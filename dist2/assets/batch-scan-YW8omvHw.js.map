{"version":3,"file":"batch-scan-YW8omvHw.js","sources":["../../src/features/batch-scan.js"],"sourcesContent":["// ── BATCH SCAN MODE ───────────────────────────────────────────────────────\n\nlet _batchStream = null;\nlet _batchActive = false;\nlet _batchItems  = [];\nlet _batchScannedCodes = new Set();\nlet _batchRaf = null;\n\nexport async function openBatchScan() {\n  _batchItems = [];\n  _batchScannedCodes.clear();\n  document.getElementById('batchOv').classList.add('on');\n  document.getElementById('batchSource').value = '';\n  renderBatchList();\n\n  try {\n    _batchStream = await navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }\n    });\n    const video = document.getElementById('batchVideo');\n    video.srcObject = _batchStream;\n    await video.play();\n    _batchActive = true;\n    document.getElementById('batchScanStatus').textContent = 'Point camera at barcodes…';\n\n    if ('BarcodeDetector' in window) {\n      _runBatchDetector(video);\n    } else {\n      const ok = await _ensureQuagga();\n      if (ok) _runBatchQuagga(video);\n      else document.getElementById('batchScanStatus').textContent = 'Camera ready — use + Manual to add items';\n    }\n  } catch(e) {\n    document.getElementById('batchScanStatus').textContent = 'Camera unavailable — use + Manual to add items';\n  }\n}\n\nexport function closeBatchScan() {\n  _batchActive = false;\n  if (_batchRaf) cancelAnimationFrame(_batchRaf);\n  if (_batchStream) { _batchStream.getTracks().forEach(t => t.stop()); _batchStream = null; }\n  document.getElementById('batchOv').classList.remove('on');\n}\n\nexport function _runBatchDetector(video) {\n  let detector;\n  try {\n    detector = new BarcodeDetector({\n      formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf']\n    });\n  } catch { detector = new BarcodeDetector(); }\n\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n\n  function tick() {\n    if (!_batchActive) return;\n    if (video.readyState >= 2) {\n      canvas.width = video.videoWidth;\n      canvas.height = video.videoHeight;\n      ctx.drawImage(video, 0, 0);\n      detector.detect(canvas).then(codes => {\n        for (const c of codes) {\n          const val = c.rawValue.trim();\n          if (val && !_batchScannedCodes.has(val)) {\n            _batchScannedCodes.add(val);\n            batchAddScanned(val);\n          }\n        }\n      }).catch(() => {});\n    }\n    _batchRaf = requestAnimationFrame(tick);\n  }\n  tick();\n}\n\nexport function _runBatchQuagga(video) {\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n\n  function tick() {\n    if (!_batchActive) return;\n    if (video.readyState >= 2) {\n      canvas.width = video.videoWidth;\n      canvas.height = video.videoHeight;\n      ctx.drawImage(video, 0, 0);\n      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n      Quagga.decodeSingle({\n        decoder: { readers: ['ean_reader','upc_reader','upc_e_reader','code_128_reader'] },\n        locate: true,\n        src: canvas.toDataURL('image/jpeg', 0.8),\n      }, result => {\n        if (result && result.codeResult) {\n          const val = result.codeResult.code.trim();\n          if (val && !_batchScannedCodes.has(val)) {\n            _batchScannedCodes.add(val);\n            batchAddScanned(val);\n          }\n        }\n      });\n    }\n    setTimeout(() => { if (_batchActive) _batchRaf = requestAnimationFrame(tick); }, 500);\n  }\n  tick();\n}\n\nexport function batchAddScanned(upc) {\n  // Check if already in inventory\n  const existing = inv.find(i => i.upc === upc);\n  _batchItems.push({\n    id: uid(),\n    upc: upc,\n    name: existing ? existing.name : '',\n    cost: existing ? existing.cost : 0,\n    price: existing ? existing.price : 0,\n    category: existing ? (existing.category || '') : '',\n    isExisting: !!existing,\n  });\n  _sfx.create();\n  document.getElementById('batchScanStatus').textContent = 'Scanned: ' + upc + ' ✓';\n  renderBatchList();\n}\n\nexport function batchManualAdd() {\n  _batchItems.push({\n    id: uid(),\n    upc: '',\n    name: '',\n    cost: 0,\n    price: 0,\n    category: '',\n    isExisting: false,\n  });\n  renderBatchList();\n  // Focus the last name input\n  setTimeout(() => {\n    const inputs = document.querySelectorAll('#batchList .batch-name-input');\n    if (inputs.length) inputs[inputs.length - 1].focus();\n  }, 50);\n}\n\nexport function batchRemoveItem(id) {\n  _batchItems = _batchItems.filter(i => i.id !== id);\n  renderBatchList();\n}\n\nexport function renderBatchList() {\n  const list = document.getElementById('batchList');\n  const empty = document.getElementById('batchEmpty');\n  const countEl = document.getElementById('batchCount');\n  const btn = document.getElementById('batchAddBtn');\n\n  countEl.textContent = _batchItems.length + ' item' + (_batchItems.length !== 1 ? 's' : '');\n  btn.disabled = !_batchItems.length;\n\n  if (!_batchItems.length) {\n    empty.style.display = '';\n    list.querySelectorAll('.batch-item').forEach(el => el.remove());\n    return;\n  }\n  empty.style.display = 'none';\n\n  // Rebuild items\n  const html = _batchItems.map((item, idx) => `<div class=\"batch-item\" data-batch-id=\"${item.id}\">\n    <div style=\"font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;width:20px;text-align:center\">${idx + 1}</div>\n    <div class=\"batch-item-info\">\n      <input class=\"batch-name-input\" type=\"text\" value=\"${escHtml(item.name)}\" placeholder=\"Item name *\"\n        oninput=\"_batchItems.find(i=>i.id==='${item.id}').name=this.value\"\n        style=\"background:none;border:none;border-bottom:1px solid var(--border);color:var(--text);font-size:12px;font-weight:600;width:100%;padding:3px 0;font-family:inherit\">\n      <div class=\"batch-item-upc\">${item.upc ? item.upc : 'No barcode'}${item.isExisting ? ' · <span style=\"color:var(--accent)\">found in inventory</span>' : ''}</div>\n    </div>\n    <div class=\"batch-item-fields\">\n      <input type=\"number\" placeholder=\"Cost\" value=\"${item.cost || ''}\" step=\"0.01\"\n        oninput=\"_batchItems.find(i=>i.id==='${item.id}').cost=parseFloat(this.value)||0\">\n      <input type=\"number\" placeholder=\"Price\" value=\"${item.price || ''}\" step=\"0.01\"\n        oninput=\"_batchItems.find(i=>i.id==='${item.id}').price=parseFloat(this.value)||0\">\n    </div>\n    <button class=\"batch-item-rm\" onclick=\"batchRemoveItem('${item.id}')\">×</button>\n  </div>`).join('');\n\n  // Keep empty hidden, replace items\n  const existingItems = list.querySelectorAll('.batch-item');\n  existingItems.forEach(el => el.remove());\n  empty.insertAdjacentHTML('afterend', html);\n}\n\nexport function batchAddAll() {\n  const source = document.getElementById('batchSource').value.trim();\n  let added = 0;\n\n  for (const item of _batchItems) {\n    const name = item.name.trim();\n    if (!name) continue;\n\n    const cat = item.category || '';\n    const skuDate = new Date().toISOString().slice(0,10).replace(/-/g,'');\n    const skuCat = (cat || 'GEN').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,4).padEnd(3,'X');\n    const skuRand = Math.random().toString(36).slice(2,5).toUpperCase();\n    const autoSku = skuCat + '-' + skuDate + '-' + skuRand;\n\n    inv.push({\n      id: uid(),\n      name: name,\n      sku: autoSku,\n      upc: item.upc || '',\n      category: cat,\n      subcategory: '',\n      subtype: '',\n      platform: 'Other',\n      platforms: [],\n      cost: item.cost || 0,\n      price: item.price || 0,\n      qty: 1,\n      bulk: false,\n      fees: 0,\n      ship: 0,\n      lowAlert: 2,\n      notes: source ? 'Batch scanned from ' + source : 'Batch scanned',\n      source: source,\n      images: [],\n      image: null,\n      added: new Date().toISOString(),\n    });\n    added++;\n  }\n\n  if (!added) { toast('No items with names to add', true); return; }\n\n  save();\n  refresh();\n  _sfx.create();\n  toast(added + ' item' + (added !== 1 ? 's' : '') + ' added to inventory ✓');\n  closeBatchScan();\n  autoSync();\n}\n"],"names":["_batchStream","_batchActive","_batchItems","_batchScannedCodes","_batchRaf","openBatchScan","renderBatchList","video","_runBatchDetector","_runBatchQuagga","closeBatchScan","detector","canvas","ctx","tick","codes","c","val","batchAddScanned","result","upc","existing","i","batchManualAdd","inputs","batchRemoveItem","id","list","empty","countEl","btn","el","html","item","idx","batchAddAll","source","added","name","cat","skuDate","skuCat","skuRand","autoSku"],"mappings":"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"}