{"version":3,"file":"scanner-glgnWlSs.js","sources":["../../src/features/scanner.js"],"sourcesContent":["// ── SCANNER (UPC/BARCODE) ────────────────────────────────────────────────────\n\nlet _scanActive = false;\nlet _scanTargetId = null;\nlet _scanStream = null;\nlet _scanRaf = null;\nlet _quaggaActive = false;\n\nexport function _loadScript(src) {\n  return new Promise((resolve, reject) => {\n    if (document.querySelector(`script[src=\"${src}\"]`)) { resolve(); return; }\n    const s = document.createElement('script');\n    s.src = src; s.onload = resolve; s.onerror = reject;\n    document.head.appendChild(s);\n  });\n}\n\nexport async function _ensureQuagga() {\n  if (typeof Quagga !== 'undefined') return true;\n  const urls = [\n    'https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js',\n    'https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js',\n  ];\n  for (const url of urls) {\n    try { await _loadScript(url); if (typeof Quagga !== 'undefined') return true; } catch {}\n  }\n  return false;\n}\n\nexport async function openScanner(targetInputId) {\n  _scanTargetId = targetInputId;\n  _scanActive   = true;\n\n  document.getElementById('scannerOv').classList.add('on');\n  _setResult('Starting camera…', false);\n  document.getElementById('scannerSub').textContent = 'Hold steady — auto-detects UPC, EAN, QR & more';\n  document.getElementById('scannerCamSel').style.display = 'none';\n\n  try {\n    _scanStream = await navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }\n    });\n    const video = document.getElementById('scannerVideo');\n    video.srcObject = _scanStream;\n    await video.play();\n\n    _populateCamList();\n    _setResult('Point camera at barcode…', false);\n\n    if ('BarcodeDetector' in window) {\n      _runNativeDetector(video);\n    } else {\n      // Fallback: Quagga2 — works in Safari, Firefox, all browsers\n      _setResult('Loading decoder…', false);\n      const ok = await _ensureQuagga();\n      if (ok) {\n        _runQuagga();\n      } else {\n        _setResult('⚠ Barcode decoder unavailable', true);\n        document.getElementById('scannerSub').textContent = 'Check your connection and try again';\n      }\n    }\n  } catch (e) {\n    const msg = e ? (e.message || String(e)) : '';\n    if (/permission|denied|not allowed/i.test(msg)) {\n      _setResult('⚠ Camera permission denied', true);\n      document.getElementById('scannerSub').textContent = 'Allow camera access in browser settings, then try again';\n    } else {\n      _setResult('⚠ Camera error: ' + (msg.slice(0, 80) || 'unknown'), true);\n    }\n  }\n}\n\nexport function _runNativeDetector(video) {\n  let detector;\n  try {\n    detector = new BarcodeDetector({\n      formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code','data_matrix','itf','aztec','pdf417']\n    });\n  } catch {\n    detector = new BarcodeDetector();\n  }\n  const tick = async () => {\n    if (!_scanActive) return;\n    try {\n      const codes = await detector.detect(video);\n      if (codes.length > 0) { _onScanSuccess(codes[0].rawValue); return; }\n    } catch {}\n    _scanRaf = requestAnimationFrame(tick);\n  };\n  _scanRaf = requestAnimationFrame(tick);\n}\n\nexport function _runQuagga() {\n  _quaggaActive = true;\n  // Quagga2 takes over the video element directly via a live stream config\n  const video = document.getElementById('scannerVideo');\n  Quagga.init({\n    inputStream: {\n      name: 'Live',\n      type: 'LiveStream',\n      target: video,\n      constraints: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },\n      area: { top: '20%', right: '10%', left: '10%', bottom: '20%' },\n    },\n    decoder: {\n      readers: ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader','code_39_reader','i2of5_reader'],\n      multiple: false,\n    },\n    locate: true,\n    numOfWorkers: 0, // 0 = main thread, avoids SharedArrayBuffer issues on iOS\n  }, (err) => {\n    if (err) {\n      _quaggaActive = false;\n      _setResult('⚠ Decoder failed to start', true);\n      document.getElementById('scannerSub').textContent = err.message || String(err);\n      return;\n    }\n    Quagga.start();\n    _setResult('Point camera at barcode…', false);\n  });\n\n  Quagga.onDetected((result) => {\n    if (!_scanActive || !_quaggaActive) return;\n    const code = result && result.codeResult && result.codeResult.code;\n    if (code) _onScanSuccess(code);\n  });\n}\n\nexport function _stopQuagga() {\n  if (_quaggaActive) {\n    _quaggaActive = false;\n    try { Quagga.offDetected(); Quagga.stop(); } catch {}\n  }\n}\n\nexport async function _populateCamList() {\n  try {\n    const devices = await navigator.mediaDevices.enumerateDevices();\n    const cams = devices.filter(d => d.kind === 'videoinput');\n    if (cams.length < 2) return;\n    const sel = document.getElementById('scannerCamSel');\n    sel.innerHTML = cams.map((c, i) =>\n      `<option value=\"${c.deviceId}\">${c.label || 'Camera ' + (i + 1)}</option>`\n    ).join('');\n    const activeId = _scanStream && _scanStream.getVideoTracks()[0]\n      && _scanStream.getVideoTracks()[0].getSettings().deviceId;\n    if (activeId) sel.value = activeId;\n    sel.style.display = 'block';\n  } catch {}\n}\n\nexport async function switchCamera(deviceId) {\n  if (!_scanActive) return;\n  _stopQuagga();\n  _stopStream();\n  try {\n    _scanStream = await navigator.mediaDevices.getUserMedia({\n      video: { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }\n    });\n    const video = document.getElementById('scannerVideo');\n    video.srcObject = _scanStream;\n    await video.play();\n    _setResult('Point camera at barcode…', false);\n    if ('BarcodeDetector' in window) _runNativeDetector(video);\n    else _runQuagga();\n  } catch {\n    _setResult('⚠ Could not switch camera', true);\n  }\n}\n\nexport function _stopStream() {\n  cancelAnimationFrame(_scanRaf); _scanRaf = null;\n  if (_scanStream) { _scanStream.getTracks().forEach(t => t.stop()); _scanStream = null; }\n  const v = document.getElementById('scannerVideo');\n  if (v) { v.pause(); v.srcObject = null; }\n}\n\nexport function _setResult(text, isError) {\n  const el = document.getElementById('scannerResult');\n  if (!el) return;\n  el.textContent = text;\n  el.style.color = isError ? '#ff6b6b' : 'var(--accent)';\n}\n\nexport function _onScanSuccess(value) {\n  if (!_scanActive) return;\n  _scanActive = false;\n  const el = document.getElementById('scannerResult');\n  el.innerHTML = `✓ <strong>${value}</strong>`;\n  el.style.color = 'var(--accent)';\n  if (navigator.vibrate) navigator.vibrate(80);\n\n  if (_scanTargetId === '__priceResearch__') {\n    // Strip any non-digit prefix a barcode scanner might prepend (e.g. \"UPC \", \"EAN:\")\n    const cleanValue = value.replace(/^[^0-9]+/, '').trim();\n    setTimeout(() => {\n      closeScanner();\n      document.getElementById('prUpcInput').value = cleanValue;\n      document.getElementById('prOv').classList.add('on');\n      lookupPrices();\n    }, 700);\n  } else {\n    const input = document.getElementById(_scanTargetId);\n    if (input) { input.value = value; input.dispatchEvent(new Event('input')); }\n    setTimeout(() => closeScanner(), 800);\n  }\n}\n\nexport function closeScanner() {\n  _scanActive = false;\n  _stopQuagga();\n  _stopStream();\n  document.getElementById('scannerOv').classList.remove('on');\n  document.getElementById('scannerCamSel').style.display = 'none';\n  _setResult('Point camera at barcode…', false);\n  document.getElementById('scannerSub').textContent = 'Hold steady — auto-detects UPC, EAN, QR & more';\n  if (_scanTargetId === '__priceResearch__') {\n    document.getElementById('prOv').classList.add('on');\n  }\n}\n"],"names":["_scanActive","_scanTargetId","_scanStream","_scanRaf","_quaggaActive","_loadScript","src","resolve","reject","s","_ensureQuagga","urls","url","openScanner","targetInputId","_setResult","video","_populateCamList","_runNativeDetector","_runQuagga","msg","detector","tick","codes","_onScanSuccess","err","result","code","_stopQuagga","cams","d","sel","c","i","activeId","switchCamera","deviceId","_stopStream","t","v","text","isError","el","value","cleanValue","closeScanner","input"],"mappings":"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"}