(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const Vl="https://gqructzvlkafclooybnc.supabase.co",Gl="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcnVjdHp2bGthZmNsb295Ym5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODIyNTAsImV4cCI6MjA4Njk1ODI1MH0.-H5p1Oq-ImveB636xgWI-Rrc23wzj7-_Vps6xeHrHtA",or=["Shirts","T-Shirts","Pants","Jeans","Shorts","Jackets","Hoodies","Sweaters","Dresses","Skirts","Socks","Underwear","Activewear","Swimwear","Outerwear","Suits","Loungewear"],Ao={Clothing:{subcats:{Men:or,Women:or,Children:or,Footwear:["Men","Women","Children"],"Men's Accessories":[],"Women's Accessories":[]}},Books:{subcats:{Fiction:["Literary","Sci-Fi","Fantasy","Mystery","Thriller","Romance","Horror","Historical"],"Non-Fiction":["Biography","History","Science","Self-Help","Business","Travel","Cooking","Health"],Textbooks:["Math","Science","Engineering","Medicine","Law","Business","Humanities","Computer Science"],Children:["Picture Books","Middle Grade","Young Adult","Board Books","Activity Books"],"Rare & Collectible":["First Editions","Signed Copies","Antiquarian","Limited Editions"],"Comics & Graphic Novels":[],"Art & Photography":[],Reference:[]}}};Object.fromEntries(Object.entries(Ao).map(([t,e])=>[t,Object.keys(e.subcats)]));Object.fromEntries(Object.entries(Ao).flatMap(([,t])=>Object.entries(t.subcats).filter(([,e])=>e.length).map(([e,n])=>[e,n])));const Kl=["eBay","Amazon","Etsy","Facebook Marketplace","Depop","Poshmark","Mercari","Grailed","StockX","GOAT","Vinted","Tradesy","The RealReal","Vestiaire Collective","Reverb","Discogs","Craigslist","OfferUp","Nextdoor","Whatnot","TikTok Shop","Instagram","Shopify","Walmart Marketplace","Newegg","Bonanza","Ruby Lane","Chairish","1stDibs","Swappa","Decluttr","Unlisted","Other"],Jl=[{label:"General",items:["eBay","Amazon","Etsy","Facebook Marketplace"]},{label:"Fashion",items:["Depop","Poshmark","Mercari","Grailed","StockX","GOAT","Vinted","Tradesy","The RealReal","Vestiaire Collective"]},{label:"Music",items:["Reverb","Discogs"]},{label:"Local",items:["Craigslist","OfferUp","Nextdoor"]},{label:"Social",items:["Whatnot","TikTok Shop","Instagram"]},{label:"Retail",items:["Shopify","Walmart Marketplace","Newegg","Bonanza","Ruby Lane","Chairish","1stDibs"]},{label:"Tech",items:["Swappa","Decluttr"]},{label:"Other",items:["Unlisted","Other"]}],Yl=t=>({eBay:"plt-ebay",Amazon:"plt-amazon",Etsy:"plt-etsy","Facebook Marketplace":"plt-fb",Depop:"plt-depop",Poshmark:"plt-poshmark",Mercari:"plt-mercari",Grailed:"plt-grailed",StockX:"plt-stockx",GOAT:"plt-goat",Vinted:"plt-vinted",Tradesy:"plt-tradesy","The RealReal":"plt-realreal","Vestiaire Collective":"plt-vestiaire",Reverb:"plt-reverb",Discogs:"plt-discogs",Craigslist:"plt-craigslist",OfferUp:"plt-offerup",Nextdoor:"plt-nextdoor",Whatnot:"plt-whatnot","TikTok Shop":"plt-tiktok",Instagram:"plt-instagram",Shopify:"plt-shopify","Walmart Marketplace":"plt-walmart",Newegg:"plt-newegg",Bonanza:"plt-bonanza","Ruby Lane":"plt-bonanza",Chairish:"plt-chairish","1stDibs":"plt-1stdibs",Swappa:"plt-swappa",Decluttr:"plt-decluttr"})[t]||"plt-other",Oo={eBay:{pct:.1325,flat:.3,label:"13.25% + $0.30"},Amazon:{pct:.15,flat:0,label:"15% referral"},Etsy:{pct:.065,flat:.2,label:"6.5% + $0.20 + 3% processing",processing:.03},"Facebook Marketplace":{pct:.05,flat:0,label:"5% (or $0.40 min)"},Depop:{pct:.1,flat:0,label:"10%"},Poshmark:{pct:.2,flat:0,label:"20% (or $2.95 if under $15)"},Mercari:{pct:.1,flat:0,label:"10%"},Grailed:{pct:.09,flat:0,label:"9% + 3.49% processing",processing:.0349},StockX:{pct:.1,flat:0,label:"~10% (varies by level)"},GOAT:{pct:.095,flat:5,label:"9.5% + $5 cashout"},Vinted:{pct:0,flat:0,label:"0% seller fees (buyer pays)"},Tradesy:{pct:.198,flat:0,label:"19.8%"},"The RealReal":{pct:.45,flat:0,label:"45% avg commission"},"Vestiaire Collective":{pct:.15,flat:0,label:"15%"},Reverb:{pct:.05,flat:.25,label:"5% + $0.25"},Discogs:{pct:.08,flat:0,label:"8%"},Whatnot:{pct:.089,flat:0,label:"8.9%"},"TikTok Shop":{pct:.08,flat:0,label:"8%"},Shopify:{pct:.029,flat:.3,label:"2.9% + $0.30 processing"},"Walmart Marketplace":{pct:.15,flat:0,label:"15% referral"},Newegg:{pct:.12,flat:0,label:"8-15% (avg 12%)"},Swappa:{pct:.03,flat:0,label:"3% (buyer pays most)"}};function Ql(t,e){const n=Oo[t];if(!n)return null;let s=e*n.pct+(n.flat||0);return n.processing&&(s+=e*n.processing),t==="Poshmark"&&e<15&&(s=2.95),t==="Facebook Marketplace"&&(s=Math.max(s,.4)),Math.round(s*100)/100}const ar=["Shirts","T-Shirts","Pants","Jeans","Shorts","Jackets","Hoodies","Sweaters","Dresses","Skirts","Socks","Underwear","Activewear","Swimwear","Outerwear","Suits","Loungewear"],Do={Clothing:{subcats:{Men:ar,Women:ar,Children:ar,Footwear:["Men","Women","Children"],"Men's Accessories":[],"Women's Accessories":[]}},Books:{subcats:{Fiction:["Literary","Sci-Fi","Fantasy","Mystery","Thriller","Romance","Horror","Historical"],"Non-Fiction":["Biography","History","Science","Self-Help","Business","Travel","Cooking","Health"],Textbooks:["Math","Science","Engineering","Medicine","Law","Business","Humanities","Computer Science"],Children:["Picture Books","Middle Grade","Young Adult","Board Books","Activity Books"],"Rare & Collectible":["First Editions","Signed Copies","Antiquarian","Limited Editions"],"Comics & Graphic Novels":[],"Art & Photography":[],Reference:[]}}},Vn=Object.fromEntries(Object.entries(Do).map(([t,e])=>[t,Object.keys(e.subcats)])),Ro=Object.fromEntries(Object.entries(Do).flatMap(([,t])=>Object.entries(t.subcats).filter(([,e])=>e.length).map(([e,n])=>[e,n]))),w=t=>"$"+Number(t||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),Q=t=>(t*100).toFixed(1)+"%",Fe=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6),me=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),x=t=>{const e=document.createElement("div");return e.textContent=t,e.innerHTML};function E(t,e,n){const s=document.getElementById("toast");s&&(s.getAttribute("role")||(s.setAttribute("role","status"),s.setAttribute("aria-live","polite")),s.textContent=t,s.className="toast"+(e?" err":""),s.classList.add("on"),setTimeout(()=>s.classList.remove("on"),2300))}const Xl=(()=>{let t=null;function e(){return t||(t=new(window.AudioContext||window.webkitAudioContext)),t.state==="suspended"&&t.resume(),t}function n(s,r,i,o,a,l,c){const d=e(),u=d.createOscillator(),p=d.createGain();u.connect(p),p.connect(d.destination),u.type=r,u.frequency.value=s,p.gain.setValueAtTime(i,d.currentTime+o),p.gain.linearRampToValueAtTime(0,d.currentTime+o+a),u.start(d.currentTime+o),u.stop(d.currentTime+o+a+.01)}return{create(){n(523.25,"sine",.18,0,.1),n(783.99,"sine",.18,.1,.14),navigator.vibrate&&navigator.vibrate([30,40,60])},edit(){n(440,"sine",.14,0,.08),n(554.37,"sine",.12,.07,.1),navigator.vibrate&&navigator.vibrate(25)},sale(){n(523.25,"triangle",.15,0,.07),n(659.25,"triangle",.15,.07,.07),n(783.99,"triangle",.16,.14,.07),n(1046.5,"triangle",.18,.21,.14),navigator.vibrate&&navigator.vibrate([20,30,20,30,80])},expense(){n(220,"sine",.2,0,.06),n(174.61,"sine",.16,.05,.12),navigator.vibrate&&navigator.vibrate([60,20,30])}}})(),Ds=Xl,Zl="fliptrack",ec=1,tc={inventory:{keyPath:"id"},sales:{keyPath:"id"},expenses:{keyPath:"id"},supplies:{keyPath:"id"},trash:{keyPath:"id"},meta:{keyPath:"key"}};let et=null,Nt=!0;const xr=[];let bs=!1;function nc(){try{return!!(window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB)}catch{return!1}}function Ae(t,e){console.error(`[IDB ${t}]`,(e==null?void 0:e.message)||e)}async function rc(){for(;xr.length>0;){const{resolve:t,reject:e,fn:n}=xr.shift();try{const s=await n();t(s)}catch(s){e(s)}}}function Gn(t){return new Promise((e,n)=>{et!==null?t().then(e).catch(n):bs?xr.push({resolve:e,reject:n,fn:t}):n(new Error("IndexedDB not initialized"))})}async function ic(){if(et!==null)return et;if(!nc())throw Nt=!1,new Error("IndexedDB is not available in this browser");return new Promise((t,e)=>{bs=!0;const n=indexedDB.open(Zl,ec);n.onerror=()=>{bs=!1,Nt=!1,Ae("open",n.error),e(n.error)},n.onsuccess=()=>{et=n.result,bs=!1,rc(),t(et)},n.onupgradeneeded=s=>{const r=s.target.result;Object.entries(tc).forEach(([i,o])=>{if(!r.objectStoreNames.contains(i))try{r.createObjectStore(i,{keyPath:o.keyPath})}catch(a){Ae(`create store ${i}`,a)}})}})}async function wn(t){return Nt?Gn(async()=>new Promise((e,n)=>{try{const i=et.transaction([t],"readonly").objectStore(t).getAll();i.onerror=()=>{Ae(`getAll ${t}`,i.error),n(i.error)},i.onsuccess=()=>{e(i.result)}}catch(s){Ae(`getAll ${t}`,s),n(s)}})):[]}async function je(t,e){if(Nt)return Gn(async()=>new Promise((n,s)=>{try{const r=et.transaction([t],"readwrite"),i=r.objectStore(t),o=i.clear();o.onerror=()=>{Ae(`putAll clear ${t}`,o.error),s(o.error)},o.onsuccess=()=>{e.forEach(a=>{try{i.add(a)}catch(l){Ae(`putAll add ${t}`,l)}})},r.onerror=()=>{Ae(`putAll transaction ${t}`,r.error),s(r.error)},r.oncomplete=()=>{n()}}catch(r){Ae(`putAll ${t}`,r),s(r)}}))}async function oc(t,e){if(Nt)return Gn(async()=>new Promise((n,s)=>{try{const o=et.transaction([t],"readwrite").objectStore(t).put(e);o.onerror=()=>{Ae(`putOne ${t}`,o.error),s(o.error)},o.onsuccess=()=>{n(o.result)}}catch(r){Ae(`putOne ${t}`,r),s(r)}}))}async function wt(t){if(Nt)return Gn(async()=>new Promise((e,n)=>{try{const i=et.transaction(["meta"],"readonly").objectStore("meta").get(t);i.onerror=()=>{Ae(`getMeta ${t}`,i.error),n(i.error)},i.onsuccess=()=>{const o=i.result;e(o?o.value:void 0)}}catch(s){Ae(`getMeta ${t}`,s),n(s)}}))}async function Ye(t,e){if(Nt)return Gn(async()=>oc("meta",{key:t,value:e}))}function Rs(t,e){var n={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(n[s]=t[s]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,s=Object.getOwnPropertySymbols(t);r<s.length;r++)e.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(t,s[r])&&(n[s[r]]=t[s[r]]);return n}function ac(t,e,n,s){function r(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function a(d){try{c(s.next(d))}catch(u){o(u)}}function l(d){try{c(s.throw(d))}catch(u){o(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((s=s.apply(t,e||[])).next())})}const lc=t=>t?(...e)=>t(...e):(...e)=>fetch(...e);class Wr extends Error{constructor(e,n="FunctionsError",s){super(e),this.name=n,this.context=s}}class cc extends Wr{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Hi extends Wr{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Wi extends Wr{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var _r;(function(t){t.Any="any",t.ApNortheast1="ap-northeast-1",t.ApNortheast2="ap-northeast-2",t.ApSouth1="ap-south-1",t.ApSoutheast1="ap-southeast-1",t.ApSoutheast2="ap-southeast-2",t.CaCentral1="ca-central-1",t.EuCentral1="eu-central-1",t.EuWest1="eu-west-1",t.EuWest2="eu-west-2",t.EuWest3="eu-west-3",t.SaEast1="sa-east-1",t.UsEast1="us-east-1",t.UsWest1="us-west-1",t.UsWest2="us-west-2"})(_r||(_r={}));class dc{constructor(e,{headers:n={},customFetch:s,region:r=_r.Any}={}){this.url=e,this.headers=n,this.region=r,this.fetch=lc(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return ac(this,arguments,void 0,function*(n,s={}){var r;let i,o;try{const{headers:a,method:l,body:c,signal:d,timeout:u}=s;let p={},{region:f}=s;f||(f=this.region);const m=new URL(`${this.url}/${n}`);f&&f!=="any"&&(p["x-region"]=f,m.searchParams.set("forceFunctionRegion",f));let v;c&&(a&&!Object.prototype.hasOwnProperty.call(a,"Content-Type")||!a)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(p["Content-Type"]="application/octet-stream",v=c):typeof c=="string"?(p["Content-Type"]="text/plain",v=c):typeof FormData<"u"&&c instanceof FormData?v=c:(p["Content-Type"]="application/json",v=JSON.stringify(c)):c&&typeof c!="string"&&!(typeof Blob<"u"&&c instanceof Blob)&&!(c instanceof ArrayBuffer)&&!(typeof FormData<"u"&&c instanceof FormData)?v=JSON.stringify(c):v=c;let g=d;u&&(o=new AbortController,i=setTimeout(()=>o.abort(),u),d?(g=o.signal,d.addEventListener("abort",()=>o.abort())):g=o.signal);const b=yield this.fetch(m.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},p),this.headers),a),body:v,signal:g}).catch(M=>{throw new cc(M)}),S=b.headers.get("x-relay-error");if(S&&S==="true")throw new Hi(b);if(!b.ok)throw new Wi(b);let k=((r=b.headers.get("Content-Type"))!==null&&r!==void 0?r:"text/plain").split(";")[0].trim(),P;return k==="application/json"?P=yield b.json():k==="application/octet-stream"||k==="application/pdf"?P=yield b.blob():k==="text/event-stream"?P=b:k==="multipart/form-data"?P=yield b.formData():P=yield b.text(),{data:P,error:null,response:b}}catch(a){return{data:null,error:a,response:a instanceof Wi||a instanceof Hi?a.context:void 0}}finally{i&&clearTimeout(i)}})}}var uc=class extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}},pc=class{constructor(t){var e,n,s;this.shouldThrowOnError=!1,this.method=t.method,this.url=t.url,this.headers=new Headers(t.headers),this.schema=t.schema,this.body=t.body,this.shouldThrowOnError=(e=t.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=t.signal,this.isMaybeSingle=(n=t.isMaybeSingle)!==null&&n!==void 0?n:!1,this.urlLengthLimit=(s=t.urlLengthLimit)!==null&&s!==void 0?s:8e3,t.fetch?this.fetch=t.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(t,e){return this.headers=new Headers(this.headers),this.headers.set(t,e),this}then(t,e){var n=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const s=this.fetch;let r=s(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{let o=null,a=null,l=null,c=i.status,d=i.statusText;if(i.ok){var u,p;if(n.method!=="HEAD"){var f;const b=await i.text();b===""||(n.headers.get("Accept")==="text/csv"||n.headers.get("Accept")&&(!((f=n.headers.get("Accept"))===null||f===void 0)&&f.includes("application/vnd.pgrst.plan+text"))?a=b:a=JSON.parse(b))}const v=(u=n.headers.get("Prefer"))===null||u===void 0?void 0:u.match(/count=(exact|planned|estimated)/),g=(p=i.headers.get("content-range"))===null||p===void 0?void 0:p.split("/");v&&g&&g.length>1&&(l=parseInt(g[1])),n.isMaybeSingle&&n.method==="GET"&&Array.isArray(a)&&(a.length>1?(o={code:"PGRST116",details:`Results contain ${a.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},a=null,l=null,c=406,d="Not Acceptable"):a.length===1?a=a[0]:a=null)}else{var m;const v=await i.text();try{o=JSON.parse(v),Array.isArray(o)&&i.status===404&&(a=[],o=null,c=200,d="OK")}catch{i.status===404&&v===""?(c=204,d="No Content"):o={message:v}}if(o&&n.isMaybeSingle&&(!(o==null||(m=o.details)===null||m===void 0)&&m.includes("0 rows"))&&(o=null,c=200,d="OK"),o&&n.shouldThrowOnError)throw new uc(o)}return{error:o,data:a,count:l,status:c,statusText:d}});return this.shouldThrowOnError||(r=r.catch(i=>{var o;let a="",l="",c="";const d=i==null?void 0:i.cause;if(d){var u,p,f,m;const b=(u=d==null?void 0:d.message)!==null&&u!==void 0?u:"",S=(p=d==null?void 0:d.code)!==null&&p!==void 0?p:"";a=`${(f=i==null?void 0:i.name)!==null&&f!==void 0?f:"FetchError"}: ${i==null?void 0:i.message}`,a+=`

Caused by: ${(m=d==null?void 0:d.name)!==null&&m!==void 0?m:"Error"}: ${b}`,S&&(a+=` (${S})`),d!=null&&d.stack&&(a+=`
${d.stack}`)}else{var v;a=(v=i==null?void 0:i.stack)!==null&&v!==void 0?v:""}const g=this.url.toString().length;return(i==null?void 0:i.name)==="AbortError"||(i==null?void 0:i.code)==="ABORT_ERR"?(c="",l="Request was aborted (timeout or manual cancellation)",g>this.urlLengthLimit&&(l+=`. Note: Your request URL is ${g} characters, which may exceed server limits. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [many IDs])), consider using an RPC function to pass values server-side.`)):((d==null?void 0:d.name)==="HeadersOverflowError"||(d==null?void 0:d.code)==="UND_ERR_HEADERS_OVERFLOW")&&(c="",l="HTTP headers exceeded server limits (typically 16KB)",g>this.urlLengthLimit&&(l+=`. Your request URL is ${g} characters. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [200+ IDs])), consider using an RPC function instead.`)),{error:{message:`${(o=i==null?void 0:i.name)!==null&&o!==void 0?o:"FetchError"}: ${i==null?void 0:i.message}`,details:a,hint:l,code:c},data:null,count:null,status:0,statusText:""}})),r.then(t,e)}returns(){return this}overrideTypes(){return this}},hc=class extends pc{select(t){let e=!1;const n=(t??"*").split("").map(s=>/\s/.test(s)&&!e?"":(s==='"'&&(e=!e),s)).join("");return this.url.searchParams.set("select",n),this.headers.append("Prefer","return=representation"),this}order(t,{ascending:e=!0,nullsFirst:n,foreignTable:s,referencedTable:r=s}={}){const i=r?`${r}.order`:"order",o=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${o?`${o},`:""}${t}.${e?"asc":"desc"}${n===void 0?"":n?".nullsfirst":".nullslast"}`),this}limit(t,{foreignTable:e,referencedTable:n=e}={}){const s=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(s,`${t}`),this}range(t,e,{foreignTable:n,referencedTable:s=n}={}){const r=typeof s>"u"?"offset":`${s}.offset`,i=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(r,`${t}`),this.url.searchParams.set(i,`${e-t+1}`),this}abortSignal(t){return this.signal=t,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:t=!1,verbose:e=!1,settings:n=!1,buffers:s=!1,wal:r=!1,format:i="text"}={}){var o;const a=[t?"analyze":null,e?"verbose":null,n?"settings":null,s?"buffers":null,r?"wal":null].filter(Boolean).join("|"),l=(o=this.headers.get("Accept"))!==null&&o!==void 0?o:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${i}; for="${l}"; options=${a};`),i==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(t){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${t}`),this}};const Vi=new RegExp("[,()]");var tn=class extends hc{eq(t,e){return this.url.searchParams.append(t,`eq.${e}`),this}neq(t,e){return this.url.searchParams.append(t,`neq.${e}`),this}gt(t,e){return this.url.searchParams.append(t,`gt.${e}`),this}gte(t,e){return this.url.searchParams.append(t,`gte.${e}`),this}lt(t,e){return this.url.searchParams.append(t,`lt.${e}`),this}lte(t,e){return this.url.searchParams.append(t,`lte.${e}`),this}like(t,e){return this.url.searchParams.append(t,`like.${e}`),this}likeAllOf(t,e){return this.url.searchParams.append(t,`like(all).{${e.join(",")}}`),this}likeAnyOf(t,e){return this.url.searchParams.append(t,`like(any).{${e.join(",")}}`),this}ilike(t,e){return this.url.searchParams.append(t,`ilike.${e}`),this}ilikeAllOf(t,e){return this.url.searchParams.append(t,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(t,e){return this.url.searchParams.append(t,`ilike(any).{${e.join(",")}}`),this}regexMatch(t,e){return this.url.searchParams.append(t,`match.${e}`),this}regexIMatch(t,e){return this.url.searchParams.append(t,`imatch.${e}`),this}is(t,e){return this.url.searchParams.append(t,`is.${e}`),this}isDistinct(t,e){return this.url.searchParams.append(t,`isdistinct.${e}`),this}in(t,e){const n=Array.from(new Set(e)).map(s=>typeof s=="string"&&Vi.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(t,`in.(${n})`),this}notIn(t,e){const n=Array.from(new Set(e)).map(s=>typeof s=="string"&&Vi.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(t,`not.in.(${n})`),this}contains(t,e){return typeof e=="string"?this.url.searchParams.append(t,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cs.{${e.join(",")}}`):this.url.searchParams.append(t,`cs.${JSON.stringify(e)}`),this}containedBy(t,e){return typeof e=="string"?this.url.searchParams.append(t,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cd.{${e.join(",")}}`):this.url.searchParams.append(t,`cd.${JSON.stringify(e)}`),this}rangeGt(t,e){return this.url.searchParams.append(t,`sr.${e}`),this}rangeGte(t,e){return this.url.searchParams.append(t,`nxl.${e}`),this}rangeLt(t,e){return this.url.searchParams.append(t,`sl.${e}`),this}rangeLte(t,e){return this.url.searchParams.append(t,`nxr.${e}`),this}rangeAdjacent(t,e){return this.url.searchParams.append(t,`adj.${e}`),this}overlaps(t,e){return typeof e=="string"?this.url.searchParams.append(t,`ov.${e}`):this.url.searchParams.append(t,`ov.{${e.join(",")}}`),this}textSearch(t,e,{config:n,type:s}={}){let r="";s==="plain"?r="pl":s==="phrase"?r="ph":s==="websearch"&&(r="w");const i=n===void 0?"":`(${n})`;return this.url.searchParams.append(t,`${r}fts${i}.${e}`),this}match(t){return Object.entries(t).forEach(([e,n])=>{this.url.searchParams.append(e,`eq.${n}`)}),this}not(t,e,n){return this.url.searchParams.append(t,`not.${e}.${n}`),this}or(t,{foreignTable:e,referencedTable:n=e}={}){const s=n?`${n}.or`:"or";return this.url.searchParams.append(s,`(${t})`),this}filter(t,e,n){return this.url.searchParams.append(t,`${e}.${n}`),this}},fc=class{constructor(t,{headers:e={},schema:n,fetch:s,urlLengthLimit:r=8e3}){this.url=t,this.headers=new Headers(e),this.schema=n,this.fetch=s,this.urlLengthLimit=r}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(t,e){const{head:n=!1,count:s}=e??{},r=n?"HEAD":"GET";let i=!1;const o=(t??"*").split("").map(c=>/\s/.test(c)&&!i?"":(c==='"'&&(i=!i),c)).join(""),{url:a,headers:l}=this.cloneRequestState();return a.searchParams.set("select",o),s&&l.append("Prefer",`count=${s}`),new tn({method:r,url:a,headers:l,schema:this.schema,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}insert(t,{count:e,defaultToNull:n=!0}={}){var s;const r="POST",{url:i,headers:o}=this.cloneRequestState();if(e&&o.append("Prefer",`count=${e}`),n||o.append("Prefer","missing=default"),Array.isArray(t)){const a=t.reduce((l,c)=>l.concat(Object.keys(c)),[]);if(a.length>0){const l=[...new Set(a)].map(c=>`"${c}"`);i.searchParams.set("columns",l.join(","))}}return new tn({method:r,url:i,headers:o,schema:this.schema,body:t,fetch:(s=this.fetch)!==null&&s!==void 0?s:fetch,urlLengthLimit:this.urlLengthLimit})}upsert(t,{onConflict:e,ignoreDuplicates:n=!1,count:s,defaultToNull:r=!0}={}){var i;const o="POST",{url:a,headers:l}=this.cloneRequestState();if(l.append("Prefer",`resolution=${n?"ignore":"merge"}-duplicates`),e!==void 0&&a.searchParams.set("on_conflict",e),s&&l.append("Prefer",`count=${s}`),r||l.append("Prefer","missing=default"),Array.isArray(t)){const c=t.reduce((d,u)=>d.concat(Object.keys(u)),[]);if(c.length>0){const d=[...new Set(c)].map(u=>`"${u}"`);a.searchParams.set("columns",d.join(","))}}return new tn({method:o,url:a,headers:l,schema:this.schema,body:t,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch,urlLengthLimit:this.urlLengthLimit})}update(t,{count:e}={}){var n;const s="PATCH",{url:r,headers:i}=this.cloneRequestState();return e&&i.append("Prefer",`count=${e}`),new tn({method:s,url:r,headers:i,schema:this.schema,body:t,fetch:(n=this.fetch)!==null&&n!==void 0?n:fetch,urlLengthLimit:this.urlLengthLimit})}delete({count:t}={}){var e;const n="DELETE",{url:s,headers:r}=this.cloneRequestState();return t&&r.append("Prefer",`count=${t}`),new tn({method:n,url:s,headers:r,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch,urlLengthLimit:this.urlLengthLimit})}};function Rn(t){"@babel/helpers - typeof";return Rn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Rn(t)}function gc(t,e){if(Rn(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var s=n.call(t,e);if(Rn(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function mc(t){var e=gc(t,"string");return Rn(e)=="symbol"?e:e+""}function vc(t,e,n){return(e=mc(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Gi(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,s)}return n}function cs(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Gi(Object(n),!0).forEach(function(s){vc(t,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Gi(Object(n)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(n,s))})}return t}var yc=class Bo{constructor(e,{headers:n={},schema:s,fetch:r,timeout:i,urlLengthLimit:o=8e3}={}){this.url=e,this.headers=new Headers(n),this.schemaName=s,this.urlLengthLimit=o;const a=r??globalThis.fetch;i!==void 0&&i>0?this.fetch=(l,c)=>{const d=new AbortController,u=setTimeout(()=>d.abort(),i),p=c==null?void 0:c.signal;if(p){if(p.aborted)return clearTimeout(u),a(l,c);const f=()=>{clearTimeout(u),d.abort()};return p.addEventListener("abort",f,{once:!0}),a(l,cs(cs({},c),{},{signal:d.signal})).finally(()=>{clearTimeout(u),p.removeEventListener("abort",f)})}return a(l,cs(cs({},c),{},{signal:d.signal})).finally(()=>clearTimeout(u))}:this.fetch=a}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new fc(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}schema(e){return new Bo(this.url,{headers:this.headers,schema:e,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}rpc(e,n={},{head:s=!1,get:r=!1,count:i}={}){var o;let a;const l=new URL(`${this.url}/rpc/${e}`);let c;const d=f=>f!==null&&typeof f=="object"&&(!Array.isArray(f)||f.some(d)),u=s&&Object.values(n).some(d);u?(a="POST",c=n):s||r?(a=s?"HEAD":"GET",Object.entries(n).filter(([f,m])=>m!==void 0).map(([f,m])=>[f,Array.isArray(m)?`{${m.join(",")}}`:`${m}`]).forEach(([f,m])=>{l.searchParams.append(f,m)})):(a="POST",c=n);const p=new Headers(this.headers);return u?p.set("Prefer",i?`count=${i},return=minimal`:"return=minimal"):i&&p.set("Prefer",`count=${i}`),new tn({method:a,url:l,headers:p,schema:this.schemaName,body:c,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch,urlLengthLimit:this.urlLengthLimit})}};class bc{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const n=globalThis.process;if(n){const s=n.versions;if(s&&s.node){const r=s.node,i=parseInt(r.replace(/^v/,"").split(".")[0]);return i>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${i} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${i} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let n=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(n+=`

Suggested solution: ${e.workaround}`),new Error(n)}static createWebSocket(e,n){const s=this.getWebSocketConstructor();return new s(e,n)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const wc="2.98.0",xc=`realtime-js/${wc}`,_c="1.0.0",Lo="2.0.0",Ki=Lo,Sr=1e4,Sc=1e3,kc=100;var pt;(function(t){t[t.connecting=0]="connecting",t[t.open=1]="open",t[t.closing=2]="closing",t[t.closed=3]="closed"})(pt||(pt={}));var se;(function(t){t.closed="closed",t.errored="errored",t.joined="joined",t.joining="joining",t.leaving="leaving"})(se||(se={}));var Le;(function(t){t.close="phx_close",t.error="phx_error",t.join="phx_join",t.reply="phx_reply",t.leave="phx_leave",t.access_token="access_token"})(Le||(Le={}));var kr;(function(t){t.websocket="websocket"})(kr||(kr={}));var At;(function(t){t.Connecting="connecting",t.Open="open",t.Closing="closing",t.Closed="closed"})(At||(At={}));class $c{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,n){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return n(this._binaryEncodeUserBroadcastPush(e));let s=[e.join_ref,e.ref,e.topic,e.event,e.payload];return n(JSON.stringify(s))}_binaryEncodeUserBroadcastPush(e){var n;return this._isArrayBuffer((n=e.payload)===null||n===void 0?void 0:n.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var n,s;const r=(s=(n=e.payload)===null||n===void 0?void 0:n.payload)!==null&&s!==void 0?s:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,r)}_encodeJsonUserBroadcastPush(e){var n,s;const r=(s=(n=e.payload)===null||n===void 0?void 0:n.payload)!==null&&s!==void 0?s:{},o=new TextEncoder().encode(JSON.stringify(r)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,o)}_encodeUserBroadcastPush(e,n,s){var r,i;const o=e.topic,a=(r=e.ref)!==null&&r!==void 0?r:"",l=(i=e.join_ref)!==null&&i!==void 0?i:"",c=e.payload.event,d=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},u=Object.keys(d).length===0?"":JSON.stringify(d);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(a.length>255)throw new Error(`ref length ${a.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`topic length ${o.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(u.length>255)throw new Error(`metadata length ${u.length} exceeds maximum of 255`);const p=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+a.length+o.length+c.length+u.length,f=new ArrayBuffer(this.HEADER_LENGTH+p);let m=new DataView(f),v=0;m.setUint8(v++,this.KINDS.userBroadcastPush),m.setUint8(v++,l.length),m.setUint8(v++,a.length),m.setUint8(v++,o.length),m.setUint8(v++,c.length),m.setUint8(v++,u.length),m.setUint8(v++,n),Array.from(l,b=>m.setUint8(v++,b.charCodeAt(0))),Array.from(a,b=>m.setUint8(v++,b.charCodeAt(0))),Array.from(o,b=>m.setUint8(v++,b.charCodeAt(0))),Array.from(c,b=>m.setUint8(v++,b.charCodeAt(0))),Array.from(u,b=>m.setUint8(v++,b.charCodeAt(0)));var g=new Uint8Array(f.byteLength+s.byteLength);return g.set(new Uint8Array(f),0),g.set(new Uint8Array(s),f.byteLength),g.buffer}decode(e,n){if(this._isArrayBuffer(e)){let s=this._binaryDecode(e);return n(s)}if(typeof e=="string"){const s=JSON.parse(e),[r,i,o,a,l]=s;return n({join_ref:r,ref:i,topic:o,event:a,payload:l})}return n({})}_binaryDecode(e){const n=new DataView(e),s=n.getUint8(0),r=new TextDecoder;switch(s){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,n,r)}}_decodeUserBroadcast(e,n,s){const r=n.getUint8(1),i=n.getUint8(2),o=n.getUint8(3),a=n.getUint8(4);let l=this.HEADER_LENGTH+4;const c=s.decode(e.slice(l,l+r));l=l+r;const d=s.decode(e.slice(l,l+i));l=l+i;const u=s.decode(e.slice(l,l+o));l=l+o;const p=e.slice(l,e.byteLength),f=a===this.JSON_ENCODING?JSON.parse(s.decode(p)):p,m={type:this.BROADCAST_EVENT,event:d,payload:f};return o>0&&(m.meta=JSON.parse(u)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:m}}_isArrayBuffer(e){var n;return e instanceof ArrayBuffer||((n=e==null?void 0:e.constructor)===null||n===void 0?void 0:n.name)==="ArrayBuffer"}_pick(e,n){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([s])=>n.includes(s)))}}class Mo{constructor(e,n){this.callback=e,this.timerCalc=n,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=n}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var K;(function(t){t.abstime="abstime",t.bool="bool",t.date="date",t.daterange="daterange",t.float4="float4",t.float8="float8",t.int2="int2",t.int4="int4",t.int4range="int4range",t.int8="int8",t.int8range="int8range",t.json="json",t.jsonb="jsonb",t.money="money",t.numeric="numeric",t.oid="oid",t.reltime="reltime",t.text="text",t.time="time",t.timestamp="timestamp",t.timestamptz="timestamptz",t.timetz="timetz",t.tsrange="tsrange",t.tstzrange="tstzrange"})(K||(K={}));const Ji=(t,e,n={})=>{var s;const r=(s=n.skipTypes)!==null&&s!==void 0?s:[];return e?Object.keys(e).reduce((i,o)=>(i[o]=Ec(o,t,e,r),i),{}):{}},Ec=(t,e,n,s)=>{const r=e.find(a=>a.name===t),i=r==null?void 0:r.type,o=n[t];return i&&!s.includes(i)?jo(i,o):$r(o)},jo=(t,e)=>{if(t.charAt(0)==="_"){const n=t.slice(1,t.length);return Pc(e,n)}switch(t){case K.bool:return Ic(e);case K.float4:case K.float8:case K.int2:case K.int4:case K.int8:case K.numeric:case K.oid:return Tc(e);case K.json:case K.jsonb:return Cc(e);case K.timestamp:return Ac(e);case K.abstime:case K.date:case K.daterange:case K.int4range:case K.int8range:case K.money:case K.reltime:case K.text:case K.time:case K.timestamptz:case K.timetz:case K.tsrange:case K.tstzrange:return $r(e);default:return $r(e)}},$r=t=>t,Ic=t=>{switch(t){case"t":return!0;case"f":return!1;default:return t}},Tc=t=>{if(typeof t=="string"){const e=parseFloat(t);if(!Number.isNaN(e))return e}return t},Cc=t=>{if(typeof t=="string")try{return JSON.parse(t)}catch{return t}return t},Pc=(t,e)=>{if(typeof t!="string")return t;const n=t.length-1,s=t[n];if(t[0]==="{"&&s==="}"){let i;const o=t.slice(1,n);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(a=>jo(e,a))}return t},Ac=t=>typeof t=="string"?t.replace(" ","T"):t,zo=t=>{const e=new URL(t);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class lr{constructor(e,n,s={},r=Sr){this.channel=e,this.event=n,this.payload=s,this.timeout=r,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,n){var s;return this._hasReceived(e)&&n((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:e,callback:n}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=n=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=n,this._matchReceive(n)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,n){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:n})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:n}){this.recHooks.filter(s=>s.status===e).forEach(s=>s.callback(n))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Yi;(function(t){t.SYNC="sync",t.JOIN="join",t.LEAVE="leave"})(Yi||(Yi={}));class Cn{constructor(e,n){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(n==null?void 0:n.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},r=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Cn.syncState(this.state,r,i,o),this.pendingDiffs.forEach(l=>{this.state=Cn.syncDiff(this.state,l,i,o)}),this.pendingDiffs=[],a()}),this.channel._on(s.diff,{},r=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(r):(this.state=Cn.syncDiff(this.state,r,i,o),a())}),this.onJoin((r,i,o)=>{this.channel._trigger("presence",{event:"join",key:r,currentPresences:i,newPresences:o})}),this.onLeave((r,i,o)=>{this.channel._trigger("presence",{event:"leave",key:r,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,n,s,r){const i=this.cloneDeep(e),o=this.transformState(n),a={},l={};return this.map(i,(c,d)=>{o[c]||(l[c]=d)}),this.map(o,(c,d)=>{const u=i[c];if(u){const p=d.map(g=>g.presence_ref),f=u.map(g=>g.presence_ref),m=d.filter(g=>f.indexOf(g.presence_ref)<0),v=u.filter(g=>p.indexOf(g.presence_ref)<0);m.length>0&&(a[c]=m),v.length>0&&(l[c]=v)}else a[c]=d}),this.syncDiff(i,{joins:a,leaves:l},s,r)}static syncDiff(e,n,s,r){const{joins:i,leaves:o}={joins:this.transformState(n.joins),leaves:this.transformState(n.leaves)};return s||(s=()=>{}),r||(r=()=>{}),this.map(i,(a,l)=>{var c;const d=(c=e[a])!==null&&c!==void 0?c:[];if(e[a]=this.cloneDeep(l),d.length>0){const u=e[a].map(f=>f.presence_ref),p=d.filter(f=>u.indexOf(f.presence_ref)<0);e[a].unshift(...p)}s(a,d,l)}),this.map(o,(a,l)=>{let c=e[a];if(!c)return;const d=l.map(u=>u.presence_ref);c=c.filter(u=>d.indexOf(u.presence_ref)<0),e[a]=c,r(a,c,l),c.length===0&&delete e[a]}),e}static map(e,n){return Object.getOwnPropertyNames(e).map(s=>n(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((n,s)=>{const r=e[s];return"metas"in r?n[s]=r.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):n[s]=r,n},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Qi;(function(t){t.ALL="*",t.INSERT="INSERT",t.UPDATE="UPDATE",t.DELETE="DELETE"})(Qi||(Qi={}));var Pn;(function(t){t.BROADCAST="broadcast",t.PRESENCE="presence",t.POSTGRES_CHANGES="postgres_changes",t.SYSTEM="system"})(Pn||(Pn={}));var Ze;(function(t){t.SUBSCRIBED="SUBSCRIBED",t.TIMED_OUT="TIMED_OUT",t.CLOSED="CLOSED",t.CHANNEL_ERROR="CHANNEL_ERROR"})(Ze||(Ze={}));class rn{constructor(e,n={config:{}},s){var r,i;if(this.topic=e,this.params=n,this.socket=s,this.bindings={},this.state=se.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},n.config),this.timeout=this.socket.timeout,this.joinPush=new lr(this,Le.join,this.params,this.timeout),this.rejoinTimer=new Mo(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=se.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(o=>o.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=se.closed,this.socket._remove(this)}),this._onError(o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=se.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=se.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=se.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Le.reply,{},(o,a)=>{this._trigger(this._replyEventName(a),o)}),this.presence=new Cn(this),this.broadcastEndpointURL=zo(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((i=(r=this.params.config)===null||r===void 0?void 0:r.broadcast)===null||i===void 0)&&i.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,n=this.timeout){var s,r,i;if(this.socket.isConnected()||this.socket.connect(),this.state==se.closed){const{config:{broadcast:o,presence:a,private:l}}=this.params,c=(r=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(f=>f.filter))!==null&&r!==void 0?r:[],d=!!this.bindings[Pn.PRESENCE]&&this.bindings[Pn.PRESENCE].length>0||((i=this.params.config.presence)===null||i===void 0?void 0:i.enabled)===!0,u={},p={broadcast:o,presence:Object.assign(Object.assign({},a),{enabled:d}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(u.access_token=this.socket.accessTokenValue),this._onError(f=>e==null?void 0:e(Ze.CHANNEL_ERROR,f)),this._onClose(()=>e==null?void 0:e(Ze.CLOSED)),this.updateJoinPayload(Object.assign({config:p},u)),this.joinedOnce=!0,this._rejoin(n),this.joinPush.receive("ok",async({postgres_changes:f})=>{var m;if(this.socket._isManualToken()||this.socket.setAuth(),f===void 0){e==null||e(Ze.SUBSCRIBED);return}else{const v=this.bindings.postgres_changes,g=(m=v==null?void 0:v.length)!==null&&m!==void 0?m:0,b=[];for(let S=0;S<g;S++){const k=v[S],{filter:{event:P,schema:M,table:D,filter:q}}=k,O=f&&f[S];if(O&&O.event===P&&rn.isFilterValueEqual(O.schema,M)&&rn.isFilterValueEqual(O.table,D)&&rn.isFilterValueEqual(O.filter,q))b.push(Object.assign(Object.assign({},k),{id:O.id}));else{this.unsubscribe(),this.state=se.errored,e==null||e(Ze.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=b,e&&e(Ze.SUBSCRIBED);return}}).receive("error",f=>{this.state=se.errored,e==null||e(Ze.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(f).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(Ze.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,n={}){return await this.send({type:"presence",event:"track",payload:e},n.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,n,s){return this.state===se.joined&&e===Pn.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,n,s)}async httpSend(e,n,s={}){var r;if(n==null)return Promise.reject("Payload is required for httpSend()");const i={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(i.Authorization=`Bearer ${this.socket.accessTokenValue}`);const o={method:"POST",headers:i,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:n,private:this.private}]})},a=await this._fetchWithTimeout(this.broadcastEndpointURL,o,(r=s.timeout)!==null&&r!==void 0?r:this.timeout);if(a.status===202)return{success:!0};let l=a.statusText;try{const c=await a.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(e,n={}){var s,r;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:i,payload:o}=e,a={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(a.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:a,body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(s=n.timeout)!==null&&s!==void 0?s:this.timeout);return await((r=c.body)===null||r===void 0?void 0:r.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var o,a,l;const c=this._push(e.type,e,n.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(o=this.params)===null||o===void 0?void 0:o.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&i("ok"),c.receive("ok",()=>i("ok")),c.receive("error",()=>i("error")),c.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=se.leaving;const n=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Le.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(r=>{s=new lr(this,Le.leave,{},e),s.receive("ok",()=>{n(),r("ok")}).receive("timeout",()=>{n(),r("timed out")}).receive("error",()=>{r("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{s==null||s.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=se.closed,this.bindings={}}async _fetchWithTimeout(e,n,s){const r=new AbortController,i=setTimeout(()=>r.abort(),s),o=await this.socket.fetch(e,Object.assign(Object.assign({},n),{signal:r.signal}));return clearTimeout(i),o}_push(e,n,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let r=new lr(this,e,n,s);return this._canPush()?r.send():this._addToPushBuffer(r),r}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>kc){const n=this.pushBuffer.shift();n&&(n.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${n.event}`,n.payload))}}_onMessage(e,n,s){return n}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,n,s){var r,i;const o=e.toLocaleLowerCase(),{close:a,error:l,leave:c,join:d}=Le;if(s&&[a,l,c,d].indexOf(o)>=0&&s!==this._joinRef())return;let p=this._onMessage(o,n,s);if(n&&!p)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(r=this.bindings.postgres_changes)===null||r===void 0||r.filter(f=>{var m,v,g;return((m=f.filter)===null||m===void 0?void 0:m.event)==="*"||((g=(v=f.filter)===null||v===void 0?void 0:v.event)===null||g===void 0?void 0:g.toLocaleLowerCase())===o}).map(f=>f.callback(p,s)):(i=this.bindings[o])===null||i===void 0||i.filter(f=>{var m,v,g,b,S,k;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in f){const P=f.id,M=(m=f.filter)===null||m===void 0?void 0:m.event;return P&&((v=n.ids)===null||v===void 0?void 0:v.includes(P))&&(M==="*"||(M==null?void 0:M.toLocaleLowerCase())===((g=n.data)===null||g===void 0?void 0:g.type.toLocaleLowerCase()))}else{const P=(S=(b=f==null?void 0:f.filter)===null||b===void 0?void 0:b.event)===null||S===void 0?void 0:S.toLocaleLowerCase();return P==="*"||P===((k=n==null?void 0:n.event)===null||k===void 0?void 0:k.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===o}).map(f=>{if(typeof p=="object"&&"ids"in p){const m=p.data,{schema:v,table:g,commit_timestamp:b,type:S,errors:k}=m;p=Object.assign(Object.assign({},{schema:v,table:g,commit_timestamp:b,eventType:S,new:{},old:{},errors:k}),this._getPayloadRecords(m))}f.callback(p,s)})}_isClosed(){return this.state===se.closed}_isJoined(){return this.state===se.joined}_isJoining(){return this.state===se.joining}_isLeaving(){return this.state===se.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,n,s){const r=e.toLocaleLowerCase(),i={type:r,filter:n,callback:s};return this.bindings[r]?this.bindings[r].push(i):this.bindings[r]=[i],this}_off(e,n){const s=e.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(r=>{var i;return!(((i=r.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===s&&rn.isEqual(r.filter,n))})),this}static isEqual(e,n){if(Object.keys(e).length!==Object.keys(n).length)return!1;for(const s in e)if(e[s]!==n[s])return!1;return!0}static isFilterValueEqual(e,n){return(e??void 0)===(n??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Le.close,{},e)}_onError(e){this._on(Le.error,{},n=>e(n))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=se.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const n={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(n.new=Ji(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(n.old=Ji(e.columns,e.old_record)),n}}const cr=()=>{},us={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Oc=[1e3,2e3,5e3,1e4],Dc=1e4,Rc=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Bc{constructor(e,n){var s;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Sr,this.transport=null,this.heartbeatIntervalMs=us.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=cr,this.ref=0,this.reconnectTimer=null,this.vsn=Ki,this.logger=cr,this.conn=null,this.sendBuffer=[],this.serializer=new $c,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=r=>r?(...i)=>r(...i):(...i)=>fetch(...i),!(!((s=n==null?void 0:n.params)===null||s===void 0)&&s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=n.params.apikey,this.endPoint=`${e}/${kr.websocket}`,this.httpEndpoint=zo(e),this._initializeOptions(n),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(n==null?void 0:n.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=bc.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const n=e.message;throw n.includes("Node.js")?new Error(`${n}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${n}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,n){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,n??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const n=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),n}async removeAllChannels(){const e=await Promise.all(this.channels.map(n=>n.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,n,s){this.logger(e,n,s)}connectionState(){switch(this.conn&&this.conn.readyState){case pt.connecting:return At.Connecting;case pt.open:return At.Open;case pt.closing:return At.Closing;default:return At.Closed}}isConnected(){return this.connectionState()===At.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,n={config:{}}){const s=`realtime:${e}`,r=this.getChannels().find(i=>i.topic===s);if(r)return r;{const i=new rn(`realtime:${e}`,n,this);return this.channels.push(i),i}}push(e){const{topic:n,event:s,payload:r,ref:i}=e,o=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${n} ${s} (${i})`,r),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(n){this.log("error","error in heartbeat callback",n)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(n){this.log("error","error in heartbeat callback",n)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Sc,"heartbeat timeout"),setTimeout(()=>{var n;this.isConnected()||(n=this.reconnectTimer)===null||n===void 0||n.scheduleTimeout()},us.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(n){this.log("error","error in heartbeat callback",n)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let n=this.channels.find(s=>s.topic===e&&(s._isJoined()||s._isJoining()));n&&(this.log("transport",`leaving duplicate topic "${e}"`),n.unsubscribe())}_remove(e){this.channels=this.channels.filter(n=>n.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,n=>{if(n.topic==="phoenix"&&n.event==="phx_reply"&&n.ref&&n.ref===this.pendingHeartbeatRef){const c=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(n.payload.status==="ok"?"ok":"error",c)}catch(d){this.log("error","error in heartbeat callback",d)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:s,event:r,payload:i,ref:o}=n,a=o?`(${o})`:"",l=i.status||"";this.log("receive",`${l} ${s} ${r} ${a}`.trim(),i),this.channels.filter(c=>c._isMember(s)).forEach(c=>c._trigger(r,i,o)),this._triggerStateCallbacks("message",n)})}_clearTimer(e){var n;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((n=this.reconnectTimer)===null||n===void 0||n.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===pt.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===pt.open||this.conn.readyState===pt.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.accessTokenValue&&(this.channels.forEach(n=>{n.updateJoinPayload({access_token:this.accessTokenValue})}),this.sendBuffer=[],this.channels.forEach(n=>{n._isJoining()&&(n.joinPush.sent=!1,n.joinPush.send())})),this.flushSendBuffer()}).catch(n=>{this.log("error","error waiting for auth on connect",n),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=n=>{this.log("worker","worker error",n.message),this._terminateWorker()},this.workerRef.onmessage=n=>{n.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var n;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(n=this.reconnectTimer)===null||n===void 0||n.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e);try{this.heartbeatCallback("error")}catch(n){this.log("error","error in heartbeat callback",n)}}_triggerChanError(){this.channels.forEach(e=>e._trigger(Le.error))}_appendParams(e,n){if(Object.keys(n).length===0)return e;const s=e.match(/\?/)?"&":"?",r=new URLSearchParams(n);return`${e}${s}${r}`}_workerObjectUrl(e){let n;if(e)n=e;else{const s=new Blob([Rc],{type:"application/javascript"});n=URL.createObjectURL(s)}return n}_setConnectionState(e,n=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=n)}async _performAuth(e=null){let n,s=!1;if(e)n=e,s=!0;else if(this.accessToken)try{n=await this.accessToken()}catch(r){this.log("error","Error fetching access token from callback",r),n=this.accessTokenValue}else n=this.accessTokenValue;s?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=n&&(this.accessTokenValue=n,this.channels.forEach(r=>{const i={access_token:n,version:xc};n&&r.updateJoinPayload(i),r.joinedOnce&&r._isJoined()&&r._push(Le.access_token,{access_token:n})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(n=>{this.log("error",`Error setting auth in ${e}`,n)})}_triggerStateCallbacks(e,n){try{this.stateChangeCallbacks[e].forEach(s=>{try{s(n)}catch(r){this.log("error",`error in ${e} callback`,r)}})}catch(s){this.log("error",`error triggering ${e} callbacks`,s)}}_setupReconnectionTimer(){this.reconnectTimer=new Mo(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},us.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var n,s,r,i,o,a,l,c,d,u,p,f;switch(this.transport=(n=e==null?void 0:e.transport)!==null&&n!==void 0?n:null,this.timeout=(s=e==null?void 0:e.timeout)!==null&&s!==void 0?s:Sr,this.heartbeatIntervalMs=(r=e==null?void 0:e.heartbeatIntervalMs)!==null&&r!==void 0?r:us.HEARTBEAT_INTERVAL,this.worker=(i=e==null?void 0:e.worker)!==null&&i!==void 0?i:!1,this.accessToken=(o=e==null?void 0:e.accessToken)!==null&&o!==void 0?o:null,this.heartbeatCallback=(a=e==null?void 0:e.heartbeatCallback)!==null&&a!==void 0?a:cr,this.vsn=(l=e==null?void 0:e.vsn)!==null&&l!==void 0?l:Ki,e!=null&&e.params&&(this.params=e.params),e!=null&&e.logger&&(this.logger=e.logger),(e!=null&&e.logLevel||e!=null&&e.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=e==null?void 0:e.reconnectAfterMs)!==null&&c!==void 0?c:m=>Oc[m-1]||Dc,this.vsn){case _c:this.encode=(d=e==null?void 0:e.encode)!==null&&d!==void 0?d:(m,v)=>v(JSON.stringify(m)),this.decode=(u=e==null?void 0:e.decode)!==null&&u!==void 0?u:(m,v)=>v(JSON.parse(m));break;case Lo:this.encode=(p=e==null?void 0:e.encode)!==null&&p!==void 0?p:this.serializer.encode.bind(this.serializer),this.decode=(f=e==null?void 0:e.decode)!==null&&f!==void 0?f:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e==null?void 0:e.workerUrl}}}var Bn=class extends Error{constructor(t,e){var n;super(t),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&((n=e.icebergType)==null?void 0:n.includes("CommitState"))===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function Lc(t,e,n){const s=new URL(e,t);if(n)for(const[r,i]of Object.entries(n))i!==void 0&&s.searchParams.set(r,i);return s.toString()}async function Mc(t){return!t||t.type==="none"?{}:t.type==="bearer"?{Authorization:`Bearer ${t.token}`}:t.type==="header"?{[t.name]:t.value}:t.type==="custom"?await t.getHeaders():{}}function jc(t){const e=t.fetchImpl??globalThis.fetch;return{async request({method:n,path:s,query:r,body:i,headers:o}){const a=Lc(t.baseUrl,s,r),l=await Mc(t.auth),c=await e(a,{method:n,headers:{...i?{"Content-Type":"application/json"}:{},...l,...o},body:i?JSON.stringify(i):void 0}),d=await c.text(),u=(c.headers.get("content-type")||"").includes("application/json"),p=u&&d?JSON.parse(d):d;if(!c.ok){const f=u?p:void 0,m=f==null?void 0:f.error;throw new Bn((m==null?void 0:m.message)??`Request failed with status ${c.status}`,{status:c.status,icebergType:m==null?void 0:m.type,icebergCode:m==null?void 0:m.code,details:f})}return{status:c.status,headers:c.headers,data:p}}}}function ps(t){return t.join("")}var zc=class{constructor(t,e=""){this.client=t,this.prefix=e}async listNamespaces(t){const e=t?{parent:ps(t.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(s=>({namespace:s}))}async createNamespace(t,e){const n={namespace:t.namespace,properties:e==null?void 0:e.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:n})).data}async dropNamespace(t){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${ps(t.namespace)}`})}async loadNamespaceMetadata(t){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${ps(t.namespace)}`})).data.properties}}async namespaceExists(t){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${ps(t.namespace)}`}),!0}catch(e){if(e instanceof Bn&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(t,e){try{return await this.createNamespace(t,e)}catch(n){if(n instanceof Bn&&n.status===409)return;throw n}}};function Yt(t){return t.join("")}var Nc=class{constructor(t,e="",n){this.client=t,this.prefix=e,this.accessDelegation=n}async listTables(t){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Yt(t.namespace)}/tables`})).data.identifiers}async createTable(t,e){const n={};return this.accessDelegation&&(n["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Yt(t.namespace)}/tables`,body:e,headers:n})).data.metadata}async updateTable(t,e){const n=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Yt(t.namespace)}/tables/${t.name}`,body:e});return{"metadata-location":n.data["metadata-location"],metadata:n.data.metadata}}async dropTable(t,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Yt(t.namespace)}/tables/${t.name}`,query:{purgeRequested:String((e==null?void 0:e.purge)??!1)}})}async loadTable(t){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Yt(t.namespace)}/tables/${t.name}`,headers:e})).data.metadata}async tableExists(t){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Yt(t.namespace)}/tables/${t.name}`,headers:e}),!0}catch(n){if(n instanceof Bn&&n.status===404)return!1;throw n}}async createTableIfNotExists(t,e){try{return await this.createTable(t,e)}catch(n){if(n instanceof Bn&&n.status===409)return await this.loadTable({namespace:t.namespace,name:e.name});throw n}}},Uc=class{constructor(t){var s;let e="v1";t.catalogName&&(e+=`/${t.catalogName}`);const n=t.baseUrl.endsWith("/")?t.baseUrl:`${t.baseUrl}/`;this.client=jc({baseUrl:n,auth:t.auth,fetchImpl:t.fetch}),this.accessDelegation=(s=t.accessDelegation)==null?void 0:s.join(","),this.namespaceOps=new zc(this.client,e),this.tableOps=new Nc(this.client,e,this.accessDelegation)}async listNamespaces(t){return this.namespaceOps.listNamespaces(t)}async createNamespace(t,e){return this.namespaceOps.createNamespace(t,e)}async dropNamespace(t){await this.namespaceOps.dropNamespace(t)}async loadNamespaceMetadata(t){return this.namespaceOps.loadNamespaceMetadata(t)}async listTables(t){return this.tableOps.listTables(t)}async createTable(t,e){return this.tableOps.createTable(t,e)}async updateTable(t,e){return this.tableOps.updateTable(t,e)}async dropTable(t,e){await this.tableOps.dropTable(t,e)}async loadTable(t){return this.tableOps.loadTable(t)}async namespaceExists(t){return this.namespaceOps.namespaceExists(t)}async tableExists(t){return this.tableOps.tableExists(t)}async createNamespaceIfNotExists(t,e){return this.namespaceOps.createNamespaceIfNotExists(t,e)}async createTableIfNotExists(t,e){return this.tableOps.createTableIfNotExists(t,e)}},Bs=class extends Error{constructor(t,e="storage",n,s){super(t),this.__isStorageError=!0,this.namespace=e,this.name=e==="vectors"?"StorageVectorsError":"StorageError",this.status=n,this.statusCode=s}};function Ls(t){return typeof t=="object"&&t!==null&&"__isStorageError"in t}var hs=class extends Bs{constructor(t,e,n,s="storage"){super(t,s,e,n),this.name=s==="vectors"?"StorageVectorsApiError":"StorageApiError",this.status=e,this.statusCode=n}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},No=class extends Bs{constructor(t,e,n="storage"){super(t,n),this.name=n==="vectors"?"StorageVectorsUnknownError":"StorageUnknownError",this.originalError=e}};const qc=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),Fc=t=>{if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},Er=t=>{if(Array.isArray(t))return t.map(n=>Er(n));if(typeof t=="function"||t!==Object(t))return t;const e={};return Object.entries(t).forEach(([n,s])=>{const r=n.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[r]=Er(s)}),e},Hc=t=>!t||typeof t!="string"||t.length===0||t.length>100||t.trim()!==t||t.includes("/")||t.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(t);function Ln(t){"@babel/helpers - typeof";return Ln=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ln(t)}function Wc(t,e){if(Ln(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var s=n.call(t,e);if(Ln(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Vc(t){var e=Wc(t,"string");return Ln(e)=="symbol"?e:e+""}function Gc(t,e,n){return(e=Vc(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Xi(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,s)}return n}function R(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Xi(Object(n),!0).forEach(function(s){Gc(t,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Xi(Object(n)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(n,s))})}return t}const Zi=t=>{var e;return t.msg||t.message||t.error_description||(typeof t.error=="string"?t.error:(e=t.error)===null||e===void 0?void 0:e.message)||JSON.stringify(t)},Kc=async(t,e,n,s)=>{if(t&&typeof t=="object"&&"status"in t&&"ok"in t&&typeof t.status=="number"&&!(n!=null&&n.noResolveJson)){const r=t,i=r.status||500;if(typeof r.json=="function")r.json().then(o=>{const a=(o==null?void 0:o.statusCode)||(o==null?void 0:o.code)||i+"";e(new hs(Zi(o),i,a,s))}).catch(()=>{if(s==="vectors"){const o=i+"";e(new hs(r.statusText||`HTTP ${i} error`,i,o,s))}else{const o=i+"";e(new hs(r.statusText||`HTTP ${i} error`,i,o,s))}});else{const o=i+"";e(new hs(r.statusText||`HTTP ${i} error`,i,o,s))}}else e(new No(Zi(t),t,s))},Jc=(t,e,n,s)=>{const r={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"||t==="HEAD"||!s?R(R({},r),n):(Fc(s)?(r.headers=R({"Content-Type":"application/json"},e==null?void 0:e.headers),r.body=JSON.stringify(s)):r.body=s,e!=null&&e.duplex&&(r.duplex=e.duplex),R(R({},r),n))};async function xn(t,e,n,s,r,i,o){return new Promise((a,l)=>{t(n,Jc(e,s,r,i)).then(c=>{if(!c.ok)throw c;if(s!=null&&s.noResolveJson)return c;if(o==="vectors"){const d=c.headers.get("content-type");if(c.headers.get("content-length")==="0"||c.status===204)return{};if(!d||!d.includes("application/json"))return{}}return c.json()}).then(c=>a(c)).catch(c=>Kc(c,l,s,o))})}function Uo(t="storage"){return{get:async(e,n,s,r)=>xn(e,"GET",n,s,r,void 0,t),post:async(e,n,s,r,i)=>xn(e,"POST",n,r,i,s,t),put:async(e,n,s,r,i)=>xn(e,"PUT",n,r,i,s,t),head:async(e,n,s,r)=>xn(e,"HEAD",n,R(R({},s),{},{noResolveJson:!0}),r,void 0,t),remove:async(e,n,s,r,i)=>xn(e,"DELETE",n,r,i,s,t)}}const Yc=Uo("storage"),{get:Mn,post:Be,put:Ir,head:Qc,remove:Vr}=Yc,Ee=Uo("vectors");var fn=class{constructor(t,e={},n,s="storage"){this.shouldThrowOnError=!1,this.url=t,this.headers=e,this.fetch=qc(n),this.namespace=s}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(t,e){return this.headers=R(R({},this.headers),{},{[t]:e}),this}async handleOperation(t){var e=this;try{return{data:await t(),error:null}}catch(n){if(e.shouldThrowOnError)throw n;if(Ls(n))return{data:null,error:n};throw n}}},Xc=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e}then(t,e){return this.execute().then(t,e)}async execute(){var t=this;try{return{data:(await t.downloadFn()).body,error:null}}catch(e){if(t.shouldThrowOnError)throw e;if(Ls(e))return{data:null,error:e};throw e}}};let qo;qo=Symbol.toStringTag;var Zc=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e,this[qo]="BlobDownloadBuilder",this.promise=null}asStream(){return new Xc(this.downloadFn,this.shouldThrowOnError)}then(t,e){return this.getPromise().then(t,e)}catch(t){return this.getPromise().catch(t)}finally(t){return this.getPromise().finally(t)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var t=this;try{return{data:await(await t.downloadFn()).blob(),error:null}}catch(e){if(t.shouldThrowOnError)throw e;if(Ls(e))return{data:null,error:e};throw e}}};const ed={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},eo={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var td=class extends fn{constructor(t,e={},n,s){super(t,e,s,"storage"),this.bucketId=n}async uploadOrUpdate(t,e,n,s){var r=this;return r.handleOperation(async()=>{let i;const o=R(R({},eo),s);let a=R(R({},r.headers),t==="POST"&&{"x-upsert":String(o.upsert)});const l=o.metadata;typeof Blob<"u"&&n instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),l&&i.append("metadata",r.encodeMetadata(l)),i.append("",n)):typeof FormData<"u"&&n instanceof FormData?(i=n,i.has("cacheControl")||i.append("cacheControl",o.cacheControl),l&&!i.has("metadata")&&i.append("metadata",r.encodeMetadata(l))):(i=n,a["cache-control"]=`max-age=${o.cacheControl}`,a["content-type"]=o.contentType,l&&(a["x-metadata"]=r.toBase64(r.encodeMetadata(l))),(typeof ReadableStream<"u"&&i instanceof ReadableStream||i&&typeof i=="object"&&"pipe"in i&&typeof i.pipe=="function")&&!o.duplex&&(o.duplex="half")),s!=null&&s.headers&&(a=R(R({},a),s.headers));const c=r._removeEmptyFolders(e),d=r._getFinalPath(c),u=await(t=="PUT"?Ir:Be)(r.fetch,`${r.url}/object/${d}`,i,R({headers:a},o!=null&&o.duplex?{duplex:o.duplex}:{}));return{path:c,id:u.Id,fullPath:u.Key}})}async upload(t,e,n){return this.uploadOrUpdate("POST",t,e,n)}async uploadToSignedUrl(t,e,n,s){var r=this;const i=r._removeEmptyFolders(t),o=r._getFinalPath(i),a=new URL(r.url+`/object/upload/sign/${o}`);return a.searchParams.set("token",e),r.handleOperation(async()=>{let l;const c=R({upsert:eo.upsert},s),d=R(R({},r.headers),{"x-upsert":String(c.upsert)});return typeof Blob<"u"&&n instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",n)):typeof FormData<"u"&&n instanceof FormData?(l=n,l.append("cacheControl",c.cacheControl)):(l=n,d["cache-control"]=`max-age=${c.cacheControl}`,d["content-type"]=c.contentType),{path:i,fullPath:(await Ir(r.fetch,a.toString(),l,{headers:d})).Key}})}async createSignedUploadUrl(t,e){var n=this;return n.handleOperation(async()=>{let s=n._getFinalPath(t);const r=R({},n.headers);e!=null&&e.upsert&&(r["x-upsert"]="true");const i=await Be(n.fetch,`${n.url}/object/upload/sign/${s}`,{},{headers:r}),o=new URL(n.url+i.url),a=o.searchParams.get("token");if(!a)throw new Bs("No token returned by API");return{signedUrl:o.toString(),path:t,token:a}})}async update(t,e,n){return this.uploadOrUpdate("PUT",t,e,n)}async move(t,e,n){var s=this;return s.handleOperation(async()=>await Be(s.fetch,`${s.url}/object/move`,{bucketId:s.bucketId,sourceKey:t,destinationKey:e,destinationBucket:n==null?void 0:n.destinationBucket},{headers:s.headers}))}async copy(t,e,n){var s=this;return s.handleOperation(async()=>({path:(await Be(s.fetch,`${s.url}/object/copy`,{bucketId:s.bucketId,sourceKey:t,destinationKey:e,destinationBucket:n==null?void 0:n.destinationBucket},{headers:s.headers})).Key}))}async createSignedUrl(t,e,n){var s=this;return s.handleOperation(async()=>{let r=s._getFinalPath(t),i=await Be(s.fetch,`${s.url}/object/sign/${r}`,R({expiresIn:e},n!=null&&n.transform?{transform:n.transform}:{}),{headers:s.headers});const o=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return{signedUrl:encodeURI(`${s.url}${i.signedURL}${o}`)}})}async createSignedUrls(t,e,n){var s=this;return s.handleOperation(async()=>{const r=await Be(s.fetch,`${s.url}/object/sign/${s.bucketId}`,{expiresIn:e,paths:t},{headers:s.headers}),i=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return r.map(o=>R(R({},o),{},{signedUrl:o.signedURL?encodeURI(`${s.url}${o.signedURL}${i}`):null}))})}download(t,e,n){const s=typeof(e==null?void 0:e.transform)<"u"?"render/image/authenticated":"object",r=this.transformOptsToQueryString((e==null?void 0:e.transform)||{}),i=r?`?${r}`:"",o=this._getFinalPath(t),a=()=>Mn(this.fetch,`${this.url}/${s}/${o}${i}`,{headers:this.headers,noResolveJson:!0},n);return new Zc(a,this.shouldThrowOnError)}async info(t){var e=this;const n=e._getFinalPath(t);return e.handleOperation(async()=>Er(await Mn(e.fetch,`${e.url}/object/info/${n}`,{headers:e.headers})))}async exists(t){var e=this;const n=e._getFinalPath(t);try{return await Qc(e.fetch,`${e.url}/object/${n}`,{headers:e.headers}),{data:!0,error:null}}catch(s){if(e.shouldThrowOnError)throw s;if(Ls(s)&&s instanceof No){const r=s.originalError;if([400,404].includes(r==null?void 0:r.status))return{data:!1,error:s}}throw s}}getPublicUrl(t,e){const n=this._getFinalPath(t),s=[],r=e!=null&&e.download?`download=${e.download===!0?"":e.download}`:"";r!==""&&s.push(r);const i=typeof(e==null?void 0:e.transform)<"u"?"render/image":"object",o=this.transformOptsToQueryString((e==null?void 0:e.transform)||{});o!==""&&s.push(o);let a=s.join("&");return a!==""&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${i}/public/${n}${a}`)}}}async remove(t){var e=this;return e.handleOperation(async()=>await Vr(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:t},{headers:e.headers}))}async list(t,e,n){var s=this;return s.handleOperation(async()=>{const r=R(R(R({},ed),e),{},{prefix:t||""});return await Be(s.fetch,`${s.url}/object/list/${s.bucketId}`,r,{headers:s.headers},n)})}async listV2(t,e){var n=this;return n.handleOperation(async()=>{const s=R({},t);return await Be(n.fetch,`${n.url}/object/list-v2/${n.bucketId}`,s,{headers:n.headers},e)})}encodeMetadata(t){return JSON.stringify(t)}toBase64(t){return typeof Buffer<"u"?Buffer.from(t).toString("base64"):btoa(t)}_getFinalPath(t){return`${this.bucketId}/${t.replace(/^\/+/,"")}`}_removeEmptyFolders(t){return t.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(t){const e=[];return t.width&&e.push(`width=${t.width}`),t.height&&e.push(`height=${t.height}`),t.resize&&e.push(`resize=${t.resize}`),t.format&&e.push(`format=${t.format}`),t.quality&&e.push(`quality=${t.quality}`),e.join("&")}};const nd="2.98.0",Kn={"X-Client-Info":`storage-js/${nd}`};var sd=class extends fn{constructor(t,e={},n,s){const r=new URL(t);s!=null&&s.useNewHostname&&/supabase\.(co|in|red)$/.test(r.hostname)&&!r.hostname.includes("storage.supabase.")&&(r.hostname=r.hostname.replace("supabase.","storage.supabase."));const i=r.href.replace(/\/$/,""),o=R(R({},Kn),e);super(i,o,n,"storage")}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const n=e.listBucketOptionsToQueryString(t);return await Mn(e.fetch,`${e.url}/bucket${n}`,{headers:e.headers})})}async getBucket(t){var e=this;return e.handleOperation(async()=>await Mn(e.fetch,`${e.url}/bucket/${t}`,{headers:e.headers}))}async createBucket(t,e={public:!1}){var n=this;return n.handleOperation(async()=>await Be(n.fetch,`${n.url}/bucket`,{id:t,name:t,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:n.headers}))}async updateBucket(t,e){var n=this;return n.handleOperation(async()=>await Ir(n.fetch,`${n.url}/bucket/${t}`,{id:t,name:t,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:n.headers}))}async emptyBucket(t){var e=this;return e.handleOperation(async()=>await Be(e.fetch,`${e.url}/bucket/${t}/empty`,{},{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await Vr(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}listBucketOptionsToQueryString(t){const e={};return t&&("limit"in t&&(e.limit=String(t.limit)),"offset"in t&&(e.offset=String(t.offset)),t.search&&(e.search=t.search),t.sortColumn&&(e.sortColumn=t.sortColumn),t.sortOrder&&(e.sortOrder=t.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},rd=class extends fn{constructor(t,e={},n){const s=t.replace(/\/$/,""),r=R(R({},Kn),e);super(s,r,n,"storage")}async createBucket(t){var e=this;return e.handleOperation(async()=>await Be(e.fetch,`${e.url}/bucket`,{name:t},{headers:e.headers}))}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const n=new URLSearchParams;(t==null?void 0:t.limit)!==void 0&&n.set("limit",t.limit.toString()),(t==null?void 0:t.offset)!==void 0&&n.set("offset",t.offset.toString()),t!=null&&t.sortColumn&&n.set("sortColumn",t.sortColumn),t!=null&&t.sortOrder&&n.set("sortOrder",t.sortOrder),t!=null&&t.search&&n.set("search",t.search);const s=n.toString(),r=s?`${e.url}/bucket?${s}`:`${e.url}/bucket`;return await Mn(e.fetch,r,{headers:e.headers})})}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await Vr(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}from(t){var e=this;if(!Hc(t))throw new Bs("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const n=new Uc({baseUrl:this.url,catalogName:t,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),s=this.shouldThrowOnError;return new Proxy(n,{get(r,i){const o=r[i];return typeof o!="function"?o:async(...a)=>{try{return{data:await o.apply(r,a),error:null}}catch(l){if(s)throw l;return{data:null,error:l}}}}})}},id=class extends fn{constructor(t,e={},n){const s=t.replace(/\/$/,""),r=R(R({},Kn),{},{"Content-Type":"application/json"},e);super(s,r,n,"vectors")}async createIndex(t){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/CreateIndex`,t,{headers:e.headers})||{})}async getIndex(t,e){var n=this;return n.handleOperation(async()=>await Ee.post(n.fetch,`${n.url}/GetIndex`,{vectorBucketName:t,indexName:e},{headers:n.headers}))}async listIndexes(t){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/ListIndexes`,t,{headers:e.headers}))}async deleteIndex(t,e){var n=this;return n.handleOperation(async()=>await Ee.post(n.fetch,`${n.url}/DeleteIndex`,{vectorBucketName:t,indexName:e},{headers:n.headers})||{})}},od=class extends fn{constructor(t,e={},n){const s=t.replace(/\/$/,""),r=R(R({},Kn),{},{"Content-Type":"application/json"},e);super(s,r,n,"vectors")}async putVectors(t){var e=this;if(t.vectors.length<1||t.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/PutVectors`,t,{headers:e.headers})||{})}async getVectors(t){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/GetVectors`,t,{headers:e.headers}))}async listVectors(t){var e=this;if(t.segmentCount!==void 0){if(t.segmentCount<1||t.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(t.segmentIndex!==void 0&&(t.segmentIndex<0||t.segmentIndex>=t.segmentCount))throw new Error(`segmentIndex must be between 0 and ${t.segmentCount-1}`)}return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/ListVectors`,t,{headers:e.headers}))}async queryVectors(t){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/QueryVectors`,t,{headers:e.headers}))}async deleteVectors(t){var e=this;if(t.keys.length<1||t.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/DeleteVectors`,t,{headers:e.headers})||{})}},ad=class extends fn{constructor(t,e={},n){const s=t.replace(/\/$/,""),r=R(R({},Kn),{},{"Content-Type":"application/json"},e);super(s,r,n,"vectors")}async createBucket(t){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}async getBucket(t){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:t},{headers:e.headers}))}async listBuckets(t={}){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/ListVectorBuckets`,t,{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await Ee.post(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}},ld=class extends ad{constructor(t,e={}){super(t,e.headers||{},e.fetch)}from(t){return new cd(this.url,this.headers,t,this.fetch)}async createBucket(t){var e=()=>super.createBucket,n=this;return e().call(n,t)}async getBucket(t){var e=()=>super.getBucket,n=this;return e().call(n,t)}async listBuckets(t={}){var e=()=>super.listBuckets,n=this;return e().call(n,t)}async deleteBucket(t){var e=()=>super.deleteBucket,n=this;return e().call(n,t)}},cd=class extends id{constructor(t,e,n,s){super(t,e,s),this.vectorBucketName=n}async createIndex(t){var e=()=>super.createIndex,n=this;return e().call(n,R(R({},t),{},{vectorBucketName:n.vectorBucketName}))}async listIndexes(t={}){var e=()=>super.listIndexes,n=this;return e().call(n,R(R({},t),{},{vectorBucketName:n.vectorBucketName}))}async getIndex(t){var e=()=>super.getIndex,n=this;return e().call(n,n.vectorBucketName,t)}async deleteIndex(t){var e=()=>super.deleteIndex,n=this;return e().call(n,n.vectorBucketName,t)}index(t){return new dd(this.url,this.headers,this.vectorBucketName,t,this.fetch)}},dd=class extends od{constructor(t,e,n,s,r){super(t,e,r),this.vectorBucketName=n,this.indexName=s}async putVectors(t){var e=()=>super.putVectors,n=this;return e().call(n,R(R({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async getVectors(t){var e=()=>super.getVectors,n=this;return e().call(n,R(R({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async listVectors(t={}){var e=()=>super.listVectors,n=this;return e().call(n,R(R({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async queryVectors(t){var e=()=>super.queryVectors,n=this;return e().call(n,R(R({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async deleteVectors(t){var e=()=>super.deleteVectors,n=this;return e().call(n,R(R({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}},ud=class extends sd{constructor(t,e={},n,s){super(t,e,n,s)}from(t){return new td(this.url,this.headers,t,this.fetch)}get vectors(){return new ld(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new rd(this.url+"/iceberg",this.headers,this.fetch)}};const Fo="2.98.0",nn=30*1e3,Tr=3,dr=Tr*nn,pd="http://localhost:9999",hd="supabase.auth.token",fd={"X-Client-Info":`gotrue-js/${Fo}`},Cr="X-Supabase-Api-Version",Ho={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},gd=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,md=10*60*1e3;class jn extends Error{constructor(e,n,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=n,this.code=s}}function A(t){return typeof t=="object"&&t!==null&&"__isAuthError"in t}class vd extends jn{constructor(e,n,s){super(e,n,s),this.name="AuthApiError",this.status=n,this.code=s}}function yd(t){return A(t)&&t.name==="AuthApiError"}class Ot extends jn{constructor(e,n){super(e),this.name="AuthUnknownError",this.originalError=n}}class at extends jn{constructor(e,n,s,r){super(e,s,r),this.name=n,this.status=s}}class ke extends at{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function ur(t){return A(t)&&t.name==="AuthSessionMissingError"}class Qt extends at{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class fs extends at{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class gs extends at{constructor(e,n=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=n}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function bd(t){return A(t)&&t.name==="AuthImplicitGrantRedirectError"}class to extends at{constructor(e,n=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=n}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class wd extends at{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class Pr extends at{constructor(e,n){super(e,"AuthRetryableFetchError",n,void 0)}}function pr(t){return A(t)&&t.name==="AuthRetryableFetchError"}class no extends at{constructor(e,n,s){super(e,"AuthWeakPasswordError",n,"weak_password"),this.reasons=s}}class Ar extends at{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const ks="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),so=` 	
\r=`.split(""),xd=(()=>{const t=new Array(128);for(let e=0;e<t.length;e+=1)t[e]=-1;for(let e=0;e<so.length;e+=1)t[so[e].charCodeAt(0)]=-2;for(let e=0;e<ks.length;e+=1)t[ks[e].charCodeAt(0)]=e;return t})();function ro(t,e,n){if(t!==null)for(e.queue=e.queue<<8|t,e.queuedBits+=8;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;n(ks[s]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;n(ks[s]),e.queuedBits-=6}}function Wo(t,e,n){const s=xd[t];if(s>-1)for(e.queue=e.queue<<6|s,e.queuedBits+=6;e.queuedBits>=8;)n(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(t)}"`)}}function io(t){const e=[],n=o=>{e.push(String.fromCodePoint(o))},s={utf8seq:0,codepoint:0},r={queue:0,queuedBits:0},i=o=>{kd(o,s,n)};for(let o=0;o<t.length;o+=1)Wo(t.charCodeAt(o),r,i);return e.join("")}function _d(t,e){if(t<=127){e(t);return}else if(t<=2047){e(192|t>>6),e(128|t&63);return}else if(t<=65535){e(224|t>>12),e(128|t>>6&63),e(128|t&63);return}else if(t<=1114111){e(240|t>>18),e(128|t>>12&63),e(128|t>>6&63),e(128|t&63);return}throw new Error(`Unrecognized Unicode codepoint: ${t.toString(16)}`)}function Sd(t,e){for(let n=0;n<t.length;n+=1){let s=t.charCodeAt(n);if(s>55295&&s<=56319){const r=(s-55296)*1024&65535;s=(t.charCodeAt(n+1)-56320&65535|r)+65536,n+=1}_d(s,e)}}function kd(t,e,n){if(e.utf8seq===0){if(t<=127){n(t);return}for(let s=1;s<6;s+=1)if(!(t>>7-s&1)){e.utf8seq=s;break}if(e.utf8seq===2)e.codepoint=t&31;else if(e.utf8seq===3)e.codepoint=t&15;else if(e.utf8seq===4)e.codepoint=t&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(t<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|t&63,e.utf8seq-=1,e.utf8seq===0&&n(e.codepoint)}}function un(t){const e=[],n={queue:0,queuedBits:0},s=r=>{e.push(r)};for(let r=0;r<t.length;r+=1)Wo(t.charCodeAt(r),n,s);return new Uint8Array(e)}function $d(t){const e=[];return Sd(t,n=>e.push(n)),new Uint8Array(e)}function Bt(t){const e=[],n={queue:0,queuedBits:0},s=r=>{e.push(r)};return t.forEach(r=>ro(r,n,s)),ro(null,n,s),e.join("")}function Ed(t){return Math.round(Date.now()/1e3)+t}function Id(){return Symbol("auth-callback")}const ie=()=>typeof window<"u"&&typeof document<"u",It={tested:!1,writable:!1},Vo=()=>{if(!ie())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(It.tested)return It.writable;const t=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(t,t),globalThis.localStorage.removeItem(t),It.tested=!0,It.writable=!0}catch{It.tested=!0,It.writable=!1}return It.writable};function Td(t){const e={},n=new URL(t);if(n.hash&&n.hash[0]==="#")try{new URLSearchParams(n.hash.substring(1)).forEach((r,i)=>{e[i]=r})}catch{}return n.searchParams.forEach((s,r)=>{e[r]=s}),e}const Go=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),Cd=t=>typeof t=="object"&&t!==null&&"status"in t&&"ok"in t&&"json"in t&&typeof t.json=="function",sn=async(t,e,n)=>{await t.setItem(e,JSON.stringify(n))},Tt=async(t,e)=>{const n=await t.getItem(e);if(!n)return null;try{return JSON.parse(n)}catch{return n}},re=async(t,e)=>{await t.removeItem(e)};class Ms{constructor(){this.promise=new Ms.promiseConstructor((e,n)=>{this.resolve=e,this.reject=n})}}Ms.promiseConstructor=Promise;function ms(t){const e=t.split(".");if(e.length!==3)throw new Ar("Invalid JWT structure");for(let s=0;s<e.length;s++)if(!gd.test(e[s]))throw new Ar("JWT not in base64url format");return{header:JSON.parse(io(e[0])),payload:JSON.parse(io(e[1])),signature:un(e[2]),raw:{header:e[0],payload:e[1]}}}async function Pd(t){return await new Promise(e=>{setTimeout(()=>e(null),t)})}function Ad(t,e){return new Promise((s,r)=>{(async()=>{for(let i=0;i<1/0;i++)try{const o=await t(i);if(!e(i,null,o)){s(o);return}}catch(o){if(!e(i,o)){r(o);return}}})()})}function Od(t){return("0"+t.toString(16)).substr(-2)}function Dd(){const e=new Uint32Array(56);if(typeof crypto>"u"){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=n.length;let r="";for(let i=0;i<56;i++)r+=n.charAt(Math.floor(Math.random()*s));return r}return crypto.getRandomValues(e),Array.from(e,Od).join("")}async function Rd(t){const n=new TextEncoder().encode(t),s=await crypto.subtle.digest("SHA-256",n),r=new Uint8Array(s);return Array.from(r).map(i=>String.fromCharCode(i)).join("")}async function Bd(t){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),t;const n=await Rd(t);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Xt(t,e,n=!1){const s=Dd();let r=s;n&&(r+="/PASSWORD_RECOVERY"),await sn(t,`${e}-code-verifier`,r);const i=await Bd(s);return[i,s===i?"plain":"s256"]}const Ld=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Md(t){const e=t.headers.get(Cr);if(!e||!e.match(Ld))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function jd(t){if(!t)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(t<=e)throw new Error("JWT has expired")}function zd(t){switch(t){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Nd=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Zt(t){if(!Nd.test(t))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function hr(){const t={};return new Proxy(t,{get:(e,n)=>{if(n==="__isUserNotAvailableProxy")return!0;if(typeof n=="symbol"){const s=n.toString();if(s==="Symbol(Symbol.toPrimitive)"||s==="Symbol(Symbol.toStringTag)"||s==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${n}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,n)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${n}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,n)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${n}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Ud(t,e){return new Proxy(t,{get:(n,s,r)=>{if(s==="__isInsecureUserWarningProxy")return!0;if(typeof s=="symbol"){const i=s.toString();if(i==="Symbol(Symbol.toPrimitive)"||i==="Symbol(Symbol.toStringTag)"||i==="Symbol(util.inspect.custom)"||i==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(n,s,r)}return!e.value&&typeof s=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(n,s,r)}})}function oo(t){return JSON.parse(JSON.stringify(t))}const Ct=t=>t.msg||t.message||t.error_description||t.error||JSON.stringify(t),qd=[502,503,504];async function ao(t){var e;if(!Cd(t))throw new Pr(Ct(t),0);if(qd.includes(t.status))throw new Pr(Ct(t),t.status);let n;try{n=await t.json()}catch(i){throw new Ot(Ct(i),i)}let s;const r=Md(t);if(r&&r.getTime()>=Ho["2024-01-01"].timestamp&&typeof n=="object"&&n&&typeof n.code=="string"?s=n.code:typeof n=="object"&&n&&typeof n.error_code=="string"&&(s=n.error_code),s){if(s==="weak_password")throw new no(Ct(n),t.status,((e=n.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(s==="session_not_found")throw new ke}else if(typeof n=="object"&&n&&typeof n.weak_password=="object"&&n.weak_password&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.reasons.reduce((i,o)=>i&&typeof o=="string",!0))throw new no(Ct(n),t.status,n.weak_password.reasons);throw new vd(Ct(n),t.status||500,s)}const Fd=(t,e,n,s)=>{const r={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"?r:(r.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),r.body=JSON.stringify(s),Object.assign(Object.assign({},r),n))};async function B(t,e,n,s){var r;const i=Object.assign({},s==null?void 0:s.headers);i[Cr]||(i[Cr]=Ho["2024-01-01"].name),s!=null&&s.jwt&&(i.Authorization=`Bearer ${s.jwt}`);const o=(r=s==null?void 0:s.query)!==null&&r!==void 0?r:{};s!=null&&s.redirectTo&&(o.redirect_to=s.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=await Hd(t,e,n+a,{headers:i,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(l):{data:Object.assign({},l),error:null}}async function Hd(t,e,n,s,r,i){const o=Fd(e,s,r,i);let a;try{a=await t(n,Object.assign({},o))}catch(l){throw console.error(l),new Pr(Ct(l),0)}if(a.ok||await ao(a),s!=null&&s.noResolveJson)return a;try{return await a.json()}catch(l){await ao(l)}}function Re(t){var e;let n=null;Gd(t)&&(n=Object.assign({},t),t.expires_at||(n.expires_at=Ed(t.expires_in)));const s=(e=t.user)!==null&&e!==void 0?e:t;return{data:{session:n,user:s},error:null}}function lo(t){const e=Re(t);return!e.error&&t.weak_password&&typeof t.weak_password=="object"&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.message&&typeof t.weak_password.message=="string"&&t.weak_password.reasons.reduce((n,s)=>n&&typeof s=="string",!0)&&(e.data.weak_password=t.weak_password),e}function ft(t){var e;return{data:{user:(e=t.user)!==null&&e!==void 0?e:t},error:null}}function Wd(t){return{data:t,error:null}}function Vd(t){const{action_link:e,email_otp:n,hashed_token:s,redirect_to:r,verification_type:i}=t,o=Rs(t,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:n,hashed_token:s,redirect_to:r,verification_type:i},l=Object.assign({},o);return{data:{properties:a,user:l},error:null}}function co(t){return t}function Gd(t){return t.access_token&&t.refresh_token&&t.expires_in}const fr=["global","local","others"];class Kd{constructor({url:e="",headers:n={},fetch:s}){this.url=e,this.headers=n,this.fetch=Go(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,n=fr[0]){if(fr.indexOf(n)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${fr.join(", ")}`);try{return await B(this.fetch,"POST",`${this.url}/logout?scope=${n}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(A(s))return{data:null,error:s};throw s}}async inviteUserByEmail(e,n={}){try{return await B(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:n.data},headers:this.headers,redirectTo:n.redirectTo,xform:ft})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async generateLink(e){try{const{options:n}=e,s=Rs(e,["options"]),r=Object.assign(Object.assign({},s),n);return"newEmail"in s&&(r.new_email=s==null?void 0:s.newEmail,delete r.newEmail),await B(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:r,headers:this.headers,xform:Vd,redirectTo:n==null?void 0:n.redirectTo})}catch(n){if(A(n))return{data:{properties:null,user:null},error:n};throw n}}async createUser(e){try{return await B(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:ft})}catch(n){if(A(n))return{data:{user:null},error:n};throw n}}async listUsers(e){var n,s,r,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},d=await B(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(n=e==null?void 0:e.page)===null||n===void 0?void 0:n.toString())!==null&&s!==void 0?s:"",per_page:(i=(r=e==null?void 0:e.perPage)===null||r===void 0?void 0:r.toString())!==null&&i!==void 0?i:""},xform:co});if(d.error)throw d.error;const u=await d.json(),p=(o=d.headers.get("x-total-count"))!==null&&o!==void 0?o:0,f=(l=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(m=>{const v=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),g=JSON.parse(m.split(";")[1].split("=")[1]);c[`${g}Page`]=v}),c.total=parseInt(p)),{data:Object.assign(Object.assign({},u),c),error:null}}catch(c){if(A(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){Zt(e);try{return await B(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:ft})}catch(n){if(A(n))return{data:{user:null},error:n};throw n}}async updateUserById(e,n){Zt(e);try{return await B(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:n,headers:this.headers,xform:ft})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async deleteUser(e,n=!1){Zt(e);try{return await B(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:n},xform:ft})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async _listFactors(e){Zt(e.userId);try{const{data:n,error:s}=await B(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:r=>({data:{factors:r},error:null})});return{data:n,error:s}}catch(n){if(A(n))return{data:null,error:n};throw n}}async _deleteFactor(e){Zt(e.userId),Zt(e.id);try{return{data:await B(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(n){if(A(n))return{data:null,error:n};throw n}}async _listOAuthClients(e){var n,s,r,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},d=await B(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(n=e==null?void 0:e.page)===null||n===void 0?void 0:n.toString())!==null&&s!==void 0?s:"",per_page:(i=(r=e==null?void 0:e.perPage)===null||r===void 0?void 0:r.toString())!==null&&i!==void 0?i:""},xform:co});if(d.error)throw d.error;const u=await d.json(),p=(o=d.headers.get("x-total-count"))!==null&&o!==void 0?o:0,f=(l=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(m=>{const v=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),g=JSON.parse(m.split(";")[1].split("=")[1]);c[`${g}Page`]=v}),c.total=parseInt(p)),{data:Object.assign(Object.assign({},u),c),error:null}}catch(c){if(A(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(e){try{return await B(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:n=>({data:n,error:null})})}catch(n){if(A(n))return{data:null,error:n};throw n}}async _getOAuthClient(e){try{return await B(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:n=>({data:n,error:null})})}catch(n){if(A(n))return{data:null,error:n};throw n}}async _updateOAuthClient(e,n){try{return await B(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:n,headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(A(s))return{data:null,error:s};throw s}}async _deleteOAuthClient(e){try{return await B(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(n){if(A(n))return{data:null,error:n};throw n}}async _regenerateOAuthClientSecret(e){try{return await B(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:n=>({data:n,error:null})})}catch(n){if(A(n))return{data:null,error:n};throw n}}}function uo(t={}){return{getItem:e=>t[e]||null,setItem:(e,n)=>{t[e]=n},removeItem:e=>{delete t[e]}}}const Xe={debug:!!(globalThis&&Vo()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class Ko extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Jd extends Ko{}async function Yd(t,e,n){Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",t,e);const s=new globalThis.AbortController;e>0&&setTimeout(()=>{s.abort(),Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",t)},e),await Promise.resolve();try{return await globalThis.navigator.locks.request(t,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async r=>{if(r){Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",t,r.name);try{return await n()}finally{Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",t,r.name)}}else{if(e===0)throw Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",t),new Jd(`Acquiring an exclusive Navigator LockManager lock "${t}" immediately failed`);if(Xe.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await n()}})}catch(r){if((r==null?void 0:r.name)==="AbortError"&&e>0)return Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire timeout, recovering by stealing lock",t),console.warn(`@supabase/gotrue-js: Lock "${t}" was not released within ${e}ms. This may indicate an orphaned lock from a component unmount (e.g., React Strict Mode). Forcefully acquiring the lock to recover.`),await Promise.resolve().then(()=>globalThis.navigator.locks.request(t,{mode:"exclusive",steal:!0},async i=>{if(i){Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock: recovered (stolen)",t,i.name);try{return await n()}finally{Xe.debug&&console.log("@supabase/gotrue-js: navigatorLock: released (stolen)",t,i.name)}}else return console.warn("@supabase/gotrue-js: Navigator LockManager returned null lock even with steal: true"),await n()}));throw r}}function Qd(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function Jo(t){if(!/^0x[a-fA-F0-9]{40}$/.test(t))throw new Error(`@supabase/auth-js: Address "${t}" is invalid.`);return t.toLowerCase()}function Xd(t){return parseInt(t,16)}function Zd(t){const e=new TextEncoder().encode(t);return"0x"+Array.from(e,s=>s.toString(16).padStart(2,"0")).join("")}function eu(t){var e;const{chainId:n,domain:s,expirationTime:r,issuedAt:i=new Date,nonce:o,notBefore:a,requestId:l,resources:c,scheme:d,uri:u,version:p}=t;{if(!Number.isInteger(n))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${n}`);if(!s)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(o&&o.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${o}`);if(!u)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(p!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${p}`);if(!((e=t.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${t.statement}`)}const f=Jo(t.address),m=d?`${d}://${s}`:s,v=t.statement?`${t.statement}
`:"",g=`${m} wants you to sign in with your Ethereum account:
${f}

${v}`;let b=`URI: ${u}
Version: ${p}
Chain ID: ${n}${o?`
Nonce: ${o}`:""}
Issued At: ${i.toISOString()}`;if(r&&(b+=`
Expiration Time: ${r.toISOString()}`),a&&(b+=`
Not Before: ${a.toISOString()}`),l&&(b+=`
Request ID: ${l}`),c){let S=`
Resources:`;for(const k of c){if(!k||typeof k!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${k}`);S+=`
- ${k}`}b+=S}return`${g}
${b}`}class ee extends Error{constructor({message:e,code:n,cause:s,name:r}){var i;super(e,{cause:s}),this.__isWebAuthnError=!0,this.name=(i=r??(s instanceof Error?s.name:void 0))!==null&&i!==void 0?i:"Unknown Error",this.code=n}}class $s extends ee{constructor(e,n){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n,message:e}),this.name="WebAuthnUnknownError",this.originalError=n}}function tu({error:t,options:e}){var n,s,r;const{publicKey:i}=e;if(!i)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ee({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else if(t.name==="ConstraintError"){if(((n=i.authenticatorSelection)===null||n===void 0?void 0:n.requireResidentKey)===!0)return new ee({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:t});if(e.mediation==="conditional"&&((s=i.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new ee({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:t});if(((r=i.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new ee({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:t})}else{if(t.name==="InvalidStateError")return new ee({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:t});if(t.name==="NotAllowedError")return new ee({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="NotSupportedError")return i.pubKeyCredParams.filter(a=>a.type==="public-key").length===0?new ee({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:t}):new ee({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:t});if(t.name==="SecurityError"){const o=window.location.hostname;if(Yo(o)){if(i.rp.id!==o)return new ee({message:`The RP ID "${i.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new ee({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="TypeError"){if(i.user.id.byteLength<1||i.user.id.byteLength>64)return new ee({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:t})}else if(t.name==="UnknownError")return new ee({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new ee({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}function nu({error:t,options:e}){const{publicKey:n}=e;if(!n)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ee({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else{if(t.name==="NotAllowedError")return new ee({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="SecurityError"){const s=window.location.hostname;if(Yo(s)){if(n.rpId!==s)return new ee({message:`The RP ID "${n.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new ee({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="UnknownError")return new ee({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new ee({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}class su{createNewAbortSignal(){if(this.controller){const n=new Error("Cancelling existing WebAuthn API call for new one");n.name="AbortError",this.controller.abort(n)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const ru=new su;function iu(t){if(!t)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(t);const{challenge:e,user:n,excludeCredentials:s}=t,r=Rs(t,["challenge","user","excludeCredentials"]),i=un(e).buffer,o=Object.assign(Object.assign({},n),{id:un(n.id).buffer}),a=Object.assign(Object.assign({},r),{challenge:i,user:o});if(s&&s.length>0){a.excludeCredentials=new Array(s.length);for(let l=0;l<s.length;l++){const c=s[l];a.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:un(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return a}function ou(t){if(!t)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(t);const{challenge:e,allowCredentials:n}=t,s=Rs(t,["challenge","allowCredentials"]),r=un(e).buffer,i=Object.assign(Object.assign({},s),{challenge:r});if(n&&n.length>0){i.allowCredentials=new Array(n.length);for(let o=0;o<n.length;o++){const a=n[o];i.allowCredentials[o]=Object.assign(Object.assign({},a),{id:un(a.id).buffer,type:a.type||"public-key",transports:a.transports})}}return i}function au(t){var e;if("toJSON"in t&&typeof t.toJSON=="function")return t.toJSON();const n=t;return{id:t.id,rawId:t.id,response:{attestationObject:Bt(new Uint8Array(t.response.attestationObject)),clientDataJSON:Bt(new Uint8Array(t.response.clientDataJSON))},type:"public-key",clientExtensionResults:t.getClientExtensionResults(),authenticatorAttachment:(e=n.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function lu(t){var e;if("toJSON"in t&&typeof t.toJSON=="function")return t.toJSON();const n=t,s=t.getClientExtensionResults(),r=t.response;return{id:t.id,rawId:t.id,response:{authenticatorData:Bt(new Uint8Array(r.authenticatorData)),clientDataJSON:Bt(new Uint8Array(r.clientDataJSON)),signature:Bt(new Uint8Array(r.signature)),userHandle:r.userHandle?Bt(new Uint8Array(r.userHandle)):void 0},type:"public-key",clientExtensionResults:s,authenticatorAttachment:(e=n.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function Yo(t){return t==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(t)}function po(){var t,e;return!!(ie()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((t=navigator==null?void 0:navigator.credentials)===null||t===void 0?void 0:t.create)=="function"&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.get)=="function")}async function cu(t){try{const e=await navigator.credentials.create(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new $s("Browser returned unexpected credential type",e)}:{data:null,error:new $s("Empty credential response",e)}}catch(e){return{data:null,error:tu({error:e,options:t})}}}async function du(t){try{const e=await navigator.credentials.get(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new $s("Browser returned unexpected credential type",e)}:{data:null,error:new $s("Empty credential response",e)}}catch(e){return{data:null,error:nu({error:e,options:t})}}}const uu={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},pu={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Es(...t){const e=r=>r!==null&&typeof r=="object"&&!Array.isArray(r),n=r=>r instanceof ArrayBuffer||ArrayBuffer.isView(r),s={};for(const r of t)if(r)for(const i in r){const o=r[i];if(o!==void 0)if(Array.isArray(o))s[i]=o;else if(n(o))s[i]=o;else if(e(o)){const a=s[i];e(a)?s[i]=Es(a,o):s[i]=Es(o)}else s[i]=o}return s}function hu(t,e){return Es(uu,t,e||{})}function fu(t,e){return Es(pu,t,e||{})}class gu{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:n,friendlyName:s,signal:r},i){var o;try{const{data:a,error:l}=await this.client.mfa.challenge({factorId:e,webauthn:n});if(!a)return{data:null,error:l};const c=r??ru.createNewAbortSignal();if(a.webauthn.type==="create"){const{user:d}=a.webauthn.credential_options.publicKey;if(!d.name){const u=s;if(u)d.name=`${d.id}:${u}`;else{const f=(await this.client.getUser()).data.user,m=((o=f==null?void 0:f.user_metadata)===null||o===void 0?void 0:o.name)||(f==null?void 0:f.email)||(f==null?void 0:f.id)||"User";d.name=`${d.id}:${m}`}}d.displayName||(d.displayName=d.name)}switch(a.webauthn.type){case"create":{const d=hu(a.webauthn.credential_options.publicKey,i==null?void 0:i.create),{data:u,error:p}=await cu({publicKey:d,signal:c});return u?{data:{factorId:e,challengeId:a.id,webauthn:{type:a.webauthn.type,credential_response:u}},error:null}:{data:null,error:p}}case"request":{const d=fu(a.webauthn.credential_options.publicKey,i==null?void 0:i.request),{data:u,error:p}=await du(Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:d,signal:c}));return u?{data:{factorId:e,challengeId:a.id,webauthn:{type:a.webauthn.type,credential_response:u}},error:null}:{data:null,error:p}}}}catch(a){return A(a)?{data:null,error:a}:{data:null,error:new Ot("Unexpected error in challenge",a)}}}async _verify({challengeId:e,factorId:n,webauthn:s}){return this.client.mfa.verify({factorId:n,challengeId:e,webauthn:s})}async _authenticate({factorId:e,webauthn:{rpId:n=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:r}={}},i){if(!n)return{data:null,error:new jn("rpId is required for WebAuthn authentication")};try{if(!po())return{data:null,error:new Ot("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this.challenge({factorId:e,webauthn:{rpId:n,rpOrigins:s},signal:r},{request:i});if(!o)return{data:null,error:a};const{webauthn:l}=o;return this._verify({factorId:e,challengeId:o.challengeId,webauthn:{type:l.type,rpId:n,rpOrigins:s,credential_response:l.credential_response}})}catch(o){return A(o)?{data:null,error:o}:{data:null,error:new Ot("Unexpected error in authenticate",o)}}}async _register({friendlyName:e,webauthn:{rpId:n=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:r}={}},i){if(!n)return{data:null,error:new jn("rpId is required for WebAuthn registration")};try{if(!po())return{data:null,error:new Ot("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this._enroll({friendlyName:e});if(!o)return await this.client.mfa.listFactors().then(d=>{var u;return(u=d.data)===null||u===void 0?void 0:u.all.find(p=>p.factor_type==="webauthn"&&p.friendly_name===e&&p.status!=="unverified")}).then(d=>d?this.client.mfa.unenroll({factorId:d==null?void 0:d.id}):void 0),{data:null,error:a};const{data:l,error:c}=await this._challenge({factorId:o.id,friendlyName:o.friendly_name,webauthn:{rpId:n,rpOrigins:s},signal:r},{create:i});return l?this._verify({factorId:o.id,challengeId:l.challengeId,webauthn:{rpId:n,rpOrigins:s,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(o){return A(o)?{data:null,error:o}:{data:null,error:new Ot("Unexpected error in register",o)}}}}Qd();const mu={url:pd,storageKey:hd,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:fd,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:5e3,skipAutoInitialize:!1};async function ho(t,e,n){return await n()}const en={};class zn{get jwks(){var e,n;return(n=(e=en[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&n!==void 0?n:{keys:[]}}set jwks(e){en[this.storageKey]=Object.assign(Object.assign({},en[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,n;return(n=(e=en[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&n!==void 0?n:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){en[this.storageKey]=Object.assign(Object.assign({},en[this.storageKey]),{cachedAt:e})}constructor(e){var n,s,r;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const i=Object.assign(Object.assign({},mu),e);if(this.storageKey=i.storageKey,this.instanceID=(n=zn.nextInstanceID[this.storageKey])!==null&&n!==void 0?n:0,zn.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!i.debug,typeof i.debug=="function"&&(this.logger=i.debug),this.instanceID>0&&ie()){const o=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(o),this.logDebugMessages&&console.trace(o)}if(this.persistSession=i.persistSession,this.autoRefreshToken=i.autoRefreshToken,this.admin=new Kd({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=Go(i.fetch),this.lock=i.lock||ho,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,this.throwOnError=i.throwOnError,this.lockAcquireTimeout=i.lockAcquireTimeout,i.lock?this.lock=i.lock:this.persistSession&&ie()&&(!((s=globalThis==null?void 0:globalThis.navigator)===null||s===void 0)&&s.locks)?this.lock=Yd:this.lock=ho,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new gu(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(i.storage?this.storage=i.storage:Vo()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=uo(this.memoryStorage)),i.userStorage&&(this.userStorage=i.userStorage)):(this.memoryStorage={},this.storage=uo(this.memoryStorage)),ie()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(o){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",o)}(r=this.broadcastChannel)===null||r===void 0||r.addEventListener("message",async o=>{this._debug("received broadcast notification from other tab or client",o);try{await this._notifyAllSubscribers(o.data.event,o.data.session,!1)}catch(a){this._debug("#broadcastChannel","error",a)}})}i.skipAutoInitialize||this.initialize().catch(o=>{this._debug("#initialize()","error",o)})}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${Fo}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let n={},s="none";if(ie()&&(n=Td(window.location.href),this._isImplicitGrantCallback(n)?s="implicit":await this._isPKCECallback(n)&&(s="pkce")),ie()&&this.detectSessionInUrl&&s!=="none"){const{data:r,error:i}=await this._getSessionFromURL(n,s);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),bd(i)){const l=(e=i.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:i}}return{error:i}}const{session:o,redirectType:a}=r;return this._debug("#_initialize()","detected session in URL",o,"redirect type",a),await this._saveSession(o),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(n){return A(n)?this._returnResult({error:n}):this._returnResult({error:new Ot("Unexpected error during initialization",n)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var n,s,r;try{const i=await B(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(n=e==null?void 0:e.options)===null||n===void 0?void 0:n.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(r=e==null?void 0:e.options)===null||r===void 0?void 0:r.captchaToken}},xform:Re}),{data:o,error:a}=i;if(a||!o)return this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signUp(e){var n,s,r;try{let i;if("email"in e){const{email:d,password:u,options:p}=e;let f=null,m=null;this.flowType==="pkce"&&([f,m]=await Xt(this.storage,this.storageKey)),i=await B(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:p==null?void 0:p.emailRedirectTo,body:{email:d,password:u,data:(n=p==null?void 0:p.data)!==null&&n!==void 0?n:{},gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken},code_challenge:f,code_challenge_method:m},xform:Re})}else if("phone"in e){const{phone:d,password:u,options:p}=e;i=await B(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:u,data:(s=p==null?void 0:p.data)!==null&&s!==void 0?s:{},channel:(r=p==null?void 0:p.channel)!==null&&r!==void 0?r:"sms",gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken}},xform:Re})}else throw new fs("You must provide either an email or phone number and a password");const{data:o,error:a}=i;if(a||!o)return await re(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(await re(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithPassword(e){try{let n;if("email"in e){const{email:i,password:o,options:a}=e;n=await B(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:lo})}else if("phone"in e){const{phone:i,password:o,options:a}=e;n=await B(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:lo})}else throw new fs("You must provide either an email or phone number and a password");const{data:s,error:r}=n;if(r)return this._returnResult({data:{user:null,session:null},error:r});if(!s||!s.session||!s.user){const i=new Qt;return this._returnResult({data:{user:null,session:null},error:i})}return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),this._returnResult({data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:r})}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithOAuth(e){var n,s,r,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(n=e.options)===null||n===void 0?void 0:n.redirectTo,scopes:(s=e.options)===null||s===void 0?void 0:s.scopes,queryParams:(r=e.options)===null||r===void 0?void 0:r.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:n}=e;switch(n){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${n}"`)}}async signInWithEthereum(e){var n,s,r,i,o,a,l,c,d,u,p;let f,m;if("message"in e)f=e.message,m=e.signature;else{const{chain:v,wallet:g,statement:b,options:S}=e;let k;if(ie())if(typeof g=="object")k=g;else{const W=window;if("ethereum"in W&&typeof W.ethereum=="object"&&"request"in W.ethereum&&typeof W.ethereum.request=="function")k=W.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof g!="object"||!(S!=null&&S.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");k=g}const P=new URL((n=S==null?void 0:S.url)!==null&&n!==void 0?n:window.location.href),M=await k.request({method:"eth_requestAccounts"}).then(W=>W).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!M||M.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const D=Jo(M[0]);let q=(s=S==null?void 0:S.signInWithEthereum)===null||s===void 0?void 0:s.chainId;if(!q){const W=await k.request({method:"eth_chainId"});q=Xd(W)}const O={domain:P.host,address:D,statement:b,uri:P.href,version:"1",chainId:q,nonce:(r=S==null?void 0:S.signInWithEthereum)===null||r===void 0?void 0:r.nonce,issuedAt:(o=(i=S==null?void 0:S.signInWithEthereum)===null||i===void 0?void 0:i.issuedAt)!==null&&o!==void 0?o:new Date,expirationTime:(a=S==null?void 0:S.signInWithEthereum)===null||a===void 0?void 0:a.expirationTime,notBefore:(l=S==null?void 0:S.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=S==null?void 0:S.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(d=S==null?void 0:S.signInWithEthereum)===null||d===void 0?void 0:d.resources};f=eu(O),m=await k.request({method:"personal_sign",params:[Zd(f),D]})}try{const{data:v,error:g}=await B(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:f,signature:m},!((u=e.options)===null||u===void 0)&&u.captchaToken?{gotrue_meta_security:{captcha_token:(p=e.options)===null||p===void 0?void 0:p.captchaToken}}:null),xform:Re});if(g)throw g;if(!v||!v.session||!v.user){const b=new Qt;return this._returnResult({data:{user:null,session:null},error:b})}return v.session&&(await this._saveSession(v.session),await this._notifyAllSubscribers("SIGNED_IN",v.session)),this._returnResult({data:Object.assign({},v),error:g})}catch(v){if(A(v))return this._returnResult({data:{user:null,session:null},error:v});throw v}}async signInWithSolana(e){var n,s,r,i,o,a,l,c,d,u,p,f;let m,v;if("message"in e)m=e.message,v=e.signature;else{const{chain:g,wallet:b,statement:S,options:k}=e;let P;if(ie())if(typeof b=="object")P=b;else{const D=window;if("solana"in D&&typeof D.solana=="object"&&("signIn"in D.solana&&typeof D.solana.signIn=="function"||"signMessage"in D.solana&&typeof D.solana.signMessage=="function"))P=D.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof b!="object"||!(k!=null&&k.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");P=b}const M=new URL((n=k==null?void 0:k.url)!==null&&n!==void 0?n:window.location.href);if("signIn"in P&&P.signIn){const D=await P.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},k==null?void 0:k.signInWithSolana),{version:"1",domain:M.host,uri:M.href}),S?{statement:S}:null));let q;if(Array.isArray(D)&&D[0]&&typeof D[0]=="object")q=D[0];else if(D&&typeof D=="object"&&"signedMessage"in D&&"signature"in D)q=D;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in q&&"signature"in q&&(typeof q.signedMessage=="string"||q.signedMessage instanceof Uint8Array)&&q.signature instanceof Uint8Array)m=typeof q.signedMessage=="string"?q.signedMessage:new TextDecoder().decode(q.signedMessage),v=q.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in P)||typeof P.signMessage!="function"||!("publicKey"in P)||typeof P!="object"||!P.publicKey||!("toBase58"in P.publicKey)||typeof P.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");m=[`${M.host} wants you to sign in with your Solana account:`,P.publicKey.toBase58(),...S?["",S,""]:[""],"Version: 1",`URI: ${M.href}`,`Issued At: ${(r=(s=k==null?void 0:k.signInWithSolana)===null||s===void 0?void 0:s.issuedAt)!==null&&r!==void 0?r:new Date().toISOString()}`,...!((i=k==null?void 0:k.signInWithSolana)===null||i===void 0)&&i.notBefore?[`Not Before: ${k.signInWithSolana.notBefore}`]:[],...!((o=k==null?void 0:k.signInWithSolana)===null||o===void 0)&&o.expirationTime?[`Expiration Time: ${k.signInWithSolana.expirationTime}`]:[],...!((a=k==null?void 0:k.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${k.signInWithSolana.chainId}`]:[],...!((l=k==null?void 0:k.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${k.signInWithSolana.nonce}`]:[],...!((c=k==null?void 0:k.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${k.signInWithSolana.requestId}`]:[],...!((u=(d=k==null?void 0:k.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||u===void 0)&&u.length?["Resources",...k.signInWithSolana.resources.map(q=>`- ${q}`)]:[]].join(`
`);const D=await P.signMessage(new TextEncoder().encode(m),"utf8");if(!D||!(D instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");v=D}}try{const{data:g,error:b}=await B(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:m,signature:Bt(v)},!((p=e.options)===null||p===void 0)&&p.captchaToken?{gotrue_meta_security:{captcha_token:(f=e.options)===null||f===void 0?void 0:f.captchaToken}}:null),xform:Re});if(b)throw b;if(!g||!g.session||!g.user){const S=new Qt;return this._returnResult({data:{user:null,session:null},error:S})}return g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),this._returnResult({data:Object.assign({},g),error:b})}catch(g){if(A(g))return this._returnResult({data:{user:null,session:null},error:g});throw g}}async _exchangeCodeForSession(e){const n=await Tt(this.storage,`${this.storageKey}-code-verifier`),[s,r]=(n??"").split("/");try{if(!s&&this.flowType==="pkce")throw new wd;const{data:i,error:o}=await B(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:Re});if(await re(this.storage,`${this.storageKey}-code-verifier`),o)throw o;if(!i||!i.session||!i.user){const a=new Qt;return this._returnResult({data:{user:null,session:null,redirectType:null},error:a})}return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),this._returnResult({data:Object.assign(Object.assign({},i),{redirectType:r??null}),error:o})}catch(i){if(await re(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:{user:null,session:null,redirectType:null},error:i});throw i}}async signInWithIdToken(e){try{const{options:n,provider:s,token:r,access_token:i,nonce:o}=e,a=await B(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:r,access_token:i,nonce:o,gotrue_meta_security:{captcha_token:n==null?void 0:n.captchaToken}},xform:Re}),{data:l,error:c}=a;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){const d=new Qt;return this._returnResult({data:{user:null,session:null},error:d})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithOtp(e){var n,s,r,i,o;try{if("email"in e){const{email:a,options:l}=e;let c=null,d=null;this.flowType==="pkce"&&([c,d]=await Xt(this.storage,this.storageKey));const{error:u}=await B(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(n=l==null?void 0:l.data)!==null&&n!==void 0?n:{},create_user:(s=l==null?void 0:l.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:c,code_challenge_method:d},redirectTo:l==null?void 0:l.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:u})}if("phone"in e){const{phone:a,options:l}=e,{data:c,error:d}=await B(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(r=l==null?void 0:l.data)!==null&&r!==void 0?r:{},create_user:(i=l==null?void 0:l.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(o=l==null?void 0:l.channel)!==null&&o!==void 0?o:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c==null?void 0:c.message_id},error:d})}throw new fs("You must provide either an email or phone number.")}catch(a){if(await re(this.storage,`${this.storageKey}-code-verifier`),A(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async verifyOtp(e){var n,s;try{let r,i;"options"in e&&(r=(n=e.options)===null||n===void 0?void 0:n.redirectTo,i=(s=e.options)===null||s===void 0?void 0:s.captchaToken);const{data:o,error:a}=await B(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:r,xform:Re});if(a)throw a;if(!o)throw new Error("An error occurred on token verification.");const l=o.session,c=o.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(r){if(A(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async signInWithSSO(e){var n,s,r,i,o;try{let a=null,l=null;this.flowType==="pkce"&&([a,l]=await Xt(this.storage,this.storageKey));const c=await B(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(s=(n=e.options)===null||n===void 0?void 0:n.redirectTo)!==null&&s!==void 0?s:void 0}),!((r=e==null?void 0:e.options)===null||r===void 0)&&r.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:l}),headers:this.headers,xform:Wd});return!((i=c.data)===null||i===void 0)&&i.url&&ie()&&!(!((o=e.options)===null||o===void 0)&&o.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(a){if(await re(this.storage,`${this.storageKey}-code-verifier`),A(a))return this._returnResult({data:null,error:a});throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:n},error:s}=e;if(s)throw s;if(!n)throw new ke;const{error:r}=await B(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:n.access_token});return this._returnResult({data:{user:null,session:null},error:r})})}catch(e){if(A(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const n=`${this.url}/resend`;if("email"in e){const{email:s,type:r,options:i}=e,{error:o}=await B(this.fetch,"POST",n,{headers:this.headers,body:{email:s,type:r,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},redirectTo:i==null?void 0:i.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:o})}else if("phone"in e){const{phone:s,type:r,options:i}=e,{data:o,error:a}=await B(this.fetch,"POST",n,{headers:this.headers,body:{phone:s,type:r,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:o==null?void 0:o.message_id},error:a})}throw new fs("You must provide either an email or phone number and a type")}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async n=>n))}async _acquireLock(e,n){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),r=(async()=>(await s,await n()))();return this.pendingInLock.push((async()=>{try{await r}catch{}})()),r}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=n();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const r=[...this.pendingInLock];await Promise.all(r),this.pendingInLock.splice(0,r.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const n=await this.__loadSession();return await e(n)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const n=await Tt(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",n),n!==null&&(this._isValidSession(n)?e=n:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=e.expires_at?e.expires_at*1e3-Date.now()<dr:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.userStorage){const o=await Tt(this.userStorage,this.storageKey+"-user");o!=null&&o.user?e.user=o.user:e.user=hr()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const o={value:this.suppressGetSessionWarning};e.user=Ud(e.user,o),o.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:r,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{session:null},error:i}):this._returnResult({data:{session:r},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const n=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return n.data.user&&(this.suppressGetSessionWarning=!0),n}async _getUser(e){try{return e?await B(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:ft}):await this._useSession(async n=>{var s,r,i;const{data:o,error:a}=n;if(a)throw a;return!(!((s=o.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new ke}:await B(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(r=o.session)===null||r===void 0?void 0:r.access_token)!==null&&i!==void 0?i:void 0,xform:ft})})}catch(n){if(A(n))return ur(n)&&(await this._removeSession(),await re(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:n});throw n}}async updateUser(e,n={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,n))}async _updateUser(e,n={}){try{return await this._useSession(async s=>{const{data:r,error:i}=s;if(i)throw i;if(!r.session)throw new ke;const o=r.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await Xt(this.storage,this.storageKey));const{data:c,error:d}=await B(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:n==null?void 0:n.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:o.access_token,xform:ft});if(d)throw d;return o.user=c.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),this._returnResult({data:{user:o.user},error:null})})}catch(s){if(await re(this.storage,`${this.storageKey}-code-verifier`),A(s))return this._returnResult({data:{user:null},error:s});throw s}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new ke;const n=Date.now()/1e3;let s=n,r=!0,i=null;const{payload:o}=ms(e.access_token);if(o.exp&&(s=o.exp,r=s<=n),r){const{data:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!a)return{data:{user:null,session:null},error:null};i=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});i={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:s-n,expires_at:s},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return this._returnResult({data:{user:i.user,session:i},error:null})}catch(n){if(A(n))return this._returnResult({data:{session:null,user:null},error:n});throw n}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async n=>{var s;if(!e){const{data:o,error:a}=n;if(a)throw a;e=(s=o.session)!==null&&s!==void 0?s:void 0}if(!(e!=null&&e.refresh_token))throw new ke;const{data:r,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{user:null,session:null},error:i}):r?this._returnResult({data:{user:r.user,session:r},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async _getSessionFromURL(e,n){try{if(!ie())throw new gs("No browser detected.");if(e.error||e.error_description||e.error_code)throw new gs(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(n){case"implicit":if(this.flowType==="pkce")throw new to("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new gs("Not a valid implicit grant flow url.");break;default:}if(n==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new to("No code detected.");const{data:S,error:k}=await this._exchangeCodeForSession(e.code);if(k)throw k;const P=new URL(window.location.href);return P.searchParams.delete("code"),window.history.replaceState(window.history.state,"",P.toString()),{data:{session:S.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:r,access_token:i,refresh_token:o,expires_in:a,expires_at:l,token_type:c}=e;if(!i||!a||!o||!c)throw new gs("No session defined in URL");const d=Math.round(Date.now()/1e3),u=parseInt(a);let p=d+u;l&&(p=parseInt(l));const f=p-d;f*1e3<=nn&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${u}s`);const m=p-u;d-m>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",m,p,d):d-m<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",m,p,d);const{data:v,error:g}=await this._getUser(i);if(g)throw g;const b={provider_token:s,provider_refresh_token:r,access_token:i,expires_in:u,expires_at:p,refresh_token:o,token_type:c,user:v.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:b,redirectType:e.type},error:null})}catch(s){if(A(s))return this._returnResult({data:{session:null,redirectType:null},error:s});throw s}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const n=await Tt(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&n)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async n=>{var s;const{data:r,error:i}=n;if(i&&!ur(i))return this._returnResult({error:i});const o=(s=r.session)===null||s===void 0?void 0:s.access_token;if(o){const{error:a}=await this.admin.signOut(o,e);if(a&&!(yd(a)&&(a.status===404||a.status===401||a.status===403)||ur(a)))return this._returnResult({error:a})}return e!=="others"&&(await this._removeSession(),await re(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const n=Id(),s={id:n,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",n),this.stateChangeEmitters.delete(n)}};return this._debug("#onAuthStateChange()","registered callback with id",n),this.stateChangeEmitters.set(n,s),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(n)})))(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async n=>{var s,r;try{const{data:{session:i},error:o}=n;if(o)throw o;await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,n={}){let s=null,r=null;this.flowType==="pkce"&&([s,r]=await Xt(this.storage,this.storageKey,!0));try{return await B(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:r,gotrue_meta_security:{captcha_token:n.captchaToken}},headers:this.headers,redirectTo:n.redirectTo})}catch(i){if(await re(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:null,error:i});throw i}}async getUserIdentities(){var e;try{const{data:n,error:s}=await this.getUser();if(s)throw s;return this._returnResult({data:{identities:(e=n.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var n;try{const{data:s,error:r}=await this._useSession(async i=>{var o,a,l,c,d;const{data:u,error:p}=i;if(p)throw p;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await B(this.fetch,"GET",f,{headers:this.headers,jwt:(d=(c=u.session)===null||c===void 0?void 0:c.access_token)!==null&&d!==void 0?d:void 0})});if(r)throw r;return ie()&&!(!((n=e.options)===null||n===void 0)&&n.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),this._returnResult({data:{provider:e.provider,url:s==null?void 0:s.url},error:null})}catch(s){if(A(s))return this._returnResult({data:{provider:e.provider,url:null},error:s});throw s}}async linkIdentityIdToken(e){return await this._useSession(async n=>{var s;try{const{error:r,data:{session:i}}=n;if(r)throw r;const{options:o,provider:a,token:l,access_token:c,nonce:d}=e,u=await B(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(s=i==null?void 0:i.access_token)!==null&&s!==void 0?s:void 0,body:{provider:a,id_token:l,access_token:c,nonce:d,link_identity:!0,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:Re}),{data:p,error:f}=u;return f?this._returnResult({data:{user:null,session:null},error:f}):!p||!p.session||!p.user?this._returnResult({data:{user:null,session:null},error:new Qt}):(p.session&&(await this._saveSession(p.session),await this._notifyAllSubscribers("USER_UPDATED",p.session)),this._returnResult({data:p,error:f}))}catch(r){if(await re(this.storage,`${this.storageKey}-code-verifier`),A(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}})}async unlinkIdentity(e){try{return await this._useSession(async n=>{var s,r;const{data:i,error:o}=n;if(o)throw o;return await B(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(r=(s=i.session)===null||s===void 0?void 0:s.access_token)!==null&&r!==void 0?r:void 0})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _refreshAccessToken(e){const n=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(n,"begin");try{const s=Date.now();return await Ad(async r=>(r>0&&await Pd(200*Math.pow(2,r-1)),this._debug(n,"refreshing attempt",r),await B(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Re})),(r,i)=>{const o=200*Math.pow(2,r);return i&&pr(i)&&Date.now()+o-s<nn})}catch(s){if(this._debug(n,"error",s),A(s))return this._returnResult({data:{session:null,user:null},error:s});throw s}finally{this._debug(n,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,n){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:n.redirectTo,scopes:n.scopes,queryParams:n.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",n,"url",s),ie()&&!n.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e,n;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const r=await Tt(this.storage,this.storageKey);if(r&&this.userStorage){let o=await Tt(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!o&&(o={user:r.user},await sn(this.userStorage,this.storageKey+"-user",o)),r.user=(e=o==null?void 0:o.user)!==null&&e!==void 0?e:hr()}else if(r&&!r.user&&!r.user){const o=await Tt(this.storage,this.storageKey+"-user");o&&(o!=null&&o.user)?(r.user=o.user,await re(this.storage,this.storageKey+"-user"),await sn(this.storage,this.storageKey,r)):r.user=hr()}if(this._debug(s,"session from storage",r),!this._isValidSession(r)){this._debug(s,"session is not valid"),r!==null&&await this._removeSession();return}const i=((n=r.expires_at)!==null&&n!==void 0?n:1/0)*1e3-Date.now()<dr;if(this._debug(s,`session has${i?"":" not"} expired with margin of ${dr}s`),i){if(this.autoRefreshToken&&r.refresh_token){const{error:o}=await this._callRefreshToken(r.refresh_token);o&&(console.error(o),pr(o)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",o),await this._removeSession()))}}else if(r.user&&r.user.__isUserNotAvailableProxy===!0)try{const{data:o,error:a}=await this._getUser(r.access_token);!a&&(o!=null&&o.user)?(r.user=o.user,await this._saveSession(r),await this._notifyAllSubscribers("SIGNED_IN",r)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(o){console.error("Error getting user data:",o),this._debug(s,"error getting user data, skipping SIGNED_IN notification",o)}else await this._notifyAllSubscribers("SIGNED_IN",r)}catch(r){this._debug(s,"error",r),console.error(r);return}finally{this._debug(s,"end")}}async _callRefreshToken(e){var n,s;if(!e)throw new ke;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const r=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(r,"begin");try{this.refreshingDeferred=new Ms;const{data:i,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!i.session)throw new ke;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const a={data:i.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(i){if(this._debug(r,"error",i),A(i)){const o={data:null,error:i};return pr(i)||await this._removeSession(),(n=this.refreshingDeferred)===null||n===void 0||n.resolve(o),o}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(i),i}finally{this.refreshingDeferred=null,this._debug(r,"end")}}async _notifyAllSubscribers(e,n,s=!0){const r=`#_notifyAllSubscribers(${e})`;this._debug(r,"begin",n,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:n});const i=[],o=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,n)}catch(l){i.push(l)}});if(await Promise.all(o),i.length>0){for(let a=0;a<i.length;a+=1)console.error(i[a]);throw i[0]}}finally{this._debug(r,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await re(this.storage,`${this.storageKey}-code-verifier`);const n=Object.assign({},e),s=n.user&&n.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!s&&n.user&&await sn(this.userStorage,this.storageKey+"-user",{user:n.user});const r=Object.assign({},n);delete r.user;const i=oo(r);await sn(this.storage,this.storageKey,i)}else{const r=oo(n);await sn(this.storage,this.storageKey,r)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await re(this.storage,this.storageKey),await re(this.storage,this.storageKey+"-code-verifier"),await re(this.storage,this.storageKey+"-user"),this.userStorage&&await re(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&ie()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(n){console.error("removing visibilitychange callback failed",n)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),nn);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const n=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=n,n&&typeof n=="object"&&typeof n.unref=="function"?n.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(n)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const n=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,n&&clearTimeout(n)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async n=>{const{data:{session:s}}=n;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const r=Math.floor((s.expires_at*1e3-e)/nn);this._debug("#_autoRefreshTokenTick()",`access token expires in ${r} ticks, a tick lasts ${nn}ms, refresh threshold is ${Tr} ticks`),r<=Tr&&await this._callRefreshToken(s.refresh_token)})}catch(n){console.error("Auto refresh tick failed with error. This is likely a transient error.",n)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof Ko)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ie()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>{try{await this._onVisibilityChanged(!1)}catch(e){this._debug("#visibilityChangedCallback","error",e)}},window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const n=`#_onVisibilityChanged(${e})`;this._debug(n,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(n,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,n,s){const r=[`provider=${encodeURIComponent(n)}`];if(s!=null&&s.redirectTo&&r.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&r.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[i,o]=await Xt(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});r.push(a.toString())}if(s!=null&&s.queryParams){const i=new URLSearchParams(s.queryParams);r.push(i.toString())}return s!=null&&s.skipBrowserRedirect&&r.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${r.join("&")}`}async _unenroll(e){try{return await this._useSession(async n=>{var s;const{data:r,error:i}=n;return i?this._returnResult({data:null,error:i}):await B(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(s=r==null?void 0:r.session)===null||s===void 0?void 0:s.access_token})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _enroll(e){try{return await this._useSession(async n=>{var s,r;const{data:i,error:o}=n;if(o)return this._returnResult({data:null,error:o});const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:l,error:c}=await B(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token});return c?this._returnResult({data:null,error:c}):(e.factorType==="totp"&&l.type==="totp"&&(!((r=l==null?void 0:l.totp)===null||r===void 0)&&r.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async n=>{var s;const{data:r,error:i}=n;if(i)return this._returnResult({data:null,error:i});const o=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?au(e.webauthn.credential_response):lu(e.webauthn.credential_response)})}:{code:e.code}),{data:a,error:l}=await B(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:o,headers:this.headers,jwt:(s=r==null?void 0:r.session)===null||s===void 0?void 0:s.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),this._returnResult({data:a,error:l}))})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async n=>{var s;const{data:r,error:i}=n;if(i)return this._returnResult({data:null,error:i});const o=await B(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(s=r==null?void 0:r.session)===null||s===void 0?void 0:s.access_token});if(o.error)return o;const{data:a}=o;if(a.type!=="webauthn")return{data:a,error:null};switch(a.webauthn.type){case"create":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:iu(a.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:ou(a.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}})}async _challengeAndVerify(e){const{data:n,error:s}=await this._challenge({factorId:e.factorId});return s?this._returnResult({data:null,error:s}):await this._verify({factorId:e.factorId,challengeId:n.id,code:e.code})}async _listFactors(){var e;const{data:{user:n},error:s}=await this.getUser();if(s)return{data:null,error:s};const r={all:[],phone:[],totp:[],webauthn:[]};for(const i of(e=n==null?void 0:n.factors)!==null&&e!==void 0?e:[])r.all.push(i),i.status==="verified"&&r[i.factor_type].push(i);return{data:r,error:null}}async _getAuthenticatorAssuranceLevel(e){var n,s,r,i;if(e)try{const{payload:f}=ms(e);let m=null;f.aal&&(m=f.aal);let v=m;const{data:{user:g},error:b}=await this.getUser(e);if(b)return this._returnResult({data:null,error:b});((s=(n=g==null?void 0:g.factors)===null||n===void 0?void 0:n.filter(P=>P.status==="verified"))!==null&&s!==void 0?s:[]).length>0&&(v="aal2");const k=f.amr||[];return{data:{currentLevel:m,nextLevel:v,currentAuthenticationMethods:k},error:null}}catch(f){if(A(f))return this._returnResult({data:null,error:f});throw f}const{data:{session:o},error:a}=await this.getSession();if(a)return this._returnResult({data:null,error:a});if(!o)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:l}=ms(o.access_token);let c=null;l.aal&&(c=l.aal);let d=c;((i=(r=o.user.factors)===null||r===void 0?void 0:r.filter(f=>f.status==="verified"))!==null&&i!==void 0?i:[]).length>0&&(d="aal2");const p=l.amr||[];return{data:{currentLevel:c,nextLevel:d,currentAuthenticationMethods:p},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async n=>{const{data:{session:s},error:r}=n;return r?this._returnResult({data:null,error:r}):s?await B(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:s.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new ke})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _approveAuthorization(e,n){try{return await this._useSession(async s=>{const{data:{session:r},error:i}=s;if(i)return this._returnResult({data:null,error:i});if(!r)return this._returnResult({data:null,error:new ke});const o=await B(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:r.access_token,body:{action:"approve"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&ie()&&!(n!=null&&n.skipBrowserRedirect)&&window.location.assign(o.data.redirect_url),o})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _denyAuthorization(e,n){try{return await this._useSession(async s=>{const{data:{session:r},error:i}=s;if(i)return this._returnResult({data:null,error:i});if(!r)return this._returnResult({data:null,error:new ke});const o=await B(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:r.access_token,body:{action:"deny"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&ie()&&!(n!=null&&n.skipBrowserRedirect)&&window.location.assign(o.data.redirect_url),o})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:n},error:s}=e;return s?this._returnResult({data:null,error:s}):n?await B(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:n.access_token,xform:r=>({data:r,error:null})}):this._returnResult({data:null,error:new ke})})}catch(e){if(A(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async n=>{const{data:{session:s},error:r}=n;return r?this._returnResult({data:null,error:r}):s?(await B(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:s.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new ke})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async fetchJwk(e,n={keys:[]}){let s=n.keys.find(a=>a.kid===e);if(s)return s;const r=Date.now();if(s=this.jwks.keys.find(a=>a.kid===e),s&&this.jwks_cached_at+md>r)return s;const{data:i,error:o}=await B(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;return!i.keys||i.keys.length===0||(this.jwks=i,this.jwks_cached_at=r,s=i.keys.find(a=>a.kid===e),!s)?null:s}async getClaims(e,n={}){try{let s=e;if(!s){const{data:f,error:m}=await this.getSession();if(m||!f.session)return this._returnResult({data:null,error:m});s=f.session.access_token}const{header:r,payload:i,signature:o,raw:{header:a,payload:l}}=ms(s);n!=null&&n.allowExpired||jd(i.exp);const c=!r.alg||r.alg.startsWith("HS")||!r.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(r.kid,n!=null&&n.keys?{keys:n.keys}:n==null?void 0:n.jwks);if(!c){const{error:f}=await this.getUser(s);if(f)throw f;return{data:{claims:i,header:r,signature:o},error:null}}const d=zd(r.alg),u=await crypto.subtle.importKey("jwk",c,d,!0,["verify"]);if(!await crypto.subtle.verify(d,u,o,$d(`${a}.${l}`)))throw new Ar("Invalid JWT signature");return{data:{claims:i,header:r,signature:o},error:null}}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}}zn.nextInstanceID={};const vu=zn,yu="2.98.0";let $n="";typeof Deno<"u"?$n="deno":typeof document<"u"?$n="web":typeof navigator<"u"&&navigator.product==="ReactNative"?$n="react-native":$n="node";const bu={"X-Client-Info":`supabase-js-${$n}/${yu}`},wu={headers:bu},xu={schema:"public"},_u={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Su={};function Nn(t){"@babel/helpers - typeof";return Nn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Nn(t)}function ku(t,e){if(Nn(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var s=n.call(t,e);if(Nn(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function $u(t){var e=ku(t,"string");return Nn(e)=="symbol"?e:e+""}function Eu(t,e,n){return(e=$u(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function fo(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,s)}return n}function Y(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?fo(Object(n),!0).forEach(function(s){Eu(t,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):fo(Object(n)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(n,s))})}return t}const Iu=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),Tu=()=>Headers,Cu=(t,e,n)=>{const s=Iu(n),r=Tu();return async(i,o)=>{var a;const l=(a=await e())!==null&&a!==void 0?a:t;let c=new r(o==null?void 0:o.headers);return c.has("apikey")||c.set("apikey",t),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),s(i,Y(Y({},o),{},{headers:c}))}};function Pu(t){return t.endsWith("/")?t:t+"/"}function Au(t,e){var n,s;const{db:r,auth:i,realtime:o,global:a}=t,{db:l,auth:c,realtime:d,global:u}=e,p={db:Y(Y({},l),r),auth:Y(Y({},c),i),realtime:Y(Y({},d),o),storage:{},global:Y(Y(Y({},u),a),{},{headers:Y(Y({},(n=u==null?void 0:u.headers)!==null&&n!==void 0?n:{}),(s=a==null?void 0:a.headers)!==null&&s!==void 0?s:{})}),accessToken:async()=>""};return t.accessToken?p.accessToken=t.accessToken:delete p.accessToken,p}function Ou(t){const e=t==null?void 0:t.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Pu(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var Du=class extends vu{constructor(t){super(t)}},Ru=class{constructor(t,e,n){var s,r;this.supabaseUrl=t,this.supabaseKey=e;const i=Ou(t);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",i),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",i),this.storageUrl=new URL("storage/v1",i),this.functionsUrl=new URL("functions/v1",i);const o=`sb-${i.hostname.split(".")[0]}-auth-token`,a={db:xu,realtime:Su,auth:Y(Y({},_u),{},{storageKey:o}),global:wu},l=Au(n??{},a);if(this.storageKey=(s=l.auth.storageKey)!==null&&s!==void 0?s:"",this.headers=(r=l.global.headers)!==null&&r!==void 0?r:{},l.accessToken)this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(d,u)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(u)} is not possible`)}});else{var c;this.auth=this._initSupabaseAuthClient((c=l.auth)!==null&&c!==void 0?c:{},this.headers,l.global.fetch)}this.fetch=Cu(e,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(Y({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(d=>this.realtime.setAuth(d)).catch(d=>console.warn("Failed to set initial Realtime auth token:",d)),this.rest=new yc(new URL("rest/v1",i).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch,timeout:l.db.timeout,urlLengthLimit:l.db.urlLengthLimit}),this.storage=new ud(this.storageUrl.href,this.headers,this.fetch,n==null?void 0:n.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new dc(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(t){return this.rest.from(t)}schema(t){return this.rest.schema(t)}rpc(t,e={},n={head:!1,get:!1,count:void 0}){return this.rest.rpc(t,e,n)}channel(t,e={config:{}}){return this.realtime.channel(t,e)}getChannels(){return this.realtime.getChannels()}removeChannel(t){return this.realtime.removeChannel(t)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var t=this,e,n;if(t.accessToken)return await t.accessToken();const{data:s}=await t.auth.getSession();return(e=(n=s.session)===null||n===void 0?void 0:n.access_token)!==null&&e!==void 0?e:t.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:t,persistSession:e,detectSessionInUrl:n,storage:s,userStorage:r,storageKey:i,flowType:o,lock:a,debug:l,throwOnError:c},d,u){const p={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Du({url:this.authUrl.href,headers:Y(Y({},p),d),storageKey:i,autoRefreshToken:t,persistSession:e,detectSessionInUrl:n,storage:s,userStorage:r,flowType:o,lock:a,debug:l,throwOnError:c,fetch:u,hasCustomAuthorizationHeader:Object.keys(this.headers).some(f=>f.toLowerCase()==="authorization")})}_initRealtimeClient(t){return new Bc(this.realtimeUrl.href,Y(Y({},t),{},{params:Y(Y({},{apikey:this.supabaseKey}),t==null?void 0:t.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,e)=>{this._handleTokenChanged(t,"CLIENT",e==null?void 0:e.access_token)})}_handleTokenChanged(t,e,n){(t==="TOKEN_REFRESHED"||t==="SIGNED_IN")&&this.changedAccessToken!==n?(this.changedAccessToken=n,this.realtime.setAuth(n)):t==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const Bu=(t,e,n)=>new Ru(t,e,n);function Lu(){if(typeof window<"u")return!1;const t=globalThis.process;if(!t)return!1;const e=t.version;if(e==null)return!1;const n=e.match(/^v(\d+)\./);return n?parseInt(n[1],10)<=18:!1}Lu()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");let mt=null,tt=null,Qo=null,Or="login",gr=!1;function lt(){return tt}function Xo(t){Or=t;const e=t==="login",n=document.getElementById("authTabLogin"),s=document.getElementById("authTabSignup"),r=document.getElementById("authSubmitBtn"),i=document.getElementById("authForgotWrap");n&&(n.style.borderBottomColor=e?"var(--accent)":"transparent"),s&&(s.style.borderBottomColor=e?"transparent":"var(--accent)"),n&&(n.style.color=e?"var(--text)":"var(--muted)"),s&&(s.style.color=e?"var(--muted)":"var(--text)"),r&&(r.textContent=e?"Sign In":"Create Account"),i&&(i.style.display=e?"":"none"),nt("","")}function nt(t,e){const n=document.getElementById("authErr"),s=document.getElementById("authOk");n&&(n.style.display="none"),s&&(s.style.display="none"),t&&(e==="ok"?s&&(s.textContent=t,s.style.display=""):n&&(n.textContent=t,n.style.display=""))}async function Mu(){const t=document.getElementById("authEmail"),e=document.getElementById("authPass"),n=document.getElementById("authSubmitBtn"),s=t?t.value.trim():"",r=e?e.value:"";if(!s||!r){nt("Please enter your email and password.","err");return}n&&(n.textContent="",n.disabled=!0),nt("","");try{if(Or==="login"){const{error:i}=await mt.auth.signInWithPassword({email:s,password:r});if(i)throw i}else{const{error:i}=await mt.auth.signUp({email:s,password:r});if(i)throw i;nt("Account created! Check your email to confirm, then sign in.","ok"),Xo("login"),n&&(n.textContent="Sign In",n.disabled=!1);return}}catch(i){nt(i.message,"err"),n&&(n.textContent=Or==="login"?"Sign In":"Create Account",n.disabled=!1)}}async function ju(){const t=document.getElementById("authEmail"),e=t?t.value.trim():"";if(!e){nt("Enter your email address first.","err");return}const{error:n}=await mt.auth.resetPasswordForEmail(e,{redirectTo:location.origin});n?nt(n.message,"err"):nt("Password reset email sent  check your inbox.","ok")}async function zu(){Zo(),clearTimeout(Qo),tt=null,await mt.auth.signOut(),_.length=0,C.length=0,G.length=0,localStorage.removeItem("ft3_inv"),localStorage.removeItem("ft3_sal"),localStorage.removeItem("ft3_exp"),J(),ge("disconnected"),Dr()}function Dr(){const t=document.getElementById("authOv");if(t){t.style.display="flex";const e=document.getElementById("authEmail"),n=document.getElementById("authPass");e&&(e.value=""),n&&(n.value=""),nt("","")}}function Nu(){const t=document.getElementById("authOv");t&&(t.style.display="none")}function Uu(){const t=document.getElementById("accountMenuEmail");t&&tt&&(t.textContent=tt.email);const e=document.getElementById("accountMenuOv");e&&(e.style.display="flex")}function Zo(){const t=document.getElementById("accountMenuOv");t&&(t.style.display="none")}async function go(t){if(gr)return;gr=!0,tt=t,Nu();const e=document.getElementById("syncDotLbl");e&&(e.textContent=t.email.split("@")[0]),ge("syncing");try{await Promise.race([Kr(),new Promise((n,s)=>setTimeout(()=>s(new Error("Sync timed out")),1e4))]),Ku().catch(n=>console.warn("FlipTrack: supplies pull error:",n.message))}catch(n){ge("error",n.message)}finally{gr=!1}}async function qu(){mt=Bu(Vl,Gl),mt.auth.onAuthStateChange((e,n)=>{e==="SIGNED_OUT"?(tt=null,clearTimeout(Qo),ge("disconnected"),Dr()):e==="SIGNED_IN"&&(n!=null&&n.user)?(!tt||tt.id!==n.user.id)&&go(n.user):n!=null&&n.user&&(tt=n.user)});const{data:{session:t}}=await mt.auth.getSession();t!=null&&t.user?await go(t.user):Dr()}function ct(){return mt}const Is=t=>typeof t=="string"&&t.startsWith("http"),mo="fliptrack",Ne="syncQueue";let _n=null;function Gr(){return _n?Promise.resolve(_n):new Promise((t,e)=>{const n=indexedDB.open(mo);n.onsuccess=()=>{const s=n.result;if(s.objectStoreNames.contains(Ne))_n=s,t(s);else{const r=s.version+1;s.close();const i=indexedDB.open(mo,r);i.onupgradeneeded=o=>{const a=o.target.result;a.objectStoreNames.contains(Ne)||a.createObjectStore(Ne,{keyPath:"id",autoIncrement:!0})},i.onsuccess=()=>{_n=i.result,t(_n)},i.onerror=()=>e(i.error)}},n.onerror=()=>e(n.error)})}async function En(t,e,n){try{if(await ea()>=1e3){console.warn("FlipTrack: offline queue is full (1000 items), skipping enqueue");return}const i=(await Gr()).transaction(Ne,"readwrite");i.objectStore(Ne).add({action:t,table:e,payload:n,ts:Date.now(),retries:0}),await new Promise((o,a)=>{i.oncomplete=o,i.onerror=a})}catch(s){console.warn("FlipTrack: offline queue enqueue failed:",s.message)}}async function Fu(){try{const t=await Gr(),n=t.transaction(Ne,"readonly").objectStore(Ne),s=await new Promise((r,i)=>{const o=n.getAll();o.onsuccess=()=>r(o.result),o.onerror=i});if(s.length){const r=t.transaction(Ne,"readwrite");r.objectStore(Ne).clear(),await new Promise((i,o)=>{r.oncomplete=i,r.onerror=o})}return s.sort((r,i)=>r.ts-i.ts)}catch(t){return console.warn("FlipTrack: offline queue dequeue failed:",t.message),[]}}async function ea(){try{const e=(await Gr()).transaction(Ne,"readonly");return new Promise((n,s)=>{const r=e.objectStore(Ne).count();r.onsuccess=()=>n(r.result),r.onerror=s})}catch{return 0}}async function Hu(t,e){const n=await Fu();if(!n.length)return{ok:0,failed:0,dropped:0};let s=0,r=0,i=0;for(const o of n)try{if(o.action==="upsert"){const l=(Array.isArray(o.payload)?o.payload:[o.payload]).map(d=>({...d,account_id:e,updated_at:new Date(o.ts).toISOString()})),{error:c}=await t.from(o.table).upsert(l,{onConflict:"id"});if(c)throw new Error(c.message);s++}else if(o.action==="delete"){const a=Array.isArray(o.payload)?o.payload:[o.payload];await t.from(o.table).delete().in("id",a),s++}}catch(a){console.warn(`FlipTrack: replay failed for ${o.table}:`,a.message);const l=(o.retries||0)+1;l>=5?(console.warn(`FlipTrack: Dropping queue entry after ${l} retries: ${o.action} on ${o.table}`),i++):(await En(o.action,o.table,o.payload),r++)}return console.log(`FlipTrack: Replayed offline queue  ${s} ok, ${r} failed, ${i} dropped`),{ok:s,failed:r,dropped:i}}let mr=!1;function Wu(t,e){const n=async()=>{if(mr||!await ea())return;const r=t();if(!(!r||!r.sb||!r.accountId)){mr=!0;try{const i=await Hu(r.sb,r.accountId);e&&e(i)}finally{mr=!1}}};window.addEventListener("online",()=>{setTimeout(n,2e3)}),document.addEventListener("visibilitychange",()=>{!document.hidden&&navigator.onLine&&setTimeout(n,1e3)})}function ge(t,e){const n=document.getElementById("syncDot"),s=document.getElementById("syncDotLbl");if(!n||!s)return;n.className="sync-dot";const r=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i={disconnected:{cls:"",txt:"Offline"},connected:{cls:"connected",txt:`Synced ${r}`},syncing:{cls:"syncing",txt:"Syncing"},error:{cls:"error",txt:e||"Sync error"}},o=i[t]||i.disconnected;o.cls&&n.classList.add(o.cls),s.textContent=o.txt}async function Vu(){const t=ct(),e=lt();if(!t||!e)return;if(await Zr(),!navigator.onLine){await vo(),ws();return}const n=e.id,s=sa();try{if(s.inv.length){const r=s.inv.map(o=>{const a={...o};return a.images&&(a.images=a.images.map(l=>Is(l)?l:null).filter(Boolean)),a.image&&!Is(a.image)&&delete a.image,a.images&&a.images.length&&(a.image=a.images[0]),{id:o.id,account_id:n,data:a,updated_at:new Date().toISOString()}}),{error:i}=await t.from("ft_inventory").upsert(r,{onConflict:"id"});if(i)throw new Error(i.message)}if(s.sales.length){const r=s.sales.map(o=>({id:o.id,account_id:n,data:o,updated_at:new Date().toISOString()})),{error:i}=await t.from("ft_sales").upsert(r,{onConflict:"id"});if(i)throw new Error(i.message)}if(s.expenses.length){const r=s.expenses.map(i=>({id:i.id,account_id:n,data:i,updated_at:new Date().toISOString()}));try{const{error:i}=await t.from("ft_expenses").upsert(r,{onConflict:"id"});i&&console.warn("FlipTrack: expenses push error:",i.message)}catch(i){console.warn("FlipTrack: ft_expenses not available:",i.message)}}for(const[r,i]of Object.entries(s.deleted))if(i.length)try{await t.from(r).delete().in("id",i)}catch(o){console.warn(`FlipTrack: delete from ${r} failed:`,o.message)}await Ye("lastSyncPush",new Date().toISOString()).catch(()=>{}),ws()}catch(r){throw console.warn("FlipTrack: push failed, queueing for retry:",r.message),await vo(),ws(),r}}async function vo(){const t=sa();if(t.inv.length){const e=t.inv.map(n=>({id:n.id,data:{...n}}));await En("upsert","ft_inventory",e)}if(t.sales.length){const e=t.sales.map(n=>({id:n.id,data:n}));await En("upsert","ft_sales",e)}if(t.expenses.length){const e=t.expenses.map(n=>({id:n.id,data:n}));await En("upsert","ft_expenses",e)}for(const[e,n]of Object.entries(t.deleted))n.length&&await En("delete",e,n)}async function Gu(){const t=ct(),e=lt();if(!t||!e)return;const n=e.id,s=_.map(a=>{const l={...a};return l.images&&(l.images=l.images.map(c=>Is(c)?c:null).filter(Boolean)),l.image&&!Is(l.image)&&delete l.image,l.images&&l.images.length&&(l.image=l.images[0]),{id:a.id,account_id:n,data:l,updated_at:new Date().toISOString()}}),r=C.map(a=>({id:a.id,account_id:n,data:a,updated_at:new Date().toISOString()})),[i,o]=await Promise.all([s.length?t.from("ft_inventory").upsert(s,{onConflict:"id"}):Promise.resolve({}),r.length?t.from("ft_sales").upsert(r,{onConflict:"id"}):Promise.resolve({})]);if(i.error||o.error)throw new Error((i.error||o.error).message);try{const a=G.map(l=>({id:l.id,account_id:n,data:l,updated_at:new Date().toISOString()}));a.length&&await t.from("ft_expenses").upsert(a,{onConflict:"id"})}catch(a){console.warn("FlipTrack: ft_expenses not available:",a.message)}ws()}async function Jn(t,e){const n=ct(),s=lt();if(!(!n||!s||!e.length))try{await n.from(t).delete().in("id",e)}catch(r){console.warn(`FlipTrack: delete from ${t} failed:`,r.message)}}async function ta(){const t=ct(),e=lt();if(!t||!e)return!1;const n=e.id,s=await wt("lastSyncPull").catch(()=>null);let r=t.from("ft_inventory").select("id, data, updated_at").eq("account_id",n),i=t.from("ft_sales").select("id, data, updated_at").eq("account_id",n);s&&(r=r.gt("updated_at",s),i=i.gt("updated_at",s));const[{data:o,error:a},{data:l,error:c}]=await Promise.all([r,i]);if(a||c)throw new Error((a||c).message);let d=null;try{let u=t.from("ft_expenses").select("id, data, updated_at").eq("account_id",n);s&&(u=u.gt("updated_at",s));const{data:p,error:f}=await u;f||(d=p)}catch{}if(s){if(o&&o.length)for(const u of o){if(!u.data)continue;const p=_.findIndex(f=>f.id===u.id);p!==-1?_[p]=u.data:_.push(u.data)}if(l&&l.length)for(const u of l){if(!u.data)continue;const p=C.findIndex(f=>f.id===u.id);p!==-1?C[p]=u.data:C.push(u.data)}if(d&&d.length)for(const u of d){if(!u.data)continue;const p=G.findIndex(f=>f.id===u.id);p!==-1?G[p]=u.data:G.push(u.data)}}else o&&(_.length=0,_.push(...o.map(u=>u.data).filter(Boolean))),l&&(C.length=0,C.push(...l.map(u=>u.data).filter(Boolean))),d&&(G.length=0,G.push(...d.map(u=>u.data).filter(Boolean)));return await Ye("lastSyncPull",new Date().toISOString()).catch(()=>{}),H(),!0}async function Ku(){const t=ct(),e=lt();if(!(!t||!e))try{const n=e.id,{data:s}=await t.from("ft_supplies").select("data").eq("account_id",n);s&&s.length&&(it.length=0,it.push(...s.map(r=>r.data).filter(Boolean))),op()}catch(n){console.warn("FlipTrack: supplies pull error:",n.message)}}async function Kr(){const t=ct(),e=lt();if(!(!t||!e)){await Zr(),ge("syncing");try{await ta(),await Gu(),ge("connected"),J()}catch(n){ge("error",n.message)}}}let yo=null;function gn(){const t=ct(),e=lt();!t||!e||navigator.onLine&&(clearTimeout(yo),yo=setTimeout(async()=>{await Zr(),ge("syncing");try{await Vu(),ge("connected")}catch(n){ge("error",n.message)}},2e3))}async function Ju(){const t=ct(),e=lt();if(!(!t||!e)){ge("syncing");try{await ta(),J(),ge("connected")}catch(n){ge("error",n.message)}}}function Yu(){Wu(()=>{const t=ct(),e=lt();return!t||!e?null:{sb:t,accountId:e.id}},t=>{t.ok>0&&(ge("connected"),E(`Synced ${t.ok} offline change${t.ok>1?"s":""} `)),t.failed>0&&ge("error",`${t.failed} sync retries pending`),t.dropped>0&&console.warn(`FlipTrack: ${t.dropped} queue item(s) permanently dropped after max retries`)})}let _=[],C=[],G=[],it=[],Jr=new Set,Yr=new Set,Qr=new Set,na=new Set,vt={ft_inventory:new Set,ft_sales:new Set,ft_expenses:new Set};function sa(){return{inv:[...Jr].map(e=>_.find(n=>n.id===e)).filter(Boolean),sales:[...Yr].map(e=>C.find(n=>n.id===e)).filter(Boolean),expenses:[...Qr].map(e=>G.find(n=>n.id===e)).filter(Boolean),deleted:{ft_inventory:[...vt.ft_inventory],ft_sales:[...vt.ft_sales],ft_expenses:[...vt.ft_expenses]}}}function ws(){Jr.clear(),Yr.clear(),Qr.clear(),na.clear(),vt.ft_inventory.clear(),vt.ft_sales.clear(),vt.ft_expenses.clear()}function ve(t,e){t==="inv"?Jr.add(e):t==="sales"?Yr.add(e):t==="expenses"?Qr.add(e):t==="supplies"&&na.add(e)}function Xr(t,e){vt[t]&&vt[t].add(e)}let ra={};function js(){ra=Object.fromEntries(_.map(t=>[t.id,t]))}function te(t){return ra[t]||null}let Qu=null,Ue=new Set,Ie=new Set,he=new Set,xs=[],Ut=!1;async function Xu(){try{await ic(),Ut=!0,await wt("migrated_from_ls")||(await Zu(),await Ye("migrated_from_ls",!0));const[e,n,s,r,i]=await Promise.all([wn("inventory"),wn("sales"),wn("expenses"),wn("supplies"),wn("trash")]);_.length=0,_.push(...e),C.length=0,C.push(...n),G.length=0,G.push(...s),it.length=0,it.push(...r),st.length=0,st.push(...i),console.log(`FlipTrack: Loaded from IndexedDB  ${_.length} items, ${C.length} sales`)}catch(t){console.warn("FlipTrack: IndexedDB unavailable, using localStorage fallback:",t.message),Ut=!1,ep()}js()}async function Zu(){const t=JSON.parse(localStorage.getItem("ft3_inv")||"[]"),e=JSON.parse(localStorage.getItem("ft3_sal")||"[]"),n=JSON.parse(localStorage.getItem("ft3_exp")||"[]"),s=JSON.parse(localStorage.getItem("ft_supplies")||"[]"),r=JSON.parse(localStorage.getItem("ft_trash")||"[]");(t.length||e.length||n.length||s.length)&&(await Promise.all([t.length?je("inventory",t):Promise.resolve(),e.length?je("sales",e):Promise.resolve(),n.length?je("expenses",n):Promise.resolve(),s.length?je("supplies",s):Promise.resolve(),r.length?je("trash",r):Promise.resolve()]),console.log(`FlipTrack: Migrated ${t.length} items from localStorage to IndexedDB`))}function ep(){_.length=0,_.push(...JSON.parse(localStorage.getItem("ft3_inv")||"[]")),C.length=0,C.push(...JSON.parse(localStorage.getItem("ft3_sal")||"[]")),G.length=0,G.push(...JSON.parse(localStorage.getItem("ft3_exp")||"[]")),it.length=0,it.push(...JSON.parse(localStorage.getItem("ft_supplies")||"[]")),st.length=0,st.push(...JSON.parse(localStorage.getItem("ft_trash")||"[]"))}let Pt=!0,bo=null,Rr=Promise.resolve();const H=()=>{js(),tp(),sp(),Pt&&gn()};function tp(){clearTimeout(bo),bo=setTimeout(()=>{Rr=Rr.then(()=>np()).catch(()=>{})},200)}async function np(){if(Ut)try{await Promise.all([je("inventory",_),je("sales",C),je("expenses",G),je("supplies",it)])}catch(t){console.warn("FlipTrack: IDB persist failed:",t.message)}}function Zr(){return Rr}function sp(){try{localStorage.setItem("ft3_inv",JSON.stringify(_)),localStorage.setItem("ft3_sal",JSON.stringify(C)),localStorage.setItem("ft3_exp",JSON.stringify(G)),Pt=!0}catch(t){if(t.name==="QuotaExceededError"||t.name==="NS_ERROR_DOM_QUOTA_REACHED"||t.code===22)try{const e=_.map(n=>{const s={...n};return delete s.image,delete s.images,s});localStorage.setItem("ft3_inv",JSON.stringify(e)),localStorage.setItem("ft3_sal",JSON.stringify(C)),localStorage.setItem("ft3_exp",JSON.stringify(G)),Pt=!0}catch(e){console.warn("FlipTrack: localStorage full:",e.message),Pt=!1,Ut&&(Pt=!0)}else console.warn("FlipTrack: save error:",t.message),Pt=!1,Ut&&(Pt=!0)}}function J(){js()}let st=[];function rp(){const t=Date.now()-6048e5;st=st.filter(e=>e.deletedAt>t).slice(-30),Ut&&je("trash",st).catch(()=>{});try{localStorage.setItem("ft_trash",JSON.stringify(st))}catch{}}function ia(t){const e=_.find(n=>n.id===t);e&&(zs("delete",{...e}),st.push({...JSON.parse(JSON.stringify(e)),deletedAt:Date.now()}),rp(),_.splice(_.indexOf(e),1),Xr("ft_inventory",t))}function zs(t,e){xs.push({action:t,data:e,ts:Date.now()}),xs.length>20&&xs.shift()}function ip(t){const e=document.getElementById("toast");if(!e)return;e.textContent="";const n=document.createElement("span");n.textContent=t+" ";const s=document.createElement("button");s.textContent="Undo",s.style.cssText="background:rgba(0,0,0,0.3);border:1px solid rgba(0,0,0,0.4);color:#fff;padding:3px 10px;margin-left:8px;cursor:pointer;font-family:Syne,sans-serif;font-weight:700;font-size:11px",s.onclick=()=>{oa(),e.classList.remove("on")},e.appendChild(n),e.appendChild(s),e.classList.remove("err"),e.classList.add("on"),setTimeout(()=>e.classList.remove("on"),8e3)}function oa(){const t=xs.pop();if(t){if(t.action==="delete")_.push(t.data),ve("inv",t.data.id),H(),J();else if(t.action==="sold"){const e=_.find(s=>s.id===t.data.itemId);e&&(e.qty=(e.qty||0)+(t.data.qty||1),ve("inv",e.id));const n=C.findIndex(s=>s.id===t.data.saleId);n!==-1&&(Xr("ft_sales",t.data.saleId),C.splice(n,1)),H(),J()}}}function op(){Ut&&je("supplies",it).catch(()=>{}),localStorage.setItem("ft_supplies",JSON.stringify(it))}function qt(t){const e=t.cost||0,n=t.price||0,s=t.fees||0,r=t.ship||0,i=n-e-s-r,o=n?i/n:0,a=e?i/e:0;return{cost:e,price:n,fees:s,ship:r,pu:i,m:o,roi:a}}function aa(t,e,n){return n?t===0?"low":t<=(e||2)?"warn":"ok":t===0?"low":"ok"}function Lt(t){return t>=.35?"mb-high":t>=.15?"mb-mid":"mb-low"}function ap(t){const e=qt(t).m;return Lt(e)}let lp=()=>{};function X(t){return Array.isArray(t.platforms)&&t.platforms.length?t.platforms:t.platform?[t.platform]:[]}function wo(t,e=[]){const n=document.getElementById(t);if(!n)return;const s=new Set(Array.isArray(e)?e:[e].filter(Boolean));let r="";PLATFORM_GROUPS.forEach(i=>{r+=`<div class="plat-picker-group-label">${i.label}</div>
    <div class="plat-picker-chips">`,i.items.forEach(o=>{const a=s.has(o)?"active":"";r+=`<span class="plat-pick-chip ${a}" data-plat="${o}" onclick="togglePlatChip(this,'${t}')">${o}</span>`}),r+="</div>"}),n.innerHTML=r}function la(){wo("d_plat_picker",[]),wo("f_plat_picker",[])}la();function ei(t){const e=X(t);if(!e.length)return'<span class="platform-tag plt-other"></span>';const n=t.platformStatus||{},s=e.slice(0,2),r=e.length-s.length;let i=s.map(o=>{const a=n[o]||"active",l=a==="sold"?'<span style="color:var(--good);font-size:8px;margin-left:2px" title="Sold"></span>':a==="delisted"?'<span style="color:var(--muted);font-size:8px;margin-left:2px;text-decoration:line-through" title="Delisted"></span>':"";return`<span class="platform-tag ${platCls(o)}">${escHtml(o)}${l}</span>`}).join(" ");return r>0&&(i+=` <span class="cross-listed-badge" title="${escHtml(e.slice(2).join(", "))}">+${r}</span>`),i}function oe(t,e={}){const{min:n=0,max:s=1/0,allowZero:r=!0,integer:i=!1}=e;if(t===""||t===null||t===void 0)return NaN;const o=i?parseInt(t,10):parseFloat(t);return isNaN(o)?NaN:!r&&o===0?NaN:o<n||o>s?NaN:Math.round(o*100)/100}function Te(t,e={}){const n=oe(t.value,e);if(isNaN(n)){t.classList.add("input-error"),t.setAttribute("aria-invalid","true");let r=t.parentElement.querySelector(".validation-hint");r||(r=document.createElement("span"),r.className="validation-hint",r.setAttribute("role","alert"),t.parentElement.appendChild(r));const i=e.fieldName||"Value";return t.value.trim()===""?r.textContent=`${i} is required`:e.integer?r.textContent=`${i} must be a whole number`:r.textContent=`${i} must be a valid number`,null}t.classList.remove("input-error"),t.removeAttribute("aria-invalid");const s=t.parentElement.querySelector(".validation-hint");return s&&s.remove(),n}const cp=["Like New","Very Good","Good","Acceptable","Poor"],dp=["NWT","NWOT","EUC","GUC","Fair","Poor","New/Sealed","Refurbished"];function Yn(t){if(!t)return!1;const e=t.toLowerCase().trim();return e==="books"||e==="book"||e==="textbooks"||e==="textbook"||e.startsWith("book")||e.endsWith("books")}function Qn(t){const e=document.getElementById(t==="f"?"f_cat":"d_cat"),n=e?e.value.trim():"",s=Yn(n),r=document.getElementById(t+"_book_fields");r&&r.classList.toggle("on",s),ca(t,s)}function ca(t,e){var i;const n=document.getElementById(t+"_cond_picker");if(!n)return;const s=((i=document.getElementById(t+"_condition"))==null?void 0:i.value)||"",r=e?cp:dp;n.innerHTML=r.map(o=>`<button type="button" class="cond-tag" onclick="setCondTag('${t}','${o}',this)">${o}</button>`).join(""),s&&vp(t,s)}function da(t){var i;const e=document.getElementById(t+"_rank_display"),n=parseInt((i=document.getElementById(t+"_sales_rank"))==null?void 0:i.value)||0;if(!e)return;if(!n){e.innerHTML="";return}let s,r;n<1e5?(s="var(--good)",r="Fast seller  high demand"):n<5e5?(s="var(--accent)",r="Moderate  sells within weeks"):n<1e6?(s="var(--warn)",r="Slow  may take months"):(s="var(--danger)",r="Very slow  consider skipping"),e.innerHTML=`<span class="rank-dot" style="background:${s}"></span><span class="rank-label">#${n.toLocaleString()}  ${r}</span>`}async function up(t){var s,r,i,o;const e=((s=document.getElementById(t+"_isbn"))==null?void 0:s.value.replace(/[-\s]/g,""))||"";if(!e||e.length!==10&&e.length!==13){toast("Enter a valid ISBN-10 or ISBN-13",!0);return}const n=document.getElementById(t+"_isbn_btn");n&&(n.disabled=!0,n.textContent=" Looking up");try{const l=await(await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${e}&format=json&jscmd=data`)).json(),c=`ISBN:${e}`;if(!l[c]){toast("ISBN not found  try entering details manually",!0);return}const d=l[c],u=document.getElementById(t==="f"?"f_name":"d_name");u&&d.title&&!u.value&&(u.value=d.title);const p=document.getElementById(t+"_author");p&&((r=d.authors)!=null&&r.length)&&(p.value=d.authors.map(g=>g.name).join(", "));const f=document.getElementById(t+"_publisher");f&&((i=d.publishers)!=null&&i.length)&&(f.value=d.publishers[0].name);const m=document.getElementById(t+"_pub_year");if(m&&d.publish_date){const g=d.publish_date.match(/\d{4}/);g&&(m.value=g[0])}const v=document.getElementById(t==="f"?"f_cat":"d_cat");if(v&&!Yn(v.value)&&(v.value="Books",t==="f"?gp():mp()),(o=d.subjects)!=null&&o.length){const g=document.getElementById(t+"_subcat_txt");g&&!g.value&&(g.value=d.subjects[0].name)}toast("ISBN found: "+(d.title||e)+" ")}catch(a){toast("ISBN lookup failed: "+a.message,!0)}finally{n&&(n.disabled=!1,n.textContent=" Lookup")}}function pp(t){var b,S,k;const e=parseFloat((b=document.getElementById(t==="f"?"f_price":"d_price"))==null?void 0:b.value)||0,n=parseFloat((S=document.getElementById(t==="f"?"f_cost":"d_cost"))==null?void 0:S.value)||0,s=parseFloat((k=document.getElementById(t==="f"?"f_ship":"d_ship"))==null?void 0:k.value)||4.5,r=document.getElementById(t+"_fba_panel");if(!r)return;if(!e){toast("Set a list price first",!0);return}const i=e*.15,o=1.8,a=3.07,l=.1,c=i+o+a+l,d=e-n-c,u=e>=10?3.99:3.49,p=i+o,f=s,m=e-n-p-f+u,v=d>m,g=P=>`<span style="color:${P>=0?"var(--good)":"var(--danger)"}">${fmt(P)}</span>`;r.classList.add("on"),r.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">
      <div>
        <div style="font-size:10px;font-weight:700;color:var(--accent3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center">FBA</div>
        <div class="fba-row"><span class="fba-lbl">Referral (15%)</span><span class="fba-val">${fmt(i)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Closing Fee</span><span class="fba-val">${fmt(o)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Fulfillment</span><span class="fba-val">${fmt(a)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Storage/mo</span><span class="fba-val">${fmt(l)}</span></div>
        <div class="fba-row fba-total"><span class="fba-lbl">Profit</span><span class="fba-val">${g(d)}</span></div>
      </div>
      <div>
        <div style="font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center">Self-Ship</div>
        <div class="fba-row"><span class="fba-lbl">Referral (15%)</span><span class="fba-val">${fmt(i)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Closing Fee</span><span class="fba-val">${fmt(o)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Shipping</span><span class="fba-val">${fmt(f)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Ship Credit</span><span class="fba-val" style="color:var(--good)">+${fmt(u)}</span></div>
        <div class="fba-row fba-total"><span class="fba-lbl">Profit</span><span class="fba-val">${g(m)}</span></div>
      </div>
    </div>
    <div class="fba-winner" style="background:${v?"rgba(123,97,255,0.1);color:var(--accent3)":"rgba(87,200,255,0.1);color:var(--accent)"}">
      ${v?" FBA wins":" Self-Ship wins"} by ${fmt(Math.abs(d-m))} per unit
    </div>
    <div style="margin-top:10px;padding:8px 10px;background:rgba(255,184,0,0.06);border:1px solid rgba(255,184,0,0.15);font-size:10px;color:var(--warn);font-family:'DM Mono',monospace"> Fee estimates shown are for Books/Media category. Other categories (electronics, apparel, etc.) have different fee structures.</div>`}function ua(t){var e,n,s,r,i,o,a,l;return{isbn:((e=document.getElementById(t+"_isbn"))==null?void 0:e.value.trim())||"",author:((n=document.getElementById(t+"_author"))==null?void 0:n.value.trim())||"",publisher:((s=document.getElementById(t+"_publisher"))==null?void 0:s.value.trim())||"",edition:((r=document.getElementById(t+"_edition"))==null?void 0:r.value.trim())||"",printing:((i=document.getElementById(t+"_printing"))==null?void 0:i.value.trim())||"",pubYear:parseInt((o=document.getElementById(t+"_pub_year"))==null?void 0:o.value)||null,signed:((a=document.getElementById(t+"_signed"))==null?void 0:a.checked)||!1,salesRank:parseInt((l=document.getElementById(t+"_sales_rank"))==null?void 0:l.value)||null}}function hp(t,e){document.getElementById(t+"_isbn").value=e.isbn||"",document.getElementById(t+"_author").value=e.author||"",document.getElementById(t+"_publisher").value=e.publisher||"",document.getElementById(t+"_edition").value=e.edition||"",document.getElementById(t+"_printing").value=e.printing||"",document.getElementById(t+"_pub_year").value=e.pubYear||"",document.getElementById(t+"_signed").checked=!!e.signed,document.getElementById(t+"_sales_rank").value=e.salesRank||"",da(t);const n=document.getElementById(t+"_fba_panel");n&&(n.classList.remove("on"),n.innerHTML="")}function fp(t){["isbn","author","publisher","edition","printing","pub_year","sales_rank"].forEach(i=>{const o=document.getElementById(t+"_"+i);o&&(o.value="")});const e=document.getElementById(t+"_signed");e&&(e.checked=!1);const n=document.getElementById(t+"_rank_display");n&&(n.innerHTML="");const s=document.getElementById(t+"_fba_panel");s&&(s.classList.remove("on"),s.innerHTML="");const r=document.getElementById(t+"_book_fields");r&&r.classList.remove("on")}function gp(){const t=document.getElementById("f_cat").value.trim(),e=SUBCATS[t]||[],n=document.getElementById("f_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join(""))}function mp(){const t=document.getElementById("d_cat").value.trim(),e=SUBCATS[t]||[],n=document.getElementById("d_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join(""))}function vp(t,e){const n=document.getElementById(t+"_condition"),s=document.getElementById(t+"_cond_picker");!n||!s||(n.value=e||"",s.querySelectorAll(".cond-tag").forEach(r=>{r.classList.toggle("active",r.textContent.trim()===e)}))}const yp={eBay:{days:30,label:"30-day or GTC",renewable:!0},Amazon:{days:0,label:"Until sold/removed",renewable:!1},Etsy:{days:120,label:"4-month listing",renewable:!0},"Facebook Marketplace":{days:7,label:"7-day listing",renewable:!0},Depop:{days:0,label:"Until sold/removed",renewable:!1},Poshmark:{days:0,label:"Active until sold (share to refresh)",renewable:!1},Mercari:{days:0,label:"Until sold/removed",renewable:!1},Grailed:{days:0,label:"Until sold/removed",renewable:!1},StockX:{days:30,label:"30-day ask",renewable:!0},GOAT:{days:30,label:"30-day listing",renewable:!0},Vinted:{days:0,label:"Until sold/removed",renewable:!1},Tradesy:{days:0,label:"Until sold/removed",renewable:!1},"The RealReal":{days:0,label:"Consignment period",renewable:!1},"Vestiaire Collective":{days:0,label:"Until sold/removed",renewable:!1},Reverb:{days:0,label:"Until sold/removed",renewable:!1},Discogs:{days:0,label:"Until sold/removed",renewable:!1},Craigslist:{days:45,label:"45-day listing",renewable:!0},OfferUp:{days:0,label:"Until sold/removed",renewable:!1},Nextdoor:{days:30,label:"30-day listing",renewable:!0},Whatnot:{days:0,label:"Live auction",renewable:!1},"TikTok Shop":{days:0,label:"Until sold/removed",renewable:!1},Instagram:{days:0,label:"Until sold/removed",renewable:!1},Shopify:{days:0,label:"Until sold/removed",renewable:!1},"Walmart Marketplace":{days:0,label:"Until sold/removed",renewable:!1},Newegg:{days:0,label:"Until sold/removed",renewable:!1},Bonanza:{days:0,label:"Until sold/removed",renewable:!1},"Ruby Lane":{days:0,label:"Until sold/removed",renewable:!1},Chairish:{days:0,label:"Until sold/removed",renewable:!1},"1stDibs":{days:0,label:"Until sold/removed",renewable:!1},Swappa:{days:30,label:"30-day listing",renewable:!0},Decluttr:{days:0,label:"Until sold/removed",renewable:!1}},bp=["active","sold","sold-elsewhere","delisted","expired","draft"],Br={active:"Active",sold:"Sold","sold-elsewhere":"Sold Elsewhere",delisted:"Delisted",expired:"Expired",draft:"Draft"},pa={active:"var(--good)",sold:"var(--accent)","sold-elsewhere":"var(--accent2)",delisted:"var(--muted)",expired:"var(--danger)",draft:"var(--warn)"};function ti(t,e){const n=yp[t];if(!n||n.days===0)return null;const s=new Date(e);return isNaN(s.getTime())?null:(s.setDate(s.getDate()+n.days),s.toISOString().split("T")[0])}function ha(t,e){const n=ti(t,e);if(!n)return null;const s=new Date;s.setHours(0,0,0,0);const r=new Date(n);return r.setHours(0,0,0,0),Math.ceil((r-s)/864e5)}function Ns(t,e,n){const s=_.find(r=>r.id===t);return s?(s.platformStatus||(s.platformStatus={}),s.platformStatus[e]=n,ve("inv",t),!0):!1}function fa(t,e,n){const s=_.find(i=>i.id===t);if(!s)return;s.platformListingDates||(s.platformListingDates={}),s.platformListingExpiry||(s.platformListingExpiry={}),s.platformListingDates[e]=n||new Date().toISOString().split("T")[0];const r=ti(e,s.platformListingDates[e]);r?s.platformListingExpiry[e]=r:delete s.platformListingExpiry[e],ve("inv",t)}function Us(t,e){const n=_.find(r=>r.id===t);if(!n)return;const s=new Date().toISOString().split("T")[0];n.lastRelisted||(n.lastRelisted={}),n.lastRelisted[e]=s,fa(t,e,s),Ns(t,e,"active")}function wp(t,e){const n=_.find(i=>i.id===t);if(!n)return[];const s=X(n);n.platformStatus||(n.platformStatus={}),n.platformStatus[e]="sold";const r=[];if((n.qty||0)<=0)for(const i of s){if(i===e)continue;const o=n.platformStatus[i];(o==="active"||!o)&&(n.platformStatus[i]="sold-elsewhere",r.push(i))}return ve("inv",t),r}function ni(t){const e=new Date;e.setHours(0,0,0,0);const n=[];for(const s of t){const r=X(s),i=s.platformStatus||{},o=s.platformListingDates||{},a=s.platformListingExpiry||{};for(const l of r){if(i[l]&&i[l]!=="active")continue;const c=a[l];c&&new Date(c)<e&&n.push({item:s,platform:l,expiryDate:c,listedDate:o[l]||null})}}return n}function ga(t,e=7){const n=new Date;n.setHours(0,0,0,0);const s=new Date(n);s.setDate(s.getDate()+e);const r=[];for(const i of t){const o=X(i),a=i.platformStatus||{},l=i.platformListingDates||{},c=i.platformListingExpiry||{};for(const d of o){if(a[d]&&a[d]!=="active")continue;const u=c[d];if(u){const p=new Date(u);if(p>=n&&p<=s){const f=Math.ceil((p-n)/864e5);r.push({item:i,platform:d,expiryDate:u,daysLeft:f,listedDate:l[d]||null})}}}}return r.sort((i,o)=>i.daysLeft-o.daysLeft)}function ma(){const t=ni(_);let e=0;for(const{item:n,platform:s}of t)n.platformStatus||(n.platformStatus={}),n.platformStatus[s]!=="expired"&&(n.platformStatus[s]="expired",ve("inv",n.id),e++);return e>0&&(H(),E(`${e} listing${e>1?"s":""} expired  relist from Crosslist tab`)),e}function va(t){const e=X(t),n=t.platformStatus||{};let s=0,r=0,i=0,o=0,a=0,l=0;for(const c of e){const d=n[c]||"active";d==="active"?s++:d==="sold"?r++:d==="sold-elsewhere"?i++:d==="expired"?o++:d==="delisted"?a++:d==="draft"&&l++}return{totalPlatforms:e.length,active:s,sold:r,soldElsewhere:i,expired:o,delisted:a,draft:l}}function xp(t){let e=0,n=0,s=0,r=0,i=0,o=0;s=ga(t,7).length;for(const l of t){if((l.qty||0)<=0)continue;const c=va(l);e+=c.active,n+=c.expired,r+=c.soldElsewhere,c.totalPlatforms===0?i++:c.totalPlatforms===1&&o++}return{totalActive:e,totalExpired:n,totalExpiringSoon:s,totalSoldElsewhere:r,itemsNotListed:i,itemsSinglePlatform:o}}function _p(){let t=0;for(const e of _){const n=X(e);if(n.length){e.platformListingDates||(e.platformListingDates={}),e.platformListingExpiry||(e.platformListingExpiry={}),e.platformStatus||(e.platformStatus={});for(const s of n){if(!e.platformListingDates[s]){const r=e.added?new Date(e.added).toISOString().split("T")[0]:new Date().toISOString().split("T")[0];e.platformListingDates[s]=r;const i=ti(s,r);i&&(e.platformListingExpiry[s]=i),t++}e.platformStatus[s]||(e.platformStatus[s]="active")}t>0&&ve("inv",e.id)}}t>0&&H()}const ya=encodeURIComponent,Sp={eBay:t=>`https://www.ebay.com/sell/create?item_title=${ya((t.name||"").slice(0,80))}`,Poshmark:()=>"https://poshmark.com/create-listing",Mercari:()=>"https://www.mercari.com/sell/",Depop:()=>"https://www.depop.com/products/create/",Etsy:()=>"https://www.etsy.com/your/shops/me/tools/listings/create","Facebook Marketplace":()=>"https://www.facebook.com/marketplace/create/item/",Amazon:()=>"https://sellercentral.amazon.com/product-search/search",Grailed:()=>"https://www.grailed.com/sell",StockX:()=>"https://stockx.com/sell",GOAT:()=>"https://www.goat.com/sell",Vinted:()=>"https://www.vinted.com/items/new","The RealReal":()=>"https://www.therealreal.com/consign","Vestiaire Collective":()=>"https://www.vestiairecollective.com/sell/",Reverb:()=>"https://reverb.com/sell",Discogs:()=>"https://www.discogs.com/sell/list",Craigslist:()=>"https://post.craigslist.org/",OfferUp:()=>"https://offerup.com/post",Nextdoor:()=>"https://nextdoor.com/for_sale_and_free/",Whatnot:()=>"https://www.whatnot.com/sell","TikTok Shop":()=>"https://seller-us.tiktok.com/",Instagram:()=>"https://www.instagram.com/",Shopify:()=>"https://admin.shopify.com/","Walmart Marketplace":()=>"https://seller.walmart.com/",Newegg:()=>"https://seller.newegg.com/",Bonanza:()=>"https://www.bonanza.com/booths/items/new","Ruby Lane":()=>"https://www.rubylane.com/",Chairish:()=>"https://www.chairish.com/consign","1stDibs":()=>"https://www.1stdibs.com/dealers/",Swappa:()=>"https://swappa.com/sell",Decluttr:()=>"https://www.decluttr.com/sell-my-stuff"};function kp(t,e){if(e.url&&X(e).length===1)return e.url;const n=Sp[t];return n?n(e):`https://www.google.com/search?q=${ya(t+" sell "+(e.name||""))}`}function $p(t,e){const n={"{name}":t.name||"","{condition}":t.condition||"Good","{category}":t.category||"","{subcategory}":t.subcategory||"","{subtype}":t.subtype||"","{sku}":t.sku||"","{upc}":t.upc||"","{price}":t.price?`$${t.price.toFixed(2)}`:"","{source}":t.source||"","{notes}":t.notes||"","{dimensions}":t.dimL&&t.dimW&&t.dimH?`${t.dimL}  ${t.dimW}  ${t.dimH} ${t.dimUnit||"in"}`:"","{weight}":t.weight?`${t.weight} ${t.dimUnit==="cm"?"kg":"lb"}`:"","{author}":t.author||"","{isbn}":t.isbn||""},s=o=>{let a=o;for(const[l,c]of Object.entries(n))a=a.replaceAll(l,c);return a.replace(/\s{2,}/g," ").trim()};if(e)return{title:s(e.titleFormula||"{name}"),description:s(e.descriptionTemplate||"")};const r=t.name||"Item",i=[];return t.condition&&i.push(`Condition: ${t.condition}`),t.category&&i.push(`Category: ${t.category}`),t.subcategory&&i.push(`Subcategory: ${t.subcategory}`),t.upc&&i.push(`UPC: ${t.upc}`),t.notes&&i.push(`
${t.notes}`),i.push(`
Ships fast! Check my other listings for bundle deals.`),{title:r,description:i.join(`
`)}}async function ba(t,e){const{title:n,description:s}=$p(t,e),r=`${n}

${s}`;try{return await navigator.clipboard.writeText(r),E("Listing text copied to clipboard "),!0}catch{const o=document.createElement("textarea");o.value=r,o.style.position="fixed",o.style.opacity="0",document.body.appendChild(o),o.select();try{document.execCommand("copy"),E("Listing text copied ")}catch{E("Copy failed  select text manually",!0)}return document.body.removeChild(o),!1}}function si(t,e,n){const s=Vn[e]||[],r=document.getElementById(t);if(!r)return;const i=t==="d_subcat"?"d_subcat_grp":"f_subcat_grp",o=document.getElementById(i);s.length?(r.innerHTML='<option value=""> None </option>'+s.map(a=>`<option value="${a}" ${a===n?"selected":""}>${a}</option>`).join(""),o&&(o.style.display="")):(r.innerHTML='<option value=""> None </option>',o&&(o.style.display="none"))}function Xn(t,e,n){const s=Ro[e]||[],r=document.getElementById(t);if(!r)return;const i=t==="d_subtype"?"d_subtype_grp":"f_subtype_grp",o=t==="d_subtype"?"d_subtype_lbl":"f_subtype_lbl",a=["Men","Women","Children"].includes(e)?"Clothing Type":"Type",l=document.getElementById(o);l&&(l.textContent=a);const c=document.getElementById(i);s.length?(r.innerHTML='<option value=""> None </option>'+s.map(d=>`<option value="${d}" ${d===n?"selected":""}>${d}</option>`).join(""),c&&(c.style.display="")):(r.innerHTML='<option value=""> None </option>',c&&(c.style.display="none"))}function Ep(){const t=document.getElementById("d_cat").value.trim(),e=Vn[t]||[],n=document.getElementById("d_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join("")),si("d_subcat",t,document.getElementById("d_subcat_txt").value),Xn("d_subtype",document.getElementById("d_subcat").value,""),Qn("d")}function Ip(){Xn("d_subtype",document.getElementById("d_subcat").value,"")}function Tp(){const t=document.getElementById("f_cat").value.trim(),e=Vn[t]||[],n=document.getElementById("f_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join("")),si("f_subcat",t,document.getElementById("f_subcat_txt").value),Xn("f_subtype",document.getElementById("f_subcat").value,""),Qn("f")}function Cp(){Xn("f_subtype",document.getElementById("f_subcat").value,"")}function Pp(t){activeDrawId=t;const e=inv.find(g=>g.id===t);if(!e)return;document.getElementById("dName").textContent=e.name,document.getElementById("dSku").textContent=e.sku?`SKU: ${e.sku}`:"No SKU";const{pu:n,m:s,roi:r}=calc(e),i=sales.filter(g=>g.itemId===t),o=i.reduce((g,b)=>g+(b.qty||0),0),a=i.reduce((g,b)=>g+(b.price||0)*(b.qty||0),0),l=sc(e.qty,e.lowAlert,e.bulk);document.getElementById("dMets").innerHTML=`
    <div class="d-met"><div class="dm-lbl">In Stock</div><div class="dm-val" style="color:${mkc(l)}">${e.qty||0}</div></div>
    <div class="d-met"><div class="dm-lbl">Profit/Unit</div><div class="dm-val" style="color:var(--good)">${fmt(n)}</div></div>
    <div class="d-met"><div class="dm-lbl">Margin</div><div class="dm-val" style="color:var(--accent)">${pct(s)}</div></div>
    <div class="d-met"><div class="dm-lbl">ROI</div><div class="dm-val" style="color:var(--accent3)">${pct(r)}</div></div>
    <div class="d-met"><div class="dm-lbl">Units Sold</div><div class="dm-val">${o}</div></div>
    <div class="d-met"><div class="dm-lbl">Total Revenue</div><div class="dm-val">${fmt(a)}</div></div>`;const c={d_name:"name",d_sku:"sku",d_upc:"upc",d_cat:"category",d_cost:"cost",d_price:"price",d_fees:"fees",d_ship:"ship",d_notes:"notes",d_url:"url",d_alert:"lowAlert",d_source:"source"};for(const[g,b]of Object.entries(c)){const S=document.getElementById(g);S&&(S.value=e[b]||"")}const d=document.getElementById("d_subcat_txt");d&&(d.value=e.subcategory||"");const u=Vn[e.category||""]||[],p=document.getElementById("d_subcat_dl");p&&(p.innerHTML=u.map(g=>`<option value="${g}">`).join(""));const f=document.getElementById("d_bulk");f&&(f.checked=!!e.bulk,toggleBulkFields("d")),buildPlatPicker("d_plat_picker",getPlatforms(e)),wa(e),xa("d",e.condition||""),si("d_subcat",e.category||"",e.subcategory||""),Xn("d_subtype",e.subcategory||"",e.subtype||""),Qn("d"),Yn(e.category)&&hp("d",e),renderDrawerImg(e.id),renderDrawerBarcode(e),loadDimsToForm("d",e),suggestPackaging("d");const m=document.getElementById("d_ship_summary");if(m){const g=[];e.weight&&g.push(`${e.weight} ${e.dimUnit==="cm"?"kg":"lb"}`),e.dimL&&e.dimW&&e.dimH&&g.push(`${e.dimL}${e.dimW}${e.dimH} ${e.dimUnit||"in"}`),m.textContent=g.length?`Package: ${g.join("  ")}`:"Add dimensions above to see package info"}const v=document.getElementById("dHistory");i.length?v.innerHTML=[...i].reverse().map(g=>{const b=(g.price||0)*(g.qty||0)-(e.cost||0)*(g.qty||0)-(g.fees||0)-(g.ship||0);return`<div class="shi"><div><div style="font-size:12px">${fmt(g.price)}  ${g.qty}</div><div class="shi-d">${ds(g.date)}</div></div><div class="shi-p ${b>=0?"pos":"neg"}">${fmt(b)}</div></div>`}).join(""):v.innerHTML='<div style="font-size:12px;color:var(--muted);padding:8px 0">No sales for this item yet.</div>',document.getElementById("drawerOv").classList.add("on"),document.getElementById("drawer").classList.add("on"),setTimeout(()=>trapFocus("#drawer"),100)}function Ap(t,e){document.querySelectorAll(".drawer-tab-panel").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".drawer-tab").forEach(n=>n.classList.remove("active")),document.getElementById("dtab-"+t).classList.add("active"),e.classList.add("active")}function qs(){releaseFocus(),document.getElementById("drawerOv").classList.remove("on"),document.getElementById("drawer").classList.remove("on"),document.querySelectorAll(".drawer-tab-panel").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".drawer-tab").forEach(n=>n.classList.remove("active"));const t=document.getElementById("dtab-details");t&&t.classList.add("active");const e=document.querySelector(".drawer-tab");e&&e.classList.add("active"),activeDrawId=null}function wa(t){const e=document.getElementById("d_listing_status_wrap"),n=document.getElementById("d_listing_status"),s=getPlatforms(t);if(!s.length||s.length<1){e.style.display="none";return}e.style.display="";const r=t.platformStatus||{},i=t.platformListingDates||{};n.innerHTML=s.map(o=>{const a=r[o]||"active",l=Br[a]||a,c=pa[a]||"var(--muted)",d=i[o],u=ha(o,d);let p="";u!==null&&(u<0?p=`<span class="ls-expiry ls-expired">Expired ${Math.abs(u)}d ago</span>`:u<=3?p=`<span class="ls-expiry ls-urgent">${u}d left</span>`:u<=7?p=`<span class="ls-expiry ls-warning">${u}d left</span>`:p=`<span class="ls-expiry">${u}d left</span>`);const f=d?`<span class="ls-date">Listed ${d}</span>`:"",m=a==="expired"||a==="delisted"||a==="sold-elsewhere";return`<div class="ls-badge-enhanced" data-status="${a}" data-plat="${escHtml(o)}">
      <div class="ls-badge-top">
        <span class="ls-dot" style="background:${c}"></span>
        <span class="ls-plat-name">${escHtml(o)}</span>
        <span class="ls-label" style="color:${c}" onclick="toggleListingStatus(this.closest('.ls-badge-enhanced'))">${l}</span>
        ${p}
      </div>
      <div class="ls-badge-bottom">
        ${f}
        <div class="ls-badge-actions">
          ${m?`<button class="btn-xs btn-accent" onclick="clRelistFromDrawer('${t.id}','${escHtml(o)}')">Relist</button>`:""}
          <button class="btn-xs" onclick="clOpenLink('${escHtml(o)}','${t.id}')" title="Open on ${escHtml(o)}"></button>
          <button class="btn-xs" onclick="clCopyListing('${t.id}')" title="Copy listing text"></button>
        </div>
      </div>
    </div>`}).join("")}function Op(){const t=document.querySelectorAll("#d_listing_status .ls-badge"),e={};return t.forEach(n=>{e[n.getAttribute("data-plat")]=n.getAttribute("data-status")}),e}function Dp(){var p;const t=inv.find(f=>f.id===activeDrawId);if(!t)return;const e=document.getElementById("d_cost"),n=oe(e.value,{});if(isNaN(n)&&e.value.trim()!==""){Te(e,{fieldName:"Cost"});return}const s=document.getElementById("d_price"),r=oe(s.value,{});if(isNaN(r)&&s.value.trim()!==""){Te(s,{fieldName:"Price"});return}const i=document.getElementById("d_fees"),o=oe(i.value,{allowZero:!0});if(isNaN(o)&&i.value.trim()!==""){Te(i,{fieldName:"Fees"});return}const a=document.getElementById("d_ship"),l=oe(a.value,{allowZero:!0});if(isNaN(l)&&a.value.trim()!==""){Te(a,{fieldName:"Shipping"});return}const c=document.getElementById("d_alert"),d=oe(c.value,{integer:!0,min:1});t.name=document.getElementById("d_name").value.trim()||t.name,t.sku=document.getElementById("d_sku").value.trim(),t.upc=document.getElementById("d_upc").value.trim(),t.category=normCat(document.getElementById("d_cat").value.trim()),t.subcategory=(document.getElementById("d_subcat_txt").value||"").trim();const u=document.getElementById("d_subtype");t.subtype=u?u.value||"":t.subtype||"",t.platforms=getSelectedPlats("d_plat_picker"),t.platform=t.platforms[0]||"Other",t.platformStatus=Op(),t.cost=isNaN(n)?0:n,t.price=isNaN(r)?0:r,t.fees=isNaN(o)?0:o,t.ship=isNaN(l)?0:l,t.lowAlert=isNaN(d)?2:d,t.bulk=((p=document.getElementById("d_bulk"))==null?void 0:p.checked)||!1,t.url=document.getElementById("d_url").value.trim(),t.source=document.getElementById("d_source").value.trim(),t.condition=document.getElementById("d_condition").value.trim(),t.notes=document.getElementById("d_notes").value.trim(),Object.assign(t,getDimsFromForm("d")),Yn(t.category)&&Object.assign(t,ua("d")),save(),qs(),refresh(),_sfx.edit(),toast("Changes saved ")}async function Rp(){const t=inv.find(n=>n.id===activeDrawId);if(!confirm(`Delete "${t==null?void 0:t.name}"?`))return;const e=activeDrawId;ia(e),save(),qs(),refresh(),toast("Item deleted  tap Undo to restore",!1,4e3),await Jn("ft_inventory",[e]),autoSync()}function Bp(t,e,n){const s=document.getElementById(t+"_condition"),r=document.getElementById(t+"_cond_picker");s.value===e?(s.value="",n.classList.remove("active")):(s.value=e,r.querySelectorAll(".cond-tag").forEach(i=>i.classList.remove("active")),n.classList.add("active"))}function xa(t,e){const n=document.getElementById(t+"_condition"),s=document.getElementById(t+"_cond_picker");!n||!s||(n.value=e||"",s.querySelectorAll(".cond-tag").forEach(r=>{r.classList.toggle("active",r.textContent.trim()===e)}))}function Lp(){const t=document.getElementById("deathPileSection");if(!t)return;const e=new Date,n=864e5,s=_.filter(l=>{if((l.qty||0)<=0)return!1;const c=X(l);return!c.length||c.length===1&&(c[0]==="Unlisted"||c[0]==="Other")}).map(l=>{const c=new Date(l.added||e),d=Math.floor((e-c)/n),u=(l.cost||0)*(l.qty||1);return{item:l,days:d,costBasis:u}}).sort((l,c)=>c.days-l.days);if(!s.length){t.style.display="none";return}const r=s.slice(0,6),i=s.length-r.length,o=s.reduce((l,c)=>l+c.costBasis,0),a=l=>l>=30?"var(--danger)":l>=14?"var(--warn)":"var(--muted)";t.style.display="",t.innerHTML=`<div class="death-pile-wrap">
    <div class="death-pile-hdr">
      <div class="death-pile-title"> Death Pile <span style="font-family:'DM Mono',monospace;font-weight:400;font-size:10px;opacity:0.7">${s.length} unlisted item${s.length>1?"s":""}  ${w(o)} tied up</span></div>
      <button style="background:none;border:1px solid rgba(123,97,255,0.3);color:var(--accent3);font-size:10px;padding:3px 10px;cursor:pointer;font-family:'DM Mono',monospace" onclick="document.getElementById('deathPileSection').style.display='none'">Dismiss</button>
    </div>
    ${r.map(l=>`<div class="death-pile-item">
      <div class="dp-info">
        <div class="dp-name" onclick="openDrawer('${l.item.id}')">${x(l.item.name)}</div>
        <div class="dp-meta">${l.item.category||"No category"}  ${w(l.item.cost)} cost  qty ${l.item.qty}${l.item.source?"  "+x(l.item.source):""}</div>
      </div>
      <div class="dp-age" style="color:${a(l.days)}">${l.days}d</div>
      <button class="dp-list-btn" onclick="openDrawer('${l.item.id}')">List It </button>
    </div>`).join("")}
    ${i>0?`<div style="font-size:10px;color:var(--muted);margin-top:6px;font-family:'DM Mono',monospace">+ ${i} more unlisted items</div>`:""}
    <div style="margin-top:8px;font-size:10px;color:var(--muted);font-family:'DM Mono',monospace"> Assign platforms to move items out of the death pile</div>
  </div>`}function Mp(){const t=document.getElementById("priceAlerts");if(!t)return;const e=new Date,n=864e5,s=_.filter(a=>{if((a.qty||0)<=0||C.some(u=>u.itemId===a.id))return!1;const c=new Date(a.added||e);return Math.floor((e-c)/n)>=14}).map(a=>{const l=new Date(a.added||e),c=Math.floor((e-l)/n),d=c>=90?3:c>=60?2:c>=30?1:0,u=d>=3?.25:d>=2?.2:d>=1?.15:.1,p=Math.round((a.price||0)*(1-u)*100)/100;return{item:a,days:c,tier:d,dropPct:u,suggested:p}}).sort((a,l)=>l.days-a.days);if(!s.length){t.style.display="none";return}const r=s.slice(0,5),i=s.length-r.length,o=a=>a>=90?" 90+d":a>=60?" 60+d":a>=30?" 30+d":" 14+d";t.style.display="",t.innerHTML=`<div class="price-alerts-wrap">
    <div class="price-alerts-hdr">
      <div class="price-alerts-title"> Price Drop Suggestions <span style="font-family:'DM Mono',monospace;font-weight:400;font-size:10px;opacity:0.7">${s.length} item${s.length>1?"s":""} not moving</span></div>
      <button class="price-alerts-dismiss" onclick="document.getElementById('priceAlerts').style.display='none'">Dismiss</button>
    </div>
    ${r.map(a=>`<div class="price-alert-item">
      <div class="price-alert-info">
        <div class="price-alert-name" onclick="openDrawer('${a.item.id}')">${x(a.item.name)}</div>
        <div class="price-alert-meta">${o(a.days)}  listed ${a.days}d  ${w(a.item.price)} current</div>
      </div>
      <div class="price-alert-action">
        <div class="price-alert-suggest">${w(a.suggested)}</div>
        <button class="price-alert-btn" onclick="quickReprice('${a.item.id}',${a.suggested})">Apply ${Math.round(a.dropPct*100)}% off</button>
      </div>
    </div>`).join("")}
    ${i>0?`<div style="font-size:10px;color:var(--muted);margin-top:6px;font-family:'DM Mono',monospace">+ ${i} more stale items  check Insights for full list</div>`:""}
  </div>`}function jp(t,e){const n=_.find(r=>r.id===t);if(!n)return;const s=n.price;n.price=e,H(),J(),E(`${n.name} repriced: ${w(s)}  ${w(e)} `)}function zp(){Mp(),Lp();const t=[..._].sort((n,s)=>new Date(s.added)-new Date(n.added)).slice(0,6),e=document.getElementById("dashBody");if(!t.length){e.innerHTML='<tr><td colspan="4" style="padding:20px;color:var(--muted);font-size:12px;text-align:center">No items yet.</td></tr>';return}e.innerHTML=t.map(n=>{const{m:s}=qt(n),r=aa(n.qty,n.lowAlert,n.bulk);return`<tr onclick="openDrawer('${n.id}')" style="cursor:pointer">
      <td><div class="item-name">${x(n.name)}</div><div class="item-meta"><span class="item-sku">${x(n.sku||"")}</span>${n.upc?`<span class="upc-tag">${x(n.upc)}</span>`:""}${n.category?`<span class="cat-tag">${x(n.category)}</span>`:""} ${n.subcategory?`<span class="cat-tag" style="background:rgba(87,200,255,0.1);color:var(--accent)">${x(n.subcategory)}</span>`:""} ${n.subtype?`<span class="cat-tag" style="background:rgba(123,97,255,0.15);color:var(--accent3)">${x(n.subtype)}</span>`:""}</div></td>
      <td>${ei(n)}</td>
      <td><span style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:${ap(r)}">${n.qty||0}</span></td>
      <td><span class="margin-badge ${Lt(s)}">${Q(s)}</span></td>
    </tr>`}).join("")}let Mt=[];function bt(t){return t.images&&t.images.length?[...t.images]:t.image?[t.image]:[]}function Np(t,e,n){const s=t.target.files[0];if(t.target.value="",!s)return;const r=e==="f"?"f:"+n:activeDrawId+":"+n;ri(s,r)}function Up(t,e,n){if(t.stopPropagation(),t.preventDefault(),e==="f")Mt.splice(n,1),yt("f",Mt);else{const s=inv.find(o=>o.id===activeDrawId);if(!s)return;const r=bt(s),i=r[n];r.splice(n,1),s.images=r,s.image=r[0]||null,save(),yt("d",r),renderInv(),isStorageUrl(i)&&deleteImageFromStorage(i)}}function yt(t,e){for(let n=0;n<3;n++){const s=document.getElementById(t+"Slot"+n),r=document.getElementById(t+"SlotImg"+n),i=document.getElementById(t+"SlotRm"+n),o=document.getElementById(t+"SlotAdd"+n),a=document.getElementById(t+"SlotBadge"+n),l=document.getElementById(t+"SlotInput"+n);s&&(n<e.length?(s.className="img-slot filled",r.src=e[n],r.style.display="block",i&&(i.style.display="flex"),o&&(o.style.display="none"),a&&(a.style.display=n===0?"block":"none"),l&&(l.style.pointerEvents="none",l.style.opacity="0")):n===e.length?(s.className="img-slot",r.src="",r.style.display="none",i&&(i.style.display="none"),o&&(o.style.display="flex",o.style.opacity="1"),a&&(a.style.display="none"),l&&(l.style.pointerEvents="auto",l.style.opacity="0")):(s.className="img-slot img-slot-locked",r.src="",r.style.display="none",i&&(i.style.display="none"),o&&(o.style.display="flex",o.style.opacity="0.3"),a&&(a.style.display="none"),l&&(l.style.pointerEvents="none",l.style.opacity="0")))}}function qp(){yt("f",Mt)}function Fp(t){const e=inv.find(n=>n.id===t);yt("d",e?bt(e):[])}function ri(t,e){const n=new FileReader;n.onload=s=>Sa(s.target.result,t.type,e),n.readAsDataURL(t)}function Hp(t){t.preventDefault()}function Wp(){}function Vp(t,e){t.preventDefault();const n=t.dataTransfer.files[0];n&&n.type.startsWith("image/")&&ri(n,e+":0")}function Gp(t){const e=inv.find(s=>s.id===t),n=e?bt(e):[];n.length&&_a(n[0])}function _a(t){t&&(document.getElementById("lightboxImg").src=t,document.getElementById("lightbox").classList.add("on"))}let z={ctx:null,origDataUrl:null,mimeType:null,img:null,scale:1,rect:null,drag:null,dragStart:null,aspect:null};const Lr="ontouchstart"in window||navigator.maxTouchPoints>0?14:7;function Sa(t,e,n){z.ctx=n,z.origDataUrl=t,z.mimeType=e,z.aspect=null;const s=new Image;s.onload=()=>{z.img=s,document.getElementById("cropCanvasWrap");const r=document.getElementById("cropCanvas"),i=Math.min(window.innerWidth*.9,520),o=window.innerHeight*.55,a=Math.min(i/s.width,o/s.height,1);r.width=Math.round(s.width*a),r.height=Math.round(s.height*a),z.scale=a,z.rect={x:0,y:0,w:r.width,h:r.height},Zn(),r.onmousedown=Ea,r.onmousemove=Ia,r.onmouseup=Ta,r.removeEventListener("touchstart",Mr),r.removeEventListener("touchmove",jr),r.removeEventListener("touchend",zr),r.addEventListener("touchstart",Mr,{passive:!1}),r.addEventListener("touchmove",jr,{passive:!1}),r.addEventListener("touchend",zr,{passive:!1});const l=document.getElementById("cropOv");l.style.display="flex",l.classList.add("on")},s.src=t}function Zn(){const t=document.getElementById("cropCanvas"),e=t.getContext("2d"),{img:n,scale:s,rect:r}=z;if(e.clearRect(0,0,t.width,t.height),e.drawImage(n,0,0,t.width,t.height),!r)return;e.fillStyle="rgba(0,0,0,0.55)",e.fillRect(0,0,t.width,r.y),e.fillRect(0,r.y+r.h,t.width,t.height-r.y-r.h),e.fillRect(0,r.y,r.x,r.h),e.fillRect(r.x+r.w,r.y,t.width-r.x-r.w,r.h),e.strokeStyle="#57c8ff",e.lineWidth=1.5,e.strokeRect(r.x+.5,r.y+.5,r.w-1,r.h-1),e.strokeStyle="rgba(87,200,255,0.25)",e.lineWidth=.5;for(let o=1;o<3;o++){const a=r.x+r.w/3*o,l=r.y+r.h/3*o;e.beginPath(),e.moveTo(a,r.y),e.lineTo(a,r.y+r.h),e.stroke(),e.beginPath(),e.moveTo(r.x,l),e.lineTo(r.x+r.w,l),e.stroke()}const i=[[r.x,r.y],[r.x+r.w,r.y],[r.x,r.y+r.h],[r.x+r.w,r.y+r.h]];for(const[o,a]of i)e.fillStyle="#57c8ff",e.beginPath(),e.arc(o,a,Lr,0,Math.PI*2),e.fill(),e.fillStyle="#0a0a0f",e.beginPath(),e.arc(o,a,Lr-2.5,0,Math.PI*2),e.fill()}function ka(t,e){const{rect:n}=z;if(!n)return null;const s=Lr+3,r={nw:[n.x,n.y],ne:[n.x+n.w,n.y],sw:[n.x,n.y+n.h],se:[n.x+n.w,n.y+n.h]};for(const[i,[o,a]]of Object.entries(r))if(Math.abs(t-o)<s&&Math.abs(e-a)<s)return i;return t>n.x&&t<n.x+n.w&&e>n.y&&e<n.y+n.h?"move":"new"}function pe(t,e,n){return Math.max(e,Math.min(n,t))}function $a(t){if(!z.aspect)return t;const{w:e,h:n}=z.aspect,s=document.getElementById("cropCanvas");let r=t.w/e*n;return t.y+r>s.height&&(r=s.height-t.y,t.w=r/n*e),t.h=r,t}function Ea(t){t.preventDefault();const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,r=e.height/n.height;ii((t.clientX-n.left)*s,(t.clientY-n.top)*r)}function Ia(t){if(!z.drag)return;t.preventDefault();const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,r=e.height/n.height;oi((t.clientX-n.left)*s,(t.clientY-n.top)*r)}function Ta(t){Fs()}document.addEventListener("mouseup",()=>{z.drag&&Fs()});function Mr(t){t.preventDefault();const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,r=e.height/n.height,i=t.touches[0];ii((i.clientX-n.left)*s,(i.clientY-n.top)*r)}function jr(t){if(t.preventDefault(),!z.drag)return;const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,r=e.height/n.height,i=t.touches[0];oi((i.clientX-n.left)*s,(i.clientY-n.top)*r)}function zr(t){t.preventDefault(),Fs()}function ii(t,e){const n=ka(t,e),s=z.rect||{x:0,y:0,w:0,h:0};z.drag=n,z.dragStart={mx:t,my:e,rx:s.x,ry:s.y,rw:s.w,rh:s.h};const r=document.getElementById("cropCanvas");r.style.cursor=n==="move"?"grabbing":n==="new"?"crosshair":"nwse-resize",n==="new"&&(z.rect={x:t,y:e,w:0,h:0})}function oi(t,e){if(!z.drag)return;const{drag:n,dragStart:s}=z,r=document.getElementById("cropCanvas"),i=r.width,o=r.height,a=t-s.mx,l=e-s.my,c=s;let d={...z.rect};if(n==="new")d.x=Math.min(c.rx,t),d.y=Math.min(c.ry,e),d.w=Math.abs(t-c.rx),d.h=Math.abs(e-c.ry),z.aspect&&(d=$a(d));else if(n==="move")d.x=pe(c.rx+a,0,i-c.rw),d.y=pe(c.ry+l,0,o-c.rh);else if(n==="nw"){const u=pe(c.rx+a,0,c.rx+c.rw-10),p=pe(c.ry+l,0,c.ry+c.rh-10);d.w=c.rx+c.rw-u,d.h=c.ry+c.rh-p,d.x=u,d.y=p,z.aspect&&(d.h=d.w/z.aspect.w*z.aspect.h,d.y=c.ry+c.rh-d.h)}else if(n==="ne"){d.w=pe(c.rw+a,10,i-c.rx);const u=pe(c.ry+l,0,c.ry+c.rh-10);d.h=c.ry+c.rh-u,d.y=u,z.aspect&&(d.h=d.w/z.aspect.w*z.aspect.h,d.y=c.ry+c.rh-d.h)}else if(n==="sw"){const u=pe(c.rx+a,0,c.rx+c.rw-10);d.w=c.rx+c.rw-u,d.x=u,d.h=pe(c.rh+l,10,o-c.ry),z.aspect&&(d.h=d.w/z.aspect.w*z.aspect.h)}else n==="se"&&(d.w=pe(c.rw+a,10,i-c.rx),d.h=pe(c.rh+l,10,o-c.ry),z.aspect&&(d.h=d.w/z.aspect.w*z.aspect.h));d.x=pe(d.x,0,i),d.y=pe(d.y,0,o),d.w=pe(d.w,0,i-d.x),d.h=pe(d.h,0,o-d.y),z.rect=d,Zn()}function Fs(){z.drag=null,z.dragStart=null,document.getElementById("cropCanvas").style.cursor="crosshair"}function Kp(){const t=document.getElementById("cropCanvas");z.rect={x:0,y:0,w:t.width,h:t.height},z.aspect=null,Zn()}function Jp(t,e){z.aspect={w:t,h:e};const n=document.getElementById("cropCanvas"),s=z.rect||{x:0,y:0,w:n.width,h:n.height};s.h=s.w/t*e,s.y+s.h>n.height&&(s.h=n.height-s.y,s.w=s.h/e*t),z.rect=s,Zn()}function Ca(){const t=document.getElementById("cropOv");t.classList.remove("on"),t.style.display="none",z={ctx:null,origDataUrl:null,mimeType:null,img:null,scale:1,rect:null,drag:null,dragStart:null,aspect:null}}function Yp(){const{img:t,rect:e,scale:n,ctx:s,mimeType:r}=z;if(!t||!e||e.w<2||e.h<2){Ca();return}const i=e.x/n,o=e.y/n,a=e.w/n,l=e.h/n,c=document.createElement("canvas");c.width=Math.round(a),c.height=Math.round(l),c.getContext("2d").drawImage(t,i,o,a,l,0,0,c.width,c.height);const d=c.toDataURL("image/jpeg",.92),u=document.getElementById("cropOv");u.classList.remove("on"),u.style.display="none";const p=s,f=activeDrawId;z={ctx:null,origDataUrl:null,mimeType:null,img:null,scale:1,rect:null,drag:null,dragStart:null,aspect:null},Pa(d,r,(m,v)=>{const[g,b]=(p||"").split(":"),S=parseInt(b)||0;if(g==="f")S>=Mt.length?Mt.push(m):Mt[S]=m,yt("f",Mt),toast("Photo added ");else{const k=g||f,P=inv.find(M=>M.id===k);if(P){const M=bt(P);S>=M.length?M.push(m):M[S]=m,P.images=M.slice(),P.image=M[0]||null,yt("d",P.images),renderInv(),toast("Photo added  uploading"),uploadImageToStorage(m,k,S).then(D=>{const q=bt(P),O=q.indexOf(m);O!==-1?q[O]=D:q[S]=D,P.images=q,P.image=q[0]||null,save(),yt("d",P.images),renderInv(),toast("Photo saved ")}).catch(D=>{console.warn("FlipTrack: upload failed, keeping base64:",D.message),save(),toast("Photo saved locally ")})}}})}function Pa(t,e,n){const o="image/jpeg",a=new Image;a.onload=()=>{if(Math.round(t.length*.75/1024)<=200&&a.width<=900&&a.height<=900){n(t,!1);return}const c=document.createElement("canvas"),d=c.getContext("2d");let u=a.width,p=a.height;if(u>900||p>900){const v=Math.min(900/u,900/p);u=Math.round(u*v),p=Math.round(p*v)}c.width=u,c.height=p,d.drawImage(a,0,0,u,p);let f=.85,m=c.toDataURL(o,f);for(;m.length*.75/1024>200&&f>.3;)f=Math.max(.3,f-.1),m=c.toDataURL(o,f);m.length*.75/1024>200&&(c.width=Math.round(u*.65),c.height=Math.round(p*.65),d.drawImage(a,0,0,c.width,c.height),m=c.toDataURL(o,.3)),n(m,!0)},a.src=t}function Aa(){document.getElementById("lightbox").classList.remove("on"),document.getElementById("lightboxImg").src=""}document.addEventListener("keydown",t=>{t.key==="Escape"&&Aa()});const Qp=Object.freeze(Object.defineProperty({__proto__:null,clamp:pe,closeLightbox:Aa,compressImage:Pa,cropApplyAspect:$a,cropCancel:Ca,cropConfirm:Yp,cropDraw:Zn,cropEndDrag:Fs,cropHitTest:ka,cropMouseDown:Ea,cropMouseMove:Ia,cropMouseUp:Ta,cropMoveDrag:oi,cropReset:Kp,cropSetAspect:Jp,cropStartDrag:ii,cropTouchEnd:zr,cropTouchMove:jr,cropTouchStart:Mr,getItemImages:bt,imgDragLeave:Wp,imgDragOver:Hp,imgDrop:Vp,imgSlotChange:Np,imgSlotRemove:Up,openCropModal:Sa,openLightbox:Gp,openLightboxUrl:_a,readImgFile:ri,refreshImgSlots:yt,renderAddFormImages:qp,renderDrawerImg:Fp},Symbol.toStringTag,{value:"Module"}));function mn(t,e){if(!t)return;const{page:n,totalItems:s,pageSize:r,onPage:i,pageSizes:o,onPageSize:a}=e,l=Math.max(1,Math.ceil(s/r));if(s<=r){t.innerHTML="";return}const c=Math.max(0,Math.min(n,l-1)),d=c*r+1,u=Math.min((c+1)*r,s),p=document.createElement("div");p.className="ft-pagination",p.style.cssText="display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 0;font-size:12px;color:var(--muted)";const f=(v,g,b)=>{const S=document.createElement("button");return S.className="btn-secondary pg-btn",S.style.cssText='padding:5px 12px;font-size:11px;font-family:"DM Mono",monospace',S.textContent=v,S.disabled=b,b&&(S.style.opacity="0.3"),b||S.addEventListener("click",()=>i(g)),S};p.appendChild(f("",0,c===0)),p.appendChild(f(" Prev",c-1,c===0));const m=document.createElement("span");if(m.style.cssText="font-family:'Syne',sans-serif;font-weight:600;padding:0 4px",m.textContent=`${d}${u} of ${s}`,p.appendChild(m),p.appendChild(f("Next ",c+1,c>=l-1)),p.appendChild(f("",l-1,c>=l-1)),o&&o.length>1&&a){const v=document.createElement("select");v.style.cssText="background:var(--surface);border:1px solid var(--border);color:var(--muted);padding:4px 8px;font-family:'DM Mono',monospace;font-size:11px;margin-left:8px",o.forEach(g=>{const b=document.createElement("option");b.value=g,b.textContent=`${g}/page`,g===r&&(b.selected=!0),v.appendChild(b)}),v.addEventListener("change",()=>a(parseInt(v.value))),p.appendChild(v)}t.innerHTML="",t.appendChild(p)}let In=null,we="all",Je="all",An="all",be=0,Sn=50,xo=null;function Oa(){const t=document.getElementById("activeFiltersBadge"),e=document.getElementById("filterToggleBtn");if(!t)return;const n=Ue.size+Ie.size+(we!=="all"?1:0)+(Je!=="all"?1:0);n?(t.textContent=n+" active",t.style.display="inline",e.classList.add("active")):(t.style.display="none",e.classList.remove("active"))}function Xp(){const t=document.getElementById("filterPanel");t&&t.classList.toggle("open")}function Da(t){var p,f;const e=_.length+":"+(((p=_[0])==null?void 0:p.id)||"")+":"+(((f=_[_.length-1])==null?void 0:f.id)||"");if(!t&&xo===e){Zp();return}xo=e;const n=new Set(_.flatMap(m=>X(m)).filter(Boolean));let s=`<span class="filter-chip ${Ue.size===0?"active":""}" role="button" tabindex="0" onclick="setPlatFilt('all',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">All</span>`;Jl.forEach(m=>{s+=`<span class="plat-group-divider">${m.label}</span>`,m.items.forEach(v=>{const g=n.has(v)?'<span class="plat-dot"></span>':"";s+=`<span class="filter-chip plat-chip ${Ue.has(v)?"active":""}" role="button" tabindex="0" onclick="setPlatFilt('${v}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${g}${v}</span>`})}),document.getElementById("platChips").innerHTML=s;const r=new Map;_.forEach(m=>{const v=(m.category||"").trim();if(v){const g=v.toLowerCase();r.has(g)||r.set(g,v)}});const i=["all",...[...r.values()].sort()],o=document.getElementById("catChips");o.innerHTML=i.map(m=>{const v=m.replace(/'/g,"\\'");return`<span class="filter-chip cat-chip ${(m==="all"?Ie.size===0:[...Ie].some(b=>b.toLowerCase()===m.toLowerCase()))?"active":""}" role="button" tabindex="0" onclick="setCatFilt('${v}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${m==="all"?"All Categories":m}</span>`}).join(""),document.getElementById("catToolbar").style.display=i.length>1?"flex":"none";const a=document.getElementById("subcatToolbar"),l=Ie.size===1?[...Ie][0]:null,c=l?Vn[l]:null;if(c){const m=l.toLowerCase(),v=[...new Set(_.filter(b=>(b.category||"").toLowerCase()===m).map(b=>b.subcategory||"").filter(Boolean))],g=[...new Set([...c,...v])];document.getElementById("subcatChips").innerHTML=["all",...g].map(b=>{const S=b.replace(/'/g,"\\'");return`<span class="filter-chip subcat-chip ${we===b?"active":""}" role="button" tabindex="0" onclick="setSubcatFilt('${S}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${b==="all"?"All":b}</span>`}).join(""),a.style.display="flex"}else a.style.display="none",we="all";const d=Ro[we],u=document.getElementById("subsubcatToolbar");if(d&&d.length&&we!=="all"){const m=[...new Set(_.filter(g=>g.subcategory===we).map(g=>g.subtype||"").filter(Boolean))],v=[...new Set([...d,...m])];document.getElementById("subsubcatLabel").textContent=["Men","Women","Children"].includes(we)?" Clothing Type":` ${we}`,document.getElementById("subsubcatChips").innerHTML=["all",...v].map(g=>{const b=g.replace(/'/g,"\\'");return`<span class="filter-chip subsubcat-chip ${Je===g?"active":""}" role="button" tabindex="0" onclick="setSubsubcatFilt('${b}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${g==="all"?"All":g}</span>`}).join(""),u.style.display="flex"}else u.style.display="none",Je="all";Oa()}function Zp(){document.querySelectorAll("#platChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All"?Ue.size===0:Ue.has(e))}),document.querySelectorAll("#catChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All Categories"?Ie.size===0:[...Ie].some(n=>n.toLowerCase()===e.toLowerCase()))}),document.querySelectorAll("#subcatChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All"?we==="all":we===e)}),document.querySelectorAll("#subsubcatChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All"?Je==="all":Je===e)}),Oa()}function eh(t,e){be=0,t==="all"?Ue.clear():Ue.has(t)?Ue.delete(t):Ue.add(t),ye()}function th(t,e){be=0,t==="all"?Ie.clear():Ie.has(t)?Ie.delete(t):Ie.add(t),we="all",Je="all",ye()}function nh(t,e){be=0,we=t,Je="all",document.querySelectorAll("#subcatChips .subcat-chip").forEach(n=>n.classList.remove("active")),e.classList.add("active"),ye()}function sh(t){be=0,An=t,ye()}function rh(){An="all",ye()}function ih(t,e){be=0,Je=t,document.querySelectorAll("#subsubcatChips .subsubcat-chip").forEach(n=>n.classList.remove("active")),e.classList.add("active"),ye()}function oh(t){document.getElementById("sortSel").value=t,ye()}function ah(t){const e=document.getElementById("sortSel").value;return[...t].sort((n,s)=>e==="added-desc"?new Date(s.added)-new Date(n.added):e==="added-asc"?new Date(n.added)-new Date(s.added):e==="name-asc"?n.name.localeCompare(s.name):e==="margin-desc"?qt(s).m-qt(n).m:e==="qty-asc"?(n.qty||0)-(s.qty||0):e==="price-desc"?(s.price||0)-(n.price||0):e==="cost"?(n.cost||0)-(s.cost||0):e==="platform"?(X(n)[0]||"").localeCompare(X(s)[0]||""):0)}function ye(){Da();const t=(document.getElementById("invSearch").value||"").toLowerCase();let e=_.filter(d=>{const u=!t||d.name.toLowerCase().includes(t)||(d.sku||"").toLowerCase().includes(t)||(d.category||"").toLowerCase().includes(t)||(d.subcategory||"").toLowerCase().includes(t)||(d.subtype||"").toLowerCase().includes(t)||(d.upc||"").toLowerCase().includes(t),p=Ue.size===0||X(d).some(S=>Ue.has(S)),f=(d.category||"").toLowerCase(),m=Ie.size===0||[...Ie].some(S=>S.toLowerCase()===f),v=we==="all"||(d.subcategory||"")===we,g=Je==="all"||(d.subtype||"")===Je,b=An==="all"||An==="low"&&(d.qty===0||d.bulk&&d.qty<=(d.lowAlert||2));return u&&p&&m&&v&&g&&b});const n=document.getElementById("stockFilterBanner");if(An!=="all"){const d=_.filter(p=>p.bulk&&p.qty>0&&p.qty<=(p.lowAlert||2)).length,u=_.filter(p=>p.qty===0).length;document.getElementById("stockFilterLabel").textContent=`Showing low stock (${d}) and out of stock (${u}) items only`,n.style.display="flex"}else n.style.display="none";e=ah(e),document.getElementById("invCnt").textContent=`${e.length} of ${_.length} items`;const s=document.getElementById("invBody"),r=document.getElementById("invEmpty");if(!e.length){s.innerHTML="",r.style.display="block",Ts();return}r.style.display="none";const i=e.length,o=Math.max(1,Math.ceil(i/Sn));be>=o&&(be=o-1),be<0&&(be=0);const a=e.slice(be*Sn,(be+1)*Sn),l=Math.max(..._.map(d=>d.qty||0),1);s.innerHTML=a.map(d=>{const{cost:u,price:p,m:f}=qt(d),m=aa(d.qty,d.lowAlert,d.bulk),v=Math.min(100,(d.qty||0)/l*100),g=he.has(d.id);return`<tr data-id="${d.id}" class="${g?"sel":""}">
      <td class="cb-col"><input type="checkbox" ${g?"checked":""} onchange="toggleSel('${d.id}',this)"></td>
      <td><span class="drag-handle" draggable="true" ondragstart="dStart(event,'${d.id}')" ondragover="dOver(event)" ondrop="dDrop(event,'${d.id}')"></span></td>
      <td>${bt(d)[0]?`<img class="item-thumb" loading="lazy" src="${bt(d)[0]}" alt="${x(d.name)}" onclick="openLightbox('${d.id}')">`:`<div class="item-thumb-placeholder" title="Add photo" onclick="openDrawer('${d.id}')"></div>`}</td>
      <td>
        <div class="item-name" onclick="openDrawer('${d.id}')">${x(d.name)}</div>
        <div class="item-meta"><span class="item-sku">${x(d.sku||"")}</span>${d.upc?`<span class="upc-tag">${x(d.upc)}</span>`:""}${d.category?`<span class="cat-tag">${x(d.category)}</span>`:""} ${d.subcategory?`<span class="cat-tag" style="background:rgba(87,200,255,0.1);color:var(--accent)">${x(d.subcategory)}</span>`:""} ${d.subtype?`<span class="cat-tag" style="background:rgba(123,97,255,0.15);color:var(--accent3)">${x(d.subtype)}</span>`:""} ${d.condition?`<span class="cat-tag" style="background:rgba(87,255,154,0.08);color:var(--good)">${x(d.condition)}</span>`:""} ${d.source?`<span class="cat-tag" style="background:rgba(255,107,53,0.1);color:var(--accent2)">${x(d.source)}</span>`:""}${d.author?`<span class="book-meta-tag"> ${x(d.author)}</span>`:""}${d.edition?`<span class="book-meta-tag">${x(d.edition)} ed.</span>`:""}${d.signed?'<span class="book-meta-tag" style="background:rgba(255,215,0,0.15);color:#d4a017;border-color:rgba(255,215,0,0.3)"> Signed</span>':""}</div>
      </td>
      <td>${ei(d)}</td>
      <td>
        <div class="stock-cell">
          <div class="stepper">
            <button class="stepper-btn" aria-label="Decrease quantity" onclick="adjStock('${d.id}',-1)"></button>
            <span class="stepper-val sv-${m}" title="${m==="low"?"Low stock":m==="warn"?"Warning":"In stock"}">${d.qty||0}${m==="low"?" ":m==="warn"?" ":""}</span>
            <button class="stepper-btn" aria-label="Increase quantity" onclick="adjStock('${d.id}',+1)">+</button>
          </div>
          <div class="mini-bar"><div class="mb-fill mf-${m}" style="width:${v}%"></div></div>
        </div>
      </td>
      <td style="color:var(--muted)">${w(u)}</td>
      <td><span class="price-disp" title="Click to edit inline" onclick="startPriceEdit(this,'${d.id}')">${w(p)}</span></td>
      <td><span class="margin-badge ${Lt(f)}">${Q(f)}</span></td>
      <td><div class="td-acts">
        ${d.qty>0?`<button class="act-btn" onclick="openSoldModal('${d.id}')">Sold </button>`:'<span class="out-badge">Out</span>'}
        <button class="act-btn" onclick="openDrawer('${d.id}')">Edit</button>
        <button class="act-btn red" onclick="delItem('${d.id}')"></button>
      </div></td>
    </tr>`}).join(""),Ts();const c=document.getElementById("invPagination");c&&mn(c,{page:be,totalItems:i,pageSize:Sn,onPage:d=>{be=d,ye()},pageSizes:[50,100,250],onPageSize:d=>{Sn=d,be=0,ye()}})}function lh(t,e){const n=_.find(i=>i.id===e);if(!n)return;const s=document.createElement("input");s.className="price-inp",s.type="number",s.step="0.01",s.value=n.price||0,t.replaceWith(s),s.focus(),s.select();const r=()=>{const i=parseFloat(s.value);!isNaN(i)&&i>=0?(n.price=i,H(),J(),E("Price updated ")):ye()};s.addEventListener("blur",r),s.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),s.blur()),i.key==="Escape"&&(s.removeEventListener("blur",r),ye())})}function ch(t,e){const n=_.find(s=>s.id===t);n&&(n.qty=Math.max(0,(n.qty||0)+e),H(),J(),n.qty===0?E(" Out of stock!",!0):n.bulk&&n.qty<=(n.lowAlert||2)&&E(` Low: ${n.qty} left`,!0))}function dh(t,e){In=_.findIndex(n=>n.id===e),t.dataTransfer.effectAllowed="move"}function uh(t){var e;t.preventDefault(),t.dataTransfer.dropEffect="move",document.querySelectorAll("#invBody tr").forEach(n=>n.classList.remove("drag-over")),(e=t.currentTarget.closest("tr"))==null||e.classList.add("drag-over")}function ph(t,e){if(t.preventDefault(),document.querySelectorAll("#invBody tr").forEach(r=>r.classList.remove("drag-over")),In===null)return;const n=_.findIndex(r=>r.id===e);if(In===n)return;const[s]=_.splice(In,1);_.splice(n,0,s),In=null,H(),ye()}function hh(t,e){e.checked?he.add(t):he.delete(t),e.closest("tr").classList.toggle("sel",e.checked),Ts();const n=document.querySelectorAll("#invBody input[type=checkbox]");document.getElementById("selAll").checked=n.length&&[...n].every(s=>s.checked)}function fh(t){document.querySelectorAll("#invBody tr[data-id]").forEach(e=>{const n=e.dataset.id,s=e.querySelector("input[type=checkbox]");t.checked?(he.add(n),s.checked=!0,e.classList.add("sel")):(he.delete(n),s.checked=!1,e.classList.remove("sel"))}),Ts()}function gh(){he.clear(),document.getElementById("selAll").checked=!1,ye()}function Ts(){document.getElementById("bulkBar").classList.toggle("on",he.size>0),document.getElementById("bulkCnt").textContent=he.size+" selected"}async function mh(){if(!he.size||!confirm(`Delete ${he.size} item(s)?`))return;const t=[...he];t.forEach(e=>ia(e)),he.clear(),H(),J(),E(t.length+" item(s) deleted  check  to restore"),await Jn("ft_inventory",t),gn()}function vh(){if(!he.size)return;const t=[...he].filter(n=>{const s=te(n);return s&&s.qty>0});if(!t.length){E("No sellable items selected",!0);return}if(!confirm(`Record sale for ${t.length} item(s) at list price?`))return;const e=new Date().toISOString().split("T")[0];for(const n of t){const s=te(n);C.push({id:Fe(),itemId:n,price:s.price,listPrice:s.price||0,qty:1,fees:s.fees||0,ship:s.ship||0,date:e}),s.qty=Math.max(0,(s.qty||0)-1)}he.clear(),H(),J(),E(`${t.length} sale(s) recorded `)}let jt=null;function Ra(t){if(!supplies.length){t([]);return}jt=t;const e=document.getElementById("matsBody");e.innerHTML=supplies.map(n=>{const s=n.qty<=(n.alert||5);return`<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--surface);border:1px solid ${s?"rgba(255,107,107,0.35)":"var(--border)"};border-radius:2px">
      <input type="checkbox" id="mat_${n.id}" style="width:16px;height:16px;accent-color:var(--accent);flex-shrink:0">
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-family:'Syne',sans-serif;font-weight:600">${n.name}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${n.category}  ${n.qty} in stock${s?'  <span style="color:#ff6b6b">LOW</span>':""}</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
        <span style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">Qty used:</span>
        <input type="number" id="matqty_${n.id}" value="1" min="1" max="${n.qty}"
          style="width:48px;text-align:center;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:4px 6px">
      </div>
    </div>`}).join(""),document.getElementById("matsOv").classList.add("on")}function yh(){const t=[];for(const e of supplies){const n=document.getElementById("mat_"+e.id);if(n&&n.checked){const s=parseInt(document.getElementById("matqty_"+e.id).value)||1;t.push({supplyId:e.id,qty:s}),e.qty=Math.max(0,e.qty-s)}}document.getElementById("matsOv").classList.remove("on"),t.length&&(saveSupplies(),renderSupplies(),checkSupplyAlerts(),toast("Materials deducted ")),jt&&(jt(t),jt=null)}function bh(){document.getElementById("matsOv").classList.remove("on"),jt&&(jt([]),jt=null)}let On=null,ai="each",Me=0;const vs=50;let ht="",on="",an="";function wh(t){On=t;const e=_.find(a=>a.id===t);if(!e){E("Item not found",!0);return}const{pu:n,m:s}=Eh(e);document.getElementById("soldInfo").innerHTML=`
    <div class="sir"><span class="k">Item</span><span>${x(e.name)}</span></div>
    <div class="sir"><span class="k">Platforms</span><span>${X(e).join(", ")||""}</span></div>
    <div class="sir"><span class="k">Cost</span><span>${w(e.cost)}</span></div>
    <div class="sir"><span class="k">List Price</span><span>${w(e.price)}</span></div>
    <div class="sir"><span class="k">Expected Profit</span><span style="color:var(--good)">${w(n)} (${Q(s)})</span></div>
    <div class="sir"><span class="k">In Stock</span><span>${e.qty} units</span></div>`,document.getElementById("s_price").value=e.price||"",document.getElementById("s_qty").value="1",document.getElementById("s_fees").value=e.fees||"",document.getElementById("s_ship").value=e.ship||"",document.getElementById("s_date").value=new Date().toISOString().split("T")[0];const r=X(e),i=Kl.filter(a=>!r.includes(a)),o=document.getElementById("s_platform");o.innerHTML=[...r.map(a=>`<option value="${a}" selected>${x(a)} </option>`),`<option value="" disabled>${r.length?" Other platforms ":" Select platform "}</option>`,...i.map(a=>`<option value="${a}">${x(a)}</option>`)].join(""),r.length&&(o.value=r[0]),Ba("each"),Ma(),document.getElementById("soldOv").classList.add("on")}function Ba(t){ai=t;const e=document.getElementById("s_price_each"),n=document.getElementById("s_price_total"),s="flex:1;padding:8px 6px;font-family:'DM Mono',monospace;font-size:11px;border:1px solid var(--accent);background:var(--accent);color:#0a0a0f;cursor:pointer;border-radius:0;font-weight:700",r="flex:1;padding:8px 6px;font-family:'DM Mono',monospace;font-size:11px;border:1px solid var(--border);background:var(--surface);color:var(--muted);cursor:pointer;border-radius:0";e&&(e.style.cssText=t==="each"?s:r),n&&(n.style.cssText=t==="total"?s:r),La()}function xh(t){ht=(t||"").toLowerCase(),Me=0,Ft()}function _h(t){on=t||"",Me=0,Ft()}function Sh(t){an=t||"",Me=0,Ft()}function kh(){ht="",on="",an="",Me=0,Ft()}function La(){const t=parseInt(document.getElementById("s_qty").value)||1,e=parseFloat(document.getElementById("s_price").value)||0,n=document.getElementById("s_price_hint");n&&(ai==="each"?n.textContent=t>1?`Per unit  total = ${w(e*t)}`:"Price per individual unit":n.textContent=t>1?`Total for all ${t} units  each = ${w(e/t)}`:"Total sale price")}function Ma(){const t=document.getElementById("s_platform").value,e=parseFloat(document.getElementById("s_price").value)||0,n=document.getElementById("s_fee_hint");if(!n)return;const s=Oo[t];if(!s){n.style.display="none";return}if(n.style.display="",e>0){const r=Ql(t,e);n.innerHTML=`${s.label}  est. <strong style="color:var(--accent)">${w(r)}</strong> <button onclick="document.getElementById('s_fees').value=${r};this.textContent='Applied '" style="background:none;border:1px solid var(--border);color:var(--accent);font-size:9px;padding:2px 8px;cursor:pointer;font-family:'DM Mono',monospace;margin-left:4px">Apply</button>`}else n.textContent=s.label}function Nr(){document.getElementById("soldOv").classList.remove("on"),On=null}function $h(){const t=_.find(p=>p.id===On);if(!t){E("Item not found  it may have been deleted",!0),Nr();return}const e=document.getElementById("s_price"),n=oe(e.value,{});if(isNaN(n)&&e.value.trim()!==""){Te(e,{fieldName:"Price"});return}if(!n){E("Sold price required",!0);return}const s=document.getElementById("s_qty"),r=oe(s.value,{integer:!0,min:1});if(isNaN(r)){Te(s,{fieldName:"Quantity",integer:!0});return}if(r>t.qty){E(`Only ${t.qty} available`,!0);return}const i=document.getElementById("s_fees"),o=oe(i.value,{allowZero:!0});if(isNaN(o)&&i.value.trim()!==""){Te(i,{fieldName:"Fees"});return}const a=document.getElementById("s_ship"),l=oe(a.value,{allowZero:!0});if(isNaN(l)&&a.value.trim()!==""){Te(a,{fieldName:"Shipping"});return}const c=ai==="total"?n/r:n,d=document.getElementById("s_platform").value||"Other",u={id:Fe(),itemId:On,price:c,listPrice:t.price||0,qty:r,platform:d,fees:isNaN(o)?0:o,ship:isNaN(l)?0:l,date:document.getElementById("s_date").value||new Date().toISOString()};zs("sold",{itemId:On,qty:r,saleId:u.id}),C.push(u),ve("sales",u.id),t.qty-=r;{t.platformStatus||(t.platformStatus={}),t.platformStatus[d]="sold";const p=wp(t.id,d);p.length&&E(`Auto-marked ${p.join(", ")} as sold-elsewhere`)}ve("inv",t.id),H(),Nr(),J(),Ds.sale(),ip("Item marked as sold"),Ra(()=>{})}function Eh(t){const e=t.cost||0,n=t.price||0,s=t.fees||0,r=t.ship||0,i=n-e-s-r,o=n?i/n:0,a=e?i/e:0;return{cost:e,price:n,fees:s,ship:r,pu:i,m:o,roi:a}}function Ft(){const t=document.getElementById("salesBody"),e=document.getElementById("salesEmpty"),n=document.getElementById("salesPagination");let s=0,r=0;for(const u of C){const p=te(u.itemId);s+=(u.price||0)*(u.qty||0),r+=(u.price||0)*(u.qty||0)-(p?(p.cost||0)*(u.qty||0):0)-(u.fees||0)-(u.ship||0)}document.getElementById("salesTotalLbl").textContent=`${C.length} sales  ${w(s)} revenue  ${w(r)} profit`;const i=[...C].reverse();let o=i;ht&&(o=o.filter(u=>{const p=te(u.itemId),f=p?p.name.toLowerCase():"",m=p?(p.category||"").toLowerCase():"",v=(u.platform||"").toLowerCase();return f.includes(ht)||m.includes(ht)||v.includes(ht)})),on&&(o=o.filter(u=>u.date>=on)),an&&(o=o.filter(u=>u.date<=an));const a=document.getElementById("salesFilterBar");if(a&&(a.innerHTML=`<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 0">
      <input type="text" placeholder="Search sales..." value="${x(ht)}"
             oninput="setSalesSearch(this.value)"
             style="flex:1;min-width:150px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;font-family:'DM Mono',monospace">
      <input type="date" value="${on}" onchange="setSalesDateFrom(this.value)" title="From date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      <span style="color:var(--muted);font-size:11px">to</span>
      <input type="date" value="${an}" onchange="setSalesDateTo(this.value)" title="To date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      ${ht||on||an?`<button onclick="clearSalesFilters()" style="padding:5px 10px;background:var(--surface);border:1px solid var(--border);color:var(--danger);font-size:11px;cursor:pointer;font-family:'DM Mono',monospace">Clear</button>`:""}
      <span style="color:var(--muted);font-size:11px">${o.length} of ${i.length} sales</span>
    </div>`),!o.length){t.innerHTML="",e.style.display="block",n&&(n.innerHTML="");return}e.style.display="none";const l=Math.ceil(o.length/vs);Me>=l&&(Me=l-1),Me<0&&(Me=0);const c=Me*vs,d=o.slice(c,c+vs);t.innerHTML=d.map(u=>{const p=te(u.itemId),f=p?x(p.name):"Deleted Item",m=p?(p.cost||0)*(u.qty||0):0,g=(u.price||0)*(u.qty||0)-m-(u.fees||0)-(u.ship||0),b=u.listPrice||(p?p.price:0),S=b>0?(u.price-b)/b:0,k=b>0?S>.01?`<span style="font-size:9px;color:var(--good);font-family:'DM Mono',monospace">${Q(S)}</span>`:S<-.01?`<span style="font-size:9px;color:var(--danger);font-family:'DM Mono',monospace">${Q(Math.abs(S))}</span>`:`<span style="font-size:9px;color:var(--muted);font-family:'DM Mono',monospace">= list</span>`:"";return`<tr>
      <td><div class="item-name" style="cursor:${p?"pointer":"default"}" ${p?`onclick="openDrawer('${x(p.id)}')"`:""}>${f}</div>${p!=null&&p.category?`<div class="item-meta"><span class="cat-tag">${x(p.category)}</span></div>`:""}</td>
      <td>${u.platform?`<span class="plat-tag ${Yl(u.platform)}">${x(u.platform)}</span>`:p?ei(p):"-"}</td>
      <td style="color:var(--muted);font-size:11px">${me(u.date)}</td>
      <td>${u.qty}</td>
      <td>${w(u.price)} ${k}</td>
      <td style="color:var(--muted)">${w(p?p.cost:0)}</td>
      <td style="color:var(--muted)">${w((u.fees||0)+(u.ship||0))}</td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;color:${g>=0?"var(--good)":"var(--danger)"}">${w(g)}</td>
      <td><div class="td-acts"><button class="act-btn red" onclick="delSale('${x(u.id)}')"></button></div></td>
    </tr>`}).join(""),n&&mn(n,{page:Me,totalItems:o.length,pageSize:vs,onPage:u=>{Me=u,Ft()}})}function Ih(){var Ai,Oi,Di,Ri,Bi,Li,Mi,ji,zi,Ni,Ui,qi,Fi;const t=document.getElementById("insightsContent");if(!t)return;if(!C.length&&!_.length){t.innerHTML='<div class="panel" style="animation:none"><div class="empty-state"><div class="empty-icon"></div><p>No data yet.<br>Add inventory and record some sales to see insights.</p></div></div>';return}const e=new Date,n=864e5,s=new Date(e-30*n),r=_.map(h=>{const y=C.filter(De=>De.itemId===h.id),$=y.reduce((De,He)=>De+(He.price||0)*(He.qty||0),0),U=y.reduce((De,He)=>De+(He.qty||0),0),F=y.reduce((De,He)=>De+(He.price||0)*(He.qty||0)-(h.cost||0)*(He.qty||0)-(He.fees||0)-(He.ship||0),0),le=y.length?new Date(Math.max(...y.map(De=>new Date(De.date)))):null,ne=le?Math.floor((e-le)/n):null,ce=new Date(h.added||e),Jt=Math.floor((e-ce)/n),rr=$>0?F/$:0,bn=h.cost>0?F/(h.cost*(U||1)):0,ir=y.filter(De=>new Date(De.date)>=s);return{item:h,itemSales:y,revenue:$,unitsSold:U,profit:F,lastSale:le,daysSinceSale:ne,daysListed:Jt,margin:rr,roi:bn,recentSales30:ir}}),i={};for(const{item:h,revenue:y,profit:$,unitsSold:U}of r){const F=h.category||"Uncategorized";i[F]||(i[F]={revenue:0,profit:0,units:0,items:0}),i[F].revenue+=y,i[F].profit+=$,i[F].units+=U,i[F].items++}const o=Object.entries(i).sort((h,y)=>y[1].profit-h[1].profit).slice(0,5),a={};for(const h of C){const y=te(h.itemId),$=h.platform||y&&y.platform||"Other";a[$]||(a[$]={revenue:0,units:0,count:0}),a[$].revenue+=(h.price||0)*(h.qty||0),a[$].units+=h.qty||0,a[$].count++}const l=Object.entries(a).sort((h,y)=>y[1].revenue-h[1].revenue).slice(0,6),c=r.filter(h=>h.unitsSold>0).sort((h,y)=>y.unitsSold-h.unitsSold),d=r.filter(h=>h.unitsSold===0&&h.daysListed>=14).sort((h,y)=>y.daysListed-h.daysListed),u=[...r].filter(h=>h.profit>0).sort((h,y)=>y.profit-h.profit).slice(0,5),p=[...r].filter(h=>h.roi>0&&h.unitsSold>0).sort((h,y)=>y.roi-h.roi).slice(0,5),f=d.filter(h=>h.daysListed>=30).slice(0,5),m=r.filter(h=>h.recentSales30.length>0).sort((h,y)=>y.recentSales30.length-h.recentSales30.length).slice(0,5),v=G.reduce((h,y)=>h+(y.amount||0),0),g=C.reduce((h,y)=>h+(y.price||0)*(y.qty||0),0),b=c.reduce((h,y)=>h+y.profit,0)-v,S={};for(const h of G)S[h.category]=(S[h.category]||0)+(h.amount||0);const k=Object.entries(S).sort((h,y)=>y[1]-h[1]).slice(0,4),P=G.filter(h=>new Date(h.date)>=s).reduce((h,y)=>h+(y.amount||0),0),M=C.filter(h=>new Date(h.date)>=s).reduce((h,y)=>h+(y.price||0)*(y.qty||0),0),D=(h,y,$="var(--accent)")=>`<div style="height:6px;background:var(--surface3);border-radius:3px;margin-top:5px"><div style="height:6px;width:${y>0?Math.round(h/y*100):0}%;background:${$};border-radius:3px;transition:width 0.4s"></div></div>`,q=h=>h<=30?"var(--good)":h<=60?"var(--warn)":h<=90?"var(--accent2)":"var(--danger)",O=(h,y,$,U="var(--accent)")=>`
    <div style="background:var(--surface2);border:1px solid var(--border);padding:16px 18px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:8px">
        <span style="font-size:16px">${h}</span>
        <span style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:${U}">${y}</span>
      </div>
      ${$}
    </div>`,W=(h,y)=>{const $=h.item;return`<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
      <div style="min-width:0;flex:1">
        <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer" onclick="openDrawer('${$.id}')">${$.name}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${$.category||""}${$.subcategory?"  "+$.subcategory:""}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;margin-left:12px">${y(h)}</div>
    </div>`},T=C.reduce((h,y)=>h+(y.qty||0),0),I=c.length?c.reduce((h,y)=>h+y.margin,0)/c.length:0,j=_.reduce((h,y)=>{const U=C.filter(F=>F.itemId===y.id).reduce((F,le)=>F+(le.qty||0),0);return h+(y.qty||0)+U},0),Z=C.reduce((h,y)=>h+(y.qty||0),0),L=j>0?Z/j:0,V=h=>h>=.5?"var(--good)":h>=.25?"var(--warn)":"var(--danger)",Se=`
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px">
      ${[["Total Revenue",w(g),"var(--accent)"],["Net Profit",w(b),b>=0?"var(--good)":"var(--danger)"],["Units Sold",T,"var(--accent3)"],["Avg Margin",Q(I),I>=.2?"var(--good)":"var(--warn)"],["Sell-Through",j>0?(L*100).toFixed(0)+"%":"",V(L)]].map(([h,y,$])=>`
        <div style="background:var(--surface2);border:1px solid var(--border);padding:12px 14px">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${h}</div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:${$}">${y}</div>
        </div>`).join("")}
    </div>`,ss=m.length?O("","Hot Right Now  30 days",m.map(h=>W(h,y=>`
      <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--accent);font-weight:700">${y.recentSales30.length} sale${y.recentSales30.length>1?"s":""}</div>
      <div style="font-size:10px;color:var(--muted)">${w(y.revenue)} rev</div>`)).join(""),"var(--accent)"):"",rs=[...r].filter(h=>h.unitsSold>0).sort((h,y)=>y.unitsSold-h.unitsSold).slice(0,8),St=((Ai=rs[0])==null?void 0:Ai.unitsSold)||1,Gs=rs.length?O("","Best Sellers  All Time",rs.map((h,y)=>{const $=y===0?"":y===1?"":y===2?"":`<span style="font-size:10px;color:var(--muted)">#${y+1}</span>`,U=h.daysListed>0?(h.unitsSold/h.daysListed*30).toFixed(1):"";return`<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
        <span style="width:22px;text-align:center;flex-shrink:0">${$}</span>
        <div style="min-width:0;flex:1">
          <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer" onclick="openDrawer('${h.item.id}')">${h.item.name}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:1px">${h.item.category||""}  ~${U}/mo velocity</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-size:13px;font-family:'Syne',sans-serif;font-weight:700;color:var(--accent)">${h.unitsSold} sold</div>
          <div style="font-size:10px;color:var(--muted)">${w(h.revenue)} rev</div>
        </div>
      </div>`+D(h.unitsSold,St)}).join(""),"var(--accent)"):"",Ks=u.length?O("","Top Profit Generators",u.map((h,y)=>W(h,$=>`
      <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--good);font-weight:700">${w($.profit)}</div>
      <div style="font-size:10px;color:var(--muted)">${Q($.margin)} margin</div>`)).join("")+(u[0]?D(u[0].profit,u[0].profit,"var(--good)"):""),"var(--good)"):"",gl=p.length?O("","Best Return on Investment",p.map(h=>W(h,y=>`
      <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent3);font-weight:700">${Q(y.roi)} ROI</div>
      <div style="font-size:10px;color:var(--muted)">cost ${w(y.item.cost)}</div>`)).join(""),"var(--accent3)"):"",Qe={};for(const{item:h,revenue:y,profit:$,unitsSold:U}of r){const F=h.source||"Unknown";Qe[F]||(Qe[F]={revenue:0,profit:0,units:0,items:0,cost:0}),Qe[F].revenue+=y,Qe[F].profit+=$,Qe[F].units+=U,Qe[F].items++,Qe[F].cost+=(h.cost||0)*(h.qty||1)}const ml=Object.entries(i).map(([h,y])=>{const $=_.filter(F=>(F.category||"Uncategorized")===h).reduce((F,le)=>F+(le.cost||0)*((le.qty||0)+C.filter(ne=>ne.itemId===le.id).reduce((ne,ce)=>ne+(ce.qty||0),0)),0),U=$>0?y.profit/$:0;return{name:h,profit:y.profit,cost:$,roi:U,units:y.units}}).filter(h=>h.units>0).sort((h,y)=>y.roi-h.roi).slice(0,5),vl=Object.entries(Qe).filter(([h])=>h!=="Unknown").map(([h,y])=>{const $=y.cost>0?y.profit/y.cost:0;return{name:h,profit:y.profit,cost:y.cost,roi:$,units:y.units}}).filter(h=>h.units>0).sort((h,y)=>y.roi-h.roi).slice(0,5),yl=Object.entries(a).map(([h,y])=>{const $=C.filter(le=>{const ne=_.find(ce=>ce.id===le.itemId);return(le.platform||ne&&ne.platform||"Other")===h}).reduce((le,ne)=>{const ce=_.find(Jt=>Jt.id===ne.itemId);return le+(ce?(ce.cost||0)*(ne.qty||0):0)},0),U=y.revenue-$,F=$>0?U/$:0;return{name:h,profit:U,cost:$,roi:F,units:y.units}}).filter(h=>h.units>0).sort((h,y)=>y.roi-h.roi).slice(0,5),Js=(h,y)=>{if(!h.length)return"";const $=Math.max(...h.map(U=>Math.abs(U.roi)),.01);return`<div style="margin-bottom:14px">
      <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">${y}</div>
      ${h.map(U=>`<div style="padding:4px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px">${x(U.name)}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;font-weight:700;color:${U.roi>=0?"var(--accent3)":"var(--danger)"}">${Q(U.roi)}</span>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:1px">${w(U.profit)} profit on ${w(U.cost)} invested  ${U.units} unit${U.units!==1?"s":""}</div>
        ${D(Math.abs(U.roi),$,U.roi>=0?"var(--accent3)":"var(--danger)")}
      </div>`).join("")}
    </div>`},xi=Js(ml,"By Category")+Js(vl,"By Source")+Js(yl,"By Platform"),bl=xi.trim()?O("","ROI Breakdown",xi,"var(--accent3)"):"",wl=[30,60,90].map(h=>{const y=new Date(e-h*n),U=_.filter(ne=>new Date(ne.added||e)>=y).reduce((ne,ce)=>{const rr=C.filter(bn=>bn.itemId===ce.id).reduce((bn,ir)=>bn+(ir.qty||0),0);return ne+(ce.qty||0)+rr},0),F=C.filter(ne=>{const ce=_.find(Jt=>Jt.id===ne.itemId);return ce&&new Date(ce.added||e)>=y}).reduce((ne,ce)=>ne+(ce.qty||0),0),le=U>0?F/U:0;return{days:h,rate:le,sold:F,added:U}}),xl=L>=.5?"Excellent sell-through  your sourcing is well-calibrated":L>=.3?"Solid rate  look for ways to move stale items faster":L>=.15?"Below average  consider reducing new sourcing until existing stock moves":"Low sell-through  focus on clearing current inventory before buying more",_l=j>0?O("","Sell-Through Rate",`<div style="display:flex;gap:12px;margin-bottom:14px">
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;color:${V(L)}">${(L*100).toFixed(1)}%</div>
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px">All Time</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${Z} of ${j} units</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      ${wl.map(h=>`<div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:${V(h.rate)}">${(h.rate*100).toFixed(0)}%</div>
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px">${h.days}d cohort</div>
        <div style="font-size:9px;color:var(--muted)">${h.sold}/${h.added}</div>
      </div>`).join("")}
    </div>
    <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> ${xl}</div>`,V(L)):"",Pe={fresh:0,moderate:0,stale:0,deadPile:0},Vt=[];for(const h of r)h.item.qty<=0||(h.daysListed<=30?Pe.fresh++:h.daysListed<=60?Pe.moderate++:h.daysListed<=90?Pe.stale++:Pe.deadPile++,h.daysListed>60&&h.item.qty>0&&h.recentSales30.length===0&&Vt.push(h));Vt.sort((h,y)=>y.daysListed-h.daysListed);const Sl=Vt.map(h=>{const y=(h.item.price||0)*.8,$=h.recentSales30.length===0?"Lower price by 20%":"Relist on new platform";return`<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
      <td style="padding:8px 10px"><div class="item-name" style="cursor:pointer;font-weight:600" onclick="openDrawer('${h.item.id}')">${x(h.item.name)}</div></td>
      <td style="padding:8px 10px;font-family:'DM Mono',monospace;font-weight:600;color:${q(h.daysListed)}">${h.daysListed}d</td>
      <td style="padding:8px 10px;text-align:right;font-family:'DM Mono',monospace">${w(h.item.price)}</td>
      <td style="padding:8px 10px;text-align:right;font-family:'DM Mono',monospace;color:var(--good)">${w(y)}</td>
      <td style="padding:8px 10px;font-size:10px;color:var(--muted)">${h.item.platform||"Other"}</td>
      <td style="padding:8px 10px;font-size:10px;color:var(--warn)">${$}</td>
    </tr>`}).join(""),kl=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px">
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Fresh (030d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--good)">${Pe.fresh}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Moderate (3160d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--warn)">${Pe.moderate}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Stale (6190d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--accent2)">${Pe.stale}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Dead (90+d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--danger)">${Pe.deadPile}</div>
      </div>
    </div>
    ${Vt.length?`
    <div style="margin-top:12px">
      <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600">Death Pile Alert  ${Vt.length} item${Vt.length!==1?"s":""}</div>
      <div style="overflow-x:auto">
        <table style="width:100%;font-size:11px;border-collapse:collapse">
          <thead>
            <tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Item</th>
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Days</th>
              <th style="text-align:right;padding:8px 10px;color:var(--muted);font-weight:600">Current</th>
              <th style="text-align:right;padding:8px 10px;color:var(--muted);font-weight:600">Suggested</th>
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Platform</th>
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Action</th>
            </tr>
          </thead>
          <tbody>${Sl}</tbody>
        </table>
      </div>
    </div>
    `:'<div style="font-size:10px;color:var(--good);margin-top:10px"> No items in death pile  great inventory health!</div>'}
  `,$l=Pe.fresh||Pe.moderate||Pe.stale||Pe.deadPile?O("","Aging & Death Pile",kl,"var(--warn)"):"",El=f.length?O("","Not Moving  Consider Repricing",f.map(h=>W(h,y=>`
      <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--warn);font-weight:700">${y.daysListed}d listed</div>
      <div style="font-size:10px;color:var(--muted)">0 sold  ${w(y.item.price)} list</div>`)).join("")+`<div style="margin-top:10px;font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> Try lowering the price by 1020% or listing on an additional platform</div>`,"var(--warn)"):"",Il=((Di=(Oi=o[0])==null?void 0:Oi[1])==null?void 0:Di.profit)||1,Tl=o.length?O("","Top Categories by Profit",o.map(([h,y])=>`
      <div style="padding:6px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:12px;font-weight:600">${h}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--good);font-weight:700">${w(y.profit)}</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${y.units} unit${y.units!==1?"s":""} sold  ${w(y.revenue)} revenue  ${y.items} item${y.items!==1?"s":""}</div>
        ${D(y.profit,Il,"var(--good)")}
      </div>`).join("")):"",Cl=((Bi=(Ri=l[0])==null?void 0:Ri[1])==null?void 0:Bi.revenue)||1,Pl=l.length?O("","Platform Performance",l.map(([h,y])=>`
      <div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between">
          <span style="font-size:12px;font-weight:600">${h}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent)">${w(y.revenue)}</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${y.count} sale${y.count!==1?"s":""}  ${y.units} unit${y.units!==1?"s":""}</div>
        ${D(y.revenue,Cl)}
      </div>`).join("")):"",Ys=Object.entries(Qe).filter(([h])=>h!=="Unknown").sort((h,y)=>y[1].profit-h[1].profit).slice(0,6),Al=((Mi=(Li=Ys[0])==null?void 0:Li[1])==null?void 0:Mi.profit)||1,Ol=Ys.length?O("","Source Performance",Ys.map(([h,y])=>{const $=y.cost>0?y.profit/y.cost:0;return`<div style="padding:6px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:12px;font-weight:600">${x(h)}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--good);font-weight:700">${w(y.profit)}</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${y.units} sold  ${y.items} item${y.items!==1?"s":""}  ${w(y.revenue)} rev  ${Q($)} ROI</div>
        ${D(Math.max(y.profit,0),Al,y.profit>=0?"var(--good)":"var(--danger)")}
      </div>`}).join(""),"var(--accent2)"):"",Qs=g>0?v/g:0,Xs=Qs<.1?["","Low","var(--good)"]:Qs<.25?["","Moderate","var(--warn)"]:["","High","var(--danger)"],Dl=((ji=k[0])==null?void 0:ji[1])||1,Rl=G.length?O("","Expense Health",`<div style="display:flex;gap:12px;margin-bottom:12px">
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:10px">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Expense Ratio</div>
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:${Xs[2]}">${Q(Qs)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">of revenue  ${Xs[0]} ${Xs[1]}</div>
      </div>
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:10px">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Last 30 Days</div>
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:var(--danger)">${w(P)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">vs ${w(M)} revenue</div>
      </div>
    </div>`+k.map(([h,y])=>`
      <div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between">
          <span style="font-size:12px">${h}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--danger)">${w(y)}</span>
        </div>
        ${D(y,Dl,"var(--danger)")}
      </div>`).join(""),"var(--danger)"):"",_i=d.filter(h=>h.daysListed>=30).reduce((h,y)=>h+(y.item.cost||0)*(y.item.qty||1),0),Zs=d.filter(h=>h.daysListed>=30).length,Bl=Zs>0?O("","Tied-Up Capital",`<div style="margin-bottom:10px">
      <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:22px;color:var(--warn)">${w(_i)}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px">cost basis sitting in ${Zs} item${Zs>1?"s":""} with no sales after 30+ days</div>
    </div>
    <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> Freeing this capital could fund ${Math.floor(_i/Math.max(_.reduce((h,y)=>h+(y.cost||0),0)/_.length,1))} new average-cost items</div>`,"var(--warn)"):"",is=C.filter(h=>{var $;return(h.listPrice||(($=te(h.itemId))==null?void 0:$.price)||0)>0});let os=0,Si=0,as=0,ki=0;for(const h of is){const y=h.listPrice||((zi=te(h.itemId))==null?void 0:zi.price)||0,$=(h.price-y)/y;ki+=$,$>.01?os++:$<-.01?as++:Si++}const ls=is.length?ki/is.length:0,$i=ls>=0?"var(--good)":ls>-.1?"var(--warn)":"var(--danger)",Ll=is.length>=3?O("","Pricing Accuracy",`<div style="display:flex;gap:10px;margin-bottom:12px">
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:22px;color:${$i}">${ls>=0?"+":""}${Q(ls)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">avg vs list price</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <div style="flex:1;text-align:center;padding:8px;background:rgba(87,255,154,0.06);border:1px solid rgba(87,255,154,0.15)">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--good)">${os}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px">ABOVE LIST</div>
      </div>
      <div style="flex:1;text-align:center;padding:8px;background:rgba(87,200,255,0.06);border:1px solid rgba(87,200,255,0.15)">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--accent)">${Si}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px">AT LIST</div>
      </div>
      <div style="flex:1;text-align:center;padding:8px;background:rgba(255,71,87,0.06);border:1px solid rgba(255,71,87,0.15)">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--danger)">${as}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px">BELOW LIST</div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> ${as>os?"You often sell below listing  try starting higher or negotiating less":os>as?"Great job  you consistently meet or exceed your asking price":"Your pricing is well calibrated to market expectations"}</div>`,$i):"",er={"< 7 days":0,"1-2 weeks":0,"2-4 weeks":0,"1-2 months":0,"2-3 months":0,"3+ months":0},Ei={"< 7 days":0,"1-2 weeks":0,"2-4 weeks":0,"1-2 months":0,"2-3 months":0,"3+ months":0};for(const h of _){const y=h.qty!=null?h.qty:1;if(y<=0)continue;const $=h.added?Math.floor((e-new Date(h.added))/n):0,U=$<7?"< 7 days":$<14?"1-2 weeks":$<30?"2-4 weeks":$<60?"1-2 months":$<90?"2-3 months":"3+ months";er[U]+=y||1,Ei[U]+=(h.cost||0)*(y||1)}const Ml=Math.max(...Object.values(er),1),jl={"< 7 days":"var(--good)","1-2 weeks":"var(--good)","2-4 weeks":"var(--accent)","1-2 months":"var(--warn)","2-3 months":"var(--accent2)","3+ months":"var(--danger)"},Gt=_.filter(h=>(h.qty!=null?h.qty:1)>0).length,zl=Gt>=1?O("","Inventory Age Distribution",`<div style="font-size:10px;color:var(--muted);margin-bottom:10px">${Gt} items in stock</div>`+Object.entries(er).filter(([,h])=>h>0).map(([h,y])=>`<div style="padding:4px 0">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px">${h}</span>
        <span style="font-size:11px;font-family:'DM Mono',monospace"><span style="font-weight:700">${y}</span> units  ${w(Ei[h])}</span>
      </div>
      ${D(y,Ml,jl[h])}
    </div>`).join(""),"var(--accent)"):"",kt={};for(const h of _){const y=h.qty!=null?h.qty:1;if(y<=0)continue;const $=h.category||"Uncategorized";kt[$]||(kt[$]={cost:0,retail:0,units:0,items:0}),kt[$].cost+=(h.cost||0)*(y||1),kt[$].retail+=(h.price||0)*(y||1),kt[$].units+=y||1,kt[$].items++}const tr=Object.entries(kt).sort((h,y)=>y[1].cost-h[1].cost).slice(0,6),Nl=((Ui=(Ni=tr[0])==null?void 0:Ni[1])==null?void 0:Ui.cost)||1,Ii=_.filter(h=>(h.qty!=null?h.qty:1)>0).reduce((h,y)=>{const $=y.qty!=null?y.qty:1;return h+(y.cost||0)*$},0),Ti=_.filter(h=>(h.qty!=null?h.qty:1)>0).reduce((h,y)=>{const $=y.qty!=null?y.qty:1;return h+(y.price||0)*$},0),Ci=Ti-Ii,Ul=tr.length>=1?O("","Capital Invested by Category",`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      <div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Invested</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--warn)">${w(Ii)}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">List Value</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--accent)">${w(Ti)}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Potential</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:${Ci>=0?"var(--good)":"var(--danger)"}">${w(Ci)}</div>
      </div>
    </div>`+tr.map(([h,y])=>{const $=y.cost>0?(y.retail-y.cost)/y.cost:0;return`<div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px;font-weight:600">${x(h)}</span>
          <span style="font-size:11px;font-family:'DM Mono',monospace;color:var(--warn);font-weight:700">${w(y.cost)}</span>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:1px">${y.items} item${y.items!==1?"s":""}  ${y.units} unit${y.units!==1?"s":""}  ${w(y.retail)} list  ${Q($)} potential ROI</div>
        ${D(y.cost,Nl,"var(--warn)")}
      </div>`}).join(""),"var(--warn)"):"",$t={noPhoto:_.filter(h=>(h.qty!=null?h.qty:1)>0&&(!h.images||!h.images.length)),noPrice:_.filter(h=>(h.qty!=null?h.qty:1)>0&&!h.price),noPlatform:_.filter(h=>{if((h.qty!=null?h.qty:1)<=0)return!1;const y=X(h);return!y.length||y.length===1&&(y[0]==="Unlisted"||y[0]==="Other")}),noCost:_.filter(h=>(h.qty!=null?h.qty:1)>0&&!h.cost),noCategory:_.filter(h=>(h.qty!=null?h.qty:1)>0&&!h.category),noCondition:_.filter(h=>(h.qty!=null?h.qty:1)>0&&!h.condition)},nr=Object.values($t).reduce((h,y)=>h+y.length,0),Kt=(h,y,$,U)=>$.length?`<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
    <span style="font-size:14px">${h}</span>
    <div style="flex:1">
      <div style="font-size:12px;font-weight:600;color:${U}">${$.length} item${$.length!==1?"s":""} ${y}</div>
      <div style="font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px">${$.slice(0,3).map(F=>x(F.name)).join(", ")}${$.length>3?"...":""}</div>
    </div>
  </div>`:"",ql=Kt("","missing photos",$t.noPhoto,"var(--accent2)")+Kt("","missing price",$t.noPrice,"var(--danger)")+Kt("","not listed on any platform",$t.noPlatform,"var(--warn)")+Kt("","missing cost (can't track profit)",$t.noCost,"var(--warn)")+Kt("","missing category",$t.noCategory,"var(--muted)")+Kt("","missing condition",$t.noCondition,"var(--muted)"),Pi=Gt>0&&!nr,Fl=Gt>0?O("","Listing Readiness",Pi?`<div style="text-align:center;padding:12px 0">
          <div style="font-size:28px;margin-bottom:6px"></div>
          <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--good)">All items fully set up!</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Every item has photos, pricing, platforms, and more</div>
        </div>`:`<div style="font-size:10px;color:var(--muted);margin-bottom:8px">${nr} thing${nr!==1?"s":""} to fix across ${Gt} in-stock items</div>`+ql+`<div style="margin-top:10px;font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> Complete items sell faster  fill in the gaps to boost your sell-through</div>`,Pi?"var(--good)":"var(--accent2)"):"",Et={};for(const h of _){const y=h.qty!=null?h.qty:1;if(y<=0)continue;const $=h.source||"";$&&(Et[$]||(Et[$]={cost:0,retail:0,items:0,units:0}),Et[$].cost+=(h.cost||0)*(y||1),Et[$].retail+=(h.price||0)*(y||1),Et[$].items++,Et[$].units+=y||1)}const sr=Object.entries(Et).sort((h,y)=>y[1].cost-h[1].cost).slice(0,5),Hl=((Fi=(qi=sr[0])==null?void 0:qi[1])==null?void 0:Fi.cost)||1,Wl=sr.length>=1?O("","Where Your Money Goes  by Source",sr.map(([h,y])=>{const $=y.cost>0?(y.retail-y.cost)/y.cost:0;return`<div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px;font-weight:600"> ${x(h)}</span>
          <span style="font-size:11px;font-family:'DM Mono',monospace;font-weight:700;color:var(--accent2)">${w(y.cost)}</span>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:1px">${y.items} item${y.items!==1?"s":""}  ${y.units} unit${y.units!==1?"s":""}  ${w(y.retail)} list value  ${Q($)} potential ROI</div>
        ${D(y.cost,Hl,"var(--accent2)")}
      </div>`}).join(""),"var(--accent2)"):"";t.innerHTML=`
    <div style="padding:0 0 24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:20px">Insights</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">Based on ${_.length} items  ${C.length} sales  ${G.length} expenses</div>
        </div>
        <div style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">Updated ${new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}</div>
      </div>
      ${Se}
      ${$l}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          ${Fl}
          ${ss}
          ${Gs}
          ${Ks}
          ${Bl}
          ${El}
          ${zl}
        </div>
        <div>
          ${Ul}
          ${gl}
          ${bl}
          ${_l}
          ${Tl}
          ${Pl}
          ${Ol}
          ${Wl}
          ${Ll}
          ${Rl}
        </div>
      </div>
      ${!c.length&&!f.length&&!Gt?`<div style="text-align:center;color:var(--muted);font-size:13px;padding:40px 0;font-family:'DM Mono',monospace">Add some inventory items to start seeing insights </div>`:""}
    </div>`,t.innerHTML}let Dt="",ln="",cn="";function Th(t){Dt=(t||"").toLowerCase(),xt()}function Ch(t){ln=t||"",xt()}function Ph(t){cn=t||"",xt()}function Ah(){Dt="",ln="",cn="",xt()}const Oh={"Shipping Supplies":"exp-shipping","Packaging Materials":"exp-packaging","Platform Fees":"exp-fees",Sourcing:"exp-sourcing",Storage:"exp-storage",Printing:"exp-printing",Software:"exp-software",Marketing:"exp-marketing",Returns:"exp-returns","Office Supplies":"exp-office",Other:"exp-other"};function ja(){const t=document.getElementById("exp_date");t&&!t.value&&(t.value=new Date().toISOString().split("T")[0])}function Dh(){const t=document.getElementById("exp_date").value,e=document.getElementById("exp_cat").value,n=document.getElementById("exp_desc").value.trim(),s=document.getElementById("exp_amt"),r=oe(s.value,{allowZero:!1});if(isNaN(r)&&s.value.trim()!==""){Te(s,{fieldName:"Amount"});return}if(!t){E("Please enter a date",!0);return}if(!n){E("Please enter a description",!0);return}if(!r||r<=0){E("Please enter a valid amount",!0);return}G.push({id:Fe(),date:t,category:e,description:n,amount:r}),H(),xt(),document.getElementById("exp_desc").value="",document.getElementById("exp_amt").value="",Ds.expense(),E("Expense added ")}async function Rh(t){if(!confirm("Delete this expense?"))return;const e=G.findIndex(n=>n.id===t);e>=0&&G.splice(e,1),H(),xt(),E("Expense deleted"),await Jn("ft_expenses",[t]),gn()}function xt(){var a;const t=((a=document.getElementById("expCatFilt"))==null?void 0:a.value)||"all",e=document.getElementById("expBody"),n=document.getElementById("expEmpty"),s=document.getElementById("expTotalLbl"),r=[...G].filter(l=>t==="all"||l.category===t).filter(l=>!Dt||(l.description||"").toLowerCase().includes(Dt)||(l.category||"").toLowerCase().includes(Dt)).filter(l=>!ln||l.date>=ln).filter(l=>!cn||l.date<=cn).sort((l,c)=>new Date(c.date)-new Date(l.date)),i=r.reduce((l,c)=>l+(c.amount||0),0);s&&(s.textContent=`${r.length} expense${r.length!==1?"s":""}  ${w(i)}`);const o=document.getElementById("expFilterBar");if(o&&(o.innerHTML=`<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 0">
      <input type="text" placeholder="Search expenses..." value="${x(Dt)}"
             oninput="setExpSearch(this.value)"
             style="flex:1;min-width:150px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;font-family:'DM Mono',monospace">
      <input type="date" value="${ln}" onchange="setExpDateFrom(this.value)" title="From date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      <span style="color:var(--muted);font-size:11px">to</span>
      <input type="date" value="${cn}" onchange="setExpDateTo(this.value)" title="To date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      ${Dt||ln||cn?`<button onclick="clearExpFilters()" style="padding:5px 10px;background:var(--surface);border:1px solid var(--border);color:var(--danger);font-size:11px;cursor:pointer;font-family:'DM Mono',monospace">Clear</button>`:""}
    </div>`),!r.length){e&&(e.innerHTML=""),n&&(n.style.display="block");return}n&&(n.style.display="none"),e.innerHTML=r.map(l=>{const c=Oh[l.category]||"exp-other",d=x(l.description),u=l.description.replace(/"/g,"&quot;");return`<tr>
      <td style="color:var(--muted);font-size:11px">${me(l.date)}</td>
      <td title="${u}"><span class="exp-cat-badge ${c}">${l.category}</span><span class="exp-desc-mobile">  ${d}</span></td>
      <td title="${u}">${d}</td>
      <td style="text-align:right;font-family:'DM Mono',monospace;font-weight:600;color:var(--danger)">
        ${w(l.amount)}&nbsp;<button class="act-btn red exp-del-mobile" onclick="delExpense('${l.id}')" style="margin-left:4px;vertical-align:middle"></button>
      </td>
      <td style="text-align:right"><button class="act-btn red exp-del-desktop" onclick="delExpense('${l.id}')"></button></td>
    </tr>`}).join("")}let _o="monthly",Bh=0;const So={"Shipping Supplies":"exp-shipping","Packaging Materials":"exp-packaging","Platform Fees":"exp-fees",Sourcing:"exp-sourcing",Storage:"exp-storage",Printing:"exp-printing",Software:"exp-software",Marketing:"exp-marketing",Returns:"exp-returns","Office Supplies":"exp-office",Other:"exp-other"};function Lh(){const t=document.getElementById("reportsContent");if(!t)return;const{start:e,end:n,label:s}=Mh(_o,Bh),r=C.filter(T=>{const I=new Date(T.date);return I>=e&&I<=n}),i=G.filter(T=>{const I=new Date(T.date);return I>=e&&I<=n});let o=0,a=0,l=0;for(const T of r){const I=_.find(j=>j.id===T.itemId);o+=(T.price||0)*(T.qty||0),a+=I?(I.cost||0)*(T.qty||0):0,l+=(T.fees||0)+(T.ship||0)}const c=o-a-l,d=i.reduce((T,I)=>T+(I.amount||0),0),u=c-d,p=o?u/o:0,f={};for(const T of i)f[T.category]=(f[T.category]||0)+T.amount;const m=jh(_o,e,n),v=`
    <div class="period-summary-grid">
      <div class="period-card">
        <div class="period-card-lbl">Revenue</div>
        <div class="period-card-val" style="color:var(--accent)">${w(o)}</div>
        <div class="period-card-sub">${r.length} sale${r.length!==1?"s":""}</div>
      </div>
      <div class="period-card">
        <div class="period-card-lbl">COGS + Fees</div>
        <div class="period-card-val" style="color:var(--warn)">${w(a+l)}</div>
        <div class="period-card-sub">cost of goods + platform fees</div>
      </div>
      <div class="period-card">
        <div class="period-card-lbl">Gross Profit</div>
        <div class="period-card-val" style="color:${c>=0?"var(--good)":"var(--danger)"}">${w(c)}</div>
        <div class="period-card-sub">before overhead expenses</div>
      </div>
      <div class="period-card">
        <div class="period-card-lbl">Expenses</div>
        <div class="period-card-val" style="color:var(--danger)">${w(d)}</div>
        <div class="period-card-sub">${i.length} expense${i.length!==1?"s":""}</div>
      </div>
      <div class="period-card" style="border-color:${u>=0?"var(--good)":"var(--danger)"}">
        <div class="period-card-lbl">Net Profit</div>
        <div class="period-card-val" style="color:${u>=0?"var(--good)":"var(--danger)"},font-size:22px">${w(u)}</div>
        <div class="period-card-sub">margin: ${(p*100).toFixed(1)}%</div>
      </div>
    </div>`,g={};for(const T of r){const I=_.find(Se=>Se.id===T.itemId),j=I?I.category||"Uncategorized":"Unknown";g[j]||(g[j]={revenue:0,cogs:0,fees:0,profit:0,count:0});const Z=(T.price||0)*(T.qty||0),L=I?(I.cost||0)*(T.qty||0):0,V=(T.fees||0)+(T.ship||0);g[j].revenue+=Z,g[j].cogs+=L,g[j].fees+=V,g[j].profit+=Z-L-V,g[j].count++}const b=Object.entries(g).sort((T,I)=>I[1].profit-T[1].profit).map(([T,I])=>{const j=I.revenue>0?I.profit/I.revenue*100:0,Z=j>=20?"var(--good)":j>=10?"var(--warn)":"var(--danger)",L=I.profit>=0?"var(--good)":"var(--danger)";return`<tr>
      <td style="font-weight:600">${x(T)}</td>
      <td style="text-align:center">${I.count}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--accent)">${w(I.revenue)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--muted)">${w(I.cogs)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--danger)">${w(I.fees)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:700;color:${L}">${w(I.profit)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:600;color:${Z}">${j.toFixed(1)}%</td>
    </tr>`}).join(""),S=Object.entries(g).length?`
    <div class="period-section-ttl">Profit by Category</div>
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table">
        <thead><tr>
          <th>Category</th><th>Sales</th><th>Revenue</th><th>COGS</th><th>Fees</th><th>Profit</th><th>Margin</th>
        </tr></thead>
        <tbody>${b}</tbody>
      </table>
    </div>`:"",k={};for(const T of r){const I=T.platform||"Unknown";k[I]||(k[I]={revenue:0,cogs:0,fees:0,profit:0,count:0});const j=_.find(Se=>Se.id===T.itemId),Z=(T.price||0)*(T.qty||0),L=j?(j.cost||0)*(T.qty||0):0,V=(T.fees||0)+(T.ship||0);k[I].revenue+=Z,k[I].cogs+=L,k[I].fees+=V,k[I].profit+=Z-L-V,k[I].count++}const P=Object.entries(k).sort((T,I)=>I[1].profit-T[1].profit).map(([T,I])=>{const j=I.revenue>0?I.profit/I.revenue*100:0,Z=j>=20?"var(--good)":j>=10?"var(--warn)":"var(--danger)",L=I.profit>=0?"var(--good)":"var(--danger)";return`<tr>
      <td style="font-weight:600">${x(T)}</td>
      <td style="text-align:center">${I.count}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--accent)">${w(I.revenue)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--muted)">${w(I.cogs)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--danger)">${w(I.fees)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:700;color:${L}">${w(I.profit)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:600;color:${Z}">${j.toFixed(1)}%</td>
    </tr>`}).join(""),M=Object.entries(k).length?`
    <div class="period-section-ttl">Profit by Platform</div>
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table">
        <thead><tr>
          <th>Platform</th><th>Sales</th><th>Revenue</th><th>COGS</th><th>Fees</th><th>Profit</th><th>Margin</th>
        </tr></thead>
        <tbody>${P}</tbody>
      </table>
    </div>`:"",D=Object.entries(f).length?`
    <div class="period-section-ttl">Expense Breakdown</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-bottom:16px">
      ${Object.entries(f).sort((T,I)=>I[1]-T[1]).map(([T,I])=>{const j=So[T]||"exp-other",Z=d?(I/d*100).toFixed(0):0;return`<div class="period-card" style="flex-direction:row;display:flex;align-items:center;gap:10px;padding:10px 12px">
          <span class="exp-cat-badge ${j}" style="font-size:8px">${T}</span>
          <span style="font-family:'DM Mono',monospace;font-weight:700;font-size:13px;margin-left:auto">${w(I)}</span>
          <span style="font-size:9px;color:var(--muted)">${Z}%</span>
        </div>`}).join("")}
    </div>`:"",q=m.length?`
    <div class="period-section-ttl">Week by Week</div>
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table">
        <thead><tr>
          <th>Week</th>
          <th>Sales</th><th>Revenue</th><th>COGS+Fees</th>
          <th>Expenses</th><th>Gross</th><th>Net</th>
        </tr></thead>
        <tbody>${m}</tbody>
      </table>
    </div>`:"",O=r.length?`
    <div class="period-section-ttl">Sales This Period (${r.length})</div>
    <div style="overflow-x:auto">
      <table class="inv-table">
        <thead><tr><th>Item</th><th>Date</th><th>Qty</th><th>Price</th><th>Net Profit</th></tr></thead>
        <tbody>${[...r].sort((T,I)=>new Date(I.date)-new Date(T.date)).map(T=>{const I=te(T.itemId),j=(T.price||0)*(T.qty||0)-(I?(I.cost||0)*(T.qty||0):0)-(T.fees||0)-(T.ship||0);return`<tr>
            <td><div class="item-name" style="cursor:${I?"pointer":"default"}" ${I?`onclick="openDrawer('${x(I.id)}')"`:""}>${I?x(I.name):"Deleted Item"}</div></td>
            <td style="color:var(--muted);font-size:11px">${me(T.date)}</td>
            <td>${T.qty}</td>
            <td>${w(T.price)}</td>
            <td style="font-weight:700;color:${j>=0?"var(--good)":"var(--danger)"}">${w(j)}</td>
          </tr>`}).join("")}</tbody>
      </table>
    </div>`:'<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">No sales in this period.</div>',W=i.length?`
    <div class="period-section-ttl" style="margin-top:20px">Expenses This Period (${i.length})</div>
    <div style="overflow-x:auto">
      <table class="inv-table">
        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>${[...i].sort((T,I)=>new Date(I.date)-new Date(T.date)).map(T=>{const I=So[T.category]||"exp-other";return`<tr>
            <td style="color:var(--muted);font-size:11px">${me(T.date)}</td>
            <td><span class="exp-cat-badge ${I}">${T.category}</span></td>
            <td>${x(T.description)}</td>
            <td style="text-align:right;font-family:'DM Mono',monospace;font-weight:600;color:var(--danger)">${w(T.amount)}</td>
          </tr>`}).join("")}</tbody>
      </table>
    </div>`:"";t.innerHTML=`
    <div class="panel" style="animation:none">
      <div class="panel-header" style="margin-bottom:0">
        <div class="panel-title">Reports</div>
        <button class="btn-secondary" style="font-size:11px" onclick="goToAddExpense()">+ Add Expense</button>
      </div>

      <!-- Mode tabs -->
      <div class="report-tabs" style="margin-top:14px">
        <button class="report-tab "  onclick="setReportMode('weekly')">Weekly</button>
        <button class="report-tab active" onclick="setReportMode('monthly')">Monthly</button>
        <button class="report-tab" id="plTabBtn" onclick="showPLReport()">P&amp;L Statement</button>
      </div>

      <!-- Period nav -->
      <div class="period-nav">
        <button class="period-nav-btn" onclick="shiftPeriod(-1)"> Prev</button>
        <div class="period-label">${s}</div>
        <button class="period-nav-btn" onclick="shiftPeriod(1)" disabled style="opacity:0.3;cursor:default">Next </button>
      </div>

      ${v}
      ${S}
      ${M}
      ${D}
      ${q}
      ${O}
      ${W}
    </div>
    <div id="plReportContent" style="display:none"></div>`}function Mh(t,e){const n=new Date;let s,r,i;{const o=n.getFullYear(),a=n.getMonth()+e,l=new Date(o,a,1);s=new Date(l.getFullYear(),l.getMonth(),1),r=new Date(l.getFullYear(),l.getMonth()+1,0,23,59,59),i=s.toLocaleString("default",{month:"long",year:"numeric"})}return{start:s,end:r,label:i}}function jh(t,e,n){{const s=[];let r=new Date(e);for(r.setHours(0,0,0,0);r<=n;){let i=new Date(r);i.setDate(r.getDate()+6),i.setHours(23,59,59,999);const o=i>n?new Date(n):i,a=C.filter(g=>{const b=new Date(g.date);return b>=r&&b<=o}),l=G.filter(g=>{const b=new Date(g.date);return b>=r&&b<=o});let c=0,d=0,u=0;for(const g of a){const b=te(g.itemId);c+=(g.price||0)*(g.qty||0),d+=b?(b.cost||0)*(g.qty||0):0,u+=(g.fees||0)+(g.ship||0)}const p=c-d-u,f=l.reduce((g,b)=>g+(b.amount||0),0),m=p-f,v=`${r.toLocaleDateString("en-US",{month:"short",day:"numeric"})}${o.toLocaleDateString("en-US",{day:"numeric"})}`;if(s.push(`<tr>
        <td style="font-size:11px;color:var(--muted)">${v}</td>
        <td>${a.length}</td>
        <td>${w(c)}</td>
        <td style="color:var(--muted)">${w(d+u)}</td>
        <td style="color:var(--danger)">${f>0?w(f):""}</td>
        <td style="color:${p>=0?"var(--good)":"var(--danger)"}">${w(p)}</td>
        <td style="font-weight:700;color:${m>=0?"var(--good)":"var(--danger)"}">${w(m)}</td>
      </tr>`),r=new Date(i),r.setDate(i.getDate()+1),r.setHours(0,0,0,0),s.length>8)break}return s.join("")}}async function zh(t){if(!confirm("Remove this sale? Stock will be restored."))return;const e=C.find(n=>n.id===t);if(e){const n=te(e.itemId);n&&(n.qty+=e.qty||0)}C=C.filter(n=>n.id!==t),H(),J(),renderSalesView(),E("Sale removed, stock restored"),await Jn("ft_sales",[t]),gn()}async function Nh(t){const e=_.find(n=>n.id===t);confirm(`Delete "${e==null?void 0:e.name}"?`)&&(softDeleteItem(t),sel.delete(t),H(),J(),E("Item deleted  check  to restore"),await Jn("ft_inventory",[t]),gn())}function Uh(){const t=document.getElementById("breakdownContent");if(!_.length){t.innerHTML='<div class="bd-empty"> No inventory yet. Add items to see your breakdown.</div>';return}const e=_.reduce((v,g)=>v+(g.price||0)*(g.qty||0),0),n=_.reduce((v,g)=>v+(g.qty||0),0),s=_.length,r=_.reduce((v,g)=>v+(g.cost||0)*(g.qty||0),0),i=_.reduce((v,g)=>{const{pu:b}=qt(g);return v+b*(g.qty||0)},0),o=e?i/e:0,a=new Map;_.forEach(v=>{const g=(v.category||"").trim();if(g){const b=g.toLowerCase();a.has(b)||a.set(b,g)}});const l=v=>a.get((v||"").toLowerCase())||v||d,c={},d="(Uncategorized)";for(const v of _){const g=v.category?l(v.category):d,b=v.subcategory||"",{pu:S}=qt(v),k=(v.price||0)*(v.qty||0),P=(v.cost||0)*(v.qty||0),M=S*(v.qty||0);c[g]||(c[g]={value:0,units:0,items:0,cost:0,profit:0,subs:{}}),c[g].value+=k,c[g].units+=v.qty||0,c[g].items+=1,c[g].cost+=P,c[g].profit+=M,b&&(c[g].subs[b]||(c[g].subs[b]={value:0,units:0,items:0,cost:0,profit:0}),c[g].subs[b].value+=k,c[g].subs[b].units+=v.qty||0,c[g].subs[b].items+=1,c[g].subs[b].cost+=P,c[g].subs[b].profit+=M)}const u=Object.entries(c).sort((v,g)=>g[1].value-v[1].value),p=`<div class="bd-col-headers">
    <div></div>
    <div class="bd-col-hdr" style="text-align:left">Category</div>
    <div class="bd-col-hdr">Value</div>
    <div class="bd-col-hdr">Cost Basis</div>
    <div class="bd-col-hdr">Units</div>
    <div class="bd-col-hdr">Items</div>
    <div class="bd-col-hdr">Avg Margin</div>
  </div>`,f=["#57c8ff","#ff6b35","#7b61ff","#57ff9a","#ffb800","#00bcff","#ff4757","#3cb371"],m=u.map(([v,g],b)=>{const S=e?(g.value/e*100).toFixed(1):0,k=g.value?g.profit/g.value:0,P=f[b%f.length],M=Object.keys(g.subs).length>0,D=M?Object.entries(g.subs).sort((q,O)=>O[1].value-q[1].value).map(([q,O])=>{const W=O.value?O.profit/O.value:0;return`<div class="bd-sub-row" onclick="filterToSubcat('${v.replace(/'/g,"\\'")}','${q.replace(/'/g,"\\'")}')">
              <div></div>
              <div>
                <div class="bd-sub-name clickable"> ${x(q)}</div>
                <div style="font-size:9px;color:var(--muted);margin-top:2px">${O.items} item${O.items!==1?"s":""}</div>
                <div class="bd-mobile-stats">
                  <span>${w(O.cost)} cost</span>
                  <span>${O.units} units</span>
                  <span class="margin-badge ${Lt(W)}">${Q(W)}</span>
                </div>
              </div>
              <div class="bd-col-val">${w(O.value)}</div>
              <div class="bd-col-val" style="color:var(--muted)">${w(O.cost)}</div>
              <div class="bd-col-units">${O.units}</div>
              <div class="bd-col-units">${O.items}</div>
              <div class="bd-col-m"><span class="margin-badge ${Lt(W)}">${Q(W)}</span></div>
            </div>`}).join(""):"";return`<div class="bd-cat-block">
      <div class="bd-cat-row ${M?"has-subs":""}" onclick="${M?`toggleBdSubs('bdsub-${b}')`:`filterToCat('${v.replace(/'/g,"\\'")}')`}">
        <div class="bd-cat-chevron${M?" open-ready":""}">
          ${M?"":""}
        </div>
        <div>
          <div class="bd-cat-name">${x(v)}</div>
          <div class="bd-cat-bar-wrap" style="width:120px">
            <div class="bd-cat-bar-fill" style="width:${S}%;background:${P}"></div>
          </div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">${S}% of total value  ${g.items} item${g.items!==1?"s":""}</div>
          <div class="bd-mobile-stats">
            <span>${w(g.cost)} cost</span>
            <span>${g.units} units</span>
            <span class="margin-badge ${Lt(k)}">${Q(k)}</span>
          </div>
        </div>
        <div class="bd-col-val" style="color:${P}">${w(g.value)}</div>
        <div class="bd-col-val" style="color:var(--muted)">${w(g.cost)}</div>
        <div class="bd-col-units">${g.units}</div>
        <div class="bd-col-units">${g.items}</div>
        <div class="bd-col-m"><span class="margin-badge ${Lt(k)}">${Q(k)}</span></div>
      </div>
      ${M?`<div class="bd-sub-table" id="bdsub-${b}">${D}</div>`:""}
    </div>`}).join("");t.innerHTML=`
    <div class="panel" style="animation:none;margin-bottom:16px">
      <div class="breakdown-header">
        <div>
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px">Total Inventory Value</div>
          <div class="breakdown-total">${w(e)}</div>
          <div class="breakdown-sub">${s} items  ${n} units in stock  avg ${Q(o)} margin</div>
        </div>
        <button class="btn-secondary" onclick="goToBreakdown()" style="font-size:11px"> Refresh</button>
      </div>
      <div class="bd-summary-grid">
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Total Value</div>
          <div class="bd-sum-val" style="color:var(--accent)">${w(e)}</div>
          <div class="bd-sum-sub">${n} units @ list price</div>
        </div>
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Cost Basis</div>
          <div class="bd-sum-val" style="color:var(--warn)">${w(r)}</div>
          <div class="bd-sum-sub">Total invested</div>
        </div>
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Potential Profit</div>
          <div class="bd-sum-val" style="color:var(--good)">${w(i)}</div>
          <div class="bd-sum-sub">If all sold at list price</div>
        </div>
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Categories</div>
          <div class="bd-sum-val">${u.length}</div>
          <div class="bd-sum-sub">across ${s} items</div>
        </div>
      </div>
    </div>
    <div class="panel" style="animation:none">
      <div class="panel-header">
        <div class="panel-title">By Category</div>
        <span style="font-size:10px;color:var(--muted)">Click a category to filter inventory  click  subcategory to drill down</span>
      </div>
      ${p}
      ${m}
    </div>`,t.innerHTML}function Hs(){localStorage.setItem("ft_supplies",JSON.stringify(supplies)),qh()}async function qh(){if(!(!_sb||!_currentUser))try{const t=_currentUser.id,e=supplies.map(n=>({id:n.id,account_id:t,data:n}));await _sb.from("ft_supplies").upsert(e,{onConflict:"id"})}catch{}}function Fh(){const t=document.getElementById("sup_name").value.trim();if(!t){toast("Supply name required",!0);return}const e=parseInt(document.getElementById("sup_qty").value)||0,n=parseInt(document.getElementById("sup_alert").value)||5;supplies.push({id:uid(),name:t,category:document.getElementById("sup_cat").value,qty:e,cost:parseFloat(document.getElementById("sup_cost").value)||0,alert:n,notes:document.getElementById("sup_notes").value.trim(),added:new Date().toISOString()}),["sup_name","sup_qty","sup_cost","sup_alert","sup_notes"].forEach(s=>{const r=document.getElementById(s);r&&(r.value="")}),document.getElementById("sup_cat").value="Boxes",Hs(),es(),toast("Supply added ")}function Hh(t,e){const n=supplies.find(s=>s.id===t);n&&(n.qty=Math.max(0,(n.qty||0)+e),Hs(),es())}function Wh(t,e){const n=supplies.find(s=>s.id===t);n&&(n.qty=Math.max(0,parseInt(e)||0),Hs(),za())}function Vh(t){supplies=supplies.filter(e=>e.id!==t),Hs(),es(),toast("Removed ")}function es(){const t=document.getElementById("supBody"),e=document.getElementById("supEmpty"),n=document.getElementById("supLowBadge");if(!t)return;const s=supplies.filter(r=>r.qty<=(r.alert||5)).length;if(n&&(n.style.display=s?"":"none"),!supplies.length){t.innerHTML="",e.style.display="block";return}e.style.display="none",t.innerHTML=supplies.map(r=>{const i=r.qty<=(r.alert||5),o=r.qty===0?"color:#ff6b6b;font-weight:700":i?"color:#ffaa33;font-weight:700":"",a=i?`<span style="font-size:9px;background:rgba(255,107,107,0.15);color:#ff6b6b;padding:1px 6px;font-family:'DM Mono',monospace;margin-left:6px">LOW</span>`:"";return`<tr>
      <td><div class="item-name">${r.name}${a}</div></td>
      <td><span class="cat-tag">${r.category||"Other"}</span></td>
      <td style="${o}">
        <div style="display:flex;align-items:center;gap:6px">
          <button onclick="updateSupplyQty('${r.id}',-1)" style="background:var(--surface3);border:1px solid var(--border);color:var(--text);width:22px;height:22px;cursor:pointer;font-size:14px;line-height:1;padding:0"></button>
          <input type="number" value="${r.qty}" min="0" onchange="setSupplyQty('${r.id}',this.value)"
            style="width:52px;text-align:center;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:3px 4px">
          <button onclick="updateSupplyQty('${r.id}',1)" style="background:var(--surface3);border:1px solid var(--border);color:var(--text);width:22px;height:22px;cursor:pointer;font-size:14px;line-height:1;padding:0">+</button>
        </div>
      </td>
      <td style="color:var(--muted);font-size:12px">${r.cost?fmt(r.cost):""}</td>
      <td style="color:var(--muted);font-size:12px">${r.alert||5}</td>
      <td style="color:var(--muted);font-size:11px">${r.notes||""}</td>
      <td style="text-align:right"><button class="btn-danger" style="font-size:11px;padding:4px 10px" onclick="delSupply('${r.id}')">Remove</button></td>
    </tr>`}).join("")}function za(){const t=supplies.filter(n=>n.qty<=(n.alert||5)&&n.qty>=0);if(!t.length)return;const e=t.map(n=>`${n.name} (${n.qty} left)`).join(", ");toast(` Low stock: ${e}`,!0,5e3)}function Gh(){const t=_.find(e=>e.id===Qu);t&&(Na(t.id),qs())}function Na(t){const e=_.find(a=>a.id===t);if(!e)return;const n=Fe(),s=new Date().toISOString().slice(0,10).replace(/-/g,""),r=(e.category||"GEN").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,4).padEnd(3,"X"),i=Math.random().toString(36).slice(2,5).toUpperCase(),o={...JSON.parse(JSON.stringify(e)),id:n,sku:r+"-"+s+"-"+i,added:new Date().toISOString(),platformStatus:{}};_.push(o),H(),J(),Ds.create(),E("Duplicated: "+o.name+" "),gn()}function Ua(t,e){document.querySelectorAll(".add-form-tab").forEach(c=>{c.style.color="var(--muted)",c.style.borderBottomColor="transparent",c.classList.remove("active")}),e&&(e.style.color="var(--accent)",e.style.borderBottomColor="var(--accent)",e.classList.add("active"));const n=["f_name","f_sku","f_upc","f_cat","f_source","f_subcat_txt","f_subtype","f_plat_picker","f_bulk","f_qty","f_alert"].map(c=>document.getElementById(c)),s=["f_cost","f_price","f_fees","f_ship","f_condition"].map(c=>document.getElementById(c)),r=["f_notes","f_book_fields","fImgWrap"].map(c=>document.getElementById(c)),i=c=>{if(c){const d=c.closest(".fgrp")||c.closest(".full")||c;d.style.display=""}},o=c=>{if(c){const d=c.closest(".fgrp")||c.closest(".full")||c;d.style.display="none"}},a=document.querySelector(".profit-prev"),l=document.getElementById("f_dim_section");t==="basic"?(n.forEach(i),s.forEach(o),r.forEach(o),a&&(a.style.display="none"),l&&(l.style.display="none")):t==="pricing"?(n.forEach(o),s.forEach(i),r.forEach(o),a&&(a.style.display=""),l&&(l.style.display="none")):(n.forEach(o),s.forEach(o),r.forEach(i),a&&(a.style.display="none"),l&&(l.style.display=""))}function Kh(){const t=document.getElementById("addOv");t.classList.add("on"),pendingAddImages=[],refreshImgSlots("f",pendingAddImages);const e=t.querySelector(".modal-bd");e&&(e.scrollTop=0);const n=t.querySelector(".modal");n&&(n.scrollTop=0),setTimeout(()=>trapFocus("#addOv .modal"),100),Ua("basic",document.querySelector(".add-form-tab"))}function qa(){releaseFocus(),document.getElementById("addOv").classList.remove("on"),["f_name","f_sku","f_upc","f_cat","f_subcat_txt","f_cost","f_price","f_fees","f_ship","f_notes","f_alert","f_source","f_condition"].forEach(n=>{const s=document.getElementById(n);s&&(s.value="")}),document.getElementById("f_qty").value="1";const t=document.getElementById("f_bulk");t&&(t.checked=!1);const e=document.getElementById("f_bulk_fields");e&&(e.style.display="none"),document.querySelectorAll("#f_cond_picker .cond-tag").forEach(n=>n.classList.remove("active")),fp("f"),ca("f",!1),pendingAddImages=[],refreshImgSlots("f",[]),clearDimForm("f"),buildPlatPicker("f_plat_picker",[]),Fa()}function Jh(t){var n;const e=(n=document.getElementById(t+"_bulk"))==null?void 0:n.checked;if(t==="f"){const s=document.getElementById("f_bulk_fields");s&&(s.style.display=e?"block":"none");const r=document.getElementById("f_qty");!e&&r&&(r.value="1")}if(t==="d"){const s=document.getElementById("d_alert_grp");s&&(s.style.display=e?"":"none")}}function Fa(){const t=parseFloat(document.getElementById("f_cost").value)||0,e=parseFloat(document.getElementById("f_price").value)||0,n=parseFloat(document.getElementById("f_fees").value)||0,s=parseFloat(document.getElementById("f_ship").value)||0,r=e-t-n-s,i=e?r/e:null,o=t?r/t:null;document.getElementById("pp_profit").textContent=e||t?fmt(r):"",document.getElementById("pp_margin").textContent=i!=null?pct(i):"",document.getElementById("pp_roi").textContent=o!=null?pct(o):"",document.getElementById("pp_profit").style.color=r>=0?"var(--good)":"var(--danger)"}function Yh(){const e=[..._].sort((o,a)=>new Date(a.added||0)-new Date(o.added||0))[0];if(!e){E("No items to copy from",!0);return}const n=document.getElementById("f_source");n&&e.source&&(n.value=e.source);const s=document.getElementById("f_cat");s&&e.category&&(s.value=e.category,syncAddSubcat());const r=document.getElementById("f_subcat_txt");r&&e.subcategory&&(r.value=e.subcategory),e.condition&&xa("f",e.condition);const i=getPlatforms(e);i.length&&buildPlatPicker("f_plat_picker",i),Qn("f"),E("Prefilled from: "+e.name)}function Qh(){var T;const t=document.getElementById("f_name").value.trim();if(!t){E("Name required",!0);return}const e=document.getElementById("f_cost"),n=oe(e.value,{});if(isNaN(n)&&e.value.trim()!==""){Te(e,{fieldName:"Cost"});return}const s=document.getElementById("f_price"),r=oe(s.value,{});if(isNaN(r)&&s.value.trim()!==""){Te(s,{fieldName:"Price"});return}if(!r){E("Price required",!0);return}const i=document.getElementById("f_fees"),o=oe(i.value,{allowZero:!0});if(isNaN(o)&&i.value.trim()!==""){Te(i,{fieldName:"Fees"});return}const a=document.getElementById("f_ship"),l=oe(a.value,{allowZero:!0});if(isNaN(l)&&a.value.trim()!==""){Te(a,{fieldName:"Shipping"});return}const c=document.getElementById("f_qty"),d=oe(c.value,{integer:!0,min:1}),u=((T=document.getElementById("f_bulk"))==null?void 0:T.checked)||!1,p=u?isNaN(d)?1:d:1,f=document.getElementById("f_alert"),m=oe(f.value,{integer:!0,min:1}),v=u?isNaN(m)?2:m:2,g=normCat(document.getElementById("f_cat").value.trim()),b=new Date().toISOString().slice(0,10).replace(/-/g,""),S=(g||"GEN").trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,4).padEnd(3,"X"),k=Math.random().toString(36).slice(2,5).toUpperCase(),P=S+"-"+b+"-"+k,M=(document.getElementById("f_upc").value||"").trim();if(M){const I=_.find(j=>j.upc===M);if(I&&!confirm(`An item with UPC "${M}" already exists:

"${I.name}" (Qty: ${I.qty})

Add as a new item anyway, or cancel to update the existing one?`)){typeof window.openDrawer=="function"&&window.openDrawer(I.id);return}}const D=getSelectedPlats("f_plat_picker"),q=D[0]||"Other",O=Fe(),W=pendingAddImages.slice();if(_.push({id:O,name:t,sku:document.getElementById("f_sku").value.trim()||P,upc:document.getElementById("f_upc").value.trim()||"",category:g,subcategory:(document.getElementById("f_subcat_txt").value||"").trim(),subtype:document.getElementById("f_subtype").value||"",platform:q,platforms:D,cost:isNaN(n)?0:n,price:r,qty:p,bulk:u,fees:isNaN(o)?0:o,ship:isNaN(l)?0:l,lowAlert:v,notes:document.getElementById("f_notes").value.trim(),source:document.getElementById("f_source").value.trim(),condition:document.getElementById("f_condition").value.trim(),images:W,image:W[0]||null,...getDimsFromForm("f"),...Yn(g)?ua("f"):{},added:new Date().toISOString()}),H(),qa(),J(),Ds.create(),E("Item added "),W.length&&_sb&&_currentUser){const I=_.find(j=>j.id===O);I&&Promise.all(W.map((j,Z)=>uploadImageToStorage(j,O,Z).catch(L=>(console.warn("FlipTrack: upload failed for slot",Z,L.message),j)))).then(j=>{I.images=j,I.image=j[0]||null,H(),renderInv()})}}let rt=JSON.parse(localStorage.getItem("ft_trash")||"[]");function Xh(){const t=Date.now()-6048e5;rt=rt.filter(e=>e.deletedAt>t).slice(-30);try{localStorage.setItem("ft_trash",JSON.stringify(rt))}catch{}}function Zh(){const t=Date.now()-6048e5;if(rt=rt.filter(n=>n.deletedAt>t),!rt.length){toast("Trash is empty");return}const e=rt.map((n,s)=>{const r=Math.floor((Date.now()-n.deletedAt)/6e4),i=r<60?r+"m ago":r<1440?Math.floor(r/60)+"h ago":Math.floor(r/1440)+"d ago";return`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(n.name)}</div>
        <div style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">${n.sku||""}  ${i}</div>
      </div>
      <button onclick="restoreItem(${s});closeTrashModal()" style="background:none;border:1px solid var(--good);color:var(--good);font-size:10px;padding:4px 10px;cursor:pointer;font-family:'DM Mono',monospace">Restore</button>
    </div>`}).reverse().join("");document.getElementById("trashBody").innerHTML=e,document.getElementById("trashOv").classList.add("on")}function Ha(){document.getElementById("trashOv").classList.remove("on")}function ef(){confirm("Permanently delete all "+rt.length+" items?")&&(rt=[],Xh(),Ha(),toast("Trash emptied"))}function Ws(t){if(document.querySelectorAll(".bnav-btn").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".bnav-more-item").forEach(n=>n.classList.remove("active")),["bn-more-expenses","bn-more-reports","bn-more-breakdown"].includes(t)){const n=document.getElementById("bn-more");n&&n.classList.add("active");const s=document.getElementById(t);s&&s.classList.add("active")}else{const n=document.getElementById(t);n&&n.classList.add("active")}}function tf(t){t.stopPropagation();const e=document.getElementById("bnavMorePopup"),n=document.getElementById("bnavMoreBackdrop"),s=e.classList.toggle("open");e.style.display=s?"block":"none",n.style.display=s?"block":"none"}function nf(){const t=document.getElementById("bnavMorePopup"),e=document.getElementById("bnavMoreBackdrop");t.classList.remove("open"),e.classList.remove("open"),t.style.display="none",e.style.display="none"}function Cs(){const t=document.getElementById("bottomNav");t&&(t.style.display=window.innerWidth<=600?"grid":"none")}Cs();window.addEventListener("resize",Cs);(function(){let t=0,e=0,n=!1;const s=document.getElementById("drawer");s.addEventListener("touchstart",r=>{r.touches[0].clientY-s.getBoundingClientRect().top>60||(t=r.touches[0].clientY,n=!0,s.style.transition="none")},{passive:!0}),s.addEventListener("touchmove",r=>{if(!n)return;e=r.touches[0].clientY;const i=Math.max(0,e-t);s.style.transform=`translateY(${i}px)`},{passive:!0}),s.addEventListener("touchend",()=>{if(!n)return;n=!1,s.style.transition="",e-t>120||(s.style.transform="")})})();document.getElementById("currentDate").textContent=new Date().toLocaleDateString("en-US",{weekday:"short",month:"long",day:"numeric",year:"numeric"});let vr=!1,sf=null;function pn(){const t=document.getElementById("offlineBanner");t&&(navigator.onLine?(t.style.display="none",document.body.style.paddingTop="",vr&&sf&&(vr=!1,E("Back online  syncing"),Kr().catch(()=>{}))):(t.style.display="",document.body.style.paddingTop="28px",vr=!0))}window.addEventListener("online",pn);window.addEventListener("offline",pn);navigator.onLine||pn();let Oe=[];async function Wa(){try{const t=await wt("listing_templates");Array.isArray(t)?Oe=t:Oe=[...ko]}catch{Oe=[...ko]}}async function li(){try{await Ye("listing_templates",Oe)}catch(t){console.warn("FlipTrack: template save failed:",t.message)}}function rf(){return Oe}function Va(t){return t?Oe.filter(e=>!e.category||e.category==="All"||e.category.toLowerCase()===t.toLowerCase()):Oe}function of(t){return Oe.find(e=>e.id===t)||null}function af(t){const e={id:Fe(),name:t.name||"Untitled Template",category:t.category||"All",titleFormula:t.titleFormula||"{name}",descriptionTemplate:t.descriptionTemplate||"",platforms:t.platforms||[],tags:t.tags||[],createdAt:Date.now(),isDefault:!1};return Oe.push(e),li(),e}function lf(t,e){const n=Oe.find(s=>s.id===t);return n?(Object.assign(n,e,{id:t}),li(),n):null}function cf(t){const e=Oe.findIndex(n=>n.id===t);return e===-1?!1:(Oe.splice(e,1),li(),!0)}const ko=[{id:"tpl-clothing",name:"Clothing  Standard",category:"Clothing",titleFormula:"{name} - {condition} - {subcategory}",descriptionTemplate:`{name}

Condition: {condition}
Category: {category} > {subcategory}
{notes}

Ships fast! Bundle and save. Check out my other listings!`,platforms:[],tags:["clothing","apparel"],isDefault:!0},{id:"tpl-books",name:"Books  Standard",category:"Books",titleFormula:"{name} by {author} - {condition}",descriptionTemplate:`{name}
Author: {author}
ISBN: {isbn}
Condition: {condition}

{notes}

Ships in 1-2 business days. Check my store for more titles!`,platforms:[],tags:["books","reading"],isDefault:!0},{id:"tpl-electronics",name:"Electronics  Standard",category:"Electronics",titleFormula:"{name} - {condition} - Tested & Working",descriptionTemplate:`{name}

Condition: {condition}
UPC: {upc}

{notes}

Tested and verified working. Ships securely padded.
Dimensions: {dimensions}
Weight: {weight}`,platforms:[],tags:["electronics","tech"],isDefault:!0},{id:"tpl-general",name:"General  All Categories",category:"All",titleFormula:"{name} - {condition}",descriptionTemplate:`{name}

Condition: {condition}
{notes}

Fast shipping! Bundle discounts available.`,platforms:[],tags:["general"],isDefault:!0},{id:"tpl-ebay-seo",name:"eBay SEO Optimized",category:"All",titleFormula:"{name} {condition} {category} {subcategory} Ships Free",descriptionTemplate:`{name}

 Condition: {condition}
 Category: {category}
 UPC: {upc}

{notes}

 FAST & FREE SHIPPING 
 30-DAY RETURNS 
 CHECK MY OTHER LISTINGS `,platforms:["eBay"],tags:["ebay","seo"],isDefault:!0},{id:"tpl-posh",name:"Poshmark Style",category:"Clothing",titleFormula:"{name} {subcategory} {condition}",descriptionTemplate:`{name}

{condition} condition
{notes}

 Bundle for discount!
 Offers welcome!
 Ships next business day!`,platforms:["Poshmark"],tags:["poshmark","fashion"],isDefault:!0}],Ga=Object.freeze(Object.defineProperty({__proto__:null,addTemplate:af,deleteTemplate:cf,getTemplate:of,getTemplates:rf,getTemplatesForCategory:Va,initTemplates:Wa,updateTemplate:lf},Symbol.toStringTag,{value:"Module"})),df="modulepreload",uf=function(t,e){return new URL(t,e).href},$o={},dt=function(e,n,s){let r=Promise.resolve();if(n&&n.length>0){const o=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));r=Promise.allSettled(n.map(c=>{if(c=uf(c,s),c in $o)return;$o[c]=!0;const d=c.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(!!s)for(let m=o.length-1;m>=0;m--){const v=o[m];if(v.href===c&&(!d||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":df,d||(f.as="script"),f.crossOrigin="",f.href=c,l&&f.setAttribute("nonce",l),document.head.appendChild(f),d)return new Promise((m,v)=>{f.addEventListener("load",m),f.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return r.then(o=>{for(const a of o||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})};let We=0;const _s=25;let Ps="",Un="all",qn="all",ut="overview";function Ce(){const t=document.getElementById("crosslistContent");if(!t)return;ma();const e=_.filter(o=>(o.qty||0)>0),n=xp(e),s=ga(e,7),r=ni(e);let i="";if(i+=`<div class="cl-stats-strip">
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--good)">${n.totalActive}</div><div class="cl-stat-lbl">Active</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--warn)">${n.totalExpiringSoon}</div><div class="cl-stat-lbl">Expiring Soon</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--danger)">${n.totalExpired}</div><div class="cl-stat-lbl">Expired</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--accent2)">${n.totalSoldElsewhere}</div><div class="cl-stat-lbl">Sold Elsewhere</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--muted)">${n.itemsNotListed}</div><div class="cl-stat-lbl">Not Listed</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--accent3)">${n.itemsSinglePlatform}</div><div class="cl-stat-lbl">Single Platform</div></div>
  </div>`,i+=`<div class="cl-tabs">
    <button class="cl-tab ${ut==="overview"?"active":""}" onclick="clSwitchTab('overview')">Overview</button>
    <button class="cl-tab ${ut==="matrix"?"active":""}" onclick="clSwitchTab('matrix')">Listing Matrix</button>
    <button class="cl-tab ${ut==="templates"?"active":""}" onclick="clSwitchTab('templates')">Templates</button>
  </div>`,ut==="overview"?i+=pf(e,s,r,n):ut==="matrix"?i+=hf(e):ut==="templates"&&(i+=ff()),t.innerHTML=i,ut==="matrix"){const o=document.getElementById("clPagination"),a=Ka(e);o&&mn(o,{page:We,totalItems:a.length,pageSize:_s,onPage:l=>{We=l,Ce()}})}}function pf(t,e,n,s){let r="";if(e.length){r+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--warn)"> Expiring Soon (${e.length})</h3>
      <div class="cl-cards">`;for(const{item:i,platform:o,daysLeft:a,expiryDate:l}of e.slice(0,10))r+=`<div class="cl-card cl-card-warn">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${i.id}')">${x(i.name)}</span>
          <span class="cl-card-days">${a}d left</span>
        </div>
        <div class="cl-card-plat">${x(o)}</div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="clRelistItem('${i.id}','${x(o)}')">Relist</button>
          <button class="btn-sm btn-muted" onclick="clOpenLink('${x(o)}','${i.id}')">Open </button>
        </div>
      </div>`;r+="</div></div>"}if(n.length){r+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--danger)"> Expired Listings (${n.length})</h3>
      <button class="btn-sm btn-accent" style="margin-bottom:8px" onclick="clBulkRelistExpired()">Relist All Expired</button>
      <div class="cl-cards">`;for(const{item:i,platform:o,expiryDate:a}of n.slice(0,12)){const l=Math.ceil((Date.now()-new Date(a).getTime())/864e5);r+=`<div class="cl-card cl-card-danger">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${i.id}')">${x(i.name)}</span>
          <span class="cl-card-days">${l}d ago</span>
        </div>
        <div class="cl-card-plat">${x(o)}</div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="clRelistItem('${i.id}','${x(o)}')">Relist</button>
          <button class="btn-sm btn-danger" onclick="clDelistItem('${i.id}','${x(o)}')">Delist</button>
        </div>
      </div>`}r+="</div></div>"}if(s.itemsNotListed>0){const i=t.filter(o=>X(o).length===0).slice(0,8);r+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--muted)"> Not Listed Anywhere (${s.itemsNotListed})</h3>
      <div class="cl-cards">`;for(const o of i)r+=`<div class="cl-card">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${o.id}')">${x(o.name)}</span>
          <span class="cl-card-days">${w(o.price||0)}</span>
        </div>
        <div class="cl-card-plat" style="color:var(--muted)">No platforms assigned</div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="openDrawer('${o.id}')">Edit & List</button>
        </div>
      </div>`;r+="</div></div>"}if(s.itemsSinglePlatform>0){const i=t.filter(o=>X(o).length===1).slice(0,6);r+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--accent3)"> Single Platform (${s.itemsSinglePlatform})</h3>
      <p style="color:var(--muted);font-size:12px;margin-bottom:8px">These items could reach more buyers if crosslisted</p>
      <div class="cl-cards">`;for(const o of i){const a=X(o)[0];r+=`<div class="cl-card">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${o.id}')">${x(o.name)}</span>
          <span class="cl-card-days">${x(a)}</span>
        </div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="openDrawer('${o.id}')">Add Platforms</button>
        </div>
      </div>`}r+="</div></div>"}return!e.length&&!n.length&&s.itemsNotListed===0&&(r+=`<div class="cl-section" style="text-align:center;padding:32px">
      <div style="font-size:24px;margin-bottom:8px"></div>
      <div style="color:var(--good);font-weight:600;font-size:14px;margin-bottom:4px">All Listings Healthy</div>
      <div style="color:var(--muted);font-size:12px">No expired or expiring listings. Check the Matrix tab for a full status overview.</div>
    </div>`),r}function Ka(t){let e=t;if(Ps){const n=Ps.toLowerCase();e=e.filter(s=>s.name.toLowerCase().includes(n)||(s.sku||"").toLowerCase().includes(n))}return Un!=="all"&&(e=e.filter(n=>X(n).includes(Un))),qn!=="all"&&(e=e.filter(n=>{const s=n.platformStatus||{};return Object.values(s).includes(qn)})),e}function hf(t){const e=new Set;for(const a of t)for(const l of X(a))e.add(l);const n=[...e].sort();let s="";s+=`<div class="cl-filters">
    <input type="text" placeholder="Search items..." value="${x(Ps)}"
           oninput="clSetSearch(this.value)"
           class="cl-filter-input">
    <select onchange="clSetPlatFilter(this.value)" class="cl-filter-select">
      <option value="all" ${Un==="all"?"selected":""}>All Platforms</option>
      ${n.map(a=>`<option value="${x(a)}" ${Un===a?"selected":""}>${x(a)}</option>`).join("")}
    </select>
    <select onchange="clSetStatusFilter(this.value)" class="cl-filter-select">
      <option value="all" ${qn==="all"?"selected":""}>All Statuses</option>
      ${bp.map(a=>`<option value="${a}" ${qn===a?"selected":""}>${Br[a]}</option>`).join("")}
    </select>
  </div>`;const r=Ka(t),i=Math.ceil(r.length/_s);We>=i&&(We=Math.max(0,i-1));const o=r.slice(We*_s,(We+1)*_s);if(!o.length)return s+='<div style="text-align:center;padding:24px;color:var(--muted)">No items match filters</div>',s;s+='<div class="cl-matrix-list">';for(const a of o){const l=X(a),c=a.platformStatus||{},d=a.platformListingDates||{};va(a),s+=`<div class="cl-matrix-item">
      <div class="cl-matrix-header" onclick="openDrawer('${a.id}')">
        <span class="cl-matrix-name">${x(a.name)}</span>
        <span class="cl-matrix-meta">${w(a.price||0)}  Qty: ${a.qty||0}</span>
      </div>
      <div class="cl-matrix-platforms">`;for(const u of l){const p=c[u]||"active",f=ha(u,d[u]),m=f!==null?f<0?`<span style="color:var(--danger)">${Math.abs(f)}d expired</span>`:f<=7?`<span style="color:var(--warn)">${f}d left</span>`:`<span style="color:var(--muted)">${f}d</span>`:"";s+=`<div class="cl-plat-row">
          <div class="cl-plat-info">
            <span class="cl-plat-dot" style="background:${pa[p]||"var(--muted)"}"></span>
            <span class="cl-plat-name">${x(u)}</span>
            <span class="cl-plat-status">${Br[p]||p}</span>
            ${m}
          </div>
          <div class="cl-plat-actions">
            <button class="btn-xs" onclick="clCycleStatus('${a.id}','${x(u)}')" title="Change status"></button>
            <button class="btn-xs" onclick="clCopyListing('${a.id}')" title="Copy listing text"></button>
            <button class="btn-xs" onclick="clOpenLink('${x(u)}','${a.id}')" title="Open platform"></button>
            ${p==="expired"?`<button class="btn-xs btn-accent" onclick="clRelistItem('${a.id}','${x(u)}')">Relist</button>`:""}
          </div>
        </div>`}l.length||(s+=`<div class="cl-plat-row" style="color:var(--muted);font-style:italic">No platforms  <span onclick="openDrawer('${a.id}')" style="color:var(--accent);cursor:pointer">add some</span></div>`),s+="</div></div>"}return s+="</div>",s+='<div id="clPagination"></div>',s}function ff(){const t=Va(null);let e=`<div class="cl-section">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 class="cl-section-title" style="margin:0">Listing Templates</h3>
      <button class="btn-sm btn-accent" onclick="clAddTemplate()">+ New Template</button>
    </div>
    <p style="color:var(--muted);font-size:12px;margin-bottom:12px">Templates auto-fill title & description when listing. Use placeholders: {name}, {condition}, {category}, {price}, {notes}, {upc}, {author}, {isbn}</p>`;if(!t.length)e+='<div style="text-align:center;padding:24px;color:var(--muted)">No templates yet. Click "+ New Template" to create one.</div>';else{e+='<div class="cl-template-grid">';for(const n of t)e+=`<div class="cl-template-card">
        <div class="cl-template-header">
          <span class="cl-template-name">${x(n.name)}</span>
          ${n.isDefault?'<span class="cl-template-badge">Default</span>':`<button class="btn-xs btn-danger" onclick="clDeleteTemplate('${n.id}')"></button>`}
        </div>
        <div class="cl-template-category">${x(n.category||"All Categories")}</div>
        <div class="cl-template-preview">
          <div style="font-weight:600;font-size:11px;color:var(--accent);margin-bottom:2px">Title:</div>
          <div style="font-size:11px;color:var(--text)">${x(n.titleFormula)}</div>
          <div style="font-weight:600;font-size:11px;color:var(--accent);margin-top:6px;margin-bottom:2px">Description:</div>
          <div style="font-size:10px;color:var(--muted);white-space:pre-line;max-height:60px;overflow:hidden">${x((n.descriptionTemplate||"").slice(0,150))}</div>
        </div>
      </div>`;e+="</div>"}return e+="</div>",e}function gf(t){ut=t,We=0,Ce()}function mf(t){Ps=t||"",We=0,Ce()}function vf(t){Un=t||"all",We=0,Ce()}function yf(t){qn=t||"all",We=0,Ce()}function bf(t,e){Us(t,e),H(),J(),E(`Relisted on ${e} `),Ce()}function wf(t,e){Ns(t,e,"delisted"),H(),J(),E(`Delisted from ${e}`),Ce()}function xf(t,e){const n=_.find(a=>a.id===t);if(!n)return;const r=(n.platformStatus||{})[e]||"active",i=["active","sold","delisted","expired","draft"],o=i[(i.indexOf(r)+1)%i.length];Ns(t,e,o),o==="active"&&fa(t,e,new Date().toISOString().split("T")[0]),H(),J(),Ce()}function _f(t,e){const n=_.find(r=>r.id===e);if(!n)return;const s=kp(t,n);window.open(s,"_blank")}function Sf(t){const e=_.find(n=>n.id===t);e&&ba(e)}function kf(){const t=_.filter(n=>(n.qty||0)>0),e=ni(t);if(!e.length){E("No expired listings to relist");return}if(confirm(`Relist ${e.length} expired listing(s)?`)){for(const{item:n,platform:s}of e)Us(n.id,s);H(),J(),E(`${e.length} listing(s) relisted `),Ce()}}function $f(){const t=prompt("Template name:");if(!t)return;const e=prompt('Category (or "All"):',"All"),n=prompt("Title formula (use {name}, {condition}, etc.):","{name} - {condition}");if(!n)return;const s=prompt("Description template:",`{name}
Condition: {condition}
{notes}`);dt(()=>Promise.resolve().then(()=>Ga),void 0,import.meta.url).then(r=>{r.addTemplate({name:t,category:e,titleFormula:n,descriptionTemplate:s||""}),E("Template created "),Ce()})}function Ef(t){confirm("Delete this template?")&&dt(()=>Promise.resolve().then(()=>Ga),void 0,import.meta.url).then(e=>{e.deleteTemplate(t),E("Template deleted"),Ce()})}const ci={d:"in",f:"in"};function If(t,e){var o,a;ci[t]=e,(o=document.getElementById(`${t}_unit_in`))==null||o.classList.toggle("active",e==="in"),(a=document.getElementById(`${t}_unit_cm`))==null||a.classList.toggle("active",e==="cm");const n=e==="in",s=document.getElementById(`${t}_wt_maj_lbl`),r=document.getElementById(`${t}_wt_min_lbl`),i=document.getElementById(`${t}_dim_unit_lbl`);s&&(s.textContent=n?"lb":"kg"),r&&(r.textContent=n?"oz":"g"),i&&(i.textContent=n?"in":"cm"),Ja(t)}function Ja(t){var l,c,d,u,p;const e=parseFloat((l=document.getElementById(`${t}_wt_maj`))==null?void 0:l.value)||0,n=parseFloat((c=document.getElementById(`${t}_wt_min`))==null?void 0:c.value)||0,s=parseFloat((d=document.getElementById(`${t}_len`))==null?void 0:d.value)||0,r=parseFloat((u=document.getElementById(`${t}_wid`))==null?void 0:u.value)||0,i=parseFloat((p=document.getElementById(`${t}_hgt`))==null?void 0:p.value)||0,o=ci[t]||"in",a=document.getElementById(`${t}_dimwt_val`);if(a){if(s&&r&&i){let f;o==="in"?(f=s*r*i/139,a.textContent=`dim wt: ${f.toFixed(2)} lb`):(f=s*r*i/5e3,a.textContent=`dim wt: ${f.toFixed(2)} kg`);const m=o==="in"?e+n/16:(e+n/1e3)*2.205;a.style.color=f>m?"var(--danger)":"var(--accent)",a.title=f>m?"Carrier may charge dimensional weight":"Actual weight is heavier"}else a.textContent="";Ya(t)}}function yr(t,e){return e==="cm"?t/2.54:t}function Tf(t,e,n){return n==="in"?t+e/16:(t+e/1e3)*2.205}const Cf=[{id:"poly-sm",icon:"",name:"Poly Mailer (S)",dims:[6,9,0],maxWt:.5,type:"mailer",note:"Clothing, soft goods under 8oz. Lightweight & waterproof."},{id:"poly-md",icon:"",name:"Poly Mailer (M)",dims:[10,13,0],maxWt:1,type:"mailer",note:"T-shirts, jeans, folded apparel. Most common reseller mailer."},{id:"poly-lg",icon:"",name:"Poly Mailer (L)",dims:[14.5,19,0],maxWt:2,type:"mailer",note:"Bulkier clothing, hoodies, jackets, multiple garments."},{id:"bubble-sm",icon:"",name:"Bubble Mailer (S)",dims:[4,8,0],maxWt:.5,type:"mailer",note:"Jewelry, coins, small electronics, accessories."},{id:"bubble-md",icon:"",name:"Bubble Mailer (M)",dims:[8.5,11,0],maxWt:1,type:"mailer",note:"Phone cases, small accessories, books under 1 lb."},{id:"bubble-lg",icon:"",name:"Bubble Mailer (L)",dims:[10.5,16,0],maxWt:2,type:"mailer",note:"Shoes (soft), stacked books, light electronics."},{id:"flat-env",icon:"",name:"USPS Flat Rate Env",dims:[12.5,9.5,0],maxWt:70,type:"flatrate",note:"Up to 70 lbs, flat rate pricing. Great for coins, hardware."},{id:"fr-padded",icon:"",name:"USPS Padded Flat Rate",dims:[12.5,9.5,0],maxWt:70,type:"flatrate",note:"Same flat rate price but padded. Good for fragile flat items."},{id:"pri-sm",icon:"",name:"Priority Small Flat Rate",dims:[8.625,5.375,1.625],maxWt:70,type:"priority",note:"Wallets, sunglasses, cards, thin documents."},{id:"pri-md-1",icon:"",name:"Priority Medium (Top)",dims:[11,8.5,5.5],maxWt:70,type:"priority",note:"Most versatile flat rate  shoes, folded clothes, small appliances."},{id:"pri-md-2",icon:"",name:"Priority Medium (Side)",dims:[13.625,11.875,3.375],maxWt:70,type:"priority",note:"Wide, flat items  art prints, keyboards, flat goods."},{id:"pri-lg",icon:"",name:"Priority Large Flat Rate",dims:[12,12,5.5],maxWt:70,type:"priority",note:"Best for 220 lb items shipping coast-to-coast."},{id:"box-xs",icon:"",name:'Box 666"',dims:[6,6,6],maxWt:10,type:"box",note:"Mugs, small electronics, candles, collectibles."},{id:"box-sm",icon:"",name:'Box 888"',dims:[8,8,8],maxWt:20,type:"box",note:"Shoes, books, small appliances, hats."},{id:"box-md",icon:"",name:'Box 12128"',dims:[12,12,8],maxWt:40,type:"box",note:"Handbags, boots, cameras + accessories, stacked books."},{id:"box-lg",icon:"",name:'Box 181816"',dims:[18,18,16],maxWt:65,type:"box",note:"Coats, keyboards, record players, printers."},{id:"box-xl",icon:"",name:'Box 242418"',dims:[24,24,18],maxWt:70,type:"box",note:"Luggage, monitors, large artwork, bundled clothing."}],Pf=[{name:"Bubble wrap",icon:"",when:(t,e)=>e||t>1},{name:"Packing peanuts",icon:"",when:(t,e,n)=>e&&n>200},{name:"Kraft paper fill",icon:"",when:(t,e,n)=>n>100},{name:"Foam sheets",icon:"",when:(t,e)=>e},{name:"Air pillows",icon:"",when:(t,e,n)=>n>300&&!e},{name:"Tissue paper",icon:"",when:t=>t<1},{name:"Double-boxing",icon:"",when:(t,e)=>e&&t>5}];function Ya(t){var W,T,I,j,Z;const e=document.getElementById(`${t}_pkg_suggestion`);if(!e)return;const n=ci[t]||"in",s=parseFloat((W=document.getElementById(`${t}_wt_maj`))==null?void 0:W.value)||0,r=parseFloat((T=document.getElementById(`${t}_wt_min`))==null?void 0:T.value)||0,i=parseFloat((I=document.getElementById(`${t}_len`))==null?void 0:I.value)||0,o=parseFloat((j=document.getElementById(`${t}_wid`))==null?void 0:j.value)||0,a=parseFloat((Z=document.getElementById(`${t}_hgt`))==null?void 0:Z.value)||0,l=s>0||r>0,c=i>0&&o>0&&a>0;if(!l&&!c){e.innerHTML="";return}const d=Tf(s,r,n),u=yr(i,n),p=yr(o,n),f=yr(a,n),m=c?[u,p,f].sort((L,V)=>V-L):[0,0,0],v=m[0]*m[1]*m[2],b=(v>0?d/(v/1728):0)>10||d>.5&&v<50,S=Cf.map(L=>{const V=[...L.dims].sort((Gs,Ks)=>Ks-Gs);let Se=d<=L.maxWt;if(c&&Se&&(V[2]===0?((m[0]>V[0]-1||m[1]>V[1]-1)&&(Se=!1),f>2&&(Se=!1)):(m[0]>V[0]-1||m[1]>V[1]-1||m[2]>V[2]-.5)&&(Se=!1)),!Se)return null;const ss=V[0]*V[1]*Math.max(V[2],1);let St=1e3/(v>0?ss/v:ss);return L.type==="flatrate"&&d>3&&(St+=200),L.type==="flatrate"&&d>8&&(St+=400),L.type==="mailer"&&d<1&&!b&&(St+=300),L.type==="mailer"&&b&&(St-=200),{...L,score:St}}).filter(Boolean).sort((L,V)=>V.score-L.score);if(!S.length){e.innerHTML='<div class="pkg-suggest"><div class="pkg-suggest-hd"><span class="pkg-suggest-icon"></span><span class="pkg-suggest-ttl">No standard package found</span><span class="pkg-suggest-sub">May require custom or freight packaging</span></div></div>';return}const k=S.slice(0,3),P=Pf.filter(L=>L.when(d,b,v)),M=k.map((L,V)=>{const Se=L.dims[2]===0?`${L.dims[0]}"  ${L.dims[1]}"`:`${L.dims[0]}"  ${L.dims[1]}"  ${L.dims[2]}"`;return`<div class="pkg-card${V===0?" best":""}">
      ${V===0?'<div class="pkg-best-tag">Best fit</div>':""}
      <div class="pkg-card-ico">${L.icon}</div>
      <div class="pkg-card-name">${L.name}</div>
      <div class="pkg-card-dim">${Se}</div>
      <div class="pkg-card-note">${L.note}</div>
    </div>`}).join(""),D=P.length?`<div class="pkg-padding-list">
    <span class="pkg-padding-ttl">Fill &amp; Protection:</span>
    ${P.map(L=>`<span class="pkg-pad-chip">${L.icon} ${L.name}</span>`).join("")}
  </div>`:"",q=l?`${d.toFixed(2)} lb`:"weight not set",O=c?`${u.toFixed(1)}"  ${p.toFixed(1)}"  ${f.toFixed(1)}"`:"dims not set";e.innerHTML=`<div class="pkg-suggest">
    <div class="pkg-suggest-hd">
      <span class="pkg-suggest-icon"></span>
      <span class="pkg-suggest-ttl">Packaging Suggestions</span>
      <span class="pkg-suggest-sub">${q}  ${O}</span>
    </div>
    <div class="pkg-cards">${M}</div>
    ${D}
  </div>`}const gt={firstClass:{basePrice:1.01,incrementalPrice:.24},priorityMail:{zones:{1:[4.3,4.71,5.2,5.85,6.5,7.15,7.8],2:[4.3,4.71,5.2,5.85,6.5,7.15,7.8],3:[4.33,4.75,5.32,6.12,6.92,7.72,8.52],4:[4.4,4.88,5.57,6.56,7.55,8.54,9.53],5:[4.57,5.12,5.98,7.2,8.42,9.64,10.86],6:[4.77,5.43,6.48,8,9.52,11.04,12.56],7:[5.02,5.82,7.1,8.92,10.74,12.56,14.38],8:[5.3,6.25,7.78,9.92,12.06,14.2,16.34]},weightBreaks:[1,2,3,5,10,20,70]}};function Qa(t){if(!t)return null;const e=parseFloat(t.weight)||0,n=t.dimUnit||"oz",r=n==="g"||n==="kg"?e*.035274:e;if(r>0&&r<=13){const i=gt.firstClass.basePrice+Math.max(0,r-1)*gt.firstClass.incrementalPrice;return{carrier:"USPS",service:"First Class Mail",estimatedCost:Math.round(i*100)/100,range:`${r}oz`}}if(r>0){const o=gt.priorityMail.weightBreaks;let a=o.findIndex(d=>r<=d);return a===-1&&(a=o.length-1),{carrier:"USPS",service:"Priority Mail",estimatedCost:gt.priorityMail.zones[5][a],range:`${r.toFixed(1)}oz`}}return{carrier:"USPS",service:"First Class Mail",estimatedCost:1.01,range:"light"}}function di(t){if(!t)return null;const e=parseFloat(t.dimL)||0,n=parseFloat(t.dimW)||0,s=parseFloat(t.dimH)||0;if(parseFloat(t.weight),t.dimUnit,e<=11&&n<=8.5&&s<=5.5)return{name:"Small Flat Rate",type:"USPS Flat Rate",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:7.65,carrier:"USPS"};if(e<=11&&n<=8.5&&s<=5.5)return{name:"Medium Flat Rate",type:"USPS Flat Rate",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:14.75,carrier:"USPS"};if(e<=12&&n<=12&&s<=8)return{name:"Large Flat Rate",type:"USPS Flat Rate",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:20.85,carrier:"USPS"};const r=Qa(t);return{name:"Priority Mail Box",type:"Priority Mail",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:r?r.estimatedCost:7.5,carrier:"USPS"}}function Af(t){if(!t)return[];const e=parseFloat(t.weight)||0;parseFloat(t.price);const n=t.dimUnit||"oz",r=n==="g"||n==="kg"?e*.035274:e,i=[];if(r>0&&r<=13){const a=gt.firstClass.basePrice+Math.max(0,r-1)*gt.firstClass.incrementalPrice;i.push({carrier:"USPS",service:"First Class Mail",estimatedCost:Math.round(a*100)/100,notes:"Fast & cheap for light items"})}if(r>0){const l=gt.priorityMail.weightBreaks;let c=l.findIndex(u=>r<=u);c===-1&&(c=l.length-1);const d=gt.priorityMail.zones[5][c];i.push({carrier:"USPS",service:"Priority Mail",estimatedCost:d,notes:"2-3 day delivery"})}t.category&&(t.category.toLowerCase().includes("book")||t.category.toLowerCase().includes("dvd"))&&i.push({carrier:"USPS",service:"Media Mail",estimatedCost:2.96,notes:"Cheapest for media"});const o=di(t);if(o&&o.type==="USPS Flat Rate"&&i.push({carrier:"USPS",service:o.name,estimatedCost:o.estimatedCost,notes:"Fixed price, any weight up to limit"}),r>16){const a=12.5+Math.max(0,r/16-1)*2.5;i.push({carrier:"UPS",service:"Ground",estimatedCost:Math.round(a*100)/100,notes:"Good for heavy packages"})}if(r>8){const a=11.75+Math.max(0,r/16-1)*2.25;i.push({carrier:"FedEx",service:"Ground",estimatedCost:Math.round(a*100)/100,notes:"Alternative carrier option"})}return i}const Xa="ft_seller_info";function ui(){const t=localStorage.getItem(Xa);if(t)try{return JSON.parse(t)}catch{return Ur()}return Ur()}function Of(t){const n={...Ur(),...t};localStorage.setItem(Xa,JSON.stringify(n))}function Ur(){return{businessName:"FlipTrack Reseller",name:localStorage.getItem("ft_seller_name")||"Your Name",address:localStorage.getItem("ft_seller_address")||"123 Main St",city:localStorage.getItem("ft_seller_city")||"City",state:localStorage.getItem("ft_seller_state")||"ST",zip:localStorage.getItem("ft_seller_zip")||"12345",phone:localStorage.getItem("ft_seller_phone")||"",email:localStorage.getItem("ft_seller_email")||"",website:localStorage.getItem("ft_seller_website")||""}}const Za="ft_thank_you_message";function pi(){return localStorage.getItem(Za)||Rf()}function Df(t){localStorage.setItem(Za,t)}function Rf(){return"Thank you for your purchase! Please leave feedback if you are satisfied with your order."}function el(t,e){if(!e)return;const n=te(e.itemId),s=ui(),r=pi(),i=tl({sale:e,item:n,seller:s,thankYou:r,pageNumber:1,totalPages:1});nl(i,`slip-${t}`)}function Bf(t,e){if(!e||e.length===0)return;const n=ui(),s=pi(),i=e.map((o,a)=>{const l=te(o.itemId);return tl({sale:o,item:l,seller:n,thankYou:s,pageNumber:a+1,totalPages:e.length,pageBreak:a<e.length-1})}).join("");nl(i,`batch-slip-${Date.now()}`)}function tl(t){const{sale:e,item:n,seller:s,thankYou:r,pageNumber:i,totalPages:o,pageBreak:a}=t,l=n?x(n.name):"Unknown Item",c=n?x(n.sku||n.id||""):"",d=x(e.buyerName||"Buyer"),u=x(e.buyerAddress||""),p=x(e.buyerCity||""),f=x(e.buyerState||""),m=x(e.buyerZip||""),v=`${x(s.businessName)}<br>${x(s.name)}<br>${x(s.address)}<br>${x(s.city)}, ${x(s.state)} ${x(s.zip)}`;return`
    <div style="page-break-after:${a?"always":"avoid"};padding:40px;font-family:'Syne','DM Mono',monospace;max-width:600px;margin:0 auto;color:#000;background:#fff">
      <!-- Header -->
      <div style="border-bottom:2px solid #333;padding-bottom:20px;margin-bottom:20px">
        <h1 style="margin:0;font-size:28px;font-weight:900;letter-spacing:-1px">PACKING SLIP</h1>
        <p style="margin:4px 0 0 0;font-size:11px;color:#666">#${x(e.id.slice(0,8).toUpperCase())}</p>
      </div>

      <!-- Two-column header: Seller | Date/Order -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px;font-size:11px">
        <div>
          <p style="margin:0 0 10px 0;font-weight:700;color:#666">FROM:</p>
          <div style="line-height:1.6;font-size:10px">${v}</div>
        </div>
        <div>
          <p style="margin:0 0 6px 0;font-weight:700">Order Date</p>
          <p style="margin:0 0 12px 0;font-size:13px;font-weight:600">${me(e.date)}</p>

          <p style="margin:0 0 6px 0;font-weight:700">Qty</p>
          <p style="margin:0;font-size:13px;font-weight:600">${e.qty||1}</p>
        </div>
      </div>

      <!-- Shipping To -->
      <div style="background:#f5f5f5;padding:16px;margin-bottom:24px;border-left:3px solid #007bff">
        <p style="margin:0 0 8px 0;font-weight:700;font-size:12px">SHIP TO:</p>
        <p style="margin:0;font-weight:600;font-size:13px">${d}</p>
        <p style="margin:4px 0 0 0;font-size:11px;line-height:1.5">
          ${u}
          ${p?"<br>"+p:""}
          ${f?(p?", ":"<br>")+f:""}
          ${m?" "+m:""}
        </p>
      </div>

      <!-- Item Details -->
      <div style="margin-bottom:24px">
        <p style="margin:0 0 10px 0;font-weight:700;font-size:12px">ITEMS INCLUDED:</p>
        <table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="border-bottom:1px solid #ccc">
              <th style="text-align:left;padding:8px 0;font-weight:700">Description</th>
              <th style="text-align:center;padding:8px 0;font-weight:700;width:60px">Qty</th>
              <th style="text-align:left;padding:8px 0;font-weight:700;width:80px">SKU</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid #eee">
              <td style="padding:10px 0;word-break:break-word">${l}</td>
              <td style="text-align:center;padding:10px 0">${e.qty||1}</td>
              <td style="padding:10px 0;font-family:'DM Mono',monospace;font-size:10px">${c}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Summary -->
      <div style="background:#f9f9f9;padding:12px;border-left:3px solid #7b61ff;margin-bottom:24px;font-size:11px">
        <div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:8px">
          <span>Sale Price:</span>
          <span style="font-weight:600">${w(e.price||0)}</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:8px">
          <span>Fees:</span>
          <span style="font-weight:600">${w(e.fees||0)}</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:16px;border-top:1px solid #ddd;padding-top:8px">
          <span>Net (before ship):</span>
          <span style="font-weight:700;font-size:12px">${w((e.price||0)-(e.fees||0))}</span>
        </div>
      </div>

      <!-- Thank You Message -->
      <div style="background:#fffacd;padding:14px;border-left:3px solid #ffc107;margin-bottom:24px;font-size:11px;line-height:1.6;color:#333">
        <p style="margin:0;font-weight:600;margin-bottom:6px">Thank You!</p>
        <p style="margin:0">${x(r)}</p>
      </div>

      <!-- Platform & Tracking info (if shipped) -->
      ${e.shipped?`
        <div style="font-size:10px;color:#666;border-top:1px solid #eee;padding-top:12px">
          <p style="margin:0"><strong>Shipped via:</strong> ${x(e.carrier||"")} ${e.platform?"("+x(e.platform)+")":""}</p>
          ${e.trackingNumber?`<p style="margin:4px 0 0 0"><strong>Tracking:</strong> ${x(e.trackingNumber)}</p>`:""}
        </div>
      `:""}

      <!-- Footer -->
      <div style="border-top:1px solid #ccc;margin-top:24px;padding-top:12px;font-size:9px;color:#999;text-align:center">
        <p style="margin:0">Generated by FlipTrack  Page ${i} of ${o}</p>
        <p style="margin:4px 0 0 0">${new Date().toLocaleString()}</p>
      </div>
    </div>
  `}function nl(t,e){const n=window.open("",e,"height=800,width=600");if(!n){console.warn("Unable to open print window  popup may be blocked");return}n.document.write(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Packing Slip</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Syne', monospace;
          background: #f5f5f5;
          padding: 20px;
        }
        @media print {
          body { background: white; padding: 0; }
          @page { margin: 0.5in; }
        }
      </style>
    </head>
    <body>
      ${t}
      <script>
        window.addEventListener('load', () => {
          setTimeout(() => window.print(), 500);
        });
      <\/script>
    </body>
    </html>
  `),n.document.close()}function Lf(){const t=document.getElementById("modals-root");if(!t||document.getElementById("packingSlipSettingsModal"))return;const e=ui();t.insertAdjacentHTML("beforeend",`
    <div id="packingSlipSettingsModal" class="overlay">
      <div class="modal" style="max-width:500px">
        <div class="modal-header">
          <h3>Packing Slip Settings</h3>
          <button onclick="closePackingSlipSettings()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px"></button>
        </div>
        <div class="modal-body" style="padding:14px;max-height:70vh;overflow-y:auto;display:grid;gap:12px">

          <div style="border-bottom:1px solid var(--border);padding-bottom:12px">
            <h4 style="font-size:12px;font-weight:700;margin-bottom:10px;color:var(--text)">Business Info</h4>

            <div class="fgrp" style="margin-bottom:10px">
              <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Business Name</label>
              <input id="ps_businessName" type="text" value="${x(e.businessName)}" placeholder="Your Shop Name" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
            </div>

            <div class="fgrp" style="margin-bottom:10px">
              <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Your Name</label>
              <input id="ps_name" type="text" value="${x(e.name)}" placeholder="Your Name" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
            </div>

            <div class="fgrp" style="margin-bottom:10px">
              <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Address</label>
              <input id="ps_address" type="text" value="${x(e.address)}" placeholder="123 Main St" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
            </div>

            <div style="display:grid;grid-template-columns:2fr 1fr 1.5fr;gap:8px">
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">City</label>
                <input id="ps_city" type="text" value="${x(e.city)}" placeholder="City" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">State</label>
                <input id="ps_state" type="text" value="${x(e.state)}" placeholder="ST" maxlength="2" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">ZIP</label>
                <input id="ps_zip" type="text" value="${x(e.zip)}" placeholder="12345" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Phone</label>
                <input id="ps_phone" type="text" value="${x(e.phone)}" placeholder="(555) 555-5555" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Email</label>
                <input id="ps_email" type="email" value="${x(e.email)}" placeholder="you@example.com" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
            </div>
          </div>

          <div>
            <h4 style="font-size:12px;font-weight:700;margin-bottom:10px;color:var(--text)">Thank You Message</h4>
            <textarea id="ps_thankYouMsg" placeholder="Thank you for your purchase!..." style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%;min-height:80px;resize:vertical">${x(pi())}</textarea>
            <p style="font-size:9px;color:var(--muted);margin-top:4px">This message appears on all packing slips</p>
          </div>

        </div>
        <div class="modal-footer" style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closePackingSlipSettings()" class="btn-secondary">Cancel</button>
          <button onclick="savePackingSlipSettings()" class="btn-primary">Save</button>
        </div>
      </div>
    </div>
  `)}function Mf(){const t=document.getElementById("packingSlipSettingsModal");t&&t.classList.add("on")}function sl(){const t=document.getElementById("packingSlipSettingsModal");t&&t.classList.remove("on")}function jf(){const t={businessName:document.getElementById("ps_businessName").value.trim(),name:document.getElementById("ps_name").value.trim(),address:document.getElementById("ps_address").value.trim(),city:document.getElementById("ps_city").value.trim(),state:document.getElementById("ps_state").value.trim().toUpperCase(),zip:document.getElementById("ps_zip").value.trim(),phone:document.getElementById("ps_phone").value.trim(),email:document.getElementById("ps_email").value.trim()},e=document.getElementById("ps_thankYouMsg").value.trim();Of(t),Df(e);const n=document.getElementById("toast");n&&(n.textContent="Packing slip settings saved",n.classList.remove("err"),n.classList.add("on"),setTimeout(()=>n.classList.remove("on"),2300)),sl()}let hn="",As="",zt="unshipped",Fn="",Hn="",ze=0;const ys=50;let ue=new Set;function zf(t){hn=(t||"").toLowerCase(),ze=0,_e()}function Nf(t){As=t||"",ze=0,_e()}function Uf(t){zt=t||"unshipped",ze=0,_e()}function qf(t){Fn=t||"",ze=0,_e()}function Ff(t){Hn=t||"",ze=0,_e()}function Hf(){hn="",As="",zt="unshipped",Fn="",Hn="",ze=0,_e()}function Wf(t){ue.has(t)?ue.delete(t):ue.add(t),_e()}function Vf(t){const e=hi();t.checked?e.forEach(n=>ue.add(n.id)):e.forEach(n=>ue.delete(n.id)),_e()}function Gf(){ue.clear(),_e()}function hi(){return C.filter(t=>{if(zt==="unshipped"&&t.shipped||zt==="shipped"&&!t.shipped||As&&t.platform!==As)return!1;if(Fn){const e=new Date(t.date).getTime(),n=new Date(Fn).getTime();if(e<n)return!1}if(Hn){const e=new Date(t.date).getTime(),n=new Date(Hn).getTime();if(e>n)return!1}if(hn){const e=te(t.itemId),n=e?(e.name||"").toLowerCase():"",s=(t.buyerName||"").toLowerCase();if(!n.includes(hn)&&!s.includes(hn))return!1}return!0})}function Kf(t){const e=C.find(s=>s.id===t);if(!e){E("Sale not found",!0);return}const n=document.getElementById("shipModal");n&&(n.dataset.activeSaleId=t,document.getElementById("shipCarrier").value=e.carrier||"USPS",document.getElementById("shipTracking").value=e.trackingNumber||"",document.getElementById("shipCost").value=e.actualShipCost||"",n.classList.add("on"))}function Jf(t){const e=C.find(o=>o.id===t);if(!e){E("Sale not found",!0);return}const n=document.getElementById("shipCarrier").value.trim(),s=document.getElementById("shipTracking").value.trim(),r=document.getElementById("shipCost").value.trim();if(!n){E("Select carrier",!0);return}if(!s){E("Enter tracking number",!0);return}const i=parseFloat(r)||0;e.shipped=!0,e.shippedDate=new Date().toISOString(),e.carrier=n,e.trackingNumber=s,e.actualShipCost=i,ve("sales",t),H(),E(`Marked shipped: ${s}`),document.getElementById("shipModal").classList.remove("on"),_e()}function Yf(){document.getElementById("shipModal").classList.remove("on")}function Qf(){if(ue.size===0){E("Select items first",!0);return}const t=document.getElementById("shipBatchModal");t&&t.classList.add("on")}function Xf(){const t=document.getElementById("shipBatchCarrier").value.trim();if(!t){E("Select carrier",!0);return}let e=0;ue.forEach(n=>{const s=C.find(r=>r.id===n);s&&!s.shipped&&(s.shipped=!0,s.shippedDate=new Date().toISOString(),s.carrier=t,s.trackingNumber="",s.actualShipCost=0,ve("sales",n),e++)}),H(),E(`Marked ${e} orders shipped`),document.getElementById("shipBatchModal").classList.remove("on"),ue.clear(),_e()}function Zf(){document.getElementById("shipBatchModal").classList.remove("on")}function eg(t){const e=C.find(n=>n.id===t);if(!e){E("Sale not found",!0);return}el(t,e)}function tg(){if(ue.size===0){E("Select orders first",!0);return}const t=[...ue].map(e=>C.find(n=>n.id===e)).filter(Boolean);Bf([...ue],t)}function ng(){const t=hi(),e=["Sale ID","Item","Buyer","Platform","Date Sold","Qty","Price","Carrier","Tracking","Ship Cost","Status"],n=t.map(a=>{const l=te(a.itemId);return[a.id,l?x(l.name):"",x(a.buyerName||""),a.platform||"",me(a.date),a.qty||1,w(a.price||0),a.carrier||"",a.trackingNumber||"",w(a.actualShipCost||0),a.shipped?"Shipped":"Pending"]}),s=[e,...n].map(a=>a.map(l=>`"${String(l).replace(/"/g,'""')}"`).join(",")).join(`
`),r=new Blob([s],{type:"text/csv"}),i=URL.createObjectURL(r),o=document.createElement("a");o.href=i,o.download=`ship-log-${new Date().toISOString().split("T")[0]}.csv`,o.click(),URL.revokeObjectURL(i),E("Exported ship log")}function _e(){const t=document.getElementById("view-shipping");if(!t)return;const e=hi(),n=Math.max(1,Math.ceil(e.length/ys));ze=Math.max(0,Math.min(ze,n-1));const s=ze*ys,r=s+ys,i=e.slice(s,r),o=C.filter(u=>!u.shipped).length,a=C.filter(u=>{if(!u.shippedDate)return!1;const p=new Date(u.shippedDate).getTime();return Date.now()-p<864e5}).length,l=(()=>{const u=C.filter(f=>f.shippedDate&&f.date);if(u.length===0)return 0;const p=u.reduce((f,m)=>{const v=new Date(m.date).getTime(),g=new Date(m.shippedDate).getTime();return f+(g-v)},0);return Math.round(p/u.length/864e5)})(),c=C.filter(u=>u.shipped).reduce((u,p)=>u+(p.actualShipCost||0),0),d=i.length>0&&i.every(u=>ue.has(u.id));t.innerHTML=`
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">Shipping & Fulfillment</h2>
      </div>

      <!-- Stats strip -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:14px;border-bottom:1px solid var(--border)">
        <div class="stat-card c1">
          <div class="stat-label">Pending</div>
          <div class="stat-value">${o}</div>
        </div>
        <div class="stat-card c2">
          <div class="stat-label">Shipped Today</div>
          <div class="stat-value">${a}</div>
        </div>
        <div class="stat-card c3">
          <div class="stat-label">Avg Ship Time</div>
          <div class="stat-value">${l} days</div>
        </div>
        <div class="stat-card c4">
          <div class="stat-label">Total Cost</div>
          <div class="stat-value">${w(c)}</div>
        </div>
      </div>

      <!-- Filters -->
      <div style="padding:14px;border-bottom:1px solid var(--border);background:var(--surface2)">
        <div class="form-grid" style="margin-bottom:12px">
          <input type="text" placeholder="Search item or buyer..." value="${x(hn)}"
            oninput="shipSetSearch(this.value)" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px" />

          <select onchange="shipSetStatusFilter(this.value)" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px">
            <option value="unshipped" ${zt==="unshipped"?"selected":""}>Unshipped</option>
            <option value="shipped" ${zt==="shipped"?"selected":""}>Shipped</option>
            <option value="all" ${zt==="all"?"selected":""}>All</option>
          </select>
        </div>

        <div class="form-grid" style="gap:8px;align-items:end">
          <div style="min-width:100px">
            <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px">From Date</label>
            <input type="date" value="${Fn}" onchange="shipSetDateFrom(this.value)" style="padding:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
          <div style="min-width:100px">
            <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px">To Date</label>
            <input type="date" value="${Hn}" onchange="shipSetDateTo(this.value)" style="padding:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
          <button onclick="shipClearFilters()" class="btn-secondary" style="padding:6px 12px;font-size:10px">Clear</button>
        </div>
      </div>

      <!-- Batch actions -->
      ${ue.size>0?`
        <div style="padding:10px 14px;background:rgba(87,200,255,0.05);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;font-size:11px;color:var(--muted)">
          <span>${ue.size} selected</span>
          <button onclick="shipBatchMark()" class="btn-primary" style="padding:5px 10px;font-size:10px">Mark Shipped</button>
          <button onclick="shipPrintBatchSlips()" class="btn-secondary" style="padding:5px 10px;font-size:10px">Print Slips</button>
          <button onclick="shipClearSel()" class="btn-danger" style="padding:5px 10px;font-size:10px">Clear</button>
        </div>
      `:""}

      <!-- Actions bar -->
      <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="shipExportLog()" class="btn-secondary" style="padding:6px 12px;font-size:10px">Export Log</button>
      </div>

      <!-- Table/cards -->
      ${i.length===0?`
        <div class="empty-state">
          <p style="font-size:12px;color:var(--muted)">No orders to ship</p>
        </div>
      `:`
        <div style="overflow-x:auto">
          <table class="inv-table">
            <thead>
              <tr style="border-bottom:1px solid var(--border)">
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">
                  <input type="checkbox" ${d?"checked":""} onchange="shipToggleAll(this)" />
                </th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Item</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Buyer</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Platform</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Date Sold</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Weight</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Package</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Status</th>
                <th style="padding:10px;text-align:center;font-size:10px;color:var(--muted);font-weight:600">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${i.map(u=>{const p=te(u.itemId),f=p?di(p):null,m=ue.has(u.id);return`
                  <tr style="border-bottom:1px solid var(--border);background:${m?"rgba(87,200,255,0.05)":"transparent"}">
                    <td style="padding:10px"><input type="checkbox" ${m?"checked":""} onchange="shipToggleSel('${u.id}')" /></td>
                    <td style="padding:10px;font-size:11px;color:var(--text)">${x(p?p.name:"")}</td>
                    <td style="padding:10px;font-size:11px;color:var(--text)">${x(u.buyerName||"")}</td>
                    <td style="padding:10px;font-size:10px;color:var(--muted)">${x(u.platform||"")}</td>
                    <td style="padding:10px;font-size:10px;color:var(--muted)">${me(u.date)}</td>
                    <td style="padding:10px;font-size:10px;color:var(--muted)">${p&&p.weight?p.weight+(p.dimUnit||"oz"):""}</td>
                    <td style="padding:10px;font-size:10px;color:var(--accent)">${f?x(f.name):""}</td>
                    <td style="padding:10px;font-size:10px">
                      <span style="color:${u.shipped?"var(--good)":"var(--warn)"}">
                        ${u.shipped?` ${me(u.shippedDate)}`:"Pending"}
                      </span>
                    </td>
                    <td style="padding:10px;text-align:center;font-size:10px;display:flex;gap:6px;justify-content:center">
                      ${u.shipped?"":`<button onclick="shipMarkShipped('${u.id}')" class="act-btn" style="padding:4px 8px">Mark</button>`}
                      <button onclick="shipPrintSlip('${u.id}')" class="act-btn" style="padding:4px 8px">Slip</button>
                      ${u.trackingNumber?`<a href="https://tools.usps.com/go/TrackConfirmAction_input?tLabels=${encodeURIComponent(u.trackingNumber)}" target="_blank" class="act-btn" style="padding:4px 8px;text-decoration:none">Track</a>`:""}
                    </td>
                  </tr>
                `}).join("")}
            </tbody>
          </table>
        </div>
      `}

      <!-- Pagination -->
      <div id="shipPagination" style="padding:14px"></div>
    </div>
  `,mn(document.getElementById("shipPagination"),{page:ze,totalItems:e.length,pageSize:ys,onPage:u=>{ze=u,_e()}})}function sg(){const t=document.getElementById("modals-root");!t||document.getElementById("shipModal")||t.insertAdjacentHTML("beforeend",`
    <!-- Mark Shipped Modal -->
    <div id="shipModal" class="overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Mark Order Shipped</h3>
          <button onclick="shipCancelMark()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px"></button>
        </div>
        <div class="modal-body" style="padding:14px;display:grid;gap:10px">
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Carrier</label>
            <select id="shipCarrier" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%">
              <option>USPS</option>
              <option>UPS</option>
              <option>FedEx</option>
              <option>DHL</option>
              <option>Other</option>
            </select>
          </div>
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Tracking Number</label>
            <input id="shipTracking" type="text" placeholder="e.g., 9400111899223456789012" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Actual Shipping Cost ($)</label>
            <input id="shipCost" type="number" placeholder="0.00" step="0.01" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
        </div>
        <div class="modal-footer" style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
          <button onclick="shipCancelMark()" class="btn-secondary">Cancel</button>
          <button onclick="shipConfirmShipped(document.getElementById('shipModal').dataset.activeSaleId)" class="btn-primary">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Batch Mark Shipped Modal -->
    <div id="shipBatchModal" class="overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Mark Selected as Shipped</h3>
          <button onclick="shipCancelBatchMark()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px"></button>
        </div>
        <div class="modal-body" style="padding:14px;display:grid;gap:10px">
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Carrier</label>
            <select id="shipBatchCarrier" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%">
              <option value=""> Select </option>
              <option>USPS</option>
              <option>UPS</option>
              <option>FedEx</option>
              <option>DHL</option>
              <option>Other</option>
            </select>
          </div>
          <p style="font-size:11px;color:var(--muted)">Tracking numbers can be added individually after batch mark.</p>
        </div>
        <div class="modal-footer" style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
          <button onclick="shipCancelBatchMark()" class="btn-secondary">Cancel</button>
          <button onclick="shipConfirmBatchMark()" class="btn-primary">Mark All</button>
        </div>
      </div>
    </div>
  `)}function Ss(t,e,n){if(!t||!t.itemIds||!t.itemIds.length)return{totalRevenue:0,totalCost:0,profit:0,roi:0,margin:0};let s=0,r=t.totalSpent||0;t.itemIds.forEach(l=>{if(!e.find(p=>p.id===l))return;const u=n.filter(p=>p.itemId===l).reduce((p,f)=>p+(f.amount||0),0);s+=u});const i=s-r,o=r?i/r:0,a=s?i/s:0;return{totalRevenue:s,totalCost:r,profit:i,roi:o,margin:a}}function rl(t,e){return!t||!t.itemIds?[]:t.itemIds.map(n=>e.find(s=>s.id===n)).filter(Boolean)}function rg(t,e){const n=rl(t,e);if(!n.length)return{};const s=(t.totalSpent||0)/n.length,r={};return n.forEach(i=>{r[i.id]=s}),r}function ig(t,e,n){const s={};return t.forEach(r=>{const i=r.location||"Unknown";s[i]||(s[i]={location:i,count:0,totalSpent:0,totalRevenue:0,itemCount:0,roi:0,margin:0});const o=Ss(r,e,n);s[i].count+=1,s[i].totalSpent+=r.totalSpent||0,s[i].totalRevenue+=o.totalRevenue,s[i].itemCount+=r.itemIds?r.itemIds.length:0}),Object.values(s).forEach(r=>{r.totalSpent&&(r.roi=(r.totalRevenue-r.totalSpent)/r.totalSpent,r.margin=r.totalRevenue?(r.totalRevenue-r.totalSpent)/r.totalRevenue:0)}),s}function og(t,e,n,s=5){const r=ig(t,e,n);return Object.values(r).filter(i=>i.count>0).sort((i,o)=>o.roi-i.roi).slice(0,s)}function ag(t){const e=t.length,n=t.reduce((r,i)=>r+(i.totalSpent||0),0),s=t.reduce((r,i)=>r+(i.itemIds?i.itemIds.length:0),0);return{totalHauls:e,totalInvested:n,avgPerHaul:e?n/e:0,totalItems:s,avgItemsPerHaul:e?s/e:0}}let fe=[],Tn="",$e="date-desc",qr=null,Rt=0,kn=25;async function lg(){try{fe=await wt("hauls"),fe||(fe=[])}catch(t){console.warn("FlipTrack: Hauls IDB load failed, using localStorage:",t.message),fe=JSON.parse(localStorage.getItem("ft_hauls")||"[]")}}async function Vs(){await Ye("hauls",fe),localStorage.setItem("ft_hauls",JSON.stringify(fe))}function qe(){const t=document.getElementById("sourcing-view");if(!t)return;const e=fe.filter(r=>!Tn||(r.location||"").toLowerCase().includes(Tn)||(r.notes||"").toLowerCase().includes(Tn)).sort((r,i)=>{if($e==="date-desc")return new Date(i.date)-new Date(r.date);if($e==="date-asc")return new Date(r.date)-new Date(i.date);if($e==="spent-high")return(i.totalSpent||0)-(r.totalSpent||0);if($e==="spent-low")return(r.totalSpent||0)-(i.totalSpent||0);if($e==="roi-high"){const o=Ss(r,_,C).roi;return Ss(i,_,C).roi-o}return $e==="location"?(r.location||"").localeCompare(i.location||""):new Date(i.date)-new Date(r.date)}),n=ag(fe),s=og(fe,_,C,3);t.innerHTML=`
    <div class="sourcing-container" style="display:flex;flex-direction:column;gap:16px;padding:12px">

      <!-- STATS STRIP -->
      <div class="stats-strip" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px">
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Total Hauls</div>
          <div style="font-size:20px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent)">${n.totalHauls}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Total Invested</div>
          <div style="font-size:18px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent2)">${w(n.totalInvested)}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Avg Per Haul</div>
          <div style="font-size:18px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent3)">${w(n.avgPerHaul)}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Avg Items/Haul</div>
          <div style="font-size:20px;font-weight:700;font-family:'Syne',sans-serif;color:var(--good)">${n.avgItemsPerHaul.toFixed(1)}</div>
        </div>
      </div>

      <!-- TOP SOURCES LEADERBOARD -->
      ${s.length?`
        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Top Sourcing Locations</h3>
          </div>
          <div style="padding:12px">
            ${s.map((r,i)=>{const o=["","",""][i]||"",a=r.roi>=.3?"var(--good)":r.roi>=.1?"var(--accent)":"var(--warn)";return`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;font-family:'DM Mono',monospace">
                <div>
                  <span style="margin-right:8px">${o}</span>
                  <strong>${x(r.location)}</strong>
                  <span style="color:var(--muted);font-size:11px"> (${r.count} haul${r.count!==1?"s":""})</span>
                </div>
                <div style="text-align:right">
                  <div style="color:${a};font-weight:700">${Q(r.roi)}</div>
                  <div style="color:var(--muted);font-size:11px">${w(r.totalSpent)} invested</div>
                </div>
              </div>`}).join("")}
          </div>
        </div>
      `:""}

      <!-- LOG NEW HAUL FORM -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Log New Haul</h3>
        </div>
        <div style="padding:12px;display:grid;gap:10px">
          <div class="form-grid">
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Date</label>
              <input type="date" id="haul_date" value="${new Date().toISOString().split("T")[0]}"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Location</label>
              <input type="text" id="haul_loc" placeholder="e.g. Goodwill, Estate Sale, Thrift"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Spent</label>
              <input type="number" id="haul_spent" placeholder="0.00" step="0.01" min="0"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Mileage (mi)</label>
              <input type="number" id="haul_mileage" placeholder="0" step="0.1" min="0"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
          </div>
          <div class="fgrp">
            <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Notes</label>
            <textarea id="haul_notes" placeholder="Add notes..." rows="2"
                      style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;resize:vertical"></textarea>
          </div>
          <button class="btn-primary" onclick="addHaul()" style="padding:10px;font-weight:700;font-family:'Syne',sans-serif">Log Haul</button>
        </div>
      </div>

      <!-- SEARCH & SORT -->
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:0 0 8px 0">
        <input type="text" placeholder="Search location, notes..." value="${x(Tn)}"
               oninput="srcSetSearch(this.value)"
               style="flex:1;min-width:150px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;font-family:'DM Mono',monospace">
        <select onchange="srcSetSort(this.value)" style="padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
          <option value="date-desc" ${$e==="date-desc"?"selected":""}>Recent first</option>
          <option value="date-asc" ${$e==="date-asc"?"selected":""}>Oldest first</option>
          <option value="spent-high" ${$e==="spent-high"?"selected":""}>Spent (high)</option>
          <option value="spent-low" ${$e==="spent-low"?"selected":""}>Spent (low)</option>
          <option value="roi-high" ${$e==="roi-high"?"selected":""}>ROI (high)</option>
          <option value="location" ${$e==="location"?"selected":""}>Location A-Z</option>
        </select>
      </div>

      <!-- HAUL LIST -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Haul History (${e.length})</h3>
        </div>
        <div style="padding:12px">
          ${e.length?`
            <div style="display:flex;flex-direction:column;gap:8px">
              ${e.slice(Rt*kn,(Rt+1)*kn).map(r=>{const i=Ss(r,_,C),o=rl(r,_),a=qr===r.id,l=i.roi>=.3?"var(--good)":i.roi>=.1?"var(--accent)":i.roi<0?"var(--danger)":"var(--muted)";return`<div class="haul-card" style="border:1px solid var(--border);border-radius:6px;padding:10px;background:rgba(var(--surface-rgb),0.5);cursor:pointer" onclick="expandHaul('${r.id}')">
                  <div style="display:grid;grid-template-columns:1fr auto;gap:8px;font-size:12px;font-family:'DM Mono',monospace">
                    <div>
                      <div style="font-weight:700;color:var(--text)">${x(r.location)}</div>
                      <div style="color:var(--muted);font-size:11px">${me(r.date)}  ${o.length} item${o.length!==1?"s":""}</div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-weight:700;color:var(--accent2)">${w(r.totalSpent)}</div>
                      <div style="color:${l};font-size:11px;font-weight:700">${Q(i.roi)}</div>
                    </div>
                  </div>
                  ${a?`
                    <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px">
                      <div style="font-size:11px;color:var(--muted);margin-bottom:8px">
                        <strong>Linked Items (${o.length}):</strong>
                      </div>
                      ${o.length?`
                        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px">
                          ${o.map(c=>{const d=rg(r,_)[c.id]||0,p=C.filter(f=>f.itemId===c.id).reduce((f,m)=>f+(m.amount||0),0);return`<div style="padding:6px;background:var(--surface);border-radius:4px;font-size:11px;display:flex;justify-content:space-between">
                              <span>${x(c.title||"Untitled")}</span>
                              <span style="color:var(--muted)">${w(d)} cost  ${w(p)} revenue</span>
                            </div>`}).join("")}
                        </div>
                      `:'<div style="color:var(--muted);font-size:11px;padding:8px">No items linked yet</div>'}
                      <button class="btn-secondary" onclick="linkItemsToHaul('${r.id}')" style="padding:6px 10px;margin-right:6px;font-size:11px;font-family:'Syne',sans-serif">Link Items</button>
                      <button class="btn-danger" onclick="deleteHaul('${r.id}')" style="padding:6px 10px;font-size:11px;font-family:'Syne',sans-serif">Delete</button>
                    </div>
                  `:""}
                </div>`}).join("")}
            </div>
            <div id="srcPagination" style="margin-top:12px"></div>
          `:`<div class="empty-state" style="text-align:center;padding:24px;color:var(--muted)">
            <div style="font-size:14px;font-family:'Syne',sans-serif;margin-bottom:8px">No hauls yet</div>
            <div style="font-size:12px">Log your first haul to get started!</div>
          </div>`}
        </div>
      </div>
    </div>
  `,e.length>kn&&mn(document.getElementById("srcPagination"),{page:Rt,totalItems:e.length,pageSize:kn,onPage:r=>{Rt=r,qe()},pageSizes:[25,50,100],onPageSize:r=>{kn=r,Rt=0,qe()}})}async function cg(){var l,c,d,u,p,f,m,v,g;const t=(l=document.getElementById("haul_date"))==null?void 0:l.value,e=(d=(c=document.getElementById("haul_loc"))==null?void 0:c.value)==null?void 0:d.trim(),n=(p=(u=document.getElementById("haul_spent"))==null?void 0:u.value)==null?void 0:p.trim(),s=(m=(f=document.getElementById("haul_mileage"))==null?void 0:f.value)==null?void 0:m.trim(),r=(g=(v=document.getElementById("haul_notes"))==null?void 0:v.value)==null?void 0:g.trim();if(!t){E("Please enter a date",!0);return}if(!e){E("Please enter a location",!0);return}if(!n||isNaN(parseFloat(n))){E("Please enter a valid amount spent",!0);return}const i=parseFloat(n),o=s?parseFloat(s):0,a={id:Fe(),date:t,location:e,totalSpent:i,itemIds:[],notes:r||"",mileage:o||0,receiptImage:null};fe.push(a),await Vs(),E("Haul logged "),document.getElementById("haul_loc").value="",document.getElementById("haul_spent").value="",document.getElementById("haul_mileage").value="",document.getElementById("haul_notes").value="",qe()}async function dg(t){if(!confirm("Delete this haul?"))return;const e=fe.findIndex(n=>n.id===t);e>=0&&(fe.splice(e,1),await Vs(),E("Haul deleted"),qe())}function ug(t){qr=qr===t?null:t,qe()}async function pg(t){const e=fe.find(i=>i.id===t);if(!e)return;const n=document.createElement("div");n.style.cssText=`
    position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);
    display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px
  `;const s=document.createElement("div");s.style.cssText=`
    background:var(--surface);border:1px solid var(--border);border-radius:8px;
    padding:20px;max-width:600px;width:100%;max-height:80vh;overflow-y:auto;
    font-family:'DM Mono',monospace;font-size:12px
  `;const r=_.filter(i=>!e.itemIds.includes(i.id));s.innerHTML=`
    <div style="margin-bottom:16px">
      <h3 style="font-family:'Syne',sans-serif;font-size:16px;margin:0 0 12px 0">Link Items to Haul</h3>
      <div style="color:var(--muted);font-size:11px;margin-bottom:12px">Select items to assign to this haul</div>

      ${r.length?`
        <div style="display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto">
          ${r.map(i=>`
            <label style="display:flex;align-items:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:4px;cursor:pointer">
              <input type="checkbox" value="${i.id}" style="margin-right:8px">
              <span style="flex:1">${x(i.title||"Untitled")}</span>
              <span style="color:var(--muted);font-size:10px">${w(i.cost||0)}</span>
            </label>
          `).join("")}
        </div>
      `:'<div style="color:var(--muted);padding:12px;text-align:center">All items already linked to hauls</div>'}
    </div>

    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn-primary" onclick="confirmLinkItems('${t}')" style="flex:1;padding:10px;font-family:'Syne',sans-serif">Link Selected</button>
      <button class="btn-secondary" onclick="closeItemLinkModal()" style="flex:1;padding:10px;font-family:'Syne',sans-serif">Cancel</button>
    </div>
  `,n.appendChild(s),document.body.appendChild(n),window._itemLinkModal=n}async function hg(t){const e=window._itemLinkModal;if(!e)return;const n=e.querySelectorAll('input[type="checkbox"]:checked'),s=Array.from(n).map(i=>i.value),r=fe.find(i=>i.id===t);r&&(r.itemIds.push(...s),await Vs(),E(`Linked ${s.length} item${s.length!==1?"s":""}`)),il(),qe()}function il(){const t=window._itemLinkModal;t&&(t.remove(),window._itemLinkModal=null)}async function fg(t,e){const n=fe.find(s=>s.id===t);if(n){const s=n.itemIds.indexOf(e);s>=0&&(n.itemIds.splice(s,1),await Vs(),qe())}}function gg(t){Tn=(t||"").toLowerCase(),Rt=0,qe()}function mg(t){$e=t||"date-desc",Rt=0,qe()}const vg={2024:.67,2025:.7,2026:.7};let Ve=[];async function ol(){try{Ve=await wt("mileage_log")||[]}catch(t){console.warn("Failed to load mileage log:",t.message),Ve=[]}}async function yg(t){if(!t.date||!t.miles||!t.purpose)return E("Please fill in date, miles, and purpose",!0),!1;const e=Number(t.miles)||0;if(e<=0)return E("Miles must be greater than 0",!0),!1;const n={id:Fe(),date:t.date,miles:e,purpose:t.purpose.trim(),startLocation:(t.startLocation||"").trim(),endLocation:(t.endLocation||"").trim(),linkedHaulId:t.linkedHaulId||null};Ve.push(n),Ve.sort((s,r)=>new Date(r.date)-new Date(s.date));try{return await Ye("mileage_log",Ve),!0}catch(s){return console.error("Failed to save mileage entry:",s.message),E("Failed to save mileage entry",!0),Ve.pop(),!1}}async function bg(t){const e=Ve.findIndex(n=>n.id===t);if(e===-1)return!1;Ve.splice(e,1);try{return await Ye("mileage_log",Ve),!0}catch(n){return console.error("Failed to delete mileage entry:",n.message),E("Failed to delete mileage entry",!0),!1}}function al(t){const e=vg[t]||.7,n=Ve.filter(i=>new Date(i.date).getFullYear()===t),s=n.reduce((i,o)=>i+(o.miles||0),0),r=s*e;return{totalMiles:s,totalDeduction:r,rate:e,entries:n}}function wg(){const t=new Date().getFullYear(),e=al(t),n=e.entries.sort((s,r)=>new Date(r.date)-new Date(s.date)).map((s,r)=>`
      <tr>
        <td style="padding:8px;font-size:12px;color:var(--text)">${me(s.date)}</td>
        <td style="padding:8px;font-size:12px;font-family:'DM Mono',monospace;color:var(--accent);text-align:right">${s.miles}</td>
        <td style="padding:8px;font-size:12px;color:var(--text)">${x(s.purpose)}</td>
        <td style="padding:8px;font-size:12px;color:var(--muted)">${s.startLocation?x(s.startLocation):""}</td>
        <td style="padding:8px;font-size:11px;text-align:center">
          <button onclick="mileDeleteEntry('${s.id}')" style="padding:4px 8px;background:var(--danger);color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;font-family:Syne,sans-serif">Delete</button>
        </td>
      </tr>
    `).join("");return`
    <div style="margin-bottom:24px">
      <div class="panel-title" style="margin-bottom:12px">Mileage Deduction Log</div>

      <!-- Add Entry Form -->
      <div class="panel" style="margin-bottom:16px;padding:12px">
        <div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:8px">ADD ENTRY</div>
        <div class="form-grid" style="grid-template-columns:1fr 1fr 2fr;gap:8px;margin-bottom:8px">
          <div class="fgrp">
            <input type="date" id="mileDate" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
          <div class="fgrp">
            <input type="number" id="mileMiles" placeholder="Miles" step="0.1" min="0" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
          <div class="fgrp">
            <input type="text" id="milePurpose" placeholder="Purpose (e.g., sourcing trip)" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
        </div>
        <div class="form-grid" style="grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="fgrp">
            <input type="text" id="mileStart" placeholder="Start location (optional)" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
          <div class="fgrp">
            <input type="text" id="mileEnd" placeholder="End location (optional)" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
        </div>
        <button onclick="mileAddEntry()" class="btn-primary" style="width:100%;padding:8px;background:var(--accent);color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-family:Syne,sans-serif;font-size:13px">Add Entry</button>
      </div>

      <!-- Log Table -->
      ${e.entries.length>0?`
        <div style="overflow-x:auto;margin-bottom:16px">
          <table class="inv-table" style="font-size:12px;width:100%">
            <thead>
              <tr style="background:var(--surface);border-bottom:1px solid var(--border)">
                <th style="padding:8px;text-align:left;font-weight:600">Date</th>
                <th style="padding:8px;text-align:right;font-weight:600">Miles</th>
                <th style="padding:8px;text-align:left;font-weight:600">Purpose</th>
                <th style="padding:8px;text-align:left;font-weight:600">From</th>
                <th style="padding:8px;text-align:center;font-weight:600">Action</th>
              </tr>
            </thead>
            <tbody>
              ${n}
            </tbody>
          </table>
        </div>
      `:`
        <div class="empty-state" style="padding:16px;text-align:center;color:var(--muted);font-size:12px">
          No mileage entries yet
        </div>
      `}

      <!-- Summary Stats -->
      <div class="stat-card" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div style="padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
          <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Total Miles (${t})</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent);font-family:'DM Mono',monospace">${e.totalMiles.toFixed(1)}</div>
        </div>
        <div style="padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
          <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Deduction @ ${(e.rate*100).toFixed(0)}/mi</div>
          <div style="font-size:18px;font-weight:700;color:var(--good);font-family:'DM Mono',monospace">${w(e.totalDeduction)}</div>
        </div>
      </div>
    </div>
  `}async function xg(){const t=document.getElementById("mileDate"),e=document.getElementById("mileMiles"),n=document.getElementById("milePurpose"),s=document.getElementById("mileStart"),r=document.getElementById("mileEnd");if(!t||!e||!n){console.warn("Mileage form elements not found");return}await yg({date:t.value,miles:e.value,purpose:n.value,startLocation:(s==null?void 0:s.value)||"",endLocation:(r==null?void 0:r.value)||""})&&(E("Mileage entry added "),t.value="",e.value="",n.value="",s.value="",r.value="",window.renderTaxCenter&&window.renderTaxCenter())}async function _g(t){if(!confirm("Delete this mileage entry?"))return;await bg(t)&&(E("Entry deleted "),window.renderTaxCenter&&window.renderTaxCenter())}let de=new Date().getFullYear(),Ge=null,Dn=!1;function Sg(t){de=Number(t),ts()}function kg(t){Ge=Ge===t?null:t,ts()}function $g(){Dn=!Dn,ts()}function Os(t,e){const n=new Date(t,(e-1)*3,1),s=new Date(t,e*3,0,23,59,59);return{start:n,end:s}}function Wn(t,e){let n=0,s=0,r=0,i=0;const o=new Set,a=C.filter(m=>{const v=new Date(m.date);return v>=t&&v<=e});for(const m of a){const v=te(m.itemId),g=m.qty||1,b=m.price||0;n+=b*g,s+=((v==null?void 0:v.cost)||0)*g,r+=m.fees||0,i+=m.ship||0,o.add(m.itemId)}const l=n-s-r-i,c=G.filter(m=>{const v=new Date(m.date);return v>=t&&v<=e}),d={};let u=0;for(const m of c){const v=m.category||"Other";d[v]=(d[v]||0)+(m.amount||0),u+=m.amount||0}const p=l-u,f=p*.25;return{revenue:n,cogs:s,platformFees:r,shipping:i,grossProfit:l,totalExpenses:u,expensesByCategory:d,netProfit:p,estimatedTax:f,saleCount:a.length,itemCount:o.size}}function Eg(){return`
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table" style="width:100%;font-size:12px">
        <thead>
          <tr style="background:var(--surface);border-bottom:2px solid var(--border)">
            <th style="padding:10px;text-align:left;font-weight:700">Period</th>
            <th style="padding:10px;text-align:right;font-weight:700">Revenue</th>
            <th style="padding:10px;text-align:right;font-weight:700">COGS</th>
            <th style="padding:10px;text-align:right;font-weight:700">Gross Profit</th>
            <th style="padding:10px;text-align:right;font-weight:700">Expenses</th>
            <th style="padding:10px;text-align:right;font-weight:700">Net Profit</th>
            <th style="padding:10px;text-align:right;font-weight:700">Est. Tax (25%)</th>
          </tr>
        </thead>
        <tbody>${[1,2,3,4].map(n=>{const{start:s,end:r}=Os(de,n),i=Wn(s,r);return`
      <tr style="cursor:pointer;background:${Ge===n?"var(--surface)":""};border-bottom:1px solid var(--border)" onclick="taxSetQuarter(${n})">
        <td style="padding:10px;font-weight:600;color:var(--text)">Q${n}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--accent)">${w(i.revenue)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--muted)">${w(i.cogs)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--good)">${w(i.grossProfit)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--danger)">${w(i.totalExpenses)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;font-weight:600;color:${i.netProfit>=0?"var(--good)":"var(--danger)"}">${w(i.netProfit)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--warn)">${w(i.estimatedTax)}</td>
      </tr>
    `}).join("")}</tbody>
      </table>
    </div>
  `}function Ig(t){return`
    <div style="margin-bottom:16px;padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="panel-title" style="margin:0">Schedule C Summary</div>
        <button onclick="taxToggleScheduleC()" style="padding:4px 10px;background:var(--accent2);color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px;font-weight:600;font-family:Syne,sans-serif">Hide</button>
      </div>
      <div style="overflow-x:auto">
        <table style="width:100%;font-size:11px">
          <tbody>${[{line:1,label:"Gross receipts or sales",value:w(t.revenue)},{line:2,label:"Returns and allowances",value:w(0)},{line:4,label:"Cost of goods sold (COGS)",value:w(t.cogs)},{line:5,label:"Gross profit",value:w(t.grossProfit)},{line:10,label:"Commissions & fees (platforms)",value:w(t.platformFees)},{line:22,label:"Supplies",value:w(t.expensesByCategory.Supplies||0)},{line:27,label:"Other expenses",value:w((t.expensesByCategory["Shipping Supplies"]||0)+(t.expensesByCategory.Software||0))}].map(s=>`
    <tr style="border-bottom:1px solid var(--border)">
      <td style="padding:8px;font-weight:600;color:var(--muted);font-family:'DM Mono',monospace;width:50px">Line ${s.line}</td>
      <td style="padding:8px;color:var(--text)">${s.label}</td>
      <td style="padding:8px;font-family:'DM Mono',monospace;color:var(--accent);text-align:right;font-weight:600">${s.value}</td>
    </tr>
  `).join("")}</tbody>
        </table>
      </div>
    </div>
  `}async function Tg(){if(Ge){const{start:t,end:e}=Os(de,Ge),n=Wn(t,e),s=["FlipTrack Tax Report - Q"+Ge+" "+de,"","Summary","Metric,Amount","Revenue,"+n.revenue,"COGS,"+n.cogs,"Platform Fees,"+n.platformFees,"Shipping Costs,"+n.shipping,"Gross Profit,"+n.grossProfit,"Total Expenses,"+n.totalExpenses,"Net Profit,"+n.netProfit,"Estimated Tax (25%),"+n.estimatedTax,"","Expenses by Category","Category,Amount",...Object.entries(n.expensesByCategory).map(([r,i])=>`"${r}",${i}`)].join(`
`);Eo("fliptrack-tax-q"+Ge+"-"+de+".csv",s)}else{let t=["FlipTrack Tax Report - "+de,"","Quarterly Summary","Quarter,Revenue,COGS,Gross Profit,Expenses,Net Profit,Estimated Tax"];for(let e=1;e<=4;e++){const{start:n,end:s}=Os(de,e),r=Wn(n,s);t.push(`Q${e},${r.revenue},${r.cogs},${r.grossProfit},${r.totalExpenses},${r.netProfit},${r.estimatedTax}`)}Eo("fliptrack-tax-"+de+".csv",t.join(`
`))}E("Tax report exported ")}function Eo(t,e){const n=new Blob([e],{type:"text/csv"}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)}async function ts(){const t=document.getElementById("taxContent");if(!t)return;await ol();const e=new Date(de,0,1),n=new Date(de,11,31,23,59,59),s=Wn(e,n);al(de);let r=null;if(Ge){const{start:d,end:u}=Os(de,Ge);r=Wn(d,u)}const i=`
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px">
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Total Revenue</div>
        <div style="font-size:20px;font-weight:700;color:var(--accent);font-family:'DM Mono',monospace">${w(s.revenue)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${s.saleCount} sales</div>
      </div>
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Total COGS</div>
        <div style="font-size:20px;font-weight:700;color:var(--muted);font-family:'DM Mono',monospace">${w(s.cogs)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${s.itemCount} items</div>
      </div>
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Net Profit</div>
        <div style="font-size:20px;font-weight:700;color:${s.netProfit>=0?"var(--good)":"var(--danger)"};font-family:'DM Mono',monospace">${w(s.netProfit)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">margin: ${s.revenue?(s.netProfit/s.revenue*100).toFixed(1):0}%</div>
      </div>
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;border-color:var(--warn)">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Est. Tax (25%)</div>
        <div style="font-size:20px;font-weight:700;color:var(--warn);font-family:'DM Mono',monospace">${w(s.estimatedTax)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">quarterly avg: ${w(s.estimatedTax/4)}</div>
      </div>
    </div>
  `,o=`
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;align-items:center;padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
      <select onchange="taxSetYear(this.value)" style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:3px;font-family:'DM Mono',monospace;font-size:12px">
        <option value="2024" ${de===2024?"selected":""}>Tax Year 2024</option>
        <option value="2025" ${de===2025?"selected":""}>Tax Year 2025</option>
        <option value="2026" ${de===2026?"selected":""}>Tax Year 2026</option>
      </select>
      <button onclick="taxToggleScheduleC()" class="btn-secondary" style="padding:6px 12px;background:${Dn?"var(--accent2)":"var(--surface2)"};border:1px solid var(--border);color:white;border-radius:3px;cursor:pointer;font-weight:600;font-family:Syne,sans-serif;font-size:12px">${Dn?"Hide":"Show"} Schedule C</button>
      <button onclick="taxExportCSV()" class="btn-primary" style="padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600;font-family:Syne,sans-serif;font-size:12px">Export CSV</button>
    </div>
  `,a=`
    <div class="panel" style="margin-bottom:20px;padding:12px">
      <div class="panel-title" style="margin-bottom:12px">Quarterly Breakdown (${de})</div>
      ${Eg()}
      <div style="font-size:10px;color:var(--muted);text-align:center">Click a quarter to expand details</div>
    </div>
  `;let l="";r&&(l=`
      <div class="panel" style="margin-bottom:20px;padding:12px">
        <div class="panel-title" style="margin-bottom:12px">Q${Ge} Details</div>
        ${Dn?Ig(r):""}
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px">
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Revenue</div>
            <div style="font-size:16px;font-weight:700;color:var(--accent);font-family:'DM Mono',monospace">${w(r.revenue)}</div>
          </div>
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Gross Profit</div>
            <div style="font-size:16px;font-weight:700;color:var(--good);font-family:'DM Mono',monospace">${w(r.grossProfit)}</div>
          </div>
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Expenses</div>
            <div style="font-size:16px;font-weight:700;color:var(--danger);font-family:'DM Mono',monospace">${w(r.totalExpenses)}</div>
          </div>
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Net Profit</div>
            <div style="font-size:16px;font-weight:700;color:${r.netProfit>=0?"var(--good)":"var(--danger)"};font-family:'DM Mono',monospace">${w(r.netProfit)}</div>
          </div>
        </div>
      </div>
    `);const c=wg();t.innerHTML=`
    <div style="padding:16px 12px">
      ${i}
      ${o}
      ${a}
      ${l}
      ${c}
    </div>
  `}function ll(t,e,n="manual"){const s=_.find(r=>r.id===t);s&&(s.priceHistory||(s.priceHistory=[]),s.priceHistory.push({date:Date.now(),price:e,source:n}),s.priceHistory.length>50&&s.priceHistory.shift(),ve("inv",t),H())}function fi(t){const e=_.find(n=>n.id===t);return(e==null?void 0:e.priceHistory)||[]}function Cg(t){const e=fi(t);if(e.length<2)return"stable";const n=e.slice(-5),s=n[0].price,r=n[n.length-1].price;return r>s*1.02?"up":r<s*.98?"down":"stable"}function Pg(t){const e=fi(t);if(e.length<2)return'<div style="padding:10px;color:var(--muted);font-size:12px">No price history yet</div>';const n=e.slice(-20),s=n.map(l=>l.price),r=Math.min(...s),i=Math.max(...s),o=i-r||1;return`
    <div style="padding:8px;background:var(--surface2);border-radius:4px">
      <div style="display:flex;align-items:flex-end;height:40px;margin-bottom:6px;gap:2px">
        ${s.map(l=>{const c=(l-r)/o*100,d=l===s[s.length-1]?"var(--accent)":Cg(t)==="up"?"var(--good)":"var(--warn)";return`<div style="display:inline-block;width:4px;height:${Math.max(c,5)}%;background:${d};margin:0 1px;border-radius:2px" title="${w(l)}"></div>`}).join("")}
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
        <span>${w(r)}</span>
        <span>${w(i)}</span>
        <span style="font-weight:500;color:var(--text)">${n.length} changes</span>
      </div>
    </div>
  `}function Ag(t){const e=fi(t);return e.length?`
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead style="background:var(--surface2);border-bottom:2px solid var(--border)">
        <tr>
          <th style="padding:6px 8px;text-align:left;font-weight:500">Date</th>
          <th style="padding:6px 8px;text-align:right;font-weight:500">Price</th>
          <th style="padding:6px 8px;text-align:center;font-weight:500">Source</th>
        </tr>
      </thead>
      <tbody>${e.slice(-20).reverse().map(s=>{const r=s.source==="sold"?`<span style="font-size:10px;background:var(--danger);color:white;padding:2px 6px;border-radius:3px">${s.platform||"SOLD"}</span>`:s.source==="repricing"?'<span style="font-size:10px;background:var(--accent2);color:white;padding:2px 6px;border-radius:3px">AUTO</span>':"";return`
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:6px 8px;font-size:12px;color:var(--muted)">${me(s.date)}</td>
        <td style="padding:6px 8px;text-align:right;font-weight:500">${w(s.price)}</td>
        <td style="padding:6px 8px;text-align:center">${r}</td>
      </tr>
    `}).join("")}</tbody>
    </table>
  `:'<div style="padding:10px;color:var(--muted);font-size:12px">No price history</div>'}const Io=[{id:"rule_30day_drop",name:"10% drop after 30 days",active:!0,condition:{daysListed:30,noSalesDays:0,priceAbove:0,priceBelow:9999},action:{type:"percent_drop",value:10},platforms:[],categories:[]},{id:"rule_60day_drop",name:"20% drop after 60 days",active:!0,condition:{daysListed:60,noSalesDays:0,priceAbove:0,priceBelow:9999},action:{type:"percent_drop",value:20},platforms:[],categories:[]},{id:"rule_quick_sale",name:"5% raise if sold within 3 days",active:!0,condition:{daysListed:0,noSalesDays:0,priceAbove:0,priceBelow:9999},action:{type:"percent_raise",value:5},platforms:[],categories:[]}];let ot=[],To=!1;async function Og(){try{ot=await wt("repricing_rules")||Io.map(e=>({...e})),To=!0}catch(t){console.warn("Failed to load repricing rules:",t.message),ot=Io.map(e=>({...e})),To=!0}}function Dg(){return ot}function Rg(t){const e=t.id||"rule_"+Fe(),n={id:e,name:t.name||"New Rule",active:t.active!==!1,condition:t.condition||{daysListed:30,noSalesDays:0,priceAbove:0,priceBelow:9999},action:t.action||{type:"percent_drop",value:10},platforms:t.platforms||[],categories:t.categories||[]};return ot.push(n),gi(),e}function Bg(t){const e=ot.findIndex(n=>n.id===t);e!==-1&&(ot.splice(e,1),gi())}function gi(){Ye("repricing_rules",ot).catch(t=>console.warn("Failed to persist rules:",t))}function cl(){const t=[],e=Date.now();return _.forEach(n=>{!n.price||n.qty===0||ot.forEach(s=>{if(!s.active)return;if(s.platforms.length>0){const f=n.platforms||[];if(!s.platforms.some(m=>f.includes(m)))return}if(s.categories.length>0&&!s.categories.includes(n.category))return;const{daysListed:r,noSalesDays:i,priceAbove:o,priceBelow:a}=s.condition,{type:l,value:c}=s.action,d=n.createdAt||n.listedAt||0;if((e-d)/(24*36e5)<r||n.price<o||n.price>a)return;if(i>0){const f=C.filter(v=>v.itemId===n.id).sort((v,g)=>(g.soldAt||0)-(v.soldAt||0))[0];if(!f||(e-(f.soldAt||0))/(24*36e5)<i)return}let p=n.price;l==="percent_drop"?p=n.price*(1-c/100):l==="fixed_drop"?p=n.price-c:l==="percent_raise"&&(p=n.price*(1+c/100)),p=Math.round(p*100)/100,p!==n.price&&t.push({item:n,rule:s,currentPrice:n.price,suggestedPrice:p,reason:Lg(s)})})}),t}function Lg(t,e){const{type:n,value:s}=t.action;return`${n==="percent_drop"?`Drop ${s}%`:n==="fixed_drop"?`Drop $${s}`:`Raise ${s}%`}  ${t.name}`}function Mg(t){if(!t.length){E("No repricing suggestions to apply",!0);return}const e=t.map(n=>({itemId:n.item.id,oldPrice:n.item.price,newPrice:n.suggestedPrice,rule:n.rule.name}));zs("repricing",e),t.forEach(n=>{const s=n.item;ll(s.id,n.suggestedPrice,"repricing"),s.price=n.suggestedPrice,ve("inv",s.id)}),H(),J(),E(`Applied ${t.length} price adjustment${t.length>1?"s":""}`)}function jg(){const t=cl();if(!t.length)return`
      <div class="panel" style="text-align:center;padding:30px">
        <div style="font-size:14px;color:var(--muted);margin-bottom:10px">No repricing suggestions</div>
        <div style="font-size:12px;color:var(--muted)">All items are optimally priced</div>
      </div>
    `;const e=t.map((n,s)=>`
    <div style="display:grid;grid-template-columns:1fr 100px 100px 120px;gap:12px;align-items:center;padding:10px;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-weight:500;color:var(--text)">${x(n.item.name)}</div>
        <div style="font-size:11px;color:var(--muted)">${x(n.reason)}</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:12px;color:var(--warn)">${w(n.currentPrice)}</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:12px;color:var(--good);font-weight:500">${w(n.suggestedPrice)}</div>
        <div style="font-size:10px;color:var(--muted)">${Q((n.suggestedPrice-n.currentPrice)/n.currentPrice)}</div>
      </div>
      <button class="btn-primary" style="font-size:11px;padding:6px 10px" onclick="rpApplySingle('${n.item.id}', ${n.suggestedPrice})">Apply</button>
    </div>
  `).join("");return`
    <div class="panel">
      <div style="padding:10px;background:var(--surface2);border-bottom:2px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:500">${t.length} Price Suggestion${t.length>1?"s":""}</div>
          <div style="font-size:11px;color:var(--muted)">Review and apply individual adjustments</div>
        </div>
        <button class="btn-primary" onclick="rpApplyAll()">Apply All</button>
      </div>
      <div>
        ${e}
      </div>
    </div>
  `}function zg(){const t=Dg(),e=t.map(n=>`
    <div style="display:grid;grid-template-columns:1fr 120px 120px;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-weight:500;color:var(--text)">${x(n.name)}</div>
        <div style="font-size:11px;color:var(--muted)">
          ${n.condition.daysListed>0?`After ${n.condition.daysListed} days`:"Always"} 
          ${n.action.type==="percent_drop"?`${n.action.value}% drop`:n.action.type==="percent_raise"?`${n.action.value}% raise`:`$${n.action.value} drop`}
        </div>
      </div>
      <div style="text-align:center">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input type="checkbox" ${n.active?"checked":""} onchange="rpToggleRule('${n.id}')" style="cursor:pointer">
          <span style="font-size:12px">${n.active?"Active":"Inactive"}</span>
        </label>
      </div>
      <div style="text-align:right">
        <button class="btn-danger" style="font-size:11px;padding:5px 10px" onclick="rpDeleteRule('${n.id}')">Delete</button>
      </div>
    </div>
  `).join("");return`
    <div class="panel">
      <div style="padding:10px;background:var(--surface2);border-bottom:2px solid var(--border)">
        <div style="font-weight:500;margin-bottom:4px">Repricing Rules</div>
        <div style="font-size:11px;color:var(--muted)">${t.length} rule${t.length!==1?"s":""} configured</div>
      </div>
      <div>
        ${e}
      </div>
      <div style="padding:10px;background:var(--surface2);border-top:1px solid var(--border)">
        <button class="btn-secondary" style="width:100%;font-size:12px;padding:8px" onclick="alert('Add new rule feature coming soon')">+ Add New Rule</button>
      </div>
    </div>
  `}function Ng(t){Rg(t),E("Rule added"),J()}function Ug(t){confirm("Delete this repricing rule?")&&(Bg(t),E("Rule deleted"),J())}function qg(t){const e=ot.find(n=>n.id===t);e&&(e.active=!e.active,gi(),J())}function Fg(){const t=cl();if(!t.length){E("No suggestions to apply",!0);return}confirm(`Apply ${t.length} price adjustment${t.length>1?"s":""}?`)&&Mg(t)}function Hg(t,e){const n=_.find(s=>s.id===t);n&&(zs("price_change",{itemId:t,oldPrice:n.price}),ll(t,e,"repricing"),n.price=e,ve("inv",t),H(),J(),E("Price updated"))}let Ke=[],dl="",Fr="spent",dn=0;const br=50;let Hr=null;async function Wg(){const t=await wt("buyers");Ke=t?JSON.parse(t):[]}function ul(){Ye("buyers",JSON.stringify(Ke)).catch(()=>{})}function Vg(t){return Ke.find(e=>e.id===t)}function Gg(){const t=document.getElementById("buyer_name"),e=document.getElementById("buyer_email"),n=document.getElementById("buyer_phone"),s=document.getElementById("buyer_ebay"),r=document.getElementById("buyer_posh"),i=document.getElementById("buyer_merc"),o=document.getElementById("buyer_notes"),a=(t.value||"").trim();if(!a){E("Name required",!0);return}const l={id:Fe(),name:a,handles:{eBay:(s.value||"").trim(),Poshmark:(r.value||"").trim(),Mercari:(i.value||"").trim()},email:(e.value||"").trim(),phone:(n.value||"").trim(),notes:(o.value||"").trim(),createdAt:Date.now()};Ke.push(l),ul(),E(`${x(a)} added`),t.value="",e.value="",n.value="",s.value="",r.value="",i.value="",o.value="",_t()}function Kg(t){const e=Vg(t);if(!e||!confirm(`Delete ${x(e.name)}?`))return;const n=Ke.indexOf(e);Ke.splice(n,1),ul(),E(`${x(e.name)} deleted`),_t()}function Jg(t){Hr=Hr===t?null:t,_t()}function Yg(t){dl=(t||"").toLowerCase(),dn=0,_t()}function Qg(t){Fr=t,dn=0,_t()}function Xg(t,e){const n=C.find(s=>s.id===e);n&&(n.buyerId=t,H(),E("Sale linked to buyer"))}function _t(){const t=document.getElementById("buyersView");if(!t)return;const e=Ke.length,n=Ke.filter(c=>C.filter(u=>u.buyerId===c.id).length>1).length,s=Ke.reduce((c,d)=>{const u=C.filter(p=>p.buyerId===d.id).reduce((p,f)=>p+(f.price||0),0);return c+u},0),r=C.length?s/C.length:0,i=Ke.filter(c=>{const d=dl;return d?c.name.toLowerCase().includes(d)||c.email.toLowerCase().includes(d)||c.phone.includes(d)||Object.values(c.handles).some(u=>u.toLowerCase().includes(d)):!0});i.sort((c,d)=>{if(Fr==="name")return c.name.localeCompare(d.name);if(Fr==="recent")return d.createdAt-c.createdAt;const u=C.filter(f=>f.buyerId===c.id).reduce((f,m)=>f+(m.price||0),0);return C.filter(f=>f.buyerId===d.id).reduce((f,m)=>f+(m.price||0),0)-u});const o=i.slice(dn*br,(dn+1)*br);let a=`
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Buyer CRM</div>
      </div>

      <!-- Stats Strip -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;padding:12px;background:var(--surface2);border-bottom:1px solid var(--border)">
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Total Buyers</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent);margin-top:4px">${e}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Repeat</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent2);margin-top:4px">${n}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Total Spent</div>
          <div style="font-size:18px;font-weight:700;color:var(--good);margin-top:4px">${w(s)}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Avg Order</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent3);margin-top:4px">${w(r)}</div>
        </div>
      </div>

      <!-- Add Buyer Form -->
      <div style="padding:12px;background:var(--surface);border-bottom:1px solid var(--border)">
        <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:8px">Add Buyer</div>
        <div class="form-grid">
          <input id="buyer_name" placeholder="Full Name" class="fgrp" style="grid-column:1/-1">
          <input id="buyer_email" type="email" placeholder="Email" class="fgrp">
          <input id="buyer_phone" placeholder="Phone" class="fgrp">
          <input id="buyer_ebay" placeholder="eBay Handle" class="fgrp" style="grid-column:1/-1">
          <input id="buyer_posh" placeholder="Poshmark Handle" class="fgrp" style="grid-column:1/-1">
          <input id="buyer_merc" placeholder="Mercari Handle" class="fgrp" style="grid-column:1/-1">
          <textarea id="buyer_notes" placeholder="Notes" class="fgrp" style="grid-column:1/-1;height:60px;resize:none"></textarea>
          <button onclick="buyerAdd()" class="btn-primary" style="grid-column:1/-1;height:36px">Add</button>
        </div>
      </div>

      <!-- Search & Sort -->
      <div style="padding:12px;display:flex;gap:8px;border-bottom:1px solid var(--border)">
        <input
          type="search"
          placeholder="Search buyers..."
          class="fgrp"
          style="flex:1"
          onchange="buyerSetSearch(this.value)"
          oninput="buyerSetSearch(this.value)"
        >
        <select class="fgrp" style="width:120px" onchange="buyerSetSort(this.value)">
          <option value="spent">By Spent</option>
          <option value="recent">By Recent</option>
          <option value="name">By Name</option>
        </select>
      </div>

      <!-- Buyers List -->
      <div style="padding:12px">
        ${o.length===0?'<div class="empty-state">No buyers yet</div>':o.map(c=>{const d=C.filter(v=>v.buyerId===c.id).reduce((v,g)=>v+(g.price||0),0),u=C.filter(v=>v.buyerId===c.id).length,p=C.filter(v=>v.buyerId===c.id).sort((v,g)=>(g.date||0)-(v.date||0))[0],f=Hr===c.id,m=C.filter(v=>v.buyerId===c.id).sort((v,g)=>(g.date||0)-(v.date||0));return`
                <div style="border:1px solid var(--border);border-radius:4px;margin-bottom:8px;overflow:hidden">
                  <!-- Header -->
                  <div
                    style="padding:12px;background:var(--surface2);cursor:pointer;display:flex;justify-content:space-between;align-items:center"
                    onclick="buyerExpand('${c.id}')"
                  >
                    <div>
                      <div style="font-weight:600;color:var(--text)">${x(c.name)}</div>
                      <div style="font-size:11px;color:var(--muted);margin-top:2px">
                        ${c.email?x(c.email)+"  ":""}
                        ${Object.entries(c.handles).filter(([,v])=>v).map(([v,g])=>`${v}: ${x(g)}`).join("  ")}
                      </div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-size:14px;font-weight:700;color:var(--good)">${w(d)}</div>
                      <div style="font-size:11px;color:var(--muted)">${u} purchase${u!==1?"s":""}</div>
                    </div>
                  </div>

                  <!-- Expanded Content -->
                  ${f?`
                    <div style="border-top:1px solid var(--border);padding:12px;background:var(--surface)">
                      ${c.notes?`<div style="padding:8px;background:var(--surface2);border-radius:2px;margin-bottom:8px"><strong>Notes:</strong> ${x(c.notes)}</div>`:""}
                      <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:600">Last Purchase: ${p?me(p.date||Date.now()):""}</div>

                      ${m.length>0?`
                        <div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:6px">Purchase History:</div>
                        <div class="inv-table">
                          <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:8px;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;padding-bottom:4px;border-bottom:1px solid var(--border)">
                            <div>Item</div>
                            <div style="text-align:right">Price</div>
                            <div style="text-align:right">Date</div>
                          </div>
                          ${m.map(v=>{const g=te(v.itemId);return`
                              <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:8px;font-size:11px;padding:6px 0;border-bottom:1px solid var(--border);align-items:center">
                                <div style="color:var(--text)">${g?x(g.name):"Unknown Item"}</div>
                                <div style="text-align:right;color:var(--good);font-weight:600">${w(v.price||0)}</div>
                                <div style="text-align:right;color:var(--muted);font-size:10px">${me(v.date||Date.now())}</div>
                              </div>
                            `}).join("")}
                        </div>
                      `:'<div style="font-size:11px;color:var(--muted)">No purchases linked</div>'}

                      <button onclick="buyerDelete('${c.id}')" class="btn-danger" style="margin-top:8px;width:100%;height:32px;font-size:11px">Delete Buyer</button>
                    </div>
                  `:""}
                </div>
              `}).join("")}
      </div>

      <!-- Pagination -->
      <div id="buyersPagination"></div>
    </div>
  `;t.innerHTML=a;const l=document.getElementById("buyersPagination");mn(l,{page:dn,totalItems:i.length,pageSize:br,onPage:c=>{dn=c,_t()}})}let xe=[];async function Zg(){const t=await wt("offers");xe=t?JSON.parse(t):[]}function mi(){Ye("offers",JSON.stringify(xe)).catch(()=>{})}function em(t){const e={id:t.id||Fe(),itemId:t.itemId,platform:t.platform||"",amount:t.amount||0,buyerHandle:t.buyerHandle||"",buyerId:t.buyerId||null,date:t.date||Date.now(),status:t.status||"pending",counterAmount:t.counterAmount||null,notes:t.notes||"",createdAt:Date.now()};return xe.push(e),mi(),e}function vi(t,e){const n=xe.find(s=>s.id===t);return n?(Object.assign(n,e),mi(),n):null}function tm(t){const e=xe.findIndex(n=>n.id===t);return e===-1?!1:(xe.splice(e,1),mi(),!0)}function nm(){return xe.filter(t=>t.status==="pending").length}function sm(t){return xe.filter(e=>e.itemId===t).sort((e,n)=>(n.date||0)-(e.date||0))}function rm(t){const e=sm(t);return e.length===0?'<div style="font-size:11px;color:var(--muted)">No offers yet</div>':`
    <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:8px">Offer History</div>
    <div class="inv-table">
      ${e.map(n=>`
        <div style="display:grid;grid-template-columns:1fr;gap:8px;padding:8px;background:var(--surface2);border-radius:2px;margin-bottom:6px;border-left:3px solid ${n.status==="accepted"?"var(--good)":n.status==="rejected"?"var(--danger)":n.status==="countered"?"var(--accent)":n.status==="expired"?"var(--muted)":"var(--accent2)"}">
          <div style="display:flex;justify-content:space-between;align-items:baseline">
            <div style="font-weight:600">${w(n.amount)}</div>
            <div style="font-size:10px;color:var(--muted)">${me(n.date||Date.now())}</div>
          </div>
          <div style="font-size:10px;color:var(--muted)">
            ${x(n.platform)}  ${x(n.buyerHandle||"Unknown")}
            ${n.status!=="pending"?`  <strong>${x(n.status.toUpperCase())}</strong>`:""}
          </div>
          ${n.counterAmount?`<div style="font-size:10px;color:var(--accent)">Counter: ${w(n.counterAmount)}</div>`:""}
          ${n.notes?`<div style="font-size:10px;color:var(--muted);font-style:italic">${x(n.notes)}</div>`:""}
        </div>
      `).join("")}
    </div>
  `}function im(){const t=xe.filter(r=>r.status==="pending").sort((r,i)=>(i.date||0)-(r.date||0)).slice(0,20),e=nm(),n=xe.filter(r=>r.status==="accepted").length,s=xe.filter(r=>r.status==="rejected").length;return`
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Offers</div>
        <div style="font-size:14px;font-weight:700;color:var(--accent2)">${e}</div>
      </div>

      <!-- Stats -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:11px">
        <div style="text-align:center">
          <div style="color:var(--muted);font-weight:600;text-transform:uppercase;font-size:9px">Pending</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent2);margin-top:2px">${e}</div>
        </div>
        <div style="text-align:center">
          <div style="color:var(--muted);font-weight:600;text-transform:uppercase;font-size:9px">Accepted</div>
          <div style="font-size:18px;font-weight:700;color:var(--good);margin-top:2px">${n}</div>
        </div>
        <div style="text-align:center">
          <div style="color:var(--muted);font-weight:600;text-transform:uppercase;font-size:9px">Rejected</div>
          <div style="font-size:18px;font-weight:700;color:var(--danger);margin-top:2px">${s}</div>
        </div>
      </div>

      <!-- Pending Offers List -->
      <div style="padding:12px">
        ${t.length===0?'<div class="empty-state">No pending offers</div>':t.map(r=>{const i=te(r.itemId);return`
                <div style="border:1px solid var(--border);border-radius:4px;padding:10px;margin-bottom:8px;background:var(--surface2)">
                  <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px">
                    <div style="font-weight:600;color:var(--text);font-size:12px">${i?x(i.name):"Unknown Item"}</div>
                    <div style="font-size:14px;font-weight:700;color:var(--good)">${w(r.amount)}</div>
                  </div>
                  <div style="font-size:10px;color:var(--muted);margin-bottom:6px">
                    ${x(r.platform)}  ${x(r.buyerHandle||"Unknown")}  ${me(r.date||Date.now())}
                  </div>
                  ${r.notes?`<div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-style:italic">${x(r.notes)}</div>`:""}
                  <div style="display:flex;gap:6px">
                    <button onclick="offerAccept('${r.id}')" class="btn-primary" style="flex:1;height:28px;font-size:10px">Accept</button>
                    <button onclick="offerCounter('${r.id}')" class="btn-secondary" style="flex:1;height:28px;font-size:10px">Counter</button>
                    <button onclick="offerReject('${r.id}')" class="btn-danger" style="flex:1;height:28px;font-size:10px">Reject</button>
                  </div>
                </div>
              `}).join("")}
      </div>
    </div>
  `}function om(t){const e=te(t);if(!e){E("Item not found",!0);return}const n=`
    <div style="padding:12px">
      <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:8px">Record Offer</div>
      <div class="form-grid">
        <input id="offer_platform" placeholder="Platform (eBay, Poshmark...)" class="fgrp" style="grid-column:1/-1">
        <input id="offer_amount" type="number" placeholder="Offer Amount" step="0.01" class="fgrp" style="grid-column:1/-1">
        <input id="offer_buyer" placeholder="Buyer Handle" class="fgrp" style="grid-column:1/-1">
        <textarea id="offer_notes" placeholder="Notes (optional)" class="fgrp" style="grid-column:1/-1;height:60px;resize:none"></textarea>
        <button onclick="offerAddConfirm('${t}')" class="btn-primary" style="grid-column:1/-1;height:36px">Add Offer</button>
        <button onclick="this.closest('.panel').remove()" class="btn-secondary" style="grid-column:1/-1;height:36px">Cancel</button>
      </div>
    </div>
  `,s=document.createElement("div");s.className="panel",s.innerHTML=`
    <div class="panel-header"><div class="panel-title">New Offer  ${x(e.name)}</div></div>
    ${n}
  `,document.body.appendChild(s)}function am(t){const e=document.getElementById("offer_platform"),n=document.getElementById("offer_amount"),s=document.getElementById("offer_buyer"),r=document.getElementById("offer_notes"),i=(e.value||"").trim(),o=parseFloat(n.value)||0,a=(s.value||"").trim();if(!i){E("Platform required",!0);return}if(!o){E("Amount required",!0);return}if(!a){E("Buyer handle required",!0);return}em({itemId:t,platform:i,amount:o,buyerHandle:a,notes:(r.value||"").trim()}),E("Offer recorded"),document.querySelector(".panel-header").closest(".panel").remove()}function lm(t){const e=xe.find(n=>n.id===t);if(!e){E("Offer not found",!0);return}vi(t,{status:"accepted"}),E(`Offer accepted: ${w(e.amount)}`)}function cm(t){if(!xe.find(n=>n.id===t)){E("Offer not found",!0);return}vi(t,{status:"rejected"}),E("Offer rejected")}function dm(t){const e=xe.find(r=>r.id===t);if(!e){E("Offer not found",!0);return}const n=prompt(`Counter offer for ${x(e.buyerHandle)} (current: ${w(e.amount)}):`,w(e.amount));if(!n)return;const s=parseFloat(n);if(isNaN(s)){E("Invalid amount",!0);return}vi(t,{status:"countered",counterAmount:s}),E(`Counter offer sent: ${w(s)}`)}function um(t){confirm("Delete offer?")&&(tm(t),E("Offer deleted"))}function pm(t,e,n=30){const s=new Date;s.setDate(s.getDate()-n);const r=e.reduce((a,l)=>new Date(l.sold_date)>=s?a+l.quantity:a,0),i=t.reduce((a,l)=>new Date(l.listed_date)>=s?a+l.quantity:a,0),o=i>0?r/i*100:0;return{rate:Math.round(o*10)/10,units_sold:r,units_listed:i,days:n}}function hm(t,e,n){const s=e.reduce((a,l)=>{const c=t.find(d=>d.id===l.item_id);return a+(c?c.cost*l.quantity:0)},0),r=t.length>0?t.reduce((a,l)=>a+l.cost*l.quantity,0)/t.length:0,i=r>0?s/r:0,o=Math.round(i*10)/10;return{turnover_rate:o,cogs:s,avg_inventory_value:Math.round(r*100)/100,times_per_year:o}}function fm(t,e,n){const s=t.reduce((l,c)=>l+c.cost*c.quantity,0),r=e.reduce((l,c)=>l+c.revenue,0),i=r-n.total,o=e.length>0?i/Math.max(1,Math.floor((new Date-new Date(e[0].sold_date))/(1e3*60*60*24))):0;return{days_to_breakeven:o>0?Math.ceil((s-i)/o):null,current_invested:Math.round(s*100)/100,current_revenue:Math.round(r*100)/100,daily_net:Math.round(o*100)/100}}function gm(t,e=12){const n={};return t.forEach(s=>{const r=new Date(s.sold_date),i=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;n[i]||(n[i]={revenue:0,cost:0,units:0,count:0}),n[i].revenue+=s.revenue||0,n[i].cost+=s.cost||0,n[i].units+=s.quantity||1,n[i].count+=1}),Object.entries(n).sort(([s],[r])=>s.localeCompare(r)).slice(-e).map(([s,r])=>({month:s,revenue:Math.round(r.revenue*100)/100,profit:Math.round((r.revenue-r.cost)*100)/100,units:r.units,yoy_change:0}))}function mm(t,e){const n={};return e.forEach(s=>{const r=t.find(c=>c.id===s.item_id);if(!r)return;const i=`${s.platform}-${r.category}`;n[i]||(n[i]={platform:s.platform,category:r.category,days:[],revenue:0,cost:0,count:0});const o=new Date(r.listed_date),a=new Date(s.sold_date),l=Math.floor((a-o)/(1e3*60*60*24));n[i].days.push(l),n[i].revenue+=s.revenue||0,n[i].cost+=r.cost*s.quantity,n[i].count+=1}),Object.values(n).map(s=>({platform:s.platform,category:s.category,avgDaysToSell:Math.round(s.days.reduce((r,i)=>r+i,0)/s.days.length),revenue:Math.round(s.revenue*100)/100,margin:s.revenue>0?Math.round((s.revenue-s.cost)/s.revenue*1e3)/10:0}))}function vm(t,e){var r;const n={};e.forEach(i=>{const o=t.find(a=>a.id===i.item_id);o&&(n[o.category]||(n[o.category]={units:0,revenue:0,items_listed:0}),n[o.category].units+=i.quantity||1,n[o.category].revenue+=i.revenue||0)}),t.forEach(i=>{n[i.category]||(n[i.category]={units:0,revenue:0,items_listed:0}),n[i.category].items_listed+=i.quantity});const s=Math.max(1,Math.ceil((new Date-new Date(((r=e[0])==null?void 0:r.sold_date)||Date.now()))/(1e3*60*60*24*30)));return Object.entries(n).map(([i,o])=>({category:i,units_per_month:Math.round(o.units/s*10)/10,monthly_revenue:Math.round(o.revenue/s*100)/100,sell_through_rate:o.items_listed>0?Math.round(o.units/o.items_listed*1e3)/10:0}))}function ym(t,e){const n={0:{name:"Sunday",units:0,profit:0},1:{name:"Monday",units:0,profit:0},2:{name:"Tuesday",units:0,profit:0},3:{name:"Wednesday",units:0,profit:0},4:{name:"Thursday",units:0,profit:0},5:{name:"Friday",units:0,profit:0},6:{name:"Saturday",units:0,profit:0}};return t.forEach(s=>{const r=e.find(l=>l.id===s.item_id),o=new Date(s.sold_date).getDay(),a=(s.revenue||0)-(r?r.cost*s.quantity:0);n[o].units+=s.quantity||1,n[o].profit+=a}),Object.values(n).map(s=>({day:s.name,units_sold:s.units,total_profit:Math.round(s.profit*100)/100,avg_profit_per_unit:s.units>0?Math.round(s.profit/s.units*100)/100:0}))}function bm(t){const e={0:0,1:0,2:0,3:0,4:0,5:0,6:0};t.forEach(r=>{const i=new Date(r.sold_date),o=new Date(i.getTime()-Math.random()*7*24*60*60*1e3).getDay();e[o]+=r.revenue||0});const n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s=Object.entries(e).reduce((r,[i,o])=>o>r[1]?[parseInt(i),o]:r);return{day_of_week:n[s[0]],revenue_correlation:Math.round(s[1]),confidence:Math.min(100,Math.round(s[1]/Math.max(...Object.values(e))*100))}}function wm(t,e=30){const n={};t.forEach(c=>{const u=new Date(c.sold_date).toISOString().split("T")[0];n[u]||(n[u]=0),n[u]+=c.revenue||0});const s=Object.values(n),r=s.length>0?s.reduce((c,d)=>c+d,0)/s.length:0,i=s.length>0?s.reduce((c,d)=>c+Math.pow(d-r,2),0)/s.length:0,o=Math.sqrt(i),a=r*e,l=Math.round(o*1.96);return{daily_average:Math.round(r*100)/100,projected_revenue:Math.round(a*100)/100,confidence_interval:Math.round(l*100)/100,days_ahead:e}}function xm(t,e,n){const s=t.reduce((d,u)=>d+u.cost*u.quantity,0),r=n.total||0,i=s+r,o=e.reduce((d,u)=>d+(u.quantity||1),0),a=o>0?(e.reduce((d,u)=>d+(u.revenue||0),0)-e.reduce((d,u)=>{const p=t.find(f=>f.id===u.item_id);return d+(p?p.cost*u.quantity:0)},0))/o:0,l=a>0?Math.ceil(i/a):null,c=l?Math.max(0,l-o):null;return{units_needed:l,units_already_sold:o,breakeven_revenue:Math.round(i*100)/100,gap:c,avg_profit_per_unit:Math.round(a*100)/100}}const wr={};function Ht(t,e){return async()=>(wr[t]||(wr[t]=await e()),wr[t])}const yi=Ht("scanner",()=>dt(()=>import("./scanner-glgnWlSs.js"),[],import.meta.url)),vn=Ht("batch-scan",()=>dt(()=>import("./batch-scan-YW8omvHw.js"),[],import.meta.url)),yn=Ht("price-research",()=>dt(()=>import("./price-research-BA2yrGD_.js"),[],import.meta.url)),Wt=Ht("identify",()=>dt(()=>import("./identify-BKP9EkDd.js"),[],import.meta.url)),ae=Ht("images",()=>dt(()=>Promise.resolve().then(()=>Qp),void 0,import.meta.url)),_m=Ht("barcodes",()=>dt(()=>import("./barcodes-CFyThy8S.js"),[],import.meta.url)),bi=Ht("csv",()=>dt(()=>import("./csv-DyGGqgjG.js"),[],import.meta.url)),N=(t,e)=>async(...n)=>(await t())[e](...n),Sm=N(yi,"openScanner"),km=N(yi,"closeScanner"),$m=N(yi,"switchCamera"),Em=N(yn,"openPriceResearch"),Im=N(yn,"closePriceResearch"),Tm=N(yn,"prSwitchTab"),Cm=N(yn,"openPriceScanner"),Pm=N(yn,"lookupPrices"),Am=N(yn,"lookupByKeyword"),Om=N(ae,"imgSlotChange"),Dm=N(ae,"imgSlotRemove"),Rm=N(ae,"refreshImgSlots"),Bm=N(ae,"renderAddFormImages"),Lm=N(ae,"renderDrawerImg"),Mm=N(ae,"imgDragOver"),jm=N(ae,"imgDragLeave"),zm=N(ae,"imgDrop"),Nm=N(ae,"openLightbox"),Um=N(ae,"openLightboxUrl"),qm=N(ae,"closeLightbox"),Fm=N(ae,"openCropModal"),Hm=N(ae,"cropDraw"),Wm=N(ae,"cropConfirm"),Vm=N(ae,"cropCancel"),Gm=N(ae,"cropReset"),Km=N(ae,"cropSetAspect"),Jm=N(Wt,"openIdentify"),Ym=N(Wt,"closeIdentify"),Qm=N(Wt,"idHandleCapture"),Xm=N(Wt,"idRetake"),Zm=N(Wt,"idAnalyze"),ev=N(Wt,"idAddToInventory"),tv=N(Wt,"idSearchPrices"),nv=N(vn,"openBatchScan"),sv=N(vn,"closeBatchScan"),rv=N(vn,"batchAddScanned"),iv=N(vn,"batchManualAdd"),ov=N(vn,"batchRemoveItem"),av=N(vn,"batchAddAll"),lv=N(bi,"exportCSV"),cv=N(bi,"exportAll"),dv=N(bi,"importCSV"),uv=N(_m,"printStickers");Object.assign(window,{toggleTheme:mv,applyFontSize:wi,setFsPreset:vv,toggleFsPopover:yv,setFont:fl});Object.assign(window,{switchView:ns,goToBreakdown:hv,goToReports:fv,goToStockAlert:gv,clearStockFilt:pl,bnav:Ws,toggleBnavMore:tf,closeBnavMore:nf});Object.assign(window,{switchAuthTab:Xo,authSubmit:Mu,authForgotPassword:ju,authSignOut:zu,openAccountMenu:Uu,closeAccountMenu:Zo,syncNow:Kr,mobileSyncNow:Ju});Object.assign(window,{renderInv:ye,buildChips:Da,setPlatFilt:eh,setCatFilt:th,setSubcatFilt:nh,setSubsubcatFilt:ih,setSort:oh,startPriceEdit:lh,adjStock:ch,dStart:dh,dOver:uh,dDrop:ph,toggleSel:hh,toggleAll:fh,clearSel:gh,clearStockFilt:pl,bulkDel:mh,bulkSold:vh,toggleFilterPanel:Xp,_debouncedRenderInv:lp});Object.assign(window,{openDrawer:Pp,closeDrawer:qs,drawerTab:Ap,saveDrawer:Dp,delCurrent:Rp,delItem:Nh,syncDrawerSubcat:Ep,syncDrawerSubtype:Ip,syncAddSubcat:Tp,syncAddSubtype:Cp,setCondTag:Bp,toggleBulkFields:Jh});Object.assign(window,{openAddModal:Kh,closeAdd:qa,addItem:Qh,dupCurrent:Gh,dupItem:Na,addFormTab:Ua,prevProfit:Fa,prefillFromLast:Yh});Object.assign(window,{openSoldModal:wh,closeSold:Nr,sPriceType:Ba,updateSalePriceHint:La,updateFeeEstimate:Ma,recSale:$h,renderSalesView:Ft,delSale:zh,setSalesSearch:xh,setSalesDateFrom:_h,setSalesDateTo:Sh,clearSalesFilters:kh});Object.assign(window,{addExpense:Dh,delExpense:Rh,renderExpenses:xt,setDefaultExpDate:ja,setExpSearch:Th,setExpDateFrom:Ch,setExpDateTo:Ph,clearExpFilters:Ah});Object.assign(window,{addSupply:Fh,updateSupplyQty:Hh,setSupplyQty:Wh,delSupply:Vh,renderSupplies:es});Object.assign(window,{openTrashModal:Zh,closeTrashModal:Ha,emptyTrash:ef,openMaterialsModal:Ra,confirmMaterials:yh,skipMaterials:bh,performUndo:oa});Object.assign(window,{openScanner:Sm,closeScanner:km,switchCamera:$m,openPriceResearch:Em,closePriceResearch:Im,prSwitchTab:Tm,openPriceScanner:Cm,lookupPrices:Pm,lookupByKeyword:Am,openIdentify:Jm,closeIdentify:Ym,idHandleCapture:Qm,idRetake:Xm,idAnalyze:Zm,idAddToInventory:ev,idSearchPrices:tv});Object.assign(window,{imgSlotChange:Om,imgSlotRemove:Dm,refreshImgSlots:Rm,imgDragOver:Mm,imgDragLeave:jm,imgDrop:zm,openLightbox:Nm,openLightboxUrl:Um,closeLightbox:qm,openCropModal:Fm,cropDraw:Hm,cropConfirm:Wm,cropCancel:Vm,cropReset:Gm,cropSetAspect:Km,renderAddFormImages:Bm,renderDrawerImg:Lm});Object.assign(window,{openBatchScan:nv,closeBatchScan:sv,batchAddScanned:rv,batchManualAdd:iv,batchRemoveItem:ov,batchAddAll:av,printStickers:uv,exportAll:cv,exportCSV:lv,importCSV:dv});Object.assign(window,{lookupISBN:up,calcFBA:pp,updateRankDisplay:da,toggleBookFields:Qn,setDimUnit:If,updateDimWeight:Ja,suggestPackaging:Ya,quickReprice:jp});Object.assign(window,{markDirty:ve,markDeleted:Xr});Object.assign(window,{renderCrosslistDashboard:Ce,clSwitchTab:gf,clSetSearch:mf,clSetPlatFilter:vf,clSetStatusFilter:yf,clRelistItem:bf,clDelistItem:wf,clCycleStatus:xf,clOpenLink:_f,clCopyListing:Sf,clBulkRelistExpired:kf,clAddTemplate:$f,clDeleteTemplate:Ef,markPlatformStatus:Ns,relistItem:Us,copyListingText:ba,clRelistFromDrawer:pv});Object.assign(window,{renderShippingView:_e,shipSetSearch:zf,shipSetPlatFilter:Nf,shipSetStatusFilter:Uf,shipSetDateFrom:qf,shipSetDateTo:Ff,shipClearFilters:Hf,shipToggleSel:Wf,shipToggleAll:Vf,shipClearSel:Gf,shipMarkShipped:Kf,shipConfirmShipped:Jf,shipCancelMark:Yf,shipBatchMark:Qf,shipConfirmBatchMark:Xf,shipCancelBatchMark:Zf,shipPrintSlip:eg,shipPrintBatchSlips:tg,shipExportLog:ng,printPackingSlip:el,openPackingSlipSettings:Mf,closePackingSlipSettings:sl,savePackingSlipSettings:jf,estimateShippingRate:Qa,suggestPackage:di,getCarrierOptions:Af});Object.assign(window,{renderSourcingView:qe,addHaul:cg,deleteHaul:dg,expandHaul:ug,linkItemsToHaul:pg,confirmLinkItems:hg,closeItemLinkModal:il,unlinkItem:fg,srcSetSearch:gg,srcSetSort:mg});Object.assign(window,{renderTaxCenter:ts,taxSetYear:Sg,taxSetQuarter:kg,taxToggleScheduleC:$g,taxExportCSV:Tg,mileAddEntry:xg,mileDeleteEntry:_g});Object.assign(window,{renderPriceHistoryChart:Pg,renderPriceHistoryTable:Ag,renderRepricingSuggestions:jg,renderRepricingRulesManager:zg,rpAddRule:Ng,rpDeleteRule:Ug,rpToggleRule:qg,rpApplyAll:Fg,rpApplySingle:Hg});Object.assign(window,{renderBuyersView:_t,buyerAdd:Gg,buyerDelete:Kg,buyerExpand:Jg,buyerSetSearch:Yg,buyerSetSort:Qg,buyerLinkSale:Xg,renderOffersPanel:im,offerAdd:om,offerAddConfirm:am,offerAccept:lm,offerReject:cm,offerCounter:dm,offerDelete:um,renderItemOffers:rm});Object.assign(window,{calcSellThroughRate:pm,calcInventoryTurnRate:hm,calcCashFlowProjection:fm,calcSeasonalTrends:gm,calcPlatformComparison:mm,calcVelocityByCategory:vm,calcProfitByDayOfWeek:ym,calcBestListingDay:bm,calcRevenueForecasts:wm,calcBreakEvenAnalysis:xm});function pv(t,e){Us(t,e),H(),J(),E(`Relisted on ${e} `);const n=_.find(s=>s.id===t);n&&wa(n)}function ns(t,e){var n;document.querySelectorAll(".view").forEach(s=>s.classList.remove("active")),document.querySelectorAll(".nav-tab").forEach(s=>s.classList.remove("active")),(n=document.getElementById("view-"+t))==null||n.classList.add("active"),e&&e.classList.add("active"),t==="inventory"?ye():t==="sales"?Ft():t==="expenses"?xt():t==="supplies"?(es(),za()):t==="insights"?Ih():t==="reports"?Lh():t==="breakdown"?Uh():t==="dashboard"?zp():t==="crosslist"?Ce():t==="shipping"?_e():t==="sourcing"?qe():t==="tax"?ts():t==="buyers"&&_t()}window.switchView=ns;function hv(){const t=document.querySelectorAll(".nav-tab")[7];ns("breakdown",t),Ws("bn-more-breakdown")}function fv(){const t=document.querySelectorAll(".nav-tab")[6];ns("reports",t),Ws("bn-more-reports")}function gv(){sh("low");const t=document.querySelectorAll(".nav-tab")[1];ns("inventory",t),Ws("bn-inventory")}function pl(){rh()}function mv(){const t=document.body;t.classList.toggle("light");const e=t.classList.contains("light");localStorage.setItem("ft_theme",e?"light":"dark"),hl()}function hl(){const t=document.body.classList.contains("light"),e=document.getElementById("themeBtn");e&&(e.textContent=t?"":"")}function wi(t,e=!0){document.documentElement.style.setProperty("--fs",t),document.getElementById("fsSlider").value=t,document.querySelectorAll(".fs-preset").forEach(n=>{n.classList.toggle("active",parseInt(n.textContent==="Small"?80:n.textContent==="Default"?100:n.textContent==="Large"?115:130)===parseInt(t))}),e&&localStorage.setItem("ft_fs",t)}function vv(t){wi(t)}function yv(){var t;(t=document.getElementById("fsPopover"))==null||t.classList.toggle("on")}function fl(t,e=!0){var n,s,r,i;if(t==="dyslexic"){document.body.classList.add("font-dyslexic"),(n=document.getElementById("fopt-dyslexic"))==null||n.classList.add("active"),(s=document.getElementById("fopt-default"))==null||s.classList.remove("active");const o=document.getElementById("fopt-hint");o&&(o.style.display="")}else{document.body.classList.remove("font-dyslexic"),(r=document.getElementById("fopt-default"))==null||r.classList.add("active"),(i=document.getElementById("fopt-dyslexic"))==null||i.classList.remove("active");const o=document.getElementById("fopt-hint");o&&(o.style.display="none")}e&&localStorage.setItem("ft_font",t)}const bv=localStorage.getItem("ft_theme");bv==="light"&&document.body.classList.add("light");hl();const Co=localStorage.getItem("ft_fs");Co&&wi(Co,!1);const Po=localStorage.getItem("ft_font");Po&&fl(Po,!1);document.getElementById("currentDate").textContent=new Date().toLocaleDateString("en-US",{weekday:"short",month:"long",day:"numeric",year:"numeric"});ja();(async function(){try{await Xu()}catch(e){console.warn("FlipTrack: Store init error:",e.message)}js(),J(),Cs(),window.addEventListener("resize",Cs),window.addEventListener("online",pn),window.addEventListener("offline",pn),navigator.onLine||pn(),la(),qu(),Yu(),await Wa(),_p(),ma(),await Promise.all([lg(),ol(),Og(),Wg(),Zg(),Lf()]),sg()})();"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").catch(t=>console.warn("SW registration failed:",t))});export{Ds as _,H as a,gn as b,qt as c,G as e,X as g,_ as i,Q as p,J as r,C as s,E as t,Fe as u};
//# sourceMappingURL=index-TH1cq55f.js.map
