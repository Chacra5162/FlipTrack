{"version":3,"file":"identify-BKP9EkDd.js","sources":["../../src/features/identify.js"],"sourcesContent":["// ‚îÄ‚îÄ AI SNAP & IDENTIFY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nlet _idImageData = null;   // base64 image (no prefix)\nlet _idMediaType = 'image/jpeg';\nlet _idResult    = null;   // last identification result\n\nexport function openIdentify() {\n  document.getElementById('idOv').classList.add('on');\n  idRetake(); // reset to capture state\n}\n\nexport function closeIdentify() {\n  document.getElementById('idOv').classList.remove('on');\n  _idImageData = null;\n  _idResult    = null;\n}\n\nexport function idHandleCapture(event) {\n  const file = event.target.files[0];\n  event.target.value = '';\n  if (!file || !file.type.startsWith('image/')) return;\n\n  _idMediaType = file.type || 'image/jpeg';\n\n  const reader = new FileReader();\n  reader.onload = e => {\n    const dataUrl = e.target.result;\n    // Extract base64 data (strip the data:image/xxx;base64, prefix)\n    _idImageData = dataUrl.split(',')[1];\n\n    // Show preview\n    document.getElementById('idPrompt').style.display = 'none';\n    document.getElementById('idPreview').style.display = 'block';\n    document.getElementById('idPreviewImg').src = dataUrl;\n    document.getElementById('idCapture').classList.add('has-photo');\n    document.getElementById('idAnalyzeBtn').disabled = false;\n    document.getElementById('idResults').innerHTML = '';\n  };\n  reader.readAsDataURL(file);\n}\n\nexport function idRetake() {\n  _idImageData = null;\n  _idResult    = null;\n  document.getElementById('idPrompt').style.display = '';\n  document.getElementById('idPreview').style.display = 'none';\n  document.getElementById('idPreviewImg').src = '';\n  document.getElementById('idCapture').classList.remove('has-photo');\n  document.getElementById('idAnalyzeBtn').disabled = true;\n  document.getElementById('idResults').innerHTML = '';\n  // Reset file inputs\n  document.getElementById('idCameraInput').value = '';\n  document.getElementById('idGalleryInput').value = '';\n}\n\nexport async function idAnalyze() {\n  if (!_idImageData) return;\n  if (!_sb || !_currentUser) {\n    toast('Please sign in to use Identify', true);\n    return;\n  }\n\n  const btn = document.getElementById('idAnalyzeBtn');\n  const results = document.getElementById('idResults');\n  btn.disabled = true;\n  btn.textContent = '‚ú® Analyzing‚Ä¶';\n\n  results.innerHTML = `\n    <div class=\"id-loading\">\n      <div class=\"id-loading-spinner\"></div>\n      <div class=\"id-loading-text\">AI is analyzing your photo‚Ä¶</div>\n      <div class=\"id-loading-sub\">Identifying item, brand, and estimating value</div>\n    </div>`;\n\n  try {\n    // Compress image before sending ‚Äî resize to max 800px and reduce quality\n    const compressed = await idCompressForAI(_idImageData, _idMediaType);\n\n    const { data, error } = await _sb.functions.invoke('identify-item', {\n      body: { image: compressed.data, media_type: compressed.type }\n    });\n\n    if (error) throw new Error(error.message || 'Edge function error');\n    if (data?.error) throw new Error(data.error);\n\n    _idResult = data;\n    idRenderResults(data);\n  } catch (e) {\n    console.error('FlipTrack: identify error:', e);\n    results.innerHTML = `\n      <div class=\"id-error\">\n        <div>‚ö† ${escHtml(e.message || 'Failed to identify item')}</div>\n        <button class=\"id-capture-btn\" onclick=\"idAnalyze()\">Try Again</button>\n      </div>`;\n  } finally {\n    btn.disabled = false;\n    btn.textContent = '‚ú® Identify & Value This Item';\n  }\n}\n\n// Compress image to send to AI ‚Äî keep under ~500KB base64\nexport function idCompressForAI(base64Data, mediaType) {\n  return new Promise((resolve) => {\n    const img = new Image();\n    img.onload = () => {\n      const MAX_DIM = 800;\n      let w = img.width, h = img.height;\n      if (w > MAX_DIM || h > MAX_DIM) {\n        const scale = Math.min(MAX_DIM / w, MAX_DIM / h);\n        w = Math.round(w * scale);\n        h = Math.round(h * scale);\n      }\n      const canvas = document.createElement('canvas');\n      canvas.width = w; canvas.height = h;\n      canvas.getContext('2d').drawImage(img, 0, 0, w, h);\n      const compressed = canvas.toDataURL('image/jpeg', 0.75);\n      resolve({ data: compressed.split(',')[1], type: 'image/jpeg' });\n    };\n    img.onerror = () => resolve({ data: base64Data, type: mediaType }); // fallback\n    img.src = 'data:' + mediaType + ';base64,' + base64Data;\n  });\n}\n\nexport function idRenderResults(r) {\n  const el = document.getElementById('idResults');\n  const confCls = r.confidence === 'high' ? 'confidence-high' : r.confidence === 'medium' ? 'confidence-medium' : 'confidence-low';\n  const q = encodeURIComponent(r.searchTerms || r.name);\n\n  el.innerHTML = `\n    <div class=\"id-result\">\n      <div class=\"id-result-card\">\n        <div class=\"id-result-name\">${escHtml(r.name || 'Unknown Item')}</div>\n        ${r.brand ? `<div class=\"id-result-brand\">üè∑ ${escHtml(r.brand)}</div>` : ''}\n        ${r.details ? `<div class=\"id-result-details\">${escHtml(r.details)}</div>` : ''}\n        <div class=\"id-result-tags\">\n          ${r.category ? `<span class=\"id-result-tag\">${escHtml(r.category)}</span>` : ''}\n          ${r.subcategory ? `<span class=\"id-result-tag\">${escHtml(r.subcategory)}</span>` : ''}\n          ${r.condition ? `<span class=\"id-result-tag\">${escHtml(r.condition)}</span>` : ''}\n          <span class=\"id-result-tag ${confCls}\">${(r.confidence || 'unknown').toUpperCase()} CONFIDENCE</span>\n        </div>\n\n        <div class=\"id-value-bar\">\n          <div class=\"id-value-cell low\">\n            <div class=\"id-value-lbl\">Low</div>\n            <div class=\"id-value-amt\">${r.estimatedLow ? fmt(r.estimatedLow) : '‚Äî'}</div>\n          </div>\n          <div class=\"id-value-cell mid\">\n            <div class=\"id-value-lbl\">Typical</div>\n            <div class=\"id-value-amt\">${r.estimatedMid ? fmt(r.estimatedMid) : '‚Äî'}</div>\n          </div>\n          <div class=\"id-value-cell high\">\n            <div class=\"id-value-lbl\">Best Case</div>\n            <div class=\"id-value-amt\">${r.estimatedHigh ? fmt(r.estimatedHigh) : '‚Äî'}</div>\n          </div>\n        </div>\n\n        <div class=\"id-actions\">\n          <button class=\"id-action-btn primary\" onclick=\"idAddToInventory()\">+ Add to Inventory</button>\n          <button class=\"id-action-btn\" onclick=\"idSearchPrices()\">üîç Research Prices</button>\n        </div>\n      </div>\n\n      <div style=\"margin-top:8px\">\n        <div class=\"pr-section-hdr\">Quick Marketplace Search</div>\n        <div class=\"pr-search-links\">\n          <a class=\"pr-search-link\" href=\"https://www.ebay.com/sch/i.html?_nkw=${q}&LH_Sold=1&LH_Complete=1\" target=\"_blank\" rel=\"noopener\">\n            <svg viewBox=\"0 0 24 24\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg>\n            eBay Sold\n          </a>\n          <a class=\"pr-search-link\" href=\"https://www.ebay.com/sch/i.html?_nkw=${q}\" target=\"_blank\" rel=\"noopener\">\n            <svg viewBox=\"0 0 24 24\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg>\n            eBay Active\n          </a>\n          <a class=\"pr-search-link\" href=\"https://www.amazon.com/s?k=${q}\" target=\"_blank\" rel=\"noopener\">\n            <svg viewBox=\"0 0 24 24\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg>\n            Amazon\n          </a>\n          <a class=\"pr-search-link\" href=\"https://www.mercari.com/search/?keyword=${q}\" target=\"_blank\" rel=\"noopener\">\n            <svg viewBox=\"0 0 24 24\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg>\n            Mercari\n          </a>\n          <a class=\"pr-search-link\" href=\"https://www.google.com/search?q=${q}+sold+price+resell\" target=\"_blank\" rel=\"noopener\">\n            <svg viewBox=\"0 0 24 24\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg>\n            Google\n          </a>\n        </div>\n      </div>\n    </div>`;\n}\n\nexport function idAddToInventory() {\n  if (!_idResult) return;\n  closeIdentify();\n\n  // Switch to inventory view and open Add modal\n  const invTab = document.querySelectorAll('.nav-tab')[1];\n  switchView('inventory', invTab);\n\n  openAddModal();\n\n  // Pre-fill form fields from identification\n  setTimeout(() => {\n    const r = _idResult;\n    const nameEl = document.getElementById('f_name');\n    if (nameEl && r.name) nameEl.value = r.name;\n\n    const catEl = document.getElementById('f_cat');\n    if (catEl && r.category) { catEl.value = r.category; syncAddSubcat(); }\n\n    const subcatTxt = document.getElementById('f_subcat_txt');\n    if (subcatTxt && r.subcategory) subcatTxt.value = r.subcategory;\n\n    const priceEl = document.getElementById('f_price');\n    if (priceEl && r.estimatedMid) priceEl.value = r.estimatedMid;\n\n    // If we have the photo, set it as the item image\n    if (_idImageData) {\n      const dataUrl = 'data:' + _idMediaType + ';base64,' + _idImageData;\n      pendingAddImages = [dataUrl];\n      refreshImgSlots('f', pendingAddImages);\n    }\n\n    prevProfit();\n    toast('Pre-filled from AI identification ‚úì');\n  }, 150);\n}\n\nexport function idSearchPrices() {\n  if (!_idResult) return;\n  closeIdentify();\n  openPriceResearch();\n  // Switch to keyword tab and pre-fill\n  prSwitchTab('kw');\n  const kwInput = document.getElementById('prKwInput');\n  if (kwInput) kwInput.value = _idResult.searchTerms || _idResult.name;\n  lookupByKeyword();\n}\n"],"names":["_idImageData","_idMediaType","_idResult","openIdentify","idRetake","closeIdentify","idHandleCapture","event","file","reader","e","dataUrl","idAnalyze","btn","results","compressed","idCompressForAI","data","error","idRenderResults","base64Data","mediaType","resolve","img","w","h","scale","canvas","r","el","confCls","q","idAddToInventory","invTab","nameEl","catEl","subcatTxt","priceEl","idSearchPrices","kwInput"],"mappings":"AAEA,IAAIA,EAAe,KACfC,EAAe,aACfC,EAAe,KAEZ,SAASC,GAAe,CAC7B,SAAS,eAAe,MAAM,EAAE,UAAU,IAAI,IAAI,EAClDC,GACF,CAEO,SAASC,GAAgB,CAC9B,SAAS,eAAe,MAAM,EAAE,UAAU,OAAO,IAAI,EACrDL,EAAe,KACfE,EAAe,IACjB,CAEO,SAASI,EAAgBC,EAAO,CACrC,MAAMC,EAAOD,EAAM,OAAO,MAAM,CAAC,EAEjC,GADAA,EAAM,OAAO,MAAQ,GACjB,CAACC,GAAQ,CAACA,EAAK,KAAK,WAAW,QAAQ,EAAG,OAE9CP,EAAeO,EAAK,MAAQ,aAE5B,MAAMC,EAAS,IAAI,WACnBA,EAAO,OAASC,GAAK,CACnB,MAAMC,EAAUD,EAAE,OAAO,OAEzBV,EAAeW,EAAQ,MAAM,GAAG,EAAE,CAAC,EAGnC,SAAS,eAAe,UAAU,EAAE,MAAM,QAAU,OACpD,SAAS,eAAe,WAAW,EAAE,MAAM,QAAU,QACrD,SAAS,eAAe,cAAc,EAAE,IAAMA,EAC9C,SAAS,eAAe,WAAW,EAAE,UAAU,IAAI,WAAW,EAC9D,SAAS,eAAe,cAAc,EAAE,SAAW,GACnD,SAAS,eAAe,WAAW,EAAE,UAAY,EACnD,EACAF,EAAO,cAAcD,CAAI,CAC3B,CAEO,SAASJ,GAAW,CACzBJ,EAAe,KACfE,EAAe,KACf,SAAS,eAAe,UAAU,EAAE,MAAM,QAAU,GACpD,SAAS,eAAe,WAAW,EAAE,MAAM,QAAU,OACrD,SAAS,eAAe,cAAc,EAAE,IAAM,GAC9C,SAAS,eAAe,WAAW,EAAE,UAAU,OAAO,WAAW,EACjE,SAAS,eAAe,cAAc,EAAE,SAAW,GACnD,SAAS,eAAe,WAAW,EAAE,UAAY,GAEjD,SAAS,eAAe,eAAe,EAAE,MAAQ,GACjD,SAAS,eAAe,gBAAgB,EAAE,MAAQ,EACpD,CAEO,eAAeU,GAAY,CAChC,GAAI,CAACZ,EAAc,OACnB,GAAI,CAAC,KAAO,CAAC,aAAc,CACzB,MAAM,iCAAkC,EAAI,EAC5C,MACF,CAEA,MAAMa,EAAM,SAAS,eAAe,cAAc,EAC5CC,EAAU,SAAS,eAAe,WAAW,EACnDD,EAAI,SAAW,GACfA,EAAI,YAAc,eAElBC,EAAQ,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,YAOpB,GAAI,CAEF,MAAMC,EAAa,MAAMC,EAAgBhB,EAAcC,CAAY,EAE7D,CAAE,KAAAgB,EAAM,MAAAC,CAAK,EAAK,MAAM,IAAI,UAAU,OAAO,gBAAiB,CAClE,KAAM,CAAE,MAAOH,EAAW,KAAM,WAAYA,EAAW,IAAI,CACjE,CAAK,EAED,GAAIG,EAAO,MAAM,IAAI,MAAMA,EAAM,SAAW,qBAAqB,EACjE,GAAID,GAAA,MAAAA,EAAM,MAAO,MAAM,IAAI,MAAMA,EAAK,KAAK,EAE3Cf,EAAYe,EACZE,EAAgBF,CAAI,CACtB,OAASP,EAAG,CACV,QAAQ,MAAM,6BAA8BA,CAAC,EAC7CI,EAAQ,UAAY;AAAA;AAAA,iBAEP,QAAQJ,EAAE,SAAW,yBAAyB,CAAC;AAAA;AAAA,aAG9D,QAAC,CACCG,EAAI,SAAW,GACfA,EAAI,YAAc,8BACpB,CACF,CAGO,SAASG,EAAgBI,EAAYC,EAAW,CACrD,OAAO,IAAI,QAASC,GAAY,CAC9B,MAAMC,EAAM,IAAI,MAChBA,EAAI,OAAS,IAAM,CAEjB,IAAIC,EAAID,EAAI,MAAOE,EAAIF,EAAI,OAC3B,GAAIC,EAAI,KAAWC,EAAI,IAAS,CAC9B,MAAMC,EAAQ,KAAK,IAAI,IAAUF,EAAG,IAAUC,CAAC,EAC/CD,EAAI,KAAK,MAAMA,EAAIE,CAAK,EACxBD,EAAI,KAAK,MAAMA,EAAIC,CAAK,CAC1B,CACA,MAAMC,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,MAAQH,EAAGG,EAAO,OAASF,EAClCE,EAAO,WAAW,IAAI,EAAE,UAAUJ,EAAK,EAAG,EAAGC,EAAGC,CAAC,EACjD,MAAMV,EAAaY,EAAO,UAAU,aAAc,GAAI,EACtDL,EAAQ,CAAE,KAAMP,EAAW,MAAM,GAAG,EAAE,CAAC,EAAG,KAAM,aAAc,CAChE,EACAQ,EAAI,QAAU,IAAMD,EAAQ,CAAE,KAAMF,EAAY,KAAMC,CAAS,CAAE,EACjEE,EAAI,IAAM,QAAUF,EAAY,WAAaD,CAC/C,CAAC,CACH,CAEO,SAASD,EAAgBS,EAAG,CACjC,MAAMC,EAAK,SAAS,eAAe,WAAW,EACxCC,EAAUF,EAAE,aAAe,OAAS,kBAAoBA,EAAE,aAAe,SAAW,oBAAsB,iBAC1GG,EAAI,mBAAmBH,EAAE,aAAeA,EAAE,IAAI,EAEpDC,EAAG,UAAY;AAAA;AAAA;AAAA,sCAGqB,QAAQD,EAAE,MAAQ,cAAc,CAAC;AAAA,UAC7DA,EAAE,MAAQ,mCAAmC,QAAQA,EAAE,KAAK,CAAC,SAAW,EAAE;AAAA,UAC1EA,EAAE,QAAU,kCAAkC,QAAQA,EAAE,OAAO,CAAC,SAAW,EAAE;AAAA;AAAA,YAE3EA,EAAE,SAAW,+BAA+B,QAAQA,EAAE,QAAQ,CAAC,UAAY,EAAE;AAAA,YAC7EA,EAAE,YAAc,+BAA+B,QAAQA,EAAE,WAAW,CAAC,UAAY,EAAE;AAAA,YACnFA,EAAE,UAAY,+BAA+B,QAAQA,EAAE,SAAS,CAAC,UAAY,EAAE;AAAA,uCACpDE,CAAO,MAAMF,EAAE,YAAc,WAAW,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wCAMpDA,EAAE,aAAe,IAAIA,EAAE,YAAY,EAAI,GAAG;AAAA;AAAA;AAAA;AAAA,wCAI1CA,EAAE,aAAe,IAAIA,EAAE,YAAY,EAAI,GAAG;AAAA;AAAA;AAAA;AAAA,wCAI1CA,EAAE,cAAgB,IAAIA,EAAE,aAAa,EAAI,GAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iFAaHG,CAAC;AAAA;AAAA;AAAA;AAAA,iFAIDA,CAAC;AAAA;AAAA;AAAA;AAAA,uEAIXA,CAAC;AAAA;AAAA;AAAA;AAAA,oFAIYA,CAAC;AAAA;AAAA;AAAA;AAAA,4EAITA,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAO7E,CAEO,SAASC,GAAmB,CACjC,GAAI,CAAC9B,EAAW,OAChBG,EAAa,EAGb,MAAM4B,EAAS,SAAS,iBAAiB,UAAU,EAAE,CAAC,EACtD,WAAW,YAAaA,CAAM,EAE9B,aAAY,EAGZ,WAAW,IAAM,CACf,MAAML,EAAI1B,EACJgC,EAAS,SAAS,eAAe,QAAQ,EAC3CA,GAAUN,EAAE,OAAMM,EAAO,MAAQN,EAAE,MAEvC,MAAMO,EAAQ,SAAS,eAAe,OAAO,EACzCA,GAASP,EAAE,WAAYO,EAAM,MAAQP,EAAE,SAAU,cAAa,GAElE,MAAMQ,EAAY,SAAS,eAAe,cAAc,EACpDA,GAAaR,EAAE,cAAaQ,EAAU,MAAQR,EAAE,aAEpD,MAAMS,EAAU,SAAS,eAAe,SAAS,EAIjD,GAHIA,GAAWT,EAAE,eAAcS,EAAQ,MAAQT,EAAE,cAG7C5B,EAAc,CAChB,MAAMW,EAAU,QAAUV,EAAe,WAAaD,EACtD,iBAAmB,CAACW,CAAO,EAC3B,gBAAgB,IAAK,gBAAgB,CACvC,CAEA,WAAU,EACV,MAAM,qCAAqC,CAC7C,EAAG,GAAG,CACR,CAEO,SAAS2B,GAAiB,CAC/B,GAAI,CAACpC,EAAW,OAChBG,EAAa,EACb,kBAAiB,EAEjB,YAAY,IAAI,EAChB,MAAMkC,EAAU,SAAS,eAAe,WAAW,EAC/CA,IAASA,EAAQ,MAAQrC,EAAU,aAAeA,EAAU,MAChE,gBAAe,CACjB"}