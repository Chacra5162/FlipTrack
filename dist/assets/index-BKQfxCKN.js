(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const Au="modulepreload",Lu=function(t,e){return new URL(t,e).href},Aa={},ct=function(e,n,s){let i=Promise.resolve();if(n&&n.length>0){const r=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),c=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=Promise.allSettled(n.map(l=>{if(l=Lu(l,s),l in Aa)return;Aa[l]=!0;const d=l.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(!!s)for(let f=r.length-1;f>=0;f--){const g=r[f];if(g.href===l&&(!d||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${u}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Au,d||(h.as="script"),h.crossOrigin="",h.href=l,c&&h.setAttribute("nonce",c),document.head.appendChild(h),d)return new Promise((f,g)=>{h.addEventListener("load",f),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return i.then(r=>{for(const a of r||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})},Ui="https://gqructzvlkafclooybnc.supabase.co",Ru="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxcnVjdHp2bGthZmNsb295Ym5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODIyNTAsImV4cCI6MjA4Njk1ODI1MH0.-H5p1Oq-ImveB636xgWI-Rrc23wzj7-_Vps6xeHrHtA",yo=["Shirts","T-Shirts","Pants","Jeans","Shorts","Jackets","Hoodies","Sweaters","Dresses","Skirts","Socks","Underwear","Activewear","Swimwear","Outerwear","Suits","Loungewear"],Rl={Clothing:{subcats:{Men:yo,Women:yo,Children:yo,Footwear:["Men","Women","Children"],"Men's Accessories":[],"Women's Accessories":[]}},Books:{subcats:{Fiction:["Literary","Sci-Fi","Fantasy","Mystery","Thriller","Romance","Horror","Historical"],"Non-Fiction":["Biography","History","Science","Self-Help","Business","Travel","Cooking","Health"],Textbooks:["Math","Science","Engineering","Medicine","Law","Business","Humanities","Computer Science"],Children:["Picture Books","Middle Grade","Young Adult","Board Books","Activity Books"],"Rare & Collectible":["First Editions","Signed Copies","Antiquarian","Limited Editions"],"Comics & Graphic Novels":[],"Art & Photography":[],Reference:[]}}};Object.fromEntries(Object.entries(Rl).map(([t,e])=>[t,Object.keys(e.subcats)]));Object.fromEntries(Object.entries(Rl).flatMap(([,t])=>Object.entries(t.subcats).filter(([,e])=>e.length).map(([e,n])=>[e,n])));const Ml=["eBay","Amazon","Etsy","Facebook Marketplace","Depop","Poshmark","Mercari","Grailed","StockX","GOAT","Vinted","Tradesy","The RealReal","Vestiaire Collective","Reverb","Discogs","Craigslist","OfferUp","Nextdoor","Whatnot","TikTok Shop","Instagram","Shopify","Walmart Marketplace","Newegg","Bonanza","Ruby Lane","Chairish","1stDibs","Swappa","Decluttr","Unlisted","Other"],jl=[{label:"General",items:["eBay","Amazon","Etsy","Facebook Marketplace"]},{label:"Fashion",items:["Depop","Poshmark","Mercari","Grailed","StockX","GOAT","Vinted","Tradesy","The RealReal","Vestiaire Collective"]},{label:"Music",items:["Reverb","Discogs"]},{label:"Local",items:["Craigslist","OfferUp","Nextdoor"]},{label:"Social",items:["Whatnot","TikTok Shop","Instagram"]},{label:"Retail",items:["Shopify","Walmart Marketplace","Newegg","Bonanza","Ruby Lane","Chairish","1stDibs"]},{label:"Tech",items:["Swappa","Decluttr"]},{label:"Other",items:["Unlisted","Other"]}],Nl=t=>({eBay:"plt-ebay",Amazon:"plt-amazon",Etsy:"plt-etsy","Facebook Marketplace":"plt-fb",Depop:"plt-depop",Poshmark:"plt-poshmark",Mercari:"plt-mercari",Grailed:"plt-grailed",StockX:"plt-stockx",GOAT:"plt-goat",Vinted:"plt-vinted",Tradesy:"plt-tradesy","The RealReal":"plt-realreal","Vestiaire Collective":"plt-vestiaire",Reverb:"plt-reverb",Discogs:"plt-discogs",Craigslist:"plt-craigslist",OfferUp:"plt-offerup",Nextdoor:"plt-nextdoor",Whatnot:"plt-whatnot","TikTok Shop":"plt-tiktok",Instagram:"plt-instagram",Shopify:"plt-shopify","Walmart Marketplace":"plt-walmart",Newegg:"plt-newegg",Bonanza:"plt-bonanza","Ruby Lane":"plt-bonanza",Chairish:"plt-chairish","1stDibs":"plt-1stdibs",Swappa:"plt-swappa",Decluttr:"plt-decluttr"})[t]||"plt-other",_s={eBay:{pct:.1325,flat:.3,label:"13.25% + $0.30"},Amazon:{pct:.15,flat:0,label:"15% referral"},Etsy:{pct:.065,flat:.2,label:"6.5% + $0.20 + 3% processing",processing:.03},"Facebook Marketplace":{pct:.05,flat:0,label:"5% (or $0.40 min)"},Depop:{pct:.1,flat:0,label:"10%"},Poshmark:{pct:.2,flat:0,label:"20% (or $2.95 if under $15)"},Mercari:{pct:.1,flat:0,label:"10%"},Grailed:{pct:.09,flat:0,label:"9% + 3.49% processing",processing:.0349},StockX:{pct:.1,flat:0,label:"~10% (varies by level)"},GOAT:{pct:.095,flat:5,label:"9.5% + $5 cashout"},Vinted:{pct:0,flat:0,label:"0% seller fees (buyer pays)"},Tradesy:{pct:.198,flat:0,label:"19.8%"},"The RealReal":{pct:.45,flat:0,label:"45% avg commission"},"Vestiaire Collective":{pct:.15,flat:0,label:"15%"},Reverb:{pct:.05,flat:.25,label:"5% + $0.25"},Discogs:{pct:.08,flat:0,label:"8%"},Whatnot:{pct:.089,flat:0,label:"8.9%"},"TikTok Shop":{pct:.08,flat:0,label:"8%"},Shopify:{pct:.029,flat:.3,label:"2.9% + $0.30 processing"},"Walmart Marketplace":{pct:.15,flat:0,label:"15% referral"},Newegg:{pct:.12,flat:0,label:"8-15% (avg 12%)"},Swappa:{pct:.03,flat:0,label:"3% (buyer pays most)"}};function Mu(t,e){const n=_s[t];if(!n)return null;let s=e*n.pct+(n.flat||0);return n.processing&&(s+=e*n.processing),t==="Poshmark"&&e<15&&(s=2.95),t==="Facebook Marketplace"&&(s=Math.max(s,.4)),Math.round(s*100)/100}const vo=["Shirts","T-Shirts","Pants","Jeans","Shorts","Jackets","Hoodies","Sweaters","Dresses","Skirts","Socks","Underwear","Activewear","Swimwear","Outerwear","Suits","Loungewear"],zl={Clothing:{subcats:{Men:vo,Women:vo,Children:vo,Footwear:["Men","Women","Children"],"Men's Accessories":[],"Women's Accessories":[]}},Books:{subcats:{Fiction:["Literary","Sci-Fi","Fantasy","Mystery","Thriller","Romance","Horror","Historical"],"Non-Fiction":["Biography","History","Science","Self-Help","Business","Travel","Cooking","Health"],Textbooks:["Math","Science","Engineering","Medicine","Law","Business","Humanities","Computer Science"],Children:["Picture Books","Middle Grade","Young Adult","Board Books","Activity Books"],"Rare & Collectible":["First Editions","Signed Copies","Antiquarian","Limited Editions"],"Comics & Graphic Novels":[],"Art & Photography":[],Reference:[]}}},js=Object.fromEntries(Object.entries(zl).map(([t,e])=>[t,Object.keys(e.subcats)])),Ul=Object.fromEntries(Object.entries(zl).flatMap(([,t])=>Object.entries(t.subcats).filter(([,e])=>e.length).map(([e,n])=>[e,n]))),x=t=>"$"+Number(t||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),V=t=>(t*100).toFixed(1)+"%",ie=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6),ce=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),_=t=>{const e=document.createElement("div");return e.textContent=t,e.innerHTML};let Rn=null,os=null;function Fl(t){if(os=document.activeElement,Rn=document.querySelector(t),!Rn)return;const e=Rn.querySelectorAll('button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), a[href], [tabindex]:not([tabindex="-1"])');e.length&&e[0].focus(),document.addEventListener("keydown",ql)}function pr(){document.removeEventListener("keydown",ql),os&&os.focus&&os.focus(),Rn=null,os=null}function ql(t){if(!Rn)return;if(t.key==="Escape"){pr(),typeof window.closeDrawer=="function"&&window.closeDrawer(),typeof window.closeAdd=="function"&&window.closeAdd();return}if(t.key!=="Tab")return;const e=Rn.querySelectorAll('button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), a[href], [tabindex]:not([tabindex="-1"])');if(!e.length)return;const n=e[0],s=e[e.length-1];t.shiftKey&&document.activeElement===n?(t.preventDefault(),s.focus()):!t.shiftKey&&document.activeElement===s&&(t.preventDefault(),n.focus())}function k(t,e,n){const s=document.getElementById("toast");s&&(s.getAttribute("role")||(s.setAttribute("role","status"),s.setAttribute("aria-live","polite")),s.textContent=t,s.className="toast"+(e?" err":""),s.classList.add("on"),setTimeout(()=>s.classList.remove("on"),n||2300))}const ju=(()=>{let t=null;function e(){return t||(t=new(window.AudioContext||window.webkitAudioContext)),t.state==="suspended"&&t.resume(),t}function n(s,i,o,r,a,c,l){const d=e(),u=d.createOscillator(),p=d.createGain();u.connect(p),p.connect(d.destination),u.type=i,u.frequency.value=s,p.gain.setValueAtTime(o,d.currentTime+r),p.gain.linearRampToValueAtTime(0,d.currentTime+r+a),u.start(d.currentTime+r),u.stop(d.currentTime+r+a+.01)}return{create(){n(523.25,"sine",.18,0,.1),n(783.99,"sine",.18,.1,.14),navigator.vibrate&&navigator.vibrate([30,40,60])},edit(){n(440,"sine",.14,0,.08),n(554.37,"sine",.12,.07,.1),navigator.vibrate&&navigator.vibrate(25)},sale(){n(523.25,"triangle",.15,0,.07),n(659.25,"triangle",.15,.07,.07),n(783.99,"triangle",.16,.14,.07),n(1046.5,"triangle",.18,.21,.14),navigator.vibrate&&navigator.vibrate([20,30,20,30,80])},expense(){n(220,"sine",.2,0,.06),n(174.61,"sine",.16,.05,.12),navigator.vibrate&&navigator.vibrate([60,20,30])}}})(),Ns=ju,Nu="fliptrack",zu=1,Uu={inventory:{keyPath:"id"},sales:{keyPath:"id"},expenses:{keyPath:"id"},supplies:{keyPath:"id"},trash:{keyPath:"id"},meta:{keyPath:"key"}};let ht=null,on=!0;const Mo=[];let mi=!1;function Fu(){try{return!!(window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB)}catch{return!1}}function Ne(t,e){console.error(`[IDB ${t}]`,(e==null?void 0:e.message)||e)}async function qu(){for(;Mo.length>0;){const{resolve:t,reject:e,fn:n}=Mo.shift();try{const s=await n();t(s)}catch(s){e(s)}}}function zs(t){return new Promise((e,n)=>{ht!==null?t().then(e).catch(n):mi?Mo.push({resolve:e,reject:n,fn:t}):n(new Error("IndexedDB not initialized"))})}async function Hu(){if(ht!==null)return ht;if(!Fu())throw on=!1,new Error("IndexedDB is not available in this browser");return new Promise((t,e)=>{mi=!0;const n=indexedDB.open(Nu,zu);n.onerror=()=>{mi=!1,on=!1,Ne("open",n.error),e(n.error)},n.onsuccess=()=>{ht=n.result,mi=!1,qu(),t(ht)},n.onupgradeneeded=s=>{const i=s.target.result;Object.entries(Uu).forEach(([o,r])=>{if(!i.objectStoreNames.contains(o))try{i.createObjectStore(o,{keyPath:r.keyPath})}catch(a){Ne(`create store ${o}`,a)}})}})}async function es(t){return on?zs(async()=>new Promise((e,n)=>{try{const o=ht.transaction([t],"readonly").objectStore(t).getAll();o.onerror=()=>{Ne(`getAll ${t}`,o.error),n(o.error)},o.onsuccess=()=>{e(o.result)}}catch(s){Ne(`getAll ${t}`,s),n(s)}})):[]}async function Ye(t,e){if(on)return zs(async()=>new Promise((n,s)=>{try{const i=ht.transaction([t],"readwrite"),o=i.objectStore(t),r=o.clear();r.onerror=()=>{Ne(`putAll clear ${t}`,r.error),s(r.error)},r.onsuccess=()=>{e.forEach(a=>{try{o.add(a)}catch(c){Ne(`putAll add ${t}`,c)}})},i.onerror=()=>{Ne(`putAll transaction ${t}`,i.error),s(i.error)},i.oncomplete=()=>{n()}}catch(i){Ne(`putAll ${t}`,i),s(i)}}))}async function Wu(t,e){if(on)return zs(async()=>new Promise((n,s)=>{try{const r=ht.transaction([t],"readwrite").objectStore(t).put(e);r.onerror=()=>{Ne(`putOne ${t}`,r.error),s(r.error)},r.onsuccess=()=>{n(r.result)}}catch(i){Ne(`putOne ${t}`,i),s(i)}}))}async function we(t){if(on)return zs(async()=>new Promise((e,n)=>{try{const o=ht.transaction(["meta"],"readonly").objectStore("meta").get(t);o.onerror=()=>{Ne(`getMeta ${t}`,o.error),n(o.error)},o.onsuccess=()=>{const r=o.result;e(r?r.value:void 0)}}catch(s){Ne(`getMeta ${t}`,s),n(s)}}))}async function te(t,e){if(on)return zs(async()=>Wu("meta",{key:t,value:e}))}function Fi(t,e){var n={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(n[s]=t[s]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,s=Object.getOwnPropertySymbols(t);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(t,s[i])&&(n[s[i]]=t[s[i]]);return n}function Gu(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(d){try{l(s.next(d))}catch(u){r(u)}}function c(d){try{l(s.throw(d))}catch(u){r(u)}}function l(d){d.done?o(d.value):i(d.value).then(a,c)}l((s=s.apply(t,e||[])).next())})}const Vu=t=>t?(...e)=>t(...e):(...e)=>fetch(...e);class fr extends Error{constructor(e,n="FunctionsError",s){super(e),this.name=n,this.context=s}}class Ku extends fr{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class La extends fr{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Ra extends fr{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var jo;(function(t){t.Any="any",t.ApNortheast1="ap-northeast-1",t.ApNortheast2="ap-northeast-2",t.ApSouth1="ap-south-1",t.ApSoutheast1="ap-southeast-1",t.ApSoutheast2="ap-southeast-2",t.CaCentral1="ca-central-1",t.EuCentral1="eu-central-1",t.EuWest1="eu-west-1",t.EuWest2="eu-west-2",t.EuWest3="eu-west-3",t.SaEast1="sa-east-1",t.UsEast1="us-east-1",t.UsWest1="us-west-1",t.UsWest2="us-west-2"})(jo||(jo={}));class Ju{constructor(e,{headers:n={},customFetch:s,region:i=jo.Any}={}){this.url=e,this.headers=n,this.region=i,this.fetch=Vu(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return Gu(this,arguments,void 0,function*(n,s={}){var i;let o,r;try{const{headers:a,method:c,body:l,signal:d,timeout:u}=s;let p={},{region:h}=s;h||(h=this.region);const f=new URL(`${this.url}/${n}`);h&&h!=="any"&&(p["x-region"]=h,f.searchParams.set("forceFunctionRegion",h));let g;l&&(a&&!Object.prototype.hasOwnProperty.call(a,"Content-Type")||!a)?typeof Blob<"u"&&l instanceof Blob||l instanceof ArrayBuffer?(p["Content-Type"]="application/octet-stream",g=l):typeof l=="string"?(p["Content-Type"]="text/plain",g=l):typeof FormData<"u"&&l instanceof FormData?g=l:(p["Content-Type"]="application/json",g=JSON.stringify(l)):l&&typeof l!="string"&&!(typeof Blob<"u"&&l instanceof Blob)&&!(l instanceof ArrayBuffer)&&!(typeof FormData<"u"&&l instanceof FormData)?g=JSON.stringify(l):g=l;let m=d;u&&(r=new AbortController,o=setTimeout(()=>r.abort(),u),d?(m=r.signal,d.addEventListener("abort",()=>r.abort())):m=r.signal);const v=yield this.fetch(f.toString(),{method:c||"POST",headers:Object.assign(Object.assign(Object.assign({},p),this.headers),a),body:g,signal:m}).catch(C=>{throw new Ku(C)}),E=v.headers.get("x-relay-error");if(E&&E==="true")throw new La(v);if(!v.ok)throw new Ra(v);let w=((i=v.headers.get("Content-Type"))!==null&&i!==void 0?i:"text/plain").split(";")[0].trim(),S;return w==="application/json"?S=yield v.json():w==="application/octet-stream"||w==="application/pdf"?S=yield v.blob():w==="text/event-stream"?S=v:w==="multipart/form-data"?S=yield v.formData():S=yield v.text(),{data:S,error:null,response:v}}catch(a){return{data:null,error:a,response:a instanceof Ra||a instanceof La?a.context:void 0}}finally{o&&clearTimeout(o)}})}}var Yu=class extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}},Qu=class{constructor(t){var e,n,s;this.shouldThrowOnError=!1,this.method=t.method,this.url=t.url,this.headers=new Headers(t.headers),this.schema=t.schema,this.body=t.body,this.shouldThrowOnError=(e=t.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=t.signal,this.isMaybeSingle=(n=t.isMaybeSingle)!==null&&n!==void 0?n:!1,this.urlLengthLimit=(s=t.urlLengthLimit)!==null&&s!==void 0?s:8e3,t.fetch?this.fetch=t.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(t,e){return this.headers=new Headers(this.headers),this.headers.set(t,e),this}then(t,e){var n=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const s=this.fetch;let i=s(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async o=>{let r=null,a=null,c=null,l=o.status,d=o.statusText;if(o.ok){var u,p;if(n.method!=="HEAD"){var h;const v=await o.text();v===""||(n.headers.get("Accept")==="text/csv"||n.headers.get("Accept")&&(!((h=n.headers.get("Accept"))===null||h===void 0)&&h.includes("application/vnd.pgrst.plan+text"))?a=v:a=JSON.parse(v))}const g=(u=n.headers.get("Prefer"))===null||u===void 0?void 0:u.match(/count=(exact|planned|estimated)/),m=(p=o.headers.get("content-range"))===null||p===void 0?void 0:p.split("/");g&&m&&m.length>1&&(c=parseInt(m[1])),n.isMaybeSingle&&n.method==="GET"&&Array.isArray(a)&&(a.length>1?(r={code:"PGRST116",details:`Results contain ${a.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},a=null,c=null,l=406,d="Not Acceptable"):a.length===1?a=a[0]:a=null)}else{var f;const g=await o.text();try{r=JSON.parse(g),Array.isArray(r)&&o.status===404&&(a=[],r=null,l=200,d="OK")}catch{o.status===404&&g===""?(l=204,d="No Content"):r={message:g}}if(r&&n.isMaybeSingle&&(!(r==null||(f=r.details)===null||f===void 0)&&f.includes("0 rows"))&&(r=null,l=200,d="OK"),r&&n.shouldThrowOnError)throw new Yu(r)}return{error:r,data:a,count:c,status:l,statusText:d}});return this.shouldThrowOnError||(i=i.catch(o=>{var r;let a="",c="",l="";const d=o==null?void 0:o.cause;if(d){var u,p,h,f;const v=(u=d==null?void 0:d.message)!==null&&u!==void 0?u:"",E=(p=d==null?void 0:d.code)!==null&&p!==void 0?p:"";a=`${(h=o==null?void 0:o.name)!==null&&h!==void 0?h:"FetchError"}: ${o==null?void 0:o.message}`,a+=`

Caused by: ${(f=d==null?void 0:d.name)!==null&&f!==void 0?f:"Error"}: ${v}`,E&&(a+=` (${E})`),d!=null&&d.stack&&(a+=`
${d.stack}`)}else{var g;a=(g=o==null?void 0:o.stack)!==null&&g!==void 0?g:""}const m=this.url.toString().length;return(o==null?void 0:o.name)==="AbortError"||(o==null?void 0:o.code)==="ABORT_ERR"?(l="",c="Request was aborted (timeout or manual cancellation)",m>this.urlLengthLimit&&(c+=`. Note: Your request URL is ${m} characters, which may exceed server limits. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [many IDs])), consider using an RPC function to pass values server-side.`)):((d==null?void 0:d.name)==="HeadersOverflowError"||(d==null?void 0:d.code)==="UND_ERR_HEADERS_OVERFLOW")&&(l="",c="HTTP headers exceeded server limits (typically 16KB)",m>this.urlLengthLimit&&(c+=`. Your request URL is ${m} characters. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [200+ IDs])), consider using an RPC function instead.`)),{error:{message:`${(r=o==null?void 0:o.name)!==null&&r!==void 0?r:"FetchError"}: ${o==null?void 0:o.message}`,details:a,hint:c,code:l},data:null,count:null,status:0,statusText:""}})),i.then(t,e)}returns(){return this}overrideTypes(){return this}},Xu=class extends Qu{select(t){let e=!1;const n=(t??"*").split("").map(s=>/\s/.test(s)&&!e?"":(s==='"'&&(e=!e),s)).join("");return this.url.searchParams.set("select",n),this.headers.append("Prefer","return=representation"),this}order(t,{ascending:e=!0,nullsFirst:n,foreignTable:s,referencedTable:i=s}={}){const o=i?`${i}.order`:"order",r=this.url.searchParams.get(o);return this.url.searchParams.set(o,`${r?`${r},`:""}${t}.${e?"asc":"desc"}${n===void 0?"":n?".nullsfirst":".nullslast"}`),this}limit(t,{foreignTable:e,referencedTable:n=e}={}){const s=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(s,`${t}`),this}range(t,e,{foreignTable:n,referencedTable:s=n}={}){const i=typeof s>"u"?"offset":`${s}.offset`,o=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(i,`${t}`),this.url.searchParams.set(o,`${e-t+1}`),this}abortSignal(t){return this.signal=t,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:t=!1,verbose:e=!1,settings:n=!1,buffers:s=!1,wal:i=!1,format:o="text"}={}){var r;const a=[t?"analyze":null,e?"verbose":null,n?"settings":null,s?"buffers":null,i?"wal":null].filter(Boolean).join("|"),c=(r=this.headers.get("Accept"))!==null&&r!==void 0?r:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${o}; for="${c}"; options=${a};`),o==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(t){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${t}`),this}};const Ma=new RegExp("[,()]");var $n=class extends Xu{eq(t,e){return this.url.searchParams.append(t,`eq.${e}`),this}neq(t,e){return this.url.searchParams.append(t,`neq.${e}`),this}gt(t,e){return this.url.searchParams.append(t,`gt.${e}`),this}gte(t,e){return this.url.searchParams.append(t,`gte.${e}`),this}lt(t,e){return this.url.searchParams.append(t,`lt.${e}`),this}lte(t,e){return this.url.searchParams.append(t,`lte.${e}`),this}like(t,e){return this.url.searchParams.append(t,`like.${e}`),this}likeAllOf(t,e){return this.url.searchParams.append(t,`like(all).{${e.join(",")}}`),this}likeAnyOf(t,e){return this.url.searchParams.append(t,`like(any).{${e.join(",")}}`),this}ilike(t,e){return this.url.searchParams.append(t,`ilike.${e}`),this}ilikeAllOf(t,e){return this.url.searchParams.append(t,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(t,e){return this.url.searchParams.append(t,`ilike(any).{${e.join(",")}}`),this}regexMatch(t,e){return this.url.searchParams.append(t,`match.${e}`),this}regexIMatch(t,e){return this.url.searchParams.append(t,`imatch.${e}`),this}is(t,e){return this.url.searchParams.append(t,`is.${e}`),this}isDistinct(t,e){return this.url.searchParams.append(t,`isdistinct.${e}`),this}in(t,e){const n=Array.from(new Set(e)).map(s=>typeof s=="string"&&Ma.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(t,`in.(${n})`),this}notIn(t,e){const n=Array.from(new Set(e)).map(s=>typeof s=="string"&&Ma.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(t,`not.in.(${n})`),this}contains(t,e){return typeof e=="string"?this.url.searchParams.append(t,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cs.{${e.join(",")}}`):this.url.searchParams.append(t,`cs.${JSON.stringify(e)}`),this}containedBy(t,e){return typeof e=="string"?this.url.searchParams.append(t,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(t,`cd.{${e.join(",")}}`):this.url.searchParams.append(t,`cd.${JSON.stringify(e)}`),this}rangeGt(t,e){return this.url.searchParams.append(t,`sr.${e}`),this}rangeGte(t,e){return this.url.searchParams.append(t,`nxl.${e}`),this}rangeLt(t,e){return this.url.searchParams.append(t,`sl.${e}`),this}rangeLte(t,e){return this.url.searchParams.append(t,`nxr.${e}`),this}rangeAdjacent(t,e){return this.url.searchParams.append(t,`adj.${e}`),this}overlaps(t,e){return typeof e=="string"?this.url.searchParams.append(t,`ov.${e}`):this.url.searchParams.append(t,`ov.{${e.join(",")}}`),this}textSearch(t,e,{config:n,type:s}={}){let i="";s==="plain"?i="pl":s==="phrase"?i="ph":s==="websearch"&&(i="w");const o=n===void 0?"":`(${n})`;return this.url.searchParams.append(t,`${i}fts${o}.${e}`),this}match(t){return Object.entries(t).forEach(([e,n])=>{this.url.searchParams.append(e,`eq.${n}`)}),this}not(t,e,n){return this.url.searchParams.append(t,`not.${e}.${n}`),this}or(t,{foreignTable:e,referencedTable:n=e}={}){const s=n?`${n}.or`:"or";return this.url.searchParams.append(s,`(${t})`),this}filter(t,e,n){return this.url.searchParams.append(t,`${e}.${n}`),this}},Zu=class{constructor(t,{headers:e={},schema:n,fetch:s,urlLengthLimit:i=8e3}){this.url=t,this.headers=new Headers(e),this.schema=n,this.fetch=s,this.urlLengthLimit=i}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(t,e){const{head:n=!1,count:s}=e??{},i=n?"HEAD":"GET";let o=!1;const r=(t??"*").split("").map(l=>/\s/.test(l)&&!o?"":(l==='"'&&(o=!o),l)).join(""),{url:a,headers:c}=this.cloneRequestState();return a.searchParams.set("select",r),s&&c.append("Prefer",`count=${s}`),new $n({method:i,url:a,headers:c,schema:this.schema,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}insert(t,{count:e,defaultToNull:n=!0}={}){var s;const i="POST",{url:o,headers:r}=this.cloneRequestState();if(e&&r.append("Prefer",`count=${e}`),n||r.append("Prefer","missing=default"),Array.isArray(t)){const a=t.reduce((c,l)=>c.concat(Object.keys(l)),[]);if(a.length>0){const c=[...new Set(a)].map(l=>`"${l}"`);o.searchParams.set("columns",c.join(","))}}return new $n({method:i,url:o,headers:r,schema:this.schema,body:t,fetch:(s=this.fetch)!==null&&s!==void 0?s:fetch,urlLengthLimit:this.urlLengthLimit})}upsert(t,{onConflict:e,ignoreDuplicates:n=!1,count:s,defaultToNull:i=!0}={}){var o;const r="POST",{url:a,headers:c}=this.cloneRequestState();if(c.append("Prefer",`resolution=${n?"ignore":"merge"}-duplicates`),e!==void 0&&a.searchParams.set("on_conflict",e),s&&c.append("Prefer",`count=${s}`),i||c.append("Prefer","missing=default"),Array.isArray(t)){const l=t.reduce((d,u)=>d.concat(Object.keys(u)),[]);if(l.length>0){const d=[...new Set(l)].map(u=>`"${u}"`);a.searchParams.set("columns",d.join(","))}}return new $n({method:r,url:a,headers:c,schema:this.schema,body:t,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch,urlLengthLimit:this.urlLengthLimit})}update(t,{count:e}={}){var n;const s="PATCH",{url:i,headers:o}=this.cloneRequestState();return e&&o.append("Prefer",`count=${e}`),new $n({method:s,url:i,headers:o,schema:this.schema,body:t,fetch:(n=this.fetch)!==null&&n!==void 0?n:fetch,urlLengthLimit:this.urlLengthLimit})}delete({count:t}={}){var e;const n="DELETE",{url:s,headers:i}=this.cloneRequestState();return t&&i.append("Prefer",`count=${t}`),new $n({method:n,url:s,headers:i,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch,urlLengthLimit:this.urlLengthLimit})}};function Ss(t){"@babel/helpers - typeof";return Ss=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ss(t)}function ep(t,e){if(Ss(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var s=n.call(t,e);if(Ss(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function tp(t){var e=ep(t,"string");return Ss(e)=="symbol"?e:e+""}function np(t,e,n){return(e=tp(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function ja(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,s)}return n}function ri(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?ja(Object(n),!0).forEach(function(s){np(t,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ja(Object(n)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(n,s))})}return t}var sp=class Hl{constructor(e,{headers:n={},schema:s,fetch:i,timeout:o,urlLengthLimit:r=8e3}={}){this.url=e,this.headers=new Headers(n),this.schemaName=s,this.urlLengthLimit=r;const a=i??globalThis.fetch;o!==void 0&&o>0?this.fetch=(c,l)=>{const d=new AbortController,u=setTimeout(()=>d.abort(),o),p=l==null?void 0:l.signal;if(p){if(p.aborted)return clearTimeout(u),a(c,l);const h=()=>{clearTimeout(u),d.abort()};return p.addEventListener("abort",h,{once:!0}),a(c,ri(ri({},l),{},{signal:d.signal})).finally(()=>{clearTimeout(u),p.removeEventListener("abort",h)})}return a(c,ri(ri({},l),{},{signal:d.signal})).finally(()=>clearTimeout(u))}:this.fetch=a}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new Zu(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}schema(e){return new Hl(this.url,{headers:this.headers,schema:e,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}rpc(e,n={},{head:s=!1,get:i=!1,count:o}={}){var r;let a;const c=new URL(`${this.url}/rpc/${e}`);let l;const d=h=>h!==null&&typeof h=="object"&&(!Array.isArray(h)||h.some(d)),u=s&&Object.values(n).some(d);u?(a="POST",l=n):s||i?(a=s?"HEAD":"GET",Object.entries(n).filter(([h,f])=>f!==void 0).map(([h,f])=>[h,Array.isArray(f)?`{${f.join(",")}}`:`${f}`]).forEach(([h,f])=>{c.searchParams.append(h,f)})):(a="POST",l=n);const p=new Headers(this.headers);return u?p.set("Prefer",o?`count=${o},return=minimal`:"return=minimal"):o&&p.set("Prefer",`count=${o}`),new $n({method:a,url:c,headers:p,schema:this.schemaName,body:l,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch,urlLengthLimit:this.urlLengthLimit})}};class ip{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const n=globalThis.process;if(n){const s=n.versions;if(s&&s.node){const i=s.node,o=parseInt(i.replace(/^v/,"").split(".")[0]);return o>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${o} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${o} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let n=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(n+=`

Suggested solution: ${e.workaround}`),new Error(n)}static createWebSocket(e,n){const s=this.getWebSocketConstructor();return new s(e,n)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const op="2.98.0",rp=`realtime-js/${op}`,ap="1.0.0",Wl="2.0.0",Na=Wl,No=1e4,lp=1e3,cp=100;var _t;(function(t){t[t.connecting=0]="connecting",t[t.open=1]="open",t[t.closing=2]="closing",t[t.closed=3]="closed"})(_t||(_t={}));var le;(function(t){t.closed="closed",t.errored="errored",t.joined="joined",t.joining="joining",t.leaving="leaving"})(le||(le={}));var Ke;(function(t){t.close="phx_close",t.error="phx_error",t.join="phx_join",t.reply="phx_reply",t.leave="phx_leave",t.access_token="access_token"})(Ke||(Ke={}));var zo;(function(t){t.websocket="websocket"})(zo||(zo={}));var Wt;(function(t){t.Connecting="connecting",t.Open="open",t.Closing="closing",t.Closed="closed"})(Wt||(Wt={}));class dp{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,n){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return n(this._binaryEncodeUserBroadcastPush(e));let s=[e.join_ref,e.ref,e.topic,e.event,e.payload];return n(JSON.stringify(s))}_binaryEncodeUserBroadcastPush(e){var n;return this._isArrayBuffer((n=e.payload)===null||n===void 0?void 0:n.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var n,s;const i=(s=(n=e.payload)===null||n===void 0?void 0:n.payload)!==null&&s!==void 0?s:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,i)}_encodeJsonUserBroadcastPush(e){var n,s;const i=(s=(n=e.payload)===null||n===void 0?void 0:n.payload)!==null&&s!==void 0?s:{},r=new TextEncoder().encode(JSON.stringify(i)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,r)}_encodeUserBroadcastPush(e,n,s){var i,o;const r=e.topic,a=(i=e.ref)!==null&&i!==void 0?i:"",c=(o=e.join_ref)!==null&&o!==void 0?o:"",l=e.payload.event,d=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},u=Object.keys(d).length===0?"":JSON.stringify(d);if(c.length>255)throw new Error(`joinRef length ${c.length} exceeds maximum of 255`);if(a.length>255)throw new Error(`ref length ${a.length} exceeds maximum of 255`);if(r.length>255)throw new Error(`topic length ${r.length} exceeds maximum of 255`);if(l.length>255)throw new Error(`userEvent length ${l.length} exceeds maximum of 255`);if(u.length>255)throw new Error(`metadata length ${u.length} exceeds maximum of 255`);const p=this.USER_BROADCAST_PUSH_META_LENGTH+c.length+a.length+r.length+l.length+u.length,h=new ArrayBuffer(this.HEADER_LENGTH+p);let f=new DataView(h),g=0;f.setUint8(g++,this.KINDS.userBroadcastPush),f.setUint8(g++,c.length),f.setUint8(g++,a.length),f.setUint8(g++,r.length),f.setUint8(g++,l.length),f.setUint8(g++,u.length),f.setUint8(g++,n),Array.from(c,v=>f.setUint8(g++,v.charCodeAt(0))),Array.from(a,v=>f.setUint8(g++,v.charCodeAt(0))),Array.from(r,v=>f.setUint8(g++,v.charCodeAt(0))),Array.from(l,v=>f.setUint8(g++,v.charCodeAt(0))),Array.from(u,v=>f.setUint8(g++,v.charCodeAt(0)));var m=new Uint8Array(h.byteLength+s.byteLength);return m.set(new Uint8Array(h),0),m.set(new Uint8Array(s),h.byteLength),m.buffer}decode(e,n){if(this._isArrayBuffer(e)){let s=this._binaryDecode(e);return n(s)}if(typeof e=="string"){const s=JSON.parse(e),[i,o,r,a,c]=s;return n({join_ref:i,ref:o,topic:r,event:a,payload:c})}return n({})}_binaryDecode(e){const n=new DataView(e),s=n.getUint8(0),i=new TextDecoder;switch(s){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,n,i)}}_decodeUserBroadcast(e,n,s){const i=n.getUint8(1),o=n.getUint8(2),r=n.getUint8(3),a=n.getUint8(4);let c=this.HEADER_LENGTH+4;const l=s.decode(e.slice(c,c+i));c=c+i;const d=s.decode(e.slice(c,c+o));c=c+o;const u=s.decode(e.slice(c,c+r));c=c+r;const p=e.slice(c,e.byteLength),h=a===this.JSON_ENCODING?JSON.parse(s.decode(p)):p,f={type:this.BROADCAST_EVENT,event:d,payload:h};return r>0&&(f.meta=JSON.parse(u)),{join_ref:null,ref:null,topic:l,event:this.BROADCAST_EVENT,payload:f}}_isArrayBuffer(e){var n;return e instanceof ArrayBuffer||((n=e==null?void 0:e.constructor)===null||n===void 0?void 0:n.name)==="ArrayBuffer"}_pick(e,n){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([s])=>n.includes(s)))}}class Gl{constructor(e,n){this.callback=e,this.timerCalc=n,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=n}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var Z;(function(t){t.abstime="abstime",t.bool="bool",t.date="date",t.daterange="daterange",t.float4="float4",t.float8="float8",t.int2="int2",t.int4="int4",t.int4range="int4range",t.int8="int8",t.int8range="int8range",t.json="json",t.jsonb="jsonb",t.money="money",t.numeric="numeric",t.oid="oid",t.reltime="reltime",t.text="text",t.time="time",t.timestamp="timestamp",t.timestamptz="timestamptz",t.timetz="timetz",t.tsrange="tsrange",t.tstzrange="tstzrange"})(Z||(Z={}));const za=(t,e,n={})=>{var s;const i=(s=n.skipTypes)!==null&&s!==void 0?s:[];return e?Object.keys(e).reduce((o,r)=>(o[r]=up(r,t,e,i),o),{}):{}},up=(t,e,n,s)=>{const i=e.find(a=>a.name===t),o=i==null?void 0:i.type,r=n[t];return o&&!s.includes(o)?Vl(o,r):Uo(r)},Vl=(t,e)=>{if(t.charAt(0)==="_"){const n=t.slice(1,t.length);return mp(e,n)}switch(t){case Z.bool:return pp(e);case Z.float4:case Z.float8:case Z.int2:case Z.int4:case Z.int8:case Z.numeric:case Z.oid:return fp(e);case Z.json:case Z.jsonb:return hp(e);case Z.timestamp:return gp(e);case Z.abstime:case Z.date:case Z.daterange:case Z.int4range:case Z.int8range:case Z.money:case Z.reltime:case Z.text:case Z.time:case Z.timestamptz:case Z.timetz:case Z.tsrange:case Z.tstzrange:return Uo(e);default:return Uo(e)}},Uo=t=>t,pp=t=>{switch(t){case"t":return!0;case"f":return!1;default:return t}},fp=t=>{if(typeof t=="string"){const e=parseFloat(t);if(!Number.isNaN(e))return e}return t},hp=t=>{if(typeof t=="string")try{return JSON.parse(t)}catch{return t}return t},mp=(t,e)=>{if(typeof t!="string")return t;const n=t.length-1,s=t[n];if(t[0]==="{"&&s==="}"){let o;const r=t.slice(1,n);try{o=JSON.parse("["+r+"]")}catch{o=r?r.split(","):[]}return o.map(a=>Vl(e,a))}return t},gp=t=>typeof t=="string"?t.replace(" ","T"):t,Kl=t=>{const e=new URL(t);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class bo{constructor(e,n,s={},i=No){this.channel=e,this.event=n,this.payload=s,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,n){var s;return this._hasReceived(e)&&n((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:e,callback:n}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=n=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=n,this._matchReceive(n)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,n){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:n})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:n}){this.recHooks.filter(s=>s.status===e).forEach(s=>s.callback(n))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Ua;(function(t){t.SYNC="sync",t.JOIN="join",t.LEAVE="leave"})(Ua||(Ua={}));class ds{constructor(e,n){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(n==null?void 0:n.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},i=>{const{onJoin:o,onLeave:r,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=ds.syncState(this.state,i,o,r),this.pendingDiffs.forEach(c=>{this.state=ds.syncDiff(this.state,c,o,r)}),this.pendingDiffs=[],a()}),this.channel._on(s.diff,{},i=>{const{onJoin:o,onLeave:r,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=ds.syncDiff(this.state,i,o,r),a())}),this.onJoin((i,o,r)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:o,newPresences:r})}),this.onLeave((i,o,r)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:o,leftPresences:r})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,n,s,i){const o=this.cloneDeep(e),r=this.transformState(n),a={},c={};return this.map(o,(l,d)=>{r[l]||(c[l]=d)}),this.map(r,(l,d)=>{const u=o[l];if(u){const p=d.map(m=>m.presence_ref),h=u.map(m=>m.presence_ref),f=d.filter(m=>h.indexOf(m.presence_ref)<0),g=u.filter(m=>p.indexOf(m.presence_ref)<0);f.length>0&&(a[l]=f),g.length>0&&(c[l]=g)}else a[l]=d}),this.syncDiff(o,{joins:a,leaves:c},s,i)}static syncDiff(e,n,s,i){const{joins:o,leaves:r}={joins:this.transformState(n.joins),leaves:this.transformState(n.leaves)};return s||(s=()=>{}),i||(i=()=>{}),this.map(o,(a,c)=>{var l;const d=(l=e[a])!==null&&l!==void 0?l:[];if(e[a]=this.cloneDeep(c),d.length>0){const u=e[a].map(h=>h.presence_ref),p=d.filter(h=>u.indexOf(h.presence_ref)<0);e[a].unshift(...p)}s(a,d,c)}),this.map(r,(a,c)=>{let l=e[a];if(!l)return;const d=c.map(u=>u.presence_ref);l=l.filter(u=>d.indexOf(u.presence_ref)<0),e[a]=l,i(a,l,c),l.length===0&&delete e[a]}),e}static map(e,n){return Object.getOwnPropertyNames(e).map(s=>n(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((n,s)=>{const i=e[s];return"metas"in i?n[s]=i.metas.map(o=>(o.presence_ref=o.phx_ref,delete o.phx_ref,delete o.phx_ref_prev,o)):n[s]=i,n},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Fa;(function(t){t.ALL="*",t.INSERT="INSERT",t.UPDATE="UPDATE",t.DELETE="DELETE"})(Fa||(Fa={}));var us;(function(t){t.BROADCAST="broadcast",t.PRESENCE="presence",t.POSTGRES_CHANGES="postgres_changes",t.SYSTEM="system"})(us||(us={}));var pt;(function(t){t.SUBSCRIBED="SUBSCRIBED",t.TIMED_OUT="TIMED_OUT",t.CLOSED="CLOSED",t.CHANNEL_ERROR="CHANNEL_ERROR"})(pt||(pt={}));class Cn{constructor(e,n={config:{}},s){var i,o;if(this.topic=e,this.params=n,this.socket=s,this.bindings={},this.state=le.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},n.config),this.timeout=this.socket.timeout,this.joinPush=new bo(this,Ke.join,this.params,this.timeout),this.rejoinTimer=new Gl(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=le.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(r=>r.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=le.closed,this.socket._remove(this)}),this._onError(r=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,r),this.state=le.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=le.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",r=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,r),this.state=le.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Ke.reply,{},(r,a)=>{this._trigger(this._replyEventName(a),r)}),this.presence=new ds(this),this.broadcastEndpointURL=Kl(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((o=(i=this.params.config)===null||i===void 0?void 0:i.broadcast)===null||o===void 0)&&o.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,n=this.timeout){var s,i,o;if(this.socket.isConnected()||this.socket.connect(),this.state==le.closed){const{config:{broadcast:r,presence:a,private:c}}=this.params,l=(i=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(h=>h.filter))!==null&&i!==void 0?i:[],d=!!this.bindings[us.PRESENCE]&&this.bindings[us.PRESENCE].length>0||((o=this.params.config.presence)===null||o===void 0?void 0:o.enabled)===!0,u={},p={broadcast:r,presence:Object.assign(Object.assign({},a),{enabled:d}),postgres_changes:l,private:c};this.socket.accessTokenValue&&(u.access_token=this.socket.accessTokenValue),this._onError(h=>e==null?void 0:e(pt.CHANNEL_ERROR,h)),this._onClose(()=>e==null?void 0:e(pt.CLOSED)),this.updateJoinPayload(Object.assign({config:p},u)),this.joinedOnce=!0,this._rejoin(n),this.joinPush.receive("ok",async({postgres_changes:h})=>{var f;if(this.socket._isManualToken()||this.socket.setAuth(),h===void 0){e==null||e(pt.SUBSCRIBED);return}else{const g=this.bindings.postgres_changes,m=(f=g==null?void 0:g.length)!==null&&f!==void 0?f:0,v=[];for(let E=0;E<m;E++){const w=g[E],{filter:{event:S,schema:C,table:B,filter:L}}=w,O=h&&h[E];if(O&&O.event===S&&Cn.isFilterValueEqual(O.schema,C)&&Cn.isFilterValueEqual(O.table,B)&&Cn.isFilterValueEqual(O.filter,L))v.push(Object.assign(Object.assign({},w),{id:O.id}));else{this.unsubscribe(),this.state=le.errored,e==null||e(pt.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=v,e&&e(pt.SUBSCRIBED);return}}).receive("error",h=>{this.state=le.errored,e==null||e(pt.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(h).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(pt.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,n={}){return await this.send({type:"presence",event:"track",payload:e},n.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,n,s){return this.state===le.joined&&e===us.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,n,s)}async httpSend(e,n,s={}){var i;if(n==null)return Promise.reject("Payload is required for httpSend()");const o={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(o.Authorization=`Bearer ${this.socket.accessTokenValue}`);const r={method:"POST",headers:o,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:n,private:this.private}]})},a=await this._fetchWithTimeout(this.broadcastEndpointURL,r,(i=s.timeout)!==null&&i!==void 0?i:this.timeout);if(a.status===202)return{success:!0};let c=a.statusText;try{const l=await a.json();c=l.error||l.message||c}catch{}return Promise.reject(new Error(c))}async send(e,n={}){var s,i;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:o,payload:r}=e,a={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(a.Authorization=`Bearer ${this.socket.accessTokenValue}`);const c={method:"POST",headers:a,body:JSON.stringify({messages:[{topic:this.subTopic,event:o,payload:r,private:this.private}]})};try{const l=await this._fetchWithTimeout(this.broadcastEndpointURL,c,(s=n.timeout)!==null&&s!==void 0?s:this.timeout);return await((i=l.body)===null||i===void 0?void 0:i.cancel()),l.ok?"ok":"error"}catch(l){return l.name==="AbortError"?"timed out":"error"}}else return new Promise(o=>{var r,a,c;const l=this._push(e.type,e,n.timeout||this.timeout);e.type==="broadcast"&&!(!((c=(a=(r=this.params)===null||r===void 0?void 0:r.config)===null||a===void 0?void 0:a.broadcast)===null||c===void 0)&&c.ack)&&o("ok"),l.receive("ok",()=>o("ok")),l.receive("error",()=>o("error")),l.receive("timeout",()=>o("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=le.leaving;const n=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Ke.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(i=>{s=new bo(this,Ke.leave,{},e),s.receive("ok",()=>{n(),i("ok")}).receive("timeout",()=>{n(),i("timed out")}).receive("error",()=>{i("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{s==null||s.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=le.closed,this.bindings={}}async _fetchWithTimeout(e,n,s){const i=new AbortController,o=setTimeout(()=>i.abort(),s),r=await this.socket.fetch(e,Object.assign(Object.assign({},n),{signal:i.signal}));return clearTimeout(o),r}_push(e,n,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new bo(this,e,n,s);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>cp){const n=this.pushBuffer.shift();n&&(n.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${n.event}`,n.payload))}}_onMessage(e,n,s){return n}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,n,s){var i,o;const r=e.toLocaleLowerCase(),{close:a,error:c,leave:l,join:d}=Ke;if(s&&[a,c,l,d].indexOf(r)>=0&&s!==this._joinRef())return;let p=this._onMessage(r,n,s);if(n&&!p)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(r)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(h=>{var f,g,m;return((f=h.filter)===null||f===void 0?void 0:f.event)==="*"||((m=(g=h.filter)===null||g===void 0?void 0:g.event)===null||m===void 0?void 0:m.toLocaleLowerCase())===r}).map(h=>h.callback(p,s)):(o=this.bindings[r])===null||o===void 0||o.filter(h=>{var f,g,m,v,E,w;if(["broadcast","presence","postgres_changes"].includes(r))if("id"in h){const S=h.id,C=(f=h.filter)===null||f===void 0?void 0:f.event;return S&&((g=n.ids)===null||g===void 0?void 0:g.includes(S))&&(C==="*"||(C==null?void 0:C.toLocaleLowerCase())===((m=n.data)===null||m===void 0?void 0:m.type.toLocaleLowerCase()))}else{const S=(E=(v=h==null?void 0:h.filter)===null||v===void 0?void 0:v.event)===null||E===void 0?void 0:E.toLocaleLowerCase();return S==="*"||S===((w=n==null?void 0:n.event)===null||w===void 0?void 0:w.toLocaleLowerCase())}else return h.type.toLocaleLowerCase()===r}).map(h=>{if(typeof p=="object"&&"ids"in p){const f=p.data,{schema:g,table:m,commit_timestamp:v,type:E,errors:w}=f;p=Object.assign(Object.assign({},{schema:g,table:m,commit_timestamp:v,eventType:E,new:{},old:{},errors:w}),this._getPayloadRecords(f))}h.callback(p,s)})}_isClosed(){return this.state===le.closed}_isJoined(){return this.state===le.joined}_isJoining(){return this.state===le.joining}_isLeaving(){return this.state===le.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,n,s){const i=e.toLocaleLowerCase(),o={type:i,filter:n,callback:s};return this.bindings[i]?this.bindings[i].push(o):this.bindings[i]=[o],this}_off(e,n){const s=e.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(i=>{var o;return!(((o=i.type)===null||o===void 0?void 0:o.toLocaleLowerCase())===s&&Cn.isEqual(i.filter,n))})),this}static isEqual(e,n){if(Object.keys(e).length!==Object.keys(n).length)return!1;for(const s in e)if(e[s]!==n[s])return!1;return!0}static isFilterValueEqual(e,n){return(e??void 0)===(n??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Ke.close,{},e)}_onError(e){this._on(Ke.error,{},n=>e(n))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=le.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const n={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(n.new=za(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(n.old=za(e.columns,e.old_record)),n}}const wo=()=>{},ai={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},yp=[1e3,2e3,5e3,1e4],vp=1e4,bp=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class wp{constructor(e,n){var s;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=No,this.transport=null,this.heartbeatIntervalMs=ai.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=wo,this.ref=0,this.reconnectTimer=null,this.vsn=Na,this.logger=wo,this.conn=null,this.sendBuffer=[],this.serializer=new dp,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=i=>i?(...o)=>i(...o):(...o)=>fetch(...o),!(!((s=n==null?void 0:n.params)===null||s===void 0)&&s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=n.params.apikey,this.endPoint=`${e}/${zo.websocket}`,this.httpEndpoint=Kl(e),this._initializeOptions(n),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(n==null?void 0:n.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=ip.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const n=e.message;throw n.includes("Node.js")?new Error(`${n}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${n}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,n){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,n??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const n=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),n}async removeAllChannels(){const e=await Promise.all(this.channels.map(n=>n.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,n,s){this.logger(e,n,s)}connectionState(){switch(this.conn&&this.conn.readyState){case _t.connecting:return Wt.Connecting;case _t.open:return Wt.Open;case _t.closing:return Wt.Closing;default:return Wt.Closed}}isConnected(){return this.connectionState()===Wt.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,n={config:{}}){const s=`realtime:${e}`,i=this.getChannels().find(o=>o.topic===s);if(i)return i;{const o=new Cn(`realtime:${e}`,n,this);return this.channels.push(o),o}}push(e){const{topic:n,event:s,payload:i,ref:o}=e,r=()=>{this.encode(e,a=>{var c;(c=this.conn)===null||c===void 0||c.send(a)})};this.log("push",`${n} ${s} (${o})`,i),this.isConnected()?r():this.sendBuffer.push(r)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(n){this.log("error","error in heartbeat callback",n)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(n){this.log("error","error in heartbeat callback",n)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(lp,"heartbeat timeout"),setTimeout(()=>{var n;this.isConnected()||(n=this.reconnectTimer)===null||n===void 0||n.scheduleTimeout()},ai.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(n){this.log("error","error in heartbeat callback",n)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let n=this.channels.find(s=>s.topic===e&&(s._isJoined()||s._isJoining()));n&&(this.log("transport",`leaving duplicate topic "${e}"`),n.unsubscribe())}_remove(e){this.channels=this.channels.filter(n=>n.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,n=>{if(n.topic==="phoenix"&&n.event==="phx_reply"&&n.ref&&n.ref===this.pendingHeartbeatRef){const l=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(n.payload.status==="ok"?"ok":"error",l)}catch(d){this.log("error","error in heartbeat callback",d)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:s,event:i,payload:o,ref:r}=n,a=r?`(${r})`:"",c=o.status||"";this.log("receive",`${c} ${s} ${i} ${a}`.trim(),o),this.channels.filter(l=>l._isMember(s)).forEach(l=>l._trigger(i,o,r)),this._triggerStateCallbacks("message",n)})}_clearTimer(e){var n;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((n=this.reconnectTimer)===null||n===void 0||n.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===_t.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===_t.open||this.conn.readyState===_t.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.accessTokenValue&&(this.channels.forEach(n=>{n.updateJoinPayload({access_token:this.accessTokenValue})}),this.sendBuffer=[],this.channels.forEach(n=>{n._isJoining()&&(n.joinPush.sent=!1,n.joinPush.send())})),this.flushSendBuffer()}).catch(n=>{this.log("error","error waiting for auth on connect",n),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=n=>{this.log("worker","worker error",n.message),this._terminateWorker()},this.workerRef.onmessage=n=>{n.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var n;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(n=this.reconnectTimer)===null||n===void 0||n.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e);try{this.heartbeatCallback("error")}catch(n){this.log("error","error in heartbeat callback",n)}}_triggerChanError(){this.channels.forEach(e=>e._trigger(Ke.error))}_appendParams(e,n){if(Object.keys(n).length===0)return e;const s=e.match(/\?/)?"&":"?",i=new URLSearchParams(n);return`${e}${s}${i}`}_workerObjectUrl(e){let n;if(e)n=e;else{const s=new Blob([bp],{type:"application/javascript"});n=URL.createObjectURL(s)}return n}_setConnectionState(e,n=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=n)}async _performAuth(e=null){let n,s=!1;if(e)n=e,s=!0;else if(this.accessToken)try{n=await this.accessToken()}catch(i){this.log("error","Error fetching access token from callback",i),n=this.accessTokenValue}else n=this.accessTokenValue;s?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=n&&(this.accessTokenValue=n,this.channels.forEach(i=>{const o={access_token:n,version:rp};n&&i.updateJoinPayload(o),i.joinedOnce&&i._isJoined()&&i._push(Ke.access_token,{access_token:n})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(n=>{this.log("error",`Error setting auth in ${e}`,n)})}_triggerStateCallbacks(e,n){try{this.stateChangeCallbacks[e].forEach(s=>{try{s(n)}catch(i){this.log("error",`error in ${e} callback`,i)}})}catch(s){this.log("error",`error triggering ${e} callbacks`,s)}}_setupReconnectionTimer(){this.reconnectTimer=new Gl(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},ai.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var n,s,i,o,r,a,c,l,d,u,p,h;switch(this.transport=(n=e==null?void 0:e.transport)!==null&&n!==void 0?n:null,this.timeout=(s=e==null?void 0:e.timeout)!==null&&s!==void 0?s:No,this.heartbeatIntervalMs=(i=e==null?void 0:e.heartbeatIntervalMs)!==null&&i!==void 0?i:ai.HEARTBEAT_INTERVAL,this.worker=(o=e==null?void 0:e.worker)!==null&&o!==void 0?o:!1,this.accessToken=(r=e==null?void 0:e.accessToken)!==null&&r!==void 0?r:null,this.heartbeatCallback=(a=e==null?void 0:e.heartbeatCallback)!==null&&a!==void 0?a:wo,this.vsn=(c=e==null?void 0:e.vsn)!==null&&c!==void 0?c:Na,e!=null&&e.params&&(this.params=e.params),e!=null&&e.logger&&(this.logger=e.logger),(e!=null&&e.logLevel||e!=null&&e.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(l=e==null?void 0:e.reconnectAfterMs)!==null&&l!==void 0?l:f=>yp[f-1]||vp,this.vsn){case ap:this.encode=(d=e==null?void 0:e.encode)!==null&&d!==void 0?d:(f,g)=>g(JSON.stringify(f)),this.decode=(u=e==null?void 0:e.decode)!==null&&u!==void 0?u:(f,g)=>g(JSON.parse(f));break;case Wl:this.encode=(p=e==null?void 0:e.encode)!==null&&p!==void 0?p:this.serializer.encode.bind(this.serializer),this.decode=(h=e==null?void 0:e.decode)!==null&&h!==void 0?h:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e==null?void 0:e.workerUrl}}}var ks=class extends Error{constructor(t,e){var n;super(t),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&((n=e.icebergType)==null?void 0:n.includes("CommitState"))===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function xp(t,e,n){const s=new URL(e,t);if(n)for(const[i,o]of Object.entries(n))o!==void 0&&s.searchParams.set(i,o);return s.toString()}async function _p(t){return!t||t.type==="none"?{}:t.type==="bearer"?{Authorization:`Bearer ${t.token}`}:t.type==="header"?{[t.name]:t.value}:t.type==="custom"?await t.getHeaders():{}}function Sp(t){const e=t.fetchImpl??globalThis.fetch;return{async request({method:n,path:s,query:i,body:o,headers:r}){const a=xp(t.baseUrl,s,i),c=await _p(t.auth),l=await e(a,{method:n,headers:{...o?{"Content-Type":"application/json"}:{},...c,...r},body:o?JSON.stringify(o):void 0}),d=await l.text(),u=(l.headers.get("content-type")||"").includes("application/json"),p=u&&d?JSON.parse(d):d;if(!l.ok){const h=u?p:void 0,f=h==null?void 0:h.error;throw new ks((f==null?void 0:f.message)??`Request failed with status ${l.status}`,{status:l.status,icebergType:f==null?void 0:f.type,icebergCode:f==null?void 0:f.code,details:h})}return{status:l.status,headers:l.headers,data:p}}}}function li(t){return t.join("")}var kp=class{constructor(t,e=""){this.client=t,this.prefix=e}async listNamespaces(t){const e=t?{parent:li(t.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(s=>({namespace:s}))}async createNamespace(t,e){const n={namespace:t.namespace,properties:e==null?void 0:e.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:n})).data}async dropNamespace(t){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${li(t.namespace)}`})}async loadNamespaceMetadata(t){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${li(t.namespace)}`})).data.properties}}async namespaceExists(t){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${li(t.namespace)}`}),!0}catch(e){if(e instanceof ks&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(t,e){try{return await this.createNamespace(t,e)}catch(n){if(n instanceof ks&&n.status===409)return;throw n}}};function bn(t){return t.join("")}var $p=class{constructor(t,e="",n){this.client=t,this.prefix=e,this.accessDelegation=n}async listTables(t){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${bn(t.namespace)}/tables`})).data.identifiers}async createTable(t,e){const n={};return this.accessDelegation&&(n["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${bn(t.namespace)}/tables`,body:e,headers:n})).data.metadata}async updateTable(t,e){const n=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${bn(t.namespace)}/tables/${t.name}`,body:e});return{"metadata-location":n.data["metadata-location"],metadata:n.data.metadata}}async dropTable(t,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${bn(t.namespace)}/tables/${t.name}`,query:{purgeRequested:String((e==null?void 0:e.purge)??!1)}})}async loadTable(t){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${bn(t.namespace)}/tables/${t.name}`,headers:e})).data.metadata}async tableExists(t){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${bn(t.namespace)}/tables/${t.name}`,headers:e}),!0}catch(n){if(n instanceof ks&&n.status===404)return!1;throw n}}async createTableIfNotExists(t,e){try{return await this.createTable(t,e)}catch(n){if(n instanceof ks&&n.status===409)return await this.loadTable({namespace:t.namespace,name:e.name});throw n}}},Ep=class{constructor(t){var s;let e="v1";t.catalogName&&(e+=`/${t.catalogName}`);const n=t.baseUrl.endsWith("/")?t.baseUrl:`${t.baseUrl}/`;this.client=Sp({baseUrl:n,auth:t.auth,fetchImpl:t.fetch}),this.accessDelegation=(s=t.accessDelegation)==null?void 0:s.join(","),this.namespaceOps=new kp(this.client,e),this.tableOps=new $p(this.client,e,this.accessDelegation)}async listNamespaces(t){return this.namespaceOps.listNamespaces(t)}async createNamespace(t,e){return this.namespaceOps.createNamespace(t,e)}async dropNamespace(t){await this.namespaceOps.dropNamespace(t)}async loadNamespaceMetadata(t){return this.namespaceOps.loadNamespaceMetadata(t)}async listTables(t){return this.tableOps.listTables(t)}async createTable(t,e){return this.tableOps.createTable(t,e)}async updateTable(t,e){return this.tableOps.updateTable(t,e)}async dropTable(t,e){await this.tableOps.dropTable(t,e)}async loadTable(t){return this.tableOps.loadTable(t)}async namespaceExists(t){return this.namespaceOps.namespaceExists(t)}async tableExists(t){return this.tableOps.tableExists(t)}async createNamespaceIfNotExists(t,e){return this.namespaceOps.createNamespaceIfNotExists(t,e)}async createTableIfNotExists(t,e){return this.tableOps.createTableIfNotExists(t,e)}},qi=class extends Error{constructor(t,e="storage",n,s){super(t),this.__isStorageError=!0,this.namespace=e,this.name=e==="vectors"?"StorageVectorsError":"StorageError",this.status=n,this.statusCode=s}};function Hi(t){return typeof t=="object"&&t!==null&&"__isStorageError"in t}var ci=class extends qi{constructor(t,e,n,s="storage"){super(t,s,e,n),this.name=s==="vectors"?"StorageVectorsApiError":"StorageApiError",this.status=e,this.statusCode=n}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},Jl=class extends qi{constructor(t,e,n="storage"){super(t,n),this.name=n==="vectors"?"StorageVectorsUnknownError":"StorageUnknownError",this.originalError=e}};const Ip=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),Tp=t=>{if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in t)&&!(Symbol.iterator in t)},Fo=t=>{if(Array.isArray(t))return t.map(n=>Fo(n));if(typeof t=="function"||t!==Object(t))return t;const e={};return Object.entries(t).forEach(([n,s])=>{const i=n.replace(/([-_][a-z])/gi,o=>o.toUpperCase().replace(/[-_]/g,""));e[i]=Fo(s)}),e},Cp=t=>!t||typeof t!="string"||t.length===0||t.length>100||t.trim()!==t||t.includes("/")||t.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(t);function $s(t){"@babel/helpers - typeof";return $s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$s(t)}function Pp(t,e){if($s(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var s=n.call(t,e);if($s(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Dp(t){var e=Pp(t,"string");return $s(e)=="symbol"?e:e+""}function Bp(t,e,n){return(e=Dp(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function qa(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,s)}return n}function M(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?qa(Object(n),!0).forEach(function(s){Bp(t,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):qa(Object(n)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(n,s))})}return t}const Ha=t=>{var e;return t.msg||t.message||t.error_description||(typeof t.error=="string"?t.error:(e=t.error)===null||e===void 0?void 0:e.message)||JSON.stringify(t)},Op=async(t,e,n,s)=>{if(t&&typeof t=="object"&&"status"in t&&"ok"in t&&typeof t.status=="number"&&!(n!=null&&n.noResolveJson)){const i=t,o=i.status||500;if(typeof i.json=="function")i.json().then(r=>{const a=(r==null?void 0:r.statusCode)||(r==null?void 0:r.code)||o+"";e(new ci(Ha(r),o,a,s))}).catch(()=>{if(s==="vectors"){const r=o+"";e(new ci(i.statusText||`HTTP ${o} error`,o,r,s))}else{const r=o+"";e(new ci(i.statusText||`HTTP ${o} error`,o,r,s))}});else{const r=o+"";e(new ci(i.statusText||`HTTP ${o} error`,o,r,s))}}else e(new Jl(Ha(t),t,s))},Ap=(t,e,n,s)=>{const i={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"||t==="HEAD"||!s?M(M({},i),n):(Tp(s)?(i.headers=M({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(s)):i.body=s,e!=null&&e.duplex&&(i.duplex=e.duplex),M(M({},i),n))};async function ts(t,e,n,s,i,o,r){return new Promise((a,c)=>{t(n,Ap(e,s,i,o)).then(l=>{if(!l.ok)throw l;if(s!=null&&s.noResolveJson)return l;if(r==="vectors"){const d=l.headers.get("content-type");if(l.headers.get("content-length")==="0"||l.status===204)return{};if(!d||!d.includes("application/json"))return{}}return l.json()}).then(l=>a(l)).catch(l=>Op(l,c,s,r))})}function Yl(t="storage"){return{get:async(e,n,s,i)=>ts(e,"GET",n,s,i,void 0,t),post:async(e,n,s,i,o)=>ts(e,"POST",n,i,o,s,t),put:async(e,n,s,i,o)=>ts(e,"PUT",n,i,o,s,t),head:async(e,n,s,i)=>ts(e,"HEAD",n,M(M({},s),{},{noResolveJson:!0}),i,void 0,t),remove:async(e,n,s,i,o)=>ts(e,"DELETE",n,i,o,s,t)}}const Lp=Yl("storage"),{get:Es,post:Ve,put:qo,head:Rp,remove:hr}=Lp,Le=Yl("vectors");var qn=class{constructor(t,e={},n,s="storage"){this.shouldThrowOnError=!1,this.url=t,this.headers=e,this.fetch=Ip(n),this.namespace=s}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(t,e){return this.headers=M(M({},this.headers),{},{[t]:e}),this}async handleOperation(t){var e=this;try{return{data:await t(),error:null}}catch(n){if(e.shouldThrowOnError)throw n;if(Hi(n))return{data:null,error:n};throw n}}},Mp=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e}then(t,e){return this.execute().then(t,e)}async execute(){var t=this;try{return{data:(await t.downloadFn()).body,error:null}}catch(e){if(t.shouldThrowOnError)throw e;if(Hi(e))return{data:null,error:e};throw e}}};let Ql;Ql=Symbol.toStringTag;var jp=class{constructor(t,e){this.downloadFn=t,this.shouldThrowOnError=e,this[Ql]="BlobDownloadBuilder",this.promise=null}asStream(){return new Mp(this.downloadFn,this.shouldThrowOnError)}then(t,e){return this.getPromise().then(t,e)}catch(t){return this.getPromise().catch(t)}finally(t){return this.getPromise().finally(t)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var t=this;try{return{data:await(await t.downloadFn()).blob(),error:null}}catch(e){if(t.shouldThrowOnError)throw e;if(Hi(e))return{data:null,error:e};throw e}}};const Np={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Wa={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var zp=class extends qn{constructor(t,e={},n,s){super(t,e,s,"storage"),this.bucketId=n}async uploadOrUpdate(t,e,n,s){var i=this;return i.handleOperation(async()=>{let o;const r=M(M({},Wa),s);let a=M(M({},i.headers),t==="POST"&&{"x-upsert":String(r.upsert)});const c=r.metadata;typeof Blob<"u"&&n instanceof Blob?(o=new FormData,o.append("cacheControl",r.cacheControl),c&&o.append("metadata",i.encodeMetadata(c)),o.append("",n)):typeof FormData<"u"&&n instanceof FormData?(o=n,o.has("cacheControl")||o.append("cacheControl",r.cacheControl),c&&!o.has("metadata")&&o.append("metadata",i.encodeMetadata(c))):(o=n,a["cache-control"]=`max-age=${r.cacheControl}`,a["content-type"]=r.contentType,c&&(a["x-metadata"]=i.toBase64(i.encodeMetadata(c))),(typeof ReadableStream<"u"&&o instanceof ReadableStream||o&&typeof o=="object"&&"pipe"in o&&typeof o.pipe=="function")&&!r.duplex&&(r.duplex="half")),s!=null&&s.headers&&(a=M(M({},a),s.headers));const l=i._removeEmptyFolders(e),d=i._getFinalPath(l),u=await(t=="PUT"?qo:Ve)(i.fetch,`${i.url}/object/${d}`,o,M({headers:a},r!=null&&r.duplex?{duplex:r.duplex}:{}));return{path:l,id:u.Id,fullPath:u.Key}})}async upload(t,e,n){return this.uploadOrUpdate("POST",t,e,n)}async uploadToSignedUrl(t,e,n,s){var i=this;const o=i._removeEmptyFolders(t),r=i._getFinalPath(o),a=new URL(i.url+`/object/upload/sign/${r}`);return a.searchParams.set("token",e),i.handleOperation(async()=>{let c;const l=M({upsert:Wa.upsert},s),d=M(M({},i.headers),{"x-upsert":String(l.upsert)});return typeof Blob<"u"&&n instanceof Blob?(c=new FormData,c.append("cacheControl",l.cacheControl),c.append("",n)):typeof FormData<"u"&&n instanceof FormData?(c=n,c.append("cacheControl",l.cacheControl)):(c=n,d["cache-control"]=`max-age=${l.cacheControl}`,d["content-type"]=l.contentType),{path:o,fullPath:(await qo(i.fetch,a.toString(),c,{headers:d})).Key}})}async createSignedUploadUrl(t,e){var n=this;return n.handleOperation(async()=>{let s=n._getFinalPath(t);const i=M({},n.headers);e!=null&&e.upsert&&(i["x-upsert"]="true");const o=await Ve(n.fetch,`${n.url}/object/upload/sign/${s}`,{},{headers:i}),r=new URL(n.url+o.url),a=r.searchParams.get("token");if(!a)throw new qi("No token returned by API");return{signedUrl:r.toString(),path:t,token:a}})}async update(t,e,n){return this.uploadOrUpdate("PUT",t,e,n)}async move(t,e,n){var s=this;return s.handleOperation(async()=>await Ve(s.fetch,`${s.url}/object/move`,{bucketId:s.bucketId,sourceKey:t,destinationKey:e,destinationBucket:n==null?void 0:n.destinationBucket},{headers:s.headers}))}async copy(t,e,n){var s=this;return s.handleOperation(async()=>({path:(await Ve(s.fetch,`${s.url}/object/copy`,{bucketId:s.bucketId,sourceKey:t,destinationKey:e,destinationBucket:n==null?void 0:n.destinationBucket},{headers:s.headers})).Key}))}async createSignedUrl(t,e,n){var s=this;return s.handleOperation(async()=>{let i=s._getFinalPath(t),o=await Ve(s.fetch,`${s.url}/object/sign/${i}`,M({expiresIn:e},n!=null&&n.transform?{transform:n.transform}:{}),{headers:s.headers});const r=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return{signedUrl:encodeURI(`${s.url}${o.signedURL}${r}`)}})}async createSignedUrls(t,e,n){var s=this;return s.handleOperation(async()=>{const i=await Ve(s.fetch,`${s.url}/object/sign/${s.bucketId}`,{expiresIn:e,paths:t},{headers:s.headers}),o=n!=null&&n.download?`&download=${n.download===!0?"":n.download}`:"";return i.map(r=>M(M({},r),{},{signedUrl:r.signedURL?encodeURI(`${s.url}${r.signedURL}${o}`):null}))})}download(t,e,n){const s=typeof(e==null?void 0:e.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((e==null?void 0:e.transform)||{}),o=i?`?${i}`:"",r=this._getFinalPath(t),a=()=>Es(this.fetch,`${this.url}/${s}/${r}${o}`,{headers:this.headers,noResolveJson:!0},n);return new jp(a,this.shouldThrowOnError)}async info(t){var e=this;const n=e._getFinalPath(t);return e.handleOperation(async()=>Fo(await Es(e.fetch,`${e.url}/object/info/${n}`,{headers:e.headers})))}async exists(t){var e=this;const n=e._getFinalPath(t);try{return await Rp(e.fetch,`${e.url}/object/${n}`,{headers:e.headers}),{data:!0,error:null}}catch(s){if(e.shouldThrowOnError)throw s;if(Hi(s)&&s instanceof Jl){const i=s.originalError;if([400,404].includes(i==null?void 0:i.status))return{data:!1,error:s}}throw s}}getPublicUrl(t,e){const n=this._getFinalPath(t),s=[],i=e!=null&&e.download?`download=${e.download===!0?"":e.download}`:"";i!==""&&s.push(i);const o=typeof(e==null?void 0:e.transform)<"u"?"render/image":"object",r=this.transformOptsToQueryString((e==null?void 0:e.transform)||{});r!==""&&s.push(r);let a=s.join("&");return a!==""&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${n}${a}`)}}}async remove(t){var e=this;return e.handleOperation(async()=>await hr(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:t},{headers:e.headers}))}async list(t,e,n){var s=this;return s.handleOperation(async()=>{const i=M(M(M({},Np),e),{},{prefix:t||""});return await Ve(s.fetch,`${s.url}/object/list/${s.bucketId}`,i,{headers:s.headers},n)})}async listV2(t,e){var n=this;return n.handleOperation(async()=>{const s=M({},t);return await Ve(n.fetch,`${n.url}/object/list-v2/${n.bucketId}`,s,{headers:n.headers},e)})}encodeMetadata(t){return JSON.stringify(t)}toBase64(t){return typeof Buffer<"u"?Buffer.from(t).toString("base64"):btoa(t)}_getFinalPath(t){return`${this.bucketId}/${t.replace(/^\/+/,"")}`}_removeEmptyFolders(t){return t.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(t){const e=[];return t.width&&e.push(`width=${t.width}`),t.height&&e.push(`height=${t.height}`),t.resize&&e.push(`resize=${t.resize}`),t.format&&e.push(`format=${t.format}`),t.quality&&e.push(`quality=${t.quality}`),e.join("&")}};const Up="2.98.0",Us={"X-Client-Info":`storage-js/${Up}`};var Fp=class extends qn{constructor(t,e={},n,s){const i=new URL(t);s!=null&&s.useNewHostname&&/supabase\.(co|in|red)$/.test(i.hostname)&&!i.hostname.includes("storage.supabase.")&&(i.hostname=i.hostname.replace("supabase.","storage.supabase."));const o=i.href.replace(/\/$/,""),r=M(M({},Us),e);super(o,r,n,"storage")}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const n=e.listBucketOptionsToQueryString(t);return await Es(e.fetch,`${e.url}/bucket${n}`,{headers:e.headers})})}async getBucket(t){var e=this;return e.handleOperation(async()=>await Es(e.fetch,`${e.url}/bucket/${t}`,{headers:e.headers}))}async createBucket(t,e={public:!1}){var n=this;return n.handleOperation(async()=>await Ve(n.fetch,`${n.url}/bucket`,{id:t,name:t,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:n.headers}))}async updateBucket(t,e){var n=this;return n.handleOperation(async()=>await qo(n.fetch,`${n.url}/bucket/${t}`,{id:t,name:t,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:n.headers}))}async emptyBucket(t){var e=this;return e.handleOperation(async()=>await Ve(e.fetch,`${e.url}/bucket/${t}/empty`,{},{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await hr(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}listBucketOptionsToQueryString(t){const e={};return t&&("limit"in t&&(e.limit=String(t.limit)),"offset"in t&&(e.offset=String(t.offset)),t.search&&(e.search=t.search),t.sortColumn&&(e.sortColumn=t.sortColumn),t.sortOrder&&(e.sortOrder=t.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},qp=class extends qn{constructor(t,e={},n){const s=t.replace(/\/$/,""),i=M(M({},Us),e);super(s,i,n,"storage")}async createBucket(t){var e=this;return e.handleOperation(async()=>await Ve(e.fetch,`${e.url}/bucket`,{name:t},{headers:e.headers}))}async listBuckets(t){var e=this;return e.handleOperation(async()=>{const n=new URLSearchParams;(t==null?void 0:t.limit)!==void 0&&n.set("limit",t.limit.toString()),(t==null?void 0:t.offset)!==void 0&&n.set("offset",t.offset.toString()),t!=null&&t.sortColumn&&n.set("sortColumn",t.sortColumn),t!=null&&t.sortOrder&&n.set("sortOrder",t.sortOrder),t!=null&&t.search&&n.set("search",t.search);const s=n.toString(),i=s?`${e.url}/bucket?${s}`:`${e.url}/bucket`;return await Es(e.fetch,i,{headers:e.headers})})}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await hr(e.fetch,`${e.url}/bucket/${t}`,{},{headers:e.headers}))}from(t){var e=this;if(!Cp(t))throw new qi("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const n=new Ep({baseUrl:this.url,catalogName:t,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),s=this.shouldThrowOnError;return new Proxy(n,{get(i,o){const r=i[o];return typeof r!="function"?r:async(...a)=>{try{return{data:await r.apply(i,a),error:null}}catch(c){if(s)throw c;return{data:null,error:c}}}}})}},Hp=class extends qn{constructor(t,e={},n){const s=t.replace(/\/$/,""),i=M(M({},Us),{},{"Content-Type":"application/json"},e);super(s,i,n,"vectors")}async createIndex(t){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/CreateIndex`,t,{headers:e.headers})||{})}async getIndex(t,e){var n=this;return n.handleOperation(async()=>await Le.post(n.fetch,`${n.url}/GetIndex`,{vectorBucketName:t,indexName:e},{headers:n.headers}))}async listIndexes(t){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/ListIndexes`,t,{headers:e.headers}))}async deleteIndex(t,e){var n=this;return n.handleOperation(async()=>await Le.post(n.fetch,`${n.url}/DeleteIndex`,{vectorBucketName:t,indexName:e},{headers:n.headers})||{})}},Wp=class extends qn{constructor(t,e={},n){const s=t.replace(/\/$/,""),i=M(M({},Us),{},{"Content-Type":"application/json"},e);super(s,i,n,"vectors")}async putVectors(t){var e=this;if(t.vectors.length<1||t.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/PutVectors`,t,{headers:e.headers})||{})}async getVectors(t){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/GetVectors`,t,{headers:e.headers}))}async listVectors(t){var e=this;if(t.segmentCount!==void 0){if(t.segmentCount<1||t.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(t.segmentIndex!==void 0&&(t.segmentIndex<0||t.segmentIndex>=t.segmentCount))throw new Error(`segmentIndex must be between 0 and ${t.segmentCount-1}`)}return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/ListVectors`,t,{headers:e.headers}))}async queryVectors(t){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/QueryVectors`,t,{headers:e.headers}))}async deleteVectors(t){var e=this;if(t.keys.length<1||t.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/DeleteVectors`,t,{headers:e.headers})||{})}},Gp=class extends qn{constructor(t,e={},n){const s=t.replace(/\/$/,""),i=M(M({},Us),{},{"Content-Type":"application/json"},e);super(s,i,n,"vectors")}async createBucket(t){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}async getBucket(t){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:t},{headers:e.headers}))}async listBuckets(t={}){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/ListVectorBuckets`,t,{headers:e.headers}))}async deleteBucket(t){var e=this;return e.handleOperation(async()=>await Le.post(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:t},{headers:e.headers})||{})}},Vp=class extends Gp{constructor(t,e={}){super(t,e.headers||{},e.fetch)}from(t){return new Kp(this.url,this.headers,t,this.fetch)}async createBucket(t){var e=()=>super.createBucket,n=this;return e().call(n,t)}async getBucket(t){var e=()=>super.getBucket,n=this;return e().call(n,t)}async listBuckets(t={}){var e=()=>super.listBuckets,n=this;return e().call(n,t)}async deleteBucket(t){var e=()=>super.deleteBucket,n=this;return e().call(n,t)}},Kp=class extends Hp{constructor(t,e,n,s){super(t,e,s),this.vectorBucketName=n}async createIndex(t){var e=()=>super.createIndex,n=this;return e().call(n,M(M({},t),{},{vectorBucketName:n.vectorBucketName}))}async listIndexes(t={}){var e=()=>super.listIndexes,n=this;return e().call(n,M(M({},t),{},{vectorBucketName:n.vectorBucketName}))}async getIndex(t){var e=()=>super.getIndex,n=this;return e().call(n,n.vectorBucketName,t)}async deleteIndex(t){var e=()=>super.deleteIndex,n=this;return e().call(n,n.vectorBucketName,t)}index(t){return new Jp(this.url,this.headers,this.vectorBucketName,t,this.fetch)}},Jp=class extends Wp{constructor(t,e,n,s,i){super(t,e,i),this.vectorBucketName=n,this.indexName=s}async putVectors(t){var e=()=>super.putVectors,n=this;return e().call(n,M(M({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async getVectors(t){var e=()=>super.getVectors,n=this;return e().call(n,M(M({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async listVectors(t={}){var e=()=>super.listVectors,n=this;return e().call(n,M(M({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async queryVectors(t){var e=()=>super.queryVectors,n=this;return e().call(n,M(M({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}async deleteVectors(t){var e=()=>super.deleteVectors,n=this;return e().call(n,M(M({},t),{},{vectorBucketName:n.vectorBucketName,indexName:n.indexName}))}},Yp=class extends Fp{constructor(t,e={},n,s){super(t,e,n,s)}from(t){return new zp(this.url,this.headers,t,this.fetch)}get vectors(){return new Vp(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new qp(this.url+"/iceberg",this.headers,this.fetch)}};const Xl="2.98.0",En=30*1e3,Ho=3,xo=Ho*En,Qp="http://localhost:9999",Xp="supabase.auth.token",Zp={"X-Client-Info":`gotrue-js/${Xl}`},Wo="X-Supabase-Api-Version",Zl={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},ef=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,tf=10*60*1e3;class Is extends Error{constructor(e,n,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=n,this.code=s}}function A(t){return typeof t=="object"&&t!==null&&"__isAuthError"in t}class nf extends Is{constructor(e,n,s){super(e,n,s),this.name="AuthApiError",this.status=n,this.code=s}}function sf(t){return A(t)&&t.name==="AuthApiError"}class Gt extends Is{constructor(e,n){super(e),this.name="AuthUnknownError",this.originalError=n}}class wt extends Is{constructor(e,n,s,i){super(e,s,i),this.name=n,this.status=s}}class Oe extends wt{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function _o(t){return A(t)&&t.name==="AuthSessionMissingError"}class wn extends wt{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class di extends wt{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class ui extends wt{constructor(e,n=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=n}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function of(t){return A(t)&&t.name==="AuthImplicitGrantRedirectError"}class Ga extends wt{constructor(e,n=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=n}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class rf extends wt{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class Go extends wt{constructor(e,n){super(e,"AuthRetryableFetchError",n,void 0)}}function So(t){return A(t)&&t.name==="AuthRetryableFetchError"}class Va extends wt{constructor(e,n,s){super(e,"AuthWeakPasswordError",n,"weak_password"),this.reasons=s}}class Vo extends wt{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Ii="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Ka=` 	
\r=`.split(""),af=(()=>{const t=new Array(128);for(let e=0;e<t.length;e+=1)t[e]=-1;for(let e=0;e<Ka.length;e+=1)t[Ka[e].charCodeAt(0)]=-2;for(let e=0;e<Ii.length;e+=1)t[Ii[e].charCodeAt(0)]=e;return t})();function Ja(t,e,n){if(t!==null)for(e.queue=e.queue<<8|t,e.queuedBits+=8;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;n(Ii[s]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;n(Ii[s]),e.queuedBits-=6}}function ec(t,e,n){const s=af[t];if(s>-1)for(e.queue=e.queue<<6|s,e.queuedBits+=6;e.queuedBits>=8;)n(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(t)}"`)}}function Ya(t){const e=[],n=r=>{e.push(String.fromCodePoint(r))},s={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},o=r=>{df(r,s,n)};for(let r=0;r<t.length;r+=1)ec(t.charCodeAt(r),i,o);return e.join("")}function lf(t,e){if(t<=127){e(t);return}else if(t<=2047){e(192|t>>6),e(128|t&63);return}else if(t<=65535){e(224|t>>12),e(128|t>>6&63),e(128|t&63);return}else if(t<=1114111){e(240|t>>18),e(128|t>>12&63),e(128|t>>6&63),e(128|t&63);return}throw new Error(`Unrecognized Unicode codepoint: ${t.toString(16)}`)}function cf(t,e){for(let n=0;n<t.length;n+=1){let s=t.charCodeAt(n);if(s>55295&&s<=56319){const i=(s-55296)*1024&65535;s=(t.charCodeAt(n+1)-56320&65535|i)+65536,n+=1}lf(s,e)}}function df(t,e,n){if(e.utf8seq===0){if(t<=127){n(t);return}for(let s=1;s<6;s+=1)if(!(t>>7-s&1)){e.utf8seq=s;break}if(e.utf8seq===2)e.codepoint=t&31;else if(e.utf8seq===3)e.codepoint=t&15;else if(e.utf8seq===4)e.codepoint=t&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(t<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|t&63,e.utf8seq-=1,e.utf8seq===0&&n(e.codepoint)}}function Mn(t){const e=[],n={queue:0,queuedBits:0},s=i=>{e.push(i)};for(let i=0;i<t.length;i+=1)ec(t.charCodeAt(i),n,s);return new Uint8Array(e)}function uf(t){const e=[];return cf(t,n=>e.push(n)),new Uint8Array(e)}function Jt(t){const e=[],n={queue:0,queuedBits:0},s=i=>{e.push(i)};return t.forEach(i=>Ja(i,n,s)),Ja(null,n,s),e.join("")}function pf(t){return Math.round(Date.now()/1e3)+t}function ff(){return Symbol("auth-callback")}const ue=()=>typeof window<"u"&&typeof document<"u",Ut={tested:!1,writable:!1},tc=()=>{if(!ue())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Ut.tested)return Ut.writable;const t=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(t,t),globalThis.localStorage.removeItem(t),Ut.tested=!0,Ut.writable=!0}catch{Ut.tested=!0,Ut.writable=!1}return Ut.writable};function hf(t){const e={},n=new URL(t);if(n.hash&&n.hash[0]==="#")try{new URLSearchParams(n.hash.substring(1)).forEach((i,o)=>{e[o]=i})}catch{}return n.searchParams.forEach((s,i)=>{e[i]=s}),e}const nc=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),mf=t=>typeof t=="object"&&t!==null&&"status"in t&&"ok"in t&&"json"in t&&typeof t.json=="function",In=async(t,e,n)=>{await t.setItem(e,JSON.stringify(n))},Ft=async(t,e)=>{const n=await t.getItem(e);if(!n)return null;try{return JSON.parse(n)}catch{return n}},de=async(t,e)=>{await t.removeItem(e)};class Wi{constructor(){this.promise=new Wi.promiseConstructor((e,n)=>{this.resolve=e,this.reject=n})}}Wi.promiseConstructor=Promise;function pi(t){const e=t.split(".");if(e.length!==3)throw new Vo("Invalid JWT structure");for(let s=0;s<e.length;s++)if(!ef.test(e[s]))throw new Vo("JWT not in base64url format");return{header:JSON.parse(Ya(e[0])),payload:JSON.parse(Ya(e[1])),signature:Mn(e[2]),raw:{header:e[0],payload:e[1]}}}async function gf(t){return await new Promise(e=>{setTimeout(()=>e(null),t)})}function yf(t,e){return new Promise((s,i)=>{(async()=>{for(let o=0;o<1/0;o++)try{const r=await t(o);if(!e(o,null,r)){s(r);return}}catch(r){if(!e(o,r)){i(r);return}}})()})}function vf(t){return("0"+t.toString(16)).substr(-2)}function bf(){const e=new Uint32Array(56);if(typeof crypto>"u"){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=n.length;let i="";for(let o=0;o<56;o++)i+=n.charAt(Math.floor(Math.random()*s));return i}return crypto.getRandomValues(e),Array.from(e,vf).join("")}async function wf(t){const n=new TextEncoder().encode(t),s=await crypto.subtle.digest("SHA-256",n),i=new Uint8Array(s);return Array.from(i).map(o=>String.fromCharCode(o)).join("")}async function xf(t){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),t;const n=await wf(t);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function xn(t,e,n=!1){const s=bf();let i=s;n&&(i+="/PASSWORD_RECOVERY"),await In(t,`${e}-code-verifier`,i);const o=await xf(s);return[o,s===o?"plain":"s256"]}const _f=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Sf(t){const e=t.headers.get(Wo);if(!e||!e.match(_f))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function kf(t){if(!t)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(t<=e)throw new Error("JWT has expired")}function $f(t){switch(t){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Ef=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function _n(t){if(!Ef.test(t))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function ko(){const t={};return new Proxy(t,{get:(e,n)=>{if(n==="__isUserNotAvailableProxy")return!0;if(typeof n=="symbol"){const s=n.toString();if(s==="Symbol(Symbol.toPrimitive)"||s==="Symbol(Symbol.toStringTag)"||s==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${n}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,n)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${n}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,n)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${n}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function If(t,e){return new Proxy(t,{get:(n,s,i)=>{if(s==="__isInsecureUserWarningProxy")return!0;if(typeof s=="symbol"){const o=s.toString();if(o==="Symbol(Symbol.toPrimitive)"||o==="Symbol(Symbol.toStringTag)"||o==="Symbol(util.inspect.custom)"||o==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(n,s,i)}return!e.value&&typeof s=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(n,s,i)}})}function Qa(t){return JSON.parse(JSON.stringify(t))}const qt=t=>t.msg||t.message||t.error_description||t.error||JSON.stringify(t),Tf=[502,503,504];async function Xa(t){var e;if(!mf(t))throw new Go(qt(t),0);if(Tf.includes(t.status))throw new Go(qt(t),t.status);let n;try{n=await t.json()}catch(o){throw new Gt(qt(o),o)}let s;const i=Sf(t);if(i&&i.getTime()>=Zl["2024-01-01"].timestamp&&typeof n=="object"&&n&&typeof n.code=="string"?s=n.code:typeof n=="object"&&n&&typeof n.error_code=="string"&&(s=n.error_code),s){if(s==="weak_password")throw new Va(qt(n),t.status,((e=n.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(s==="session_not_found")throw new Oe}else if(typeof n=="object"&&n&&typeof n.weak_password=="object"&&n.weak_password&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.reasons.reduce((o,r)=>o&&typeof r=="string",!0))throw new Va(qt(n),t.status,n.weak_password.reasons);throw new nf(qt(n),t.status||500,s)}const Cf=(t,e,n,s)=>{const i={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),i.body=JSON.stringify(s),Object.assign(Object.assign({},i),n))};async function j(t,e,n,s){var i;const o=Object.assign({},s==null?void 0:s.headers);o[Wo]||(o[Wo]=Zl["2024-01-01"].name),s!=null&&s.jwt&&(o.Authorization=`Bearer ${s.jwt}`);const r=(i=s==null?void 0:s.query)!==null&&i!==void 0?i:{};s!=null&&s.redirectTo&&(r.redirect_to=s.redirectTo);const a=Object.keys(r).length?"?"+new URLSearchParams(r).toString():"",c=await Pf(t,e,n+a,{headers:o,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(c):{data:Object.assign({},c),error:null}}async function Pf(t,e,n,s,i,o){const r=Cf(e,s,i,o);let a;try{a=await t(n,Object.assign({},r))}catch(c){throw console.error(c),new Go(qt(c),0)}if(a.ok||await Xa(a),s!=null&&s.noResolveJson)return a;try{return await a.json()}catch(c){await Xa(c)}}function Ge(t){var e;let n=null;Of(t)&&(n=Object.assign({},t),t.expires_at||(n.expires_at=pf(t.expires_in)));const s=(e=t.user)!==null&&e!==void 0?e:t;return{data:{session:n,user:s},error:null}}function Za(t){const e=Ge(t);return!e.error&&t.weak_password&&typeof t.weak_password=="object"&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.message&&typeof t.weak_password.message=="string"&&t.weak_password.reasons.reduce((n,s)=>n&&typeof s=="string",!0)&&(e.data.weak_password=t.weak_password),e}function $t(t){var e;return{data:{user:(e=t.user)!==null&&e!==void 0?e:t},error:null}}function Df(t){return{data:t,error:null}}function Bf(t){const{action_link:e,email_otp:n,hashed_token:s,redirect_to:i,verification_type:o}=t,r=Fi(t,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:n,hashed_token:s,redirect_to:i,verification_type:o},c=Object.assign({},r);return{data:{properties:a,user:c},error:null}}function el(t){return t}function Of(t){return t.access_token&&t.refresh_token&&t.expires_in}const $o=["global","local","others"];class Af{constructor({url:e="",headers:n={},fetch:s}){this.url=e,this.headers=n,this.fetch=nc(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,n=$o[0]){if($o.indexOf(n)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${$o.join(", ")}`);try{return await j(this.fetch,"POST",`${this.url}/logout?scope=${n}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(A(s))return{data:null,error:s};throw s}}async inviteUserByEmail(e,n={}){try{return await j(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:n.data},headers:this.headers,redirectTo:n.redirectTo,xform:$t})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async generateLink(e){try{const{options:n}=e,s=Fi(e,["options"]),i=Object.assign(Object.assign({},s),n);return"newEmail"in s&&(i.new_email=s==null?void 0:s.newEmail,delete i.newEmail),await j(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:Bf,redirectTo:n==null?void 0:n.redirectTo})}catch(n){if(A(n))return{data:{properties:null,user:null},error:n};throw n}}async createUser(e){try{return await j(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:$t})}catch(n){if(A(n))return{data:{user:null},error:n};throw n}}async listUsers(e){var n,s,i,o,r,a,c;try{const l={nextPage:null,lastPage:0,total:0},d=await j(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(n=e==null?void 0:e.page)===null||n===void 0?void 0:n.toString())!==null&&s!==void 0?s:"",per_page:(o=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&o!==void 0?o:""},xform:el});if(d.error)throw d.error;const u=await d.json(),p=(r=d.headers.get("x-total-count"))!==null&&r!==void 0?r:0,h=(c=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&c!==void 0?c:[];return h.length>0&&(h.forEach(f=>{const g=parseInt(f.split(";")[0].split("=")[1].substring(0,1)),m=JSON.parse(f.split(";")[1].split("=")[1]);l[`${m}Page`]=g}),l.total=parseInt(p)),{data:Object.assign(Object.assign({},u),l),error:null}}catch(l){if(A(l))return{data:{users:[]},error:l};throw l}}async getUserById(e){_n(e);try{return await j(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:$t})}catch(n){if(A(n))return{data:{user:null},error:n};throw n}}async updateUserById(e,n){_n(e);try{return await j(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:n,headers:this.headers,xform:$t})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async deleteUser(e,n=!1){_n(e);try{return await j(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:n},xform:$t})}catch(s){if(A(s))return{data:{user:null},error:s};throw s}}async _listFactors(e){_n(e.userId);try{const{data:n,error:s}=await j(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:n,error:s}}catch(n){if(A(n))return{data:null,error:n};throw n}}async _deleteFactor(e){_n(e.userId),_n(e.id);try{return{data:await j(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(n){if(A(n))return{data:null,error:n};throw n}}async _listOAuthClients(e){var n,s,i,o,r,a,c;try{const l={nextPage:null,lastPage:0,total:0},d=await j(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(n=e==null?void 0:e.page)===null||n===void 0?void 0:n.toString())!==null&&s!==void 0?s:"",per_page:(o=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&o!==void 0?o:""},xform:el});if(d.error)throw d.error;const u=await d.json(),p=(r=d.headers.get("x-total-count"))!==null&&r!==void 0?r:0,h=(c=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&c!==void 0?c:[];return h.length>0&&(h.forEach(f=>{const g=parseInt(f.split(";")[0].split("=")[1].substring(0,1)),m=JSON.parse(f.split(";")[1].split("=")[1]);l[`${m}Page`]=g}),l.total=parseInt(p)),{data:Object.assign(Object.assign({},u),l),error:null}}catch(l){if(A(l))return{data:{clients:[]},error:l};throw l}}async _createOAuthClient(e){try{return await j(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:n=>({data:n,error:null})})}catch(n){if(A(n))return{data:null,error:n};throw n}}async _getOAuthClient(e){try{return await j(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:n=>({data:n,error:null})})}catch(n){if(A(n))return{data:null,error:n};throw n}}async _updateOAuthClient(e,n){try{return await j(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:n,headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(A(s))return{data:null,error:s};throw s}}async _deleteOAuthClient(e){try{return await j(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(n){if(A(n))return{data:null,error:n};throw n}}async _regenerateOAuthClientSecret(e){try{return await j(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:n=>({data:n,error:null})})}catch(n){if(A(n))return{data:null,error:n};throw n}}}function tl(t={}){return{getItem:e=>t[e]||null,setItem:(e,n)=>{t[e]=n},removeItem:e=>{delete t[e]}}}const ut={debug:!!(globalThis&&tc()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class sc extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Lf extends sc{}async function Rf(t,e,n){ut.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",t,e);const s=new globalThis.AbortController;e>0&&setTimeout(()=>{s.abort(),ut.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",t)},e),await Promise.resolve();try{return await globalThis.navigator.locks.request(t,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async i=>{if(i){ut.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",t,i.name);try{return await n()}finally{ut.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",t,i.name)}}else{if(e===0)throw ut.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",t),new Lf(`Acquiring an exclusive Navigator LockManager lock "${t}" immediately failed`);if(ut.debug)try{const o=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(o,null,"  "))}catch(o){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",o)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await n()}})}catch(i){if((i==null?void 0:i.name)==="AbortError"&&e>0)return ut.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire timeout, recovering by stealing lock",t),console.warn(`@supabase/gotrue-js: Lock "${t}" was not released within ${e}ms. This may indicate an orphaned lock from a component unmount (e.g., React Strict Mode). Forcefully acquiring the lock to recover.`),await Promise.resolve().then(()=>globalThis.navigator.locks.request(t,{mode:"exclusive",steal:!0},async o=>{if(o){ut.debug&&console.log("@supabase/gotrue-js: navigatorLock: recovered (stolen)",t,o.name);try{return await n()}finally{ut.debug&&console.log("@supabase/gotrue-js: navigatorLock: released (stolen)",t,o.name)}}else return console.warn("@supabase/gotrue-js: Navigator LockManager returned null lock even with steal: true"),await n()}));throw i}}function Mf(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function ic(t){if(!/^0x[a-fA-F0-9]{40}$/.test(t))throw new Error(`@supabase/auth-js: Address "${t}" is invalid.`);return t.toLowerCase()}function jf(t){return parseInt(t,16)}function Nf(t){const e=new TextEncoder().encode(t);return"0x"+Array.from(e,s=>s.toString(16).padStart(2,"0")).join("")}function zf(t){var e;const{chainId:n,domain:s,expirationTime:i,issuedAt:o=new Date,nonce:r,notBefore:a,requestId:c,resources:l,scheme:d,uri:u,version:p}=t;{if(!Number.isInteger(n))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${n}`);if(!s)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(r&&r.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${r}`);if(!u)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(p!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${p}`);if(!((e=t.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${t.statement}`)}const h=ic(t.address),f=d?`${d}://${s}`:s,g=t.statement?`${t.statement}
`:"",m=`${f} wants you to sign in with your Ethereum account:
${h}

${g}`;let v=`URI: ${u}
Version: ${p}
Chain ID: ${n}${r?`
Nonce: ${r}`:""}
Issued At: ${o.toISOString()}`;if(i&&(v+=`
Expiration Time: ${i.toISOString()}`),a&&(v+=`
Not Before: ${a.toISOString()}`),c&&(v+=`
Request ID: ${c}`),l){let E=`
Resources:`;for(const w of l){if(!w||typeof w!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${w}`);E+=`
- ${w}`}v+=E}return`${m}
${v}`}class re extends Error{constructor({message:e,code:n,cause:s,name:i}){var o;super(e,{cause:s}),this.__isWebAuthnError=!0,this.name=(o=i??(s instanceof Error?s.name:void 0))!==null&&o!==void 0?o:"Unknown Error",this.code=n}}class Ti extends re{constructor(e,n){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n,message:e}),this.name="WebAuthnUnknownError",this.originalError=n}}function Uf({error:t,options:e}){var n,s,i;const{publicKey:o}=e;if(!o)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new re({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else if(t.name==="ConstraintError"){if(((n=o.authenticatorSelection)===null||n===void 0?void 0:n.requireResidentKey)===!0)return new re({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:t});if(e.mediation==="conditional"&&((s=o.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new re({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:t});if(((i=o.authenticatorSelection)===null||i===void 0?void 0:i.userVerification)==="required")return new re({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:t})}else{if(t.name==="InvalidStateError")return new re({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:t});if(t.name==="NotAllowedError")return new re({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="NotSupportedError")return o.pubKeyCredParams.filter(a=>a.type==="public-key").length===0?new re({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:t}):new re({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:t});if(t.name==="SecurityError"){const r=window.location.hostname;if(oc(r)){if(o.rp.id!==r)return new re({message:`The RP ID "${o.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new re({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="TypeError"){if(o.user.id.byteLength<1||o.user.id.byteLength>64)return new re({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:t})}else if(t.name==="UnknownError")return new re({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new re({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}function Ff({error:t,options:e}){const{publicKey:n}=e;if(!n)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(e.signal instanceof AbortSignal)return new re({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else{if(t.name==="NotAllowedError")return new re({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="SecurityError"){const s=window.location.hostname;if(oc(s)){if(n.rpId!==s)return new re({message:`The RP ID "${n.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new re({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="UnknownError")return new re({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return new re({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t})}class qf{createNewAbortSignal(){if(this.controller){const n=new Error("Cancelling existing WebAuthn API call for new one");n.name="AbortError",this.controller.abort(n)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const Hf=new qf;function Wf(t){if(!t)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(t);const{challenge:e,user:n,excludeCredentials:s}=t,i=Fi(t,["challenge","user","excludeCredentials"]),o=Mn(e).buffer,r=Object.assign(Object.assign({},n),{id:Mn(n.id).buffer}),a=Object.assign(Object.assign({},i),{challenge:o,user:r});if(s&&s.length>0){a.excludeCredentials=new Array(s.length);for(let c=0;c<s.length;c++){const l=s[c];a.excludeCredentials[c]=Object.assign(Object.assign({},l),{id:Mn(l.id).buffer,type:l.type||"public-key",transports:l.transports})}}return a}function Gf(t){if(!t)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(t);const{challenge:e,allowCredentials:n}=t,s=Fi(t,["challenge","allowCredentials"]),i=Mn(e).buffer,o=Object.assign(Object.assign({},s),{challenge:i});if(n&&n.length>0){o.allowCredentials=new Array(n.length);for(let r=0;r<n.length;r++){const a=n[r];o.allowCredentials[r]=Object.assign(Object.assign({},a),{id:Mn(a.id).buffer,type:a.type||"public-key",transports:a.transports})}}return o}function Vf(t){var e;if("toJSON"in t&&typeof t.toJSON=="function")return t.toJSON();const n=t;return{id:t.id,rawId:t.id,response:{attestationObject:Jt(new Uint8Array(t.response.attestationObject)),clientDataJSON:Jt(new Uint8Array(t.response.clientDataJSON))},type:"public-key",clientExtensionResults:t.getClientExtensionResults(),authenticatorAttachment:(e=n.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function Kf(t){var e;if("toJSON"in t&&typeof t.toJSON=="function")return t.toJSON();const n=t,s=t.getClientExtensionResults(),i=t.response;return{id:t.id,rawId:t.id,response:{authenticatorData:Jt(new Uint8Array(i.authenticatorData)),clientDataJSON:Jt(new Uint8Array(i.clientDataJSON)),signature:Jt(new Uint8Array(i.signature)),userHandle:i.userHandle?Jt(new Uint8Array(i.userHandle)):void 0},type:"public-key",clientExtensionResults:s,authenticatorAttachment:(e=n.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function oc(t){return t==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(t)}function nl(){var t,e;return!!(ue()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((t=navigator==null?void 0:navigator.credentials)===null||t===void 0?void 0:t.create)=="function"&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.get)=="function")}async function Jf(t){try{const e=await navigator.credentials.create(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ti("Browser returned unexpected credential type",e)}:{data:null,error:new Ti("Empty credential response",e)}}catch(e){return{data:null,error:Uf({error:e,options:t})}}}async function Yf(t){try{const e=await navigator.credentials.get(t);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ti("Browser returned unexpected credential type",e)}:{data:null,error:new Ti("Empty credential response",e)}}catch(e){return{data:null,error:Ff({error:e,options:t})}}}const Qf={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},Xf={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Ci(...t){const e=i=>i!==null&&typeof i=="object"&&!Array.isArray(i),n=i=>i instanceof ArrayBuffer||ArrayBuffer.isView(i),s={};for(const i of t)if(i)for(const o in i){const r=i[o];if(r!==void 0)if(Array.isArray(r))s[o]=r;else if(n(r))s[o]=r;else if(e(r)){const a=s[o];e(a)?s[o]=Ci(a,r):s[o]=Ci(r)}else s[o]=r}return s}function Zf(t,e){return Ci(Qf,t,e||{})}function eh(t,e){return Ci(Xf,t,e||{})}class th{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:n,friendlyName:s,signal:i},o){var r;try{const{data:a,error:c}=await this.client.mfa.challenge({factorId:e,webauthn:n});if(!a)return{data:null,error:c};const l=i??Hf.createNewAbortSignal();if(a.webauthn.type==="create"){const{user:d}=a.webauthn.credential_options.publicKey;if(!d.name){const u=s;if(u)d.name=`${d.id}:${u}`;else{const h=(await this.client.getUser()).data.user,f=((r=h==null?void 0:h.user_metadata)===null||r===void 0?void 0:r.name)||(h==null?void 0:h.email)||(h==null?void 0:h.id)||"User";d.name=`${d.id}:${f}`}}d.displayName||(d.displayName=d.name)}switch(a.webauthn.type){case"create":{const d=Zf(a.webauthn.credential_options.publicKey,o==null?void 0:o.create),{data:u,error:p}=await Jf({publicKey:d,signal:l});return u?{data:{factorId:e,challengeId:a.id,webauthn:{type:a.webauthn.type,credential_response:u}},error:null}:{data:null,error:p}}case"request":{const d=eh(a.webauthn.credential_options.publicKey,o==null?void 0:o.request),{data:u,error:p}=await Yf(Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:d,signal:l}));return u?{data:{factorId:e,challengeId:a.id,webauthn:{type:a.webauthn.type,credential_response:u}},error:null}:{data:null,error:p}}}}catch(a){return A(a)?{data:null,error:a}:{data:null,error:new Gt("Unexpected error in challenge",a)}}}async _verify({challengeId:e,factorId:n,webauthn:s}){return this.client.mfa.verify({factorId:n,challengeId:e,webauthn:s})}async _authenticate({factorId:e,webauthn:{rpId:n=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},o){if(!n)return{data:null,error:new Is("rpId is required for WebAuthn authentication")};try{if(!nl())return{data:null,error:new Gt("Browser does not support WebAuthn",null)};const{data:r,error:a}=await this.challenge({factorId:e,webauthn:{rpId:n,rpOrigins:s},signal:i},{request:o});if(!r)return{data:null,error:a};const{webauthn:c}=r;return this._verify({factorId:e,challengeId:r.challengeId,webauthn:{type:c.type,rpId:n,rpOrigins:s,credential_response:c.credential_response}})}catch(r){return A(r)?{data:null,error:r}:{data:null,error:new Gt("Unexpected error in authenticate",r)}}}async _register({friendlyName:e,webauthn:{rpId:n=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},o){if(!n)return{data:null,error:new Is("rpId is required for WebAuthn registration")};try{if(!nl())return{data:null,error:new Gt("Browser does not support WebAuthn",null)};const{data:r,error:a}=await this._enroll({friendlyName:e});if(!r)return await this.client.mfa.listFactors().then(d=>{var u;return(u=d.data)===null||u===void 0?void 0:u.all.find(p=>p.factor_type==="webauthn"&&p.friendly_name===e&&p.status!=="unverified")}).then(d=>d?this.client.mfa.unenroll({factorId:d==null?void 0:d.id}):void 0),{data:null,error:a};const{data:c,error:l}=await this._challenge({factorId:r.id,friendlyName:r.friendly_name,webauthn:{rpId:n,rpOrigins:s},signal:i},{create:o});return c?this._verify({factorId:r.id,challengeId:c.challengeId,webauthn:{rpId:n,rpOrigins:s,type:c.webauthn.type,credential_response:c.webauthn.credential_response}}):{data:null,error:l}}catch(r){return A(r)?{data:null,error:r}:{data:null,error:new Gt("Unexpected error in register",r)}}}}Mf();const nh={url:Qp,storageKey:Xp,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Zp,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:5e3,skipAutoInitialize:!1};async function sl(t,e,n){return await n()}const Sn={};class Ts{get jwks(){var e,n;return(n=(e=Sn[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&n!==void 0?n:{keys:[]}}set jwks(e){Sn[this.storageKey]=Object.assign(Object.assign({},Sn[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,n;return(n=(e=Sn[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&n!==void 0?n:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){Sn[this.storageKey]=Object.assign(Object.assign({},Sn[this.storageKey]),{cachedAt:e})}constructor(e){var n,s,i;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const o=Object.assign(Object.assign({},nh),e);if(this.storageKey=o.storageKey,this.instanceID=(n=Ts.nextInstanceID[this.storageKey])!==null&&n!==void 0?n:0,Ts.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!o.debug,typeof o.debug=="function"&&(this.logger=o.debug),this.instanceID>0&&ue()){const r=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(r),this.logDebugMessages&&console.trace(r)}if(this.persistSession=o.persistSession,this.autoRefreshToken=o.autoRefreshToken,this.admin=new Af({url:o.url,headers:o.headers,fetch:o.fetch}),this.url=o.url,this.headers=o.headers,this.fetch=nc(o.fetch),this.lock=o.lock||sl,this.detectSessionInUrl=o.detectSessionInUrl,this.flowType=o.flowType,this.hasCustomAuthorizationHeader=o.hasCustomAuthorizationHeader,this.throwOnError=o.throwOnError,this.lockAcquireTimeout=o.lockAcquireTimeout,o.lock?this.lock=o.lock:this.persistSession&&ue()&&(!((s=globalThis==null?void 0:globalThis.navigator)===null||s===void 0)&&s.locks)?this.lock=Rf:this.lock=sl,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new th(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(o.storage?this.storage=o.storage:tc()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=tl(this.memoryStorage)),o.userStorage&&(this.userStorage=o.userStorage)):(this.memoryStorage={},this.storage=tl(this.memoryStorage)),ue()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(r){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",r)}(i=this.broadcastChannel)===null||i===void 0||i.addEventListener("message",async r=>{this._debug("received broadcast notification from other tab or client",r);try{await this._notifyAllSubscribers(r.data.event,r.data.session,!1)}catch(a){this._debug("#broadcastChannel","error",a)}})}o.skipAutoInitialize||this.initialize().catch(r=>{this._debug("#initialize()","error",r)})}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${Xl}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let n={},s="none";if(ue()&&(n=hf(window.location.href),this._isImplicitGrantCallback(n)?s="implicit":await this._isPKCECallback(n)&&(s="pkce")),ue()&&this.detectSessionInUrl&&s!=="none"){const{data:i,error:o}=await this._getSessionFromURL(n,s);if(o){if(this._debug("#_initialize()","error detecting session from URL",o),of(o)){const c=(e=o.details)===null||e===void 0?void 0:e.code;if(c==="identity_already_exists"||c==="identity_not_found"||c==="single_identity_not_deletable")return{error:o}}return{error:o}}const{session:r,redirectType:a}=i;return this._debug("#_initialize()","detected session in URL",r,"redirect type",a),await this._saveSession(r),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",r):await this._notifyAllSubscribers("SIGNED_IN",r)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(n){return A(n)?this._returnResult({error:n}):this._returnResult({error:new Gt("Unexpected error during initialization",n)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var n,s,i;try{const o=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(n=e==null?void 0:e.options)===null||n===void 0?void 0:n.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.captchaToken}},xform:Ge}),{data:r,error:a}=o;if(a||!r)return this._returnResult({data:{user:null,session:null},error:a});const c=r.session,l=r.user;return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(o){if(A(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async signUp(e){var n,s,i;try{let o;if("email"in e){const{email:d,password:u,options:p}=e;let h=null,f=null;this.flowType==="pkce"&&([h,f]=await xn(this.storage,this.storageKey)),o=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:p==null?void 0:p.emailRedirectTo,body:{email:d,password:u,data:(n=p==null?void 0:p.data)!==null&&n!==void 0?n:{},gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken},code_challenge:h,code_challenge_method:f},xform:Ge})}else if("phone"in e){const{phone:d,password:u,options:p}=e;o=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:u,data:(s=p==null?void 0:p.data)!==null&&s!==void 0?s:{},channel:(i=p==null?void 0:p.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken}},xform:Ge})}else throw new di("You must provide either an email or phone number and a password");const{data:r,error:a}=o;if(a||!r)return await de(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:a});const c=r.session,l=r.user;return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(o){if(await de(this.storage,`${this.storageKey}-code-verifier`),A(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async signInWithPassword(e){try{let n;if("email"in e){const{email:o,password:r,options:a}=e;n=await j(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:o,password:r,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Za})}else if("phone"in e){const{phone:o,password:r,options:a}=e;n=await j(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:o,password:r,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Za})}else throw new di("You must provide either an email or phone number and a password");const{data:s,error:i}=n;if(i)return this._returnResult({data:{user:null,session:null},error:i});if(!s||!s.session||!s.user){const o=new wn;return this._returnResult({data:{user:null,session:null},error:o})}return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),this._returnResult({data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:i})}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithOAuth(e){var n,s,i,o;return await this._handleProviderSignIn(e.provider,{redirectTo:(n=e.options)===null||n===void 0?void 0:n.redirectTo,scopes:(s=e.options)===null||s===void 0?void 0:s.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(o=e.options)===null||o===void 0?void 0:o.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:n}=e;switch(n){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${n}"`)}}async signInWithEthereum(e){var n,s,i,o,r,a,c,l,d,u,p;let h,f;if("message"in e)h=e.message,f=e.signature;else{const{chain:g,wallet:m,statement:v,options:E}=e;let w;if(ue())if(typeof m=="object")w=m;else{const G=window;if("ethereum"in G&&typeof G.ethereum=="object"&&"request"in G.ethereum&&typeof G.ethereum.request=="function")w=G.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof m!="object"||!(E!=null&&E.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");w=m}const S=new URL((n=E==null?void 0:E.url)!==null&&n!==void 0?n:window.location.href),C=await w.request({method:"eth_requestAccounts"}).then(G=>G).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!C||C.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const B=ic(C[0]);let L=(s=E==null?void 0:E.signInWithEthereum)===null||s===void 0?void 0:s.chainId;if(!L){const G=await w.request({method:"eth_chainId"});L=jf(G)}const O={domain:S.host,address:B,statement:v,uri:S.href,version:"1",chainId:L,nonce:(i=E==null?void 0:E.signInWithEthereum)===null||i===void 0?void 0:i.nonce,issuedAt:(r=(o=E==null?void 0:E.signInWithEthereum)===null||o===void 0?void 0:o.issuedAt)!==null&&r!==void 0?r:new Date,expirationTime:(a=E==null?void 0:E.signInWithEthereum)===null||a===void 0?void 0:a.expirationTime,notBefore:(c=E==null?void 0:E.signInWithEthereum)===null||c===void 0?void 0:c.notBefore,requestId:(l=E==null?void 0:E.signInWithEthereum)===null||l===void 0?void 0:l.requestId,resources:(d=E==null?void 0:E.signInWithEthereum)===null||d===void 0?void 0:d.resources};h=zf(O),f=await w.request({method:"personal_sign",params:[Nf(h),B]})}try{const{data:g,error:m}=await j(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:h,signature:f},!((u=e.options)===null||u===void 0)&&u.captchaToken?{gotrue_meta_security:{captcha_token:(p=e.options)===null||p===void 0?void 0:p.captchaToken}}:null),xform:Ge});if(m)throw m;if(!g||!g.session||!g.user){const v=new wn;return this._returnResult({data:{user:null,session:null},error:v})}return g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),this._returnResult({data:Object.assign({},g),error:m})}catch(g){if(A(g))return this._returnResult({data:{user:null,session:null},error:g});throw g}}async signInWithSolana(e){var n,s,i,o,r,a,c,l,d,u,p,h;let f,g;if("message"in e)f=e.message,g=e.signature;else{const{chain:m,wallet:v,statement:E,options:w}=e;let S;if(ue())if(typeof v=="object")S=v;else{const B=window;if("solana"in B&&typeof B.solana=="object"&&("signIn"in B.solana&&typeof B.solana.signIn=="function"||"signMessage"in B.solana&&typeof B.solana.signMessage=="function"))S=B.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof v!="object"||!(w!=null&&w.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");S=v}const C=new URL((n=w==null?void 0:w.url)!==null&&n!==void 0?n:window.location.href);if("signIn"in S&&S.signIn){const B=await S.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},w==null?void 0:w.signInWithSolana),{version:"1",domain:C.host,uri:C.href}),E?{statement:E}:null));let L;if(Array.isArray(B)&&B[0]&&typeof B[0]=="object")L=B[0];else if(B&&typeof B=="object"&&"signedMessage"in B&&"signature"in B)L=B;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in L&&"signature"in L&&(typeof L.signedMessage=="string"||L.signedMessage instanceof Uint8Array)&&L.signature instanceof Uint8Array)f=typeof L.signedMessage=="string"?L.signedMessage:new TextDecoder().decode(L.signedMessage),g=L.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in S)||typeof S.signMessage!="function"||!("publicKey"in S)||typeof S!="object"||!S.publicKey||!("toBase58"in S.publicKey)||typeof S.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");f=[`${C.host} wants you to sign in with your Solana account:`,S.publicKey.toBase58(),...E?["",E,""]:[""],"Version: 1",`URI: ${C.href}`,`Issued At: ${(i=(s=w==null?void 0:w.signInWithSolana)===null||s===void 0?void 0:s.issuedAt)!==null&&i!==void 0?i:new Date().toISOString()}`,...!((o=w==null?void 0:w.signInWithSolana)===null||o===void 0)&&o.notBefore?[`Not Before: ${w.signInWithSolana.notBefore}`]:[],...!((r=w==null?void 0:w.signInWithSolana)===null||r===void 0)&&r.expirationTime?[`Expiration Time: ${w.signInWithSolana.expirationTime}`]:[],...!((a=w==null?void 0:w.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${w.signInWithSolana.chainId}`]:[],...!((c=w==null?void 0:w.signInWithSolana)===null||c===void 0)&&c.nonce?[`Nonce: ${w.signInWithSolana.nonce}`]:[],...!((l=w==null?void 0:w.signInWithSolana)===null||l===void 0)&&l.requestId?[`Request ID: ${w.signInWithSolana.requestId}`]:[],...!((u=(d=w==null?void 0:w.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||u===void 0)&&u.length?["Resources",...w.signInWithSolana.resources.map(L=>`- ${L}`)]:[]].join(`
`);const B=await S.signMessage(new TextEncoder().encode(f),"utf8");if(!B||!(B instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");g=B}}try{const{data:m,error:v}=await j(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:f,signature:Jt(g)},!((p=e.options)===null||p===void 0)&&p.captchaToken?{gotrue_meta_security:{captcha_token:(h=e.options)===null||h===void 0?void 0:h.captchaToken}}:null),xform:Ge});if(v)throw v;if(!m||!m.session||!m.user){const E=new wn;return this._returnResult({data:{user:null,session:null},error:E})}return m.session&&(await this._saveSession(m.session),await this._notifyAllSubscribers("SIGNED_IN",m.session)),this._returnResult({data:Object.assign({},m),error:v})}catch(m){if(A(m))return this._returnResult({data:{user:null,session:null},error:m});throw m}}async _exchangeCodeForSession(e){const n=await Ft(this.storage,`${this.storageKey}-code-verifier`),[s,i]=(n??"").split("/");try{if(!s&&this.flowType==="pkce")throw new rf;const{data:o,error:r}=await j(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:Ge});if(await de(this.storage,`${this.storageKey}-code-verifier`),r)throw r;if(!o||!o.session||!o.user){const a=new wn;return this._returnResult({data:{user:null,session:null,redirectType:null},error:a})}return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",o.session)),this._returnResult({data:Object.assign(Object.assign({},o),{redirectType:i??null}),error:r})}catch(o){if(await de(this.storage,`${this.storageKey}-code-verifier`),A(o))return this._returnResult({data:{user:null,session:null,redirectType:null},error:o});throw o}}async signInWithIdToken(e){try{const{options:n,provider:s,token:i,access_token:o,nonce:r}=e,a=await j(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:i,access_token:o,nonce:r,gotrue_meta_security:{captcha_token:n==null?void 0:n.captchaToken}},xform:Ge}),{data:c,error:l}=a;if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!c||!c.session||!c.user){const d=new wn;return this._returnResult({data:{user:null,session:null},error:d})}return c.session&&(await this._saveSession(c.session),await this._notifyAllSubscribers("SIGNED_IN",c.session)),this._returnResult({data:c,error:l})}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithOtp(e){var n,s,i,o,r;try{if("email"in e){const{email:a,options:c}=e;let l=null,d=null;this.flowType==="pkce"&&([l,d]=await xn(this.storage,this.storageKey));const{error:u}=await j(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(n=c==null?void 0:c.data)!==null&&n!==void 0?n:{},create_user:(s=c==null?void 0:c.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},code_challenge:l,code_challenge_method:d},redirectTo:c==null?void 0:c.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:u})}if("phone"in e){const{phone:a,options:c}=e,{data:l,error:d}=await j(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(i=c==null?void 0:c.data)!==null&&i!==void 0?i:{},create_user:(o=c==null?void 0:c.shouldCreateUser)!==null&&o!==void 0?o:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},channel:(r=c==null?void 0:c.channel)!==null&&r!==void 0?r:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:d})}throw new di("You must provide either an email or phone number.")}catch(a){if(await de(this.storage,`${this.storageKey}-code-verifier`),A(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async verifyOtp(e){var n,s;try{let i,o;"options"in e&&(i=(n=e.options)===null||n===void 0?void 0:n.redirectTo,o=(s=e.options)===null||s===void 0?void 0:s.captchaToken);const{data:r,error:a}=await j(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:o}}),redirectTo:i,xform:Ge});if(a)throw a;if(!r)throw new Error("An error occurred on token verification.");const c=r.session,l=r.user;return c!=null&&c.access_token&&(await this._saveSession(c),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(i){if(A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithSSO(e){var n,s,i,o,r;try{let a=null,c=null;this.flowType==="pkce"&&([a,c]=await xn(this.storage,this.storageKey));const l=await j(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(s=(n=e.options)===null||n===void 0?void 0:n.redirectTo)!==null&&s!==void 0?s:void 0}),!((i=e==null?void 0:e.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:c}),headers:this.headers,xform:Df});return!((o=l.data)===null||o===void 0)&&o.url&&ue()&&!(!((r=e.options)===null||r===void 0)&&r.skipBrowserRedirect)&&window.location.assign(l.data.url),this._returnResult(l)}catch(a){if(await de(this.storage,`${this.storageKey}-code-verifier`),A(a))return this._returnResult({data:null,error:a});throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:n},error:s}=e;if(s)throw s;if(!n)throw new Oe;const{error:i}=await j(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:n.access_token});return this._returnResult({data:{user:null,session:null},error:i})})}catch(e){if(A(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const n=`${this.url}/resend`;if("email"in e){const{email:s,type:i,options:o}=e,{error:r}=await j(this.fetch,"POST",n,{headers:this.headers,body:{email:s,type:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},redirectTo:o==null?void 0:o.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:r})}else if("phone"in e){const{phone:s,type:i,options:o}=e,{data:r,error:a}=await j(this.fetch,"POST",n,{headers:this.headers,body:{phone:s,type:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:r==null?void 0:r.message_id},error:a})}throw new di("You must provide either an email or phone number and a type")}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async n=>n))}async _acquireLock(e,n){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await s,await n()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=n();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const n=await this.__loadSession();return await e(n)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const n=await Ft(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",n),n!==null&&(this._isValidSession(n)?e=n:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=e.expires_at?e.expires_at*1e3-Date.now()<xo:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.userStorage){const r=await Ft(this.userStorage,this.storageKey+"-user");r!=null&&r.user?e.user=r.user:e.user=ko()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const r={value:this.suppressGetSessionWarning};e.user=If(e.user,r),r.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:i,error:o}=await this._callRefreshToken(e.refresh_token);return o?this._returnResult({data:{session:null},error:o}):this._returnResult({data:{session:i},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const n=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return n.data.user&&(this.suppressGetSessionWarning=!0),n}async _getUser(e){try{return e?await j(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:$t}):await this._useSession(async n=>{var s,i,o;const{data:r,error:a}=n;if(a)throw a;return!(!((s=r.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Oe}:await j(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(o=(i=r.session)===null||i===void 0?void 0:i.access_token)!==null&&o!==void 0?o:void 0,xform:$t})})}catch(n){if(A(n))return _o(n)&&(await this._removeSession(),await de(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:n});throw n}}async updateUser(e,n={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,n))}async _updateUser(e,n={}){try{return await this._useSession(async s=>{const{data:i,error:o}=s;if(o)throw o;if(!i.session)throw new Oe;const r=i.session;let a=null,c=null;this.flowType==="pkce"&&e.email!=null&&([a,c]=await xn(this.storage,this.storageKey));const{data:l,error:d}=await j(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:n==null?void 0:n.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:c}),jwt:r.access_token,xform:$t});if(d)throw d;return r.user=l.user,await this._saveSession(r),await this._notifyAllSubscribers("USER_UPDATED",r),this._returnResult({data:{user:r.user},error:null})})}catch(s){if(await de(this.storage,`${this.storageKey}-code-verifier`),A(s))return this._returnResult({data:{user:null},error:s});throw s}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new Oe;const n=Date.now()/1e3;let s=n,i=!0,o=null;const{payload:r}=pi(e.access_token);if(r.exp&&(s=r.exp,i=s<=n),i){const{data:a,error:c}=await this._callRefreshToken(e.refresh_token);if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!a)return{data:{user:null,session:null},error:null};o=a}else{const{data:a,error:c}=await this._getUser(e.access_token);if(c)return this._returnResult({data:{user:null,session:null},error:c});o={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:s-n,expires_at:s},await this._saveSession(o),await this._notifyAllSubscribers("SIGNED_IN",o)}return this._returnResult({data:{user:o.user,session:o},error:null})}catch(n){if(A(n))return this._returnResult({data:{session:null,user:null},error:n});throw n}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async n=>{var s;if(!e){const{data:r,error:a}=n;if(a)throw a;e=(s=r.session)!==null&&s!==void 0?s:void 0}if(!(e!=null&&e.refresh_token))throw new Oe;const{data:i,error:o}=await this._callRefreshToken(e.refresh_token);return o?this._returnResult({data:{user:null,session:null},error:o}):i?this._returnResult({data:{user:i.user,session:i},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(n){if(A(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async _getSessionFromURL(e,n){try{if(!ue())throw new ui("No browser detected.");if(e.error||e.error_description||e.error_code)throw new ui(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(n){case"implicit":if(this.flowType==="pkce")throw new Ga("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new ui("Not a valid implicit grant flow url.");break;default:}if(n==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Ga("No code detected.");const{data:E,error:w}=await this._exchangeCodeForSession(e.code);if(w)throw w;const S=new URL(window.location.href);return S.searchParams.delete("code"),window.history.replaceState(window.history.state,"",S.toString()),{data:{session:E.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:i,access_token:o,refresh_token:r,expires_in:a,expires_at:c,token_type:l}=e;if(!o||!a||!r||!l)throw new ui("No session defined in URL");const d=Math.round(Date.now()/1e3),u=parseInt(a);let p=d+u;c&&(p=parseInt(c));const h=p-d;h*1e3<=En&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${h}s, should have been closer to ${u}s`);const f=p-u;d-f>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",f,p,d):d-f<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",f,p,d);const{data:g,error:m}=await this._getUser(o);if(m)throw m;const v={provider_token:s,provider_refresh_token:i,access_token:o,expires_in:u,expires_at:p,refresh_token:r,token_type:l,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:v,redirectType:e.type},error:null})}catch(s){if(A(s))return this._returnResult({data:{session:null,redirectType:null},error:s});throw s}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const n=await Ft(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&n)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async n=>{var s;const{data:i,error:o}=n;if(o&&!_o(o))return this._returnResult({error:o});const r=(s=i.session)===null||s===void 0?void 0:s.access_token;if(r){const{error:a}=await this.admin.signOut(r,e);if(a&&!(sf(a)&&(a.status===404||a.status===401||a.status===403)||_o(a)))return this._returnResult({error:a})}return e!=="others"&&(await this._removeSession(),await de(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const n=ff(),s={id:n,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",n),this.stateChangeEmitters.delete(n)}};return this._debug("#onAuthStateChange()","registered callback with id",n),this.stateChangeEmitters.set(n,s),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(n)})))(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async n=>{var s,i;try{const{data:{session:o},error:r}=n;if(r)throw r;await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",o)),this._debug("INITIAL_SESSION","callback id",e,"session",o)}catch(o){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",o),console.error(o)}})}async resetPasswordForEmail(e,n={}){let s=null,i=null;this.flowType==="pkce"&&([s,i]=await xn(this.storage,this.storageKey,!0));try{return await j(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:i,gotrue_meta_security:{captcha_token:n.captchaToken}},headers:this.headers,redirectTo:n.redirectTo})}catch(o){if(await de(this.storage,`${this.storageKey}-code-verifier`),A(o))return this._returnResult({data:null,error:o});throw o}}async getUserIdentities(){var e;try{const{data:n,error:s}=await this.getUser();if(s)throw s;return this._returnResult({data:{identities:(e=n.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var n;try{const{data:s,error:i}=await this._useSession(async o=>{var r,a,c,l,d;const{data:u,error:p}=o;if(p)throw p;const h=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(r=e.options)===null||r===void 0?void 0:r.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(c=e.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:!0});return await j(this.fetch,"GET",h,{headers:this.headers,jwt:(d=(l=u.session)===null||l===void 0?void 0:l.access_token)!==null&&d!==void 0?d:void 0})});if(i)throw i;return ue()&&!(!((n=e.options)===null||n===void 0)&&n.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),this._returnResult({data:{provider:e.provider,url:s==null?void 0:s.url},error:null})}catch(s){if(A(s))return this._returnResult({data:{provider:e.provider,url:null},error:s});throw s}}async linkIdentityIdToken(e){return await this._useSession(async n=>{var s;try{const{error:i,data:{session:o}}=n;if(i)throw i;const{options:r,provider:a,token:c,access_token:l,nonce:d}=e,u=await j(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(s=o==null?void 0:o.access_token)!==null&&s!==void 0?s:void 0,body:{provider:a,id_token:c,access_token:l,nonce:d,link_identity:!0,gotrue_meta_security:{captcha_token:r==null?void 0:r.captchaToken}},xform:Ge}),{data:p,error:h}=u;return h?this._returnResult({data:{user:null,session:null},error:h}):!p||!p.session||!p.user?this._returnResult({data:{user:null,session:null},error:new wn}):(p.session&&(await this._saveSession(p.session),await this._notifyAllSubscribers("USER_UPDATED",p.session)),this._returnResult({data:p,error:h}))}catch(i){if(await de(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}})}async unlinkIdentity(e){try{return await this._useSession(async n=>{var s,i;const{data:o,error:r}=n;if(r)throw r;return await j(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(s=o.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _refreshAccessToken(e){const n=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(n,"begin");try{const s=Date.now();return await yf(async i=>(i>0&&await gf(200*Math.pow(2,i-1)),this._debug(n,"refreshing attempt",i),await j(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Ge})),(i,o)=>{const r=200*Math.pow(2,i);return o&&So(o)&&Date.now()+r-s<En})}catch(s){if(this._debug(n,"error",s),A(s))return this._returnResult({data:{session:null,user:null},error:s});throw s}finally{this._debug(n,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,n){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:n.redirectTo,scopes:n.scopes,queryParams:n.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",n,"url",s),ue()&&!n.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e,n;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const i=await Ft(this.storage,this.storageKey);if(i&&this.userStorage){let r=await Ft(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!r&&(r={user:i.user},await In(this.userStorage,this.storageKey+"-user",r)),i.user=(e=r==null?void 0:r.user)!==null&&e!==void 0?e:ko()}else if(i&&!i.user&&!i.user){const r=await Ft(this.storage,this.storageKey+"-user");r&&(r!=null&&r.user)?(i.user=r.user,await de(this.storage,this.storageKey+"-user"),await In(this.storage,this.storageKey,i)):i.user=ko()}if(this._debug(s,"session from storage",i),!this._isValidSession(i)){this._debug(s,"session is not valid"),i!==null&&await this._removeSession();return}const o=((n=i.expires_at)!==null&&n!==void 0?n:1/0)*1e3-Date.now()<xo;if(this._debug(s,`session has${o?"":" not"} expired with margin of ${xo}s`),o){if(this.autoRefreshToken&&i.refresh_token){const{error:r}=await this._callRefreshToken(i.refresh_token);r&&(console.error(r),So(r)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",r),await this._removeSession()))}}else if(i.user&&i.user.__isUserNotAvailableProxy===!0)try{const{data:r,error:a}=await this._getUser(i.access_token);!a&&(r!=null&&r.user)?(i.user=r.user,await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(r){console.error("Error getting user data:",r),this._debug(s,"error getting user data, skipping SIGNED_IN notification",r)}else await this._notifyAllSubscribers("SIGNED_IN",i)}catch(i){this._debug(s,"error",i),console.error(i);return}finally{this._debug(s,"end")}}async _callRefreshToken(e){var n,s;if(!e)throw new Oe;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new Wi;const{data:o,error:r}=await this._refreshAccessToken(e);if(r)throw r;if(!o.session)throw new Oe;await this._saveSession(o.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",o.session);const a={data:o.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(o){if(this._debug(i,"error",o),A(o)){const r={data:null,error:o};return So(o)||await this._removeSession(),(n=this.refreshingDeferred)===null||n===void 0||n.resolve(r),r}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(o),o}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,n,s=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",n,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:n});const o=[],r=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,n)}catch(c){o.push(c)}});if(await Promise.all(r),o.length>0){for(let a=0;a<o.length;a+=1)console.error(o[a]);throw o[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await de(this.storage,`${this.storageKey}-code-verifier`);const n=Object.assign({},e),s=n.user&&n.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!s&&n.user&&await In(this.userStorage,this.storageKey+"-user",{user:n.user});const i=Object.assign({},n);delete i.user;const o=Qa(i);await In(this.storage,this.storageKey,o)}else{const i=Qa(n);await In(this.storage,this.storageKey,i)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await de(this.storage,this.storageKey),await de(this.storage,this.storageKey+"-code-verifier"),await de(this.storage,this.storageKey+"-user"),this.userStorage&&await de(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&ue()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(n){console.error("removing visibilitychange callback failed",n)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),En);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const n=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=n,n&&typeof n=="object"&&typeof n.unref=="function"?n.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(n)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const n=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,n&&clearTimeout(n)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async n=>{const{data:{session:s}}=n;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((s.expires_at*1e3-e)/En);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${En}ms, refresh threshold is ${Ho} ticks`),i<=Ho&&await this._callRefreshToken(s.refresh_token)})}catch(n){console.error("Auto refresh tick failed with error. This is likely a transient error.",n)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof sc)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ue()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>{try{await this._onVisibilityChanged(!1)}catch(e){this._debug("#visibilityChangedCallback","error",e)}},window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const n=`#_onVisibilityChanged(${e})`;this._debug(n,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(n,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,n,s){const i=[`provider=${encodeURIComponent(n)}`];if(s!=null&&s.redirectTo&&i.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&i.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[o,r]=await xn(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(o)}`,code_challenge_method:`${encodeURIComponent(r)}`});i.push(a.toString())}if(s!=null&&s.queryParams){const o=new URLSearchParams(s.queryParams);i.push(o.toString())}return s!=null&&s.skipBrowserRedirect&&i.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async n=>{var s;const{data:i,error:o}=n;return o?this._returnResult({data:null,error:o}):await j(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _enroll(e){try{return await this._useSession(async n=>{var s,i;const{data:o,error:r}=n;if(r)return this._returnResult({data:null,error:r});const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:c,error:l}=await j(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(s=o==null?void 0:o.session)===null||s===void 0?void 0:s.access_token});return l?this._returnResult({data:null,error:l}):(e.factorType==="totp"&&c.type==="totp"&&(!((i=c==null?void 0:c.totp)===null||i===void 0)&&i.qr_code)&&(c.totp.qr_code=`data:image/svg+xml;utf-8,${c.totp.qr_code}`),this._returnResult({data:c,error:null}))})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async n=>{var s;const{data:i,error:o}=n;if(o)return this._returnResult({data:null,error:o});const r=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?Vf(e.webauthn.credential_response):Kf(e.webauthn.credential_response)})}:{code:e.code}),{data:a,error:c}=await j(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:r,headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token});return c?this._returnResult({data:null,error:c}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),this._returnResult({data:a,error:c}))})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async n=>{var s;const{data:i,error:o}=n;if(o)return this._returnResult({data:null,error:o});const r=await j(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token});if(r.error)return r;const{data:a}=r;if(a.type!=="webauthn")return{data:a,error:null};switch(a.webauthn.type){case"create":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:Wf(a.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:Gf(a.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}})}async _challengeAndVerify(e){const{data:n,error:s}=await this._challenge({factorId:e.factorId});return s?this._returnResult({data:null,error:s}):await this._verify({factorId:e.factorId,challengeId:n.id,code:e.code})}async _listFactors(){var e;const{data:{user:n},error:s}=await this.getUser();if(s)return{data:null,error:s};const i={all:[],phone:[],totp:[],webauthn:[]};for(const o of(e=n==null?void 0:n.factors)!==null&&e!==void 0?e:[])i.all.push(o),o.status==="verified"&&i[o.factor_type].push(o);return{data:i,error:null}}async _getAuthenticatorAssuranceLevel(e){var n,s,i,o;if(e)try{const{payload:h}=pi(e);let f=null;h.aal&&(f=h.aal);let g=f;const{data:{user:m},error:v}=await this.getUser(e);if(v)return this._returnResult({data:null,error:v});((s=(n=m==null?void 0:m.factors)===null||n===void 0?void 0:n.filter(S=>S.status==="verified"))!==null&&s!==void 0?s:[]).length>0&&(g="aal2");const w=h.amr||[];return{data:{currentLevel:f,nextLevel:g,currentAuthenticationMethods:w},error:null}}catch(h){if(A(h))return this._returnResult({data:null,error:h});throw h}const{data:{session:r},error:a}=await this.getSession();if(a)return this._returnResult({data:null,error:a});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:c}=pi(r.access_token);let l=null;c.aal&&(l=c.aal);let d=l;((o=(i=r.user.factors)===null||i===void 0?void 0:i.filter(h=>h.status==="verified"))!==null&&o!==void 0?o:[]).length>0&&(d="aal2");const p=c.amr||[];return{data:{currentLevel:l,nextLevel:d,currentAuthenticationMethods:p},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async n=>{const{data:{session:s},error:i}=n;return i?this._returnResult({data:null,error:i}):s?await j(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:s.access_token,xform:o=>({data:o,error:null})}):this._returnResult({data:null,error:new Oe})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _approveAuthorization(e,n){try{return await this._useSession(async s=>{const{data:{session:i},error:o}=s;if(o)return this._returnResult({data:null,error:o});if(!i)return this._returnResult({data:null,error:new Oe});const r=await j(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"approve"},xform:a=>({data:a,error:null})});return r.data&&r.data.redirect_url&&ue()&&!(n!=null&&n.skipBrowserRedirect)&&window.location.assign(r.data.redirect_url),r})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _denyAuthorization(e,n){try{return await this._useSession(async s=>{const{data:{session:i},error:o}=s;if(o)return this._returnResult({data:null,error:o});if(!i)return this._returnResult({data:null,error:new Oe});const r=await j(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"deny"},xform:a=>({data:a,error:null})});return r.data&&r.data.redirect_url&&ue()&&!(n!=null&&n.skipBrowserRedirect)&&window.location.assign(r.data.redirect_url),r})}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:n},error:s}=e;return s?this._returnResult({data:null,error:s}):n?await j(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:n.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new Oe})})}catch(e){if(A(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async n=>{const{data:{session:s},error:i}=n;return i?this._returnResult({data:null,error:i}):s?(await j(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:s.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new Oe})})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async fetchJwk(e,n={keys:[]}){let s=n.keys.find(a=>a.kid===e);if(s)return s;const i=Date.now();if(s=this.jwks.keys.find(a=>a.kid===e),s&&this.jwks_cached_at+tf>i)return s;const{data:o,error:r}=await j(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(r)throw r;return!o.keys||o.keys.length===0||(this.jwks=o,this.jwks_cached_at=i,s=o.keys.find(a=>a.kid===e),!s)?null:s}async getClaims(e,n={}){try{let s=e;if(!s){const{data:h,error:f}=await this.getSession();if(f||!h.session)return this._returnResult({data:null,error:f});s=h.session.access_token}const{header:i,payload:o,signature:r,raw:{header:a,payload:c}}=pi(s);n!=null&&n.allowExpired||kf(o.exp);const l=!i.alg||i.alg.startsWith("HS")||!i.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(i.kid,n!=null&&n.keys?{keys:n.keys}:n==null?void 0:n.jwks);if(!l){const{error:h}=await this.getUser(s);if(h)throw h;return{data:{claims:o,header:i,signature:r},error:null}}const d=$f(i.alg),u=await crypto.subtle.importKey("jwk",l,d,!0,["verify"]);if(!await crypto.subtle.verify(d,u,r,uf(`${a}.${c}`)))throw new Vo("Invalid JWT signature");return{data:{claims:o,header:i,signature:r},error:null}}catch(s){if(A(s))return this._returnResult({data:null,error:s});throw s}}}Ts.nextInstanceID={};const sh=Ts,ih="2.98.0";let rs="";typeof Deno<"u"?rs="deno":typeof document<"u"?rs="web":typeof navigator<"u"&&navigator.product==="ReactNative"?rs="react-native":rs="node";const oh={"X-Client-Info":`supabase-js-${rs}/${ih}`},rh={headers:oh},ah={schema:"public"},lh={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},ch={};function Cs(t){"@babel/helpers - typeof";return Cs=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Cs(t)}function dh(t,e){if(Cs(t)!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var s=n.call(t,e);if(Cs(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function uh(t){var e=dh(t,"string");return Cs(e)=="symbol"?e:e+""}function ph(t,e,n){return(e=uh(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function il(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,s)}return n}function se(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?il(Object(n),!0).forEach(function(s){ph(t,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):il(Object(n)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(n,s))})}return t}const fh=t=>t?(...e)=>t(...e):(...e)=>fetch(...e),hh=()=>Headers,mh=(t,e,n)=>{const s=fh(n),i=hh();return async(o,r)=>{var a;const c=(a=await e())!==null&&a!==void 0?a:t;let l=new i(r==null?void 0:r.headers);return l.has("apikey")||l.set("apikey",t),l.has("Authorization")||l.set("Authorization",`Bearer ${c}`),s(o,se(se({},r),{},{headers:l}))}};function gh(t){return t.endsWith("/")?t:t+"/"}function yh(t,e){var n,s;const{db:i,auth:o,realtime:r,global:a}=t,{db:c,auth:l,realtime:d,global:u}=e,p={db:se(se({},c),i),auth:se(se({},l),o),realtime:se(se({},d),r),storage:{},global:se(se(se({},u),a),{},{headers:se(se({},(n=u==null?void 0:u.headers)!==null&&n!==void 0?n:{}),(s=a==null?void 0:a.headers)!==null&&s!==void 0?s:{})}),accessToken:async()=>""};return t.accessToken?p.accessToken=t.accessToken:delete p.accessToken,p}function vh(t){const e=t==null?void 0:t.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(gh(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var bh=class extends sh{constructor(t){super(t)}},wh=class{constructor(t,e,n){var s,i;this.supabaseUrl=t,this.supabaseKey=e;const o=vh(t);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const r=`sb-${o.hostname.split(".")[0]}-auth-token`,a={db:ah,realtime:ch,auth:se(se({},lh),{},{storageKey:r}),global:rh},c=yh(n??{},a);if(this.storageKey=(s=c.auth.storageKey)!==null&&s!==void 0?s:"",this.headers=(i=c.global.headers)!==null&&i!==void 0?i:{},c.accessToken)this.accessToken=c.accessToken,this.auth=new Proxy({},{get:(d,u)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(u)} is not possible`)}});else{var l;this.auth=this._initSupabaseAuthClient((l=c.auth)!==null&&l!==void 0?l:{},this.headers,c.global.fetch)}this.fetch=mh(e,this._getAccessToken.bind(this),c.global.fetch),this.realtime=this._initRealtimeClient(se({headers:this.headers,accessToken:this._getAccessToken.bind(this)},c.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(d=>this.realtime.setAuth(d)).catch(d=>console.warn("Failed to set initial Realtime auth token:",d)),this.rest=new sp(new URL("rest/v1",o).href,{headers:this.headers,schema:c.db.schema,fetch:this.fetch,timeout:c.db.timeout,urlLengthLimit:c.db.urlLengthLimit}),this.storage=new Yp(this.storageUrl.href,this.headers,this.fetch,n==null?void 0:n.storage),c.accessToken||this._listenForAuthEvents()}get functions(){return new Ju(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(t){return this.rest.from(t)}schema(t){return this.rest.schema(t)}rpc(t,e={},n={head:!1,get:!1,count:void 0}){return this.rest.rpc(t,e,n)}channel(t,e={config:{}}){return this.realtime.channel(t,e)}getChannels(){return this.realtime.getChannels()}removeChannel(t){return this.realtime.removeChannel(t)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var t=this,e,n;if(t.accessToken)return await t.accessToken();const{data:s}=await t.auth.getSession();return(e=(n=s.session)===null||n===void 0?void 0:n.access_token)!==null&&e!==void 0?e:t.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:t,persistSession:e,detectSessionInUrl:n,storage:s,userStorage:i,storageKey:o,flowType:r,lock:a,debug:c,throwOnError:l},d,u){const p={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new bh({url:this.authUrl.href,headers:se(se({},p),d),storageKey:o,autoRefreshToken:t,persistSession:e,detectSessionInUrl:n,storage:s,userStorage:i,flowType:r,lock:a,debug:c,throwOnError:l,fetch:u,hasCustomAuthorizationHeader:Object.keys(this.headers).some(h=>h.toLowerCase()==="authorization")})}_initRealtimeClient(t){return new wp(this.realtimeUrl.href,se(se({},t),{},{params:se(se({},{apikey:this.supabaseKey}),t==null?void 0:t.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,e)=>{this._handleTokenChanged(t,"CLIENT",e==null?void 0:e.access_token)})}_handleTokenChanged(t,e,n){(t==="TOKEN_REFRESHED"||t==="SIGNED_IN")&&this.changedAccessToken!==n?(this.changedAccessToken=n,this.realtime.setAuth(n)):t==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const xh=(t,e,n)=>new wh(t,e,n);function _h(){if(typeof window<"u")return!1;const t=globalThis.process;if(!t)return!1;const e=t.version;if(e==null)return!1;const n=e.match(/^v(\d+)\./);return n?parseInt(n[1],10)<=18:!1}_h()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");let It=null,Xe=null,rc=null,Ko="login",Eo=!1;function Sh(){return Xe?Xe.id:null}function Ce(){return Xe}function mr(t){Ko=t;const e=t==="login",n=document.getElementById("authTabLogin"),s=document.getElementById("authTabSignup"),i=document.getElementById("authSubmitBtn"),o=document.getElementById("authForgotWrap");n&&(n.style.borderBottomColor=e?"var(--accent)":"transparent"),s&&(s.style.borderBottomColor=e?"transparent":"var(--accent)"),n&&(n.style.color=e?"var(--text)":"var(--muted)"),s&&(s.style.color=e?"var(--muted)":"var(--text)"),i&&(i.textContent=e?"Sign In":"Create Account"),o&&(o.style.display=e?"":"none"),nt("","")}function nt(t,e){const n=document.getElementById("authErr"),s=document.getElementById("authOk");n&&(n.style.display="none"),s&&(s.style.display="none"),t&&(e==="ok"?s&&(s.textContent=t,s.style.display=""):n&&(n.textContent=t,n.style.display=""))}async function ac(){const t=document.getElementById("authEmail"),e=document.getElementById("authPass"),n=document.getElementById("authSubmitBtn"),s=t?t.value.trim():"",i=e?e.value:"";if(!s||!i){nt("Please enter your email and password.","err");return}n&&(n.textContent="",n.disabled=!0),nt("","");try{if(Ko==="login"){const{error:o}=await It.auth.signInWithPassword({email:s,password:i});if(o)throw o}else{const{error:o}=await It.auth.signUp({email:s,password:i});if(o)throw o;nt("Account created! Check your email to confirm, then sign in.","ok"),mr("login"),n&&(n.textContent="Sign In",n.disabled=!1);return}}catch(o){nt(o.message,"err"),n&&(n.textContent=Ko==="login"?"Sign In":"Create Account",n.disabled=!1)}}async function lc(){const t=document.getElementById("authEmail"),e=t?t.value.trim():"";if(!e){nt("Enter your email address first.","err");return}const{error:n}=await It.auth.resetPasswordForEmail(e,{redirectTo:location.origin});n?nt(n.message,"err"):nt("Password reset email sent  check your inbox.","ok")}async function cc(){Gi(),clearTimeout(rc),Xe=null,await It.auth.signOut(),$.length=0,I.length=0,Q.length=0,localStorage.removeItem("ft3_inv"),localStorage.removeItem("ft3_sal"),localStorage.removeItem("ft3_exp"),W(),ke("disconnected"),Pi()}function Pi(){const t=document.getElementById("authOv");if(t){t.style.display="flex";const e=document.getElementById("authEmail"),n=document.getElementById("authPass");e&&(e.value=""),n&&(n.value=""),nt("","")}}function dc(){const t=document.getElementById("authOv");t&&(t.style.display="none")}function uc(){const t=document.getElementById("accountMenuEmail");t&&Xe&&(t.textContent=Xe.email);const e=document.getElementById("accountMenuOv");e&&(e.style.display="flex")}function Gi(){const t=document.getElementById("accountMenuOv");t&&(t.style.display="none")}async function ol(t){if(Eo)return;Eo=!0,Xe=t,dc();const e=document.getElementById("syncDotLbl");e&&(e.textContent=t.email.split("@")[0]),ke("syncing");try{await Promise.race([yr(),new Promise((n,s)=>setTimeout(()=>s(new Error("Sync timed out")),1e4))]),Oh().catch(n=>console.warn("FlipTrack: supplies pull error:",n.message))}catch(n){ke("error",n.message)}finally{Eo=!1}}async function pc(){It=xh(Ui,Ru),It.auth.onAuthStateChange((e,n)=>{e==="SIGNED_OUT"?(Xe=null,clearTimeout(rc),ke("disconnected"),Pi()):e==="SIGNED_IN"&&(n!=null&&n.user)?(!Xe||Xe.id!==n.user.id)&&ol(n.user):n!=null&&n.user&&(Xe=n.user)});const{data:{session:t}}=await It.auth.getSession();t!=null&&t.user?await ol(t.user):Pi()}function kh(){const t=document.getElementById("accountMenuOv");t&&t.addEventListener("click",function(e){e.target===this&&Gi()})}function Pe(){return It}const $h=Object.freeze(Object.defineProperty({__proto__:null,authForgotPassword:lc,authSignOut:cc,authSubmit:ac,closeAccountMenu:Gi,getAccountId:Sh,getCurrentUser:Ce,getSupabaseClient:Pe,hideAuthModal:dc,initAuth:pc,openAccountMenu:uc,setAuthMsg:nt,setupAuthEventListeners:kh,showAuthModal:Pi,switchAuthTab:mr},Symbol.toStringTag,{value:"Module"})),Di="item-images";async function fc(t,e,n){const s=Pe(),i=Ce();if(!s||!i)throw new Error("Not authenticated");const r=await(await fetch(t)).blob(),a=i.id,c=`${e}_${n}_${Date.now()}.jpg`,l=`${a}/${c}`,{error:d}=await s.storage.from(Di).upload(l,r,{contentType:"image/jpeg",upsert:!0});if(d)throw new Error(d.message);const{data:{publicUrl:u}}=s.storage.from(Di).getPublicUrl(l);return u}async function Eh(t){const e=Pe(),n=Ce();if(!(!e||!n||!t||!t.includes("/storage/")))try{const s=`/object/public/${Di}/`,i=t.indexOf(s);if(i===-1)return;const o=decodeURIComponent(t.slice(i+s.length));await e.storage.from(Di).remove([o])}catch(s){console.warn("FlipTrack: storage delete failed:",s.message)}}const Ps=t=>typeof t=="string"&&t.startsWith("http"),rl="fliptrack",Ze="syncQueue";let ns=null;function gr(){return ns?Promise.resolve(ns):new Promise((t,e)=>{const n=indexedDB.open(rl);n.onsuccess=()=>{const s=n.result;if(s.objectStoreNames.contains(Ze))ns=s,t(s);else{const i=s.version+1;s.close();const o=indexedDB.open(rl,i);o.onupgradeneeded=r=>{const a=r.target.result;a.objectStoreNames.contains(Ze)||a.createObjectStore(Ze,{keyPath:"id",autoIncrement:!0})},o.onsuccess=()=>{ns=o.result,t(ns)},o.onerror=()=>e(o.error)}},n.onerror=()=>e(n.error)})}async function as(t,e,n){try{if(await hc()>=1e3){console.warn("FlipTrack: offline queue is full (1000 items), skipping enqueue");return}const o=(await gr()).transaction(Ze,"readwrite");o.objectStore(Ze).add({action:t,table:e,payload:n,ts:Date.now(),retries:0}),await new Promise((r,a)=>{o.oncomplete=r,o.onerror=a})}catch(s){console.warn("FlipTrack: offline queue enqueue failed:",s.message)}}async function Ih(){try{const t=await gr(),n=t.transaction(Ze,"readonly").objectStore(Ze),s=await new Promise((i,o)=>{const r=n.getAll();r.onsuccess=()=>i(r.result),r.onerror=o});if(s.length){const i=t.transaction(Ze,"readwrite");i.objectStore(Ze).clear(),await new Promise((o,r)=>{i.oncomplete=o,i.onerror=r})}return s.sort((i,o)=>i.ts-o.ts)}catch(t){return console.warn("FlipTrack: offline queue dequeue failed:",t.message),[]}}async function hc(){try{const e=(await gr()).transaction(Ze,"readonly");return new Promise((n,s)=>{const i=e.objectStore(Ze).count();i.onsuccess=()=>n(i.result),i.onerror=s})}catch{return 0}}async function Th(t,e){const n=await Ih();if(!n.length)return{ok:0,failed:0,dropped:0};let s=0,i=0,o=0;for(const r of n)try{if(r.action==="upsert"){const c=(Array.isArray(r.payload)?r.payload:[r.payload]).map(d=>({...d,account_id:e,updated_at:new Date(r.ts).toISOString()})),{error:l}=await t.from(r.table).upsert(c,{onConflict:"id"});if(l)throw new Error(l.message);s++}else if(r.action==="delete"){const a=Array.isArray(r.payload)?r.payload:[r.payload];await t.from(r.table).delete().in("id",a),s++}}catch(a){console.warn(`FlipTrack: replay failed for ${r.table}:`,a.message);const c=(r.retries||0)+1;c>=5?(console.warn(`FlipTrack: Dropping queue entry after ${c} retries: ${r.action} on ${r.table}`),o++):(await as(r.action,r.table,r.payload),i++)}return console.log(`FlipTrack: Replayed offline queue  ${s} ok, ${i} failed, ${o} dropped`),{ok:s,failed:i,dropped:o}}let Io=!1;function Ch(t,e){const n=async()=>{if(Io||!await hc())return;const i=t();if(!(!i||!i.sb||!i.accountId)){Io=!0;try{const o=await Th(i.sb,i.accountId);e&&e(o)}finally{Io=!1}}};window.addEventListener("online",()=>{setTimeout(n,2e3)}),document.addEventListener("visibilitychange",()=>{!document.hidden&&navigator.onLine&&setTimeout(n,1e3)})}const mc="ft_last_sync";function gc(){localStorage.setItem(mc,new Date().toISOString()),Jo()}function Jo(){const t=document.getElementById("syncTimestamp");if(!t)return;const e=localStorage.getItem(mc);if(!e){t.textContent="";return}const n=Date.now()-new Date(e).getTime(),s=Math.floor(n/6e4);let i;if(s<1)i="just now";else if(s<60)i=s+"m ago";else{const o=Math.floor(s/60);o<24?i=o+"h ago":i=Math.floor(o/24)+"d ago"}t.textContent="Synced "+i}function Ph(){Jo(),setInterval(Jo,3e4)}function ke(t,e){const n=document.getElementById("syncDot"),s=document.getElementById("syncDotLbl");if(!n||!s)return;n.className="sync-dot";const i=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o={disconnected:{cls:"",txt:"Offline"},connected:{cls:"connected",txt:`Synced ${i}`},syncing:{cls:"syncing",txt:"Syncing"},error:{cls:"error",txt:e||"Sync error"}},r=o[t]||o.disconnected;r.cls&&n.classList.add(r.cls),s.textContent=r.txt}async function Dh(){const t=Pe(),e=Ce();if(!t||!e)return;if(await _r(),!navigator.onLine){await al(),gi();return}const n=e.id,s=bc();try{if(s.inv.length){const i=s.inv.map(r=>{const a={...r};return a.images&&(a.images=a.images.map(c=>Ps(c)?c:null).filter(Boolean)),a.image&&!Ps(a.image)&&delete a.image,a.images&&a.images.length&&(a.image=a.images[0]),{id:r.id,account_id:n,data:a,updated_at:new Date().toISOString()}}),{error:o}=await t.from("ft_inventory").upsert(i,{onConflict:"id"});if(o)throw new Error(o.message)}if(s.sales.length){const i=s.sales.map(r=>({id:r.id,account_id:n,data:r,updated_at:new Date().toISOString()})),{error:o}=await t.from("ft_sales").upsert(i,{onConflict:"id"});if(o)throw new Error(o.message)}if(s.expenses.length){const i=s.expenses.map(o=>({id:o.id,account_id:n,data:o,updated_at:new Date().toISOString()}));try{const{error:o}=await t.from("ft_expenses").upsert(i,{onConflict:"id"});o&&console.warn("FlipTrack: expenses push error:",o.message)}catch(o){console.warn("FlipTrack: ft_expenses not available:",o.message)}}for(const[i,o]of Object.entries(s.deleted))if(o.length)try{await t.from(i).delete().in("id",o)}catch(r){console.warn(`FlipTrack: delete from ${i} failed:`,r.message)}await te("lastSyncPush",new Date().toISOString()).catch(()=>{}),gi()}catch(i){throw console.warn("FlipTrack: push failed, queueing for retry:",i.message),await al(),gi(),i}}async function al(){const t=bc();if(t.inv.length){const e=t.inv.map(n=>({id:n.id,data:{...n}}));await as("upsert","ft_inventory",e)}if(t.sales.length){const e=t.sales.map(n=>({id:n.id,data:n}));await as("upsert","ft_sales",e)}if(t.expenses.length){const e=t.expenses.map(n=>({id:n.id,data:n}));await as("upsert","ft_expenses",e)}for(const[e,n]of Object.entries(t.deleted))n.length&&await as("delete",e,n)}async function Bh(){const t=Pe(),e=Ce();if(!t||!e)return;const n=e.id,s=$.map(a=>{const c={...a};return c.images&&(c.images=c.images.map(l=>Ps(l)?l:null).filter(Boolean)),c.image&&!Ps(c.image)&&delete c.image,c.images&&c.images.length&&(c.image=c.images[0]),{id:a.id,account_id:n,data:c,updated_at:new Date().toISOString()}}),i=I.map(a=>({id:a.id,account_id:n,data:a,updated_at:new Date().toISOString()})),[o,r]=await Promise.all([s.length?t.from("ft_inventory").upsert(s,{onConflict:"id"}):Promise.resolve({}),i.length?t.from("ft_sales").upsert(i,{onConflict:"id"}):Promise.resolve({})]);if(o.error||r.error)throw new Error((o.error||r.error).message);try{const a=Q.map(c=>({id:c.id,account_id:n,data:c,updated_at:new Date().toISOString()}));a.length&&await t.from("ft_expenses").upsert(a,{onConflict:"id"})}catch(a){console.warn("FlipTrack: ft_expenses not available:",a.message)}gi()}async function Fs(t,e){const n=Pe(),s=Ce();if(!(!n||!s||!e.length))try{await n.from(t).delete().in("id",e)}catch(i){console.warn(`FlipTrack: delete from ${t} failed:`,i.message)}}async function yc(){const t=Pe(),e=Ce();if(!t||!e)return!1;const n=e.id,s=await we("lastSyncPull").catch(()=>null);let i=t.from("ft_inventory").select("id, data, updated_at").eq("account_id",n),o=t.from("ft_sales").select("id, data, updated_at").eq("account_id",n);s&&(i=i.gt("updated_at",s),o=o.gt("updated_at",s));const[{data:r,error:a},{data:c,error:l}]=await Promise.all([i,o]);if(a||l)throw new Error((a||l).message);let d=null;try{let u=t.from("ft_expenses").select("id, data, updated_at").eq("account_id",n);s&&(u=u.gt("updated_at",s));const{data:p,error:h}=await u;h||(d=p)}catch{}if(s){if(r&&r.length)for(const u of r){if(!u.data)continue;const p=$.findIndex(h=>h.id===u.id);p!==-1?$[p]=u.data:$.push(u.data)}if(c&&c.length)for(const u of c){if(!u.data)continue;const p=I.findIndex(h=>h.id===u.id);p!==-1?I[p]=u.data:I.push(u.data)}if(d&&d.length)for(const u of d){if(!u.data)continue;const p=Q.findIndex(h=>h.id===u.id);p!==-1?Q[p]=u.data:Q.push(u.data)}}else r&&($.length=0,$.push(...r.map(u=>u.data).filter(Boolean))),c&&(I.length=0,I.push(...c.map(u=>u.data).filter(Boolean))),d&&(Q.length=0,Q.push(...d.map(u=>u.data).filter(Boolean)));return await te("lastSyncPull",new Date().toISOString()).catch(()=>{}),R(),!0}async function Oh(){const t=Pe(),e=Ce();if(!(!t||!e))try{const n=e.id,{data:s}=await t.from("ft_supplies").select("data").eq("account_id",n);s&&s.length&&(ee.length=0,ee.push(...s.map(i=>i.data).filter(Boolean))),Gh()}catch(n){console.warn("FlipTrack: supplies pull error:",n.message)}}async function yr(){const t=Pe(),e=Ce();if(!(!t||!e)){await _r(),ke("syncing");try{await yc(),await Bh(),ke("connected"),gc(),W()}catch(n){ke("error",n.message)}}}let ll=null;function Hn(){const t=Pe(),e=Ce();!t||!e||navigator.onLine&&(clearTimeout(ll),ll=setTimeout(async()=>{await _r(),ke("syncing");try{await Dh(),ke("connected"),gc()}catch(n){ke("error",n.message)}},2e3))}async function Ah(){const t=Pe(),e=Ce();if(!(!t||!e)){ke("syncing");try{await yc(),W(),ke("connected")}catch(n){ke("error",n.message)}}}function Lh(){Ch(()=>{const t=Pe(),e=Ce();return!t||!e?null:{sb:t,accountId:e.id}},t=>{t.ok>0&&(ke("connected"),k(`Synced ${t.ok} offline change${t.ok>1?"s":""} `)),t.failed>0&&ke("error",`${t.failed} sync retries pending`),t.dropped>0&&console.warn(`FlipTrack: ${t.dropped} queue item(s) permanently dropped after max retries`)})}let $=[],I=[],Q=[],ee=[],vr=new Set,br=new Set,wr=new Set,vc=new Set,Tt={ft_inventory:new Set,ft_sales:new Set,ft_expenses:new Set};function bc(){return{inv:[...vr].map(e=>$.find(n=>n.id===e)).filter(Boolean),sales:[...br].map(e=>I.find(n=>n.id===e)).filter(Boolean),expenses:[...wr].map(e=>Q.find(n=>n.id===e)).filter(Boolean),deleted:{ft_inventory:[...Tt.ft_inventory],ft_sales:[...Tt.ft_sales],ft_expenses:[...Tt.ft_expenses]}}}function gi(){vr.clear(),br.clear(),wr.clear(),vc.clear(),Tt.ft_inventory.clear(),Tt.ft_sales.clear(),Tt.ft_expenses.clear()}function J(t,e){t==="inv"?vr.add(e):t==="sales"?br.add(e):t==="expenses"?wr.add(e):t==="supplies"&&vc.add(e)}function xr(t,e){Tt[t]&&Tt[t].add(e)}let wc={};function Wn(){wc=Object.fromEntries($.map(t=>[t.id,t]))}function q(t){return wc[t]||null}let yt=null;function xc(t){yt=t}let Re=new Set,_e=new Set,Rh="all",Mh="all",fe=new Set,yi=[],rn=!1;async function jh(){try{await Hu(),rn=!0,await we("migrated_from_ls")||(await Nh(),await te("migrated_from_ls",!0));const[e,n,s,i,o]=await Promise.all([es("inventory"),es("sales"),es("expenses"),es("supplies"),es("trash")]);$.length=0,$.push(...e),I.length=0,I.push(...n),Q.length=0,Q.push(...s),ee.length=0,ee.push(...i),ve.length=0,ve.push(...o),console.log(`FlipTrack: Loaded from IndexedDB  ${$.length} items, ${I.length} sales`)}catch(t){console.warn("FlipTrack: IndexedDB unavailable, using localStorage fallback:",t.message),rn=!1,zh()}Wn()}async function Nh(){const t=JSON.parse(localStorage.getItem("ft3_inv")||"[]"),e=JSON.parse(localStorage.getItem("ft3_sal")||"[]"),n=JSON.parse(localStorage.getItem("ft3_exp")||"[]"),s=JSON.parse(localStorage.getItem("ft_supplies")||"[]"),i=JSON.parse(localStorage.getItem("ft_trash")||"[]");(t.length||e.length||n.length||s.length)&&(await Promise.all([t.length?Ye("inventory",t):Promise.resolve(),e.length?Ye("sales",e):Promise.resolve(),n.length?Ye("expenses",n):Promise.resolve(),s.length?Ye("supplies",s):Promise.resolve(),i.length?Ye("trash",i):Promise.resolve()]),console.log(`FlipTrack: Migrated ${t.length} items from localStorage to IndexedDB`))}function zh(){$.length=0,$.push(...JSON.parse(localStorage.getItem("ft3_inv")||"[]")),I.length=0,I.push(...JSON.parse(localStorage.getItem("ft3_sal")||"[]")),Q.length=0,Q.push(...JSON.parse(localStorage.getItem("ft3_exp")||"[]")),ee.length=0,ee.push(...JSON.parse(localStorage.getItem("ft_supplies")||"[]")),ve.length=0,ve.push(...JSON.parse(localStorage.getItem("ft_trash")||"[]"))}let Ht=!0,cl=null,Yo=Promise.resolve();const R=()=>{Wn(),Uh(),qh(),Ht&&Hn()};function Uh(){clearTimeout(cl),cl=setTimeout(()=>{Yo=Yo.then(()=>Fh()).catch(()=>{})},200)}async function Fh(){if(rn)try{await Promise.all([Ye("inventory",$),Ye("sales",I),Ye("expenses",Q),Ye("supplies",ee)])}catch(t){console.warn("FlipTrack: IDB persist failed:",t.message)}}function _r(){return Yo}function qh(){try{localStorage.setItem("ft3_inv",JSON.stringify($)),localStorage.setItem("ft3_sal",JSON.stringify(I)),localStorage.setItem("ft3_exp",JSON.stringify(Q)),Ht=!0}catch(t){if(t.name==="QuotaExceededError"||t.name==="NS_ERROR_DOM_QUOTA_REACHED"||t.code===22)try{const e=$.map(n=>{const s={...n};return delete s.image,delete s.images,s});localStorage.setItem("ft3_inv",JSON.stringify(e)),localStorage.setItem("ft3_sal",JSON.stringify(I)),localStorage.setItem("ft3_exp",JSON.stringify(Q)),Ht=!0}catch(e){console.warn("FlipTrack: localStorage full:",e.message),Ht=!1,rn&&(Ht=!0)}else console.warn("FlipTrack: save error:",t.message),Ht=!1,rn&&(Ht=!0)}}function W(){Wn()}function Hh(t){if(!t)return t;const e=t.trim(),n=e.toLowerCase(),s=$.find(i=>(i.category||"").toLowerCase()===n);return s?s.category:e}let ve=[];function _c(){const t=Date.now()-6048e5;ve=ve.filter(e=>e.deletedAt>t).slice(-30),rn&&Ye("trash",ve).catch(()=>{});try{localStorage.setItem("ft_trash",JSON.stringify(ve))}catch{}}function Sc(t){const e=$.find(n=>n.id===t);e&&(Vi("delete",{...e}),ve.push({...JSON.parse(JSON.stringify(e)),deletedAt:Date.now()}),_c(),$.splice($.indexOf(e),1),xr("ft_inventory",t))}function Vi(t,e){yi.push({action:t,data:e,ts:Date.now()}),yi.length>20&&yi.shift()}function Wh(t){const e=document.getElementById("toast");if(!e)return;e.textContent="";const n=document.createElement("span");n.textContent=t+" ";const s=document.createElement("button");s.textContent="Undo",s.style.cssText="background:rgba(0,0,0,0.3);border:1px solid rgba(0,0,0,0.4);color:#fff;padding:3px 10px;margin-left:8px;cursor:pointer;font-family:Syne,sans-serif;font-weight:700;font-size:11px",s.onclick=()=>{kc(),e.classList.remove("on")},e.appendChild(n),e.appendChild(s),e.classList.remove("err"),e.classList.add("on"),setTimeout(()=>e.classList.remove("on"),8e3)}function kc(){const t=yi.pop();if(t){if(t.action==="delete")$.push(t.data),J("inv",t.data.id),R(),W();else if(t.action==="sold"){const e=$.find(s=>s.id===t.data.itemId);e&&(e.qty=(e.qty||0)+(t.data.qty||1),J("inv",e.id));const n=I.findIndex(s=>s.id===t.data.saleId);n!==-1&&(xr("ft_sales",t.data.saleId),I.splice(n,1)),R(),W()}}}function Gh(){rn&&Ye("supplies",ee).catch(()=>{}),localStorage.setItem("ft_supplies",JSON.stringify(ee))}function At(t){const e=t.cost||0,n=t.price||0,s=t.fees||0,i=t.ship||0,o=n-e-s-i,r=n?o/n:0,a=e?o/e:0;return{cost:e,price:n,fees:s,ship:i,pu:o,m:r,roi:a}}function Sr(t,e,n){return n?t===0?"low":t<=(e||2)?"warn":"ok":t===0?"low":"ok"}function Yt(t){return t>=.35?"mb-high":t>=.15?"mb-mid":"mb-low"}function $c(t){const e=At(t).m;return Yt(e)}let Vh=()=>{};function Y(t){return Array.isArray(t.platforms)&&t.platforms.length?t.platforms:t.platform?[t.platform]:[]}function Ds(t,e=[]){const n=document.getElementById(t);if(!n)return;const s=new Set(Array.isArray(e)?e:[e].filter(Boolean));let i="";jl.forEach(o=>{i+=`<div class="plat-picker-group-label">${o.label}</div>
    <div class="plat-picker-chips">`,o.items.forEach(r=>{const a=s.has(r)?"active":"";i+=`<span class="plat-pick-chip ${a}" data-plat="${r}" onclick="togglePlatChip(this,'${t}')">${r}</span>`}),i+="</div>"}),n.innerHTML=i}function Ec(t){const e=document.getElementById(t);return e?[...e.querySelectorAll(".plat-pick-chip.active")].map(n=>n.dataset.plat):[]}function Ic(){Ds("d_plat_picker",[]),Ds("f_plat_picker",[])}Ic();function kr(t){const e=Y(t);if(!e.length)return'<span class="platform-tag plt-other"></span>';const n=t.platformStatus||{},s=e.slice(0,2),i=e.length-s.length;let o=s.map(r=>{const a=n[r]||"active",c=a==="sold"?'<span style="color:var(--good);font-size:8px;margin-left:2px" title="Sold"></span>':a==="delisted"?'<span style="color:var(--muted);font-size:8px;margin-left:2px;text-decoration:line-through" title="Delisted"></span>':"";return`<span class="platform-tag ${Nl(r)}">${_(r)}${c}</span>`}).join(" ");return i>0&&(o+=` <span class="cross-listed-badge" title="${_(e.slice(2).join(", "))}">+${i}</span>`),o}function pe(t,e={}){const{min:n=0,max:s=1/0,allowZero:i=!0,integer:o=!1}=e;if(t===""||t===null||t===void 0)return NaN;const r=o?parseInt(t,10):parseFloat(t);return isNaN(r)?NaN:!i&&r===0?NaN:r<n||r>s?NaN:Math.round(r*100)/100}function Me(t,e={}){const n=pe(t.value,e);if(isNaN(n)){t.classList.add("input-error"),t.setAttribute("aria-invalid","true");let i=t.parentElement.querySelector(".validation-hint");i||(i=document.createElement("span"),i.className="validation-hint",i.setAttribute("role","alert"),t.parentElement.appendChild(i));const o=e.fieldName||"Value";return t.value.trim()===""?i.textContent=`${o} is required`:e.integer?i.textContent=`${o} must be a whole number`:i.textContent=`${o} must be a valid number`,null}t.classList.remove("input-error"),t.removeAttribute("aria-invalid");const s=t.parentElement.querySelector(".validation-hint");return s&&s.remove(),n}const Kh=["Like New","Very Good","Good","Acceptable","Poor"],Jh=["NWT","NWOT","EUC","GUC","Fair","Poor","New/Sealed","Refurbished"];function qs(t){if(!t)return!1;const e=t.toLowerCase().trim();return e==="books"||e==="book"||e==="textbooks"||e==="textbook"||e.startsWith("book")||e.endsWith("books")}function Hs(t){const e=document.getElementById(t==="f"?"f_cat":"d_cat"),n=e?e.value.trim():"",s=qs(n),i=document.getElementById(t+"_book_fields");i&&i.classList.toggle("on",s),Tc(t,s)}function Tc(t,e){var o;const n=document.getElementById(t+"_cond_picker");if(!n)return;const s=((o=document.getElementById(t+"_condition"))==null?void 0:o.value)||"",i=e?Kh:Jh;n.innerHTML=i.map(r=>`<button type="button" class="cond-tag" onclick="setCondTag('${t}','${r}',this)">${r}</button>`).join(""),s&&nm(t,s)}function Cc(t){var o;const e=document.getElementById(t+"_rank_display"),n=parseInt((o=document.getElementById(t+"_sales_rank"))==null?void 0:o.value)||0;if(!e)return;if(!n){e.innerHTML="";return}let s,i;n<1e5?(s="var(--good)",i="Fast seller  high demand"):n<5e5?(s="var(--accent)",i="Moderate  sells within weeks"):n<1e6?(s="var(--warn)",i="Slow  may take months"):(s="var(--danger)",i="Very slow  consider skipping"),e.innerHTML=`<span class="rank-dot" style="background:${s}"></span><span class="rank-label">#${n.toLocaleString()}  ${i}</span>`}async function Yh(t){var s,i,o,r;const e=((s=document.getElementById(t+"_isbn"))==null?void 0:s.value.replace(/[-\s]/g,""))||"";if(!e||e.length!==10&&e.length!==13){toast("Enter a valid ISBN-10 or ISBN-13",!0);return}const n=document.getElementById(t+"_isbn_btn");n&&(n.disabled=!0,n.textContent=" Looking up");try{const c=await(await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${e}&format=json&jscmd=data`)).json(),l=`ISBN:${e}`;if(!c[l]){toast("ISBN not found  try entering details manually",!0);return}const d=c[l],u=document.getElementById(t==="f"?"f_name":"d_name");u&&d.title&&!u.value&&(u.value=d.title);const p=document.getElementById(t+"_author");p&&((i=d.authors)!=null&&i.length)&&(p.value=d.authors.map(m=>m.name).join(", "));const h=document.getElementById(t+"_publisher");h&&((o=d.publishers)!=null&&o.length)&&(h.value=d.publishers[0].name);const f=document.getElementById(t+"_pub_year");if(f&&d.publish_date){const m=d.publish_date.match(/\d{4}/);m&&(f.value=m[0])}const g=document.getElementById(t==="f"?"f_cat":"d_cat");if(g&&!qs(g.value)&&(g.value="Books",t==="f"?em():tm()),(r=d.subjects)!=null&&r.length){const m=document.getElementById(t+"_subcat_txt");m&&!m.value&&(m.value=d.subjects[0].name)}toast("ISBN found: "+(d.title||e)+" ")}catch(a){toast("ISBN lookup failed: "+a.message,!0)}finally{n&&(n.disabled=!1,n.textContent=" Lookup")}}function Qh(t){var v,E,w;const e=parseFloat((v=document.getElementById(t==="f"?"f_price":"d_price"))==null?void 0:v.value)||0,n=parseFloat((E=document.getElementById(t==="f"?"f_cost":"d_cost"))==null?void 0:E.value)||0,s=parseFloat((w=document.getElementById(t==="f"?"f_ship":"d_ship"))==null?void 0:w.value)||4.5,i=document.getElementById(t+"_fba_panel");if(!i)return;if(!e){toast("Set a list price first",!0);return}const o=e*.15,r=1.8,a=3.07,c=.1,l=o+r+a+c,d=e-n-l,u=e>=10?3.99:3.49,p=o+r,h=s,f=e-n-p-h+u,g=d>f,m=S=>`<span style="color:${S>=0?"var(--good)":"var(--danger)"}">${fmt(S)}</span>`;i.classList.add("on"),i.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 16px">
      <div>
        <div style="font-size:10px;font-weight:700;color:var(--accent3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center">FBA</div>
        <div class="fba-row"><span class="fba-lbl">Referral (15%)</span><span class="fba-val">${fmt(o)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Closing Fee</span><span class="fba-val">${fmt(r)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Fulfillment</span><span class="fba-val">${fmt(a)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Storage/mo</span><span class="fba-val">${fmt(c)}</span></div>
        <div class="fba-row fba-total"><span class="fba-lbl">Profit</span><span class="fba-val">${m(d)}</span></div>
      </div>
      <div>
        <div style="font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;text-align:center">Self-Ship</div>
        <div class="fba-row"><span class="fba-lbl">Referral (15%)</span><span class="fba-val">${fmt(o)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Closing Fee</span><span class="fba-val">${fmt(r)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Shipping</span><span class="fba-val">${fmt(h)}</span></div>
        <div class="fba-row"><span class="fba-lbl">Ship Credit</span><span class="fba-val" style="color:var(--good)">+${fmt(u)}</span></div>
        <div class="fba-row fba-total"><span class="fba-lbl">Profit</span><span class="fba-val">${m(f)}</span></div>
      </div>
    </div>
    <div class="fba-winner" style="background:${g?"rgba(123,97,255,0.1);color:var(--accent3)":"rgba(87,200,255,0.1);color:var(--accent)"}">
      ${g?" FBA wins":" Self-Ship wins"} by ${fmt(Math.abs(d-f))} per unit
    </div>
    <div style="margin-top:10px;padding:8px 10px;background:rgba(255,184,0,0.06);border:1px solid rgba(255,184,0,0.15);font-size:10px;color:var(--warn);font-family:'DM Mono',monospace"> Fee estimates shown are for Books/Media category. Other categories (electronics, apparel, etc.) have different fee structures.</div>`}function Pc(t){var e,n,s,i,o,r,a,c;return{isbn:((e=document.getElementById(t+"_isbn"))==null?void 0:e.value.trim())||"",author:((n=document.getElementById(t+"_author"))==null?void 0:n.value.trim())||"",publisher:((s=document.getElementById(t+"_publisher"))==null?void 0:s.value.trim())||"",edition:((i=document.getElementById(t+"_edition"))==null?void 0:i.value.trim())||"",printing:((o=document.getElementById(t+"_printing"))==null?void 0:o.value.trim())||"",pubYear:parseInt((r=document.getElementById(t+"_pub_year"))==null?void 0:r.value)||null,signed:((a=document.getElementById(t+"_signed"))==null?void 0:a.checked)||!1,salesRank:parseInt((c=document.getElementById(t+"_sales_rank"))==null?void 0:c.value)||null}}function Xh(t,e){document.getElementById(t+"_isbn").value=e.isbn||"",document.getElementById(t+"_author").value=e.author||"",document.getElementById(t+"_publisher").value=e.publisher||"",document.getElementById(t+"_edition").value=e.edition||"",document.getElementById(t+"_printing").value=e.printing||"",document.getElementById(t+"_pub_year").value=e.pubYear||"",document.getElementById(t+"_signed").checked=!!e.signed,document.getElementById(t+"_sales_rank").value=e.salesRank||"",Cc(t);const n=document.getElementById(t+"_fba_panel");n&&(n.classList.remove("on"),n.innerHTML="")}function Zh(t){["isbn","author","publisher","edition","printing","pub_year","sales_rank"].forEach(o=>{const r=document.getElementById(t+"_"+o);r&&(r.value="")});const e=document.getElementById(t+"_signed");e&&(e.checked=!1);const n=document.getElementById(t+"_rank_display");n&&(n.innerHTML="");const s=document.getElementById(t+"_fba_panel");s&&(s.classList.remove("on"),s.innerHTML="");const i=document.getElementById(t+"_book_fields");i&&i.classList.remove("on")}function em(){const t=document.getElementById("f_cat").value.trim(),e=SUBCATS[t]||[],n=document.getElementById("f_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join(""))}function tm(){const t=document.getElementById("d_cat").value.trim(),e=SUBCATS[t]||[],n=document.getElementById("d_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join(""))}function nm(t,e){const n=document.getElementById(t+"_condition"),s=document.getElementById(t+"_cond_picker");!n||!s||(n.value=e||"",s.querySelectorAll(".cond-tag").forEach(i=>{i.classList.toggle("active",i.textContent.trim()===e)}))}const sm={eBay:{days:30,label:"30-day or GTC",renewable:!0},Amazon:{days:0,label:"Until sold/removed",renewable:!1},Etsy:{days:120,label:"4-month listing",renewable:!0},"Facebook Marketplace":{days:7,label:"7-day listing",renewable:!0},Depop:{days:0,label:"Until sold/removed",renewable:!1},Poshmark:{days:0,label:"Active until sold (share to refresh)",renewable:!1},Mercari:{days:0,label:"Until sold/removed",renewable:!1},Grailed:{days:0,label:"Until sold/removed",renewable:!1},StockX:{days:30,label:"30-day ask",renewable:!0},GOAT:{days:30,label:"30-day listing",renewable:!0},Vinted:{days:0,label:"Until sold/removed",renewable:!1},Tradesy:{days:0,label:"Until sold/removed",renewable:!1},"The RealReal":{days:0,label:"Consignment period",renewable:!1},"Vestiaire Collective":{days:0,label:"Until sold/removed",renewable:!1},Reverb:{days:0,label:"Until sold/removed",renewable:!1},Discogs:{days:0,label:"Until sold/removed",renewable:!1},Craigslist:{days:45,label:"45-day listing",renewable:!0},OfferUp:{days:0,label:"Until sold/removed",renewable:!1},Nextdoor:{days:30,label:"30-day listing",renewable:!0},Whatnot:{days:0,label:"Live auction",renewable:!1},"TikTok Shop":{days:0,label:"Until sold/removed",renewable:!1},Instagram:{days:0,label:"Until sold/removed",renewable:!1},Shopify:{days:0,label:"Until sold/removed",renewable:!1},"Walmart Marketplace":{days:0,label:"Until sold/removed",renewable:!1},Newegg:{days:0,label:"Until sold/removed",renewable:!1},Bonanza:{days:0,label:"Until sold/removed",renewable:!1},"Ruby Lane":{days:0,label:"Until sold/removed",renewable:!1},Chairish:{days:0,label:"Until sold/removed",renewable:!1},"1stDibs":{days:0,label:"Until sold/removed",renewable:!1},Swappa:{days:30,label:"30-day listing",renewable:!0},Decluttr:{days:0,label:"Until sold/removed",renewable:!1}},im=["active","sold","sold-elsewhere","delisted","expired","draft"],Qo={active:"Active",sold:"Sold","sold-elsewhere":"Sold Elsewhere",delisted:"Delisted",expired:"Expired",draft:"Draft"},Dc={active:"var(--good)",sold:"var(--accent)","sold-elsewhere":"var(--accent2)",delisted:"var(--muted)",expired:"var(--danger)",draft:"var(--warn)"};function $r(t,e){const n=sm[t];if(!n||n.days===0)return null;const s=new Date(e);return isNaN(s.getTime())?null:(s.setDate(s.getDate()+n.days),s.toISOString().split("T")[0])}function Bc(t,e){const n=$r(t,e);if(!n)return null;const s=new Date;s.setHours(0,0,0,0);const i=new Date(n);return i.setHours(0,0,0,0),Math.ceil((i-s)/864e5)}function He(t,e,n){const s=$.find(i=>i.id===t);return s?(s.platformStatus||(s.platformStatus={}),s.platformStatus[e]=n,J("inv",t),!0):!1}function un(t,e,n){const s=$.find(o=>o.id===t);if(!s)return;s.platformListingDates||(s.platformListingDates={}),s.platformListingExpiry||(s.platformListingExpiry={}),s.platformListingDates[e]=n||new Date().toISOString().split("T")[0];const i=$r(e,s.platformListingDates[e]);i?s.platformListingExpiry[e]=i:delete s.platformListingExpiry[e],J("inv",t)}function Ki(t,e){const n=$.find(i=>i.id===t);if(!n)return;const s=new Date().toISOString().split("T")[0];n.lastRelisted||(n.lastRelisted={}),n.lastRelisted[e]=s,un(t,e,s),He(t,e,"active")}function Er(t,e){const n=$.find(o=>o.id===t);if(!n)return[];const s=Y(n);n.platformStatus||(n.platformStatus={}),n.platformStatus[e]="sold";const i=[];if((n.qty||0)<=0)for(const o of s){if(o===e)continue;const r=n.platformStatus[o];(r==="active"||!r)&&(n.platformStatus[o]="sold-elsewhere",i.push(o))}return J("inv",t),i}function Ir(t){const e=new Date;e.setHours(0,0,0,0);const n=[];for(const s of t){const i=Y(s),o=s.platformStatus||{},r=s.platformListingDates||{},a=s.platformListingExpiry||{};for(const c of i){if(o[c]&&o[c]!=="active")continue;const l=a[c];l&&new Date(l)<e&&n.push({item:s,platform:c,expiryDate:l,listedDate:r[c]||null})}}return n}function Oc(t,e=7){const n=new Date;n.setHours(0,0,0,0);const s=new Date(n);s.setDate(s.getDate()+e);const i=[];for(const o of t){const r=Y(o),a=o.platformStatus||{},c=o.platformListingDates||{},l=o.platformListingExpiry||{};for(const d of r){if(a[d]&&a[d]!=="active")continue;const u=l[d];if(u){const p=new Date(u);if(p>=n&&p<=s){const h=Math.ceil((p-n)/864e5);i.push({item:o,platform:d,expiryDate:u,daysLeft:h,listedDate:c[d]||null})}}}}return i.sort((o,r)=>o.daysLeft-r.daysLeft)}function Ac(){const t=Ir($);let e=0;for(const{item:n,platform:s}of t)n.platformStatus||(n.platformStatus={}),n.platformStatus[s]!=="expired"&&(n.platformStatus[s]="expired",J("inv",n.id),e++);return e>0&&(R(),k(`${e} listing${e>1?"s":""} expired  relist from Crosslist tab`)),e}function Lc(t){const e=Y(t),n=t.platformStatus||{};let s=0,i=0,o=0,r=0,a=0,c=0;for(const l of e){const d=n[l]||"active";d==="active"?s++:d==="sold"?i++:d==="sold-elsewhere"?o++:d==="expired"?r++:d==="delisted"?a++:d==="draft"&&c++}return{totalPlatforms:e.length,active:s,sold:i,soldElsewhere:o,expired:r,delisted:a,draft:c}}function om(t){let e=0,n=0,s=0,i=0,o=0,r=0;s=Oc(t,7).length;for(const c of t){if((c.qty||0)<=0)continue;const l=Lc(c);e+=l.active,n+=l.expired,i+=l.soldElsewhere,l.totalPlatforms===0?o++:l.totalPlatforms===1&&r++}return{totalActive:e,totalExpired:n,totalExpiringSoon:s,totalSoldElsewhere:i,itemsNotListed:o,itemsSinglePlatform:r}}function rm(){let t=0;for(const e of $){const n=Y(e);if(n.length){e.platformListingDates||(e.platformListingDates={}),e.platformListingExpiry||(e.platformListingExpiry={}),e.platformStatus||(e.platformStatus={});for(const s of n){if(!e.platformListingDates[s]){const i=e.added?new Date(e.added).toISOString().split("T")[0]:new Date().toISOString().split("T")[0];e.platformListingDates[s]=i;const o=$r(s,i);o&&(e.platformListingExpiry[s]=o),t++}e.platformStatus[s]||(e.platformStatus[s]="active")}t>0&&J("inv",e.id)}}t>0&&R()}const Rc=encodeURIComponent,am={eBay:t=>`https://www.ebay.com/sell/create?item_title=${Rc((t.name||"").slice(0,80))}`,Poshmark:()=>"https://poshmark.com/create-listing",Mercari:()=>"https://www.mercari.com/sell/",Depop:()=>"https://www.depop.com/products/create/",Etsy:()=>"https://www.etsy.com/your/shops/me/tools/listings/create","Facebook Marketplace":()=>"https://www.facebook.com/marketplace/create/item/",Amazon:()=>"https://sellercentral.amazon.com/product-search/search",Grailed:()=>"https://www.grailed.com/sell",StockX:()=>"https://stockx.com/sell",GOAT:()=>"https://www.goat.com/sell",Vinted:()=>"https://www.vinted.com/items/new","The RealReal":()=>"https://www.therealreal.com/consign","Vestiaire Collective":()=>"https://www.vestiairecollective.com/sell/",Reverb:()=>"https://reverb.com/sell",Discogs:()=>"https://www.discogs.com/sell/list",Craigslist:()=>"https://post.craigslist.org/",OfferUp:()=>"https://offerup.com/post",Nextdoor:()=>"https://nextdoor.com/for_sale_and_free/",Whatnot:()=>"https://www.whatnot.com/sell","TikTok Shop":()=>"https://seller-us.tiktok.com/",Instagram:()=>"https://www.instagram.com/",Shopify:()=>"https://admin.shopify.com/","Walmart Marketplace":()=>"https://seller.walmart.com/",Newegg:()=>"https://seller.newegg.com/",Bonanza:()=>"https://www.bonanza.com/booths/items/new","Ruby Lane":()=>"https://www.rubylane.com/",Chairish:()=>"https://www.chairish.com/consign","1stDibs":()=>"https://www.1stdibs.com/dealers/",Swappa:()=>"https://swappa.com/sell",Decluttr:()=>"https://www.decluttr.com/sell-my-stuff"};function Mc(t,e){if(e.url&&Y(e).length===1)return e.url;const n=am[t];return n?n(e):`https://www.google.com/search?q=${Rc(t+" sell "+(e.name||""))}`}function Tr(t,e){const n={"{name}":t.name||"","{condition}":t.condition||"Good","{category}":t.category||"","{subcategory}":t.subcategory||"","{subtype}":t.subtype||"","{sku}":t.sku||"","{upc}":t.upc||"","{price}":t.price?`$${t.price.toFixed(2)}`:"","{source}":t.source||"","{notes}":t.notes||"","{dimensions}":t.dimL&&t.dimW&&t.dimH?`${t.dimL}  ${t.dimW}  ${t.dimH} ${t.dimUnit||"in"}`:"","{weight}":t.weight?`${t.weight} ${t.dimUnit==="cm"?"kg":"lb"}`:"","{author}":t.author||"","{isbn}":t.isbn||""},s=r=>{let a=r;for(const[c,l]of Object.entries(n))a=a.replaceAll(c,l);return a.replace(/\s{2,}/g," ").trim()};if(e)return{title:s(e.titleFormula||"{name}"),description:s(e.descriptionTemplate||"")};const i=t.name||"Item",o=[];return t.condition&&o.push(`Condition: ${t.condition}`),t.category&&o.push(`Category: ${t.category}`),t.subcategory&&o.push(`Subcategory: ${t.subcategory}`),t.upc&&o.push(`UPC: ${t.upc}`),t.notes&&o.push(`
${t.notes}`),o.push(`
Ships fast! Check my other listings for bundle deals.`),{title:i,description:o.join(`
`)}}async function jc(t,e){const{title:n,description:s}=Tr(t,e),i=`${n}

${s}`;try{return await navigator.clipboard.writeText(i),k("Listing text copied to clipboard "),!0}catch{const r=document.createElement("textarea");r.value=i,r.style.position="fixed",r.style.opacity="0",document.body.appendChild(r),r.select();try{document.execCommand("copy"),k("Listing text copied ")}catch{k("Copy failed  select text manually",!0)}return document.body.removeChild(r),!1}}function Cr(t,e,n="manual"){const s=$.find(i=>i.id===t);s&&(s.priceHistory||(s.priceHistory=[]),s.priceHistory.push({date:Date.now(),price:e,source:n}),s.priceHistory.length>50&&s.priceHistory.shift(),J("inv",t),R())}function Pr(t,e,n){const s=$.find(i=>i.id===t);s&&(s.priceHistory||(s.priceHistory=[]),s.priceHistory.push({date:Date.now(),price:e,source:"sold",platform:n}),s.priceHistory.length>50&&s.priceHistory.shift(),J("inv",t),R())}function Dr(t){const e=$.find(n=>n.id===t);return(e==null?void 0:e.priceHistory)||[]}function lm(t){const e=Dr(t);if(e.length<2)return"stable";const n=e.slice(-5),s=n[0].price,i=n[n.length-1].price;return i>s*1.02?"up":i<s*.98?"down":"stable"}function cm(t){const e=Dr(t);if(e.length<2)return'<div style="padding:10px;color:var(--muted);font-size:12px">No price history yet</div>';const n=e.slice(-20),s=n.map(c=>c.price),i=Math.min(...s),o=Math.max(...s),r=o-i||1;return`
    <div style="padding:8px;background:var(--surface2);border-radius:4px">
      <div style="display:flex;align-items:flex-end;height:40px;margin-bottom:6px;gap:2px">
        ${s.map(c=>{const l=(c-i)/r*100,d=c===s[s.length-1]?"var(--accent)":lm(t)==="up"?"var(--good)":"var(--warn)";return`<div style="display:inline-block;width:4px;height:${Math.max(l,5)}%;background:${d};margin:0 1px;border-radius:2px" title="${x(c)}"></div>`}).join("")}
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
        <span>${x(i)}</span>
        <span>${x(o)}</span>
        <span style="font-weight:500;color:var(--text)">${n.length} changes</span>
      </div>
    </div>
  `}function dm(t){const e=Dr(t);return e.length?`
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead style="background:var(--surface2);border-bottom:2px solid var(--border)">
        <tr>
          <th style="padding:6px 8px;text-align:left;font-weight:500">Date</th>
          <th style="padding:6px 8px;text-align:right;font-weight:500">Price</th>
          <th style="padding:6px 8px;text-align:center;font-weight:500">Source</th>
        </tr>
      </thead>
      <tbody>${e.slice(-20).reverse().map(s=>{const i=s.source==="sold"?`<span style="font-size:10px;background:var(--danger);color:white;padding:2px 6px;border-radius:3px">${s.platform||"SOLD"}</span>`:s.source==="repricing"?'<span style="font-size:10px;background:var(--accent2);color:white;padding:2px 6px;border-radius:3px">AUTO</span>':"";return`
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:6px 8px;font-size:12px;color:var(--muted)">${ce(s.date)}</td>
        <td style="padding:6px 8px;text-align:right;font-weight:500">${x(s.price)}</td>
        <td style="padding:6px 8px;text-align:center">${i}</td>
      </tr>
    `}).join("")}</tbody>
    </table>
  `:'<div style="padding:10px;color:var(--muted);font-size:12px">No price history</div>'}const Gn={d:"in",f:"in"};function Br(t,e){var r,a;Gn[t]=e,(r=document.getElementById(`${t}_unit_in`))==null||r.classList.toggle("active",e==="in"),(a=document.getElementById(`${t}_unit_cm`))==null||a.classList.toggle("active",e==="cm");const n=e==="in",s=document.getElementById(`${t}_wt_maj_lbl`),i=document.getElementById(`${t}_wt_min_lbl`),o=document.getElementById(`${t}_dim_unit_lbl`);s&&(s.textContent=n?"lb":"kg"),i&&(i.textContent=n?"oz":"g"),o&&(o.textContent=n?"in":"cm"),Or(t)}function Or(t){var c,l,d,u,p;const e=parseFloat((c=document.getElementById(`${t}_wt_maj`))==null?void 0:c.value)||0,n=parseFloat((l=document.getElementById(`${t}_wt_min`))==null?void 0:l.value)||0,s=parseFloat((d=document.getElementById(`${t}_len`))==null?void 0:d.value)||0,i=parseFloat((u=document.getElementById(`${t}_wid`))==null?void 0:u.value)||0,o=parseFloat((p=document.getElementById(`${t}_hgt`))==null?void 0:p.value)||0,r=Gn[t]||"in",a=document.getElementById(`${t}_dimwt_val`);if(a){if(s&&i&&o){let h;r==="in"?(h=s*i*o/139,a.textContent=`dim wt: ${h.toFixed(2)} lb`):(h=s*i*o/5e3,a.textContent=`dim wt: ${h.toFixed(2)} kg`);const f=r==="in"?e+n/16:(e+n/1e3)*2.205;a.style.color=h>f?"var(--danger)":"var(--accent)",a.title=h>f?"Carrier may charge dimensional weight":"Actual weight is heavier"}else a.textContent="";Ar(t)}}function To(t,e){return e==="cm"?t/2.54:t}function um(t,e,n){return n==="in"?t+e/16:(t+e/1e3)*2.205}const pm=[{id:"poly-sm",icon:"",name:"Poly Mailer (S)",dims:[6,9,0],maxWt:.5,type:"mailer",note:"Clothing, soft goods under 8oz. Lightweight & waterproof."},{id:"poly-md",icon:"",name:"Poly Mailer (M)",dims:[10,13,0],maxWt:1,type:"mailer",note:"T-shirts, jeans, folded apparel. Most common reseller mailer."},{id:"poly-lg",icon:"",name:"Poly Mailer (L)",dims:[14.5,19,0],maxWt:2,type:"mailer",note:"Bulkier clothing, hoodies, jackets, multiple garments."},{id:"bubble-sm",icon:"",name:"Bubble Mailer (S)",dims:[4,8,0],maxWt:.5,type:"mailer",note:"Jewelry, coins, small electronics, accessories."},{id:"bubble-md",icon:"",name:"Bubble Mailer (M)",dims:[8.5,11,0],maxWt:1,type:"mailer",note:"Phone cases, small accessories, books under 1 lb."},{id:"bubble-lg",icon:"",name:"Bubble Mailer (L)",dims:[10.5,16,0],maxWt:2,type:"mailer",note:"Shoes (soft), stacked books, light electronics."},{id:"flat-env",icon:"",name:"USPS Flat Rate Env",dims:[12.5,9.5,0],maxWt:70,type:"flatrate",note:"Up to 70 lbs, flat rate pricing. Great for coins, hardware."},{id:"fr-padded",icon:"",name:"USPS Padded Flat Rate",dims:[12.5,9.5,0],maxWt:70,type:"flatrate",note:"Same flat rate price but padded. Good for fragile flat items."},{id:"pri-sm",icon:"",name:"Priority Small Flat Rate",dims:[8.625,5.375,1.625],maxWt:70,type:"priority",note:"Wallets, sunglasses, cards, thin documents."},{id:"pri-md-1",icon:"",name:"Priority Medium (Top)",dims:[11,8.5,5.5],maxWt:70,type:"priority",note:"Most versatile flat rate  shoes, folded clothes, small appliances."},{id:"pri-md-2",icon:"",name:"Priority Medium (Side)",dims:[13.625,11.875,3.375],maxWt:70,type:"priority",note:"Wide, flat items  art prints, keyboards, flat goods."},{id:"pri-lg",icon:"",name:"Priority Large Flat Rate",dims:[12,12,5.5],maxWt:70,type:"priority",note:"Best for 220 lb items shipping coast-to-coast."},{id:"box-xs",icon:"",name:'Box 666"',dims:[6,6,6],maxWt:10,type:"box",note:"Mugs, small electronics, candles, collectibles."},{id:"box-sm",icon:"",name:'Box 888"',dims:[8,8,8],maxWt:20,type:"box",note:"Shoes, books, small appliances, hats."},{id:"box-md",icon:"",name:'Box 12128"',dims:[12,12,8],maxWt:40,type:"box",note:"Handbags, boots, cameras + accessories, stacked books."},{id:"box-lg",icon:"",name:'Box 181816"',dims:[18,18,16],maxWt:65,type:"box",note:"Coats, keyboards, record players, printers."},{id:"box-xl",icon:"",name:'Box 242418"',dims:[24,24,18],maxWt:70,type:"box",note:"Luggage, monitors, large artwork, bundled clothing."}],fm=[{name:"Bubble wrap",icon:"",when:(t,e)=>e||t>1},{name:"Packing peanuts",icon:"",when:(t,e,n)=>e&&n>200},{name:"Kraft paper fill",icon:"",when:(t,e,n)=>n>100},{name:"Foam sheets",icon:"",when:(t,e)=>e},{name:"Air pillows",icon:"",when:(t,e,n)=>n>300&&!e},{name:"Tissue paper",icon:"",when:t=>t<1},{name:"Double-boxing",icon:"",when:(t,e)=>e&&t>5}];function Ar(t){var G,D,P,z,oe;const e=document.getElementById(`${t}_pkg_suggestion`);if(!e)return;const n=Gn[t]||"in",s=parseFloat((G=document.getElementById(`${t}_wt_maj`))==null?void 0:G.value)||0,i=parseFloat((D=document.getElementById(`${t}_wt_min`))==null?void 0:D.value)||0,o=parseFloat((P=document.getElementById(`${t}_len`))==null?void 0:P.value)||0,r=parseFloat((z=document.getElementById(`${t}_wid`))==null?void 0:z.value)||0,a=parseFloat((oe=document.getElementById(`${t}_hgt`))==null?void 0:oe.value)||0,c=s>0||i>0,l=o>0&&r>0&&a>0;if(!c&&!l){e.innerHTML="";return}const d=um(s,i,n),u=To(o,n),p=To(r,n),h=To(a,n),f=l?[u,p,h].sort((N,X)=>X-N):[0,0,0],g=f[0]*f[1]*f[2],v=(g>0?d/(g/1728):0)>10||d>.5&&g<50,E=pm.map(N=>{const X=[...N.dims].sort((so,io)=>io-so);let Be=d<=N.maxWt;if(l&&Be&&(X[2]===0?((f[0]>X[0]-1||f[1]>X[1]-1)&&(Be=!1),h>2&&(Be=!1)):(f[0]>X[0]-1||f[1]>X[1]-1||f[2]>X[2]-.5)&&(Be=!1)),!Be)return null;const ei=X[0]*X[1]*Math.max(X[2],1);let Mt=1e3/(g>0?ei/g:ei);return N.type==="flatrate"&&d>3&&(Mt+=200),N.type==="flatrate"&&d>8&&(Mt+=400),N.type==="mailer"&&d<1&&!v&&(Mt+=300),N.type==="mailer"&&v&&(Mt-=200),{...N,score:Mt}}).filter(Boolean).sort((N,X)=>X.score-N.score);if(!E.length){e.innerHTML='<div class="pkg-suggest"><div class="pkg-suggest-hd"><span class="pkg-suggest-icon"></span><span class="pkg-suggest-ttl">No standard package found</span><span class="pkg-suggest-sub">May require custom or freight packaging</span></div></div>';return}const w=E.slice(0,3),S=fm.filter(N=>N.when(d,v,g)),C=w.map((N,X)=>{const Be=N.dims[2]===0?`${N.dims[0]}"  ${N.dims[1]}"`:`${N.dims[0]}"  ${N.dims[1]}"  ${N.dims[2]}"`;return`<div class="pkg-card${X===0?" best":""}">
      ${X===0?'<div class="pkg-best-tag">Best fit</div>':""}
      <div class="pkg-card-ico">${N.icon}</div>
      <div class="pkg-card-name">${N.name}</div>
      <div class="pkg-card-dim">${Be}</div>
      <div class="pkg-card-note">${N.note}</div>
    </div>`}).join(""),B=S.length?`<div class="pkg-padding-list">
    <span class="pkg-padding-ttl">Fill &amp; Protection:</span>
    ${S.map(N=>`<span class="pkg-pad-chip">${N.icon} ${N.name}</span>`).join("")}
  </div>`:"",L=c?`${d.toFixed(2)} lb`:"weight not set",O=l?`${u.toFixed(1)}"  ${p.toFixed(1)}"  ${h.toFixed(1)}"`:"dims not set";e.innerHTML=`<div class="pkg-suggest">
    <div class="pkg-suggest-hd">
      <span class="pkg-suggest-icon"></span>
      <span class="pkg-suggest-ttl">Packaging Suggestions</span>
      <span class="pkg-suggest-sub">${L}  ${O}</span>
    </div>
    <div class="pkg-cards">${C}</div>
    ${B}
  </div>`}function hm(t,e){var i,o;const n=e.dimUnit||"in";Gn[t]=n,(i=document.getElementById(`${t}_unit_in`))==null||i.classList.toggle("active",n==="in"),(o=document.getElementById(`${t}_unit_cm`))==null||o.classList.toggle("active",n==="cm"),Br(t,n);const s={wt_maj:"weightMaj",wt_min:"weightMin",len:"dimL",wid:"dimW",hgt:"dimH"};for(const[r,a]of Object.entries(s)){const c=document.getElementById(`${t}_${r}`);c&&(c.value=e[a]||"")}Or(t)}function Nc(t){var e,n,s,i,o;return{dimUnit:Gn[t]||"in",weightMaj:parseFloat((e=document.getElementById(`${t}_wt_maj`))==null?void 0:e.value)||0,weightMin:parseFloat((n=document.getElementById(`${t}_wt_min`))==null?void 0:n.value)||0,dimL:parseFloat((s=document.getElementById(`${t}_len`))==null?void 0:s.value)||0,dimW:parseFloat((i=document.getElementById(`${t}_wid`))==null?void 0:i.value)||0,dimH:parseFloat((o=document.getElementById(`${t}_hgt`))==null?void 0:o.value)||0}}function mm(t){["wt_maj","wt_min","len","wid","hgt"].forEach(e=>{const n=document.getElementById(`${t}_${e}`);n&&(n.value="")}),Gn[t]="in",Br(t,"in")}let Qt=[];function at(t){return t.images&&t.images.length?[...t.images]:t.image?[t.image]:[]}function gm(t,e,n){const s=t.target.files[0];if(t.target.value="",!s)return;const i=e==="f"?"f:"+n:yt+":"+n;Lr(s,i)}function ym(t,e,n){if(t.stopPropagation(),t.preventDefault(),e==="f")Qt.splice(n,1),rt("f",Qt);else{const s=$.find(r=>r.id===yt);if(!s)return;const i=at(s),o=i[n];i.splice(n,1),s.images=i,s.image=i[0]||null,R(),rt("d",i),window.renderInv&&window.renderInv(),Ps(o)&&Eh(o)}}function rt(t,e){for(let n=0;n<3;n++){const s=document.getElementById(t+"Slot"+n),i=document.getElementById(t+"SlotImg"+n),o=document.getElementById(t+"SlotRm"+n),r=document.getElementById(t+"SlotAdd"+n),a=document.getElementById(t+"SlotBadge"+n),c=document.getElementById(t+"SlotInput"+n);s&&(n<e.length?(s.className="img-slot filled",i.src=e[n],i.style.display="block",o&&(o.style.display="flex"),r&&(r.style.display="none"),a&&(a.style.display=n===0?"block":"none"),c&&(c.style.pointerEvents="none",c.style.opacity="0")):n===e.length?(s.className="img-slot",i.src="",i.style.display="none",o&&(o.style.display="none"),r&&(r.style.display="flex",r.style.opacity="1"),a&&(a.style.display="none"),c&&(c.style.pointerEvents="auto",c.style.opacity="0")):(s.className="img-slot img-slot-locked",i.src="",i.style.display="none",o&&(o.style.display="none"),r&&(r.style.display="flex",r.style.opacity="0.3"),a&&(a.style.display="none"),c&&(c.style.pointerEvents="none",c.style.opacity="0")))}}function vm(){rt("f",Qt)}function bm(t){const e=$.find(n=>n.id===t);rt("d",e?at(e):[])}function Lr(t,e){const n=new FileReader;n.onload=s=>Uc(s.target.result,t.type,e),n.readAsDataURL(t)}function wm(t){t.preventDefault()}function xm(){}function _m(t,e){t.preventDefault();const n=t.dataTransfer.files[0];n&&n.type.startsWith("image/")&&Lr(n,e+":0")}function Sm(t){const e=$.find(s=>s.id===t),n=e?at(e):[];n.length&&zc(n[0])}function zc(t){t&&(document.getElementById("lightboxImg").src=t,document.getElementById("lightbox").classList.add("on"))}let U={ctx:null,origDataUrl:null,mimeType:null,img:null,scale:1,rect:null,drag:null,dragStart:null,aspect:null};const Xo="ontouchstart"in window||navigator.maxTouchPoints>0?14:7;function Uc(t,e,n){U.ctx=n,U.origDataUrl=t,U.mimeType=e,U.aspect=null;const s=new Image;s.onload=()=>{U.img=s,document.getElementById("cropCanvasWrap");const i=document.getElementById("cropCanvas"),o=Math.min(window.innerWidth*.9,520),r=window.innerHeight*.55,a=Math.min(o/s.width,r/s.height,1);i.width=Math.round(s.width*a),i.height=Math.round(s.height*a),U.scale=a,U.rect={x:0,y:0,w:i.width,h:i.height},Ws(),i.onmousedown=Hc,i.onmousemove=Wc,i.onmouseup=Gc,i.removeEventListener("touchstart",Zo),i.removeEventListener("touchmove",er),i.removeEventListener("touchend",tr),i.addEventListener("touchstart",Zo,{passive:!1}),i.addEventListener("touchmove",er,{passive:!1}),i.addEventListener("touchend",tr,{passive:!1});const c=document.getElementById("cropOv");c.style.display="flex",c.classList.add("on")},s.src=t}function Ws(){const t=document.getElementById("cropCanvas"),e=t.getContext("2d"),{img:n,scale:s,rect:i}=U;if(e.clearRect(0,0,t.width,t.height),e.drawImage(n,0,0,t.width,t.height),!i)return;e.fillStyle="rgba(0,0,0,0.55)",e.fillRect(0,0,t.width,i.y),e.fillRect(0,i.y+i.h,t.width,t.height-i.y-i.h),e.fillRect(0,i.y,i.x,i.h),e.fillRect(i.x+i.w,i.y,t.width-i.x-i.w,i.h),e.strokeStyle="#57c8ff",e.lineWidth=1.5,e.strokeRect(i.x+.5,i.y+.5,i.w-1,i.h-1),e.strokeStyle="rgba(87,200,255,0.25)",e.lineWidth=.5;for(let r=1;r<3;r++){const a=i.x+i.w/3*r,c=i.y+i.h/3*r;e.beginPath(),e.moveTo(a,i.y),e.lineTo(a,i.y+i.h),e.stroke(),e.beginPath(),e.moveTo(i.x,c),e.lineTo(i.x+i.w,c),e.stroke()}const o=[[i.x,i.y],[i.x+i.w,i.y],[i.x,i.y+i.h],[i.x+i.w,i.y+i.h]];for(const[r,a]of o)e.fillStyle="#57c8ff",e.beginPath(),e.arc(r,a,Xo,0,Math.PI*2),e.fill(),e.fillStyle="#0a0a0f",e.beginPath(),e.arc(r,a,Xo-2.5,0,Math.PI*2),e.fill()}function Fc(t,e){const{rect:n}=U;if(!n)return null;const s=Xo+3,i={nw:[n.x,n.y],ne:[n.x+n.w,n.y],sw:[n.x,n.y+n.h],se:[n.x+n.w,n.y+n.h]};for(const[o,[r,a]]of Object.entries(i))if(Math.abs(t-r)<s&&Math.abs(e-a)<s)return o;return t>n.x&&t<n.x+n.w&&e>n.y&&e<n.y+n.h?"move":"new"}function xe(t,e,n){return Math.max(e,Math.min(n,t))}function qc(t){if(!U.aspect)return t;const{w:e,h:n}=U.aspect,s=document.getElementById("cropCanvas");let i=t.w/e*n;return t.y+i>s.height&&(i=s.height-t.y,t.w=i/n*e),t.h=i,t}function Hc(t){t.preventDefault();const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,i=e.height/n.height;Rr((t.clientX-n.left)*s,(t.clientY-n.top)*i)}function Wc(t){if(!U.drag)return;t.preventDefault();const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,i=e.height/n.height;Mr((t.clientX-n.left)*s,(t.clientY-n.top)*i)}function Gc(t){Ji()}document.addEventListener("mouseup",()=>{U.drag&&Ji()});function Zo(t){t.preventDefault();const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,i=e.height/n.height,o=t.touches[0];Rr((o.clientX-n.left)*s,(o.clientY-n.top)*i)}function er(t){if(t.preventDefault(),!U.drag)return;const e=document.getElementById("cropCanvas"),n=e.getBoundingClientRect(),s=e.width/n.width,i=e.height/n.height,o=t.touches[0];Mr((o.clientX-n.left)*s,(o.clientY-n.top)*i)}function tr(t){t.preventDefault(),Ji()}function Rr(t,e){const n=Fc(t,e),s=U.rect||{x:0,y:0,w:0,h:0};U.drag=n,U.dragStart={mx:t,my:e,rx:s.x,ry:s.y,rw:s.w,rh:s.h};const i=document.getElementById("cropCanvas");i.style.cursor=n==="move"?"grabbing":n==="new"?"crosshair":"nwse-resize",n==="new"&&(U.rect={x:t,y:e,w:0,h:0})}function Mr(t,e){if(!U.drag)return;const{drag:n,dragStart:s}=U,i=document.getElementById("cropCanvas"),o=i.width,r=i.height,a=t-s.mx,c=e-s.my,l=s;let d={...U.rect};if(n==="new")d.x=Math.min(l.rx,t),d.y=Math.min(l.ry,e),d.w=Math.abs(t-l.rx),d.h=Math.abs(e-l.ry),U.aspect&&(d=qc(d));else if(n==="move")d.x=xe(l.rx+a,0,o-l.rw),d.y=xe(l.ry+c,0,r-l.rh);else if(n==="nw"){const u=xe(l.rx+a,0,l.rx+l.rw-10),p=xe(l.ry+c,0,l.ry+l.rh-10);d.w=l.rx+l.rw-u,d.h=l.ry+l.rh-p,d.x=u,d.y=p,U.aspect&&(d.h=d.w/U.aspect.w*U.aspect.h,d.y=l.ry+l.rh-d.h)}else if(n==="ne"){d.w=xe(l.rw+a,10,o-l.rx);const u=xe(l.ry+c,0,l.ry+l.rh-10);d.h=l.ry+l.rh-u,d.y=u,U.aspect&&(d.h=d.w/U.aspect.w*U.aspect.h,d.y=l.ry+l.rh-d.h)}else if(n==="sw"){const u=xe(l.rx+a,0,l.rx+l.rw-10);d.w=l.rx+l.rw-u,d.x=u,d.h=xe(l.rh+c,10,r-l.ry),U.aspect&&(d.h=d.w/U.aspect.w*U.aspect.h)}else n==="se"&&(d.w=xe(l.rw+a,10,o-l.rx),d.h=xe(l.rh+c,10,r-l.ry),U.aspect&&(d.h=d.w/U.aspect.w*U.aspect.h));d.x=xe(d.x,0,o),d.y=xe(d.y,0,r),d.w=xe(d.w,0,o-d.x),d.h=xe(d.h,0,r-d.y),U.rect=d,Ws()}function Ji(){U.drag=null,U.dragStart=null,document.getElementById("cropCanvas").style.cursor="crosshair"}function km(){const t=document.getElementById("cropCanvas");U.rect={x:0,y:0,w:t.width,h:t.height},U.aspect=null,Ws()}function $m(t,e){U.aspect={w:t,h:e};const n=document.getElementById("cropCanvas"),s=U.rect||{x:0,y:0,w:n.width,h:n.height};s.h=s.w/t*e,s.y+s.h>n.height&&(s.h=n.height-s.y,s.w=s.h/e*t),U.rect=s,Ws()}function Vc(){const t=document.getElementById("cropOv");t.classList.remove("on"),t.style.display="none",U={ctx:null,origDataUrl:null,mimeType:null,img:null,scale:1,rect:null,drag:null,dragStart:null,aspect:null}}function Em(){const{img:t,rect:e,scale:n,ctx:s,mimeType:i}=U;if(!t||!e||e.w<2||e.h<2){Vc();return}const o=e.x/n,r=e.y/n,a=e.w/n,c=e.h/n,l=document.createElement("canvas");l.width=Math.round(a),l.height=Math.round(c),l.getContext("2d").drawImage(t,o,r,a,c,0,0,l.width,l.height);const d=l.toDataURL("image/jpeg",.92),u=document.getElementById("cropOv");u.classList.remove("on"),u.style.display="none";const p=s,h=yt;U={ctx:null,origDataUrl:null,mimeType:null,img:null,scale:1,rect:null,drag:null,dragStart:null,aspect:null},Kc(d,i,(f,g)=>{const[m,v]=(p||"").split(":"),E=parseInt(v)||0;if(m==="f")E>=Qt.length?Qt.push(f):Qt[E]=f,rt("f",Qt),k("Photo added ");else{const w=m||h,S=$.find(C=>C.id===w);if(S){const C=at(S);E>=C.length?C.push(f):C[E]=f,S.images=C.slice(),S.image=C[0]||null,rt("d",S.images),window.renderInv&&window.renderInv(),k("Photo added  uploading"),fc(f,w,E).then(B=>{const L=at(S),O=L.indexOf(f);O!==-1?L[O]=B:L[E]=B,S.images=L,S.image=L[0]||null,R(),rt("d",S.images),window.renderInv&&window.renderInv(),k("Photo saved ")}).catch(B=>{console.warn("FlipTrack: upload failed, keeping base64:",B.message),R(),k("Photo saved locally ")})}}})}function Kc(t,e,n){const r="image/jpeg",a=new Image;a.onload=()=>{if(Math.round(t.length*.75/1024)<=200&&a.width<=900&&a.height<=900){n(t,!1);return}const l=document.createElement("canvas"),d=l.getContext("2d");let u=a.width,p=a.height;if(u>900||p>900){const g=Math.min(900/u,900/p);u=Math.round(u*g),p=Math.round(p*g)}l.width=u,l.height=p,d.drawImage(a,0,0,u,p);let h=.85,f=l.toDataURL(r,h);for(;f.length*.75/1024>200&&h>.3;)h=Math.max(.3,h-.1),f=l.toDataURL(r,h);f.length*.75/1024>200&&(l.width=Math.round(u*.65),l.height=Math.round(p*.65),d.drawImage(a,0,0,l.width,l.height),f=l.toDataURL(r,.3)),n(f,!0)},a.src=t}function Jc(){document.getElementById("lightbox").classList.remove("on"),document.getElementById("lightboxImg").src=""}document.addEventListener("keydown",t=>{t.key==="Escape"&&Jc()});const Im=Object.freeze(Object.defineProperty({__proto__:null,clamp:xe,closeLightbox:Jc,compressImage:Kc,cropApplyAspect:qc,cropCancel:Vc,cropConfirm:Em,cropDraw:Ws,cropEndDrag:Ji,cropHitTest:Fc,cropMouseDown:Hc,cropMouseMove:Wc,cropMouseUp:Gc,cropMoveDrag:Mr,cropReset:km,cropSetAspect:$m,cropStartDrag:Rr,cropTouchEnd:tr,cropTouchMove:er,cropTouchStart:Zo,getItemImages:at,imgDragLeave:xm,imgDragOver:wm,imgDrop:_m,imgSlotChange:gm,imgSlotRemove:ym,openCropModal:Uc,openLightbox:Sm,openLightboxUrl:zc,readImgFile:Lr,refreshImgSlots:rt,renderAddFormImages:vm,renderDrawerImg:bm},Symbol.toStringTag,{value:"Module"}));function jr(t){return(t.sku||t.id).replace(/[^A-Za-z0-9\-\.\ \$\/\+\%]/g,"").substring(0,40)||"ITEM"}function Yc(t,e){try{JsBarcode(t,e,{format:"CODE128",width:2,height:50,displayValue:!1,margin:0,background:"#ffffff",lineColor:"#000000"})}catch{JsBarcode(t,"FT"+e.replace(/[^A-Za-z0-9]/g,"").substring(0,20),{format:"CODE128",width:2,height:50,displayValue:!1,margin:0,background:"#ffffff",lineColor:"#000000"})}}function Qc(t){const e=document.getElementById("dBarcodeWrap");if(!e)return;const n=jr(t);e.innerHTML=`
    <div class="barcode-wrap">
      <svg id="dBarcodeSvg"></svg>
      <div class="barcode-sku-lbl">${n}</div>
    </div>
    <div class="barcode-actions">
      <button class="btn-secondary" style="font-size:11px;padding:5px 10px" onclick="printStickers(false,[activeDrawId])"> Print Sticker</button>
      <span style="font-size:10px;color:var(--muted)">CODE128</span>
    </div>`;const s=document.getElementById("dBarcodeSvg");s&&Yc(s,n)}function Tm(t,e){let n;if(e)n=e.map(o=>$.find(r=>r.id===o)).filter(Boolean);else if(t&&fe.size)n=[...fe].map(o=>$.find(r=>r.id===o)).filter(Boolean);else{const o=(document.getElementById("invSearch").value||"").toLowerCase();n=$.filter(r=>{const a=!o||r.name.toLowerCase().includes(o)||(r.sku||"").toLowerCase().includes(o),c=Re.size===0||Y(r).some(h=>Re.has(h)),l=(r.category||"").toLowerCase(),d=_e.size===0||[..._e].some(h=>h.toLowerCase()===l);return a&&c&&d&&Rh==="all"&&Mh==="all"})}if(!n.length){k("No items to print",!0);return}const s=n.map(o=>{const r=jr(o),a="$"+Number(o.price||0).toFixed(2),c=at(o)[0]?`<img class="st-photo" src="${at(o)[0]}" alt="">`:"",l=[o.category,o.subcategory,o.subtype].filter(Boolean).join("  ");return`
      <div class="sticker" data-sku="${r}">
        ${c}
        <div class="st-name">${o.name}</div>
        ${l?`<div class="st-cat">${l}</div>`:""}
        <div class="st-meta">
          <span class="st-platform">${Y(o).join("  ")}</span>
          <span class="st-price">${a}</span>
        </div>
        <div class="st-bc-wrap">
          <svg class="bc-svg" data-val="${r}"></svg>
          <div class="st-sku">${r}</div>
        </div>
      </div>`}).join(""),i=window.open("","_blank","width=900,height=700");i.document.write(`<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FlipTrack  Inventory Stickers</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"><\/script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Courier New', monospace;
    background: #f5f5f5;
    padding: 16px;
  }
  .print-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #000;
  }
  .print-title { font-size: 20px; font-weight: 700; letter-spacing: 2px; }
  .print-meta  { font-size: 11px; color: #666; }
  .print-actions { display: flex; gap: 8px; }
  .print-btn {
    padding: 8px 18px;
    background: #000;
    color: #fff;
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .print-btn.sec { background: #fff; color: #000; border: 1px solid #000; }

  .sticker-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }

  .sticker {
    background: #fff;
    border: 1.5px solid #000;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    page-break-inside: avoid;
    break-inside: avoid;
    min-height: 160px;
  }
  .st-photo {
    width: 100%;
    height: 70px;
    object-fit: cover;
    border: 1px solid #eee;
    margin-bottom: 2px;
  }
  .st-name {
    font-size: 11px;
    font-weight: 700;
    line-height: 1.3;
    letter-spacing: 0.3px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .st-cat {
    font-size: 8px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .st-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2px;
  }
  .st-platform {
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: #f0f0f0;
    padding: 2px 5px;
    color: #333;
  }
  .st-price {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .st-bc-wrap {
    margin-top: auto;
    padding-top: 5px;
    border-top: 1px dashed #ccc;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }
  .bc-svg { width: 100%; max-height: 44px; }
  .st-sku {
    font-size: 7.5px;
    letter-spacing: 1.5px;
    color: #444;
    text-transform: uppercase;
  }

  @media print {
    body { background: #fff; padding: 8px; }
    .print-header .print-actions { display: none; }
    .sticker-grid { gap: 6px; }
    .sticker { border: 1px solid #000; }
  }
  @page { margin: 12mm; }
</style>
</head>
<body>
<div class="print-header">
  <div>
    <div class="print-title">FLIPTRACK  INVENTORY STICKERS</div>
    <div class="print-meta">${n.length} item${n.length!==1?"s":""}  Generated ${new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}</div>
  </div>
  <div class="print-actions">
    <button class="print-btn sec" onclick="window.close()"> Close</button>
    <button class="print-btn" onclick="window.print()"> Print</button>
  </div>
</div>
<div class="sticker-grid">${s}</div>
<script>
  window.onload = function() {
    document.querySelectorAll('.bc-svg').forEach(svg => {
      const val = svg.dataset.val;
      try {
        JsBarcode(svg, val, {
          format: 'CODE128',
          width: 1.5,
          height: 40,
          displayValue: false,
          margin: 0,
          background: '#ffffff',
          lineColor: '#000000',
        });
      } catch(e) {
        JsBarcode(svg, 'FT' + val.replace(/[^A-Za-z0-9]/g,'').substring(0,20), {
          format:'CODE128', width:1.5, height:40, displayValue:false,
          margin:0, background:'#ffffff', lineColor:'#000000'
        });
      }
    });
    // Auto-show print dialog after barcodes render
    setTimeout(() => window.print(), 400);
  };
<\/script>
</body>
</html>`),i.document.close()}const Cm=Object.freeze(Object.defineProperty({__proto__:null,makeBarcodeValue:jr,printStickers:Tm,renderBarcode:Yc,renderDrawerBarcode:Qc},Symbol.toStringTag,{value:"Module"}));let Bi=[];function Pm(){const t=$.find(e=>e.id===yt);t&&(Xc(t.id),Yi())}function Xc(t){const e=$.find(a=>a.id===t);if(!e)return;const n=ie(),s=new Date().toISOString().slice(0,10).replace(/-/g,""),i=(e.category||"GEN").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,4).padEnd(3,"X"),o=Math.random().toString(36).slice(2,5).toUpperCase(),r={...JSON.parse(JSON.stringify(e)),id:n,sku:i+"-"+s+"-"+o,added:new Date().toISOString(),platformStatus:{}};$.push(r),R(),W(),Ns.create(),k("Duplicated: "+r.name+" "),Hn()}function Zc(t,e){document.querySelectorAll(".add-form-tab").forEach(l=>{l.style.color="var(--muted)",l.style.borderBottomColor="transparent",l.classList.remove("active")}),e&&(e.style.color="var(--accent)",e.style.borderBottomColor="var(--accent)",e.classList.add("active"));const n=["f_name","f_sku","f_upc","f_cat","f_source","f_subcat_txt","f_subtype","f_plat_picker","f_bulk","f_qty","f_alert"].map(l=>document.getElementById(l)),s=["f_cost","f_price","f_fees","f_ship","f_condition"].map(l=>document.getElementById(l)),i=["f_notes","f_book_fields","fImgWrap"].map(l=>document.getElementById(l)),o=l=>{if(l){const d=l.closest(".fgrp")||l.closest(".full")||l;d.style.display=""}},r=l=>{if(l){const d=l.closest(".fgrp")||l.closest(".full")||l;d.style.display="none"}},a=document.querySelector(".profit-prev"),c=document.getElementById("f_dim_section");t==="basic"?(n.forEach(o),s.forEach(r),i.forEach(r),a&&(a.style.display="none"),c&&(c.style.display="none")):t==="pricing"?(n.forEach(r),s.forEach(o),i.forEach(r),a&&(a.style.display=""),c&&(c.style.display="none")):(n.forEach(r),s.forEach(r),i.forEach(o),a&&(a.style.display="none"),c&&(c.style.display=""))}function Dm(){const t=document.getElementById("addOv");t.classList.add("on"),Bi=[],rt("f",Bi);const e=t.querySelector(".modal-bd");e&&(e.scrollTop=0);const n=t.querySelector(".modal");n&&(n.scrollTop=0),setTimeout(()=>Fl("#addOv .modal"),100),Zc("basic",document.querySelector(".add-form-tab"))}function ed(){pr(),document.getElementById("addOv").classList.remove("on"),["f_name","f_sku","f_upc","f_cat","f_subcat_txt","f_cost","f_price","f_fees","f_ship","f_notes","f_alert","f_source","f_condition"].forEach(n=>{const s=document.getElementById(n);s&&(s.value="")}),document.getElementById("f_qty").value="1";const t=document.getElementById("f_bulk");t&&(t.checked=!1);const e=document.getElementById("f_bulk_fields");e&&(e.style.display="none"),document.querySelectorAll("#f_cond_picker .cond-tag").forEach(n=>n.classList.remove("active")),Zh("f"),Tc("f",!1),Bi=[],rt("f",[]),mm("f"),Ds("f_plat_picker",[]),nd()}function td(t){var n;const e=(n=document.getElementById(t+"_bulk"))==null?void 0:n.checked;if(t==="f"){const s=document.getElementById("f_bulk_fields");s&&(s.style.display=e?"block":"none");const i=document.getElementById("f_qty");!e&&i&&(i.value="1")}if(t==="d"){const s=document.getElementById("d_alert_grp");s&&(s.style.display=e?"":"none")}}function nd(){const t=parseFloat(document.getElementById("f_cost").value)||0,e=parseFloat(document.getElementById("f_price").value)||0,n=parseFloat(document.getElementById("f_fees").value)||0,s=parseFloat(document.getElementById("f_ship").value)||0,i=e-t-n-s,o=e?i/e:null,r=t?i/t:null;document.getElementById("pp_profit").textContent=e||t?x(i):"",document.getElementById("pp_margin").textContent=o!=null?V(o):"",document.getElementById("pp_roi").textContent=r!=null?V(r):"",document.getElementById("pp_profit").style.color=i>=0?"var(--good)":"var(--danger)"}function Bm(){const e=[...$].sort((r,a)=>new Date(a.added||0)-new Date(r.added||0))[0];if(!e){k("No items to copy from",!0);return}const n=document.getElementById("f_source");n&&e.source&&(n.value=e.source);const s=document.getElementById("f_cat");s&&e.category&&(s.value=e.category,sd());const i=document.getElementById("f_subcat_txt");i&&e.subcategory&&(i.value=e.subcategory),e.condition&&od("f",e.condition);const o=Y(e);o.length&&Ds("f_plat_picker",o),Hs("f"),k("Prefilled from: "+e.name)}function Om(){var D;const t=document.getElementById("f_name").value.trim();if(!t){k("Name required",!0);return}const e=document.getElementById("f_cost"),n=pe(e.value,{});if(isNaN(n)&&e.value.trim()!==""){Me(e,{fieldName:"Cost"});return}const s=document.getElementById("f_price"),i=pe(s.value,{});if(isNaN(i)&&s.value.trim()!==""){Me(s,{fieldName:"Price"});return}if(!i){k("Price required",!0);return}const o=document.getElementById("f_fees"),r=pe(o.value,{allowZero:!0});if(isNaN(r)&&o.value.trim()!==""){Me(o,{fieldName:"Fees"});return}const a=document.getElementById("f_ship"),c=pe(a.value,{allowZero:!0});if(isNaN(c)&&a.value.trim()!==""){Me(a,{fieldName:"Shipping"});return}const l=document.getElementById("f_qty"),d=pe(l.value,{integer:!0,min:1}),u=((D=document.getElementById("f_bulk"))==null?void 0:D.checked)||!1,p=u?isNaN(d)?1:d:1,h=document.getElementById("f_alert"),f=pe(h.value,{integer:!0,min:1}),g=u?isNaN(f)?2:f:2,m=Hh(document.getElementById("f_cat").value.trim()),v=new Date().toISOString().slice(0,10).replace(/-/g,""),E=(m||"GEN").trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,4).padEnd(3,"X"),w=Math.random().toString(36).slice(2,5).toUpperCase(),S=E+"-"+v+"-"+w,C=(document.getElementById("f_upc").value||"").trim();if(C){const P=$.find(z=>z.upc===C);if(P&&!confirm(`An item with UPC "${C}" already exists:

"${P.name}" (Qty: ${P.qty})

Add as a new item anyway, or cancel to update the existing one?`)){typeof window.openDrawer=="function"&&window.openDrawer(P.id);return}}const B=Ec("f_plat_picker"),L=B[0]||"Other",O=ie(),G=Bi.slice();if($.push({id:O,name:t,sku:document.getElementById("f_sku").value.trim()||S,upc:document.getElementById("f_upc").value.trim()||"",category:m,subcategory:(document.getElementById("f_subcat_txt").value||"").trim(),subtype:document.getElementById("f_subtype").value||"",platform:L,platforms:B,cost:isNaN(n)?0:n,price:i,qty:p,bulk:u,fees:isNaN(r)?0:r,ship:isNaN(c)?0:c,lowAlert:g,notes:document.getElementById("f_notes").value.trim(),source:document.getElementById("f_source").value.trim(),condition:document.getElementById("f_condition").value.trim(),images:G,image:G[0]||null,...Nc("f"),...qs(m)?Pc("f"):{},added:new Date().toISOString()}),R(),ed(),W(),Ns.create(),k("Item added "),G.length&&Pe()&&Ce()){const P=$.find(z=>z.id===O);P&&Promise.all(G.map((z,oe)=>fc(z,O,oe).catch(N=>(console.warn("FlipTrack: upload failed for slot",oe,N.message),z)))).then(z=>{P.images=z,P.image=z[0]||null,R(),window.renderInv&&window.renderInv()})}}function Nr(t,e,n){const s=js[e]||[],i=document.getElementById(t);if(!i)return;const o=t==="d_subcat"?"d_subcat_grp":"f_subcat_grp",r=document.getElementById(o);s.length?(i.innerHTML='<option value=""> None </option>'+s.map(a=>`<option value="${a}" ${a===n?"selected":""}>${a}</option>`).join(""),r&&(r.style.display="")):(i.innerHTML='<option value=""> None </option>',r&&(r.style.display="none"))}function Gs(t,e,n){const s=Ul[e]||[],i=document.getElementById(t);if(!i)return;const o=t==="d_subtype"?"d_subtype_grp":"f_subtype_grp",r=t==="d_subtype"?"d_subtype_lbl":"f_subtype_lbl",a=["Men","Women","Children"].includes(e)?"Clothing Type":"Type",c=document.getElementById(r);c&&(c.textContent=a);const l=document.getElementById(o);s.length?(i.innerHTML='<option value=""> None </option>'+s.map(d=>`<option value="${d}" ${d===n?"selected":""}>${d}</option>`).join(""),l&&(l.style.display="")):(i.innerHTML='<option value=""> None </option>',l&&(l.style.display="none"))}function Am(){const t=document.getElementById("d_cat").value.trim(),e=js[t]||[],n=document.getElementById("d_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join("")),Nr("d_subcat",t,document.getElementById("d_subcat_txt").value),Gs("d_subtype",document.getElementById("d_subcat").value,""),Hs("d")}function Lm(){Gs("d_subtype",document.getElementById("d_subcat").value,"")}function sd(){const t=document.getElementById("f_cat").value.trim(),e=js[t]||[],n=document.getElementById("f_subcat_dl");n&&(n.innerHTML=e.map(s=>`<option value="${s}">`).join("")),Nr("f_subcat",t,document.getElementById("f_subcat_txt").value),Gs("f_subtype",document.getElementById("f_subcat").value,""),Hs("f")}function Rm(){Gs("f_subtype",document.getElementById("f_subcat").value,"")}function Mm(t){xc(t);const e=$.find(m=>m.id===t);if(!e)return;document.getElementById("dName").textContent=e.name,document.getElementById("dSku").textContent=e.sku?`SKU: ${e.sku}`:"No SKU";const{pu:n,m:s,roi:i}=At(e),o=I.filter(m=>m.itemId===t),r=o.reduce((m,v)=>m+(v.qty||0),0),a=o.reduce((m,v)=>m+(v.price||0)*(v.qty||0),0),c=Sr(e.qty,e.lowAlert,e.bulk);document.getElementById("dMets").innerHTML=`
    <div class="d-met"><div class="dm-lbl">In Stock</div><div class="dm-val" style="color:${$c(c)}">${e.qty||0}</div></div>
    <div class="d-met"><div class="dm-lbl">Profit/Unit</div><div class="dm-val" style="color:var(--good)">${x(n)}</div></div>
    <div class="d-met"><div class="dm-lbl">Margin</div><div class="dm-val" style="color:var(--accent)">${V(s)}</div></div>
    <div class="d-met"><div class="dm-lbl">ROI</div><div class="dm-val" style="color:var(--accent3)">${V(i)}</div></div>
    <div class="d-met"><div class="dm-lbl">Units Sold</div><div class="dm-val">${r}</div></div>
    <div class="d-met"><div class="dm-lbl">Total Revenue</div><div class="dm-val">${x(a)}</div></div>`;const l={d_name:"name",d_sku:"sku",d_upc:"upc",d_cat:"category",d_cost:"cost",d_price:"price",d_fees:"fees",d_ship:"ship",d_notes:"notes",d_url:"url",d_alert:"lowAlert",d_source:"source"};for(const[m,v]of Object.entries(l)){const E=document.getElementById(m);E&&(E.value=e[v]||"")}const d=document.getElementById("d_subcat_txt");d&&(d.value=e.subcategory||"");const u=js[e.category||""]||[],p=document.getElementById("d_subcat_dl");p&&(p.innerHTML=u.map(m=>`<option value="${m}">`).join(""));const h=document.getElementById("d_bulk");h&&(h.checked=!!e.bulk,td("d")),Ds("d_plat_picker",Y(e)),id(e),od("d",e.condition||""),Nr("d_subcat",e.category||"",e.subcategory||""),Gs("d_subtype",e.subcategory||"",e.subtype||""),Hs("d"),qs(e.category)&&Xh("d",e),window.renderDrawerImg&&window.renderDrawerImg(e.id),Qc(e),hm("d",e),Ar("d");const f=document.getElementById("d_ship_summary");if(f){const m=[];e.weight&&m.push(`${e.weight} ${e.dimUnit==="cm"?"kg":"lb"}`),e.dimL&&e.dimW&&e.dimH&&m.push(`${e.dimL}${e.dimW}${e.dimH} ${e.dimUnit||"in"}`),f.textContent=m.length?`Package: ${m.join("  ")}`:"Add dimensions above to see package info"}const g=document.getElementById("dHistory");o.length?g.innerHTML=[...o].reverse().map(m=>{const v=(m.price||0)*(m.qty||0)-(e.cost||0)*(m.qty||0)-(m.fees||0)-(m.ship||0);return`<div class="shi"><div><div style="font-size:12px">${x(m.price)}  ${m.qty}</div><div class="shi-d">${ce(m.date)}</div></div><div class="shi-p ${v>=0?"pos":"neg"}">${x(v)}</div></div>`}).join(""):g.innerHTML='<div style="font-size:12px;color:var(--muted);padding:8px 0">No sales for this item yet.</div>',document.getElementById("drawerOv").classList.add("on"),document.getElementById("drawer").classList.add("on"),setTimeout(()=>Fl("#drawer"),100)}function jm(t,e){document.querySelectorAll(".drawer-tab-panel").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".drawer-tab").forEach(n=>n.classList.remove("active")),document.getElementById("dtab-"+t).classList.add("active"),e.classList.add("active")}function Yi(){pr(),document.getElementById("drawerOv").classList.remove("on"),document.getElementById("drawer").classList.remove("on"),document.querySelectorAll(".drawer-tab-panel").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".drawer-tab").forEach(n=>n.classList.remove("active"));const t=document.getElementById("dtab-details");t&&t.classList.add("active");const e=document.querySelector(".drawer-tab");e&&e.classList.add("active"),xc(null)}function id(t){const e=document.getElementById("d_listing_status_wrap"),n=document.getElementById("d_listing_status"),s=Y(t);if(!s.length||s.length<1){e.style.display="none";return}e.style.display="";const i=t.platformStatus||{},o=t.platformListingDates||{};n.innerHTML=s.map(r=>{const a=i[r]||"active",c=Qo[a]||a,l=Dc[a]||"var(--muted)",d=o[r],u=Bc(r,d);let p="";u!==null&&(u<0?p=`<span class="ls-expiry ls-expired">Expired ${Math.abs(u)}d ago</span>`:u<=3?p=`<span class="ls-expiry ls-urgent">${u}d left</span>`:u<=7?p=`<span class="ls-expiry ls-warning">${u}d left</span>`:p=`<span class="ls-expiry">${u}d left</span>`);const h=d?`<span class="ls-date">Listed ${d}</span>`:"",f=a==="expired"||a==="delisted"||a==="sold-elsewhere";return`<div class="ls-badge-enhanced" data-status="${a}" data-plat="${_(r)}">
      <div class="ls-badge-top">
        <span class="ls-dot" style="background:${l}"></span>
        <span class="ls-plat-name">${_(r)}</span>
        <span class="ls-label" style="color:${l}" onclick="toggleListingStatus(this.closest('.ls-badge-enhanced'))">${c}</span>
        ${p}
      </div>
      <div class="ls-badge-bottom">
        ${h}
        <div class="ls-badge-actions">
          ${f?`<button class="btn-xs btn-accent" onclick="clRelistFromDrawer('${t.id}','${_(r)}')">Relist</button>`:""}
          <button class="btn-xs" onclick="clOpenLink('${_(r)}','${t.id}')" title="Open on ${_(r)}"></button>
          <button class="btn-xs" onclick="clCopyListing('${t.id}')" title="Copy listing text"></button>
        </div>
      </div>
    </div>`}).join("")}function Nm(){const t=document.querySelectorAll("#d_listing_status .ls-badge"),e={};return t.forEach(n=>{e[n.getAttribute("data-plat")]=n.getAttribute("data-status")}),e}function zm(){var h;const t=$.find(f=>f.id===yt);if(!t)return;const e=document.getElementById("d_cost"),n=pe(e.value,{});if(isNaN(n)&&e.value.trim()!==""){Me(e,{fieldName:"Cost"});return}const s=document.getElementById("d_price"),i=pe(s.value,{});if(isNaN(i)&&s.value.trim()!==""){Me(s,{fieldName:"Price"});return}const o=document.getElementById("d_fees"),r=pe(o.value,{allowZero:!0});if(isNaN(r)&&o.value.trim()!==""){Me(o,{fieldName:"Fees"});return}const a=document.getElementById("d_ship"),c=pe(a.value,{allowZero:!0});if(isNaN(c)&&a.value.trim()!==""){Me(a,{fieldName:"Shipping"});return}const l=document.getElementById("d_alert"),d=pe(l.value,{integer:!0,min:1}),u=t.price||0;t.name=document.getElementById("d_name").value.trim()||t.name,t.sku=document.getElementById("d_sku").value.trim(),t.upc=document.getElementById("d_upc").value.trim(),t.category=normCat(document.getElementById("d_cat").value.trim()),t.subcategory=(document.getElementById("d_subcat_txt").value||"").trim();const p=document.getElementById("d_subtype");t.subtype=p?p.value||"":t.subtype||"",t.platforms=Ec("d_plat_picker"),t.platform=t.platforms[0]||"Other",t.platformStatus=Nm(),t.cost=isNaN(n)?0:n,t.price=isNaN(i)?0:i,t.fees=isNaN(r)?0:r,t.ship=isNaN(c)?0:c,t.lowAlert=isNaN(d)?2:d,t.bulk=((h=document.getElementById("d_bulk"))==null?void 0:h.checked)||!1,t.url=document.getElementById("d_url").value.trim(),t.source=document.getElementById("d_source").value.trim(),t.condition=document.getElementById("d_condition").value.trim(),t.notes=document.getElementById("d_notes").value.trim(),Object.assign(t,Nc("d")),qs(t.category)&&Object.assign(t,Pc("d")),t.price!==u&&t.price>0&&Cr(t.id,t.price,"manual"),R(),Yi(),W(),Ns.edit(),k("Changes saved ")}async function Um(){const t=$.find(n=>n.id===yt);if(!confirm(`Delete "${t==null?void 0:t.name}"?`))return;const e=yt;Sc(e),R(),Yi(),W(),k("Item deleted  tap Undo to restore",!1,4e3),await Fs("ft_inventory",[e]),autoSync()}function Fm(t,e,n){const s=document.getElementById(t+"_condition"),i=document.getElementById(t+"_cond_picker");s.value===e?(s.value="",n.classList.remove("active")):(s.value=e,i.querySelectorAll(".cond-tag").forEach(o=>o.classList.remove("active")),n.classList.add("active"))}function od(t,e){const n=document.getElementById(t+"_condition"),s=document.getElementById(t+"_cond_picker");!n||!s||(n.value=e||"",s.querySelectorAll(".cond-tag").forEach(i=>{i.classList.toggle("active",i.textContent.trim()===e)}))}const ps=[{days:7,level:"notice",label:"Getting Dusty",color:"var(--muted)",icon:""},{days:14,level:"warning",label:"Needs Attention",color:"var(--warn)",icon:""},{days:30,level:"urgent",label:"Death Pile",color:"var(--danger)",icon:""},{days:60,level:"critical",label:"Buried Treasure",color:"#ff4757",icon:""},{days:90,level:"extreme",label:"Cut Your Losses",color:"#ff0000",icon:""}];function qm(t){for(let e=ps.length-1;e>=0;e--)if(t>=ps[e].days)return ps[e];return null}function Hm(t){const e=Date.now(),n=864e5,s=[];for(const i of $){if((i.qty||0)<=0)continue;const o=i.added?new Date(i.added).getTime():e,r=Math.floor((e-o)/n);if(r<7)continue;const a=Y(i),c=I.some(f=>f.itemId===i.id),l=a.length>0&&Object.values(i.platformStatus||{}).some(f=>f==="active");let d="",u=0,p="";if(a.length===0||!Object.keys(i.platformStatus||{}).length)u=r,d="Never listed on any platform",p="List on 2-3 platforms to get visibility";else if(!l)u=r,d="All listings expired or delisted",p="Relist with updated photos and price";else if(c){const f=I.filter(g=>g.itemId===i.id).sort((g,m)=>new Date(m.date)-new Date(g.date))[0];if(f){const g=Math.floor((e-new Date(f.date).getTime())/n);if(g<30)continue;u=g,d=`Last sale ${u} days ago`,p="Consider bundling or relisting at lower price"}else continue}else{const f=Object.values(i.platformListingDates||{}),g=f.length?Math.min(...f.map(m=>new Date(m).getTime())):o;if(u=Math.floor((e-g)/n),u<14)continue;d=`Listed ${u} days with no sales`,p="Drop price 10-15% or refresh listing with new photos"}const h=qm(u);h&&s.push({item:i,reason:d,daysStale:u,urgency:h,suggestedAction:p,potentialLoss:(i.cost||0)*(i.qty||1)})}return s.sort((i,o)=>o.daysStale-i.daysStale),s}function Qi(){const t=Hm(),e=t.reduce((i,o)=>i+(o.item.price||0)*(o.item.qty||1),0),n=t.reduce((i,o)=>i+o.potentialLoss,0),s={};for(const i of ps)s[i.level]=t.filter(o=>o.urgency.level===i.level).length;return{totalItems:t.length,totalValue:e,totalCost:n,byUrgency:s,items:t}}function Wm(){const t=Qi();if(!t.totalItems)return`<div class="dp-widget dp-empty">
      <div class="dp-icon"></div>
      <div class="dp-msg">No death pile items! Everything is listed and active.</div>
    </div>`;(t.byUrgency.urgent||0)+(t.byUrgency.critical||0)+(t.byUrgency.extreme||0);let e=`<div class="dp-widget">
    <div class="dp-header">
      <span class="dp-title"> Death Pile</span>
      <span class="dp-count">${t.totalItems} items  ${x(t.totalCost)} at risk</span>
    </div>
  `;const n=t.items.slice(0,5);e+='<div class="dp-list">';for(const s of n)e+=`
      <div class="dp-item" onclick="openDrawer('${s.item.id}')">
        <span class="dp-urgency" style="color:${s.urgency.color}">${s.urgency.icon}</span>
        <div class="dp-item-info">
          <div class="dp-item-name">${_((s.item.name||"Item").slice(0,40))}</div>
          <div class="dp-item-reason">${_(s.reason)}</div>
        </div>
        <div class="dp-item-days">${s.daysStale}d</div>
      </div>
    `;return e+="</div>",t.totalItems>5&&(e+=`<div class="dp-more">+ ${t.totalItems-5} more items</div>`),e+="</div>",e}function Gm(){const t=Qi();let e=`<div class="dp-view">
    <div class="dp-view-header">
      <h3>Death Pile Tracker</h3>
      <div class="dp-view-stats">
        <span>${t.totalItems} stale items</span>
        <span></span>
        <span>${x(t.totalValue)} inventory value</span>
        <span></span>
        <span style="color:var(--danger)">${x(t.totalCost)} cost at risk</span>
      </div>
    </div>
  `;if(!t.totalItems)return e+=`<div class="dp-empty-full">
      <div style="font-size:48px;margin-bottom:12px"></div>
      <p>No stale inventory! All your items are actively listed or recently sold.</p>
    </div></div>`,e;for(const n of[...ps].reverse()){const s=t.items.filter(i=>i.urgency.level===n.level);if(s.length){e+=`
      <div class="dp-group">
        <div class="dp-group-header" style="color:${n.color}">
          ${n.icon} ${n.label}  ${s.length} items (${n.days}+ days)
        </div>
        <div class="dp-group-items">
    `;for(const i of s)e+=`
        <div class="dp-row" onclick="openDrawer('${i.item.id}')">
          <div class="dp-row-main">
            <span class="dp-row-name">${_((i.item.name||"Item").slice(0,50))}</span>
            <span class="dp-row-cat">${_(i.item.category||"")}</span>
          </div>
          <div class="dp-row-meta">
            <span>${i.daysStale} days</span>
            <span>${x(i.item.price||0)}</span>
            <span style="color:var(--muted)">${_(i.reason)}</span>
          </div>
          <div class="dp-row-action">${_(i.suggestedAction)}</div>
        </div>
      `;e+="</div></div>"}}return e+="</div>",e}const Vm=800;function Km(t,e){if(!t||!e)return;const n=e.startsWith("$"),s=e.endsWith("%");if(e===""||e==="%")return;const o=e.replace(/[$,%]/g,"").replace(/,/g,""),r=parseFloat(o);if(isNaN(r)||r===0)return;const a=r<0,c=Math.abs(r),l=e.includes(".")&&!e.endsWith("d"),d=performance.now();function u(p){const h=p-d,f=Math.min(h/Vm,1),g=1-Math.pow(1-f,3);let m=c*g,v;if(l){const w=(e.split(".")[1]||"").replace(/[^0-9]/g,"").length;v=m.toFixed(w)}else v=Math.round(m).toString();const E=v.split(".");E[0]=E[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),v=E.join("."),n&&(v="$"+v),a&&(v="-"+v),s&&(v+="%"),e.endsWith("d")&&!s&&(v+="d"),t.textContent=v,f<1?requestAnimationFrame(u):t.textContent=e}t.textContent=n?"$0":s?"0%":"0",requestAnimationFrame(u)}function Jm(){const t=["sInvVal","sRev","sProfit","sROI","sLow","sAvgDays"];for(const e of t){const n=document.getElementById(e);if(!n)continue;const s=n.textContent;s&&s!=="$0"&&s!=="0"&&s!==""&&Km(n,s)}}function Ym(t=365){const e={},n=new Date,s=new Date(n);s.setDate(s.getDate()-t);for(const i of I){const o=(i.date||"").slice(0,10);if(!o||new Date(o)<s)continue;const r=q(i.itemId),a=(i.price||0)*(i.qty||0),c=r?(r.cost||0)*(i.qty||0):0,l=(i.fees||0)+(i.ship||0),d=a-c-l;e[o]=(e[o]||0)+d}for(const i of Q){const o=(i.date||"").slice(0,10);!o||new Date(o)<s||(e[o]=(e[o]||0)-(i.amount||0))}return e}function Qm(t,e){if(t===0||!e)return"var(--border)";const n=Math.min(Math.abs(t)/e,1);if(t>0){const s=["rgba(0,200,136,0.15)","rgba(0,200,136,0.3)","rgba(0,200,136,0.5)","rgba(0,200,136,0.75)","rgba(0,200,136,1)"],i=Math.min(Math.floor(n*5),4);return s[i]}else{const s=["rgba(255,107,53,0.15)","rgba(255,107,53,0.3)","rgba(255,107,53,0.5)","rgba(255,107,53,0.75)","rgba(255,107,53,1)"],i=Math.min(Math.floor(n*5),4);return s[i]}}function Xm(){const t=Ym(365),e=Object.values(t),n=e.length?Math.max(...e.map(Math.abs)):1,s=new Date,i=864e5,o=new Date(s.getFullYear(),s.getMonth(),s.getDate()),r=o.getDay(),a=new Date(o.getTime()-(52*7+r)*i),c=[];let l=-1,d='<div class="heatmap-wrap">';d+='<div class="heatmap-grid">',d+='<div class="heatmap-days">',d+='<div class="hm-day-lbl"></div>',d+='<div class="hm-day-lbl">Mon</div>',d+='<div class="hm-day-lbl"></div>',d+='<div class="hm-day-lbl">Wed</div>',d+='<div class="hm-day-lbl"></div>',d+='<div class="hm-day-lbl">Fri</div>',d+='<div class="hm-day-lbl"></div>',d+="</div>";const u=53;for(let m=0;m<u;m++){d+='<div class="hm-week">';for(let v=0;v<7;v++){const E=new Date(a.getTime()+(m*7+v)*i);if(E>o){d+='<div class="hm-cell empty"></div>';continue}const w=E.toISOString().slice(0,10),S=t[w]||0,C=Qm(S,n),B=`${w}: ${S>=0?"+":""}${x(S)}`,L=E.getMonth();v===0&&L!==l&&(c.push({week:m,label:E.toLocaleString("en-US",{month:"short"})}),l=L),d+=`<div class="hm-cell" style="background:${C}" title="${B}"></div>`}d+="</div>"}d+="</div>",d+='<div class="hm-months">',d+='<div style="width:26px"></div>';let p=0;for(const m of c){const v=(m.week-p)*13;d+=`<span style="margin-left:${v}px">${m.label}</span>`,p=m.week+3}d+="</div>";const h=e.reduce((m,v)=>m+v,0),f=e.filter(m=>m>0).length,g=e.filter(m=>m<0).length;return d+=`<div class="hm-legend">
    <span class="hm-stat">${x(h)} net  ${f} profit days  ${g} loss days</span>
    <div class="hm-scale">
      <span>Less</span>
      <div class="hm-cell" style="background:rgba(255,107,53,0.5)"></div>
      <div class="hm-cell" style="background:rgba(255,107,53,0.2)"></div>
      <div class="hm-cell" style="background:var(--border)"></div>
      <div class="hm-cell" style="background:rgba(0,200,136,0.2)"></div>
      <div class="hm-cell" style="background:rgba(0,200,136,0.5)"></div>
      <div class="hm-cell" style="background:rgba(0,200,136,1)"></div>
      <span>More</span>
    </div>
  </div>`,d+="</div>",d}function Zm(){const t=document.getElementById("profitHeatmap");t&&(t.innerHTML=Xm(),t.style.display="")}const zr={ebay:{name:"eBay File Exchange",ext:"csv",columns:["Action","Title","Subtitle","Category","ConditionID","Price","Quantity","Description","PicURL","ShippingType","ShippingService-1:Option","ShippingService-1:Cost","Format","Duration"],mapper:t=>({Action:"Add",Title:(t.name||"").slice(0,80),Subtitle:"",Category:t.category||"",ConditionID:eg(t.condition),Price:(t.price||0).toFixed(2),Quantity:t.qty||1,Description:t.notes||t.name||"",PicURL:"",ShippingType:"Flat","ShippingService-1:Option":"USPSPriority","ShippingService-1:Cost":(t.ship||5.99).toFixed(2),Format:"FixedPrice",Duration:"GTC"})},poshmark:{name:"Poshmark",ext:"csv",columns:["Title","Description","Department","Category","Subcategory","Brand","Size","Color","Condition","Original Price","Listing Price","Quantity"],mapper:t=>({Title:(t.name||"").slice(0,80),Description:t.notes||t.name||"",Department:"",Category:t.category||"",Subcategory:t.subcategory||"",Brand:"",Size:"",Color:"",Condition:t.condition||"Pre-Owned","Original Price":((t.price||0)*1.3).toFixed(2),"Listing Price":(t.price||0).toFixed(2),Quantity:t.qty||1})},mercari:{name:"Mercari",ext:"csv",columns:["Title","Description","Category","Condition","Price","Shipping Paid By","Shipping Weight"],mapper:t=>({Title:(t.name||"").slice(0,80),Description:t.notes||t.name||"",Category:t.category||"",Condition:t.condition||"Good",Price:(t.price||0).toFixed(2),"Shipping Paid By":"Seller","Shipping Weight":t.weight?t.weight+" oz":""})},depop:{name:"Depop",ext:"csv",columns:["Title","Description","Category","Condition","Price","Quantity","Shipping Cost"],mapper:t=>({Title:(t.name||"").slice(0,80),Description:t.notes||t.name||"",Category:t.category||"",Condition:t.condition||"Used",Price:(t.price||0).toFixed(2),Quantity:t.qty||1,"Shipping Cost":(t.ship||0).toFixed(2)})},generic:{name:"FlipTrack Full Export",ext:"csv",columns:["SKU","Name","Category","Subcategory","Platforms","Condition","Cost","Price","Fees","Shipping","Quantity","Date Added","Notes","UPC"],mapper:t=>({SKU:t.sku||"",Name:t.name||"",Category:t.category||"",Subcategory:t.subcategory||"",Platforms:Y(t).join("; "),Condition:t.condition||"",Cost:(t.cost||0).toFixed(2),Price:(t.price||0).toFixed(2),Fees:(t.fees||0).toFixed(2),Shipping:(t.ship||0).toFixed(2),Quantity:t.qty||0,"Date Added":t.added||"",Notes:t.notes||"",UPC:t.upc||""})},sales_report:{name:"Sales Report",ext:"csv",columns:["Date","Item Name","SKU","Platform","Sale Price","Quantity","Fees","Shipping","Item Cost","Profit"],mapper:null},tax_export:{name:"Tax Summary",ext:"csv",columns:["Category","Description","Date","Amount","Type"],mapper:null}};function eg(t){return{"New with Tags":1e3,New:1e3,Deadstock:1e3,"New without Tags":1500,"Open Box":1500,"Like New":2e3,Refurbished:2500,"Pre-Owned":3e3,Good:3e3,Fair:5e3,Poor:7e3}[t]||3e3}function dl(t){const e=String(t??"");return e.includes(",")||e.includes('"')||e.includes(`
`)?'"'+e.replace(/"/g,'""')+'"':e}function Ur(t,e,n){const s=e.map(dl).join(","),i=n.map(l=>e.map(d=>dl(l[d]??"")).join(",")).join(`
`),o=s+`
`+i,r=new Blob([o],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(r),c=document.createElement("a");c.href=a,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(a)}function tg(t,e){const n=zr[t];if(!n){k("Unknown template",!0);return}let s=[...$].filter(r=>(r.qty||0)>0);if(e&&(s=s.filter(r=>Y(r).some(a=>a.toLowerCase().includes(e.toLowerCase())))),!s.length){k("No matching items to export",!0);return}const i=s.map(n.mapper),o=`fliptrack-${t}-${new Date().toISOString().slice(0,10)}.${n.ext}`;Ur(o,n.columns,i),k(`Exported ${i.length} items  ${n.name} format`)}function ng(){const t=zr.sales_report,e=I.map(n=>{const s=$.find(a=>a.id===n.itemId),i=s?(s.cost||0)*(n.qty||1):0,o=(n.price||0)*(n.qty||1),r=o-i-(n.fees||0)-(n.ship||0);return{Date:n.date||"","Item Name":s?s.name:"Unknown",SKU:s&&s.sku||"",Platform:n.platform||"","Sale Price":o.toFixed(2),Quantity:n.qty||1,Fees:(n.fees||0).toFixed(2),Shipping:(n.ship||0).toFixed(2),"Item Cost":i.toFixed(2),Profit:r.toFixed(2)}});if(!e.length){k("No sales to export",!0);return}Ur(`fliptrack-sales-${new Date().toISOString().slice(0,10)}.csv`,t.columns,e),k(`Exported ${e.length} sales`)}function sg(){const t=zr.tax_export,e=[];for(const n of I){const s=$.find(i=>i.id===n.itemId);e.push({Category:"Revenue",Description:s?s.name:"Sale",Date:n.date||"",Amount:((n.price||0)*(n.qty||1)).toFixed(2),Type:"Income"})}for(const n of Q)e.push({Category:n.category||"Expense",Description:n.desc||"",Date:n.date||"",Amount:(n.amount||0).toFixed(2),Type:"Expense"});if(!e.length){k("No data to export",!0);return}Ur(`fliptrack-tax-${new Date().toISOString().slice(0,10)}.csv`,t.columns,e),k(`Exported ${e.length} tax records`)}function ig(){return`<div class="csv-export-panel">
    <div class="csv-export-title">Export for Platform</div>
    <div class="csv-export-grid">
      ${[{key:"ebay",label:"eBay File Exchange",icon:""},{key:"poshmark",label:"Poshmark",icon:""},{key:"mercari",label:"Mercari",icon:""},{key:"depop",label:"Depop",icon:""}].map(e=>`<button class="csv-btn" onclick="exportPlatformCSV('${e.key}')">
        <span>${e.icon}</span> ${e.label}
      </button>`).join("")}
    </div>
    <div class="csv-export-divider"></div>
    <div class="csv-export-grid">
      <button class="csv-btn csv-btn-secondary" onclick="exportPlatformCSV('generic')"> Full Inventory</button>
      <button class="csv-btn csv-btn-secondary" onclick="exportSalesCSV()"> Sales Report</button>
      <button class="csv-btn csv-btn-secondary" onclick="exportTaxCSV()"> Tax Summary</button>
    </div>
  </div>`}const rd="ft_kpi_goals",og=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function Fr(){try{return JSON.parse(localStorage.getItem(rd)||"{}")}catch{return{}}}function rg(t){localStorage.setItem(rd,JSON.stringify(t))}function Xi(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`}function ad(){const t=Xi(),[e,n]=t.split("-").map(Number),s=new Date(e,n-1,1),i=new Date(e,n,0,23,59,59);let o=0,r=0,a=0,c=0;for(const l of I){const d=new Date(l.date);if(d>=s&&d<=i){const u=q(l.itemId);o+=(l.price||0)*(l.qty||0),r+=u?(u.cost||0)*(l.qty||0):0,a+=(l.fees||0)+(l.ship||0),c+=l.qty||0}}return{rev:o,profit:o-r-a,unitsSold:c,month:og[n-1],year:e}}function ld(){const t=Fr(),e=Xi(),n=t[e]||{},s=ad(),i=n.revenue||0,o=n.profit||0,r=n.sales||0;if(!(i>0||o>0||r>0))return`<div class="kpi-goals-empty">
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px">Set monthly targets to track your progress</div>
      <button class="btn-secondary" onclick="openKPIGoalEditor()" style="font-size:11px;padding:5px 14px"> Set ${s.month} Goals</button>
    </div>`;const c=[];if(i>0){const l=Math.min(1,s.rev/i);c.push({label:"Revenue",current:x(s.rev),goal:x(i),pct:l,color:"var(--accent2)"})}if(o>0){const l=Math.min(1,s.profit/o);c.push({label:"Profit",current:x(s.profit),goal:x(o),pct:l,color:"var(--accent3)"})}if(r>0){const l=Math.min(1,s.unitsSold/r);c.push({label:"Units Sold",current:s.unitsSold,goal:r,pct:l,color:"var(--accent)"})}return`<div class="kpi-goals-wrap">
    <div class="kpi-header">
      <span class="kpi-month">${s.month} ${s.year} Goals</span>
      <button class="kpi-edit-btn" onclick="openKPIGoalEditor()" title="Edit goals"></button>
    </div>
    ${c.map(l=>`<div class="kpi-bar-wrap">
      <div class="kpi-bar-label">
        <span>${l.label}</span>
        <span class="kpi-bar-nums">${l.current} / ${l.goal}</span>
      </div>
      <div class="kpi-bar-track">
        <div class="kpi-bar-fill" style="width:${Math.round(l.pct*100)}%;background:${l.color}"></div>
      </div>
      <div class="kpi-bar-pct" style="color:${l.pct>=1?"#57ff9a":"var(--muted)"}">${l.pct>=1?" Goal reached!":Math.round(l.pct*100)+"%"}</div>
    </div>`).join("")}
  </div>`}function ag(){const t=Fr(),e=Xi(),n=t[e]||{},s=ad(),i=document.createElement("div");i.id="kpiModal",i.className="kpi-modal-overlay",i.innerHTML=`
    <div class="kpi-modal">
      <div class="kpi-modal-title"> Set ${s.month} ${s.year} Goals</div>
      <div class="kpi-field">
        <label>Monthly Revenue Target</label>
        <div class="kpi-input-wrap">
          <span class="kpi-prefix">$</span>
          <input type="number" id="kpiRevGoal" value="${n.revenue||""}" placeholder="e.g. 2000" min="0" step="100">
        </div>
      </div>
      <div class="kpi-field">
        <label>Monthly Profit Target</label>
        <div class="kpi-input-wrap">
          <span class="kpi-prefix">$</span>
          <input type="number" id="kpiProfitGoal" value="${n.profit||""}" placeholder="e.g. 800" min="0" step="50">
        </div>
      </div>
      <div class="kpi-field">
        <label>Units Sold Target</label>
        <input type="number" id="kpiSalesGoal" value="${n.sales||""}" placeholder="e.g. 30" min="0" step="1">
      </div>
      <div class="kpi-modal-actions">
        <button class="btn-secondary" onclick="closeKPIGoalEditor()">Cancel</button>
        <button class="btn-primary" onclick="saveKPIGoals()" style="padding:8px 20px">Save Goals</button>
      </div>
    </div>
  `,document.body.appendChild(i),requestAnimationFrame(()=>i.classList.add("on"))}function cd(){const t=document.getElementById("kpiModal");t&&(t.classList.remove("on"),setTimeout(()=>t.remove(),200))}function lg(){const t=Fr(),e=Xi();t[e]={revenue:parseFloat(document.getElementById("kpiRevGoal").value)||0,profit:parseFloat(document.getElementById("kpiProfitGoal").value)||0,sales:parseInt(document.getElementById("kpiSalesGoal").value)||0},rg(t),cd(),k("Monthly goals saved ");const n=document.getElementById("kpiGoalsSection");n&&(n.innerHTML=ld())}function cg(){const t=$.reduce((f,g)=>f+(g.price||0)*(g.qty||0),0),e=$.reduce((f,g)=>f+(g.qty||0),0),n=$.filter(f=>f.bulk&&f.qty>0&&f.qty<=(f.lowAlert||2)),s=$.filter(f=>f.qty===0);let i=0,o=0,r=0;for(const f of I){const g=q(f.itemId);i+=(f.price||0)*(f.qty||0),o+=g?(g.cost||0)*(f.qty||0):0,r+=(f.fees||0)+(f.ship||0)}const a=i-o-r,c=o?a/o:null,l=i?a/i:null;document.getElementById("sInvVal").textContent=x(t),document.getElementById("sInvCnt").textContent=e+" units in stock",document.getElementById("sRev").textContent=x(i),document.getElementById("sRevCnt").textContent=I.length+" sales",document.getElementById("sProfit").textContent=x(a),document.getElementById("sMargin").textContent=l!=null?"avg margin "+V(l):"avg margin ",document.getElementById("sROI").textContent=c!=null?V(c):"",document.getElementById("sCOGS").textContent=x(o)+" cost basis",document.getElementById("sLow").textContent=n.length,document.getElementById("sOut").textContent=s.length+" out of stock";const d=[];for(const f of $){if(!f.added)continue;const g=I.filter(w=>w.itemId===f.id);if(!g.length)continue;const m=new Date(Math.min(...g.map(w=>new Date(w.date)))),v=new Date(f.added),E=Math.max(0,Math.floor((m-v)/864e5));d.push(E)}const u=d.length?Math.round(d.reduce((f,g)=>f+g,0)/d.length):null;document.getElementById("sAvgDays").textContent=u!==null?u+"d":"",document.getElementById("sAvgDaysSub").textContent=d.length?`based on ${d.length} sold items`:"no sales data yet";const p=[...s,...n.filter(f=>!s.includes(f))],h=document.getElementById("alertBanner");p.length?(document.getElementById("alertItems").textContent=p.map(f=>`${f.name} (${f.qty} left)`).join("  "),h.classList.add("on")):h.classList.remove("on"),requestAnimationFrame(()=>Jm())}function dg(){const t={};for(const o of I){const r=q(o.itemId),a=r?Y(r):["Other"],c=(o.price||0)*(o.qty||0);a.forEach(l=>{t[l]=(t[l]||0)+c/a.length})}const e=Object.values(t).reduce((o,r)=>o+r,0),n=Object.entries(t).sort((o,r)=>r[1]-o[1]),s={eBay:"#ff6b35",Amazon:"#ffb800",Etsy:"#7b61ff","Facebook Marketplace":"#57ff9a",Depop:"#ff4757",Poshmark:"#e63950",Mercari:"#3cb371",Grailed:"#57c8ff",StockX:"#00bcff",GOAT:"#57c8ff",Vinted:"#09b66d",Tradesy:"#ff69b4","The RealReal":"#b4b4b4","Vestiaire Collective":"#d4af37",Reverb:"#0096ff",Discogs:"#ffa500",Craigslist:"#6495ed",OfferUp:"#50c878",Nextdoor:"#00ac4f",Whatnot:"#9b59b6","TikTok Shop":"#ff0050",Instagram:"#e4405f",Shopify:"#95bf47","Walmart Marketplace":"#0071ce",Newegg:"#ff5a00",Bonanza:"#ffc800","Ruby Lane":"#ffc800",Chairish:"#8b5a2b","1stDibs":"#b4946f",Swappa:"#00aeef",Decluttr:"#ff8c00",Other:"#57c8ff"},i=document.getElementById("platBreakdown");if(!n.length){i.innerHTML=`<div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">Record your first sale to see revenue breakdown by platform</div><button class="empty-state-cta" onclick="switchView('sales',document.querySelectorAll('.nav-tab')[2])">Go to Sales </button></div>`;return}i.innerHTML=n.map(([o,r])=>`
    <div class="plat-row">
      <span class="plat-name">${o}</span>
      <div class="plat-bw"><div class="plat-bar"><div class="plat-fill" style="width:${e?r/e*100:0}%;background:${s[o]||"#57c8ff"}"></div></div></div>
      <span class="plat-val">${x(r)}</span>
    </div>`).join("")}function ug(){document.getElementById("saleCnt").textContent=I.length+" total";const t=document.getElementById("salesLog");if(!I.length){t.innerHTML='<div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-text">No sales recorded yet. Sell an item and log it here!</div><button class="empty-state-cta" onclick="openSoldModal()">Record a Sale </button></div>';return}const e=["#57c8ff","#ff6b35","#7b61ff","#57ff9a","#ffb800"];t.innerHTML=[...I].reverse().slice(0,8).map((n,s)=>{const i=$.find(a=>a.id===n.itemId),o=i?i.name:"Unknown",r=(n.price||0)*(n.qty||0)-(i?(i.cost||0)*(n.qty||0):0)-(n.fees||0)-(n.ship||0);return`<div class="sale-item">
      <div class="sale-dot" style="background:${e[s%5]}"></div>
      <div class="sale-info"><div class="sale-name">${o}</div><div class="sale-time">${ce(n.date)}  profit ${x(r)}</div></div>
      <div class="sale-amt">${x((n.price||0)*(n.qty||0))}</div>
    </div>`}).join("")}function pg(){const t=document.getElementById("deathPileSection");if(!t)return;const e=Qi();if(!e.totalItems){t.style.display="none";return}const n=e.items.slice(0,6),s=e.totalItems-n.length;t.style.display="",t.innerHTML=`<div class="death-pile-wrap">
    <div class="death-pile-hdr">
      <div class="death-pile-title"> Death Pile <span style="font-family:'DM Mono',monospace;font-weight:400;font-size:10px;opacity:0.7">${e.totalItems} stale item${e.totalItems>1?"s":""}  ${x(e.totalCost)} at risk</span></div>
      <button style="background:none;border:1px solid rgba(123,97,255,0.3);color:var(--accent3);font-size:10px;padding:3px 10px;cursor:pointer;font-family:'DM Mono',monospace" onclick="document.getElementById('deathPileSection').style.display='none'">Dismiss</button>
    </div>
    ${n.map(i=>`<div class="death-pile-item">
      <div style="font-size:16px;margin-right:4px">${i.urgency.icon}</div>
      <div class="dp-info">
        <div class="dp-name" onclick="openDrawer('${i.item.id}')">${_(i.item.name)}</div>
        <div class="dp-meta">${_(i.reason)}  ${_(i.suggestedAction)}</div>
      </div>
      <div class="dp-age" style="color:${i.urgency.color}">${i.daysStale}d</div>
      <button class="dp-list-btn" onclick="openDrawer('${i.item.id}')">Fix </button>
    </div>`).join("")}
    ${s>0?`<div style="font-size:10px;color:var(--muted);margin-top:6px;font-family:'DM Mono',monospace">+ ${s} more stale items</div>`:""}
  </div>`}function fg(){const t=document.getElementById("priceAlerts");if(!t)return;const e=new Date,n=864e5,s=$.filter(a=>{if((a.qty||0)<=0||I.some(u=>u.itemId===a.id))return!1;const l=new Date(a.added||e);return Math.floor((e-l)/n)>=14}).map(a=>{const c=new Date(a.added||e),l=Math.floor((e-c)/n),d=l>=90?3:l>=60?2:l>=30?1:0,u=d>=3?.25:d>=2?.2:d>=1?.15:.1,p=Math.round((a.price||0)*(1-u)*100)/100;return{item:a,days:l,tier:d,dropPct:u,suggested:p}}).sort((a,c)=>c.days-a.days);if(!s.length){t.style.display="none";return}const i=s.slice(0,5),o=s.length-i.length,r=a=>a>=90?" 90+d":a>=60?" 60+d":a>=30?" 30+d":" 14+d";t.style.display="",t.innerHTML=`<div class="price-alerts-wrap">
    <div class="price-alerts-hdr">
      <div class="price-alerts-title"> Price Drop Suggestions <span style="font-family:'DM Mono',monospace;font-weight:400;font-size:10px;opacity:0.7">${s.length} item${s.length>1?"s":""} not moving</span></div>
      <button class="price-alerts-dismiss" onclick="document.getElementById('priceAlerts').style.display='none'">Dismiss</button>
    </div>
    ${i.map(a=>`<div class="price-alert-item">
      <div class="price-alert-info">
        <div class="price-alert-name" onclick="openDrawer('${a.item.id}')">${_(a.item.name)}</div>
        <div class="price-alert-meta">${r(a.days)}  listed ${a.days}d  ${x(a.item.price)} current</div>
      </div>
      <div class="price-alert-action">
        <div class="price-alert-suggest">${x(a.suggested)}</div>
        <button class="price-alert-btn" onclick="quickReprice('${a.item.id}',${a.suggested})">Apply ${Math.round(a.dropPct*100)}% off</button>
      </div>
    </div>`).join("")}
    ${o>0?`<div style="font-size:10px;color:var(--muted);margin-top:6px;font-family:'DM Mono',monospace">+ ${o} more stale items  check Insights for full list</div>`:""}
  </div>`}function hg(t,e){const n=$.find(i=>i.id===t);if(!n)return;const s=n.price;n.price=e,R(),W(),k(`${n.name} repriced: ${x(s)}  ${x(e)} `)}function dd(){cg(),dg(),ug(),fg(),pg(),Zm();const t=document.getElementById("csvExportSection");t&&(t.innerHTML=ig());const e=document.getElementById("kpiGoalsSection");e&&(e.innerHTML=ld());const n=document.getElementById("fsTotalItems");n&&(n.textContent=$.length);const s=[...$].sort((o,r)=>new Date(r.added)-new Date(o.added)).slice(0,6),i=document.getElementById("dashBody");if(!s.length){i.innerHTML='<tr><td colspan="4" style="padding:20px;color:var(--muted);font-size:12px;text-align:center">No items yet.</td></tr>';return}i.innerHTML=s.map(o=>{const{m:r}=At(o),a=Sr(o.qty,o.lowAlert,o.bulk);return`<tr onclick="openDrawer('${o.id}')" style="cursor:pointer">
      <td><div class="item-name">${_(o.name)}</div><div class="item-meta"><span class="item-sku">${_(o.sku||"")}</span>${o.upc?`<span class="upc-tag">${_(o.upc)}</span>`:""}${o.category?`<span class="cat-tag">${_(o.category)}</span>`:""} ${o.subcategory?`<span class="cat-tag" style="background:rgba(87,200,255,0.1);color:var(--accent)">${_(o.subcategory)}</span>`:""} ${o.subtype?`<span class="cat-tag" style="background:rgba(123,97,255,0.15);color:var(--accent3)">${_(o.subtype)}</span>`:""}</div></td>
      <td>${kr(o)}</td>
      <td><span style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:${$c(a)}">${o.qty||0}</span></td>
      <td><span class="margin-badge ${Yt(r)}">${V(r)}</span></td>
    </tr>`}).join("")}function Vn(t,e){if(!t)return;const{page:n,totalItems:s,pageSize:i,onPage:o,pageSizes:r,onPageSize:a}=e,c=Math.max(1,Math.ceil(s/i));if(s<=i){t.innerHTML="";return}const l=Math.max(0,Math.min(n,c-1)),d=l*i+1,u=Math.min((l+1)*i,s),p=document.createElement("div");p.className="ft-pagination",p.style.cssText="display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 0;font-size:12px;color:var(--muted)";const h=(g,m,v)=>{const E=document.createElement("button");return E.className="btn-secondary pg-btn",E.style.cssText='padding:5px 12px;font-size:11px;font-family:"DM Mono",monospace',E.textContent=g,E.disabled=v,v&&(E.style.opacity="0.3"),v||E.addEventListener("click",()=>o(m)),E};p.appendChild(h("",0,l===0)),p.appendChild(h(" Prev",l-1,l===0));const f=document.createElement("span");if(f.style.cssText="font-family:'Syne',sans-serif;font-weight:600;padding:0 4px",f.textContent=`${d}${u} of ${s}`,p.appendChild(f),p.appendChild(h("Next ",l+1,l>=c-1)),p.appendChild(h("",c-1,l>=c-1)),r&&r.length>1&&a){const g=document.createElement("select");g.style.cssText="background:var(--surface);border:1px solid var(--border);color:var(--muted);padding:4px 8px;font-family:'DM Mono',monospace;font-size:11px;margin-left:8px",r.forEach(m=>{const v=document.createElement("option");v.value=m,v.textContent=`${m}/page`,m===i&&(v.selected=!0),g.appendChild(v)}),g.addEventListener("change",()=>a(parseInt(g.value))),p.appendChild(g)}t.innerHTML="",t.appendChild(p)}let ls=null,Ie="all",lt="all",fs="all",Ee=0,ss=50,ul=null;function ud(){const t=document.getElementById("activeFiltersBadge"),e=document.getElementById("filterToggleBtn");if(!t)return;const n=Re.size+_e.size+(Ie!=="all"?1:0)+(lt!=="all"?1:0);n?(t.textContent=n+" active",t.style.display="inline",e.classList.add("active")):(t.style.display="none",e.classList.remove("active"))}function mg(){const t=document.getElementById("filterPanel");t&&t.classList.toggle("open")}function pd(t){var p,h;const e=$.length+":"+(((p=$[0])==null?void 0:p.id)||"")+":"+(((h=$[$.length-1])==null?void 0:h.id)||"");if(!t&&ul===e){gg();return}ul=e;const n=new Set($.flatMap(f=>Y(f)).filter(Boolean));let s=`<span class="filter-chip ${Re.size===0?"active":""}" role="button" tabindex="0" onclick="setPlatFilt('all',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">All</span>`;jl.forEach(f=>{s+=`<span class="plat-group-divider">${f.label}</span>`,f.items.forEach(g=>{const m=n.has(g)?'<span class="plat-dot"></span>':"";s+=`<span class="filter-chip plat-chip ${Re.has(g)?"active":""}" role="button" tabindex="0" onclick="setPlatFilt('${g}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${m}${g}</span>`})}),document.getElementById("platChips").innerHTML=s;const i=new Map;$.forEach(f=>{const g=(f.category||"").trim();if(g){const m=g.toLowerCase();i.has(m)||i.set(m,g)}});const o=["all",...[...i.values()].sort()],r=document.getElementById("catChips");r.innerHTML=o.map(f=>{const g=f.replace(/'/g,"\\'");return`<span class="filter-chip cat-chip ${(f==="all"?_e.size===0:[..._e].some(v=>v.toLowerCase()===f.toLowerCase()))?"active":""}" role="button" tabindex="0" onclick="setCatFilt('${g}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${f==="all"?"All Categories":f}</span>`}).join(""),document.getElementById("catToolbar").style.display=o.length>1?"flex":"none";const a=document.getElementById("subcatToolbar"),c=_e.size===1?[..._e][0]:null,l=c?js[c]:null;if(l){const f=c.toLowerCase(),g=[...new Set($.filter(v=>(v.category||"").toLowerCase()===f).map(v=>v.subcategory||"").filter(Boolean))],m=[...new Set([...l,...g])];document.getElementById("subcatChips").innerHTML=["all",...m].map(v=>{const E=v.replace(/'/g,"\\'");return`<span class="filter-chip subcat-chip ${Ie===v?"active":""}" role="button" tabindex="0" onclick="setSubcatFilt('${E}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${v==="all"?"All":v}</span>`}).join(""),a.style.display="flex"}else a.style.display="none",Ie="all";const d=Ul[Ie],u=document.getElementById("subsubcatToolbar");if(d&&d.length&&Ie!=="all"){const f=[...new Set($.filter(m=>m.subcategory===Ie).map(m=>m.subtype||"").filter(Boolean))],g=[...new Set([...d,...f])];document.getElementById("subsubcatLabel").textContent=["Men","Women","Children"].includes(Ie)?" Clothing Type":` ${Ie}`,document.getElementById("subsubcatChips").innerHTML=["all",...g].map(m=>{const v=m.replace(/'/g,"\\'");return`<span class="filter-chip subsubcat-chip ${lt===m?"active":""}" role="button" tabindex="0" onclick="setSubsubcatFilt('${v}',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}">${m==="all"?"All":m}</span>`}).join(""),u.style.display="flex"}else u.style.display="none",lt="all";ud()}function gg(){document.querySelectorAll("#platChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All"?Re.size===0:Re.has(e))}),document.querySelectorAll("#catChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All Categories"?_e.size===0:[..._e].some(n=>n.toLowerCase()===e.toLowerCase()))}),document.querySelectorAll("#subcatChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All"?Ie==="all":Ie===e)}),document.querySelectorAll("#subsubcatChips .filter-chip").forEach(t=>{const e=t.textContent.trim();t.classList.toggle("active",e==="All"?lt==="all":lt===e)}),ud()}function yg(t,e){Ee=0,t==="all"?Re.clear():Re.has(t)?Re.delete(t):Re.add(t),$e()}function vg(t,e){Ee=0,t==="all"?_e.clear():_e.has(t)?_e.delete(t):_e.add(t),Ie="all",lt="all",$e()}function bg(t,e){Ee=0,Ie=t,lt="all",document.querySelectorAll("#subcatChips .subcat-chip").forEach(n=>n.classList.remove("active")),e&&e.classList.add("active"),$e()}function wg(t){Ee=0,fs=t,$e()}function xg(){fs="all",$e()}function _g(t,e){Ee=0,lt=t,document.querySelectorAll("#subsubcatChips .subsubcat-chip").forEach(n=>n.classList.remove("active")),e&&e.classList.add("active"),$e()}function Sg(t){document.getElementById("sortSel").value=t,$e()}function kg(t){const e=document.getElementById("sortSel").value;return[...t].sort((n,s)=>e==="added-desc"?new Date(s.added)-new Date(n.added):e==="added-asc"?new Date(n.added)-new Date(s.added):e==="name-asc"?n.name.localeCompare(s.name):e==="margin-desc"?At(s).m-At(n).m:e==="qty-asc"?(n.qty||0)-(s.qty||0):e==="price-desc"?(s.price||0)-(n.price||0):e==="cost"?(n.cost||0)-(s.cost||0):e==="platform"?(Y(n)[0]||"").localeCompare(Y(s)[0]||""):0)}function $e(){pd();const t=(document.getElementById("invSearch").value||"").toLowerCase();let e=$.filter(d=>{const u=!t||d.name.toLowerCase().includes(t)||(d.sku||"").toLowerCase().includes(t)||(d.category||"").toLowerCase().includes(t)||(d.subcategory||"").toLowerCase().includes(t)||(d.subtype||"").toLowerCase().includes(t)||(d.upc||"").toLowerCase().includes(t),p=Re.size===0||Y(d).some(E=>Re.has(E)),h=(d.category||"").toLowerCase(),f=_e.size===0||[..._e].some(E=>E.toLowerCase()===h),g=Ie==="all"||(d.subcategory||"")===Ie,m=lt==="all"||(d.subtype||"")===lt,v=fs==="all"||fs==="low"&&(d.qty===0||d.bulk&&d.qty<=(d.lowAlert||2));return u&&p&&f&&g&&m&&v});const n=document.getElementById("stockFilterBanner");if(fs!=="all"){const d=$.filter(p=>p.bulk&&p.qty>0&&p.qty<=(p.lowAlert||2)).length,u=$.filter(p=>p.qty===0).length;document.getElementById("stockFilterLabel").textContent=`Showing low stock (${d}) and out of stock (${u}) items only`,n.style.display="flex"}else n.style.display="none";e=kg(e),document.getElementById("invCnt").textContent=`${e.length} of ${$.length} items`;const s=document.getElementById("invBody"),i=document.getElementById("invEmpty");if(!e.length){s.innerHTML="",i.style.display="block",Oi();return}i.style.display="none";const o=e.length,r=Math.max(1,Math.ceil(o/ss));Ee>=r&&(Ee=r-1),Ee<0&&(Ee=0);const a=e.slice(Ee*ss,(Ee+1)*ss),c=Math.max(...$.map(d=>d.qty||0),1);s.innerHTML=a.map(d=>{const{cost:u,price:p,m:h}=At(d),f=Sr(d.qty,d.lowAlert,d.bulk),g=Math.min(100,(d.qty||0)/c*100),m=fe.has(d.id);return`<tr data-id="${d.id}" class="${m?"sel":""}">
      <td class="cb-col"><input type="checkbox" ${m?"checked":""} onchange="toggleSel('${d.id}',this)"></td>
      <td><span class="drag-handle" draggable="true" ondragstart="dStart(event,'${d.id}')" ondragover="dOver(event)" ondrop="dDrop(event,'${d.id}')"></span></td>
      <td>${at(d)[0]?`<img class="item-thumb" loading="lazy" src="${at(d)[0]}" alt="${_(d.name)}" onclick="openLightbox('${d.id}')">`:`<div class="item-thumb-placeholder" title="Add photo" onclick="openDrawer('${d.id}')"></div>`}</td>
      <td>
        <div class="item-name" onclick="openDrawer('${d.id}')">${_(d.name)}</div>
        <div class="item-meta"><span class="item-sku">${_(d.sku||"")}</span>${d.upc?`<span class="upc-tag">${_(d.upc)}</span>`:""}${d.category?`<span class="cat-tag">${_(d.category)}</span>`:""} ${d.subcategory?`<span class="cat-tag" style="background:rgba(87,200,255,0.1);color:var(--accent)">${_(d.subcategory)}</span>`:""} ${d.subtype?`<span class="cat-tag" style="background:rgba(123,97,255,0.15);color:var(--accent3)">${_(d.subtype)}</span>`:""} ${d.condition?`<span class="cat-tag" style="background:rgba(87,255,154,0.08);color:var(--good)">${_(d.condition)}</span>`:""} ${d.source?`<span class="cat-tag" style="background:rgba(255,107,53,0.1);color:var(--accent2)">${_(d.source)}</span>`:""}${d.author?`<span class="book-meta-tag"> ${_(d.author)}</span>`:""}${d.edition?`<span class="book-meta-tag">${_(d.edition)} ed.</span>`:""}${d.signed?'<span class="book-meta-tag" style="background:rgba(255,215,0,0.15);color:#d4a017;border-color:rgba(255,215,0,0.3)"> Signed</span>':""}</div>
      </td>
      <td>${kr(d)}</td>
      <td>
        <div class="stock-cell">
          <div class="stepper">
            <button class="stepper-btn" aria-label="Decrease quantity" onclick="adjStock('${d.id}',-1)"></button>
            <span class="stepper-val sv-${f}" title="${f==="low"?"Low stock":f==="warn"?"Warning":"In stock"}">${d.qty||0}${f==="low"?" ":f==="warn"?" ":""}</span>
            <button class="stepper-btn" aria-label="Increase quantity" onclick="adjStock('${d.id}',+1)">+</button>
          </div>
          <div class="mini-bar"><div class="mb-fill mf-${f}" style="width:${g}%"></div></div>
        </div>
      </td>
      <td style="color:var(--muted)">${x(u)}</td>
      <td><span class="price-disp" title="Click to edit inline" onclick="startPriceEdit(this,'${d.id}')">${x(p)}</span></td>
      <td><span class="margin-badge ${Yt(h)}">${V(h)}</span></td>
      <td><div class="td-acts">
        ${d.qty>0?`<button class="act-btn" onclick="openSoldModal('${d.id}')">Sold </button>`:'<span class="out-badge">Out</span>'}
        <button class="act-btn" onclick="openDrawer('${d.id}')">Edit</button>
        <button class="act-btn red" onclick="delItem('${d.id}')"></button>
      </div></td>
    </tr>`}).join(""),Oi();const l=document.getElementById("invPagination");l&&Vn(l,{page:Ee,totalItems:o,pageSize:ss,onPage:d=>{Ee=d,$e()},pageSizes:[50,100,250],onPageSize:d=>{ss=d,Ee=0,$e()}})}function $g(t,e){const n=$.find(o=>o.id===e);if(!n)return;const s=document.createElement("input");s.className="price-inp",s.type="number",s.step="0.01",s.value=n.price||0,t.replaceWith(s),s.focus(),s.select();const i=()=>{const o=parseFloat(s.value);!isNaN(o)&&o>=0?(n.price=o,R(),W(),k("Price updated ")):$e()};s.addEventListener("blur",i),s.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),s.blur()),o.key==="Escape"&&(s.removeEventListener("blur",i),$e())})}function Eg(t,e){const n=$.find(s=>s.id===t);n&&(n.qty=Math.max(0,(n.qty||0)+e),R(),W(),n.qty===0?k(" Out of stock!",!0):n.bulk&&n.qty<=(n.lowAlert||2)&&k(` Low: ${n.qty} left`,!0))}function Ig(t,e){ls=$.findIndex(n=>n.id===e),t.dataTransfer.effectAllowed="move"}function Tg(t){var e;t.preventDefault(),t.dataTransfer.dropEffect="move",document.querySelectorAll("#invBody tr").forEach(n=>n.classList.remove("drag-over")),(e=t.currentTarget.closest("tr"))==null||e.classList.add("drag-over")}function Cg(t,e){if(t.preventDefault(),document.querySelectorAll("#invBody tr").forEach(i=>i.classList.remove("drag-over")),ls===null)return;const n=$.findIndex(i=>i.id===e);if(ls===n)return;const[s]=$.splice(ls,1);$.splice(n,0,s),ls=null,R(),$e()}function Pg(t,e){e.checked?fe.add(t):fe.delete(t),e.closest("tr").classList.toggle("sel",e.checked),Oi();const n=document.querySelectorAll("#invBody input[type=checkbox]");document.getElementById("selAll").checked=n.length&&[...n].every(s=>s.checked)}function Dg(t){document.querySelectorAll("#invBody tr[data-id]").forEach(e=>{const n=e.dataset.id,s=e.querySelector("input[type=checkbox]");t.checked?(fe.add(n),s.checked=!0,e.classList.add("sel")):(fe.delete(n),s.checked=!1,e.classList.remove("sel"))}),Oi()}function Bg(){fe.clear(),document.getElementById("selAll").checked=!1,$e()}function Oi(){document.getElementById("bulkBar").classList.toggle("on",fe.size>0),document.getElementById("bulkCnt").textContent=fe.size+" selected"}async function Og(){if(!fe.size||!confirm(`Delete ${fe.size} item(s)?`))return;const t=[...fe];t.forEach(e=>Sc(e)),fe.clear(),R(),W(),k(t.length+" item(s) deleted  check  to restore"),await Fs("ft_inventory",t),Hn()}function Ag(){if(!fe.size)return;const t=[...fe].filter(n=>{const s=q(n);return s&&s.qty>0});if(!t.length){k("No sellable items selected",!0);return}if(!confirm(`Record sale for ${t.length} item(s) at list price?`))return;const e=new Date().toISOString().split("T")[0];for(const n of t){const s=q(n);I.push({id:ie(),itemId:n,price:s.price,listPrice:s.price||0,qty:1,fees:s.fees||0,ship:s.ship||0,date:e}),s.qty=Math.max(0,(s.qty||0)-1)}fe.clear(),R(),W(),k(`${t.length} sale(s) recorded `)}let ze=[],fd="",nr="spent",Pn=0;const Co=50;let sr=null;async function Lg(){const t=await we("buyers");ze=t?JSON.parse(t):[]}function qr(){te("buyers",JSON.stringify(ze)).catch(()=>{})}function Rg(t){return ze.find(e=>e.id===t)}function Mg(){const t=document.getElementById("buyer_name"),e=document.getElementById("buyer_email"),n=document.getElementById("buyer_phone"),s=document.getElementById("buyer_ebay"),i=document.getElementById("buyer_posh"),o=document.getElementById("buyer_merc"),r=document.getElementById("buyer_notes"),a=(t.value||"").trim();if(!a){k("Name required",!0);return}const c={id:ie(),name:a,handles:{eBay:(s.value||"").trim(),Poshmark:(i.value||"").trim(),Mercari:(o.value||"").trim()},email:(e.value||"").trim(),phone:(n.value||"").trim(),notes:(r.value||"").trim(),createdAt:Date.now()};ze.push(c),qr(),k(`${_(a)} added`),t.value="",e.value="",n.value="",s.value="",i.value="",o.value="",r.value="",Lt()}function jg(t){const e=Rg(t);if(!e||!confirm(`Delete ${_(e.name)}?`))return;const n=ze.indexOf(e);ze.splice(n,1),qr(),k(`${_(e.name)} deleted`),Lt()}function Ng(t){sr=sr===t?null:t,Lt()}function zg(t){fd=(t||"").toLowerCase(),Pn=0,Lt()}function Ug(t){nr=t,Pn=0,Lt()}function Fg(t,e){if(!t)return null;const n=t.toLowerCase().trim();let s=ze.find(i=>i.name.toLowerCase()===n||Object.values(i.handles||{}).some(o=>o&&o.toLowerCase()===n));return s||(s={id:ie(),name:t.trim(),handles:{[e]:t.trim()},email:"",phone:"",notes:"",createdAt:Date.now()},ze.push(s),qr()),s}function qg(t,e){const n=I.find(s=>s.id===e);n&&(n.buyerId=t,R(),k("Sale linked to buyer"))}function Lt(){const t=document.getElementById("buyersView");if(!t)return;const e=ze.length,n=ze.filter(l=>I.filter(u=>u.buyerId===l.id).length>1).length,s=ze.reduce((l,d)=>{const u=I.filter(p=>p.buyerId===d.id).reduce((p,h)=>p+(h.price||0),0);return l+u},0),i=I.length?s/I.length:0,o=ze.filter(l=>{const d=fd;return d?l.name.toLowerCase().includes(d)||l.email.toLowerCase().includes(d)||l.phone.includes(d)||Object.values(l.handles).some(u=>u.toLowerCase().includes(d)):!0});o.sort((l,d)=>{if(nr==="name")return l.name.localeCompare(d.name);if(nr==="recent")return d.createdAt-l.createdAt;const u=I.filter(h=>h.buyerId===l.id).reduce((h,f)=>h+(f.price||0),0);return I.filter(h=>h.buyerId===d.id).reduce((h,f)=>h+(f.price||0),0)-u});const r=o.slice(Pn*Co,(Pn+1)*Co);let a=`
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Buyer CRM</div>
      </div>

      <!-- Stats Strip -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;padding:12px;background:var(--surface2);border-bottom:1px solid var(--border)">
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Total Buyers</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent);margin-top:4px">${e}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Repeat</div>
          <div style="font-size:24px;font-weight:700;color:var(--accent2);margin-top:4px">${n}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Total Spent</div>
          <div style="font-size:18px;font-weight:700;color:var(--good);margin-top:4px">${x(s)}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Avg Order</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent3);margin-top:4px">${x(i)}</div>
        </div>
      </div>

      <!-- Add Buyer Form -->
      <div style="padding:12px;background:var(--surface);border-bottom:1px solid var(--border)">
        <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:8px">Add Buyer</div>
        <div class="form-grid">
          <input id="buyer_name" placeholder="Full Name" class="fgrp" style="grid-column:1/-1">
          <input id="buyer_email" type="email" placeholder="Email" class="fgrp">
          <input id="buyer_phone" placeholder="Phone" class="fgrp">
          <input id="buyer_ebay" placeholder="eBay Handle" class="fgrp" style="grid-column:1/-1">
          <input id="buyer_posh" placeholder="Poshmark Handle" class="fgrp" style="grid-column:1/-1">
          <input id="buyer_merc" placeholder="Mercari Handle" class="fgrp" style="grid-column:1/-1">
          <textarea id="buyer_notes" placeholder="Notes" class="fgrp" style="grid-column:1/-1;height:60px;resize:none"></textarea>
          <button onclick="buyerAdd()" class="btn-primary" style="grid-column:1/-1;height:36px">Add</button>
        </div>
      </div>

      <!-- Search & Sort -->
      <div style="padding:12px;display:flex;gap:8px;border-bottom:1px solid var(--border)">
        <input
          type="search"
          placeholder="Search buyers..."
          class="fgrp"
          style="flex:1"
          onchange="buyerSetSearch(this.value)"
          oninput="buyerSetSearch(this.value)"
        >
        <select class="fgrp" style="width:120px" onchange="buyerSetSort(this.value)">
          <option value="spent">By Spent</option>
          <option value="recent">By Recent</option>
          <option value="name">By Name</option>
        </select>
      </div>

      <!-- Buyers List -->
      <div style="padding:12px">
        ${r.length===0?'<div class="empty-state">No buyers yet</div>':r.map(l=>{const d=I.filter(g=>g.buyerId===l.id).reduce((g,m)=>g+(m.price||0),0),u=I.filter(g=>g.buyerId===l.id).length,p=I.filter(g=>g.buyerId===l.id).sort((g,m)=>(m.date||0)-(g.date||0))[0],h=sr===l.id,f=I.filter(g=>g.buyerId===l.id).sort((g,m)=>(m.date||0)-(g.date||0));return`
                <div style="border:1px solid var(--border);border-radius:4px;margin-bottom:8px;overflow:hidden">
                  <!-- Header -->
                  <div
                    style="padding:12px;background:var(--surface2);cursor:pointer;display:flex;justify-content:space-between;align-items:center"
                    onclick="buyerExpand('${l.id}')"
                  >
                    <div>
                      <div style="font-weight:600;color:var(--text)">${_(l.name)}</div>
                      <div style="font-size:11px;color:var(--muted);margin-top:2px">
                        ${l.email?_(l.email)+"  ":""}
                        ${Object.entries(l.handles).filter(([,g])=>g).map(([g,m])=>`${g}: ${_(m)}`).join("  ")}
                      </div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-size:14px;font-weight:700;color:var(--good)">${x(d)}</div>
                      <div style="font-size:11px;color:var(--muted)">${u} purchase${u!==1?"s":""}</div>
                    </div>
                  </div>

                  <!-- Expanded Content -->
                  ${h?`
                    <div style="border-top:1px solid var(--border);padding:12px;background:var(--surface)">
                      ${l.notes?`<div style="padding:8px;background:var(--surface2);border-radius:2px;margin-bottom:8px"><strong>Notes:</strong> ${_(l.notes)}</div>`:""}
                      <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:600">Last Purchase: ${p?ce(p.date||Date.now()):""}</div>

                      ${f.length>0?`
                        <div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:6px">Purchase History:</div>
                        <div class="inv-table">
                          <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:8px;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;padding-bottom:4px;border-bottom:1px solid var(--border)">
                            <div>Item</div>
                            <div style="text-align:right">Price</div>
                            <div style="text-align:right">Date</div>
                          </div>
                          ${f.map(g=>{const m=q(g.itemId);return`
                              <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:8px;font-size:11px;padding:6px 0;border-bottom:1px solid var(--border);align-items:center">
                                <div style="color:var(--text)">${m?_(m.name):"Unknown Item"}</div>
                                <div style="text-align:right;color:var(--good);font-weight:600">${x(g.price||0)}</div>
                                <div style="text-align:right;color:var(--muted);font-size:10px">${ce(g.date||Date.now())}</div>
                              </div>
                            `}).join("")}
                        </div>
                      `:'<div style="font-size:11px;color:var(--muted)">No purchases linked</div>'}

                      <button onclick="buyerDelete('${l.id}')" class="btn-danger" style="margin-top:8px;width:100%;height:32px;font-size:11px">Delete Buyer</button>
                    </div>
                  `:""}
                </div>
              `}).join("")}
      </div>

      <!-- Pagination -->
      <div id="buyersPagination"></div>
    </div>
  `;t.innerHTML=a;const c=document.getElementById("buyersPagination");Vn(c,{page:Pn,totalItems:o.length,pageSize:Co,onPage:l=>{Pn=l,Lt()}})}function Vs(){localStorage.setItem("ft_supplies",JSON.stringify(ee)),Hg()}async function Hg(){const t=Pe(),e=Ce();if(!(!t||!e))try{const n=e.id,s=ee.map(i=>({id:i.id,account_id:n,data:i}));await t.from("ft_supplies").upsert(s,{onConflict:"id"})}catch{}}function Wg(){const t=document.getElementById("sup_name").value.trim();if(!t){k("Supply name required",!0);return}const e=parseInt(document.getElementById("sup_qty").value)||0,n=parseInt(document.getElementById("sup_alert").value)||5;ee.push({id:ie(),name:t,category:document.getElementById("sup_cat").value,qty:e,cost:parseFloat(document.getElementById("sup_cost").value)||0,alert:n,notes:document.getElementById("sup_notes").value.trim(),added:new Date().toISOString()}),["sup_name","sup_qty","sup_cost","sup_alert","sup_notes"].forEach(s=>{const i=document.getElementById(s);i&&(i.value="")}),document.getElementById("sup_cat").value="Boxes",Vs(),Kn(),k("Supply added ")}function Gg(t,e){const n=ee.find(s=>s.id===t);n&&(n.qty=Math.max(0,(n.qty||0)+e),Vs(),Kn())}function Vg(t,e){const n=ee.find(s=>s.id===t);n&&(n.qty=Math.max(0,parseInt(e)||0),Vs(),Hr())}function Kg(t){const e=ee.findIndex(n=>n.id===t);e!==-1&&ee.splice(e,1),Vs(),Kn(),k("Removed ")}function Kn(){const t=document.getElementById("supBody"),e=document.getElementById("supEmpty"),n=document.getElementById("supLowBadge");if(!t)return;const s=ee.filter(i=>i.qty<=(i.alert||5)).length;if(n&&(n.style.display=s?"":"none"),!ee.length){t.innerHTML="",e.style.display="block";return}e.style.display="none",t.innerHTML=ee.map(i=>{const o=i.qty<=(i.alert||5),r=i.qty===0?"color:#ff6b6b;font-weight:700":o?"color:#ffaa33;font-weight:700":"",a=o?`<span style="font-size:9px;background:rgba(255,107,107,0.15);color:#ff6b6b;padding:1px 6px;font-family:'DM Mono',monospace;margin-left:6px">LOW</span>`:"";return`<tr>
      <td><div class="item-name">${i.name}${a}</div></td>
      <td><span class="cat-tag">${i.category||"Other"}</span></td>
      <td style="${r}">
        <div style="display:flex;align-items:center;gap:6px">
          <button onclick="updateSupplyQty('${i.id}',-1)" style="background:var(--surface3);border:1px solid var(--border);color:var(--text);width:22px;height:22px;cursor:pointer;font-size:14px;line-height:1;padding:0"></button>
          <input type="number" value="${i.qty}" min="0" onchange="setSupplyQty('${i.id}',this.value)"
            style="width:52px;text-align:center;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:3px 4px">
          <button onclick="updateSupplyQty('${i.id}',1)" style="background:var(--surface3);border:1px solid var(--border);color:var(--text);width:22px;height:22px;cursor:pointer;font-size:14px;line-height:1;padding:0">+</button>
        </div>
      </td>
      <td style="color:var(--muted);font-size:12px">${i.cost?x(i.cost):""}</td>
      <td style="color:var(--muted);font-size:12px">${i.alert||5}</td>
      <td style="color:var(--muted);font-size:11px">${i.notes||""}</td>
      <td style="text-align:right"><button class="btn-danger" style="font-size:11px;padding:4px 10px" onclick="delSupply('${i.id}')">Remove</button></td>
    </tr>`}).join("")}function Hr(){const t=ee.filter(n=>n.qty<=(n.alert||5)&&n.qty>=0);if(!t.length)return;const e=t.map(n=>`${n.name} (${n.qty} left)`).join(", ");k(` Low stock: ${e}`,!0,5e3)}let Zt=null;function hd(t){if(!ee.length){t([]);return}Zt=t;const e=document.getElementById("matsBody");e.innerHTML=ee.map(n=>{const s=n.qty<=(n.alert||5);return`<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--surface);border:1px solid ${s?"rgba(255,107,107,0.35)":"var(--border)"};border-radius:2px">
      <input type="checkbox" id="mat_${n.id}" style="width:16px;height:16px;accent-color:var(--accent);flex-shrink:0">
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-family:'Syne',sans-serif;font-weight:600">${n.name}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${n.category}  ${n.qty} in stock${s?'  <span style="color:#ff6b6b">LOW</span>':""}</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
        <span style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">Qty used:</span>
        <input type="number" id="matqty_${n.id}" value="1" min="1" max="${n.qty}"
          style="width:48px;text-align:center;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:4px 6px">
      </div>
    </div>`}).join(""),document.getElementById("matsOv").classList.add("on")}function Jg(){const t=[];for(const e of ee){const n=document.getElementById("mat_"+e.id);if(n&&n.checked){const s=parseInt(document.getElementById("matqty_"+e.id).value)||1;t.push({supplyId:e.id,qty:s}),e.qty=Math.max(0,e.qty-s)}}document.getElementById("matsOv").classList.remove("on"),t.length&&(Vs(),Kn(),Hr(),k("Materials deducted ")),Zt&&(Zt(t),Zt=null)}function Yg(){document.getElementById("matsOv").classList.remove("on"),Zt&&(Zt([]),Zt=null)}let en=null,Wr="each",Je=0;const fi=50;let St="",Dn="",Bn="";function Qg(t){if(!t){const n=$.filter(o=>o.qty>0&&!o._del);if(!n.length){k("No items in stock to sell",!0);return}en=null;const s=document.getElementById("soldInfo");s.innerHTML=`
      <div class="fgrp full" style="margin-bottom:8px">
        <label style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted)">Select Item to Sell</label>
        <select id="s_item_picker" style="background:var(--surface);border:1px solid var(--border);color:var(--text);padding:9px 12px;font-family:'DM Mono',monospace;font-size:12px;width:100%" onchange="onSoldItemPick(this.value)">
          <option value=""> Choose an item </option>
          ${n.map(o=>`<option value="${o.id}">${_(o.name)} (${o.qty} in stock  ${x(o.price)})</option>`).join("")}
        </select>
      </div>`,document.getElementById("s_price").value="",document.getElementById("s_qty").value="1",document.getElementById("s_fees").value="",document.getElementById("s_ship").value="",document.getElementById("s_date").value=new Date().toISOString().split("T")[0];const i=document.getElementById("s_platform");i.innerHTML='<option value="" disabled selected> Select platform </option>'+Ml.map(o=>`<option value="${o}">${_(o)}</option>`).join(""),Gr("each"),Vr(),document.getElementById("soldOv").classList.add("on");return}en=t;const e=$.find(n=>n.id===t);if(!e){k("Item not found",!0);return}md(e),document.getElementById("soldOv").classList.add("on")}function Xg(t){if(!t)return;en=t;const e=$.find(n=>n.id===t);e&&md(e)}function md(t){const{pu:e,m:n}=iy(t),s=document.getElementById("soldInfo"),i=document.getElementById("s_item_picker"),o=i?i.parentElement.outerHTML:"";if(s.innerHTML=o+`
    <div class="sir"><span class="k">Item</span><span>${_(t.name)}</span></div>
    <div class="sir"><span class="k">Platforms</span><span>${Y(t).join(", ")||""}</span></div>
    <div class="sir"><span class="k">Cost</span><span>${x(t.cost)}</span></div>
    <div class="sir"><span class="k">List Price</span><span>${x(t.price)}</span></div>
    <div class="sir"><span class="k">Expected Profit</span><span style="color:var(--good)">${x(e)} (${V(n)})</span></div>
    <div class="sir"><span class="k">In Stock</span><span>${t.qty} units</span></div>`,i){const l=document.getElementById("s_item_picker");l&&(l.value=t.id)}document.getElementById("s_price").value=t.price||"",document.getElementById("s_qty").value="1",document.getElementById("s_fees").value=t.fees||"",document.getElementById("s_ship").value=t.ship||"",document.getElementById("s_date").value=new Date().toISOString().split("T")[0];const r=Y(t),a=Ml.filter(l=>!r.includes(l)),c=document.getElementById("s_platform");c.innerHTML=[...r.map(l=>`<option value="${l}" selected>${_(l)} </option>`),`<option value="" disabled>${r.length?" Other platforms ":" Select platform "}</option>`,...a.map(l=>`<option value="${l}">${_(l)}</option>`)].join(""),r.length&&(c.value=r[0]),Gr("each"),Vr()}function Gr(t){Wr=t;const e=document.getElementById("s_price_each"),n=document.getElementById("s_price_total"),s="flex:1;padding:8px 6px;font-family:'DM Mono',monospace;font-size:11px;border:1px solid var(--accent);background:var(--accent);color:#0a0a0f;cursor:pointer;border-radius:0;font-weight:700",i="flex:1;padding:8px 6px;font-family:'DM Mono',monospace;font-size:11px;border:1px solid var(--border);background:var(--surface);color:var(--muted);cursor:pointer;border-radius:0";e&&(e.style.cssText=t==="each"?s:i),n&&(n.style.cssText=t==="total"?s:i),gd()}function Zg(t){St=(t||"").toLowerCase(),Je=0,pn()}function ey(t){Dn=t||"",Je=0,pn()}function ty(t){Bn=t||"",Je=0,pn()}function ny(){St="",Dn="",Bn="",Je=0,pn()}function gd(){const t=parseInt(document.getElementById("s_qty").value)||1,e=parseFloat(document.getElementById("s_price").value)||0,n=document.getElementById("s_price_hint");n&&(Wr==="each"?n.textContent=t>1?`Per unit  total = ${x(e*t)}`:"Price per individual unit":n.textContent=t>1?`Total for all ${t} units  each = ${x(e/t)}`:"Total sale price")}function Vr(){const t=document.getElementById("s_platform").value,e=parseFloat(document.getElementById("s_price").value)||0,n=document.getElementById("s_fee_hint");if(!n)return;const s=_s[t];if(!s){n.style.display="none";return}if(n.style.display="",e>0){const i=Mu(t,e);n.innerHTML=`${s.label}  est. <strong style="color:var(--accent)">${x(i)}</strong> <button onclick="document.getElementById('s_fees').value=${i};this.textContent='Applied '" style="background:none;border:1px solid var(--border);color:var(--accent);font-size:9px;padding:2px 8px;cursor:pointer;font-family:'DM Mono',monospace;margin-left:4px">Apply</button>`}else n.textContent=s.label}function ir(){document.getElementById("soldOv").classList.remove("on");const t=document.getElementById("s_buyer");t&&(t.value=""),en=null}function sy(){var h;const t=$.find(f=>f.id===en);if(!t){k("Item not found  it may have been deleted",!0),ir();return}const e=document.getElementById("s_price"),n=pe(e.value,{});if(isNaN(n)&&e.value.trim()!==""){Me(e,{fieldName:"Price"});return}if(!n){k("Sold price required",!0);return}const s=document.getElementById("s_qty"),i=pe(s.value,{integer:!0,min:1});if(isNaN(i)){Me(s,{fieldName:"Quantity",integer:!0});return}if(i>t.qty){k(`Only ${t.qty} available`,!0);return}const o=document.getElementById("s_fees"),r=pe(o.value,{allowZero:!0});if(isNaN(r)&&o.value.trim()!==""){Me(o,{fieldName:"Fees"});return}const a=document.getElementById("s_ship"),c=pe(a.value,{allowZero:!0});if(isNaN(c)&&a.value.trim()!==""){Me(a,{fieldName:"Shipping"});return}const l=Wr==="total"?n/i:n,d=document.getElementById("s_platform").value||"Other",u={id:ie(),itemId:en,price:l,listPrice:t.price||0,qty:i,platform:d,fees:isNaN(r)?0:r,ship:isNaN(c)?0:c,date:document.getElementById("s_date").value||new Date().toISOString()};Vi("sold",{itemId:en,qty:i,saleId:u.id}),I.push(u),J("sales",u.id),Pr(t.id,l,d);const p=(((h=document.getElementById("s_buyer"))==null?void 0:h.value)||"").trim();if(p){const f=Fg(p,d);f&&(u.buyerId=f.id)}t.qty-=i;{t.platformStatus||(t.platformStatus={}),t.platformStatus[d]="sold";const f=Er(t.id,d);f.length&&k(`Auto-marked ${f.join(", ")} as sold-elsewhere`)}J("inv",t.id),R(),ir(),W(),Ns.sale(),Wh("Item marked as sold"),hd(()=>{})}function iy(t){const e=t.cost||0,n=t.price||0,s=t.fees||0,i=t.ship||0,o=n-e-s-i,r=n?o/n:0,a=e?o/e:0;return{cost:e,price:n,fees:s,ship:i,pu:o,m:r,roi:a}}function pn(){const t=document.getElementById("salesBody"),e=document.getElementById("salesEmpty"),n=document.getElementById("salesPagination");let s=0,i=0;for(const u of I){const p=q(u.itemId);s+=(u.price||0)*(u.qty||0),i+=(u.price||0)*(u.qty||0)-(p?(p.cost||0)*(u.qty||0):0)-(u.fees||0)-(u.ship||0)}document.getElementById("salesTotalLbl").textContent=`${I.length} sales  ${x(s)} revenue  ${x(i)} profit`;const o=[...I].reverse();let r=o;St&&(r=r.filter(u=>{const p=q(u.itemId),h=p?p.name.toLowerCase():"",f=p?(p.category||"").toLowerCase():"",g=(u.platform||"").toLowerCase();return h.includes(St)||f.includes(St)||g.includes(St)})),Dn&&(r=r.filter(u=>u.date>=Dn)),Bn&&(r=r.filter(u=>u.date<=Bn));const a=document.getElementById("salesFilterBar");if(a&&(a.innerHTML=`<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 0">
      <input type="text" placeholder="Search sales..." value="${_(St)}"
             oninput="setSalesSearch(this.value)"
             style="flex:1;min-width:150px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;font-family:'DM Mono',monospace">
      <input type="date" value="${Dn}" onchange="setSalesDateFrom(this.value)" title="From date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      <span style="color:var(--muted);font-size:11px">to</span>
      <input type="date" value="${Bn}" onchange="setSalesDateTo(this.value)" title="To date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      ${St||Dn||Bn?`<button onclick="clearSalesFilters()" style="padding:5px 10px;background:var(--surface);border:1px solid var(--border);color:var(--danger);font-size:11px;cursor:pointer;font-family:'DM Mono',monospace">Clear</button>`:""}
      <span style="color:var(--muted);font-size:11px">${r.length} of ${o.length} sales</span>
    </div>`),!r.length){t.innerHTML="",e.style.display="block",n&&(n.innerHTML="");return}e.style.display="none";const c=Math.ceil(r.length/fi);Je>=c&&(Je=c-1),Je<0&&(Je=0);const l=Je*fi,d=r.slice(l,l+fi);t.innerHTML=d.map(u=>{const p=q(u.itemId),h=p?_(p.name):"Deleted Item",f=p?(p.cost||0)*(u.qty||0):0,m=(u.price||0)*(u.qty||0)-f-(u.fees||0)-(u.ship||0),v=u.listPrice||(p?p.price:0),E=v>0?(u.price-v)/v:0,w=v>0?E>.01?`<span style="font-size:9px;color:var(--good);font-family:'DM Mono',monospace">${V(E)}</span>`:E<-.01?`<span style="font-size:9px;color:var(--danger);font-family:'DM Mono',monospace">${V(Math.abs(E))}</span>`:`<span style="font-size:9px;color:var(--muted);font-family:'DM Mono',monospace">= list</span>`:"";return`<tr>
      <td><div class="item-name" style="cursor:${p?"pointer":"default"}" ${p?`onclick="openDrawer('${_(p.id)}')"`:""}>${h}</div>${p!=null&&p.category?`<div class="item-meta"><span class="cat-tag">${_(p.category)}</span></div>`:""}</td>
      <td>${u.platform?`<span class="plat-tag ${Nl(u.platform)}">${_(u.platform)}</span>`:p?kr(p):"-"}</td>
      <td style="color:var(--muted);font-size:11px">${ce(u.date)}</td>
      <td>${u.qty}</td>
      <td>${x(u.price)} ${w}</td>
      <td style="color:var(--muted)">${x(p?p.cost:0)}</td>
      <td style="color:var(--muted)">${x((u.fees||0)+(u.ship||0))}</td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;color:${m>=0?"var(--good)":"var(--danger)"}">${x(m)}</td>
      <td><div class="td-acts"><button class="act-btn red" onclick="delSale('${_(u.id)}')"></button></div></td>
    </tr>`}).join(""),n&&Vn(n,{page:Je,totalItems:r.length,pageSize:fi,onPage:u=>{Je=u,pn()}})}function oy(){var xa,_a,Sa,ka,$a,Ea,Ia,Ta,Ca,Pa,Da,Ba,Oa;const t=document.getElementById("insightsContent");if(!t)return;if(!I.length&&!$.length){t.innerHTML='<div class="panel" style="animation:none"><div class="empty-state"><div class="empty-icon"></div><p>No data yet.<br>Add inventory and record some sales to see insights.</p></div></div>';return}const e=new Date,n=864e5,s=new Date(e-30*n),i=$.map(y=>{const b=I.filter(We=>We.itemId===y.id),T=b.reduce((We,tt)=>We+(tt.price||0)*(tt.qty||0),0),H=b.reduce((We,tt)=>We+(tt.qty||0),0),K=b.reduce((We,tt)=>We+(tt.price||0)*(tt.qty||0)-(y.cost||0)*(tt.qty||0)-(tt.fees||0)-(tt.ship||0),0),me=b.length?new Date(Math.max(...b.map(We=>new Date(We.date)))):null,ae=me?Math.floor((e-me)/n):null,ge=new Date(y.added||e),vn=Math.floor((e-ge)/n),mo=T>0?K/T:0,Zn=y.cost>0?K/(y.cost*(H||1)):0,go=b.filter(We=>new Date(We.date)>=s);return{item:y,itemSales:b,revenue:T,unitsSold:H,profit:K,lastSale:me,daysSinceSale:ae,daysListed:vn,margin:mo,roi:Zn,recentSales30:go}}),o={};for(const{item:y,revenue:b,profit:T,unitsSold:H}of i){const K=y.category||"Uncategorized";o[K]||(o[K]={revenue:0,profit:0,units:0,items:0}),o[K].revenue+=b,o[K].profit+=T,o[K].units+=H,o[K].items++}const r=Object.entries(o).sort((y,b)=>b[1].profit-y[1].profit).slice(0,5),a={};for(const y of I){const b=q(y.itemId),T=y.platform||b&&b.platform||"Other";a[T]||(a[T]={revenue:0,units:0,count:0}),a[T].revenue+=(y.price||0)*(y.qty||0),a[T].units+=y.qty||0,a[T].count++}const c=Object.entries(a).sort((y,b)=>b[1].revenue-y[1].revenue).slice(0,6),l=i.filter(y=>y.unitsSold>0).sort((y,b)=>b.unitsSold-y.unitsSold),d=i.filter(y=>y.unitsSold===0&&y.daysListed>=14).sort((y,b)=>b.daysListed-y.daysListed),u=[...i].filter(y=>y.profit>0).sort((y,b)=>b.profit-y.profit).slice(0,5),p=[...i].filter(y=>y.roi>0&&y.unitsSold>0).sort((y,b)=>b.roi-y.roi).slice(0,5),h=d.filter(y=>y.daysListed>=30).slice(0,5),f=i.filter(y=>y.recentSales30.length>0).sort((y,b)=>b.recentSales30.length-y.recentSales30.length).slice(0,5),g=Q.reduce((y,b)=>y+(b.amount||0),0),m=I.reduce((y,b)=>y+(b.price||0)*(b.qty||0),0),v=l.reduce((y,b)=>y+b.profit,0)-g,E={};for(const y of Q)E[y.category]=(E[y.category]||0)+(y.amount||0);const w=Object.entries(E).sort((y,b)=>b[1]-y[1]).slice(0,4),S=Q.filter(y=>new Date(y.date)>=s).reduce((y,b)=>y+(b.amount||0),0),C=I.filter(y=>new Date(y.date)>=s).reduce((y,b)=>y+(b.price||0)*(b.qty||0),0),B=(y,b,T="var(--accent)")=>`<div style="height:6px;background:var(--surface3);border-radius:3px;margin-top:5px"><div style="height:6px;width:${b>0?Math.round(y/b*100):0}%;background:${T};border-radius:3px;transition:width 0.4s"></div></div>`,L=y=>y<=30?"var(--good)":y<=60?"var(--warn)":y<=90?"var(--accent2)":"var(--danger)",O=(y,b,T,H="var(--accent)")=>`
    <div style="background:var(--surface2);border:1px solid var(--border);padding:16px 18px;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;border-bottom:1px solid var(--border);padding-bottom:8px">
        <span style="font-size:16px">${y}</span>
        <span style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:${H}">${b}</span>
      </div>
      ${T}
    </div>`,G=(y,b)=>{const T=y.item;return`<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
      <div style="min-width:0;flex:1">
        <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer" onclick="openDrawer('${T.id}')">${T.name}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${T.category||""}${T.subcategory?"  "+T.subcategory:""}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;margin-left:12px">${b(y)}</div>
    </div>`},D=I.reduce((y,b)=>y+(b.qty||0),0),P=l.length?l.reduce((y,b)=>y+b.margin,0)/l.length:0,z=$.reduce((y,b)=>{const H=I.filter(K=>K.itemId===b.id).reduce((K,me)=>K+(me.qty||0),0);return y+(b.qty||0)+H},0),oe=I.reduce((y,b)=>y+(b.qty||0),0),N=z>0?oe/z:0,X=y=>y>=.5?"var(--good)":y>=.25?"var(--warn)":"var(--danger)",Be=`
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px">
      ${[["Total Revenue",x(m),"var(--accent)"],["Net Profit",x(v),v>=0?"var(--good)":"var(--danger)"],["Units Sold",D,"var(--accent3)"],["Avg Margin",V(P),P>=.2?"var(--good)":"var(--warn)"],["Sell-Through",z>0?(N*100).toFixed(0)+"%":"",X(N)]].map(([y,b,T])=>`
        <div style="background:var(--surface2);border:1px solid var(--border);padding:12px 14px">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${y}</div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:${T}">${b}</div>
        </div>`).join("")}
    </div>`,ei=f.length?O("","Hot Right Now  30 days",f.map(y=>G(y,b=>`
      <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--accent);font-weight:700">${b.recentSales30.length} sale${b.recentSales30.length>1?"s":""}</div>
      <div style="font-size:10px;color:var(--muted)">${x(b.revenue)} rev</div>`)).join(""),"var(--accent)"):"",ti=[...i].filter(y=>y.unitsSold>0).sort((y,b)=>b.unitsSold-y.unitsSold).slice(0,8),Mt=((xa=ti[0])==null?void 0:xa.unitsSold)||1,so=ti.length?O("","Best Sellers  All Time",ti.map((y,b)=>{const T=b===0?"":b===1?"":b===2?"":`<span style="font-size:10px;color:var(--muted)">#${b+1}</span>`,H=y.daysListed>0?(y.unitsSold/y.daysListed*30).toFixed(1):"";return`<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
        <span style="width:22px;text-align:center;flex-shrink:0">${T}</span>
        <div style="min-width:0;flex:1">
          <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer" onclick="openDrawer('${y.item.id}')">${y.item.name}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:1px">${y.item.category||""}  ~${H}/mo velocity</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-size:13px;font-family:'Syne',sans-serif;font-weight:700;color:var(--accent)">${y.unitsSold} sold</div>
          <div style="font-size:10px;color:var(--muted)">${x(y.revenue)} rev</div>
        </div>
      </div>`+B(y.unitsSold,Mt)}).join(""),"var(--accent)"):"",io=u.length?O("","Top Profit Generators",u.map((y,b)=>G(y,T=>`
      <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--good);font-weight:700">${x(T.profit)}</div>
      <div style="font-size:10px;color:var(--muted)">${V(T.margin)} margin</div>`)).join("")+(u[0]?B(u[0].profit,u[0].profit,"var(--good)"):""),"var(--good)"):"",su=p.length?O("","Best Return on Investment",p.map(y=>G(y,b=>`
      <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent3);font-weight:700">${V(b.roi)} ROI</div>
      <div style="font-size:10px;color:var(--muted)">cost ${x(b.item.cost)}</div>`)).join(""),"var(--accent3)"):"",dt={};for(const{item:y,revenue:b,profit:T,unitsSold:H}of i){const K=y.source||"Unknown";dt[K]||(dt[K]={revenue:0,profit:0,units:0,items:0,cost:0}),dt[K].revenue+=b,dt[K].profit+=T,dt[K].units+=H,dt[K].items++,dt[K].cost+=(y.cost||0)*(y.qty||1)}const iu=Object.entries(o).map(([y,b])=>{const T=$.filter(K=>(K.category||"Uncategorized")===y).reduce((K,me)=>K+(me.cost||0)*((me.qty||0)+I.filter(ae=>ae.itemId===me.id).reduce((ae,ge)=>ae+(ge.qty||0),0)),0),H=T>0?b.profit/T:0;return{name:y,profit:b.profit,cost:T,roi:H,units:b.units}}).filter(y=>y.units>0).sort((y,b)=>b.roi-y.roi).slice(0,5),ou=Object.entries(dt).filter(([y])=>y!=="Unknown").map(([y,b])=>{const T=b.cost>0?b.profit/b.cost:0;return{name:y,profit:b.profit,cost:b.cost,roi:T,units:b.units}}).filter(y=>y.units>0).sort((y,b)=>b.roi-y.roi).slice(0,5),ru=Object.entries(a).map(([y,b])=>{const T=I.filter(me=>{const ae=$.find(ge=>ge.id===me.itemId);return(me.platform||ae&&ae.platform||"Other")===y}).reduce((me,ae)=>{const ge=$.find(vn=>vn.id===ae.itemId);return me+(ge?(ge.cost||0)*(ae.qty||0):0)},0),H=b.revenue-T,K=T>0?H/T:0;return{name:y,profit:H,cost:T,roi:K,units:b.units}}).filter(y=>y.units>0).sort((y,b)=>b.roi-y.roi).slice(0,5),oo=(y,b)=>{if(!y.length)return"";const T=Math.max(...y.map(H=>Math.abs(H.roi)),.01);return`<div style="margin-bottom:14px">
      <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">${b}</div>
      ${y.map(H=>`<div style="padding:4px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px">${_(H.name)}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;font-weight:700;color:${H.roi>=0?"var(--accent3)":"var(--danger)"}">${V(H.roi)}</span>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:1px">${x(H.profit)} profit on ${x(H.cost)} invested  ${H.units} unit${H.units!==1?"s":""}</div>
        ${B(Math.abs(H.roi),T,H.roi>=0?"var(--accent3)":"var(--danger)")}
      </div>`).join("")}
    </div>`},ua=oo(iu,"By Category")+oo(ou,"By Source")+oo(ru,"By Platform"),au=ua.trim()?O("","ROI Breakdown",ua,"var(--accent3)"):"",lu=[30,60,90].map(y=>{const b=new Date(e-y*n),H=$.filter(ae=>new Date(ae.added||e)>=b).reduce((ae,ge)=>{const mo=I.filter(Zn=>Zn.itemId===ge.id).reduce((Zn,go)=>Zn+(go.qty||0),0);return ae+(ge.qty||0)+mo},0),K=I.filter(ae=>{const ge=$.find(vn=>vn.id===ae.itemId);return ge&&new Date(ge.added||e)>=b}).reduce((ae,ge)=>ae+(ge.qty||0),0),me=H>0?K/H:0;return{days:y,rate:me,sold:K,added:H}}),cu=N>=.5?"Excellent sell-through  your sourcing is well-calibrated":N>=.3?"Solid rate  look for ways to move stale items faster":N>=.15?"Below average  consider reducing new sourcing until existing stock moves":"Low sell-through  focus on clearing current inventory before buying more",du=z>0?O("","Sell-Through Rate",`<div style="display:flex;gap:12px;margin-bottom:14px">
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:28px;color:${X(N)}">${(N*100).toFixed(1)}%</div>
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px">All Time</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${oe} of ${z} units</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      ${lu.map(y=>`<div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:${X(y.rate)}">${(y.rate*100).toFixed(0)}%</div>
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px">${y.days}d cohort</div>
        <div style="font-size:9px;color:var(--muted)">${y.sold}/${y.added}</div>
      </div>`).join("")}
    </div>
    <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> ${cu}</div>`,X(N)):"",je={fresh:0,moderate:0,stale:0,deadPile:0},mn=[];for(const y of i)y.item.qty<=0||(y.daysListed<=30?je.fresh++:y.daysListed<=60?je.moderate++:y.daysListed<=90?je.stale++:je.deadPile++,y.daysListed>60&&y.item.qty>0&&y.recentSales30.length===0&&mn.push(y));mn.sort((y,b)=>b.daysListed-y.daysListed);const uu=mn.map(y=>{const b=(y.item.price||0)*.8,T=y.recentSales30.length===0?"Lower price by 20%":"Relist on new platform";return`<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
      <td style="padding:8px 10px"><div class="item-name" style="cursor:pointer;font-weight:600" onclick="openDrawer('${y.item.id}')">${_(y.item.name)}</div></td>
      <td style="padding:8px 10px;font-family:'DM Mono',monospace;font-weight:600;color:${L(y.daysListed)}">${y.daysListed}d</td>
      <td style="padding:8px 10px;text-align:right;font-family:'DM Mono',monospace">${x(y.item.price)}</td>
      <td style="padding:8px 10px;text-align:right;font-family:'DM Mono',monospace;color:var(--good)">${x(b)}</td>
      <td style="padding:8px 10px;font-size:10px;color:var(--muted)">${y.item.platform||"Other"}</td>
      <td style="padding:8px 10px;font-size:10px;color:var(--warn)">${T}</td>
    </tr>`}).join(""),pu=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px">
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Fresh (030d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--good)">${je.fresh}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Moderate (3160d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--warn)">${je.moderate}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Stale (6190d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--accent2)">${je.stale}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Dead (90+d)</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--danger)">${je.deadPile}</div>
      </div>
    </div>
    ${mn.length?`
    <div style="margin-top:12px">
      <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600">Death Pile Alert  ${mn.length} item${mn.length!==1?"s":""}</div>
      <div style="overflow-x:auto">
        <table style="width:100%;font-size:11px;border-collapse:collapse">
          <thead>
            <tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Item</th>
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Days</th>
              <th style="text-align:right;padding:8px 10px;color:var(--muted);font-weight:600">Current</th>
              <th style="text-align:right;padding:8px 10px;color:var(--muted);font-weight:600">Suggested</th>
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Platform</th>
              <th style="text-align:left;padding:8px 10px;color:var(--muted);font-weight:600">Action</th>
            </tr>
          </thead>
          <tbody>${uu}</tbody>
        </table>
      </div>
    </div>
    `:'<div style="font-size:10px;color:var(--good);margin-top:10px"> No items in death pile  great inventory health!</div>'}
  `,fu=je.fresh||je.moderate||je.stale||je.deadPile?O("","Aging & Death Pile",pu,"var(--warn)"):"",hu=h.length?O("","Not Moving  Consider Repricing",h.map(y=>G(y,b=>`
      <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--warn);font-weight:700">${b.daysListed}d listed</div>
      <div style="font-size:10px;color:var(--muted)">0 sold  ${x(b.item.price)} list</div>`)).join("")+`<div style="margin-top:10px;font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> Try lowering the price by 1020% or listing on an additional platform</div>`,"var(--warn)"):"",mu=((Sa=(_a=r[0])==null?void 0:_a[1])==null?void 0:Sa.profit)||1,gu=r.length?O("","Top Categories by Profit",r.map(([y,b])=>`
      <div style="padding:6px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:12px;font-weight:600">${y}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--good);font-weight:700">${x(b.profit)}</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${b.units} unit${b.units!==1?"s":""} sold  ${x(b.revenue)} revenue  ${b.items} item${b.items!==1?"s":""}</div>
        ${B(b.profit,mu,"var(--good)")}
      </div>`).join("")):"",yu=(($a=(ka=c[0])==null?void 0:ka[1])==null?void 0:$a.revenue)||1,vu=c.length?O("","Platform Performance",c.map(([y,b])=>`
      <div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between">
          <span style="font-size:12px;font-weight:600">${y}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent)">${x(b.revenue)}</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${b.count} sale${b.count!==1?"s":""}  ${b.units} unit${b.units!==1?"s":""}</div>
        ${B(b.revenue,yu)}
      </div>`).join("")):"",ro=Object.entries(dt).filter(([y])=>y!=="Unknown").sort((y,b)=>b[1].profit-y[1].profit).slice(0,6),bu=((Ia=(Ea=ro[0])==null?void 0:Ea[1])==null?void 0:Ia.profit)||1,wu=ro.length?O("","Source Performance",ro.map(([y,b])=>{const T=b.cost>0?b.profit/b.cost:0;return`<div style="padding:6px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:12px;font-weight:600">${_(y)}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--good);font-weight:700">${x(b.profit)}</span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${b.units} sold  ${b.items} item${b.items!==1?"s":""}  ${x(b.revenue)} rev  ${V(T)} ROI</div>
        ${B(Math.max(b.profit,0),bu,b.profit>=0?"var(--good)":"var(--danger)")}
      </div>`}).join(""),"var(--accent2)"):"",ao=m>0?g/m:0,lo=ao<.1?["","Low","var(--good)"]:ao<.25?["","Moderate","var(--warn)"]:["","High","var(--danger)"],xu=((Ta=w[0])==null?void 0:Ta[1])||1,_u=Q.length?O("","Expense Health",`<div style="display:flex;gap:12px;margin-bottom:12px">
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:10px">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Expense Ratio</div>
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:${lo[2]}">${V(ao)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">of revenue  ${lo[0]} ${lo[1]}</div>
      </div>
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:10px">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Last 30 Days</div>
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:var(--danger)">${x(S)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">vs ${x(C)} revenue</div>
      </div>
    </div>`+w.map(([y,b])=>`
      <div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between">
          <span style="font-size:12px">${y}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--danger)">${x(b)}</span>
        </div>
        ${B(b,xu,"var(--danger)")}
      </div>`).join(""),"var(--danger)"):"",pa=d.filter(y=>y.daysListed>=30).reduce((y,b)=>y+(b.item.cost||0)*(b.item.qty||1),0),co=d.filter(y=>y.daysListed>=30).length,Su=co>0?O("","Tied-Up Capital",`<div style="margin-bottom:10px">
      <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:22px;color:var(--warn)">${x(pa)}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px">cost basis sitting in ${co} item${co>1?"s":""} with no sales after 30+ days</div>
    </div>
    <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> Freeing this capital could fund ${Math.floor(pa/Math.max($.reduce((y,b)=>y+(b.cost||0),0)/$.length,1))} new average-cost items</div>`,"var(--warn)"):"",ni=I.filter(y=>{var T;return(y.listPrice||((T=q(y.itemId))==null?void 0:T.price)||0)>0});let si=0,fa=0,ii=0,ha=0;for(const y of ni){const b=y.listPrice||((Ca=q(y.itemId))==null?void 0:Ca.price)||0,T=(y.price-b)/b;ha+=T,T>.01?si++:T<-.01?ii++:fa++}const oi=ni.length?ha/ni.length:0,ma=oi>=0?"var(--good)":oi>-.1?"var(--warn)":"var(--danger)",ku=ni.length>=3?O("","Pricing Accuracy",`<div style="display:flex;gap:10px;margin-bottom:12px">
      <div style="flex:1;background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:22px;color:${ma}">${oi>=0?"+":""}${V(oi)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">avg vs list price</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <div style="flex:1;text-align:center;padding:8px;background:rgba(87,255,154,0.06);border:1px solid rgba(87,255,154,0.15)">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--good)">${si}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px">ABOVE LIST</div>
      </div>
      <div style="flex:1;text-align:center;padding:8px;background:rgba(87,200,255,0.06);border:1px solid rgba(87,200,255,0.15)">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--accent)">${fa}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px">AT LIST</div>
      </div>
      <div style="flex:1;text-align:center;padding:8px;background:rgba(255,71,87,0.06);border:1px solid rgba(255,71,87,0.15)">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--danger)">${ii}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px">BELOW LIST</div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> ${ii>si?"You often sell below listing  try starting higher or negotiating less":si>ii?"Great job  you consistently meet or exceed your asking price":"Your pricing is well calibrated to market expectations"}</div>`,ma):"",uo={"< 7 days":0,"1-2 weeks":0,"2-4 weeks":0,"1-2 months":0,"2-3 months":0,"3+ months":0},ga={"< 7 days":0,"1-2 weeks":0,"2-4 weeks":0,"1-2 months":0,"2-3 months":0,"3+ months":0};for(const y of $){const b=y.qty!=null?y.qty:1;if(b<=0)continue;const T=y.added?Math.floor((e-new Date(y.added))/n):0,H=T<7?"< 7 days":T<14?"1-2 weeks":T<30?"2-4 weeks":T<60?"1-2 months":T<90?"2-3 months":"3+ months";uo[H]+=b||1,ga[H]+=(y.cost||0)*(b||1)}const $u=Math.max(...Object.values(uo),1),Eu={"< 7 days":"var(--good)","1-2 weeks":"var(--good)","2-4 weeks":"var(--accent)","1-2 months":"var(--warn)","2-3 months":"var(--accent2)","3+ months":"var(--danger)"},gn=$.filter(y=>(y.qty!=null?y.qty:1)>0).length,Iu=gn>=1?O("","Inventory Age Distribution",`<div style="font-size:10px;color:var(--muted);margin-bottom:10px">${gn} items in stock</div>`+Object.entries(uo).filter(([,y])=>y>0).map(([y,b])=>`<div style="padding:4px 0">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px">${y}</span>
        <span style="font-size:11px;font-family:'DM Mono',monospace"><span style="font-weight:700">${b}</span> units  ${x(ga[y])}</span>
      </div>
      ${B(b,$u,Eu[y])}
    </div>`).join(""),"var(--accent)"):"",jt={};for(const y of $){const b=y.qty!=null?y.qty:1;if(b<=0)continue;const T=y.category||"Uncategorized";jt[T]||(jt[T]={cost:0,retail:0,units:0,items:0}),jt[T].cost+=(y.cost||0)*(b||1),jt[T].retail+=(y.price||0)*(b||1),jt[T].units+=b||1,jt[T].items++}const po=Object.entries(jt).sort((y,b)=>b[1].cost-y[1].cost).slice(0,6),Tu=((Da=(Pa=po[0])==null?void 0:Pa[1])==null?void 0:Da.cost)||1,ya=$.filter(y=>(y.qty!=null?y.qty:1)>0).reduce((y,b)=>{const T=b.qty!=null?b.qty:1;return y+(b.cost||0)*T},0),va=$.filter(y=>(y.qty!=null?y.qty:1)>0).reduce((y,b)=>{const T=b.qty!=null?b.qty:1;return y+(b.price||0)*T},0),ba=va-ya,Cu=po.length>=1?O("","Capital Invested by Category",`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      <div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Invested</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--warn)">${x(ya)}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">List Value</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:var(--accent)">${x(va)}</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Potential</div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;color:${ba>=0?"var(--good)":"var(--danger)"}">${x(ba)}</div>
      </div>
    </div>`+po.map(([y,b])=>{const T=b.cost>0?(b.retail-b.cost)/b.cost:0;return`<div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px;font-weight:600">${_(y)}</span>
          <span style="font-size:11px;font-family:'DM Mono',monospace;color:var(--warn);font-weight:700">${x(b.cost)}</span>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:1px">${b.items} item${b.items!==1?"s":""}  ${b.units} unit${b.units!==1?"s":""}  ${x(b.retail)} list  ${V(T)} potential ROI</div>
        ${B(b.cost,Tu,"var(--warn)")}
      </div>`}).join(""),"var(--warn)"):"",Nt={noPhoto:$.filter(y=>(y.qty!=null?y.qty:1)>0&&(!y.images||!y.images.length)),noPrice:$.filter(y=>(y.qty!=null?y.qty:1)>0&&!y.price),noPlatform:$.filter(y=>{if((y.qty!=null?y.qty:1)<=0)return!1;const b=Y(y);return!b.length||b.length===1&&(b[0]==="Unlisted"||b[0]==="Other")}),noCost:$.filter(y=>(y.qty!=null?y.qty:1)>0&&!y.cost),noCategory:$.filter(y=>(y.qty!=null?y.qty:1)>0&&!y.category),noCondition:$.filter(y=>(y.qty!=null?y.qty:1)>0&&!y.condition)},fo=Object.values(Nt).reduce((y,b)=>y+b.length,0),yn=(y,b,T,H)=>T.length?`<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
    <span style="font-size:14px">${y}</span>
    <div style="flex:1">
      <div style="font-size:12px;font-weight:600;color:${H}">${T.length} item${T.length!==1?"s":""} ${b}</div>
      <div style="font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px">${T.slice(0,3).map(K=>_(K.name)).join(", ")}${T.length>3?"...":""}</div>
    </div>
  </div>`:"",Pu=yn("","missing photos",Nt.noPhoto,"var(--accent2)")+yn("","missing price",Nt.noPrice,"var(--danger)")+yn("","not listed on any platform",Nt.noPlatform,"var(--warn)")+yn("","missing cost (can't track profit)",Nt.noCost,"var(--warn)")+yn("","missing category",Nt.noCategory,"var(--muted)")+yn("","missing condition",Nt.noCondition,"var(--muted)"),wa=gn>0&&!fo,Du=gn>0?O("","Listing Readiness",wa?`<div style="text-align:center;padding:12px 0">
          <div style="font-size:28px;margin-bottom:6px"></div>
          <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--good)">All items fully set up!</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Every item has photos, pricing, platforms, and more</div>
        </div>`:`<div style="font-size:10px;color:var(--muted);margin-bottom:8px">${fo} thing${fo!==1?"s":""} to fix across ${gn} in-stock items</div>`+Pu+`<div style="margin-top:10px;font-size:11px;color:var(--muted);font-family:'DM Mono',monospace"> Complete items sell faster  fill in the gaps to boost your sell-through</div>`,wa?"var(--good)":"var(--accent2)"):"",zt={};for(const y of $){const b=y.qty!=null?y.qty:1;if(b<=0)continue;const T=y.source||"";T&&(zt[T]||(zt[T]={cost:0,retail:0,items:0,units:0}),zt[T].cost+=(y.cost||0)*(b||1),zt[T].retail+=(y.price||0)*(b||1),zt[T].items++,zt[T].units+=b||1)}const ho=Object.entries(zt).sort((y,b)=>b[1].cost-y[1].cost).slice(0,5),Bu=((Oa=(Ba=ho[0])==null?void 0:Ba[1])==null?void 0:Oa.cost)||1,Ou=ho.length>=1?O("","Where Your Money Goes  by Source",ho.map(([y,b])=>{const T=b.cost>0?(b.retail-b.cost)/b.cost:0;return`<div style="padding:5px 0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px;font-weight:600"> ${_(y)}</span>
          <span style="font-size:11px;font-family:'DM Mono',monospace;font-weight:700;color:var(--accent2)">${x(b.cost)}</span>
        </div>
        <div style="font-size:9px;color:var(--muted);margin-top:1px">${b.items} item${b.items!==1?"s":""}  ${b.units} unit${b.units!==1?"s":""}  ${x(b.retail)} list value  ${V(T)} potential ROI</div>
        ${B(b.cost,Bu,"var(--accent2)")}
      </div>`}).join(""),"var(--accent2)"):"";t.innerHTML=`
    <div style="padding:0 0 24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:20px">Insights</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">Based on ${$.length} items  ${I.length} sales  ${Q.length} expenses</div>
        </div>
        <div style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">Updated ${new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}</div>
      </div>
      ${Be}
      ${fu}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          ${Du}
          ${ei}
          ${so}
          ${io}
          ${Su}
          ${hu}
          ${Iu}
        </div>
        <div>
          ${Cu}
          ${su}
          ${au}
          ${du}
          ${gu}
          ${vu}
          ${wu}
          ${Ou}
          ${ku}
          ${_u}
        </div>
      </div>
      ${!l.length&&!h.length&&!gn?`<div style="text-align:center;color:var(--muted);font-size:13px;padding:40px 0;font-family:'DM Mono',monospace">Add some inventory items to start seeing insights </div>`:""}
    </div>`,t.innerHTML}let Vt="",On="",An="";function ry(t){Vt=(t||"").toLowerCase(),Rt()}function ay(t){On=t||"",Rt()}function ly(t){An=t||"",Rt()}function cy(){Vt="",On="",An="",Rt()}const dy={"Shipping Supplies":"exp-shipping","Packaging Materials":"exp-packaging","Platform Fees":"exp-fees",Sourcing:"exp-sourcing",Storage:"exp-storage",Printing:"exp-printing",Software:"exp-software",Marketing:"exp-marketing",Returns:"exp-returns","Office Supplies":"exp-office",Other:"exp-other"};function yd(){const t=document.getElementById("exp_date");t&&!t.value&&(t.value=new Date().toISOString().split("T")[0])}function uy(){const t=document.getElementById("exp_date").value,e=document.getElementById("exp_cat").value,n=document.getElementById("exp_desc").value.trim(),s=document.getElementById("exp_amt"),i=pe(s.value,{allowZero:!1});if(isNaN(i)&&s.value.trim()!==""){Me(s,{fieldName:"Amount"});return}if(!t){k("Please enter a date",!0);return}if(!n){k("Please enter a description",!0);return}if(!i||i<=0){k("Please enter a valid amount",!0);return}Q.push({id:ie(),date:t,category:e,description:n,amount:i}),R(),Rt(),document.getElementById("exp_desc").value="",document.getElementById("exp_amt").value="",Ns.expense(),k("Expense added ")}async function py(t){if(!confirm("Delete this expense?"))return;const e=Q.findIndex(n=>n.id===t);e>=0&&Q.splice(e,1),R(),Rt(),k("Expense deleted"),await Fs("ft_expenses",[t]),Hn()}function Rt(){var a;const t=((a=document.getElementById("expCatFilt"))==null?void 0:a.value)||"all",e=document.getElementById("expBody"),n=document.getElementById("expEmpty"),s=document.getElementById("expTotalLbl"),i=[...Q].filter(c=>t==="all"||c.category===t).filter(c=>!Vt||(c.description||"").toLowerCase().includes(Vt)||(c.category||"").toLowerCase().includes(Vt)).filter(c=>!On||c.date>=On).filter(c=>!An||c.date<=An).sort((c,l)=>new Date(l.date)-new Date(c.date)),o=i.reduce((c,l)=>c+(l.amount||0),0);s&&(s.textContent=`${i.length} expense${i.length!==1?"s":""}  ${x(o)}`);const r=document.getElementById("expFilterBar");if(r&&(r.innerHTML=`<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 0">
      <input type="text" placeholder="Search expenses..." value="${_(Vt)}"
             oninput="setExpSearch(this.value)"
             style="flex:1;min-width:150px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;font-family:'DM Mono',monospace">
      <input type="date" value="${On}" onchange="setExpDateFrom(this.value)" title="From date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      <span style="color:var(--muted);font-size:11px">to</span>
      <input type="date" value="${An}" onchange="setExpDateTo(this.value)" title="To date"
             style="padding:5px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
      ${Vt||On||An?`<button onclick="clearExpFilters()" style="padding:5px 10px;background:var(--surface);border:1px solid var(--border);color:var(--danger);font-size:11px;cursor:pointer;font-family:'DM Mono',monospace">Clear</button>`:""}
    </div>`),!i.length){e&&(e.innerHTML=""),n&&(n.style.display="block");return}n&&(n.style.display="none"),e.innerHTML=i.map(c=>{const l=dy[c.category]||"exp-other",d=_(c.description),u=c.description.replace(/"/g,"&quot;");return`<tr>
      <td style="color:var(--muted);font-size:11px">${ce(c.date)}</td>
      <td title="${u}"><span class="exp-cat-badge ${l}">${c.category}</span><span class="exp-desc-mobile">  ${d}</span></td>
      <td title="${u}">${d}</td>
      <td style="text-align:right;font-family:'DM Mono',monospace;font-weight:600;color:var(--danger)">
        ${x(c.amount)}&nbsp;<button class="act-btn red exp-del-mobile" onclick="delExpense('${c.id}')" style="margin-left:4px;vertical-align:middle"></button>
      </td>
      <td style="text-align:right"><button class="act-btn red exp-del-desktop" onclick="delExpense('${c.id}')"></button></td>
    </tr>`}).join("")}let pl="monthly",fy=0;const fl={"Shipping Supplies":"exp-shipping","Packaging Materials":"exp-packaging","Platform Fees":"exp-fees",Sourcing:"exp-sourcing",Storage:"exp-storage",Printing:"exp-printing",Software:"exp-software",Marketing:"exp-marketing",Returns:"exp-returns","Office Supplies":"exp-office",Other:"exp-other"};function hy(){const t=document.getElementById("reportsContent");if(!t)return;const{start:e,end:n,label:s}=my(pl,fy),i=I.filter(D=>{const P=new Date(D.date);return P>=e&&P<=n}),o=Q.filter(D=>{const P=new Date(D.date);return P>=e&&P<=n});let r=0,a=0,c=0;for(const D of i){const P=$.find(z=>z.id===D.itemId);r+=(D.price||0)*(D.qty||0),a+=P?(P.cost||0)*(D.qty||0):0,c+=(D.fees||0)+(D.ship||0)}const l=r-a-c,d=o.reduce((D,P)=>D+(P.amount||0),0),u=l-d,p=r?u/r:0,h={};for(const D of o)h[D.category]=(h[D.category]||0)+D.amount;const f=gy(pl,e,n),g=`
    <div class="period-summary-grid">
      <div class="period-card">
        <div class="period-card-lbl">Revenue</div>
        <div class="period-card-val" style="color:var(--accent)">${x(r)}</div>
        <div class="period-card-sub">${i.length} sale${i.length!==1?"s":""}</div>
      </div>
      <div class="period-card">
        <div class="period-card-lbl">COGS + Fees</div>
        <div class="period-card-val" style="color:var(--warn)">${x(a+c)}</div>
        <div class="period-card-sub">cost of goods + platform fees</div>
      </div>
      <div class="period-card">
        <div class="period-card-lbl">Gross Profit</div>
        <div class="period-card-val" style="color:${l>=0?"var(--good)":"var(--danger)"}">${x(l)}</div>
        <div class="period-card-sub">before overhead expenses</div>
      </div>
      <div class="period-card">
        <div class="period-card-lbl">Expenses</div>
        <div class="period-card-val" style="color:var(--danger)">${x(d)}</div>
        <div class="period-card-sub">${o.length} expense${o.length!==1?"s":""}</div>
      </div>
      <div class="period-card" style="border-color:${u>=0?"var(--good)":"var(--danger)"}">
        <div class="period-card-lbl">Net Profit</div>
        <div class="period-card-val" style="color:${u>=0?"var(--good)":"var(--danger)"},font-size:22px">${x(u)}</div>
        <div class="period-card-sub">margin: ${(p*100).toFixed(1)}%</div>
      </div>
    </div>`,m={};for(const D of i){const P=$.find(Be=>Be.id===D.itemId),z=P?P.category||"Uncategorized":"Unknown";m[z]||(m[z]={revenue:0,cogs:0,fees:0,profit:0,count:0});const oe=(D.price||0)*(D.qty||0),N=P?(P.cost||0)*(D.qty||0):0,X=(D.fees||0)+(D.ship||0);m[z].revenue+=oe,m[z].cogs+=N,m[z].fees+=X,m[z].profit+=oe-N-X,m[z].count++}const v=Object.entries(m).sort((D,P)=>P[1].profit-D[1].profit).map(([D,P])=>{const z=P.revenue>0?P.profit/P.revenue*100:0,oe=z>=20?"var(--good)":z>=10?"var(--warn)":"var(--danger)",N=P.profit>=0?"var(--good)":"var(--danger)";return`<tr>
      <td style="font-weight:600">${_(D)}</td>
      <td style="text-align:center">${P.count}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--accent)">${x(P.revenue)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--muted)">${x(P.cogs)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--danger)">${x(P.fees)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:700;color:${N}">${x(P.profit)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:600;color:${oe}">${z.toFixed(1)}%</td>
    </tr>`}).join(""),E=Object.entries(m).length?`
    <div class="period-section-ttl">Profit by Category</div>
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table">
        <thead><tr>
          <th>Category</th><th>Sales</th><th>Revenue</th><th>COGS</th><th>Fees</th><th>Profit</th><th>Margin</th>
        </tr></thead>
        <tbody>${v}</tbody>
      </table>
    </div>`:"",w={};for(const D of i){const P=D.platform||"Unknown";w[P]||(w[P]={revenue:0,cogs:0,fees:0,profit:0,count:0});const z=$.find(Be=>Be.id===D.itemId),oe=(D.price||0)*(D.qty||0),N=z?(z.cost||0)*(D.qty||0):0,X=(D.fees||0)+(D.ship||0);w[P].revenue+=oe,w[P].cogs+=N,w[P].fees+=X,w[P].profit+=oe-N-X,w[P].count++}const S=Object.entries(w).sort((D,P)=>P[1].profit-D[1].profit).map(([D,P])=>{const z=P.revenue>0?P.profit/P.revenue*100:0,oe=z>=20?"var(--good)":z>=10?"var(--warn)":"var(--danger)",N=P.profit>=0?"var(--good)":"var(--danger)";return`<tr>
      <td style="font-weight:600">${_(D)}</td>
      <td style="text-align:center">${P.count}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--accent)">${x(P.revenue)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--muted)">${x(P.cogs)}</td>
      <td style="font-family:'DM Mono',monospace;color:var(--danger)">${x(P.fees)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:700;color:${N}">${x(P.profit)}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:600;color:${oe}">${z.toFixed(1)}%</td>
    </tr>`}).join(""),C=Object.entries(w).length?`
    <div class="period-section-ttl">Profit by Platform</div>
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table">
        <thead><tr>
          <th>Platform</th><th>Sales</th><th>Revenue</th><th>COGS</th><th>Fees</th><th>Profit</th><th>Margin</th>
        </tr></thead>
        <tbody>${S}</tbody>
      </table>
    </div>`:"",B=Object.entries(h).length?`
    <div class="period-section-ttl">Expense Breakdown</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-bottom:16px">
      ${Object.entries(h).sort((D,P)=>P[1]-D[1]).map(([D,P])=>{const z=fl[D]||"exp-other",oe=d?(P/d*100).toFixed(0):0;return`<div class="period-card" style="flex-direction:row;display:flex;align-items:center;gap:10px;padding:10px 12px">
          <span class="exp-cat-badge ${z}" style="font-size:8px">${D}</span>
          <span style="font-family:'DM Mono',monospace;font-weight:700;font-size:13px;margin-left:auto">${x(P)}</span>
          <span style="font-size:9px;color:var(--muted)">${oe}%</span>
        </div>`}).join("")}
    </div>`:"",L=f.length?`
    <div class="period-section-ttl">Week by Week</div>
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table">
        <thead><tr>
          <th>Week</th>
          <th>Sales</th><th>Revenue</th><th>COGS+Fees</th>
          <th>Expenses</th><th>Gross</th><th>Net</th>
        </tr></thead>
        <tbody>${f}</tbody>
      </table>
    </div>`:"",O=i.length?`
    <div class="period-section-ttl">Sales This Period (${i.length})</div>
    <div style="overflow-x:auto">
      <table class="inv-table">
        <thead><tr><th>Item</th><th>Date</th><th>Qty</th><th>Price</th><th>Net Profit</th></tr></thead>
        <tbody>${[...i].sort((D,P)=>new Date(P.date)-new Date(D.date)).map(D=>{const P=q(D.itemId),z=(D.price||0)*(D.qty||0)-(P?(P.cost||0)*(D.qty||0):0)-(D.fees||0)-(D.ship||0);return`<tr>
            <td><div class="item-name" style="cursor:${P?"pointer":"default"}" ${P?`onclick="openDrawer('${_(P.id)}')"`:""}>${P?_(P.name):"Deleted Item"}</div></td>
            <td style="color:var(--muted);font-size:11px">${ce(D.date)}</td>
            <td>${D.qty}</td>
            <td>${x(D.price)}</td>
            <td style="font-weight:700;color:${z>=0?"var(--good)":"var(--danger)"}">${x(z)}</td>
          </tr>`}).join("")}</tbody>
      </table>
    </div>`:'<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">No sales in this period.</div>',G=o.length?`
    <div class="period-section-ttl" style="margin-top:20px">Expenses This Period (${o.length})</div>
    <div style="overflow-x:auto">
      <table class="inv-table">
        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>${[...o].sort((D,P)=>new Date(P.date)-new Date(D.date)).map(D=>{const P=fl[D.category]||"exp-other";return`<tr>
            <td style="color:var(--muted);font-size:11px">${ce(D.date)}</td>
            <td><span class="exp-cat-badge ${P}">${D.category}</span></td>
            <td>${_(D.description)}</td>
            <td style="text-align:right;font-family:'DM Mono',monospace;font-weight:600;color:var(--danger)">${x(D.amount)}</td>
          </tr>`}).join("")}</tbody>
      </table>
    </div>`:"";t.innerHTML=`
    <div class="panel" style="animation:none">
      <div class="panel-header" style="margin-bottom:0">
        <div class="panel-title">Reports</div>
        <button class="btn-secondary" style="font-size:11px" onclick="goToAddExpense()">+ Add Expense</button>
      </div>

      <!-- Mode tabs -->
      <div class="report-tabs" style="margin-top:14px">
        <button class="report-tab "  onclick="setReportMode('weekly')">Weekly</button>
        <button class="report-tab active" onclick="setReportMode('monthly')">Monthly</button>
        <button class="report-tab" id="plTabBtn" onclick="showPLReport()">P&amp;L Statement</button>
      </div>

      <!-- Period nav -->
      <div class="period-nav">
        <button class="period-nav-btn" onclick="shiftPeriod(-1)"> Prev</button>
        <div class="period-label">${s}</div>
        <button class="period-nav-btn" onclick="shiftPeriod(1)" disabled style="opacity:0.3;cursor:default">Next </button>
      </div>

      ${g}
      ${E}
      ${C}
      ${B}
      ${L}
      ${O}
      ${G}
    </div>
    <div id="plReportContent" style="display:none"></div>`}function my(t,e){const n=new Date;let s,i,o;{const r=n.getFullYear(),a=n.getMonth()+e,c=new Date(r,a,1);s=new Date(c.getFullYear(),c.getMonth(),1),i=new Date(c.getFullYear(),c.getMonth()+1,0,23,59,59),o=s.toLocaleString("default",{month:"long",year:"numeric"})}return{start:s,end:i,label:o}}function gy(t,e,n){{const s=[];let i=new Date(e);for(i.setHours(0,0,0,0);i<=n;){let o=new Date(i);o.setDate(i.getDate()+6),o.setHours(23,59,59,999);const r=o>n?new Date(n):o,a=I.filter(m=>{const v=new Date(m.date);return v>=i&&v<=r}),c=Q.filter(m=>{const v=new Date(m.date);return v>=i&&v<=r});let l=0,d=0,u=0;for(const m of a){const v=q(m.itemId);l+=(m.price||0)*(m.qty||0),d+=v?(v.cost||0)*(m.qty||0):0,u+=(m.fees||0)+(m.ship||0)}const p=l-d-u,h=c.reduce((m,v)=>m+(v.amount||0),0),f=p-h,g=`${i.toLocaleDateString("en-US",{month:"short",day:"numeric"})}${r.toLocaleDateString("en-US",{day:"numeric"})}`;if(s.push(`<tr>
        <td style="font-size:11px;color:var(--muted)">${g}</td>
        <td>${a.length}</td>
        <td>${x(l)}</td>
        <td style="color:var(--muted)">${x(d+u)}</td>
        <td style="color:var(--danger)">${h>0?x(h):""}</td>
        <td style="color:${p>=0?"var(--good)":"var(--danger)"}">${x(p)}</td>
        <td style="font-weight:700;color:${f>=0?"var(--good)":"var(--danger)"}">${x(f)}</td>
      </tr>`),i=new Date(o),i.setDate(o.getDate()+1),i.setHours(0,0,0,0),s.length>8)break}return s.join("")}}async function yy(t){if(!confirm("Remove this sale? Stock will be restored."))return;const e=I.find(s=>s.id===t);if(e){const s=q(e.itemId);s&&(s.qty+=e.qty||0)}const n=I.findIndex(s=>s.id===t);n!==-1&&I.splice(n,1),R(),W(),renderSalesView(),k("Sale removed, stock restored"),await Fs("ft_sales",[t]),Hn()}async function vy(t){const e=$.find(n=>n.id===t);confirm(`Delete "${e==null?void 0:e.name}"?`)&&(softDeleteItem(t),sel.delete(t),R(),W(),k("Item deleted  check  to restore"),await Fs("ft_inventory",[t]),Hn())}function by(){const t=document.getElementById("breakdownContent");if(!$.length){t.innerHTML='<div class="bd-empty"> No inventory yet. Add items to see your breakdown.</div>';return}const e=$.reduce((g,m)=>g+(m.price||0)*(m.qty||0),0),n=$.reduce((g,m)=>g+(m.qty||0),0),s=$.length,i=$.reduce((g,m)=>g+(m.cost||0)*(m.qty||0),0),o=$.reduce((g,m)=>{const{pu:v}=At(m);return g+v*(m.qty||0)},0),r=e?o/e:0,a=new Map;$.forEach(g=>{const m=(g.category||"").trim();if(m){const v=m.toLowerCase();a.has(v)||a.set(v,m)}});const c=g=>a.get((g||"").toLowerCase())||g||d,l={},d="(Uncategorized)";for(const g of $){const m=g.category?c(g.category):d,v=g.subcategory||"",{pu:E}=At(g),w=(g.price||0)*(g.qty||0),S=(g.cost||0)*(g.qty||0),C=E*(g.qty||0);l[m]||(l[m]={value:0,units:0,items:0,cost:0,profit:0,subs:{}}),l[m].value+=w,l[m].units+=g.qty||0,l[m].items+=1,l[m].cost+=S,l[m].profit+=C,v&&(l[m].subs[v]||(l[m].subs[v]={value:0,units:0,items:0,cost:0,profit:0}),l[m].subs[v].value+=w,l[m].subs[v].units+=g.qty||0,l[m].subs[v].items+=1,l[m].subs[v].cost+=S,l[m].subs[v].profit+=C)}const u=Object.entries(l).sort((g,m)=>m[1].value-g[1].value),p=`<div class="bd-col-headers">
    <div></div>
    <div class="bd-col-hdr" style="text-align:left">Category</div>
    <div class="bd-col-hdr">Value</div>
    <div class="bd-col-hdr">Cost Basis</div>
    <div class="bd-col-hdr">Units</div>
    <div class="bd-col-hdr">Items</div>
    <div class="bd-col-hdr">Avg Margin</div>
  </div>`,h=["#57c8ff","#ff6b35","#7b61ff","#57ff9a","#ffb800","#00bcff","#ff4757","#3cb371"],f=u.map(([g,m],v)=>{const E=e?(m.value/e*100).toFixed(1):0,w=m.value?m.profit/m.value:0,S=h[v%h.length],C=Object.keys(m.subs).length>0,B=C?Object.entries(m.subs).sort((L,O)=>O[1].value-L[1].value).map(([L,O])=>{const G=O.value?O.profit/O.value:0;return`<div class="bd-sub-row" onclick="filterToSubcat('${g.replace(/'/g,"\\'")}','${L.replace(/'/g,"\\'")}')">
              <div></div>
              <div>
                <div class="bd-sub-name clickable"> ${_(L)}</div>
                <div style="font-size:9px;color:var(--muted);margin-top:2px">${O.items} item${O.items!==1?"s":""}</div>
                <div class="bd-mobile-stats">
                  <span>${x(O.cost)} cost</span>
                  <span>${O.units} units</span>
                  <span class="margin-badge ${Yt(G)}">${V(G)}</span>
                </div>
              </div>
              <div class="bd-col-val">${x(O.value)}</div>
              <div class="bd-col-val" style="color:var(--muted)">${x(O.cost)}</div>
              <div class="bd-col-units">${O.units}</div>
              <div class="bd-col-units">${O.items}</div>
              <div class="bd-col-m"><span class="margin-badge ${Yt(G)}">${V(G)}</span></div>
            </div>`}).join(""):"";return`<div class="bd-cat-block">
      <div class="bd-cat-row ${C?"has-subs":""}" onclick="${C?`toggleBdSubs('bdsub-${v}')`:`filterToCat('${g.replace(/'/g,"\\'")}')`}">
        <div class="bd-cat-chevron${C?" open-ready":""}">
          ${C?"":""}
        </div>
        <div>
          <div class="bd-cat-name">${_(g)}</div>
          <div class="bd-cat-bar-wrap" style="width:120px">
            <div class="bd-cat-bar-fill" style="width:${E}%;background:${S}"></div>
          </div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">${E}% of total value  ${m.items} item${m.items!==1?"s":""}</div>
          <div class="bd-mobile-stats">
            <span>${x(m.cost)} cost</span>
            <span>${m.units} units</span>
            <span class="margin-badge ${Yt(w)}">${V(w)}</span>
          </div>
        </div>
        <div class="bd-col-val" style="color:${S}">${x(m.value)}</div>
        <div class="bd-col-val" style="color:var(--muted)">${x(m.cost)}</div>
        <div class="bd-col-units">${m.units}</div>
        <div class="bd-col-units">${m.items}</div>
        <div class="bd-col-m"><span class="margin-badge ${Yt(w)}">${V(w)}</span></div>
      </div>
      ${C?`<div class="bd-sub-table" id="bdsub-${v}">${B}</div>`:""}
    </div>`}).join("");t.innerHTML=`
    <div class="panel" style="animation:none;margin-bottom:16px">
      <div class="breakdown-header">
        <div>
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px">Total Inventory Value</div>
          <div class="breakdown-total">${x(e)}</div>
          <div class="breakdown-sub">${s} items  ${n} units in stock  avg ${V(r)} margin</div>
        </div>
        <button class="btn-secondary" onclick="goToBreakdown()" style="font-size:11px"> Refresh</button>
      </div>
      <div class="bd-summary-grid">
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Total Value</div>
          <div class="bd-sum-val" style="color:var(--accent)">${x(e)}</div>
          <div class="bd-sum-sub">${n} units @ list price</div>
        </div>
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Cost Basis</div>
          <div class="bd-sum-val" style="color:var(--warn)">${x(i)}</div>
          <div class="bd-sum-sub">Total invested</div>
        </div>
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Potential Profit</div>
          <div class="bd-sum-val" style="color:var(--good)">${x(o)}</div>
          <div class="bd-sum-sub">If all sold at list price</div>
        </div>
        <div class="bd-sum-card">
          <div class="bd-sum-lbl">Categories</div>
          <div class="bd-sum-val">${u.length}</div>
          <div class="bd-sum-sub">across ${s} items</div>
        </div>
      </div>
    </div>
    <div class="panel" style="animation:none">
      <div class="panel-header">
        <div class="panel-title">By Category</div>
        <span style="font-size:10px;color:var(--muted)">Click a category to filter inventory  click  subcategory to drill down</span>
      </div>
      ${p}
      ${f}
    </div>`,t.innerHTML}function wy(){const t=Date.now()-6048e5;for(let n=ve.length-1;n>=0;n--)ve[n].deletedAt<=t&&ve.splice(n,1);if(!ve.length){k("Trash is empty");return}const e=ve.map((n,s)=>{const i=Math.floor((Date.now()-n.deletedAt)/6e4),o=i<60?i+"m ago":i<1440?Math.floor(i/60)+"h ago":Math.floor(i/1440)+"d ago";return`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${_(n.name)}</div>
        <div style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">${n.sku||""}  ${o}</div>
      </div>
      <button onclick="restoreItem(${s});closeTrashModal()" style="background:none;border:1px solid var(--good);color:var(--good);font-size:10px;padding:4px 10px;cursor:pointer;font-family:'DM Mono',monospace">Restore</button>
    </div>`}).reverse().join("");document.getElementById("trashBody").innerHTML=e,document.getElementById("trashOv").classList.add("on")}function vd(){document.getElementById("trashOv").classList.remove("on")}function xy(){confirm("Permanently delete all "+ve.length+" items?")&&(ve.length=0,_c(),vd(),k("Trash emptied"))}function Zi(t){if(document.querySelectorAll(".bnav-btn").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".bnav-more-item").forEach(n=>n.classList.remove("active")),["bn-more-expenses","bn-more-reports","bn-more-breakdown"].includes(t)){const n=document.getElementById("bn-more");n&&n.classList.add("active");const s=document.getElementById(t);s&&s.classList.add("active")}else{const n=document.getElementById(t);n&&n.classList.add("active")}}function _y(t){t.stopPropagation();const e=document.getElementById("bnavMorePopup"),n=document.getElementById("bnavMoreBackdrop"),s=e.classList.toggle("open");e.style.display=s?"block":"none",n.style.display=s?"block":"none"}function Sy(){const t=document.getElementById("bnavMorePopup"),e=document.getElementById("bnavMoreBackdrop");t.classList.remove("open"),e.classList.remove("open"),t.style.display="none",e.style.display="none"}function Ai(){const t=document.getElementById("bottomNav");t&&(t.style.display=window.innerWidth<=600?"grid":"none")}Ai();window.addEventListener("resize",Ai);(function(){let t=0,e=0,n=!1;const s=document.getElementById("drawer");s.addEventListener("touchstart",i=>{i.touches[0].clientY-s.getBoundingClientRect().top>60||(t=i.touches[0].clientY,n=!0,s.style.transition="none")},{passive:!0}),s.addEventListener("touchmove",i=>{if(!n)return;e=i.touches[0].clientY;const o=Math.max(0,e-t);s.style.transform=`translateY(${o}px)`},{passive:!0}),s.addEventListener("touchend",()=>{if(!n)return;n=!1,s.style.transition="",e-t>120||(s.style.transform="")})})();document.getElementById("currentDate").textContent=new Date().toLocaleDateString("en-US",{weekday:"short",month:"long",day:"numeric",year:"numeric"});let Po=!1,ky=null;function jn(){const t=document.getElementById("offlineBanner");t&&(navigator.onLine?(t.style.display="none",document.body.style.paddingTop="",Po&&ky&&(Po=!1,k("Back online  syncing"),yr().catch(()=>{}))):(t.style.display="",document.body.style.paddingTop="28px",Po=!0))}window.addEventListener("online",jn);window.addEventListener("offline",jn);navigator.onLine||jn();let Fe=[];async function bd(){try{const t=await we("listing_templates");Array.isArray(t)?Fe=t:Fe=[...hl]}catch{Fe=[...hl]}}async function Kr(){try{await te("listing_templates",Fe)}catch(t){console.warn("FlipTrack: template save failed:",t.message)}}function $y(){return Fe}function wd(t){return t?Fe.filter(e=>!e.category||e.category==="All"||e.category.toLowerCase()===t.toLowerCase()):Fe}function Ey(t){return Fe.find(e=>e.id===t)||null}function Iy(t){const e={id:ie(),name:t.name||"Untitled Template",category:t.category||"All",titleFormula:t.titleFormula||"{name}",descriptionTemplate:t.descriptionTemplate||"",platforms:t.platforms||[],tags:t.tags||[],createdAt:Date.now(),isDefault:!1};return Fe.push(e),Kr(),e}function Ty(t,e){const n=Fe.find(s=>s.id===t);return n?(Object.assign(n,e,{id:t}),Kr(),n):null}function Cy(t){const e=Fe.findIndex(n=>n.id===t);return e===-1?!1:(Fe.splice(e,1),Kr(),!0)}const hl=[{id:"tpl-clothing",name:"Clothing  Standard",category:"Clothing",titleFormula:"{name} - {condition} - {subcategory}",descriptionTemplate:`{name}

Condition: {condition}
Category: {category} > {subcategory}
{notes}

Ships fast! Bundle and save. Check out my other listings!`,platforms:[],tags:["clothing","apparel"],isDefault:!0},{id:"tpl-books",name:"Books  Standard",category:"Books",titleFormula:"{name} by {author} - {condition}",descriptionTemplate:`{name}
Author: {author}
ISBN: {isbn}
Condition: {condition}

{notes}

Ships in 1-2 business days. Check my store for more titles!`,platforms:[],tags:["books","reading"],isDefault:!0},{id:"tpl-electronics",name:"Electronics  Standard",category:"Electronics",titleFormula:"{name} - {condition} - Tested & Working",descriptionTemplate:`{name}

Condition: {condition}
UPC: {upc}

{notes}

Tested and verified working. Ships securely padded.
Dimensions: {dimensions}
Weight: {weight}`,platforms:[],tags:["electronics","tech"],isDefault:!0},{id:"tpl-general",name:"General  All Categories",category:"All",titleFormula:"{name} - {condition}",descriptionTemplate:`{name}

Condition: {condition}
{notes}

Fast shipping! Bundle discounts available.`,platforms:[],tags:["general"],isDefault:!0},{id:"tpl-ebay-seo",name:"eBay SEO Optimized",category:"All",titleFormula:"{name} {condition} {category} {subcategory} Ships Free",descriptionTemplate:`{name}

 Condition: {condition}
 Category: {category}
 UPC: {upc}

{notes}

 FAST & FREE SHIPPING 
 30-DAY RETURNS 
 CHECK MY OTHER LISTINGS `,platforms:["eBay"],tags:["ebay","seo"],isDefault:!0},{id:"tpl-posh",name:"Poshmark Style",category:"Clothing",titleFormula:"{name} {subcategory} {condition}",descriptionTemplate:`{name}

{condition} condition
{notes}

 Bundle for discount!
 Offers welcome!
 Ships next business day!`,platforms:["Poshmark"],tags:["poshmark","fashion"],isDefault:!0}],xd=Object.freeze(Object.defineProperty({__proto__:null,addTemplate:Iy,deleteTemplate:Cy,getTemplate:Ey,getTemplates:$y,getTemplatesForCategory:wd,initTemplates:bd,updateTemplate:Ty},Symbol.toStringTag,{value:"Module"})),Py=`${Ui}/functions/v1/ebay-auth`;let Ct=!1,Jn=!1,an=null,Li=null,mt=null,ml=null,or=null;async function Dy(t){or=t;try{const e=await we("ebay_auth");e&&(Ct=e.connected||!1,Jn=e.isSandbox||!1,an=e.ebayUsername||null,Li=e.connectedAt||null),Oy().catch(()=>{})}catch(e){console.warn("FlipTrack: eBay auth init error:",e.message)}}async function By(){if(!or)throw new Error("Not authenticated");const{data:{session:t}}=await or.auth.getSession();if(!t)throw new Error("Session expired  please log in again");return{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`}}async function Ks(t,e={}){const n=await By();n["x-ebay-action"]=t;const s=await fetch(Py,{method:"POST",headers:n,body:JSON.stringify({...e,isSandbox:Jn})}),i=await s.json();if(!s.ok)throw new Error(i.error||`Edge function error: ${s.status}`);return i}async function Oy(){try{const t=await Ks("status");return Ct=t.connected,an=t.ebay_username||null,Li=t.connected_at||null,await te("ebay_auth",{connected:Ct,isSandbox:Jn,ebayUsername:an,connectedAt:Li}),t}catch(t){return console.warn("eBay status check failed:",t.message),{connected:Ct}}}async function Ay(t=!1){Jn=t;try{const e=await Ks("authorize");ml=e.state,await te("ebay_csrf_state",ml);const n=700,s=650,i=Math.round((screen.width-n)/2),o=Math.round((screen.height-s)/2);return mt=window.open(e.authUrl,"ebay-auth",`width=${n},height=${s},left=${i},top=${o},resizable=yes,scrollbars=yes`),mt?(k("Opening eBay authorization"),Ly(),!0):(k("Popup blocked  please allow popups for this site",!0),!1)}catch(e){return k(`eBay connect error: ${e.message}`,!0),!1}}function Ly(){const t=setInterval(()=>{mt&&mt.closed&&(clearInterval(t),mt=null)},500);setTimeout(()=>clearInterval(t),3e5)}async function Ry(t,e){try{const n=await we("ebay_csrf_state");if(e&&n&&e!==n)throw new Error("State mismatch  possible CSRF attack. Please try again.");const s=await Ks("callback",{code:t});s.success&&(Ct=!0,an=s.ebay_username||null,await te("ebay_auth",{connected:!0,isSandbox:Jn,ebayUsername:an,connectedAt:new Date().toISOString()}),await te("ebay_csrf_state",null),k("eBay account connected!"),mt&&!mt.closed&&mt.close(),mt=null,typeof window.renderCrosslistDashboard=="function"&&window.renderCrosslistDashboard())}catch(n){k(`eBay auth error: ${n.message}`,!0)}}async function My(){try{await Ks("disconnect"),Ct=!1,an=null,Li=null,await te("ebay_auth",{connected:!1,isSandbox:Jn,ebayUsername:null,connectedAt:null}),k("eBay account disconnected"),typeof window.renderCrosslistDashboard=="function"&&window.renderCrosslistDashboard()}catch(t){k(`Disconnect error: ${t.message}`,!0)}}function qe(){return Ct}function jy(){return an}async function ln(t,e,n=null){if(!Ct)throw new Error("eBay not connected");return Ks("api",{method:t,path:e,body:n})}const Bs="/sell/inventory/v1",Ny="/sell/fulfillment/v1",gl={new:{id:1e3,name:"New"},"like new":{id:3e3,name:"Like New"},"open box":{id:1500,name:"Open Box"},excellent:{id:2750,name:"Excellent - Refurbished"},"very good":{id:4e3,name:"Very Good"},good:{id:5e3,name:"Good"},acceptable:{id:6e3,name:"Acceptable"},fair:{id:6e3,name:"Acceptable"},poor:{id:7e3,name:"For parts or not working"}};let zn=null,hs=!1,Do=null;async function zy(){zn=await we("ebay_last_sync")}function Uy(){Do&&clearInterval(Do),Do=setInterval(()=>{qe()&&!hs&&_d().catch(t=>console.warn("eBay sync error:",t.message))},3e5)}async function _d(){var t,e,n,s;if(!qe())throw new Error("eBay not connected");if(hs)throw new Error("Sync already in progress");hs=!0;try{let i=0,o=0,r=0,a=0;const c=100;let l=!0;for(;l;){const u=(await ln("GET",`${Bs}/inventory_item?limit=${c}&offset=${a}`)).inventoryItems||[];u.length<c&&(l=!1);for(const p of u){const h=p.sku;let f=$.find(g=>g.sku&&g.sku===h)||$.find(g=>g.ebayItemId&&g.ebayItemId===h);if(f){i++;let g=!1;(!f.ebayItemId||f.ebayItemId!==h)&&(f.ebayItemId=h,g=!0);const m=(t=p.availability)==null?void 0:t.shipToLocationAvailability;m&&(m.quantity||0)===0&&((e=f.platformStatus)==null?void 0:e.eBay)==="active"&&(He(f.id,"eBay","sold"),g=!0);const v=p.product;v&&(!f.name&&v.title&&(f.name=v.title,g=!0),!f.upc&&((n=v.upc)!=null&&n.length)&&(f.upc=v.upc[0],g=!0),(s=v.imageUrls)!=null&&s.length&&(!f.images||!f.images.length)&&(f.images=v.imageUrls,f.image=v.imageUrls[0],g=!0)),g&&(J("inv",f.id),r++)}else o++}a+=c}return await Fy(),zn=new Date().toISOString(),await te("ebay_last_sync",zn),r>0&&(R(),W()),{matched:i,unmatched:o,updated:r}}finally{hs=!1}}async function Fy(){var t,e;try{const s=`creationdate:[${zn?new Date(zn).toISOString():new Date(Date.now()-864e5).toISOString()}..NOW]`,o=(await ln("GET",`${Ny}/order?filter=${encodeURIComponent(s)}&limit=50`)).orders||[];for(const r of o)for(const a of r.lineItems||[]){const c=a.sku;if(!c)continue;const l=$.find(d=>d.ebayItemId===c||d.sku===c);if(l&&((t=l.platformStatus)==null?void 0:t.eBay)!=="sold"){He(l.id,"eBay","sold"),(l.qty||0)<=0&&Er(l.id,"eBay");const d=parseFloat(((e=a.total)==null?void 0:e.value)||"0");d>0&&Pr(l.id,d,"eBay"),J("inv",l.id)}}}catch(n){console.warn("eBay orders sync error:",n.message)}}function qy(t){const e=(t.condition||"good").toLowerCase(),n=gl[e]||gl.good,s={availability:{shipToLocationAvailability:{quantity:t.qty||1}},condition:n.name.toUpperCase().replace(/\s+/g,"_"),conditionDescription:t.notes||void 0,product:{title:(t.name||"Item").slice(0,80),description:Hy(t),aspects:Wy(t),imageUrls:(t.images||[]).filter(i=>i&&i.startsWith("http")).slice(0,12)}};return t.upc&&(s.product.upc=[t.upc]),t.isbn&&(s.product.isbn=[t.isbn]),s}function Hy(t){const e=[];return t.condition&&e.push(`Condition: ${t.condition}`),t.category&&e.push(`Category: ${t.category}`),t.subcategory&&e.push(`Subcategory: ${t.subcategory}`),t.notes&&e.push(t.notes),e.push("Ships fast! Check my other listings for bundle deals."),e.join(`
`)}function Wy(t){const e={};return t.category&&(e.Category=[t.category]),t.condition&&(e.Condition=[t.condition]),t.author&&(e.Author=[t.author]),t.isbn&&(e.ISBN=[t.isbn]),e}async function Sd(t){if(!qe())throw new Error("eBay not connected");const e=q(t);if(!e)throw new Error("Item not found");const n=e.ebayItemId||e.sku||`FT-${t.slice(0,12)}`,s=qy(e);try{return await ln("PUT",`${Bs}/inventory_item/${encodeURIComponent(n)}`,s),e.ebayItemId=n,e.platforms||(e.platforms=[]),e.platforms.includes("eBay")||e.platforms.push("eBay"),e.platformStatus||(e.platformStatus={}),e.platformStatus.eBay="draft",un(t,"eBay",new Date().toISOString().split("T")[0]),J("inv",t),R(),k(`Pushed "${_(e.name)}" to eBay inventory (SKU: ${n})`),{success:!0,sku:n}}catch(i){return k(`eBay push error: ${i.message}`,!0),{success:!1,sku:n}}}async function kd(t,e={}){var r,a;if(!qe())throw new Error("eBay not connected");const n=q(t);if(!n)throw new Error("Item not found");if(!n.ebayItemId)throw new Error("Item not in eBay inventory. Push it first.");const s=n.ebayItemId,i=n.price||0;if(i<=0)throw new Error("Item needs a price before listing");const o={sku:s,marketplaceId:"EBAY_US",format:"FIXED_PRICE",listingDuration:e.listingDuration||"GTC",pricingSummary:{price:{value:i.toFixed(2),currency:"USD"}},availableQuantity:n.qty||1};e.categoryId&&(o.categoryId=e.categoryId);try{const c=await ln("POST",`${Bs}/offer`,o),l=c.offerId;if(!l){const p=((a=(r=c.errors)==null?void 0:r[0])==null?void 0:a.message)||"Could not create offer. Check your eBay business policies.";throw new Error(p)}const u=(await ln("POST",`${Bs}/offer/${l}/publish`)).listingId;return n.platformStatus.eBay="active",n.ebayListingId=u,n.url=u?`https://www.ebay.com/itm/${u}`:n.url,un(t,"eBay",new Date().toISOString().split("T")[0]),J("inv",t),R(),k(`Listed on eBay! Item #${u}`),{success:!0,listingId:u}}catch(c){return k(`eBay listing error: ${c.message}`,!0),{success:!1}}}async function Gy(t){if(!qe())throw new Error("eBay not connected");const e=q(t);if(!e||!e.ebayItemId)throw new Error("Item not on eBay");try{return await ln("PUT",`${Bs}/inventory_item/${encodeURIComponent(e.ebayItemId)}`,{availability:{shipToLocationAvailability:{quantity:0}}}),He(t,"eBay","delisted"),J("inv",t),R(),k("eBay listing ended"),{success:!0}}catch(n){return k(`eBay end listing error: ${n.message}`,!0),{success:!1}}}function Vy(){return hs}function Ky(){return zn}const Jy=`${Ui}/functions/v1/etsy-auth`;let Pt=!1,Dt=null,cn=null,Ri=null,gt=null,yl=null,rr=null;async function Yy(t){rr=t;try{const e=await we("etsy_auth");e&&(Pt=e.connected||!1,Dt=e.shopName||null,cn=e.shopId||null,Ri=e.connectedAt||null),Xy().catch(()=>{})}catch(e){console.warn("FlipTrack: Etsy auth init error:",e.message)}}async function Qy(){if(!rr)throw new Error("Not authenticated");const{data:{session:t}}=await rr.auth.getSession();if(!t)throw new Error("Session expired  please log in again");return{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`}}async function Js(t,e={}){const n=await Qy();n["x-etsy-action"]=t;const s=await fetch(Jy,{method:"POST",headers:n,body:JSON.stringify(e)}),i=await s.json();if(!s.ok)throw new Error(i.error||`Edge function error: ${s.status}`);return i}async function Xy(){try{const t=await Js("status");return Pt=t.connected,Dt=t.shop_name||null,cn=t.shop_id||null,Ri=t.connected_at||null,await te("etsy_auth",{connected:Pt,shopName:Dt,shopId:cn,connectedAt:Ri}),t}catch(t){return console.warn("Etsy status check failed:",t.message),{connected:Pt}}}async function Zy(){try{const t=await Js("authorize");yl=t.state,await te("etsy_csrf_state",yl);const e=700,n=700,s=Math.round((screen.width-e)/2),i=Math.round((screen.height-n)/2);return gt=window.open(t.authUrl,"etsy-auth",`width=${e},height=${n},left=${s},top=${i},resizable=yes,scrollbars=yes`),gt?(k("Opening Etsy authorization"),ev(),!0):(k("Popup blocked  please allow popups for this site",!0),!1)}catch(t){return k(`Etsy connect error: ${t.message}`,!0),!1}}function ev(){const t=setInterval(()=>{gt&&gt.closed&&(clearInterval(t),gt=null)},500);setTimeout(()=>clearInterval(t),3e5)}async function tv(t,e){try{const n=await we("etsy_csrf_state");if(e&&n&&e!==n)throw new Error("State mismatch  possible CSRF attack. Please try again.");const s=await Js("callback",{code:t});s.success&&(Pt=!0,Dt=s.shop_name||null,cn=s.shop_id||null,await te("etsy_auth",{connected:!0,shopName:Dt,shopId:cn,connectedAt:new Date().toISOString()}),await te("etsy_csrf_state",null),k(`Etsy shop "${Dt||"connected"}" linked!`),gt&&!gt.closed&&gt.close(),gt=null,typeof window.renderCrosslistDashboard=="function"&&window.renderCrosslistDashboard())}catch(n){k(`Etsy auth error: ${n.message}`,!0)}}async function nv(){try{await Js("disconnect"),Pt=!1,Dt=null,cn=null,Ri=null,await te("etsy_auth",{connected:!1,shopName:null,shopId:null,connectedAt:null}),k("Etsy shop disconnected"),typeof window.renderCrosslistDashboard=="function"&&window.renderCrosslistDashboard()}catch(t){k(`Disconnect error: ${t.message}`,!0)}}function vt(){return Pt}function sv(){return Dt}function eo(){return cn}async function Ys(t,e,n=null){if(!Pt)throw new Error("Etsy not connected");return Js("api",{method:t,path:e,body:n})}const $d="active",iv="inactive",ov="draft",Bo={who_made:"someone_else",when_made:"2020_2025",is_supply:!1},rv="physical";let Un=null,Ln=!1,Oo=null;async function av(){Un=await we("etsy_last_sync")}function lv(){Oo&&clearInterval(Oo),Oo=setInterval(()=>{vt()&&!Ln&&Ed().catch(t=>console.warn("Etsy sync error:",t.message))},3e5)}async function Ed(){var e,n,s,i;if(!vt())throw new Error("Etsy not connected");if(Ln)throw new Error("Sync already in progress");Ln=!0;const t=eo();if(!t)throw Ln=!1,new Error("No shop ID available. Please reconnect Etsy.");try{let o=0,r=0,a=0,c=0;const l=100;let d=!0;for(;d;){const p=(await Ys("GET",`/application/shops/${t}/listings?state=${$d}&limit=${l}&offset=${c}&includes=Images`)).results||[];p.length<l&&(d=!1);for(const h of p){const f=String(h.listing_id),g=h.skus&&h.skus[0]||null;let m=null;if(g&&(m=$.find(v=>v.sku&&v.sku===g)),m||(m=$.find(v=>v.etsyListingId&&v.etsyListingId===f)),m){o++;let v=!1;(!m.etsyListingId||m.etsyListingId!==f)&&(m.etsyListingId=f,v=!0),h.quantity!==void 0&&(h.quantity||0)===0&&((e=m.platformStatus)==null?void 0:e.Etsy)==="active"&&(He(m.id,"Etsy","sold"),v=!0),!m.name&&h.title&&(m.name=h.title,v=!0),(n=h.images)!=null&&n.length&&(!m.images||!m.images.length)&&(m.images=h.images.sort((E,w)=>E.rank-w.rank).map(E=>E.url_570xN||E.url_fullxfull).filter(Boolean),m.images.length&&(m.image=m.images[0]),v=!0),!m.price&&((s=h.price)!=null&&s.amount)&&(m.price=h.price.amount/h.price.divisor,v=!0),(i=h.tags)!=null&&i.length&&!m.tags&&(m.tags=h.tags,v=!0),v&&(J("inv",m.id),a++)}else r++}c+=l}return await cv(t),Un=new Date().toISOString(),await te("etsy_last_sync",Un),a>0&&(R(),W()),{matched:o,unmatched:r,updated:a}}finally{Ln=!1}}async function cv(t){var e,n;try{const s=Math.floor(Un?new Date(Un).getTime()/1e3:(Date.now()-864e5)/1e3),o=(await Ys("GET",`/application/shops/${t}/receipts?min_created=${s}&limit=50`)).results||[];for(const r of o){const a=r.transactions||[];for(const c of a){const l=String(c.listing_id),d=c.sku||"",u=$.find(p=>p.etsyListingId===l||d&&p.sku===d);if(u&&((e=u.platformStatus)==null?void 0:e.Etsy)!=="sold"){He(u.id,"Etsy","sold"),(u.qty||0)<=0&&Er(u.id,"Etsy");const p=(n=c.price)!=null&&n.amount?c.price.amount/c.price.divisor:0;p>0&&Pr(u.id,p,"Etsy"),J("inv",u.id)}}}}catch(s){console.warn("Etsy receipts sync error:",s.message)}}function dv(t){var n,s;const e={title:(t.name||"Item").slice(0,140),description:uv(t),quantity:t.qty||1,price:t.price||0,who_made:Bo.who_made,when_made:Bo.when_made,is_supply:Bo.is_supply,type:rv,shipping_profile_id:null,taxonomy_id:null};if(t.sku&&(e.sku=t.sku),(n=t.tags)!=null&&n.length)e.tags=t.tags.slice(0,13).map(i=>i.slice(0,20));else{const i=[];if(t.name){const o=t.name.split(/\s+/).filter(r=>r.length>2).slice(0,8);i.push(...o.map(r=>r.slice(0,20)))}t.category&&i.push(t.category.slice(0,20)),t.subcategory&&i.push(t.subcategory.slice(0,20)),e.tags=i.slice(0,13)}return(s=t.materials)!=null&&s.length&&(e.materials=t.materials.slice(0,13).map(i=>i.slice(0,45))),e}function uv(t){const e=[];return t.condition&&e.push(`Condition: ${t.condition}`),t.category&&e.push(`Category: ${t.category}`),t.subcategory&&e.push(`Subcategory: ${t.subcategory}`),t.notes&&e.push(t.notes),e.push(""),e.push("Ships fast! Check my shop for bundle deals and more items."),e.join(`
`)}async function Id(t,e={}){if(!vt())throw new Error("Etsy not connected");const n=eo();if(!n)throw new Error("No shop ID. Please reconnect Etsy.");const s=q(t);if(!s)throw new Error("Item not found");const i=dv(s);if((s.price||0)<=0)throw new Error("Item needs a price before listing");e.taxonomyId&&(i.taxonomy_id=e.taxonomyId),e.shippingProfileId&&(i.shipping_profile_id=e.shippingProfileId);const r=!i.taxonomy_id||!i.shipping_profile_id;r&&(i.state=ov);try{const a=await Ys("POST",`/application/shops/${n}/listings`,i),c=String(a.listing_id);s.etsyListingId=c,s.platforms||(s.platforms=[]),s.platforms.includes("Etsy")||s.platforms.push("Etsy"),s.platformStatus||(s.platformStatus={}),s.platformStatus.Etsy=r?"draft":"active",un(t,"Etsy",new Date().toISOString().split("T")[0]),J("inv",t),R();const l=r?"draft (complete on Etsy)":"active";return k(`Listed "${_(s.name)}" on Etsy as ${l}`),{success:!0,listingId:c,isDraft:r}}catch(a){return k(`Etsy listing error: ${a.message}`,!0),{success:!1}}}async function pv(t){if(!vt())throw new Error("Etsy not connected");const e=eo(),n=q(t);if(!n||!n.etsyListingId)throw new Error("Item not on Etsy");try{return await Ys("PATCH",`/application/shops/${e}/listings/${n.etsyListingId}`,{state:iv}),He(t,"Etsy","delisted"),J("inv",t),R(),k("Etsy listing deactivated"),{success:!0}}catch(s){return k(`Etsy deactivate error: ${s.message}`,!0),{success:!1}}}async function fv(t){if(!vt())throw new Error("Etsy not connected");const e=eo(),n=q(t);if(!n||!n.etsyListingId)return Id(t);try{return await Ys("PATCH",`/application/shops/${e}/listings/${n.etsyListingId}`,{state:$d,quantity:n.qty||1}),He(t,"Etsy","active"),un(t,"Etsy",new Date().toISOString().split("T")[0]),J("inv",t),R(),k("Etsy listing renewed ($0.20 fee)"),{success:!0}}catch(s){return k(`Etsy renew error: ${s.message}`,!0),{success:!1}}}function hv(){return Ln}function mv(){return Un}let st=0;const vi=25;let Mi="",Os="all",As="all",xt="overview";function ne(){const t=document.getElementById("crosslistContent");if(!t)return;Ac();const e=$.filter(r=>(r.qty||0)>0),n=om(e),s=Oc(e,7),i=Ir(e);let o="";if(o+=jv(),o+=Dv(),o+=`<div class="cl-stats-strip">
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--good)">${n.totalActive}</div><div class="cl-stat-lbl">Active</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--warn)">${n.totalExpiringSoon}</div><div class="cl-stat-lbl">Expiring Soon</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--danger)">${n.totalExpired}</div><div class="cl-stat-lbl">Expired</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--accent2)">${n.totalSoldElsewhere}</div><div class="cl-stat-lbl">Sold Elsewhere</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--muted)">${n.itemsNotListed}</div><div class="cl-stat-lbl">Not Listed</div></div>
    <div class="cl-stat"><div class="cl-stat-val" style="color:var(--accent3)">${n.itemsSinglePlatform}</div><div class="cl-stat-lbl">Single Platform</div></div>
  </div>`,o+=`<div class="cl-tabs">
    <button class="cl-tab ${xt==="overview"?"active":""}" onclick="clSwitchTab('overview')">Overview</button>
    <button class="cl-tab ${xt==="matrix"?"active":""}" onclick="clSwitchTab('matrix')">Listing Matrix</button>
    <button class="cl-tab ${xt==="templates"?"active":""}" onclick="clSwitchTab('templates')">Templates</button>
  </div>`,xt==="overview"?o+=gv(e,s,i,n):xt==="matrix"?o+=yv(e):xt==="templates"&&(o+=vv()),t.innerHTML=o,xt==="matrix"){const r=document.getElementById("clPagination"),a=Td(e);r&&Vn(r,{page:st,totalItems:a.length,pageSize:vi,onPage:c=>{st=c,ne()}})}}function gv(t,e,n,s){let i="";if(e.length){i+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--warn)"> Expiring Soon (${e.length})</h3>
      <div class="cl-cards">`;for(const{item:o,platform:r,daysLeft:a,expiryDate:c}of e.slice(0,10))i+=`<div class="cl-card cl-card-warn">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${o.id}')">${_(o.name)}</span>
          <span class="cl-card-days">${a}d left</span>
        </div>
        <div class="cl-card-plat">${_(r)}</div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="clRelistItem('${o.id}','${_(r)}')">Relist</button>
          <button class="btn-sm btn-muted" onclick="clOpenLink('${_(r)}','${o.id}')">Open </button>
        </div>
      </div>`;i+="</div></div>"}if(n.length){i+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--danger)"> Expired Listings (${n.length})</h3>
      <button class="btn-sm btn-accent" style="margin-bottom:8px" onclick="clBulkRelistExpired()">Relist All Expired</button>
      <div class="cl-cards">`;for(const{item:o,platform:r,expiryDate:a}of n.slice(0,12)){const c=Math.ceil((Date.now()-new Date(a).getTime())/864e5);i+=`<div class="cl-card cl-card-danger">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${o.id}')">${_(o.name)}</span>
          <span class="cl-card-days">${c}d ago</span>
        </div>
        <div class="cl-card-plat">${_(r)}</div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="clRelistItem('${o.id}','${_(r)}')">Relist</button>
          <button class="btn-sm btn-danger" onclick="clDelistItem('${o.id}','${_(r)}')">Delist</button>
        </div>
      </div>`}i+="</div></div>"}if(s.itemsNotListed>0){const o=t.filter(r=>Y(r).length===0).slice(0,8);i+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--muted)"> Not Listed Anywhere (${s.itemsNotListed})</h3>
      <div class="cl-cards">`;for(const r of o)i+=`<div class="cl-card">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${r.id}')">${_(r.name)}</span>
          <span class="cl-card-days">${x(r.price||0)}</span>
        </div>
        <div class="cl-card-plat" style="color:var(--muted)">No platforms assigned</div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="openDrawer('${r.id}')">Edit & List</button>
        </div>
      </div>`;i+="</div></div>"}if(s.itemsSinglePlatform>0){const o=t.filter(r=>Y(r).length===1).slice(0,6);i+=`<div class="cl-section">
      <h3 class="cl-section-title" style="color:var(--accent3)"> Single Platform (${s.itemsSinglePlatform})</h3>
      <p style="color:var(--muted);font-size:12px;margin-bottom:8px">These items could reach more buyers if crosslisted</p>
      <div class="cl-cards">`;for(const r of o){const a=Y(r)[0];i+=`<div class="cl-card">
        <div class="cl-card-header">
          <span class="cl-card-name" onclick="openDrawer('${r.id}')">${_(r.name)}</span>
          <span class="cl-card-days">${_(a)}</span>
        </div>
        <div class="cl-card-actions">
          <button class="btn-sm btn-accent" onclick="openDrawer('${r.id}')">Add Platforms</button>
        </div>
      </div>`}i+="</div></div>"}return!e.length&&!n.length&&s.itemsNotListed===0&&(i+=`<div class="cl-section" style="text-align:center;padding:32px">
      <div style="font-size:24px;margin-bottom:8px"></div>
      <div style="color:var(--good);font-weight:600;font-size:14px;margin-bottom:4px">All Listings Healthy</div>
      <div style="color:var(--muted);font-size:12px">No expired or expiring listings. Check the Matrix tab for a full status overview.</div>
    </div>`),i}function Td(t){let e=t;if(Mi){const n=Mi.toLowerCase();e=e.filter(s=>s.name.toLowerCase().includes(n)||(s.sku||"").toLowerCase().includes(n))}return Os!=="all"&&(e=e.filter(n=>Y(n).includes(Os))),As!=="all"&&(e=e.filter(n=>{const s=n.platformStatus||{};return Object.values(s).includes(As)})),e}function yv(t){const e=new Set;for(const a of t)for(const c of Y(a))e.add(c);const n=[...e].sort();let s="";s+=`<div class="cl-filters">
    <input type="text" placeholder="Search items..." value="${_(Mi)}"
           oninput="clSetSearch(this.value)"
           class="cl-filter-input">
    <select onchange="clSetPlatFilter(this.value)" class="cl-filter-select">
      <option value="all" ${Os==="all"?"selected":""}>All Platforms</option>
      ${n.map(a=>`<option value="${_(a)}" ${Os===a?"selected":""}>${_(a)}</option>`).join("")}
    </select>
    <select onchange="clSetStatusFilter(this.value)" class="cl-filter-select">
      <option value="all" ${As==="all"?"selected":""}>All Statuses</option>
      ${im.map(a=>`<option value="${a}" ${As===a?"selected":""}>${Qo[a]}</option>`).join("")}
    </select>
  </div>`;const i=Td(t),o=Math.ceil(i.length/vi);st>=o&&(st=Math.max(0,o-1));const r=i.slice(st*vi,(st+1)*vi);if(!r.length)return s+='<div style="text-align:center;padding:24px;color:var(--muted)">No items match filters</div>',s;s+='<div class="cl-matrix-list">';for(const a of r){const c=Y(a),l=a.platformStatus||{},d=a.platformListingDates||{};Lc(a),s+=`<div class="cl-matrix-item">
      <div class="cl-matrix-header" onclick="openDrawer('${a.id}')">
        <span class="cl-matrix-name">${_(a.name)}</span>
        <span class="cl-matrix-meta">${x(a.price||0)}  Qty: ${a.qty||0}</span>
      </div>
      <div class="cl-matrix-platforms">`;for(const u of c){const p=l[u]||"active",h=Bc(u,d[u]),f=h!==null?h<0?`<span style="color:var(--danger)">${Math.abs(h)}d expired</span>`:h<=7?`<span style="color:var(--warn)">${h}d left</span>`:`<span style="color:var(--muted)">${h}d</span>`:"";s+=`<div class="cl-plat-row">
          <div class="cl-plat-info">
            <span class="cl-plat-dot" style="background:${Dc[p]||"var(--muted)"}"></span>
            <span class="cl-plat-name">${_(u)}</span>
            <span class="cl-plat-status">${Qo[p]||p}</span>
            ${f}
          </div>
          <div class="cl-plat-actions">
            <button class="btn-xs" onclick="clCycleStatus('${a.id}','${_(u)}')" title="Change status"></button>
            <button class="btn-xs" onclick="clCopyListing('${a.id}')" title="Copy listing text"></button>
            <button class="btn-xs" onclick="clOpenLink('${_(u)}','${a.id}')" title="Open platform"></button>
            ${p==="expired"?`<button class="btn-xs btn-accent" onclick="clRelistItem('${a.id}','${_(u)}')">Relist</button>`:""}
          </div>
        </div>`}qe()&&!c.includes("eBay")&&(s+=`<div class="cl-plat-row" style="border-top:1px dashed var(--border)">
        <div class="cl-plat-info" style="color:var(--accent)">
          <span class="cl-plat-name">eBay</span>
          <span class="cl-plat-status" style="color:var(--muted)">Not listed</span>
        </div>
        <div class="cl-plat-actions">
          <button class="btn-xs btn-accent" onclick="clPushToEBay('${a.id}')">List on eBay</button>
        </div>
      </div>`),vt()&&!c.includes("Etsy")&&(s+=`<div class="cl-plat-row" style="border-top:1px dashed var(--border)">
        <div class="cl-plat-info" style="color:#f56400">
          <span class="cl-plat-name">Etsy</span>
          <span class="cl-plat-status" style="color:var(--muted)">Not listed</span>
        </div>
        <div class="cl-plat-actions">
          <button class="btn-xs btn-etsy" onclick="clPushToEtsy('${a.id}')">List on Etsy</button>
        </div>
      </div>`),!c.length&&!qe()&&!vt()&&(s+=`<div class="cl-plat-row" style="color:var(--muted);font-style:italic">No platforms  <span onclick="openDrawer('${a.id}')" style="color:var(--accent);cursor:pointer">add some</span></div>`),s+="</div></div>"}return s+="</div>",s+='<div id="clPagination"></div>',s}function vv(){const t=wd(null);let e=`<div class="cl-section">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 class="cl-section-title" style="margin:0">Listing Templates</h3>
      <button class="btn-sm btn-accent" onclick="clAddTemplate()">+ New Template</button>
    </div>
    <p style="color:var(--muted);font-size:12px;margin-bottom:12px">Templates auto-fill title & description when listing. Use placeholders: {name}, {condition}, {category}, {price}, {notes}, {upc}, {author}, {isbn}</p>`;if(!t.length)e+='<div style="text-align:center;padding:24px;color:var(--muted)">No templates yet. Click "+ New Template" to create one.</div>';else{e+='<div class="cl-template-grid">';for(const n of t)e+=`<div class="cl-template-card">
        <div class="cl-template-header">
          <span class="cl-template-name">${_(n.name)}</span>
          ${n.isDefault?'<span class="cl-template-badge">Default</span>':`<button class="btn-xs btn-danger" onclick="clDeleteTemplate('${n.id}')"></button>`}
        </div>
        <div class="cl-template-category">${_(n.category||"All Categories")}</div>
        <div class="cl-template-preview">
          <div style="font-weight:600;font-size:11px;color:var(--accent);margin-bottom:2px">Title:</div>
          <div style="font-size:11px;color:var(--text)">${_(n.titleFormula)}</div>
          <div style="font-weight:600;font-size:11px;color:var(--accent);margin-top:6px;margin-bottom:2px">Description:</div>
          <div style="font-size:10px;color:var(--muted);white-space:pre-line;max-height:60px;overflow:hidden">${_((n.descriptionTemplate||"").slice(0,150))}</div>
        </div>
      </div>`;e+="</div>"}return e+="</div>",e}function bv(t){xt=t,st=0,ne()}function wv(t){Mi=t||"",st=0,ne()}function xv(t){Os=t||"all",st=0,ne()}function _v(t){As=t||"all",st=0,ne()}function Sv(t,e){Ki(t,e),R(),W(),k(`Relisted on ${e} `),ne()}function kv(t,e){He(t,e,"delisted"),R(),W(),k(`Delisted from ${e}`),ne()}function $v(t,e){const n=$.find(a=>a.id===t);if(!n)return;const i=(n.platformStatus||{})[e]||"active",o=["active","sold","delisted","expired","draft"],r=o[(o.indexOf(i)+1)%o.length];He(t,e,r),r==="active"&&un(t,e,new Date().toISOString().split("T")[0]),R(),W(),ne()}function Ev(t,e){const n=$.find(i=>i.id===e);if(!n)return;const s=Mc(t,n);window.open(s,"_blank")}function Iv(t){const e=$.find(n=>n.id===t);e&&jc(e)}function Tv(){const t=$.filter(n=>(n.qty||0)>0),e=Ir(t);if(!e.length){k("No expired listings to relist");return}if(confirm(`Relist ${e.length} expired listing(s)?`)){for(const{item:n,platform:s}of e)Ki(n.id,s);R(),W(),k(`${e.length} listing(s) relisted `),ne()}}function Cv(){const t=prompt("Template name:");if(!t)return;const e=prompt('Category (or "All"):',"All"),n=prompt("Title formula (use {name}, {condition}, etc.):","{name} - {condition}");if(!n)return;const s=prompt("Description template:",`{name}
Condition: {condition}
{notes}`);ct(()=>Promise.resolve().then(()=>xd),void 0,import.meta.url).then(i=>{i.addTemplate({name:t,category:e,titleFormula:n,descriptionTemplate:s||""}),k("Template created "),ne()})}function Pv(t){confirm("Delete this template?")&&ct(()=>Promise.resolve().then(()=>xd),void 0,import.meta.url).then(e=>{e.deleteTemplate(t),k("Template deleted"),ne()})}function Dv(){const t=vt(),e=sv(),n=hv(),s=mv(),i=s?new Date(s).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never";return t?`<div class="etsy-panel etsy-connected">
      <div class="etsy-panel-left">
        <div class="etsy-panel-status">
          <span class="etsy-dot etsy-dot-on"></span>
          <strong>Etsy Connected</strong>
          ${e?`<span class="etsy-shop">(${_(e)})</span>`:""}
        </div>
        <div class="etsy-panel-meta">Last sync: ${_(i)}</div>
      </div>
      <div class="etsy-panel-actions">
        <button class="btn-sm btn-etsy" onclick="clEtsySync()" ${n?"disabled":""}>
          ${n?" Syncing":" Sync Now"}
        </button>
        <button class="btn-sm btn-muted" onclick="clEtsyDisconnect()">Disconnect</button>
      </div>
    </div>`:`<div class="etsy-panel">
    <div class="etsy-panel-left">
      <div class="etsy-panel-status">
        <span class="etsy-dot"></span>
        <strong>Etsy</strong>
        <span class="etsy-shop" style="color:var(--muted)">Not connected</span>
      </div>
      <div class="etsy-panel-meta">Connect your shop to sync listings, track sales, and manage inventory</div>
    </div>
    <div class="etsy-panel-actions">
      <button class="btn-sm btn-etsy" onclick="clEtsyConnect()">Connect Etsy Shop</button>
    </div>
  </div>`}function Bv(){Zy()}function Ov(){confirm("Disconnect your Etsy shop? You can reconnect anytime.")&&nv()}async function Av(){k("Syncing Etsy listings"),ne();try{const t=await Ed();k(`Etsy sync complete  ${t.matched} matched, ${t.updated} updated`)}catch(t){k(`Etsy sync error: ${t.message}`,!0)}ne()}async function Lv(t){(await Id(t)).success&&ne()}async function Rv(t){if(!confirm("Deactivate this Etsy listing?"))return;(await pv(t)).success&&(W(),ne())}async function Mv(t){if(!confirm("Renew this Etsy listing? ($0.20 fee applies)"))return;(await fv(t)).success&&(W(),ne())}function jv(){const t=qe(),e=jy(),n=Vy(),s=Ky(),i=s?new Date(s).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never";return t?`<div class="ebay-panel ebay-connected">
      <div class="ebay-panel-left">
        <div class="ebay-panel-status">
          <span class="ebay-dot ebay-dot-on"></span>
          <strong>eBay Connected</strong>
          ${e?`<span class="ebay-user">(${_(e)})</span>`:""}
        </div>
        <div class="ebay-panel-meta">Last sync: ${_(i)}</div>
      </div>
      <div class="ebay-panel-actions">
        <button class="btn-sm btn-accent" onclick="clEBaySync()" ${n?"disabled":""}>
          ${n?" Syncing":" Sync Now"}
        </button>
        <button class="btn-sm btn-muted" onclick="clEBayDisconnect()">Disconnect</button>
      </div>
    </div>`:`<div class="ebay-panel">
    <div class="ebay-panel-left">
      <div class="ebay-panel-status">
        <span class="ebay-dot"></span>
        <strong>eBay</strong>
        <span class="ebay-user" style="color:var(--muted)">Not connected</span>
      </div>
      <div class="ebay-panel-meta">Connect to list items, sync status, and track sales directly</div>
    </div>
    <div class="ebay-panel-actions">
      <button class="btn-sm btn-accent" onclick="clEBayConnect()">Connect eBay Account</button>
    </div>
  </div>`}function Nv(){Ay(!1)}function zv(){confirm("Disconnect your eBay account? You can reconnect anytime.")&&My()}async function Uv(){k("Syncing eBay listings"),ne();try{const t=await _d();k(`eBay sync complete  ${t.matched} matched, ${t.updated} updated`)}catch(t){k(`eBay sync error: ${t.message}`,!0)}ne()}async function Fv(t){(await Sd(t)).success&&ne()}async function qv(t){(await kd(t)).success&&(W(),ne())}async function Hv(t){if(!confirm("End this eBay listing?"))return;(await Gy(t)).success&&(W(),ne())}const Et={firstClass:{basePrice:1.01,incrementalPrice:.24},priorityMail:{zones:{1:[4.3,4.71,5.2,5.85,6.5,7.15,7.8],2:[4.3,4.71,5.2,5.85,6.5,7.15,7.8],3:[4.33,4.75,5.32,6.12,6.92,7.72,8.52],4:[4.4,4.88,5.57,6.56,7.55,8.54,9.53],5:[4.57,5.12,5.98,7.2,8.42,9.64,10.86],6:[4.77,5.43,6.48,8,9.52,11.04,12.56],7:[5.02,5.82,7.1,8.92,10.74,12.56,14.38],8:[5.3,6.25,7.78,9.92,12.06,14.2,16.34]},weightBreaks:[1,2,3,5,10,20,70]}};function Cd(t){if(!t)return null;const e=parseFloat(t.weight)||0,n=t.dimUnit||"oz",i=n==="g"||n==="kg"?e*.035274:e;if(i>0&&i<=13){const o=Et.firstClass.basePrice+Math.max(0,i-1)*Et.firstClass.incrementalPrice;return{carrier:"USPS",service:"First Class Mail",estimatedCost:Math.round(o*100)/100,range:`${i}oz`}}if(i>0){const r=Et.priorityMail.weightBreaks;let a=r.findIndex(d=>i<=d);return a===-1&&(a=r.length-1),{carrier:"USPS",service:"Priority Mail",estimatedCost:Et.priorityMail.zones[5][a],range:`${i.toFixed(1)}oz`}}return{carrier:"USPS",service:"First Class Mail",estimatedCost:1.01,range:"light"}}function Jr(t){if(!t)return null;const e=parseFloat(t.dimL)||0,n=parseFloat(t.dimW)||0,s=parseFloat(t.dimH)||0;if(parseFloat(t.weight),t.dimUnit,e<=11&&n<=8.5&&s<=5.5)return{name:"Small Flat Rate",type:"USPS Flat Rate",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:7.65,carrier:"USPS"};if(e<=11&&n<=8.5&&s<=5.5)return{name:"Medium Flat Rate",type:"USPS Flat Rate",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:14.75,carrier:"USPS"};if(e<=12&&n<=12&&s<=8)return{name:"Large Flat Rate",type:"USPS Flat Rate",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:20.85,carrier:"USPS"};const i=Cd(t);return{name:"Priority Mail Box",type:"Priority Mail",dimensions:`${e}" x ${n}" x ${s}"`,estimatedCost:i?i.estimatedCost:7.5,carrier:"USPS"}}function Wv(t){if(!t)return[];const e=parseFloat(t.weight)||0;parseFloat(t.price);const n=t.dimUnit||"oz",i=n==="g"||n==="kg"?e*.035274:e,o=[];if(i>0&&i<=13){const a=Et.firstClass.basePrice+Math.max(0,i-1)*Et.firstClass.incrementalPrice;o.push({carrier:"USPS",service:"First Class Mail",estimatedCost:Math.round(a*100)/100,notes:"Fast & cheap for light items"})}if(i>0){const c=Et.priorityMail.weightBreaks;let l=c.findIndex(u=>i<=u);l===-1&&(l=c.length-1);const d=Et.priorityMail.zones[5][l];o.push({carrier:"USPS",service:"Priority Mail",estimatedCost:d,notes:"2-3 day delivery"})}t.category&&(t.category.toLowerCase().includes("book")||t.category.toLowerCase().includes("dvd"))&&o.push({carrier:"USPS",service:"Media Mail",estimatedCost:2.96,notes:"Cheapest for media"});const r=Jr(t);if(r&&r.type==="USPS Flat Rate"&&o.push({carrier:"USPS",service:r.name,estimatedCost:r.estimatedCost,notes:"Fixed price, any weight up to limit"}),i>16){const a=12.5+Math.max(0,i/16-1)*2.5;o.push({carrier:"UPS",service:"Ground",estimatedCost:Math.round(a*100)/100,notes:"Good for heavy packages"})}if(i>8){const a=11.75+Math.max(0,i/16-1)*2.25;o.push({carrier:"FedEx",service:"Ground",estimatedCost:Math.round(a*100)/100,notes:"Alternative carrier option"})}return o}const Pd="ft_seller_info";function Yr(){const t=localStorage.getItem(Pd);if(t)try{return JSON.parse(t)}catch{return ar()}return ar()}function Gv(t){const n={...ar(),...t};localStorage.setItem(Pd,JSON.stringify(n))}function ar(){return{businessName:"FlipTrack Reseller",name:localStorage.getItem("ft_seller_name")||"Your Name",address:localStorage.getItem("ft_seller_address")||"123 Main St",city:localStorage.getItem("ft_seller_city")||"City",state:localStorage.getItem("ft_seller_state")||"ST",zip:localStorage.getItem("ft_seller_zip")||"12345",phone:localStorage.getItem("ft_seller_phone")||"",email:localStorage.getItem("ft_seller_email")||"",website:localStorage.getItem("ft_seller_website")||""}}const Dd="ft_thank_you_message";function Qr(){return localStorage.getItem(Dd)||Kv()}function Vv(t){localStorage.setItem(Dd,t)}function Kv(){return"Thank you for your purchase! Please leave feedback if you are satisfied with your order."}function Bd(t,e){if(!e)return;const n=q(e.itemId),s=Yr(),i=Qr(),o=Od({sale:e,item:n,seller:s,thankYou:i,pageNumber:1,totalPages:1});Ad(o,`slip-${t}`)}function Jv(t,e){if(!e||e.length===0)return;const n=Yr(),s=Qr(),o=e.map((r,a)=>{const c=q(r.itemId);return Od({sale:r,item:c,seller:n,thankYou:s,pageNumber:a+1,totalPages:e.length,pageBreak:a<e.length-1})}).join("");Ad(o,`batch-slip-${Date.now()}`)}function Od(t){const{sale:e,item:n,seller:s,thankYou:i,pageNumber:o,totalPages:r,pageBreak:a}=t,c=n?_(n.name):"Unknown Item",l=n?_(n.sku||n.id||""):"",d=_(e.buyerName||"Buyer"),u=_(e.buyerAddress||""),p=_(e.buyerCity||""),h=_(e.buyerState||""),f=_(e.buyerZip||""),g=`${_(s.businessName)}<br>${_(s.name)}<br>${_(s.address)}<br>${_(s.city)}, ${_(s.state)} ${_(s.zip)}`;return`
    <div style="page-break-after:${a?"always":"avoid"};padding:40px;font-family:'Syne','DM Mono',monospace;max-width:600px;margin:0 auto;color:#000;background:#fff">
      <!-- Header -->
      <div style="border-bottom:2px solid #333;padding-bottom:20px;margin-bottom:20px">
        <h1 style="margin:0;font-size:28px;font-weight:900;letter-spacing:-1px">PACKING SLIP</h1>
        <p style="margin:4px 0 0 0;font-size:11px;color:#666">#${_(e.id.slice(0,8).toUpperCase())}</p>
      </div>

      <!-- Two-column header: Seller | Date/Order -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px;font-size:11px">
        <div>
          <p style="margin:0 0 10px 0;font-weight:700;color:#666">FROM:</p>
          <div style="line-height:1.6;font-size:10px">${g}</div>
        </div>
        <div>
          <p style="margin:0 0 6px 0;font-weight:700">Order Date</p>
          <p style="margin:0 0 12px 0;font-size:13px;font-weight:600">${ce(e.date)}</p>

          <p style="margin:0 0 6px 0;font-weight:700">Qty</p>
          <p style="margin:0;font-size:13px;font-weight:600">${e.qty||1}</p>
        </div>
      </div>

      <!-- Shipping To -->
      <div style="background:#f5f5f5;padding:16px;margin-bottom:24px;border-left:3px solid #007bff">
        <p style="margin:0 0 8px 0;font-weight:700;font-size:12px">SHIP TO:</p>
        <p style="margin:0;font-weight:600;font-size:13px">${d}</p>
        <p style="margin:4px 0 0 0;font-size:11px;line-height:1.5">
          ${u}
          ${p?"<br>"+p:""}
          ${h?(p?", ":"<br>")+h:""}
          ${f?" "+f:""}
        </p>
      </div>

      <!-- Item Details -->
      <div style="margin-bottom:24px">
        <p style="margin:0 0 10px 0;font-weight:700;font-size:12px">ITEMS INCLUDED:</p>
        <table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="border-bottom:1px solid #ccc">
              <th style="text-align:left;padding:8px 0;font-weight:700">Description</th>
              <th style="text-align:center;padding:8px 0;font-weight:700;width:60px">Qty</th>
              <th style="text-align:left;padding:8px 0;font-weight:700;width:80px">SKU</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid #eee">
              <td style="padding:10px 0;word-break:break-word">${c}</td>
              <td style="text-align:center;padding:10px 0">${e.qty||1}</td>
              <td style="padding:10px 0;font-family:'DM Mono',monospace;font-size:10px">${l}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Summary -->
      <div style="background:#f9f9f9;padding:12px;border-left:3px solid #7b61ff;margin-bottom:24px;font-size:11px">
        <div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:8px">
          <span>Sale Price:</span>
          <span style="font-weight:600">${x(e.price||0)}</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:8px">
          <span>Fees:</span>
          <span style="font-weight:600">${x(e.fees||0)}</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:16px;border-top:1px solid #ddd;padding-top:8px">
          <span>Net (before ship):</span>
          <span style="font-weight:700;font-size:12px">${x((e.price||0)-(e.fees||0))}</span>
        </div>
      </div>

      <!-- Thank You Message -->
      <div style="background:#fffacd;padding:14px;border-left:3px solid #ffc107;margin-bottom:24px;font-size:11px;line-height:1.6;color:#333">
        <p style="margin:0;font-weight:600;margin-bottom:6px">Thank You!</p>
        <p style="margin:0">${_(i)}</p>
      </div>

      <!-- Platform & Tracking info (if shipped) -->
      ${e.shipped?`
        <div style="font-size:10px;color:#666;border-top:1px solid #eee;padding-top:12px">
          <p style="margin:0"><strong>Shipped via:</strong> ${_(e.carrier||"")} ${e.platform?"("+_(e.platform)+")":""}</p>
          ${e.trackingNumber?`<p style="margin:4px 0 0 0"><strong>Tracking:</strong> ${_(e.trackingNumber)}</p>`:""}
        </div>
      `:""}

      <!-- Footer -->
      <div style="border-top:1px solid #ccc;margin-top:24px;padding-top:12px;font-size:9px;color:#999;text-align:center">
        <p style="margin:0">Generated by FlipTrack  Page ${o} of ${r}</p>
        <p style="margin:4px 0 0 0">${new Date().toLocaleString()}</p>
      </div>
    </div>
  `}function Ad(t,e){const n=window.open("",e,"height=800,width=600");if(!n){console.warn("Unable to open print window  popup may be blocked");return}n.document.write(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Packing Slip</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Syne', monospace;
          background: #f5f5f5;
          padding: 20px;
        }
        @media print {
          body { background: white; padding: 0; }
          @page { margin: 0.5in; }
        }
      </style>
    </head>
    <body>
      ${t}
      <script>
        window.addEventListener('load', () => {
          setTimeout(() => window.print(), 500);
        });
      <\/script>
    </body>
    </html>
  `),n.document.close()}function Yv(){const t=document.getElementById("modals-root");if(!t||document.getElementById("packingSlipSettingsModal"))return;const e=Yr();t.insertAdjacentHTML("beforeend",`
    <div id="packingSlipSettingsModal" class="overlay">
      <div class="modal" style="max-width:500px">
        <div class="modal-header">
          <h3>Packing Slip Settings</h3>
          <button onclick="closePackingSlipSettings()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px"></button>
        </div>
        <div class="modal-body" style="padding:14px;max-height:70vh;overflow-y:auto;display:grid;gap:12px">

          <div style="border-bottom:1px solid var(--border);padding-bottom:12px">
            <h4 style="font-size:12px;font-weight:700;margin-bottom:10px;color:var(--text)">Business Info</h4>

            <div class="fgrp" style="margin-bottom:10px">
              <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Business Name</label>
              <input id="ps_businessName" type="text" value="${_(e.businessName)}" placeholder="Your Shop Name" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
            </div>

            <div class="fgrp" style="margin-bottom:10px">
              <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Your Name</label>
              <input id="ps_name" type="text" value="${_(e.name)}" placeholder="Your Name" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
            </div>

            <div class="fgrp" style="margin-bottom:10px">
              <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Address</label>
              <input id="ps_address" type="text" value="${_(e.address)}" placeholder="123 Main St" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
            </div>

            <div style="display:grid;grid-template-columns:2fr 1fr 1.5fr;gap:8px">
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">City</label>
                <input id="ps_city" type="text" value="${_(e.city)}" placeholder="City" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">State</label>
                <input id="ps_state" type="text" value="${_(e.state)}" placeholder="ST" maxlength="2" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">ZIP</label>
                <input id="ps_zip" type="text" value="${_(e.zip)}" placeholder="12345" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Phone</label>
                <input id="ps_phone" type="text" value="${_(e.phone)}" placeholder="(555) 555-5555" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
              <div class="fgrp">
                <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Email</label>
                <input id="ps_email" type="email" value="${_(e.email)}" placeholder="you@example.com" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
              </div>
            </div>
          </div>

          <div>
            <h4 style="font-size:12px;font-weight:700;margin-bottom:10px;color:var(--text)">Thank You Message</h4>
            <textarea id="ps_thankYouMsg" placeholder="Thank you for your purchase!..." style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%;min-height:80px;resize:vertical">${_(Qr())}</textarea>
            <p style="font-size:9px;color:var(--muted);margin-top:4px">This message appears on all packing slips</p>
          </div>

        </div>
        <div class="modal-footer" style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closePackingSlipSettings()" class="btn-secondary">Cancel</button>
          <button onclick="savePackingSlipSettings()" class="btn-primary">Save</button>
        </div>
      </div>
    </div>
  `)}function Qv(){const t=document.getElementById("packingSlipSettingsModal");t&&t.classList.add("on")}function Ld(){const t=document.getElementById("packingSlipSettingsModal");t&&t.classList.remove("on")}function Xv(){const t={businessName:document.getElementById("ps_businessName").value.trim(),name:document.getElementById("ps_name").value.trim(),address:document.getElementById("ps_address").value.trim(),city:document.getElementById("ps_city").value.trim(),state:document.getElementById("ps_state").value.trim().toUpperCase(),zip:document.getElementById("ps_zip").value.trim(),phone:document.getElementById("ps_phone").value.trim(),email:document.getElementById("ps_email").value.trim()},e=document.getElementById("ps_thankYouMsg").value.trim();Gv(t),Vv(e);const n=document.getElementById("toast");n&&(n.textContent="Packing slip settings saved",n.classList.remove("err"),n.classList.add("on"),setTimeout(()=>n.classList.remove("on"),2300)),Ld()}let Nn="",ji="",tn="unshipped",Ls="",Rs="",Qe=0;const hi=50;let be=new Set;function Zv(t){Nn=(t||"").toLowerCase(),Qe=0,De()}function e0(t){ji=t||"",Qe=0,De()}function t0(t){tn=t||"unshipped",Qe=0,De()}function n0(t){Ls=t||"",Qe=0,De()}function s0(t){Rs=t||"",Qe=0,De()}function i0(){Nn="",ji="",tn="unshipped",Ls="",Rs="",Qe=0,De()}function o0(t){be.has(t)?be.delete(t):be.add(t),De()}function r0(t){const e=Xr();t.checked?e.forEach(n=>be.add(n.id)):e.forEach(n=>be.delete(n.id)),De()}function a0(){be.clear(),De()}function Xr(){return I.filter(t=>{if(tn==="unshipped"&&t.shipped||tn==="shipped"&&!t.shipped||ji&&t.platform!==ji)return!1;if(Ls){const e=new Date(t.date).getTime(),n=new Date(Ls).getTime();if(e<n)return!1}if(Rs){const e=new Date(t.date).getTime(),n=new Date(Rs).getTime();if(e>n)return!1}if(Nn){const e=q(t.itemId),n=e?(e.name||"").toLowerCase():"",s=(t.buyerName||"").toLowerCase();if(!n.includes(Nn)&&!s.includes(Nn))return!1}return!0})}function l0(t){const e=I.find(s=>s.id===t);if(!e){k("Sale not found",!0);return}const n=document.getElementById("shipModal");n&&(n.dataset.activeSaleId=t,document.getElementById("shipCarrier").value=e.carrier||"USPS",document.getElementById("shipTracking").value=e.trackingNumber||"",document.getElementById("shipCost").value=e.actualShipCost||"",n.classList.add("on"))}function c0(t){const e=I.find(r=>r.id===t);if(!e){k("Sale not found",!0);return}const n=document.getElementById("shipCarrier").value.trim(),s=document.getElementById("shipTracking").value.trim(),i=document.getElementById("shipCost").value.trim();if(!n){k("Select carrier",!0);return}if(!s){k("Enter tracking number",!0);return}const o=parseFloat(i)||0;e.shipped=!0,e.shippedDate=new Date().toISOString(),e.carrier=n,e.trackingNumber=s,e.actualShipCost=o,J("sales",t),R(),k(`Marked shipped: ${s}`),document.getElementById("shipModal").classList.remove("on"),De()}function d0(){document.getElementById("shipModal").classList.remove("on")}function u0(){if(be.size===0){k("Select items first",!0);return}const t=document.getElementById("shipBatchModal");t&&t.classList.add("on")}function p0(){const t=document.getElementById("shipBatchCarrier").value.trim();if(!t){k("Select carrier",!0);return}let e=0;be.forEach(n=>{const s=I.find(i=>i.id===n);s&&!s.shipped&&(s.shipped=!0,s.shippedDate=new Date().toISOString(),s.carrier=t,s.trackingNumber="",s.actualShipCost=0,J("sales",n),e++)}),R(),k(`Marked ${e} orders shipped`),document.getElementById("shipBatchModal").classList.remove("on"),be.clear(),De()}function f0(){document.getElementById("shipBatchModal").classList.remove("on")}function h0(t){const e=I.find(n=>n.id===t);if(!e){k("Sale not found",!0);return}Bd(t,e)}function m0(){if(be.size===0){k("Select orders first",!0);return}const t=[...be].map(e=>I.find(n=>n.id===e)).filter(Boolean);Jv([...be],t)}function g0(){const t=Xr(),e=["Sale ID","Item","Buyer","Platform","Date Sold","Qty","Price","Carrier","Tracking","Ship Cost","Status"],n=t.map(a=>{const c=q(a.itemId);return[a.id,c?_(c.name):"",_(a.buyerName||""),a.platform||"",ce(a.date),a.qty||1,x(a.price||0),a.carrier||"",a.trackingNumber||"",x(a.actualShipCost||0),a.shipped?"Shipped":"Pending"]}),s=[e,...n].map(a=>a.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join(`
`),i=new Blob([s],{type:"text/csv"}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download=`ship-log-${new Date().toISOString().split("T")[0]}.csv`,r.click(),URL.revokeObjectURL(o),k("Exported ship log")}function De(){const t=document.getElementById("view-shipping");if(!t)return;const e=Xr(),n=Math.max(1,Math.ceil(e.length/hi));Qe=Math.max(0,Math.min(Qe,n-1));const s=Qe*hi,i=s+hi,o=e.slice(s,i),r=I.filter(u=>!u.shipped).length,a=I.filter(u=>{if(!u.shippedDate)return!1;const p=new Date(u.shippedDate).getTime();return Date.now()-p<864e5}).length,c=(()=>{const u=I.filter(h=>h.shippedDate&&h.date);if(u.length===0)return 0;const p=u.reduce((h,f)=>{const g=new Date(f.date).getTime(),m=new Date(f.shippedDate).getTime();return h+(m-g)},0);return Math.round(p/u.length/864e5)})(),l=I.filter(u=>u.shipped).reduce((u,p)=>u+(p.actualShipCost||0),0),d=o.length>0&&o.every(u=>be.has(u.id));t.innerHTML=`
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">Shipping & Fulfillment</h2>
      </div>

      <!-- Stats strip -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:14px;border-bottom:1px solid var(--border)">
        <div class="stat-card c1">
          <div class="stat-label">Pending</div>
          <div class="stat-value">${r}</div>
        </div>
        <div class="stat-card c2">
          <div class="stat-label">Shipped Today</div>
          <div class="stat-value">${a}</div>
        </div>
        <div class="stat-card c3">
          <div class="stat-label">Avg Ship Time</div>
          <div class="stat-value">${c} days</div>
        </div>
        <div class="stat-card c4">
          <div class="stat-label">Total Cost</div>
          <div class="stat-value">${x(l)}</div>
        </div>
      </div>

      <!-- Filters -->
      <div style="padding:14px;border-bottom:1px solid var(--border);background:var(--surface2)">
        <div class="form-grid" style="margin-bottom:12px">
          <input type="text" placeholder="Search item or buyer..." value="${_(Nn)}"
            oninput="shipSetSearch(this.value)" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px" />

          <select onchange="shipSetStatusFilter(this.value)" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px">
            <option value="unshipped" ${tn==="unshipped"?"selected":""}>Unshipped</option>
            <option value="shipped" ${tn==="shipped"?"selected":""}>Shipped</option>
            <option value="all" ${tn==="all"?"selected":""}>All</option>
          </select>
        </div>

        <div class="form-grid" style="gap:8px;align-items:end">
          <div style="min-width:100px">
            <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px">From Date</label>
            <input type="date" value="${Ls}" onchange="shipSetDateFrom(this.value)" style="padding:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
          <div style="min-width:100px">
            <label style="display:block;font-size:10px;color:var(--muted);margin-bottom:4px">To Date</label>
            <input type="date" value="${Rs}" onchange="shipSetDateTo(this.value)" style="padding:6px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
          <button onclick="shipClearFilters()" class="btn-secondary" style="padding:6px 12px;font-size:10px">Clear</button>
        </div>
      </div>

      <!-- Batch actions -->
      ${be.size>0?`
        <div style="padding:10px 14px;background:rgba(87,200,255,0.05);border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;font-size:11px;color:var(--muted)">
          <span>${be.size} selected</span>
          <button onclick="shipBatchMark()" class="btn-primary" style="padding:5px 10px;font-size:10px">Mark Shipped</button>
          <button onclick="shipPrintBatchSlips()" class="btn-secondary" style="padding:5px 10px;font-size:10px">Print Slips</button>
          <button onclick="shipClearSel()" class="btn-danger" style="padding:5px 10px;font-size:10px">Clear</button>
        </div>
      `:""}

      <!-- Actions bar -->
      <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="shipExportLog()" class="btn-secondary" style="padding:6px 12px;font-size:10px">Export Log</button>
      </div>

      <!-- Table/cards -->
      ${o.length===0?`
        <div class="empty-state">
          <p style="font-size:12px;color:var(--muted)">No orders to ship</p>
        </div>
      `:`
        <div style="overflow-x:auto">
          <table class="inv-table">
            <thead>
              <tr style="border-bottom:1px solid var(--border)">
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">
                  <input type="checkbox" ${d?"checked":""} onchange="shipToggleAll(this)" />
                </th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Item</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Buyer</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Platform</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Date Sold</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Weight</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Package</th>
                <th style="padding:10px;text-align:left;font-size:10px;color:var(--muted);font-weight:600">Status</th>
                <th style="padding:10px;text-align:center;font-size:10px;color:var(--muted);font-weight:600">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${o.map(u=>{const p=q(u.itemId),h=p?Jr(p):null,f=be.has(u.id);return`
                  <tr style="border-bottom:1px solid var(--border);background:${f?"rgba(87,200,255,0.05)":"transparent"}">
                    <td style="padding:10px"><input type="checkbox" ${f?"checked":""} onchange="shipToggleSel('${u.id}')" /></td>
                    <td style="padding:10px;font-size:11px;color:var(--text)">${_(p?p.name:"")}</td>
                    <td style="padding:10px;font-size:11px;color:var(--text)">${_(u.buyerName||"")}</td>
                    <td style="padding:10px;font-size:10px;color:var(--muted)">${_(u.platform||"")}</td>
                    <td style="padding:10px;font-size:10px;color:var(--muted)">${ce(u.date)}</td>
                    <td style="padding:10px;font-size:10px;color:var(--muted)">${p&&p.weight?p.weight+(p.dimUnit||"oz"):""}</td>
                    <td style="padding:10px;font-size:10px;color:var(--accent)">${h?_(h.name):""}</td>
                    <td style="padding:10px;font-size:10px">
                      <span style="color:${u.shipped?"var(--good)":"var(--warn)"}">
                        ${u.shipped?` ${ce(u.shippedDate)}`:"Pending"}
                      </span>
                    </td>
                    <td style="padding:10px;text-align:center;font-size:10px;display:flex;gap:6px;justify-content:center">
                      ${u.shipped?"":`<button onclick="shipMarkShipped('${u.id}')" class="act-btn" style="padding:4px 8px">Mark</button>`}
                      <button onclick="shipPrintSlip('${u.id}')" class="act-btn" style="padding:4px 8px">Slip</button>
                      ${u.trackingNumber?`<a href="https://tools.usps.com/go/TrackConfirmAction_input?tLabels=${encodeURIComponent(u.trackingNumber)}" target="_blank" class="act-btn" style="padding:4px 8px;text-decoration:none">Track</a>`:""}
                    </td>
                  </tr>
                `}).join("")}
            </tbody>
          </table>
        </div>
      `}

      <!-- Pagination -->
      <div id="shipPagination" style="padding:14px"></div>
    </div>
  `,Vn(document.getElementById("shipPagination"),{page:Qe,totalItems:e.length,pageSize:hi,onPage:u=>{Qe=u,De()}})}function y0(){const t=document.getElementById("modals-root");!t||document.getElementById("shipModal")||t.insertAdjacentHTML("beforeend",`
    <!-- Mark Shipped Modal -->
    <div id="shipModal" class="overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Mark Order Shipped</h3>
          <button onclick="shipCancelMark()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px"></button>
        </div>
        <div class="modal-body" style="padding:14px;display:grid;gap:10px">
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Carrier</label>
            <select id="shipCarrier" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%">
              <option>USPS</option>
              <option>UPS</option>
              <option>FedEx</option>
              <option>DHL</option>
              <option>Other</option>
            </select>
          </div>
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Tracking Number</label>
            <input id="shipTracking" type="text" placeholder="e.g., 9400111899223456789012" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Actual Shipping Cost ($)</label>
            <input id="shipCost" type="number" placeholder="0.00" step="0.01" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%" />
          </div>
        </div>
        <div class="modal-footer" style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
          <button onclick="shipCancelMark()" class="btn-secondary">Cancel</button>
          <button onclick="shipConfirmShipped(document.getElementById('shipModal').dataset.activeSaleId)" class="btn-primary">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Batch Mark Shipped Modal -->
    <div id="shipBatchModal" class="overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Mark Selected as Shipped</h3>
          <button onclick="shipCancelBatchMark()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px"></button>
        </div>
        <div class="modal-body" style="padding:14px;display:grid;gap:10px">
          <div class="fgrp">
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:4px">Carrier</label>
            <select id="shipBatchCarrier" style="padding:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;width:100%">
              <option value=""> Select </option>
              <option>USPS</option>
              <option>UPS</option>
              <option>FedEx</option>
              <option>DHL</option>
              <option>Other</option>
            </select>
          </div>
          <p style="font-size:11px;color:var(--muted)">Tracking numbers can be added individually after batch mark.</p>
        </div>
        <div class="modal-footer" style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
          <button onclick="shipCancelBatchMark()" class="btn-secondary">Cancel</button>
          <button onclick="shipConfirmBatchMark()" class="btn-primary">Mark All</button>
        </div>
      </div>
    </div>
  `)}function bi(t,e,n){if(!t||!t.itemIds||!t.itemIds.length)return{totalRevenue:0,totalCost:0,profit:0,roi:0,margin:0};let s=0,i=t.totalSpent||0;t.itemIds.forEach(c=>{if(!e.find(p=>p.id===c))return;const u=n.filter(p=>p.itemId===c).reduce((p,h)=>p+(h.amount||0),0);s+=u});const o=s-i,r=i?o/i:0,a=s?o/s:0;return{totalRevenue:s,totalCost:i,profit:o,roi:r,margin:a}}function Rd(t,e){return!t||!t.itemIds?[]:t.itemIds.map(n=>e.find(s=>s.id===n)).filter(Boolean)}function v0(t,e){const n=Rd(t,e);if(!n.length)return{};const s=(t.totalSpent||0)/n.length,i={};return n.forEach(o=>{i[o.id]=s}),i}function b0(t,e,n){const s={};return t.forEach(i=>{const o=i.location||"Unknown";s[o]||(s[o]={location:o,count:0,totalSpent:0,totalRevenue:0,itemCount:0,roi:0,margin:0});const r=bi(i,e,n);s[o].count+=1,s[o].totalSpent+=i.totalSpent||0,s[o].totalRevenue+=r.totalRevenue,s[o].itemCount+=i.itemIds?i.itemIds.length:0}),Object.values(s).forEach(i=>{i.totalSpent&&(i.roi=(i.totalRevenue-i.totalSpent)/i.totalSpent,i.margin=i.totalRevenue?(i.totalRevenue-i.totalSpent)/i.totalRevenue:0)}),s}function w0(t,e,n,s=5){const i=b0(t,e,n);return Object.values(i).filter(o=>o.count>0).sort((o,r)=>r.roi-o.roi).slice(0,s)}function x0(t){const e=t.length,n=t.reduce((i,o)=>i+(o.totalSpent||0),0),s=t.reduce((i,o)=>i+(o.itemIds?o.itemIds.length:0),0);return{totalHauls:e,totalInvested:n,avgPerHaul:e?n/e:0,totalItems:s,avgItemsPerHaul:e?s/e:0}}let Se=[],cs="",Ae="date-desc",lr=null,Kt=0,is=25;async function _0(){try{Se=await we("hauls"),Se||(Se=[])}catch(t){console.warn("FlipTrack: Hauls IDB load failed, using localStorage:",t.message),Se=JSON.parse(localStorage.getItem("ft_hauls")||"[]")}}async function to(){await te("hauls",Se),localStorage.setItem("ft_hauls",JSON.stringify(Se))}function et(){const t=document.getElementById("sourcing-view");if(!t)return;const e=Se.filter(i=>!cs||(i.location||"").toLowerCase().includes(cs)||(i.notes||"").toLowerCase().includes(cs)).sort((i,o)=>{if(Ae==="date-desc")return new Date(o.date)-new Date(i.date);if(Ae==="date-asc")return new Date(i.date)-new Date(o.date);if(Ae==="spent-high")return(o.totalSpent||0)-(i.totalSpent||0);if(Ae==="spent-low")return(i.totalSpent||0)-(o.totalSpent||0);if(Ae==="roi-high"){const r=bi(i,$,I).roi;return bi(o,$,I).roi-r}return Ae==="location"?(i.location||"").localeCompare(o.location||""):new Date(o.date)-new Date(i.date)}),n=x0(Se),s=w0(Se,$,I,3);t.innerHTML=`
    <div class="sourcing-container" style="display:flex;flex-direction:column;gap:16px;padding:12px">

      <!-- STATS STRIP -->
      <div class="stats-strip" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px">
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Total Hauls</div>
          <div style="font-size:20px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent)">${n.totalHauls}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Total Invested</div>
          <div style="font-size:18px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent2)">${x(n.totalInvested)}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Avg Per Haul</div>
          <div style="font-size:18px;font-weight:700;font-family:'Syne',sans-serif;color:var(--accent3)">${x(n.avgPerHaul)}</div>
        </div>
        <div class="stat-card">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-family:'Syne',sans-serif;font-weight:700">Avg Items/Haul</div>
          <div style="font-size:20px;font-weight:700;font-family:'Syne',sans-serif;color:var(--good)">${n.avgItemsPerHaul.toFixed(1)}</div>
        </div>
      </div>

      <!-- TOP SOURCES LEADERBOARD -->
      ${s.length?`
        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Top Sourcing Locations</h3>
          </div>
          <div style="padding:12px">
            ${s.map((i,o)=>{const r=["","",""][o]||"",a=i.roi>=.3?"var(--good)":i.roi>=.1?"var(--accent)":"var(--warn)";return`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;font-family:'DM Mono',monospace">
                <div>
                  <span style="margin-right:8px">${r}</span>
                  <strong>${_(i.location)}</strong>
                  <span style="color:var(--muted);font-size:11px"> (${i.count} haul${i.count!==1?"s":""})</span>
                </div>
                <div style="text-align:right">
                  <div style="color:${a};font-weight:700">${V(i.roi)}</div>
                  <div style="color:var(--muted);font-size:11px">${x(i.totalSpent)} invested</div>
                </div>
              </div>`}).join("")}
          </div>
        </div>
      `:""}

      <!-- LOG NEW HAUL FORM -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Log New Haul</h3>
        </div>
        <div style="padding:12px;display:grid;gap:10px">
          <div class="form-grid">
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Date</label>
              <input type="date" id="haul_date" value="${new Date().toISOString().split("T")[0]}"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Location</label>
              <input type="text" id="haul_loc" placeholder="e.g. Goodwill, Estate Sale, Thrift"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Spent</label>
              <input type="number" id="haul_spent" placeholder="0.00" step="0.01" min="0"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
            <div class="fgrp">
              <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Mileage (mi)</label>
              <input type="number" id="haul_mileage" placeholder="0" step="0.1" min="0"
                     style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px">
            </div>
          </div>
          <div class="fgrp">
            <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Notes</label>
            <textarea id="haul_notes" placeholder="Add notes..." rows="2"
                      style="padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;resize:vertical"></textarea>
          </div>
          <button class="btn-primary" onclick="addHaul()" style="padding:10px;font-weight:700;font-family:'Syne',sans-serif">Log Haul</button>
        </div>
      </div>

      <!-- SEARCH & SORT -->
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:0 0 8px 0">
        <input type="text" placeholder="Search location, notes..." value="${_(cs)}"
               oninput="srcSetSearch(this.value)"
               style="flex:1;min-width:150px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;font-family:'DM Mono',monospace">
        <select onchange="srcSetSort(this.value)" style="padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:11px;font-family:'DM Mono',monospace">
          <option value="date-desc" ${Ae==="date-desc"?"selected":""}>Recent first</option>
          <option value="date-asc" ${Ae==="date-asc"?"selected":""}>Oldest first</option>
          <option value="spent-high" ${Ae==="spent-high"?"selected":""}>Spent (high)</option>
          <option value="spent-low" ${Ae==="spent-low"?"selected":""}>Spent (low)</option>
          <option value="roi-high" ${Ae==="roi-high"?"selected":""}>ROI (high)</option>
          <option value="location" ${Ae==="location"?"selected":""}>Location A-Z</option>
        </select>
      </div>

      <!-- HAUL LIST -->
      <div class="panel">
        <div class="panel-header">
          <h3 class="panel-title">Haul History (${e.length})</h3>
        </div>
        <div style="padding:12px">
          ${e.length?`
            <div style="display:flex;flex-direction:column;gap:8px">
              ${e.slice(Kt*is,(Kt+1)*is).map(i=>{const o=bi(i,$,I),r=Rd(i,$),a=lr===i.id,c=o.roi>=.3?"var(--good)":o.roi>=.1?"var(--accent)":o.roi<0?"var(--danger)":"var(--muted)";return`<div class="haul-card" style="border:1px solid var(--border);border-radius:6px;padding:10px;background:rgba(var(--surface-rgb),0.5);cursor:pointer" onclick="expandHaul('${i.id}')">
                  <div style="display:grid;grid-template-columns:1fr auto;gap:8px;font-size:12px;font-family:'DM Mono',monospace">
                    <div>
                      <div style="font-weight:700;color:var(--text)">${_(i.location)}</div>
                      <div style="color:var(--muted);font-size:11px">${ce(i.date)}  ${r.length} item${r.length!==1?"s":""}</div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-weight:700;color:var(--accent2)">${x(i.totalSpent)}</div>
                      <div style="color:${c};font-size:11px;font-weight:700">${V(o.roi)}</div>
                    </div>
                  </div>
                  ${a?`
                    <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px">
                      <div style="font-size:11px;color:var(--muted);margin-bottom:8px">
                        <strong>Linked Items (${r.length}):</strong>
                      </div>
                      ${r.length?`
                        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px">
                          ${r.map(l=>{const d=v0(i,$)[l.id]||0,p=I.filter(h=>h.itemId===l.id).reduce((h,f)=>h+(f.amount||0),0);return`<div style="padding:6px;background:var(--surface);border-radius:4px;font-size:11px;display:flex;justify-content:space-between">
                              <span>${_(l.title||"Untitled")}</span>
                              <span style="color:var(--muted)">${x(d)} cost  ${x(p)} revenue</span>
                            </div>`}).join("")}
                        </div>
                      `:'<div style="color:var(--muted);font-size:11px;padding:8px">No items linked yet</div>'}
                      <button class="btn-secondary" onclick="linkItemsToHaul('${i.id}')" style="padding:6px 10px;margin-right:6px;font-size:11px;font-family:'Syne',sans-serif">Link Items</button>
                      <button class="btn-danger" onclick="deleteHaul('${i.id}')" style="padding:6px 10px;font-size:11px;font-family:'Syne',sans-serif">Delete</button>
                    </div>
                  `:""}
                </div>`}).join("")}
            </div>
            <div id="srcPagination" style="margin-top:12px"></div>
          `:`<div class="empty-state" style="text-align:center;padding:24px;color:var(--muted)">
            <div style="font-size:14px;font-family:'Syne',sans-serif;margin-bottom:8px">No hauls yet</div>
            <div style="font-size:12px">Log your first haul to get started!</div>
          </div>`}
        </div>
      </div>
    </div>
  `,e.length>is&&Vn(document.getElementById("srcPagination"),{page:Kt,totalItems:e.length,pageSize:is,onPage:i=>{Kt=i,et()},pageSizes:[25,50,100],onPageSize:i=>{is=i,Kt=0,et()}})}async function S0(){var c,l,d,u,p,h,f,g,m;const t=(c=document.getElementById("haul_date"))==null?void 0:c.value,e=(d=(l=document.getElementById("haul_loc"))==null?void 0:l.value)==null?void 0:d.trim(),n=(p=(u=document.getElementById("haul_spent"))==null?void 0:u.value)==null?void 0:p.trim(),s=(f=(h=document.getElementById("haul_mileage"))==null?void 0:h.value)==null?void 0:f.trim(),i=(m=(g=document.getElementById("haul_notes"))==null?void 0:g.value)==null?void 0:m.trim();if(!t){k("Please enter a date",!0);return}if(!e){k("Please enter a location",!0);return}if(!n||isNaN(parseFloat(n))){k("Please enter a valid amount spent",!0);return}const o=parseFloat(n),r=s?parseFloat(s):0,a={id:ie(),date:t,location:e,totalSpent:o,itemIds:[],notes:i||"",mileage:r||0,receiptImage:null};Se.push(a),await to(),k("Haul logged "),document.getElementById("haul_loc").value="",document.getElementById("haul_spent").value="",document.getElementById("haul_mileage").value="",document.getElementById("haul_notes").value="",et()}async function k0(t){if(!confirm("Delete this haul?"))return;const e=Se.findIndex(n=>n.id===t);e>=0&&(Se.splice(e,1),await to(),k("Haul deleted"),et())}function $0(t){lr=lr===t?null:t,et()}async function E0(t){const e=Se.find(o=>o.id===t);if(!e)return;const n=document.createElement("div");n.style.cssText=`
    position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);
    display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px
  `;const s=document.createElement("div");s.style.cssText=`
    background:var(--surface);border:1px solid var(--border);border-radius:8px;
    padding:20px;max-width:600px;width:100%;max-height:80vh;overflow-y:auto;
    font-family:'DM Mono',monospace;font-size:12px
  `;const i=$.filter(o=>!e.itemIds.includes(o.id));s.innerHTML=`
    <div style="margin-bottom:16px">
      <h3 style="font-family:'Syne',sans-serif;font-size:16px;margin:0 0 12px 0">Link Items to Haul</h3>
      <div style="color:var(--muted);font-size:11px;margin-bottom:12px">Select items to assign to this haul</div>

      ${i.length?`
        <div style="display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto">
          ${i.map(o=>`
            <label style="display:flex;align-items:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:4px;cursor:pointer">
              <input type="checkbox" value="${o.id}" style="margin-right:8px">
              <span style="flex:1">${_(o.title||"Untitled")}</span>
              <span style="color:var(--muted);font-size:10px">${x(o.cost||0)}</span>
            </label>
          `).join("")}
        </div>
      `:'<div style="color:var(--muted);padding:12px;text-align:center">All items already linked to hauls</div>'}
    </div>

    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn-primary" onclick="confirmLinkItems('${t}')" style="flex:1;padding:10px;font-family:'Syne',sans-serif">Link Selected</button>
      <button class="btn-secondary" onclick="closeItemLinkModal()" style="flex:1;padding:10px;font-family:'Syne',sans-serif">Cancel</button>
    </div>
  `,n.appendChild(s),document.body.appendChild(n),window._itemLinkModal=n}async function I0(t){const e=window._itemLinkModal;if(!e)return;const n=e.querySelectorAll('input[type="checkbox"]:checked'),s=Array.from(n).map(o=>o.value),i=Se.find(o=>o.id===t);i&&(i.itemIds.push(...s),await to(),k(`Linked ${s.length} item${s.length!==1?"s":""}`)),Md(),et()}function Md(){const t=window._itemLinkModal;t&&(t.remove(),window._itemLinkModal=null)}async function T0(t,e){const n=Se.find(s=>s.id===t);if(n){const s=n.itemIds.indexOf(e);s>=0&&(n.itemIds.splice(s,1),await to(),et())}}function C0(t){cs=(t||"").toLowerCase(),Kt=0,et()}function P0(t){Ae=t||"date-desc",Kt=0,et()}const D0={2024:.67,2025:.7,2026:.7};let it=[];async function jd(){try{it=await we("mileage_log")||[]}catch(t){console.warn("Failed to load mileage log:",t.message),it=[]}}async function B0(t){if(!t.date||!t.miles||!t.purpose)return k("Please fill in date, miles, and purpose",!0),!1;const e=Number(t.miles)||0;if(e<=0)return k("Miles must be greater than 0",!0),!1;const n={id:ie(),date:t.date,miles:e,purpose:t.purpose.trim(),startLocation:(t.startLocation||"").trim(),endLocation:(t.endLocation||"").trim(),linkedHaulId:t.linkedHaulId||null};it.push(n),it.sort((s,i)=>new Date(i.date)-new Date(s.date));try{return await te("mileage_log",it),!0}catch(s){return console.error("Failed to save mileage entry:",s.message),k("Failed to save mileage entry",!0),it.pop(),!1}}async function O0(t){const e=it.findIndex(n=>n.id===t);if(e===-1)return!1;it.splice(e,1);try{return await te("mileage_log",it),!0}catch(n){return console.error("Failed to delete mileage entry:",n.message),k("Failed to delete mileage entry",!0),!1}}function Nd(t){const e=D0[t]||.7,n=it.filter(o=>new Date(o.date).getFullYear()===t),s=n.reduce((o,r)=>o+(r.miles||0),0),i=s*e;return{totalMiles:s,totalDeduction:i,rate:e,entries:n}}function A0(){const t=new Date().getFullYear(),e=Nd(t),n=e.entries.sort((s,i)=>new Date(i.date)-new Date(s.date)).map((s,i)=>`
      <tr>
        <td style="padding:8px;font-size:12px;color:var(--text)">${ce(s.date)}</td>
        <td style="padding:8px;font-size:12px;font-family:'DM Mono',monospace;color:var(--accent);text-align:right">${s.miles}</td>
        <td style="padding:8px;font-size:12px;color:var(--text)">${_(s.purpose)}</td>
        <td style="padding:8px;font-size:12px;color:var(--muted)">${s.startLocation?_(s.startLocation):""}</td>
        <td style="padding:8px;font-size:11px;text-align:center">
          <button onclick="mileDeleteEntry('${s.id}')" style="padding:4px 8px;background:var(--danger);color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;font-family:Syne,sans-serif">Delete</button>
        </td>
      </tr>
    `).join("");return`
    <div style="margin-bottom:24px">
      <div class="panel-title" style="margin-bottom:12px">Mileage Deduction Log</div>

      <!-- Add Entry Form -->
      <div class="panel" style="margin-bottom:16px;padding:12px">
        <div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:8px">ADD ENTRY</div>
        <div class="form-grid" style="grid-template-columns:1fr 1fr 2fr;gap:8px;margin-bottom:8px">
          <div class="fgrp">
            <input type="date" id="mileDate" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
          <div class="fgrp">
            <input type="number" id="mileMiles" placeholder="Miles" step="0.1" min="0" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
          <div class="fgrp">
            <input type="text" id="milePurpose" placeholder="Purpose (e.g., sourcing trip)" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
        </div>
        <div class="form-grid" style="grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div class="fgrp">
            <input type="text" id="mileStart" placeholder="Start location (optional)" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
          <div class="fgrp">
            <input type="text" id="mileEnd" placeholder="End location (optional)" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:12px;border-radius:4px" />
          </div>
        </div>
        <button onclick="mileAddEntry()" class="btn-primary" style="width:100%;padding:8px;background:var(--accent);color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-family:Syne,sans-serif;font-size:13px">Add Entry</button>
      </div>

      <!-- Log Table -->
      ${e.entries.length>0?`
        <div style="overflow-x:auto;margin-bottom:16px">
          <table class="inv-table" style="font-size:12px;width:100%">
            <thead>
              <tr style="background:var(--surface);border-bottom:1px solid var(--border)">
                <th style="padding:8px;text-align:left;font-weight:600">Date</th>
                <th style="padding:8px;text-align:right;font-weight:600">Miles</th>
                <th style="padding:8px;text-align:left;font-weight:600">Purpose</th>
                <th style="padding:8px;text-align:left;font-weight:600">From</th>
                <th style="padding:8px;text-align:center;font-weight:600">Action</th>
              </tr>
            </thead>
            <tbody>
              ${n}
            </tbody>
          </table>
        </div>
      `:`
        <div class="empty-state" style="padding:16px;text-align:center;color:var(--muted);font-size:12px">
          No mileage entries yet
        </div>
      `}

      <!-- Summary Stats -->
      <div class="stat-card" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div style="padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
          <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Total Miles (${t})</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent);font-family:'DM Mono',monospace">${e.totalMiles.toFixed(1)}</div>
        </div>
        <div style="padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
          <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Deduction @ ${(e.rate*100).toFixed(0)}/mi</div>
          <div style="font-size:18px;font-weight:700;color:var(--good);font-family:'DM Mono',monospace">${x(e.totalDeduction)}</div>
        </div>
      </div>
    </div>
  `}async function L0(){const t=document.getElementById("mileDate"),e=document.getElementById("mileMiles"),n=document.getElementById("milePurpose"),s=document.getElementById("mileStart"),i=document.getElementById("mileEnd");if(!t||!e||!n){console.warn("Mileage form elements not found");return}await B0({date:t.value,miles:e.value,purpose:n.value,startLocation:(s==null?void 0:s.value)||"",endLocation:(i==null?void 0:i.value)||""})&&(k("Mileage entry added "),t.value="",e.value="",n.value="",s.value="",i.value="",window.renderTaxCenter&&window.renderTaxCenter())}async function R0(t){if(!confirm("Delete this mileage entry?"))return;await O0(t)&&(k("Entry deleted "),window.renderTaxCenter&&window.renderTaxCenter())}let ye=new Date().getFullYear(),ot=null,ms=!1;function M0(t){ye=Number(t),Qs()}function j0(t){ot=ot===t?null:t,Qs()}function N0(){ms=!ms,Qs()}function Ni(t,e){const n=new Date(t,(e-1)*3,1),s=new Date(t,e*3,0,23,59,59);return{start:n,end:s}}function Ms(t,e){let n=0,s=0,i=0,o=0;const r=new Set,a=I.filter(f=>{const g=new Date(f.date);return g>=t&&g<=e});for(const f of a){const g=q(f.itemId),m=f.qty||1,v=f.price||0;n+=v*m,s+=((g==null?void 0:g.cost)||0)*m,i+=f.fees||0,o+=f.ship||0,r.add(f.itemId)}const c=n-s-i-o,l=Q.filter(f=>{const g=new Date(f.date);return g>=t&&g<=e}),d={};let u=0;for(const f of l){const g=f.category||"Other";d[g]=(d[g]||0)+(f.amount||0),u+=f.amount||0}const p=c-u,h=p*.25;return{revenue:n,cogs:s,platformFees:i,shipping:o,grossProfit:c,totalExpenses:u,expensesByCategory:d,netProfit:p,estimatedTax:h,saleCount:a.length,itemCount:r.size}}function z0(){return`
    <div style="overflow-x:auto;margin-bottom:16px">
      <table class="inv-table" style="width:100%;font-size:12px">
        <thead>
          <tr style="background:var(--surface);border-bottom:2px solid var(--border)">
            <th style="padding:10px;text-align:left;font-weight:700">Period</th>
            <th style="padding:10px;text-align:right;font-weight:700">Revenue</th>
            <th style="padding:10px;text-align:right;font-weight:700">COGS</th>
            <th style="padding:10px;text-align:right;font-weight:700">Gross Profit</th>
            <th style="padding:10px;text-align:right;font-weight:700">Expenses</th>
            <th style="padding:10px;text-align:right;font-weight:700">Net Profit</th>
            <th style="padding:10px;text-align:right;font-weight:700">Est. Tax (25%)</th>
          </tr>
        </thead>
        <tbody>${[1,2,3,4].map(n=>{const{start:s,end:i}=Ni(ye,n),o=Ms(s,i);return`
      <tr style="cursor:pointer;background:${ot===n?"var(--surface)":""};border-bottom:1px solid var(--border)" onclick="taxSetQuarter(${n})">
        <td style="padding:10px;font-weight:600;color:var(--text)">Q${n}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--accent)">${x(o.revenue)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--muted)">${x(o.cogs)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--good)">${x(o.grossProfit)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--danger)">${x(o.totalExpenses)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;font-weight:600;color:${o.netProfit>=0?"var(--good)":"var(--danger)"}">${x(o.netProfit)}</td>
        <td style="padding:10px;font-family:'DM Mono',monospace;color:var(--warn)">${x(o.estimatedTax)}</td>
      </tr>
    `}).join("")}</tbody>
      </table>
    </div>
  `}function U0(t){return`
    <div style="margin-bottom:16px;padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="panel-title" style="margin:0">Schedule C Summary</div>
        <button onclick="taxToggleScheduleC()" style="padding:4px 10px;background:var(--accent2);color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px;font-weight:600;font-family:Syne,sans-serif">Hide</button>
      </div>
      <div style="overflow-x:auto">
        <table style="width:100%;font-size:11px">
          <tbody>${[{line:1,label:"Gross receipts or sales",value:x(t.revenue)},{line:2,label:"Returns and allowances",value:x(0)},{line:4,label:"Cost of goods sold (COGS)",value:x(t.cogs)},{line:5,label:"Gross profit",value:x(t.grossProfit)},{line:10,label:"Commissions & fees (platforms)",value:x(t.platformFees)},{line:22,label:"Supplies",value:x(t.expensesByCategory.Supplies||0)},{line:27,label:"Other expenses",value:x((t.expensesByCategory["Shipping Supplies"]||0)+(t.expensesByCategory.Software||0))}].map(s=>`
    <tr style="border-bottom:1px solid var(--border)">
      <td style="padding:8px;font-weight:600;color:var(--muted);font-family:'DM Mono',monospace;width:50px">Line ${s.line}</td>
      <td style="padding:8px;color:var(--text)">${s.label}</td>
      <td style="padding:8px;font-family:'DM Mono',monospace;color:var(--accent);text-align:right;font-weight:600">${s.value}</td>
    </tr>
  `).join("")}</tbody>
        </table>
      </div>
    </div>
  `}async function F0(){if(ot){const{start:t,end:e}=Ni(ye,ot),n=Ms(t,e),s=["FlipTrack Tax Report - Q"+ot+" "+ye,"","Summary","Metric,Amount","Revenue,"+n.revenue,"COGS,"+n.cogs,"Platform Fees,"+n.platformFees,"Shipping Costs,"+n.shipping,"Gross Profit,"+n.grossProfit,"Total Expenses,"+n.totalExpenses,"Net Profit,"+n.netProfit,"Estimated Tax (25%),"+n.estimatedTax,"","Expenses by Category","Category,Amount",...Object.entries(n.expensesByCategory).map(([i,o])=>`"${i}",${o}`)].join(`
`);vl("fliptrack-tax-q"+ot+"-"+ye+".csv",s)}else{let t=["FlipTrack Tax Report - "+ye,"","Quarterly Summary","Quarter,Revenue,COGS,Gross Profit,Expenses,Net Profit,Estimated Tax"];for(let e=1;e<=4;e++){const{start:n,end:s}=Ni(ye,e),i=Ms(n,s);t.push(`Q${e},${i.revenue},${i.cogs},${i.grossProfit},${i.totalExpenses},${i.netProfit},${i.estimatedTax}`)}vl("fliptrack-tax-"+ye+".csv",t.join(`
`))}k("Tax report exported ")}function vl(t,e){const n=new Blob([e],{type:"text/csv"}),s=URL.createObjectURL(n),i=document.createElement("a");i.href=s,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}async function Qs(){const t=document.getElementById("taxContent");if(!t)return;await jd();const e=new Date(ye,0,1),n=new Date(ye,11,31,23,59,59),s=Ms(e,n);Nd(ye);let i=null;if(ot){const{start:d,end:u}=Ni(ye,ot);i=Ms(d,u)}const o=`
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px">
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Total Revenue</div>
        <div style="font-size:20px;font-weight:700;color:var(--accent);font-family:'DM Mono',monospace">${x(s.revenue)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${s.saleCount} sales</div>
      </div>
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Total COGS</div>
        <div style="font-size:20px;font-weight:700;color:var(--muted);font-family:'DM Mono',monospace">${x(s.cogs)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${s.itemCount} items</div>
      </div>
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Net Profit</div>
        <div style="font-size:20px;font-weight:700;color:${s.netProfit>=0?"var(--good)":"var(--danger)"};font-family:'DM Mono',monospace">${x(s.netProfit)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">margin: ${s.revenue?(s.netProfit/s.revenue*100).toFixed(1):0}%</div>
      </div>
      <div class="stat-card" style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;border-color:var(--warn)">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">Est. Tax (25%)</div>
        <div style="font-size:20px;font-weight:700;color:var(--warn);font-family:'DM Mono',monospace">${x(s.estimatedTax)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">quarterly avg: ${x(s.estimatedTax/4)}</div>
      </div>
    </div>
  `,r=`
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;align-items:center;padding:12px;background:var(--surface);border-radius:6px;border:1px solid var(--border)">
      <select onchange="taxSetYear(this.value)" style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:3px;font-family:'DM Mono',monospace;font-size:12px">
        <option value="2024" ${ye===2024?"selected":""}>Tax Year 2024</option>
        <option value="2025" ${ye===2025?"selected":""}>Tax Year 2025</option>
        <option value="2026" ${ye===2026?"selected":""}>Tax Year 2026</option>
      </select>
      <button onclick="taxToggleScheduleC()" class="btn-secondary" style="padding:6px 12px;background:${ms?"var(--accent2)":"var(--surface2)"};border:1px solid var(--border);color:white;border-radius:3px;cursor:pointer;font-weight:600;font-family:Syne,sans-serif;font-size:12px">${ms?"Hide":"Show"} Schedule C</button>
      <button onclick="taxExportCSV()" class="btn-primary" style="padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:3px;cursor:pointer;font-weight:600;font-family:Syne,sans-serif;font-size:12px">Export CSV</button>
    </div>
  `,a=`
    <div class="panel" style="margin-bottom:20px;padding:12px">
      <div class="panel-title" style="margin-bottom:12px">Quarterly Breakdown (${ye})</div>
      ${z0()}
      <div style="font-size:10px;color:var(--muted);text-align:center">Click a quarter to expand details</div>
    </div>
  `;let c="";i&&(c=`
      <div class="panel" style="margin-bottom:20px;padding:12px">
        <div class="panel-title" style="margin-bottom:12px">Q${ot} Details</div>
        ${ms?U0(i):""}
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px">
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Revenue</div>
            <div style="font-size:16px;font-weight:700;color:var(--accent);font-family:'DM Mono',monospace">${x(i.revenue)}</div>
          </div>
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Gross Profit</div>
            <div style="font-size:16px;font-weight:700;color:var(--good);font-family:'DM Mono',monospace">${x(i.grossProfit)}</div>
          </div>
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Expenses</div>
            <div style="font-size:16px;font-weight:700;color:var(--danger);font-family:'DM Mono',monospace">${x(i.totalExpenses)}</div>
          </div>
          <div style="padding:10px;background:var(--surface);border-radius:4px;border:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">Net Profit</div>
            <div style="font-size:16px;font-weight:700;color:${i.netProfit>=0?"var(--good)":"var(--danger)"};font-family:'DM Mono',monospace">${x(i.netProfit)}</div>
          </div>
        </div>
      </div>
    `);const l=A0();t.innerHTML=`
    <div style="padding:16px 12px">
      ${o}
      ${r}
      ${a}
      ${c}
      ${l}
    </div>
  `}const bl=[{id:"rule_30day_drop",name:"10% drop after 30 days",active:!0,condition:{daysListed:30,noSalesDays:0,priceAbove:0,priceBelow:9999},action:{type:"percent_drop",value:10},platforms:[],categories:[]},{id:"rule_60day_drop",name:"20% drop after 60 days",active:!0,condition:{daysListed:60,noSalesDays:0,priceAbove:0,priceBelow:9999},action:{type:"percent_drop",value:20},platforms:[],categories:[]},{id:"rule_quick_sale",name:"5% raise if sold within 3 days",active:!0,condition:{daysListed:0,noSalesDays:0,priceAbove:0,priceBelow:9999},action:{type:"percent_raise",value:5},platforms:[],categories:[]}];let bt=[],wl=!1;async function q0(){try{bt=await we("repricing_rules")||bl.map(e=>({...e})),wl=!0}catch(t){console.warn("Failed to load repricing rules:",t.message),bt=bl.map(e=>({...e})),wl=!0}}function H0(){return bt}function W0(t){const e=t.id||"rule_"+ie(),n={id:e,name:t.name||"New Rule",active:t.active!==!1,condition:t.condition||{daysListed:30,noSalesDays:0,priceAbove:0,priceBelow:9999},action:t.action||{type:"percent_drop",value:10},platforms:t.platforms||[],categories:t.categories||[]};return bt.push(n),Zr(),e}function G0(t){const e=bt.findIndex(n=>n.id===t);e!==-1&&(bt.splice(e,1),Zr())}function Zr(){te("repricing_rules",bt).catch(t=>console.warn("Failed to persist rules:",t))}function zd(){const t=[],e=Date.now();return $.forEach(n=>{!n.price||n.qty===0||bt.forEach(s=>{if(!s.active)return;if(s.platforms.length>0){const h=n.platforms||[];if(!s.platforms.some(f=>h.includes(f)))return}if(s.categories.length>0&&!s.categories.includes(n.category))return;const{daysListed:i,noSalesDays:o,priceAbove:r,priceBelow:a}=s.condition,{type:c,value:l}=s.action,d=n.createdAt||n.listedAt||0;if((e-d)/(24*36e5)<i||n.price<r||n.price>a)return;if(o>0){const h=I.filter(g=>g.itemId===n.id).sort((g,m)=>(m.soldAt||0)-(g.soldAt||0))[0];if(!h||(e-(h.soldAt||0))/(24*36e5)<o)return}let p=n.price;c==="percent_drop"?p=n.price*(1-l/100):c==="fixed_drop"?p=n.price-l:c==="percent_raise"&&(p=n.price*(1+l/100)),p=Math.round(p*100)/100,p!==n.price&&t.push({item:n,rule:s,currentPrice:n.price,suggestedPrice:p,reason:V0(s)})})}),t}function V0(t,e){const{type:n,value:s}=t.action;return`${n==="percent_drop"?`Drop ${s}%`:n==="fixed_drop"?`Drop $${s}`:`Raise ${s}%`}  ${t.name}`}function K0(t){if(!t.length){k("No repricing suggestions to apply",!0);return}const e=t.map(n=>({itemId:n.item.id,oldPrice:n.item.price,newPrice:n.suggestedPrice,rule:n.rule.name}));Vi("repricing",e),t.forEach(n=>{const s=n.item;Cr(s.id,n.suggestedPrice,"repricing"),s.price=n.suggestedPrice,J("inv",s.id)}),R(),W(),k(`Applied ${t.length} price adjustment${t.length>1?"s":""}`)}function J0(){const t=zd();if(!t.length)return`
      <div class="panel" style="text-align:center;padding:30px">
        <div style="font-size:14px;color:var(--muted);margin-bottom:10px">No repricing suggestions</div>
        <div style="font-size:12px;color:var(--muted)">All items are optimally priced</div>
      </div>
    `;const e=t.map((n,s)=>`
    <div style="display:grid;grid-template-columns:1fr 100px 100px 120px;gap:12px;align-items:center;padding:10px;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-weight:500;color:var(--text)">${_(n.item.name)}</div>
        <div style="font-size:11px;color:var(--muted)">${_(n.reason)}</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:12px;color:var(--warn)">${x(n.currentPrice)}</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:12px;color:var(--good);font-weight:500">${x(n.suggestedPrice)}</div>
        <div style="font-size:10px;color:var(--muted)">${V((n.suggestedPrice-n.currentPrice)/n.currentPrice)}</div>
      </div>
      <button class="btn-primary" style="font-size:11px;padding:6px 10px" onclick="rpApplySingle('${n.item.id}', ${n.suggestedPrice})">Apply</button>
    </div>
  `).join("");return`
    <div class="panel">
      <div style="padding:10px;background:var(--surface2);border-bottom:2px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:500">${t.length} Price Suggestion${t.length>1?"s":""}</div>
          <div style="font-size:11px;color:var(--muted)">Review and apply individual adjustments</div>
        </div>
        <button class="btn-primary" onclick="rpApplyAll()">Apply All</button>
      </div>
      <div>
        ${e}
      </div>
    </div>
  `}function Y0(){const t=H0(),e=t.map(n=>`
    <div style="display:grid;grid-template-columns:1fr 120px 120px;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-weight:500;color:var(--text)">${_(n.name)}</div>
        <div style="font-size:11px;color:var(--muted)">
          ${n.condition.daysListed>0?`After ${n.condition.daysListed} days`:"Always"} 
          ${n.action.type==="percent_drop"?`${n.action.value}% drop`:n.action.type==="percent_raise"?`${n.action.value}% raise`:`$${n.action.value} drop`}
        </div>
      </div>
      <div style="text-align:center">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input type="checkbox" ${n.active?"checked":""} onchange="rpToggleRule('${n.id}')" style="cursor:pointer">
          <span style="font-size:12px">${n.active?"Active":"Inactive"}</span>
        </label>
      </div>
      <div style="text-align:right">
        <button class="btn-danger" style="font-size:11px;padding:5px 10px" onclick="rpDeleteRule('${n.id}')">Delete</button>
      </div>
    </div>
  `).join("");return`
    <div class="panel">
      <div style="padding:10px;background:var(--surface2);border-bottom:2px solid var(--border)">
        <div style="font-weight:500;margin-bottom:4px">Repricing Rules</div>
        <div style="font-size:11px;color:var(--muted)">${t.length} rule${t.length!==1?"s":""} configured</div>
      </div>
      <div>
        ${e}
      </div>
      <div style="padding:10px;background:var(--surface2);border-top:1px solid var(--border)">
        <button class="btn-secondary" style="width:100%;font-size:12px;padding:8px" onclick="alert('Add new rule feature coming soon')">+ Add New Rule</button>
      </div>
    </div>
  `}function Q0(t){W0(t),k("Rule added"),W()}function X0(t){confirm("Delete this repricing rule?")&&(G0(t),k("Rule deleted"),W())}function Z0(t){const e=bt.find(n=>n.id===t);e&&(e.active=!e.active,Zr(),W())}function eb(){const t=zd();if(!t.length){k("No suggestions to apply",!0);return}confirm(`Apply ${t.length} price adjustment${t.length>1?"s":""}?`)&&K0(t)}function tb(t,e){const n=$.find(s=>s.id===t);n&&(Vi("price_change",{itemId:t,oldPrice:n.price}),Cr(t,e,"repricing"),n.price=e,J("inv",t),R(),W(),k("Price updated"))}let Te=[];async function nb(){const t=await we("offers");Te=t?JSON.parse(t):[]}function ea(){te("offers",JSON.stringify(Te)).catch(()=>{})}function sb(t){const e={id:t.id||ie(),itemId:t.itemId,platform:t.platform||"",amount:t.amount||0,buyerHandle:t.buyerHandle||"",buyerId:t.buyerId||null,date:t.date||Date.now(),status:t.status||"pending",counterAmount:t.counterAmount||null,notes:t.notes||"",createdAt:Date.now()};return Te.push(e),ea(),e}function ta(t,e){const n=Te.find(s=>s.id===t);return n?(Object.assign(n,e),ea(),n):null}function ib(t){const e=Te.findIndex(n=>n.id===t);return e===-1?!1:(Te.splice(e,1),ea(),!0)}function ob(){return Te.filter(t=>t.status==="pending").length}function rb(t){return Te.filter(e=>e.itemId===t).sort((e,n)=>(n.date||0)-(e.date||0))}function ab(t){const e=rb(t);return e.length===0?'<div style="font-size:11px;color:var(--muted)">No offers yet</div>':`
    <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:8px">Offer History</div>
    <div class="inv-table">
      ${e.map(n=>`
        <div style="display:grid;grid-template-columns:1fr;gap:8px;padding:8px;background:var(--surface2);border-radius:2px;margin-bottom:6px;border-left:3px solid ${n.status==="accepted"?"var(--good)":n.status==="rejected"?"var(--danger)":n.status==="countered"?"var(--accent)":n.status==="expired"?"var(--muted)":"var(--accent2)"}">
          <div style="display:flex;justify-content:space-between;align-items:baseline">
            <div style="font-weight:600">${x(n.amount)}</div>
            <div style="font-size:10px;color:var(--muted)">${ce(n.date||Date.now())}</div>
          </div>
          <div style="font-size:10px;color:var(--muted)">
            ${_(n.platform)}  ${_(n.buyerHandle||"Unknown")}
            ${n.status!=="pending"?`  <strong>${_(n.status.toUpperCase())}</strong>`:""}
          </div>
          ${n.counterAmount?`<div style="font-size:10px;color:var(--accent)">Counter: ${x(n.counterAmount)}</div>`:""}
          ${n.notes?`<div style="font-size:10px;color:var(--muted);font-style:italic">${_(n.notes)}</div>`:""}
        </div>
      `).join("")}
    </div>
  `}function lb(){const t=Te.filter(i=>i.status==="pending").sort((i,o)=>(o.date||0)-(i.date||0)).slice(0,20),e=ob(),n=Te.filter(i=>i.status==="accepted").length,s=Te.filter(i=>i.status==="rejected").length;return`
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Offers</div>
        <div style="font-size:14px;font-weight:700;color:var(--accent2)">${e}</div>
      </div>

      <!-- Stats -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:11px">
        <div style="text-align:center">
          <div style="color:var(--muted);font-weight:600;text-transform:uppercase;font-size:9px">Pending</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent2);margin-top:2px">${e}</div>
        </div>
        <div style="text-align:center">
          <div style="color:var(--muted);font-weight:600;text-transform:uppercase;font-size:9px">Accepted</div>
          <div style="font-size:18px;font-weight:700;color:var(--good);margin-top:2px">${n}</div>
        </div>
        <div style="text-align:center">
          <div style="color:var(--muted);font-weight:600;text-transform:uppercase;font-size:9px">Rejected</div>
          <div style="font-size:18px;font-weight:700;color:var(--danger);margin-top:2px">${s}</div>
        </div>
      </div>

      <!-- Pending Offers List -->
      <div style="padding:12px">
        ${t.length===0?'<div class="empty-state">No pending offers</div>':t.map(i=>{const o=q(i.itemId);return`
                <div style="border:1px solid var(--border);border-radius:4px;padding:10px;margin-bottom:8px;background:var(--surface2)">
                  <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px">
                    <div style="font-weight:600;color:var(--text);font-size:12px">${o?_(o.name):"Unknown Item"}</div>
                    <div style="font-size:14px;font-weight:700;color:var(--good)">${x(i.amount)}</div>
                  </div>
                  <div style="font-size:10px;color:var(--muted);margin-bottom:6px">
                    ${_(i.platform)}  ${_(i.buyerHandle||"Unknown")}  ${ce(i.date||Date.now())}
                  </div>
                  ${i.notes?`<div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-style:italic">${_(i.notes)}</div>`:""}
                  <div style="display:flex;gap:6px">
                    <button onclick="offerAccept('${i.id}')" class="btn-primary" style="flex:1;height:28px;font-size:10px">Accept</button>
                    <button onclick="offerCounter('${i.id}')" class="btn-secondary" style="flex:1;height:28px;font-size:10px">Counter</button>
                    <button onclick="offerReject('${i.id}')" class="btn-danger" style="flex:1;height:28px;font-size:10px">Reject</button>
                  </div>
                </div>
              `}).join("")}
      </div>
    </div>
  `}function cb(t){const e=q(t);if(!e){k("Item not found",!0);return}const n=`
    <div style="padding:12px">
      <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:8px">Record Offer</div>
      <div class="form-grid">
        <input id="offer_platform" placeholder="Platform (eBay, Poshmark...)" class="fgrp" style="grid-column:1/-1">
        <input id="offer_amount" type="number" placeholder="Offer Amount" step="0.01" class="fgrp" style="grid-column:1/-1">
        <input id="offer_buyer" placeholder="Buyer Handle" class="fgrp" style="grid-column:1/-1">
        <textarea id="offer_notes" placeholder="Notes (optional)" class="fgrp" style="grid-column:1/-1;height:60px;resize:none"></textarea>
        <button onclick="offerAddConfirm('${t}')" class="btn-primary" style="grid-column:1/-1;height:36px">Add Offer</button>
        <button onclick="this.closest('.panel').remove()" class="btn-secondary" style="grid-column:1/-1;height:36px">Cancel</button>
      </div>
    </div>
  `,s=document.createElement("div");s.className="panel",s.innerHTML=`
    <div class="panel-header"><div class="panel-title">New Offer  ${_(e.name)}</div></div>
    ${n}
  `,document.body.appendChild(s)}function db(t){const e=document.getElementById("offer_platform"),n=document.getElementById("offer_amount"),s=document.getElementById("offer_buyer"),i=document.getElementById("offer_notes"),o=(e.value||"").trim(),r=parseFloat(n.value)||0,a=(s.value||"").trim();if(!o){k("Platform required",!0);return}if(!r){k("Amount required",!0);return}if(!a){k("Buyer handle required",!0);return}sb({itemId:t,platform:o,amount:r,buyerHandle:a,notes:(i.value||"").trim()}),k("Offer recorded"),document.querySelector(".panel-header").closest(".panel").remove()}function ub(t){const e=Te.find(n=>n.id===t);if(!e){k("Offer not found",!0);return}ta(t,{status:"accepted"}),k(`Offer accepted: ${x(e.amount)}`)}function pb(t){if(!Te.find(n=>n.id===t)){k("Offer not found",!0);return}ta(t,{status:"rejected"}),k("Offer rejected")}function fb(t){const e=Te.find(i=>i.id===t);if(!e){k("Offer not found",!0);return}const n=prompt(`Counter offer for ${_(e.buyerHandle)} (current: ${x(e.amount)}):`,x(e.amount));if(!n)return;const s=parseFloat(n);if(isNaN(s)){k("Invalid amount",!0);return}ta(t,{status:"countered",counterAmount:s}),k(`Counter offer sent: ${x(s)}`)}function hb(t){confirm("Delete offer?")&&(ib(t),k("Offer deleted"))}function mb(t,e,n=30){const s=new Date;s.setDate(s.getDate()-n);const i=e.reduce((a,c)=>new Date(c.sold_date)>=s?a+c.quantity:a,0),o=t.reduce((a,c)=>new Date(c.listed_date)>=s?a+c.quantity:a,0),r=o>0?i/o*100:0;return{rate:Math.round(r*10)/10,units_sold:i,units_listed:o,days:n}}function gb(t,e,n){const s=e.reduce((a,c)=>{const l=t.find(d=>d.id===c.item_id);return a+(l?l.cost*c.quantity:0)},0),i=t.length>0?t.reduce((a,c)=>a+c.cost*c.quantity,0)/t.length:0,o=i>0?s/i:0,r=Math.round(o*10)/10;return{turnover_rate:r,cogs:s,avg_inventory_value:Math.round(i*100)/100,times_per_year:r}}function yb(t,e,n){const s=t.reduce((c,l)=>c+l.cost*l.quantity,0),i=e.reduce((c,l)=>c+l.revenue,0),o=i-n.total,r=e.length>0?o/Math.max(1,Math.floor((new Date-new Date(e[0].sold_date))/(1e3*60*60*24))):0;return{days_to_breakeven:r>0?Math.ceil((s-o)/r):null,current_invested:Math.round(s*100)/100,current_revenue:Math.round(i*100)/100,daily_net:Math.round(r*100)/100}}function vb(t,e=12){const n={};return t.forEach(s=>{const i=new Date(s.sold_date),o=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`;n[o]||(n[o]={revenue:0,cost:0,units:0,count:0}),n[o].revenue+=s.revenue||0,n[o].cost+=s.cost||0,n[o].units+=s.quantity||1,n[o].count+=1}),Object.entries(n).sort(([s],[i])=>s.localeCompare(i)).slice(-e).map(([s,i])=>({month:s,revenue:Math.round(i.revenue*100)/100,profit:Math.round((i.revenue-i.cost)*100)/100,units:i.units,yoy_change:0}))}function bb(t,e){const n={};return e.forEach(s=>{const i=t.find(l=>l.id===s.item_id);if(!i)return;const o=`${s.platform}-${i.category}`;n[o]||(n[o]={platform:s.platform,category:i.category,days:[],revenue:0,cost:0,count:0});const r=new Date(i.listed_date),a=new Date(s.sold_date),c=Math.floor((a-r)/(1e3*60*60*24));n[o].days.push(c),n[o].revenue+=s.revenue||0,n[o].cost+=i.cost*s.quantity,n[o].count+=1}),Object.values(n).map(s=>({platform:s.platform,category:s.category,avgDaysToSell:Math.round(s.days.reduce((i,o)=>i+o,0)/s.days.length),revenue:Math.round(s.revenue*100)/100,margin:s.revenue>0?Math.round((s.revenue-s.cost)/s.revenue*1e3)/10:0}))}function wb(t,e){var i;const n={};e.forEach(o=>{const r=t.find(a=>a.id===o.item_id);r&&(n[r.category]||(n[r.category]={units:0,revenue:0,items_listed:0}),n[r.category].units+=o.quantity||1,n[r.category].revenue+=o.revenue||0)}),t.forEach(o=>{n[o.category]||(n[o.category]={units:0,revenue:0,items_listed:0}),n[o.category].items_listed+=o.quantity});const s=Math.max(1,Math.ceil((new Date-new Date(((i=e[0])==null?void 0:i.sold_date)||Date.now()))/(1e3*60*60*24*30)));return Object.entries(n).map(([o,r])=>({category:o,units_per_month:Math.round(r.units/s*10)/10,monthly_revenue:Math.round(r.revenue/s*100)/100,sell_through_rate:r.items_listed>0?Math.round(r.units/r.items_listed*1e3)/10:0}))}function xb(t,e){const n={0:{name:"Sunday",units:0,profit:0},1:{name:"Monday",units:0,profit:0},2:{name:"Tuesday",units:0,profit:0},3:{name:"Wednesday",units:0,profit:0},4:{name:"Thursday",units:0,profit:0},5:{name:"Friday",units:0,profit:0},6:{name:"Saturday",units:0,profit:0}};return t.forEach(s=>{const i=e.find(c=>c.id===s.item_id),r=new Date(s.sold_date).getDay(),a=(s.revenue||0)-(i?i.cost*s.quantity:0);n[r].units+=s.quantity||1,n[r].profit+=a}),Object.values(n).map(s=>({day:s.name,units_sold:s.units,total_profit:Math.round(s.profit*100)/100,avg_profit_per_unit:s.units>0?Math.round(s.profit/s.units*100)/100:0}))}function _b(t){const e={0:0,1:0,2:0,3:0,4:0,5:0,6:0};t.forEach(i=>{const o=new Date(i.sold_date),r=new Date(o.getTime()-Math.random()*7*24*60*60*1e3).getDay();e[r]+=i.revenue||0});const n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s=Object.entries(e).reduce((i,[o,r])=>r>i[1]?[parseInt(o),r]:i);return{day_of_week:n[s[0]],revenue_correlation:Math.round(s[1]),confidence:Math.min(100,Math.round(s[1]/Math.max(...Object.values(e))*100))}}function Sb(t,e=30){const n={};t.forEach(l=>{const u=new Date(l.sold_date).toISOString().split("T")[0];n[u]||(n[u]=0),n[u]+=l.revenue||0});const s=Object.values(n),i=s.length>0?s.reduce((l,d)=>l+d,0)/s.length:0,o=s.length>0?s.reduce((l,d)=>l+Math.pow(d-i,2),0)/s.length:0,r=Math.sqrt(o),a=i*e,c=Math.round(r*1.96);return{daily_average:Math.round(i*100)/100,projected_revenue:Math.round(a*100)/100,confidence_interval:Math.round(c*100)/100,days_ahead:e}}function kb(t,e,n){const s=t.reduce((d,u)=>d+u.cost*u.quantity,0),i=n.total||0,o=s+i,r=e.reduce((d,u)=>d+(u.quantity||1),0),a=r>0?(e.reduce((d,u)=>d+(u.revenue||0),0)-e.reduce((d,u)=>{const p=t.find(h=>h.id===u.item_id);return d+(p?p.cost*u.quantity:0)},0))/r:0,c=a>0?Math.ceil(o/a):null,l=c?Math.max(0,c-r):null;return{units_needed:c,units_already_sold:r,breakeven_revenue:Math.round(o*100)/100,gap:l,avg_profit_per_unit:Math.round(a*100)/100}}const $b=36e5;let Tn={};const Eb="/buy/browse/v1";async function na(t,e={}){if(!t||t.trim().length<2)return sa();const n=`${t.toLowerCase()}|${e.condition||""}`;if(Tn[n]&&Date.now()-Tn[n].ts<$b)return Tn[n].results;if(qe())try{const i=await Ib(t,e);return Tn[n]={results:i,ts:Date.now()},i}catch(i){console.warn("eBay comps error:",i.message)}const s=Tb(t,e);return Tn[n]={results:s,ts:Date.now()},s}async function Ib(t,e){const n=e.limit||20,s=new URLSearchParams({q:t,limit:String(n),sort:"-price",filter:"buyingOptions:{FIXED_PRICE|AUCTION},conditions:{NEW|USED|VERY_GOOD|GOOD|ACCEPTABLE}"}),r=((await ln("GET",`${Eb}/item_summary/search?${s}`)).itemSummaries||[]).map(a=>{var c,l,d,u;return{title:a.title||"",price:parseFloat(((c=a.price)==null?void 0:c.value)||"0"),currency:((l=a.price)==null?void 0:l.currency)||"USD",condition:a.condition||"Unknown",imageUrl:((d=a.image)==null?void 0:d.imageUrl)||"",itemUrl:a.itemWebUrl||"",sold:(u=a.buyingOptions)!=null&&u.includes("FIXED_PRICE")?"Buy It Now":"Auction",date:a.itemEndDate||null}}).filter(a=>a.price>0);return Ud(r,"eBay")}function Tb(t,e){const n=t.toLowerCase(),s=[];for(const i of I){const o=q(i.itemId);if(!o)continue;const r=(o.name||"").toLowerCase(),a=(o.category||"").toLowerCase();!r.includes(n)&&!a.includes(n)||e.condition&&(o.condition||"").toLowerCase()!==e.condition.toLowerCase()||s.push({title:o.name||"Item",price:i.price||0,condition:o.condition||"Unknown",imageUrl:o.image||"",itemUrl:"",sold:"FlipTrack Sale",date:i.date})}return Ud(s,"Local Sales")}function Ud(t,e){if(!t.length)return sa();const n=t.map(r=>r.price).sort((r,a)=>r-a),i=n.reduce((r,a)=>r+a,0)/n.length,o=n.length%2===0?(n[n.length/2-1]+n[n.length/2])/2:n[Math.floor(n.length/2)];return{comps:t,source:e,avgPrice:i,medianPrice:o,lowPrice:n[0],highPrice:n[n.length-1],count:t.length}}function sa(){return{comps:[],source:"None",avgPrice:0,medianPrice:0,lowPrice:0,highPrice:0,count:0}}async function Cb(t,e){const n=await na(t,{condition:e});if(!n.count)return{suggested:0,range:"N/A",confidence:"low"};const s=Math.round(n.medianPrice*.95*100)/100,i=`${x(n.lowPrice)}  ${x(n.highPrice)}`,o=n.count>=10?"high":n.count>=5?"medium":"low";return{suggested:s,range:i,confidence:o}}function Pb(t){if(!t||!t.count)return'<div class="comps-empty">No comparable sales found. Try a different search term.</div>';const e=`
    <div class="comps-stats">
      <div class="comps-stat"><span class="comps-stat-val">${x(t.avgPrice)}</span><span class="comps-stat-lbl">Avg</span></div>
      <div class="comps-stat"><span class="comps-stat-val">${x(t.medianPrice)}</span><span class="comps-stat-lbl">Median</span></div>
      <div class="comps-stat"><span class="comps-stat-val">${x(t.lowPrice)}</span><span class="comps-stat-lbl">Low</span></div>
      <div class="comps-stat"><span class="comps-stat-val">${x(t.highPrice)}</span><span class="comps-stat-lbl">High</span></div>
      <div class="comps-stat"><span class="comps-stat-val">${t.count}</span><span class="comps-stat-lbl">Comps</span></div>
    </div>
  `,n=t.comps.slice(0,8).map(s=>`
    <div class="comps-item">
      ${s.imageUrl?`<img src="${_(s.imageUrl)}" class="comps-thumb" alt="" loading="lazy">`:'<div class="comps-thumb comps-thumb-empty"></div>'}
      <div class="comps-item-info">
        <div class="comps-item-title">${_(s.title.slice(0,60))}</div>
        <div class="comps-item-meta">${_(s.condition)}  ${s.sold}${s.date?`  ${ce(s.date)}`:""}</div>
      </div>
      <div class="comps-item-price">${x(s.price)}</div>
    </div>
  `).join("");return`
    <div class="comps-panel">
      <div class="comps-source">Source: ${_(t.source)}</div>
      ${e}
      <div class="comps-list">${n}</div>
    </div>
  `}async function Db(t){const e=q(t);return!e||!e.name?sa():na(e.name,{condition:e.condition})}function Bb(){Tn={}}let gs="FlipTrack",ys=.3,vs="bottom-right",bs=10,Bt=.85;async function Ob(){const t=await we("photo_settings");t&&(gs=t.watermarkText||"FlipTrack",ys=t.watermarkOpacity??.3,vs=t.watermarkPosition||"bottom-right",bs=t.autoCropPadding??10,Bt=t.jpegQuality??.85)}async function Ab(t){gs=t.watermarkText||gs,ys=t.watermarkOpacity??ys,vs=t.watermarkPosition||vs,bs=t.autoCropPadding??bs,Bt=t.jpegQuality??Bt,await te("photo_settings",{watermarkText:gs,watermarkOpacity:ys,watermarkPosition:vs,autoCropPadding:bs,jpegQuality:Bt})}async function xl(t,e={}){const n=e.threshold??240,s=e.feather??2,i=await Xs(t),o=document.createElement("canvas");o.width=i.width,o.height=i.height;const r=o.getContext("2d");r.drawImage(i,0,0);const a=r.getImageData(0,0,o.width,o.height),c=a.data,l=o.width,d=o.height,u=new Uint8Array(l*d),p=new Uint8Array(l*d),h=[];for(let f=0;f<l;f++)h.push(f),h.push(f+(d-1)*l);for(let f=0;f<d;f++)h.push(f*l),h.push(l-1+f*l);for(;h.length;){const f=h.pop();if(f<0||f>=l*d||u[f])continue;u[f]=1;const g=f*4,m=c[g],v=c[g+1],E=c[g+2];if(.299*m+.587*v+.114*E>=n){p[f]=1;const S=f%l,C=Math.floor(f/l);S>0&&h.push(f-1),S<l-1&&h.push(f+1),C>0&&h.push(f-l),C<d-1&&h.push(f+l)}}for(let f=0;f<l*d;f++)if(p[f])c[f*4+3]=0;else if(s>0){const g=f%l,m=Math.floor(f/l);let v=s+1;for(let E=-s;E<=s;E++)for(let w=-s;w<=s;w++){const S=g+w,C=m+E;if(S>=0&&S<l&&C>=0&&C<d&&p[C*l+S]){const B=Math.sqrt(w*w+E*E);v=Math.min(v,B)}}v<=s&&(c[f*4+3]=Math.round(255*(v/s)))}return r.putImageData(a,0,0),o.toDataURL("image/png")}async function _l(t,e={}){const n=e.padding??bs,s=e.threshold??250,i=await Xs(t),o=document.createElement("canvas");o.width=i.width,o.height=i.height;const r=o.getContext("2d");r.drawImage(i,0,0);const c=r.getImageData(0,0,o.width,o.height).data,l=o.width,d=o.height;let u=d,p=l,h=0,f=0;for(let w=0;w<d;w++)for(let S=0;S<l;S++){const C=(w*l+S)*4,B=c[C],L=c[C+1],O=c[C+2];c[C+3]>10&&(B<s||L<s||O<s)&&(w<u&&(u=w),w>h&&(h=w),S<p&&(p=S),S>f&&(f=S))}if(h<=u||f<=p)return t;u=Math.max(0,u-n),p=Math.max(0,p-n),h=Math.min(d-1,h+n),f=Math.min(l-1,f+n);const g=f-p+1,m=h-u+1,v=document.createElement("canvas");return v.width=g,v.height=m,v.getContext("2d").drawImage(o,p,u,g,m,0,0,g,m),v.toDataURL("image/jpeg",Bt)}async function Sl(t,e={}){const n=e.text||gs,s=e.opacity??ys,i=e.position||vs,o=await Xs(t),r=document.createElement("canvas");r.width=o.width,r.height=o.height;const a=r.getContext("2d");a.drawImage(o,0,0);const c=Math.max(14,Math.round(o.width/20));a.font=`bold ${c}px sans-serif`,a.globalAlpha=s,a.fillStyle="rgba(255,255,255,0.9)",a.strokeStyle="rgba(0,0,0,0.5)",a.lineWidth=2;const d=a.measureText(n).width,u=c;let p,h;switch(i){case"top-left":p=u,h=u+c;break;case"top-right":p=o.width-d-u,h=u+c;break;case"bottom-left":p=u,h=o.height-u;break;case"center":p=(o.width-d)/2,h=o.height/2;break;default:p=o.width-d-u,h=o.height-u}return a.strokeText(n,p,h),a.fillText(n,p,h),a.globalAlpha=1,r.toDataURL("image/jpeg",Bt)}async function kl(t,e={}){const n=(e.brightness||0)/100,s=(e.contrast||0)/100,i=(e.saturation||0)/100,o=await Xs(t),r=document.createElement("canvas");r.width=o.width,r.height=o.height;const a=r.getContext("2d"),c=[];return n&&c.push(`brightness(${1+n})`),s&&c.push(`contrast(${1+s})`),i&&c.push(`saturate(${1+i})`),c.length&&(a.filter=c.join(" ")),a.drawImage(o,0,0),a.filter="none",r.toDataURL("image/jpeg",Bt)}async function $l(t,e={}){const n=e.bgColor||"#ffffff",s=e.size||1200,i=await Xs(t),o=document.createElement("canvas");o.width=s,o.height=s;const r=o.getContext("2d");r.fillStyle=n,r.fillRect(0,0,s,s);const a=Math.min(s/i.width,s/i.height)*.9,c=i.width*a,l=i.height*a,d=(s-c)/2,u=(s-l)/2;return r.drawImage(i,d,u,c,l),o.toDataURL("image/jpeg",Bt)}function Lb(t,e){return t?`
    <div class="pt-panel" data-item="${_(e)}">
      <div class="pt-preview">
        <img src="${_(t)}" id="ptPreview" class="pt-img" alt="Preview">
      </div>
      <div class="pt-tools">
        <button class="pt-btn" onclick="ptRemoveBg('${_(e)}')" title="Remove background">
           Remove BG
        </button>
        <button class="pt-btn" onclick="ptAutoCrop('${_(e)}')" title="Auto-crop whitespace">
           Auto-Crop
        </button>
        <button class="pt-btn" onclick="ptWatermark('${_(e)}')" title="Add watermark">
           Watermark
        </button>
        <button class="pt-btn" onclick="ptSquare('${_(e)}')" title="Square pad for marketplace">
           Square Pad
        </button>
      </div>
      <div class="pt-sliders">
        <label class="pt-slider-row">
          <span>Brightness</span>
          <input type="range" min="-50" max="50" value="0" id="ptBrightness"
            oninput="ptAdjustPreview('${_(e)}')">
        </label>
        <label class="pt-slider-row">
          <span>Contrast</span>
          <input type="range" min="-50" max="50" value="0" id="ptContrast"
            oninput="ptAdjustPreview('${_(e)}')">
        </label>
      </div>
    </div>
  `:'<div class="pt-empty">No image to edit. Add a photo first.</div>'}function Xs(t){return new Promise((e,n)=>{const s=new Image;s.crossOrigin="anonymous",s.onload=()=>e(s),s.onerror=()=>n(new Error("Failed to load image")),s.src=t})}function Fd(t){const{cost:e=0,price:n=0,platforms:s=[],shipping:i=0,tax:o=0}=t,r=e+o,a=s.map(h=>{const f=_s[h]||{pct:0},g=n*(f.pct||0)+(f.fixed||0),m=n-g,v=m-r-i,E=n>0?v/n:0,w=r>0?v/r:0;return{platform:h,fee:Math.round(g*100)/100,feePct:f.pct||0,netRevenue:Math.round(m*100)/100,profit:Math.round(v*100)/100,margin:E,roi:w}}),c=a.map(h=>h.profit),l=c.length?Math.max(...c):n-r-i,d=c.length?Math.min(...c):n-r-i,u=c.length?c.reduce((h,f)=>h+f,0)/c.length:n-r-i,p=s.map(h=>{const f=_s[h]||{pct:0},g=(r+i+(f.fixed||0))/(1-(f.pct||0));return{platform:h,breakEven:Math.round(g*100)/100}});return{totalCost:r,shipping:i,platforms:a,bestProfit:l,worstProfit:d,avgProfit:u,breakEvenPrices:p,isProfitable:u>0}}function Rb(t){const e=Fd(t);if(!t.cost&&!t.price)return'<div class="pc-hint">Enter cost and price to see profit estimates</div>';const n=e.isProfitable?"var(--good)":"var(--danger)",s=e.isProfitable?"":"";let i='<div class="pc-panel">';if(i+=`
    <div class="pc-summary">
      <div class="pc-big" style="color:${n}">${s} ${x(e.avgProfit)}</div>
      <div class="pc-sub">Est. profit${e.platforms.length>1?" (avg across platforms)":""}</div>
    </div>
  `,e.platforms.length){i+='<div class="pc-platforms">';for(const o of e.platforms){const r=o.profit>0?"pc-pos":"pc-neg";i+=`
        <div class="pc-plat-row ${r}">
          <span class="pc-plat-name">${o.platform}</span>
          <span class="pc-plat-fee">Fee: ${x(o.fee)} (${V(o.feePct)})</span>
          <span class="pc-plat-profit" style="color:${o.profit>0?"var(--good)":"var(--danger)"}">${x(o.profit)}</span>
          <span class="pc-plat-roi">${o.roi>0?V(o.roi)+" ROI":""}</span>
        </div>
      `}i+="</div>"}if(e.breakEvenPrices.length){const o=Math.min(...e.breakEvenPrices.map(r=>r.breakEven));i+=`<div class="pc-breakeven">Break-even price: ${x(o)}</div>`}return i+="</div>",i}function Mb(t,e,n){if(!t||!e)return"";const s=_s[n]||{pct:0},i=e*(s.pct||0)+(s.fixed||0),o=e-t-i,r=t>0?o/t:0,a=o>=0?"+":"",c=n?` after ${n} fees`:"";return`${a}${x(o)} (${V(r)} ROI)${c}`}let Yn=[],nn=new Set,Fn=null,Xt={current:0,total:0,status:"idle"};function jb(t){Yn=t.filter(e=>{const n=q(e);return n&&(n.qty||0)>0}),nn.clear(),Fn=null,Xt={current:0,total:0,status:"idle"}}function El(t){nn.has(t)?nn.delete(t):nn.add(t)}function Nb(){return{items:Yn.map(t=>q(t)).filter(Boolean),platforms:[...nn],template:Fn,progress:{...Xt}}}async function Il(t={}){var c;const e=t.delayMs||2e3,n=[...nn],s=Yn.map(l=>q(l)).filter(Boolean);if(!s.length||!n.length)return k("Select items and platforms first",!0),{success:0,failed:0,skipped:0};Xt={current:0,total:s.length*n.length,status:"running"};let o=0,r=0,a=0;for(const l of s)for(const d of n){if(Xt.current++,t.onProgress&&t.onProgress(Xt),((c=l.platformStatus)==null?void 0:c[d])==="active"){a++;continue}try{if(d==="eBay"&&qe())(await Sd(l.id)).success&&l.price>0&&await kd(l.id),o++;else{const u=Fn?{titleFormula:Fn}:null,{title:p,description:h}=Tr(l,u);await navigator.clipboard.writeText(`${p}

${h}`);const f=Mc(d,l);window.open(f,"_blank"),He(l.id,d,"draft"),un(l.id,d,new Date().toISOString().split("T")[0]),J("inv",l.id),o++,e>0&&await new Promise(g=>setTimeout(g,e))}}catch(u){console.warn(`Batch list error for ${l.name} on ${d}:`,u.message),r++}}return R(),W(),Xt.status="done",k(`Batch listing complete: ${o} listed, ${a} skipped, ${r} failed`),{success:o,failed:r,skipped:a}}function zb(){return Yn.map(n=>q(n)).filter(Boolean).map(n=>{const{title:s,description:i}=Tr(n,Fn);return`=== ${s} ===
${i}
`}).join(`
---

`)}async function Tl(){const t=zb();try{await navigator.clipboard.writeText(t),k(`Copied listing text for ${Yn.length} items `)}catch{k("Copy failed",!0)}}function Ub(){const t=Nb();if(!t.items.length)return`<div class="bl-empty">
      <p>No items selected for batch listing.</p>
      <p style="color:var(--muted)">Select items from inventory using checkboxes, then click "Batch List".</p>
    </div>`;let e=`<div class="bl-panel">
    <div class="bl-header">
      <span class="bl-count">${t.items.length} items selected</span>
      <button class="btn-sm" onclick="blClearSelection()">Clear</button>
    </div>
  `;e+='<div class="bl-section"><div class="bl-section-title">Platforms to list on:</div><div class="bl-plat-grid">';const n=["eBay","Poshmark","Mercari","Depop","Etsy","Facebook Marketplace","Amazon","Grailed","Vinted","Whatnot"];for(const s of n){const i=t.platforms.includes(s),o=s==="eBay"&&qe()?" (API)":"";e+=`<button class="bl-plat-chip ${i?"active":""}" onclick="blTogglePlatform('${_(s)}')">${_(s)}${o}</button>`}e+="</div></div>",e+='<div class="bl-section"><div class="bl-section-title">Items:</div><div class="bl-items">';for(const s of t.items.slice(0,10))e+=`
      <div class="bl-item-row">
        <span class="bl-item-name">${_((s.name||"Item").slice(0,40))}</span>
        <span class="bl-item-price">${x(s.price||0)}</span>
        <span class="bl-item-plats">${Y(s).join(", ")||"None"}</span>
      </div>
    `;if(t.items.length>10&&(e+=`<div class="bl-more">+ ${t.items.length-10} more</div>`),e+="</div></div>",e+=`
    <div class="bl-actions">
      <button class="btn-primary" onclick="blExecute()" ${t.platforms.length?"":"disabled"}>
         Start Batch Listing
      </button>
      <button class="btn-secondary" onclick="blCopyAll()">
         Copy All Listing Text
      </button>
    </div>
  `,t.progress.status==="running"){const s=t.progress.total>0?Math.round(t.progress.current/t.progress.total*100):0;e+=`
      <div class="bl-progress">
        <div class="bl-progress-bar"><div class="bl-progress-fill" style="width:${s}%"></div></div>
        <div class="bl-progress-text">${t.progress.current} / ${t.progress.total}</div>
      </div>
    `}return e+="</div>",e}function Cl(){Yn=[],nn.clear(),Fn=null,Xt={current:0,total:0,status:"idle"}}const Fb=`${Ui}/functions/v1/anthropic-proxy`;let zi=null,wi=!1;function qb(t){zi=t}async function Hb(){if(!zi)throw new Error("Not authenticated");const{data:{session:t}}=await zi.auth.getSession();if(!t)throw new Error("Session expired  please log in");return{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`}}async function Wb(t,e={}){var n,s;if(wi)throw new Error("Already generating  please wait");if(!zi)throw new Error("Sign in to use AI features");wi=!0;try{const i=e.platform||Y(t)[0]||"eBay",o=e.tone||"professional",r=Gb(t,i,o,e.includeKeywords!==!1),a=await Hb(),c=await fetch(Fb,{method:"POST",headers:a,body:JSON.stringify({model:"claude-haiku-4-5-20251001",max_tokens:1024,messages:[{role:"user",content:r}]})});if(!c.ok){const u=await c.json().catch(()=>({}));throw new Error(u.error||`AI request failed: ${c.status}`)}const d=((s=(n=(await c.json()).content)==null?void 0:n[0])==null?void 0:s.text)||"";return Vb(d)}finally{wi=!1}}function Gb(t,e,n,s){const i=[];t.name&&i.push(`Item: ${t.name}`),t.category&&i.push(`Category: ${t.category}`),t.subcategory&&i.push(`Subcategory: ${t.subcategory}`),t.condition&&i.push(`Condition: ${t.condition}`),t.notes&&i.push(`Notes: ${t.notes}`),t.upc&&i.push(`UPC: ${t.upc}`),t.isbn&&i.push(`ISBN: ${t.isbn}`),t.author&&i.push(`Author: ${t.author}`),t.price&&i.push(`Price: $${t.price}`),t.dimL&&t.dimW&&t.dimH&&i.push(`Dimensions: ${t.dimL}  ${t.dimW}  ${t.dimH} ${t.dimUnit||"in"}`),t.weight&&i.push(`Weight: ${t.weight} ${t.dimUnit==="cm"?"kg":"lb"}`);const o={eBay:"eBay: max 80 char title, include brand/model/key specs. Description should be detailed with condition notes.",Poshmark:"Poshmark: max 80 char title. Description should mention fit, fabric, measurements. Casual friendly tone.",Mercari:"Mercari: short catchy title. Description should be concise and honest about condition.",Depop:"Depop: trendy, hashtag-friendly. Use Gen-Z friendly language. Include style/aesthetic references.",Etsy:"Etsy: include relevant search terms. Description should tell a story about the item. Emphasize uniqueness.","Facebook Marketplace":"Facebook Marketplace: casual, local-friendly. Mention pickup/shipping availability.",Amazon:"Amazon: bullet-point style features. Focus on product specifications and condition details."};return`You are an expert reseller listing copywriter. Generate an optimized marketplace listing.

ITEM DETAILS:
${i.join(`
`)}

PLATFORM: ${e}
${o[e]||""}

TONE: ${n}

REQUIREMENTS:
- Generate a compelling title (under 80 characters)
- Generate a detailed description (150-300 words)
${s?"- Include 5-8 relevant search keywords":""}
- Include condition details and any flaws
- End with a call to action

FORMAT YOUR RESPONSE EXACTLY LIKE THIS:
TITLE: [your title here]
DESCRIPTION:
[your description here]
${s?"KEYWORDS: [comma-separated keywords]":""}
SEO_TIPS: [2-3 tips for better listing visibility]`}function Vb(t){const e=t.match(/TITLE:\s*(.+?)(?:\n|$)/),n=t.match(/DESCRIPTION:\s*([\s\S]*?)(?=KEYWORDS:|SEO_TIPS:|$)/),s=t.match(/KEYWORDS:\s*(.+?)(?:\n|$)/),i=t.match(/SEO_TIPS:\s*([\s\S]*?)$/);return{title:e?e[1].trim():"",description:n?n[1].trim():"",keywords:s?s[1].split(",").map(o=>o.trim()).filter(Boolean):[],seoTips:i?i[1].split(`
`).map(o=>o.replace(/^[-*]\s*/,"").trim()).filter(Boolean):[]}}async function Pl(t,e={}){const n=q(t);if(!n)throw new Error("Item not found");k("Generating AI listing");const s=await Wb(n,e);return(s.title||s.description)&&(n.aiListing||(n.aiListing={}),n.aiListing.title=s.title,n.aiListing.description=s.description,n.aiListing.keywords=s.keywords,n.aiListing.generatedAt=new Date().toISOString(),n.aiListing.platform=e.platform||"",J("inv",t),R(),k("AI listing generated ")),s}function Dl(t){var i;const e=t.aiListing||{},n=e.title||e.description;let s='<div class="ai-panel">';return n&&(s+=`
      <div class="ai-existing">
        <div class="ai-label">AI-Generated Title:</div>
        <div class="ai-title">${_(e.title)}</div>
        <div class="ai-label" style="margin-top:8px">AI-Generated Description:</div>
        <div class="ai-desc">${_(e.description).replace(/\n/g,"<br>")}</div>
        ${(i=e.keywords)!=null&&i.length?`<div class="ai-keywords">${e.keywords.map(o=>`<span class="ai-kw">${_(o)}</span>`).join("")}</div>`:""}
        <div class="ai-meta">Generated ${e.generatedAt?new Date(e.generatedAt).toLocaleDateString():""} ${e.platform?`for ${e.platform}`:""}</div>
      </div>
      <div class="ai-actions">
        <button class="btn-sm" onclick="aiCopyListing('${t.id}')"> Copy</button>
        <button class="btn-sm" onclick="aiRegenerate('${t.id}')"> Regenerate</button>
      </div>
    `),s+=`
    <div class="ai-generate">
      <div class="ai-gen-row">
        <select id="aiPlatform" class="ai-select">
          <option value="">Any Platform</option>
          <option value="eBay">eBay</option>
          <option value="Poshmark">Poshmark</option>
          <option value="Mercari">Mercari</option>
          <option value="Depop">Depop</option>
          <option value="Etsy">Etsy</option>
          <option value="Facebook Marketplace">Facebook</option>
          <option value="Amazon">Amazon</option>
        </select>
        <select id="aiTone" class="ai-select">
          <option value="professional">Professional</option>
          <option value="casual">Casual</option>
          <option value="urgent">Urgent/Sale</option>
          <option value="luxury">Luxury</option>
        </select>
      </div>
      <button class="btn-primary ai-gen-btn" onclick="aiGenerate('${t.id}')" ${wi?"disabled":""}>
         ${n?"Regenerate":"Generate"} AI Listing
      </button>
      <div class="ai-cost-note">~$0.002 per generation (Claude Haiku)</div>
    </div>
  `,s+="</div>",s}async function Bl(t){const e=q(t);if(!(e!=null&&e.aiListing))return;const n=`${e.aiListing.title}

${e.aiListing.description}`;try{await navigator.clipboard.writeText(n),k("AI listing copied to clipboard ")}catch{k("Copy failed",!0)}}function Kb(){const t=Date.now(),e=864e5,n=$.filter(w=>(w.qty||0)>0),s=n.reduce((w,S)=>w+(S.price||0)*(S.qty||1),0),i=n.reduce((w,S)=>w+(S.cost||0)*(S.qty||1),0),o=n.reduce((w,S)=>w+(S.qty||1),0),r=s-i,a=s>0?r/s:0,c=[{label:"0-7 days",min:0,max:7,items:[],value:0,cost:0},{label:"8-30 days",min:8,max:30,items:[],value:0,cost:0},{label:"31-60 days",min:31,max:60,items:[],value:0,cost:0},{label:"61-90 days",min:61,max:90,items:[],value:0,cost:0},{label:"90+ days",min:91,max:1/0,items:[],value:0,cost:0}];for(const w of n){const S=w.added?new Date(w.added).getTime():t,C=Math.floor((t-S)/e),B=(w.price||0)*(w.qty||1),L=(w.cost||0)*(w.qty||1);for(const O of c)if(C>=O.min&&C<=O.max){O.items.push(w),O.value+=B,O.cost+=L;break}}const l={};for(const w of n){const S=w.category||"Uncategorized";l[S]||(l[S]={count:0,units:0,value:0,cost:0,items:[]}),l[S].count++,l[S].units+=w.qty||1,l[S].value+=(w.price||0)*(w.qty||1),l[S].cost+=(w.cost||0)*(w.qty||1),l[S].items.push(w)}const d=Object.entries(l).map(([w,S])=>({name:w,...S,profit:S.value-S.cost,margin:S.value>0?(S.value-S.cost)/S.value:0})).sort((w,S)=>S.value-w.value),u=t-30*e,p=I.filter(w=>new Date(w.date).getTime()>=u),h=p.reduce((w,S)=>w+(S.price||0)*(S.qty||0),0),f=p.reduce((w,S)=>w+(S.qty||0),0),g=f>0?Math.round(o/f*30):null,m=h,v=[...n].sort((w,S)=>(S.price||0)*(S.qty||1)-(w.price||0)*(w.qty||1)).slice(0,10),E=n.filter(w=>{const S=w.added?new Date(w.added).getTime():t;return t-S>30*e}).filter(w=>!p.some(S=>S.itemId===w.id)).sort((w,S)=>(S.price||0)*(S.qty||1)-(w.price||0)*(w.qty||1)).slice(0,10);return{totalRetailValue:s,totalCostBasis:i,totalUnits:o,potentialProfit:r,avgMargin:a,itemCount:n.length,agingBuckets:c,categories:d,monthlySalesRevenue:h,monthlySalesUnits:f,daysToSellAll:g,projectedRevenue30d:m,topItems:v,slowMovers:E}}function qd(){const t=Kb();let e='<div class="iv-dashboard">';e+=`<div class="iv-cards">
    <div class="iv-card">
      <div class="iv-card-label">Total Retail Value</div>
      <div class="iv-card-value">${x(t.totalRetailValue)}</div>
      <div class="iv-card-sub">${t.totalUnits} units  ${t.itemCount} unique items</div>
    </div>
    <div class="iv-card">
      <div class="iv-card-label">Cost Basis</div>
      <div class="iv-card-value">${x(t.totalCostBasis)}</div>
      <div class="iv-card-sub">Invested in current inventory</div>
    </div>
    <div class="iv-card">
      <div class="iv-card-label">Potential Profit</div>
      <div class="iv-card-value" style="color:${t.potentialProfit>=0?"var(--good)":"var(--danger)"}">${x(t.potentialProfit)}</div>
      <div class="iv-card-sub">${V(t.avgMargin)} avg margin</div>
    </div>
    <div class="iv-card">
      <div class="iv-card-label">Sell-Through Projection</div>
      <div class="iv-card-value">${t.daysToSellAll?t.daysToSellAll+"d":""}</div>
      <div class="iv-card-sub">${t.daysToSellAll?"to sell all at current rate":"No recent sales"}</div>
    </div>
  </div>`,e+=`<div class="iv-section">
    <h4 class="iv-section-title"> Inventory Aging</h4>
    <div class="iv-aging">
  `;const n=Math.max(...t.agingBuckets.map(s=>s.value),1);for(const s of t.agingBuckets){const i=s.value/n*100,o=s.min>=61?" iv-aging-danger":s.min>=31?" iv-aging-warn":"";e+=`
      <div class="iv-aging-row${o}">
        <span class="iv-aging-label">${s.label}</span>
        <div class="iv-aging-bar-wrap">
          <div class="iv-aging-bar" style="width:${i}%"></div>
        </div>
        <span class="iv-aging-val">${x(s.value)} (${s.items.length})</span>
      </div>
    `}e+="</div></div>",e+=`<div class="iv-section">
    <h4 class="iv-section-title"> Value by Category</h4>
    <div class="iv-categories">
  `;for(const s of t.categories.slice(0,8)){const i=t.totalRetailValue>0?s.value/t.totalRetailValue*100:0;e+=`
      <div class="iv-cat-row">
        <span class="iv-cat-name">${_(s.name)}</span>
        <div class="iv-cat-bar-wrap">
          <div class="iv-cat-bar" style="width:${i}%"></div>
        </div>
        <span class="iv-cat-val">${x(s.value)}</span>
        <span class="iv-cat-margin" style="color:${s.margin>=.3?"var(--good)":"var(--warn)"}">${V(s.margin)}</span>
      </div>
    `}e+="</div></div>",e+=`<div class="iv-section">
    <h4 class="iv-section-title"> Top Value Items</h4>
    <div class="iv-top-items">
  `;for(const s of t.topItems){const i=(s.price||0)*(s.qty||1);e+=`
      <div class="iv-item-row" onclick="openDrawer('${s.id}')">
        <span class="iv-item-name">${_((s.name||"Item").slice(0,40))}</span>
        <span class="iv-item-qty">${s.qty||1}</span>
        <span class="iv-item-val">${x(i)}</span>
      </div>
    `}if(e+="</div></div>",t.slowMovers.length){e+=`<div class="iv-section">
      <h4 class="iv-section-title"> Slow Movers (30+ days, no recent sales)</h4>
      <div class="iv-top-items">
    `;for(const s of t.slowMovers){const i=Math.floor((Date.now()-new Date(s.added||Date.now()).getTime())/864e5);e+=`
        <div class="iv-item-row iv-slow" onclick="openDrawer('${s.id}')">
          <span class="iv-item-name">${_((s.name||"Item").slice(0,40))}</span>
          <span class="iv-item-days">${i}d old</span>
          <span class="iv-item-val">${x((s.price||0)*(s.qty||1))}</span>
        </div>
      `}e+="</div></div>"}return e+="</div>",e}const Jb=[{name:"Nike Air Max 90 OG",category:"Footwear",subcategory:"Sneakers",platforms:["eBay","StockX","Mercari"],cost:45,price:120,qty:1,condition:"Pre-Owned",sku:"FT-NKE-001"},{name:"Vintage Levi's 501 Jeans",category:"Clothing",subcategory:"Denim",platforms:["Poshmark","eBay","Depop"],cost:8,price:65,qty:2,condition:"Pre-Owned",sku:"FT-LEV-002"},{name:"Canon EOS Rebel T7 Camera",category:"Electronics",subcategory:"Cameras",platforms:["eBay","Facebook Marketplace"],cost:180,price:350,qty:1,condition:"Like New",sku:"FT-CAN-003"},{name:"First Edition Harry Potter GoF",category:"Books",subcategory:"Fiction",platforms:["eBay","Amazon"],cost:12,price:85,qty:1,condition:"Good",sku:"FT-HPB-004"},{name:"Pyrex Vintage Mixing Bowl Set",category:"Home & Garden",subcategory:"Kitchen",platforms:["eBay","Etsy"],cost:15,price:90,qty:1,condition:"Good",sku:"FT-PYR-005"},{name:"Supreme Box Logo Hoodie FW21",category:"Clothing",subcategory:"Streetwear",platforms:["Grailed","StockX","Depop"],cost:220,price:480,qty:1,condition:"New with Tags",sku:"FT-SUP-006"},{name:"Sony WH-1000XM4 Headphones",category:"Electronics",subcategory:"Audio",platforms:["eBay","Mercari","Amazon"],cost:95,price:175,qty:1,condition:"Refurbished",sku:"FT-SNY-007"},{name:"Pokmon Base Set Charizard PSA 7",category:"Collectibles",subcategory:"Trading Cards",platforms:["eBay"],cost:150,price:420,qty:1,condition:"Graded",sku:"FT-PKM-008"},{name:"Le Creuset Dutch Oven 5.5qt",category:"Home & Garden",subcategory:"Kitchen",platforms:["eBay","Facebook Marketplace","Mercari"],cost:40,price:145,qty:1,condition:"Pre-Owned",sku:"FT-LCR-009"},{name:"Jordan 4 Retro Thunder",category:"Footwear",subcategory:"Sneakers",platforms:["StockX","GOAT","eBay"],cost:190,price:310,qty:2,condition:"Deadstock",sku:"FT-JRD-010"},{name:"Vintage Coach Crossbody Bag",category:"Clothing",subcategory:"Bags",platforms:["Poshmark","eBay","Etsy"],cost:18,price:78,qty:1,condition:"Pre-Owned",sku:"FT-CCH-011"},{name:"KitchenAid Stand Mixer KSM150",category:"Home & Garden",subcategory:"Kitchen",platforms:["eBay","Facebook Marketplace"],cost:65,price:185,qty:1,condition:"Pre-Owned",sku:"FT-KAD-012"},{name:"Nintendo Switch OLED Bundle",category:"Electronics",subcategory:"Gaming",platforms:["eBay","Mercari","Facebook Marketplace"],cost:230,price:340,qty:1,condition:"Like New",sku:"FT-NSW-013"},{name:"Patagonia Better Sweater Vest",category:"Clothing",subcategory:"Outerwear",platforms:["Poshmark","eBay","Depop"],cost:22,price:68,qty:3,condition:"Pre-Owned",sku:"FT-PAT-014"},{name:"Dyson V8 Cordless Vacuum",category:"Home & Garden",subcategory:"Appliances",platforms:["eBay","Facebook Marketplace"],cost:55,price:165,qty:1,condition:"Refurbished",sku:"FT-DYS-015"},{name:"Vintage Star Wars Figure Lot",category:"Collectibles",subcategory:"Toys",platforms:["eBay"],cost:35,price:125,qty:1,condition:"Pre-Owned",sku:"FT-SWF-016"},{name:"Anthropologie Table Runner",category:"Home & Garden",subcategory:"Decor",platforms:["Poshmark","eBay","Etsy"],cost:5,price:42,qty:2,condition:"New without Tags",sku:"FT-ANT-017"},{name:"Apple AirPods Pro 2nd Gen",category:"Electronics",subcategory:"Audio",platforms:["eBay","Mercari","Amazon"],cost:140,price:210,qty:1,condition:"Open Box",sku:"FT-APL-018"}];function kt(t){const e=new Date;return e.setDate(e.getDate()-t),e.toISOString().slice(0,10)}function Yb(){return Jb.map((t,e)=>({id:ie(),name:t.name,category:t.category,subcategory:t.subcategory||"",subtype:"",platforms:t.platforms||[],cost:t.cost,price:t.price,fees:Math.round(t.price*.12*100)/100,ship:Math.round((3+Math.random()*8)*100)/100,qty:t.qty,condition:t.condition||"",sku:t.sku||"",upc:"",notes:"",added:kt(Math.floor(Math.random()*60)+5),image:"",images:[],bulk:t.qty>1,lowAlert:2}))}function Qb(t){return[0,2,3,5,6,7,9,10,12,14,15,17].map(n=>{const s=t[n],i=s.price+Math.round((Math.random()*20-10)*100)/100,o=Math.round(i*.12*100)/100,r=Math.round((4+Math.random()*6)*100)/100;return{id:ie(),itemId:s.id,date:kt(Math.floor(Math.random()*30)),price:i,qty:1,fees:o,ship:r,platform:s.platforms[0]||"eBay",buyer:"",notes:""}})}function Xb(){return[{id:ie(),date:kt(25),category:"Shipping Supplies",desc:"USPS Flat Rate Boxes (20)",amount:16.8},{id:ie(),date:kt(18),category:"Software",desc:"eBay Store Subscription",amount:21.95},{id:ie(),date:kt(12),category:"Shipping Supplies",desc:"Poly Mailers (50 pack)",amount:12.99},{id:ie(),date:kt(8),category:"Sourcing",desc:"Goodwill thrift haul gas",amount:8.5},{id:ie(),date:kt(4),category:"Software",desc:"Photo editing subscription",amount:9.99},{id:ie(),date:kt(1),category:"Shipping Supplies",desc:"Bubble wrap roll",amount:14.5}]}function Hd(){if(($.length>0||I.length>0)&&!confirm("This will ADD demo data alongside your existing data. Continue?"))return!1;const t=Yb(),e=Qb(t),n=Xb();for(const s of e){const i=t.find(o=>o.id===s.itemId);i&&(i.qty=Math.max(0,i.qty-s.qty))}return $.push(...t),I.push(...e),Q.push(...n),R(),Wn(),W(),k("Demo data loaded  18 items, 12 sales, 6 expenses"),!0}function Wd(){const t=new Set($.filter(e=>(e.sku||"").startsWith("FT-")).map(e=>e.id));$.length=0,$.push(...$.filter(e=>!t.has(e.id))),I.length=0,I.push(...I.filter(e=>!t.has(e.itemId))),R(),Wn(),W(),k("Demo data cleared")}function Zb(){const t=document.querySelector(".logo");if(!t)return;let e=0,n=null;t.addEventListener("click",()=>{if(e++,clearTimeout(n),e>=3){e=0;const s=$.some(i=>(i.sku||"").startsWith("FT-"))?confirm("Remove demo data?")?"clear":null:"load";s==="load"?Hd():s==="clear"&&Wd()}else n=setTimeout(()=>{e=0},600)})}let dn="default",xi=null;const ew=3e5;async function tw(){if(!("Notification"in window))return k("Notifications not supported in this browser",!0),!1;const t=await Notification.requestPermission();return dn=t,localStorage.setItem("ft_notif_perm",t),t==="granted"?(k("Notifications enabled"),!0):(k("Notification permission denied",!0),!1)}function Ao(t,e,n){if(dn==="granted")try{const s=new Notification(t,{body:e,icon:"./icons/icon-192.png",badge:"./icons/icon-192.png",tag:n,silent:!1});s.onclick=()=>{window.focus(),s.close()}}catch{"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.ready.then(i=>{i.showNotification(t,{body:e,tag:n})}).catch(()=>{})}}function Ol(){if(dn!=="granted")return;const t=localStorage.getItem("ft_notif_lastcheck")||"0",e=Date.now();if(e-parseInt(t)<36e5)return;const n=$.filter(o=>(o.qty||0)===0&&o.bulk),s=$.filter(o=>o.bulk&&(o.qty||0)>0&&(o.qty||0)<=(o.lowAlert||2)),i=ee.filter(o=>(o.qty||0)>0&&(o.qty||0)<=(o.lowAlert||5));n.length>0&&Ao(`${n.length} item${n.length>1?"s":""} out of stock`,n.slice(0,3).map(o=>o.name).join(", ")+(n.length>3?` +${n.length-3} more`:""),"ft-oos"),s.length>0&&Ao(`${s.length} item${s.length>1?"s":""} running low`,s.slice(0,3).map(o=>`${o.name} (${o.qty} left)`).join(", "),"ft-low"),i.length>0&&Ao(`${i.length} supply item${i.length>1?"s":""} running low`,i.slice(0,3).map(o=>`${o.name} (${o.qty} left)`).join(", "),"ft-supplies-low"),localStorage.setItem("ft_notif_lastcheck",String(e))}function Gd(){dn=localStorage.getItem("ft_notif_perm")||(Notification==null?void 0:Notification.permission)||"default",dn==="granted"&&(setTimeout(Ol,1e4),xi=setInterval(Ol,ew))}function nw(){xi&&(clearInterval(xi),xi=null)}async function sw(){if(dn==="granted")return dn="denied",localStorage.setItem("ft_notif_perm","denied"),nw(),k("Stock notifications disabled"),!1;{const t=await tw();return t&&Gd(),t}}const iw=[{target:".stats-grid",title:"Your Command Center",desc:"Track inventory value, revenue, profit, and ROI at a glance. Cards update in real-time as you add items and record sales.",position:"bottom"},{target:"#headerAddBtn",mobileTarget:".bnav-fab",title:"Add Your First Item",desc:"Tap here to add inventory. Use the camera to auto-identify items, scan barcodes, or enter details manually.",position:"bottom-left",mobilePosition:"top"},{target:"#headerIdBtn",title:"AI-Powered Identification",desc:"Snap a photo and FlipTrack identifies the item, suggests pricing, and finds comparable listings across platforms.",position:"bottom-left",desktopOnly:!0},{target:"#profitHeatmap",fallbackTarget:".kpi-goals-wrap, #kpiGoalsSection",title:"Track Your Progress",desc:"Set monthly goals and view your profit heatmap. Green = profit days, red = loss days. Spot trends at a glance.",position:"top"},{target:"#csvExportSection",title:"Export Everywhere",desc:"One-click CSV exports formatted for eBay, Poshmark, Mercari, and Depop. Plus full inventory and tax reports.",position:"top"}];let ws=-1,sn=null,ft=[];function Lo(t){if(!t)return!1;const e=getComputedStyle(t);if(e.display==="none"||e.visibility==="hidden")return!1;const n=t.getBoundingClientRect();return n.width>0&&n.height>0}function Vd(){return window.innerWidth<=820}function Kd(t){if(Vd()&&t.mobileTarget){const n=document.querySelector(t.mobileTarget);if(Lo(n))return{el:n,position:t.mobilePosition||t.position}}const e=document.querySelector(t.target);if(Lo(e))return{el:e,position:t.position};if(t.fallbackTarget){const n=t.fallbackTarget.split(",").map(s=>s.trim());for(const s of n){const i=document.querySelector(s);if(Lo(i))return{el:i,position:t.position}}}return null}function ow(){ft=[];for(const t of iw){if(t.desktopOnly&&Vd())continue;const e=Kd(t);e&&ft.push({...t,_resolved:e})}}function rw(){if(sn)return;const t=document.createElement("div");t.id="tourOverlay",t.innerHTML=`
    <div class="tour-backdrop" id="tourBackdrop"></div>
    <div class="tour-spotlight" id="tourSpotlight"></div>
    <div class="tour-tooltip" id="tourTooltip">
      <div class="tour-tooltip-arrow" id="tourArrow"></div>
      <div class="tour-step-badge" id="tourBadge"></div>
      <div class="tour-title" id="tourTitle"></div>
      <div class="tour-desc" id="tourDesc"></div>
      <div class="tour-actions">
        <button class="tour-skip" id="tourSkip">Skip Tour</button>
        <div style="flex:1"></div>
        <button class="tour-prev" id="tourPrev"> Back</button>
        <button class="tour-next" id="tourNext">Next </button>
      </div>
      <div class="tour-dots" id="tourDots"></div>
    </div>
  `,document.body.appendChild(t),sn=t,document.getElementById("tourSkip").addEventListener("click",_i),document.getElementById("tourPrev").addEventListener("click",()=>cr(ws-1)),document.getElementById("tourNext").addEventListener("click",()=>{ws>=ft.length-1?_i():cr(ws+1)}),document.getElementById("tourBackdrop").addEventListener("click",_i)}function cr(t){if(t<0||t>=ft.length)return;ws=t;const e=ft[t],n=Kd(e)||e._resolved,s=n==null?void 0:n.el,i=(n==null?void 0:n.position)||e.position,o=document.getElementById("tourSpotlight"),r=document.getElementById("tourTooltip");if(s)s.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{const a=s.getBoundingClientRect(),c=8;o.style.cssText=`
        position: fixed;
        top: ${a.top-c}px;
        left: ${a.left-c}px;
        width: ${a.width+c*2}px;
        height: ${a.height+c*2}px;
        display: block;
      `;const l=Math.min(320,window.innerWidth-32);let d,u;i==="bottom"||i==="bottom-left"?(d=a.bottom+16,u=i==="bottom-left"?Math.max(16,a.right-l):Math.max(16,a.left+a.width/2-l/2)):(d=a.top-16,u=Math.max(16,a.left+a.width/2-l/2)),u=Math.min(u,window.innerWidth-l-16),d=Math.max(16,d),i!=="top"&&d+180>window.innerHeight&&(d=a.top-180),i==="top"?r.style.cssText=`position:fixed;bottom:${window.innerHeight-a.top+16}px;left:${u}px;display:block;width:${l}px;`:r.style.cssText=`position:fixed;top:${d}px;left:${u}px;display:block;width:${l}px;`},350);else{o.style.display="none";const a=Math.min(320,window.innerWidth-32);r.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);display:block;width:${a}px;`}document.getElementById("tourTitle").textContent=e.title,document.getElementById("tourDesc").textContent=e.desc,document.getElementById("tourBadge").textContent=`${t+1} of ${ft.length}`,document.getElementById("tourPrev").style.display=t===0?"none":"",document.getElementById("tourNext").textContent=t>=ft.length-1?"Done ":"Next ",document.getElementById("tourDots").innerHTML=ft.map((a,c)=>`<span class="tour-dot${c===t?" active":""}"></span>`).join("")}function Jd(){ow(),ft.length!==0&&(rw(),sn.style.display="",sn.classList.add("on"),cr(0),localStorage.setItem("ft_toured","1"))}function _i(){if(sn){sn.classList.remove("on"),sn.style.display="none";const t=document.getElementById("tourSpotlight"),e=document.getElementById("tourTooltip");t&&(t.style.display="none"),e&&(e.style.display="none")}ws=-1,localStorage.setItem("ft_toured","1")}function aw(){!localStorage.getItem("ft_toured")&&!localStorage.getItem("ft_welcomed")&&setTimeout(()=>Jd(),1500)}const ia=50,Yd="ft_notifications";let Ue=[],Ot=0,xs=!1;function lw(){try{Ue=JSON.parse(localStorage.getItem(Yd)||"[]").slice(0,ia),Ot=Ue.filter(t=>!t.read).length}catch{Ue=[],Ot=0}}function oa(){localStorage.setItem(Yd,JSON.stringify(Ue.slice(0,ia)))}function Si(t,e,n,s){Ue.unshift({id:Date.now().toString(36),type:t,title:e,message:n,actionId:s||null,time:new Date().toISOString(),read:!1}),Ue=Ue.slice(0,ia),Ot=Ue.filter(i=>!i.read).length,oa(),no()}function cw(){Ue.forEach(t=>t.read=!0),Ot=0,oa(),no(),ra()}function dw(){Ue=[],Ot=0,oa(),no(),ra()}function no(){const t=document.getElementById("notifBadge");t&&(Ot>0?(t.textContent=Ot>9?"9+":Ot,t.style.display=""):t.style.display="none")}function uw(t){const e=Date.now()-new Date(t).getTime(),n=Math.floor(e/6e4);if(n<1)return"just now";if(n<60)return n+"m ago";const s=Math.floor(n/60);return s<24?s+"h ago":Math.floor(s/24)+"d ago"}function pw(t){switch(t){case"stock":return"";case"sync":return"";case"price":return"";case"sale":return"";case"info":return"";default:return""}}function ra(){const t=document.getElementById("notifList");if(t){if(!Ue.length){t.innerHTML='<div class="notif-empty">No notifications yet</div>';return}t.innerHTML=Ue.slice(0,20).map(e=>`
    <div class="notif-item${e.read?"":" unread"}" data-nid="${e.id}"${e.actionId?` onclick="openDrawer('${e.actionId}')"`:""}>
      <span class="notif-icon">${pw(e.type)}</span>
      <div class="notif-body">
        <div class="notif-title">${_(e.title)}</div>
        <div class="notif-msg">${_(e.message)}</div>
      </div>
      <span class="notif-time">${uw(e.time)}</span>
    </div>
  `).join("")}}function fw(){xs=!xs;const t=document.getElementById("notifDropdown");t&&(xs?(t.classList.add("on"),ra()):t.classList.remove("on"))}function Qd(){xs=!1;const t=document.getElementById("notifDropdown");t&&t.classList.remove("on")}function hw(){const t=Date.now(),e=parseInt(localStorage.getItem("ft_notif_stock_check")||"0");if(t-e<36e5)return;localStorage.setItem("ft_notif_stock_check",t.toString());const n=$.filter(o=>o.qty===0),s=$.filter(o=>o.bulk&&o.qty>0&&o.qty<=(o.lowAlert||2)),i=$.filter(o=>(o.qty||0)<=0?!1:Math.floor((t-new Date(o.added||t).getTime())/864e5)>=60&&!I.some(a=>a.itemId===o.id));n.length&&Si("stock","Out of Stock",`${n.length} item${n.length>1?"s":""} need restocking`),s.length&&Si("stock","Low Stock Warning",`${s.length} item${s.length>1?"s are":" is"} running low`),i.length&&Si("price","Stale Inventory",`${i.length} item${i.length>1?"s":""} listed 60+ days with no sales  consider repricing`)}function mw(){lw(),no(),hw(),document.addEventListener("click",t=>{xs&&!t.target.closest("#notifDropdown")&&!t.target.closest("#notifBellBtn")&&Qd()})}let kn=null;async function Xd(){return kn||new Promise((t,e)=>{if(window.jspdf){kn=window.jspdf,t(kn);return}const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js",n.onload=()=>{kn=window.jspdf,t(kn)},n.onerror=()=>e(new Error("Failed to load jsPDF")),document.head.appendChild(n)})}function dr(t,e,n){return t.setFillColor(10,10,15),t.rect(0,0,210,30,"F"),t.setTextColor(0,200,136),t.setFontSize(18),t.setFont("helvetica","bold"),t.text("FlipTrack",14,16),t.setTextColor(255,255,255),t.setFontSize(11),t.setFont("helvetica","normal"),t.text(e,65,14),t.setFontSize(8),t.setTextColor(160,160,180),t.text(n,65,20),t.setTextColor(0,0,0),38}function ur(t,e){const n=t.internal.pageSize.getHeight();t.setFontSize(7),t.setTextColor(140,140,160),t.text(`Generated by FlipTrack  ${new Date().toLocaleDateString()}`,14,n-8),t.text(`Page ${e}`,196,n-8,{align:"right"})}async function gw(t,e){k("Generating P&L report");const{jsPDF:n}=await Xd(),s=new n,i=t?new Date(t):new Date(new Date().getFullYear(),0,1),o=e?new Date(e):new Date,r=`${i.toLocaleDateString()}  ${o.toLocaleDateString()}`;let a=dr(s,"Profit & Loss Statement",r),c=0,l=0,d=0,u=0;const p=I.filter(w=>{const S=new Date(w.date);return S>=i&&S<=o});for(const w of p){const S=q(w.itemId);c+=(w.price||0)*(w.qty||0),l+=S?(S.cost||0)*(w.qty||0):0,d+=w.fees||0,u+=w.ship||0}const h=Q.filter(w=>{const S=new Date(w.date);return S>=i&&S<=o}),f=h.reduce((w,S)=>w+(S.amount||0),0),g=c-l,m=g-d-u-f;s.setFontSize(12),s.setFont("helvetica","bold"),s.text("Revenue",14,a),a+=8,s.setFontSize(10),s.setFont("helvetica","normal"),s.text(`Sales Revenue (${p.length} transactions)`,20,a),s.text(x(c),196,a,{align:"right"}),a+=12,s.setFontSize(12),s.setFont("helvetica","bold"),s.text("Cost of Goods Sold",14,a),a+=8,s.setFontSize(10),s.setFont("helvetica","normal"),s.text("Product Cost (COGS)",20,a),s.text(`(${x(l)})`,196,a,{align:"right"}),a+=6,s.text("Platform Fees",20,a),s.text(`(${x(d)})`,196,a,{align:"right"}),a+=6,s.text("Shipping Costs",20,a),s.text(`(${x(u)})`,196,a,{align:"right"}),a+=10,s.setDrawColor(0,200,136),s.line(14,a,196,a),a+=6,s.setFontSize(11),s.setFont("helvetica","bold"),s.text("Gross Profit",14,a),s.setTextColor(g>=0?0:200,g>=0?150:50,g>=0?100:50),s.text(x(g),196,a,{align:"right"}),s.setTextColor(0,0,0),a+=12,s.setFontSize(12),s.setFont("helvetica","bold"),s.text("Operating Expenses",14,a),a+=8,s.setFontSize(10),s.setFont("helvetica","normal");const v={};for(const w of h){const S=w.category||"Other";v[S]=(v[S]||0)+(w.amount||0)}for(const[w,S]of Object.entries(v).sort((C,B)=>B[1]-C[1]))s.text(w,20,a),s.text(`(${x(S)})`,196,a,{align:"right"}),a+=6;h.length||(s.text("No operating expenses recorded",20,a),a+=6),a+=6,s.setDrawColor(0,200,136),s.setLineWidth(.5),s.line(14,a,196,a),a+=2,s.line(14,a,196,a),a+=8,s.setFontSize(13),s.setFont("helvetica","bold"),s.text("Net Profit",14,a),s.setTextColor(m>=0?0:200,m>=0?150:50,m>=0?100:50),s.text(x(m),196,a,{align:"right"}),s.setTextColor(0,0,0),a+=8,s.setFontSize(9),s.setFont("helvetica","normal");const E=c?m/c:0;if(s.text(`Net Margin: ${V(E)}  ROI: ${l?V(m/l):"N/A"}`,14,a),ur(s,1),p.length){s.addPage();let w=dr(s,"Revenue by Platform",r);const S={};for(const B of p){const L=q(B.itemId),O=L?Y(L):["Other"],G=(B.price||0)*(B.qty||0);O.forEach(D=>{S[D]=(S[D]||0)+G/O.length})}s.setFontSize(10),s.setFont("helvetica","bold"),s.text("Platform",20,w),s.text("Revenue",120,w),s.text("% of Total",160,w,{align:"right"}),s.text("Sales",196,w,{align:"right"}),w+=4,s.setDrawColor(200,200,200),s.line(20,w,196,w),w+=6,s.setFont("helvetica","normal");const C=Object.values(S).reduce((B,L)=>B+L,0);for(const[B,L]of Object.entries(S).sort((O,G)=>G[1]-O[1])){const O=p.filter(G=>{const D=q(G.itemId);return D&&Y(D).includes(B)}).length;s.text(B,20,w),s.text(x(L),120,w),s.text(V(L/C),160,w,{align:"right"}),s.text(String(O),196,w,{align:"right"}),w+=7}ur(s,2)}s.save(`FlipTrack_PL_${i.toISOString().slice(0,10)}_${o.toISOString().slice(0,10)}.pdf`),k("P&L report downloaded ")}async function yw(t){k("Generating tax summary");const{jsPDF:e}=await Xd(),n=new e,s=t||new Date().getFullYear();let i=dr(n,"Tax Summary Report",`Fiscal Year ${s}`);const o=new Date(s,0,1),r=new Date(s,11,31,23,59,59);let a=0,c=0,l=0,d=0,u=0;const p=I.filter(S=>{const C=new Date(S.date);return C>=o&&C<=r});for(const S of p){const C=q(S.itemId);a+=(S.price||0)*(S.qty||0),c+=C?(C.cost||0)*(S.qty||0):0,l+=S.fees||0,d+=S.ship||0,u+=S.qty||0}const h=Q.filter(S=>{const C=new Date(S.date);return C>=o&&C<=r}),f=h.reduce((S,C)=>S+(C.amount||0),0);n.setFontSize(11),n.setFont("helvetica","bold"),n.text("INCOME",14,i),i+=8,n.setFontSize(10),n.setFont("helvetica","normal"),n.text("Gross Sales Revenue",20,i),n.text(x(a),196,i,{align:"right"}),i+=6,n.text(`Total Transactions: ${p.length}  Units Sold: ${u}`,20,i),i+=12,n.setFont("helvetica","bold"),n.text("DEDUCTIONS (Schedule C)",14,i),i+=8,n.setFont("helvetica","normal");const g=[["Cost of Goods Sold (COGS)",c],["Platform & Selling Fees",l],["Shipping & Postage",d]],m={};for(const S of h){const C=S.category||"Other Business Expense";m[C]=(m[C]||0)+(S.amount||0)}for(const[S,C]of Object.entries(m).sort((B,L)=>L[1]-B[1]))g.push([S,C]);const v=c+l+d+f;for(const[S,C]of g)n.text(S,20,i),n.text(x(C),196,i,{align:"right"}),i+=6;i+=4,n.setDrawColor(0,200,136),n.line(14,i,196,i),i+=6,n.setFont("helvetica","bold"),n.text("Total Deductions",20,i),n.text(x(v),196,i,{align:"right"}),i+=12;const E=a-v;n.setFontSize(13),n.text("NET BUSINESS INCOME",14,i),n.setTextColor(E>=0?0:200,E>=0?150:50,E>=0?100:50),n.text(x(E),196,i,{align:"right"}),n.setTextColor(0,0,0),i+=12,n.setFontSize(8),n.setTextColor(140,140,140),n.text("This report is for informational purposes only and does not constitute tax advice.",14,i),i+=4,n.text("Consult a qualified tax professional for filing. FlipTrack is not a CPA or tax preparation service.",14,i);const w=$.reduce((S,C)=>S+(C.cost||0)*(C.qty||0),0);i+=12,n.setTextColor(0,0,0),n.setFontSize(10),n.setFont("helvetica","bold"),n.text("ENDING INVENTORY VALUATION",14,i),i+=7,n.setFont("helvetica","normal"),n.text(`${$.filter(S=>S.qty>0).length} items in stock`,20,i),n.text(x(w),196,i,{align:"right"}),ur(n,1),n.save(`FlipTrack_Tax_${s}.pdf`),k("Tax summary downloaded ")}const vw={"First Class":[{maxOz:4,price:4.63},{maxOz:8,price:5.13},{maxOz:12,price:5.63},{maxOz:15.99,price:6.13}],"Priority Mail":[{maxOz:16,price:8.7},{maxOz:32,price:10.2},{maxOz:48,price:12.45},{maxOz:80,price:14.8},{maxOz:160,price:19.3},{maxOz:1120,price:28.5}],"Priority Mail Flat Rate":[{name:"Small Flat Rate Box",price:10.2,maxOz:1120},{name:"Medium Flat Rate Box",price:16.45,maxOz:1120},{name:"Large Flat Rate Box",price:22.95,maxOz:1120},{name:"Padded Flat Rate Envelope",price:9.85,maxOz:1120}],"Media Mail":[{maxOz:16,price:4.13},{maxOz:32,price:4.78},{maxOz:48,price:5.43},{maxOz:80,price:6.73},{maxOz:160,price:9.33},{maxOz:1120,price:14.53}],"Ground Advantage":[{maxOz:16,price:5.5},{maxOz:32,price:7},{maxOz:48,price:9.5},{maxOz:80,price:12},{maxOz:160,price:15.5},{maxOz:1120,price:20}]},bw={"UPS Ground":[{maxOz:16,price:10.5},{maxOz:48,price:14},{maxOz:160,price:22},{maxOz:1120,price:35}]};let ki="",$i="poly_mailer",Ei="USPS";async function ww(){const t=await we("ship_label_settings");t&&(ki=t.sellerZip||"",$i=t.defaultPackage||"poly_mailer",Ei=t.preferredCarrier||"USPS")}async function xw(t){ki=t.sellerZip||ki,$i=t.defaultPackage||$i,Ei=t.preferredCarrier||Ei,await te("ship_label_settings",{sellerZip:ki,defaultPackage:$i,preferredCarrier:Ei})}function aa(t){const{weightOz:e,length:n,width:s,height:i,isMedia:o}=t,r=[];for(const[a,c]of Object.entries(vw))if(!(a==="Media Mail"&&!o)){for(const l of c)if(e<=l.maxOz){r.push({carrier:"USPS",service:l.name||a,price:l.price,estimatedDays:a.includes("Priority")?"1-3":a==="Media Mail"?"2-8":"2-5"});break}}for(const[a,c]of Object.entries(bw))for(const l of c)if(e<=l.maxOz){r.push({carrier:"UPS",service:a,price:l.price,estimatedDays:"1-5"});break}return r.forEach(a=>{a.pirateShipPrice=Math.round(a.price*.85*100)/100}),r.sort((a,c)=>a.price-c.price)}function _w(t,e=!1){return aa({weightOz:t,isMedia:e})[0]||null}function Sw(t={}){return"https://app.pirateship.com/ship"}function kw(){return"https://www.paypal.com/shiplabel/create"}function $w(t){return"https://www.ebay.com/sh/ord"}function Ew(t,e){const n=I.find(s=>s.id===t);n&&(n.labelCost=e.cost,n.labelCarrier=e.carrier,n.labelService=e.service,e.tracking&&(n.trackingNumber=e.tracking),n.actualShipCost=e.cost,J("sales",t),R())}function Iw(t=30){const e=Date.now()-t*864e5,n=I.filter(a=>new Date(a.date).getTime()>=e&&a.labelCost),s=n.reduce((a,c)=>a+(c.labelCost||0),0),i=n.reduce((a,c)=>a+(c.ship||0),0),o=i-s,r={};for(const a of n){const c=a.labelCarrier||"Unknown";r[c]||(r[c]={count:0,cost:0}),r[c].count++,r[c].cost+=a.labelCost||0}return{totalLabels:n.length,totalCost:s,totalCharged:i,shippingProfit:o,avgCost:n.length>0?s/n.length:0,byCarrier:r}}function Tw(t){const e=aa(t);if(!e.length)return'<div class="sl-empty">Enter weight to see rate estimates</div>';let n=`<div class="sl-rates">
    <div class="sl-rates-header">Estimated Shipping Rates (${t.weightOz}oz)</div>
  `;for(const s of e){const i=s===e[0];n+=`
      <div class="sl-rate-row ${i?"sl-cheapest":""}">
        <span class="sl-carrier">${_(s.carrier)}</span>
        <span class="sl-service">${_(s.service)}</span>
        <span class="sl-price">${x(s.price)}</span>
        <span class="sl-pirate" title="Pirate Ship price">${x(s.pirateShipPrice)}</span>
        <span class="sl-days">${s.estimatedDays}d</span>
        ${i?'<span class="sl-badge">Cheapest</span>':""}
      </div>
    `}return n+=`
    <div class="sl-links">
      <a href="${Sw()}" target="_blank" class="sl-link"> Buy on Pirate Ship (Cheapest)</a>
      <a href="${kw()}" target="_blank" class="sl-link"> PayPal Shipping</a>
      <a href="${$w()}" target="_blank" class="sl-link"> eBay Labels</a>
    </div>
  </div>`,n}const Ro={};function fn(t,e){return async()=>(Ro[t]||(Ro[t]=await e()),Ro[t])}const la=fn("scanner",()=>ct(()=>import("./scanner-glgnWlSs.js"),[],import.meta.url)),Qn=fn("batch-scan",()=>ct(()=>import("./batch-scan-D9JbSzKk.js"),[],import.meta.url)),Xn=fn("price-research",()=>ct(()=>import("./price-research-kclI2HbB.js"),[],import.meta.url)),hn=fn("identify",()=>ct(()=>import("./identify-KoR2XLEl.js"),[],import.meta.url)),he=fn("images",()=>ct(()=>Promise.resolve().then(()=>Im),void 0,import.meta.url)),Cw=fn("barcodes",()=>ct(()=>Promise.resolve().then(()=>Cm),void 0,import.meta.url)),ca=fn("csv",()=>ct(()=>import("./csv-mq_2w_KV.js"),[],import.meta.url)),F=(t,e)=>async(...n)=>(await t())[e](...n),Pw=F(la,"openScanner"),Dw=F(la,"closeScanner"),Bw=F(la,"switchCamera"),Ow=F(Xn,"openPriceResearch"),Aw=F(Xn,"closePriceResearch"),Lw=F(Xn,"prSwitchTab"),Rw=F(Xn,"openPriceScanner"),Mw=F(Xn,"lookupPrices"),jw=F(Xn,"lookupByKeyword"),Nw=F(he,"imgSlotChange"),zw=F(he,"imgSlotRemove"),Uw=F(he,"refreshImgSlots"),Fw=F(he,"renderAddFormImages"),qw=F(he,"renderDrawerImg"),Hw=F(he,"imgDragOver"),Ww=F(he,"imgDragLeave"),Gw=F(he,"imgDrop"),Vw=F(he,"openLightbox"),Kw=F(he,"openLightboxUrl"),Jw=F(he,"closeLightbox"),Yw=F(he,"openCropModal"),Qw=F(he,"cropDraw"),Xw=F(he,"cropConfirm"),Zw=F(he,"cropCancel"),ex=F(he,"cropReset"),tx=F(he,"cropSetAspect"),nx=F(hn,"openIdentify"),sx=F(hn,"closeIdentify"),ix=F(hn,"idHandleCapture"),ox=F(hn,"idRetake"),rx=F(hn,"idAnalyze"),ax=F(hn,"idAddToInventory"),lx=F(hn,"idSearchPrices"),cx=F(Qn,"openBatchScan"),dx=F(Qn,"closeBatchScan"),ux=F(Qn,"batchAddScanned"),px=F(Qn,"batchManualAdd"),fx=F(Qn,"batchRemoveItem"),hx=F(Qn,"batchAddAll"),mx=F(ca,"exportCSV"),gx=F(ca,"exportAll"),yx=F(ca,"importCSV"),vx=F(Cw,"printStickers");Object.defineProperty(window,"activeDrawId",{get(){return yt},configurable:!0});Object.assign(window,{toggleTheme:Sx,applyFontSize:da,setFsPreset:kx,toggleFsPopover:$x,setFont:tu});Object.assign(window,{switchView:Zs,goToBreakdown:wx,goToReports:xx,goToStockAlert:_x,clearStockFilt:Zd,bnav:Zi,toggleBnavMore:_y,closeBnavMore:Sy});Object.assign(window,{switchAuthTab:mr,authSubmit:ac,authForgotPassword:lc,authSignOut:cc,openAccountMenu:uc,closeAccountMenu:Gi,syncNow:yr,mobileSyncNow:Ah});Object.assign(window,{renderInv:$e,buildChips:pd,setPlatFilt:yg,setCatFilt:vg,setSubcatFilt:bg,setSubsubcatFilt:_g,setSort:Sg,startPriceEdit:$g,adjStock:Eg,dStart:Ig,dOver:Tg,dDrop:Cg,toggleSel:Pg,toggleAll:Dg,clearSel:Bg,clearStockFilt:Zd,bulkDel:Og,bulkSold:Ag,toggleFilterPanel:mg,_debouncedRenderInv:Vh});Object.assign(window,{openDrawer:Mm,closeDrawer:Yi,drawerTab:jm,saveDrawer:zm,delCurrent:Um,delItem:vy,syncDrawerSubcat:Am,syncDrawerSubtype:Lm,syncAddSubcat:sd,syncAddSubtype:Rm,setCondTag:Fm,toggleBulkFields:td});Object.assign(window,{openAddModal:Dm,closeAdd:ed,addItem:Om,dupCurrent:Pm,dupItem:Xc,addFormTab:Zc,prevProfit:nd,prefillFromLast:Bm});Object.assign(window,{openSoldModal:Qg,closeSold:ir,sPriceType:Gr,onSoldItemPick:Xg,updateSalePriceHint:gd,updateFeeEstimate:Vr,recSale:sy,renderSalesView:pn,delSale:yy,setSalesSearch:Zg,setSalesDateFrom:ey,setSalesDateTo:ty,clearSalesFilters:ny});Object.assign(window,{addExpense:uy,delExpense:py,renderExpenses:Rt,setDefaultExpDate:yd,setExpSearch:ry,setExpDateFrom:ay,setExpDateTo:ly,clearExpFilters:cy});Object.assign(window,{addSupply:Wg,updateSupplyQty:Gg,setSupplyQty:Vg,delSupply:Kg,renderSupplies:Kn});Object.assign(window,{openTrashModal:wy,closeTrashModal:vd,emptyTrash:xy,openMaterialsModal:hd,confirmMaterials:Jg,skipMaterials:Yg,performUndo:kc});Object.assign(window,{openScanner:Pw,closeScanner:Dw,switchCamera:Bw,openPriceResearch:Ow,closePriceResearch:Aw,prSwitchTab:Lw,openPriceScanner:Rw,lookupPrices:Mw,lookupByKeyword:jw,openIdentify:nx,closeIdentify:sx,idHandleCapture:ix,idRetake:ox,idAnalyze:rx,idAddToInventory:ax,idSearchPrices:lx});Object.assign(window,{imgSlotChange:Nw,imgSlotRemove:zw,refreshImgSlots:Uw,imgDragOver:Hw,imgDragLeave:Ww,imgDrop:Gw,openLightbox:Vw,openLightboxUrl:Kw,closeLightbox:Jw,openCropModal:Yw,cropDraw:Qw,cropConfirm:Xw,cropCancel:Zw,cropReset:ex,cropSetAspect:tx,renderAddFormImages:Fw,renderDrawerImg:qw});Object.assign(window,{openBatchScan:cx,closeBatchScan:dx,batchAddScanned:ux,batchManualAdd:px,batchRemoveItem:fx,batchAddAll:hx,printStickers:vx,exportAll:gx,exportCSV:mx,importCSV:yx});Object.assign(window,{lookupISBN:Yh,calcFBA:Qh,updateRankDisplay:Cc,toggleBookFields:Hs,setDimUnit:Br,updateDimWeight:Or,suggestPackaging:Ar,quickReprice:hg});Object.assign(window,{markDirty:J,markDeleted:xr});Object.assign(window,{renderCrosslistDashboard:ne,clSwitchTab:bv,clSetSearch:wv,clSetPlatFilter:xv,clSetStatusFilter:_v,clRelistItem:Sv,clDelistItem:kv,clCycleStatus:$v,clOpenLink:Ev,clCopyListing:Iv,clBulkRelistExpired:Tv,clAddTemplate:Cv,clDeleteTemplate:Pv,markPlatformStatus:He,relistItem:Ki,copyListingText:jc,clRelistFromDrawer:bx});Object.assign(window,{clEBayConnect:Nv,clEBayDisconnect:zv,clEBaySync:Uv,clPushToEBay:Fv,clPublishOnEBay:qv,clEndEBayListing:Hv,handleEBayCallback:Ry});Object.assign(window,{clEtsyConnect:Bv,clEtsyDisconnect:Ov,clEtsySync:Av,clPushToEtsy:Lv,clDeactivateEtsyListing:Rv,clRenewEtsyListing:Mv,handleEtsyCallback:tv});Object.assign(window,{renderShippingView:De,shipSetSearch:Zv,shipSetPlatFilter:e0,shipSetStatusFilter:t0,shipSetDateFrom:n0,shipSetDateTo:s0,shipClearFilters:i0,shipToggleSel:o0,shipToggleAll:r0,shipClearSel:a0,shipMarkShipped:l0,shipConfirmShipped:c0,shipCancelMark:d0,shipBatchMark:u0,shipConfirmBatchMark:p0,shipCancelBatchMark:f0,shipPrintSlip:h0,shipPrintBatchSlips:m0,shipExportLog:g0,printPackingSlip:Bd,openPackingSlipSettings:Qv,closePackingSlipSettings:Ld,savePackingSlipSettings:Xv,estimateShippingRate:Cd,suggestPackage:Jr,getCarrierOptions:Wv});Object.assign(window,{renderSourcingView:et,addHaul:S0,deleteHaul:k0,expandHaul:$0,linkItemsToHaul:E0,confirmLinkItems:I0,closeItemLinkModal:Md,unlinkItem:T0,srcSetSearch:C0,srcSetSort:P0});Object.assign(window,{renderTaxCenter:Qs,taxSetYear:M0,taxSetQuarter:j0,taxToggleScheduleC:N0,taxExportCSV:F0,mileAddEntry:L0,mileDeleteEntry:R0});Object.assign(window,{renderPriceHistoryChart:cm,renderPriceHistoryTable:dm,renderRepricingSuggestions:J0,renderRepricingRulesManager:Y0,rpAddRule:Q0,rpDeleteRule:X0,rpToggleRule:Z0,rpApplyAll:eb,rpApplySingle:tb});Object.assign(window,{renderBuyersView:Lt,buyerAdd:Mg,buyerDelete:jg,buyerExpand:Ng,buyerSetSearch:zg,buyerSetSort:Ug,buyerLinkSale:qg,renderOffersPanel:lb,offerAdd:cb,offerAddConfirm:db,offerAccept:ub,offerReject:pb,offerCounter:fb,offerDelete:hb,renderItemOffers:ab});Object.assign(window,{calcSellThroughRate:mb,calcInventoryTurnRate:gb,calcCashFlowProjection:yb,calcSeasonalTrends:vb,calcPlatformComparison:bb,calcVelocityByCategory:wb,calcProfitByDayOfWeek:xb,calcBestListingDay:_b,calcRevenueForecasts:Sb,calcBreakEvenAnalysis:kb});Object.assign(window,{loadDemoData:Hd,clearDemoData:Wd,exportPlatformCSV:tg,exportSalesCSV:ng,exportTaxCSV:sg,toggleNotifications:sw,startTour:Jd,endTour:_i,openKPIGoalEditor:ag,closeKPIGoalEditor:cd,saveKPIGoals:lg,toggleNotifCenter:fw,closeNotifCenter:Qd,markAllRead:cw,clearNotifications:dw,addNotification:Si,exportPLReport:gw,exportTaxReport:yw});Object.assign(window,{fetchComps:na,suggestPrice:Cb,renderCompsPanel:Pb,getItemComps:Db,clearCompsCache:Bb,removeBackground:xl,autoCrop:_l,addWatermark:Sl,squarePad:$l,adjustImage:kl,renderPhotoToolsPanel:Lb,savePhotoSettings:Ab,calculateProfit:Fd,renderProfitCalc:Rb,quickProfitEstimate:Mb,renderDeathPileWidget:Wm,renderDeathPileView:Gm,getDeathPileStats:Qi,startBatchList:jb,batchTogglePlatform:El,executeBatchList:Il,copyBatchText:Tl,renderBatchListPanel:Ub,clearBatchList:Cl,blTogglePlatform:El,blExecute:Il,blCopyAll:Tl,blClearSelection:Cl,generateAndApply:Pl,renderAIListingPanel:Dl,copyAIListing:Bl,aiGenerate:t=>{var s,i;const e=((s=document.getElementById("aiPlatform"))==null?void 0:s.value)||"",n=((i=document.getElementById("aiTone"))==null?void 0:i.value)||"professional";Pl(t,{platform:e,tone:n}).then(()=>{const o=$.find(r=>r.id===t);if(o){const r=document.querySelector(".ai-panel");r&&(r.outerHTML=Dl(o))}}).catch(o=>k(o.message,!0))},aiRegenerate:t=>window.aiGenerate(t),aiCopyListing:Bl,renderInventoryValueDashboard:qd,estimateRates:aa,getCheapestRate:_w,renderRateComparison:Tw,recordLabelCost:Ew,getShippingCostSummary:Iw,saveShipLabelSettings:xw,ptRemoveBg:async t=>{const e=$.find(n=>n.id===t);if(e!=null&&e.image){k("Removing background");try{const n=await xl(e.image);document.getElementById("ptPreview").src=n,e.image=n,J("inv",t),R(),k("Background removed ")}catch(n){k("BG removal failed: "+n.message,!0)}}},ptAutoCrop:async t=>{const e=$.find(n=>n.id===t);if(e!=null&&e.image)try{const n=await _l(e.image);document.getElementById("ptPreview").src=n,e.image=n,J("inv",t),R(),k("Auto-cropped ")}catch(n){k("Crop failed: "+n.message,!0)}},ptWatermark:async t=>{const e=$.find(n=>n.id===t);if(e!=null&&e.image)try{const n=await Sl(e.image);document.getElementById("ptPreview").src=n,e.image=n,J("inv",t),R(),k("Watermark added ")}catch(n){k("Watermark failed: "+n.message,!0)}},ptSquare:async t=>{const e=$.find(n=>n.id===t);if(e!=null&&e.image)try{const n=await $l(e.image);document.getElementById("ptPreview").src=n,e.image=n,J("inv",t),R(),k("Square padded ")}catch(n){k("Square pad failed: "+n.message,!0)}},ptAdjustPreview:async t=>{var i,o;const e=$.find(r=>r.id===t);if(!(e!=null&&e.image))return;const n=parseInt(((i=document.getElementById("ptBrightness"))==null?void 0:i.value)||"0"),s=parseInt(((o=document.getElementById("ptContrast"))==null?void 0:o.value)||"0");if(n||s){const r=await kl(e.image,{brightness:n,contrast:s});document.getElementById("ptPreview").src=r}}});function bx(t,e){Ki(t,e),R(),W(),k(`Relisted on ${e} `);const n=$.find(s=>s.id===t);n&&id(n)}function Zs(t,e){var n;if(document.querySelectorAll(".view").forEach(s=>s.classList.remove("active")),document.querySelectorAll(".nav-tab").forEach(s=>{s.classList.remove("active"),s.setAttribute("aria-selected","false"),s.setAttribute("tabindex","-1")}),(n=document.getElementById("view-"+t))==null||n.classList.add("active"),e&&(e.classList.add("active"),e.setAttribute("aria-selected","true"),e.setAttribute("tabindex","0")),t==="inventory")$e();else if(t==="sales")pn();else if(t==="expenses")Rt();else if(t==="supplies")Kn(),Hr();else if(t==="insights")oy();else if(t==="reports")hy();else if(t==="breakdown")by();else if(t==="dashboard")dd();else if(t==="crosslist")ne();else if(t==="shipping")De();else if(t==="sourcing")et();else if(t==="tax")Qs();else if(t==="buyers")Lt();else if(t==="invvalue"){const s=document.getElementById("invValueContent");s&&(s.innerHTML=qd())}}window.switchView=Zs;function wx(){const t=document.querySelectorAll(".nav-tab")[7];Zs("breakdown",t),Zi("bn-more-breakdown")}function xx(){const t=document.querySelectorAll(".nav-tab")[6];Zs("reports",t),Zi("bn-more-reports")}function _x(){wg("low");const t=document.querySelectorAll(".nav-tab")[1];Zs("inventory",t),Zi("bn-inventory")}function Zd(){xg()}function Sx(){const t=document.documentElement,e=t.getAttribute("data-theme")!=="light";t.setAttribute("data-theme",e?"light":"dark"),localStorage.setItem("ft_theme",e?"light":"dark"),eu()}function eu(){const t=document.documentElement.getAttribute("data-theme")==="light",e=document.getElementById("themeBtn");e&&(e.textContent=t?"":"")}function da(t,e=!0){const n=parseInt(t)/100;document.documentElement.style.setProperty("--fs",t),document.documentElement.style.zoom=n,document.getElementById("fsSlider").value=t,document.querySelectorAll(".fs-preset").forEach(s=>{s.classList.toggle("active",parseInt(s.textContent==="Small"?80:s.textContent==="Default"?100:s.textContent==="Large"?115:130)===parseInt(t))}),e&&localStorage.setItem("ft_fs",t)}function kx(t){da(t)}function $x(){var t;(t=document.getElementById("fsPopover"))==null||t.classList.toggle("on")}function tu(t,e=!0){var n,s,i,o;if(t==="dyslexic"){document.body.classList.add("font-dyslexic"),(n=document.getElementById("fopt-dyslexic"))==null||n.classList.add("active"),(s=document.getElementById("fopt-default"))==null||s.classList.remove("active");const r=document.getElementById("fopt-hint");r&&(r.style.display="")}else{document.body.classList.remove("font-dyslexic"),(i=document.getElementById("fopt-default"))==null||i.classList.add("active"),(o=document.getElementById("fopt-dyslexic"))==null||o.classList.remove("active");const r=document.getElementById("fopt-hint");r&&(r.style.display="none")}e&&localStorage.setItem("ft_font",t)}const Ex=localStorage.getItem("ft_theme");Ex==="light"&&document.documentElement.setAttribute("data-theme","light");eu();const Al=localStorage.getItem("ft_fs");Al&&da(Al,!1);const Ll=localStorage.getItem("ft_font");Ll&&tu(Ll,!1);document.getElementById("currentDate").textContent=new Date().toLocaleDateString("en-US",{weekday:"short",month:"long",day:"numeric",year:"numeric"});yd();function nu(){const t=document.getElementById("splash");t&&(t.style.opacity="0",t.style.pointerEvents="none",setTimeout(()=>t.remove(),600))}setTimeout(nu,3e3);(async function(){try{await jh()}catch(e){console.warn("FlipTrack: Store init error:",e.message)}try{try{Wn(),W(),dd()}catch(n){console.warn("FlipTrack: render error:",n.message)}if(nu(),!localStorage.getItem("ft_welcomed")){const n=document.getElementById("welcomeOv");n&&(n.style.display="")}window.dismissWelcome=function(){localStorage.setItem("ft_welcomed","1");const n=document.getElementById("welcomeOv");n&&(n.style.opacity="0",setTimeout(()=>n.remove(),300))},Ai(),window.addEventListener("resize",Ai),window.addEventListener("online",jn),window.addEventListener("offline",jn),navigator.onLine||jn(),Ic(),pc(),Lh(),await bd(),rm(),Ac(),await Promise.all([_0(),jd(),q0(),Lg(),nb(),Yv(),zy(),av(),Ob(),ww()]),y0(),Zb(),Gd(),mw(),Ph(),aw();const e=(await ct(async()=>{const{getSupabaseClient:n}=await Promise.resolve().then(()=>$h);return{getSupabaseClient:n}},void 0,import.meta.url)).getSupabaseClient();e&&(Dy(e).then(()=>{qe()&&Uy()}).catch(n=>console.warn("eBay init:",n.message)),Yy(e).then(()=>{vt()&&lv()}).catch(n=>console.warn("Etsy init:",n.message)),qb(e))}catch(e){console.warn("FlipTrack: boot error:",e.message||e)}})();"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").catch(t=>console.warn("SW registration failed:",t))});(function(){let t=0;function e(n){if(Date.now()-t<3e3)return;t=Date.now();const s=document.getElementById("toast");s&&(s.textContent=n,s.className="toast err on",setTimeout(()=>s.classList.remove("on"),4e3))}window.addEventListener("error",n=>{console.error("FlipTrack global error:",n.error||n.message),e("Something went wrong  your data is safe.")}),window.addEventListener("unhandledrejection",n=>{var o;const s=String(((o=n.reason)==null?void 0:o.message)||n.reason||"");if(/401|not authenticated|session expired|sw.*regist|service.worker|networkerror|failed to fetch|load failed/i.test(s)){n.preventDefault(),console.warn("FlipTrack (suppressed):",s);return}console.error("FlipTrack unhandled rejection:",n.reason),e("A background task failed  retrying automatically.")})})();export{Ns as _,Hn as a,rt as b,At as c,Q as d,_ as e,x as f,Y as g,I as h,$ as i,V as p,W as r,R as s,k as t,ie as u};
