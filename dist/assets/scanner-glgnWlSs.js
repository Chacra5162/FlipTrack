let r=!1,d=null,o=null,l=null,i=!1;function _(n){return new Promise((e,t)=>{if(document.querySelector(`script[src="${n}"]`)){e();return}const c=document.createElement("script");c.src=n,c.onload=e,c.onerror=t,document.head.appendChild(c)})}async function h(){if(typeof Quagga<"u")return!0;const n=["https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js","https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"];for(const e of n)try{if(await _(e),typeof Quagga<"u")return!0}catch{}return!1}async function E(n){d=n,r=!0,document.getElementById("scannerOv").classList.add("on"),a("Starting camera…",!1),document.getElementById("scannerSub").textContent="Hold steady — auto-detects UPC, EAN, QR & more",document.getElementById("scannerCamSel").style.display="none";try{o=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});const e=document.getElementById("scannerVideo");e.srcObject=o,await e.play(),w(),a("Point camera at barcode…",!1),"BarcodeDetector"in window?m(e):(a("Loading decoder…",!1),await h()?g():(a("⚠ Barcode decoder unavailable",!0),document.getElementById("scannerSub").textContent="Check your connection and try again"))}catch(e){const t=e?e.message||String(e):"";/permission|denied|not allowed/i.test(t)?(a("⚠ Camera permission denied",!0),document.getElementById("scannerSub").textContent="Allow camera access in browser settings, then try again"):a("⚠ Camera error: "+(t.slice(0,80)||"unknown"),!0)}}function m(n){let e;try{e=new BarcodeDetector({formats:["ean_13","ean_8","upc_a","upc_e","code_128","code_39","qr_code","data_matrix","itf","aztec","pdf417"]})}catch{e=new BarcodeDetector}const t=async()=>{if(r){try{const c=await e.detect(n);if(c.length>0){y(c[0].rawValue);return}}catch{}l=requestAnimationFrame(t)}};l=requestAnimationFrame(t)}function g(){i=!0;const n=document.getElementById("scannerVideo");Quagga.init({inputStream:{name:"Live",type:"LiveStream",target:n,constraints:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},area:{top:"20%",right:"10%",left:"10%",bottom:"20%"}},decoder:{readers:["ean_reader","ean_8_reader","upc_reader","upc_e_reader","code_128_reader","code_39_reader","i2of5_reader"],multiple:!1},locate:!0,numOfWorkers:0},e=>{if(e){i=!1,a("⚠ Decoder failed to start",!0),document.getElementById("scannerSub").textContent=e.message||String(e);return}Quagga.start(),a("Point camera at barcode…",!1)}),Quagga.onDetected(e=>{if(!r||!i)return;const t=e&&e.codeResult&&e.codeResult.code;t&&y(t)})}function f(){if(i){i=!1;try{Quagga.offDetected(),Quagga.stop()}catch{}}}async function w(){try{const e=(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput");if(e.length<2)return;const t=document.getElementById("scannerCamSel");t.innerHTML=e.map((s,v)=>`<option value="${s.deviceId}">${s.label||"Camera "+(v+1)}</option>`).join("");const c=o&&o.getVideoTracks()[0]&&o.getVideoTracks()[0].getSettings().deviceId;c&&(t.value=c),t.style.display="block"}catch{}}async function I(n){if(r){f(),p();try{o=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:n},width:{ideal:1280},height:{ideal:720}}});const e=document.getElementById("scannerVideo");e.srcObject=o,await e.play(),a("Point camera at barcode…",!1),"BarcodeDetector"in window?m(e):g()}catch{a("⚠ Could not switch camera",!0)}}}function p(){cancelAnimationFrame(l),l=null,o&&(o.getTracks().forEach(e=>e.stop()),o=null);const n=document.getElementById("scannerVideo");n&&(n.pause(),n.srcObject=null)}function a(n,e){const t=document.getElementById("scannerResult");t&&(t.textContent=n,t.style.color=e?"#ff6b6b":"var(--accent)")}function y(n){if(!r)return;r=!1;const e=document.getElementById("scannerResult");if(e.innerHTML=`✓ <strong>${n}</strong>`,e.style.color="var(--accent)",navigator.vibrate&&navigator.vibrate(80),d==="__priceResearch__"){const t=n.replace(/^[^0-9]+/,"").trim();setTimeout(()=>{u(),document.getElementById("prUpcInput").value=t,document.getElementById("prOv").classList.add("on"),lookupPrices()},700)}else{const t=document.getElementById(d);t&&(t.value=n,t.dispatchEvent(new Event("input"))),setTimeout(()=>u(),800)}}function u(){r=!1,f(),p(),document.getElementById("scannerOv").classList.remove("on"),document.getElementById("scannerCamSel").style.display="none",a("Point camera at barcode…",!1),document.getElementById("scannerSub").textContent="Hold steady — auto-detects UPC, EAN, QR & more",d==="__priceResearch__"&&document.getElementById("prOv").classList.add("on")}export{h as _ensureQuagga,_ as _loadScript,y as _onScanSuccess,w as _populateCamList,m as _runNativeDetector,g as _runQuagga,a as _setResult,f as _stopQuagga,p as _stopStream,u as closeScanner,E as openScanner,I as switchCamera};
